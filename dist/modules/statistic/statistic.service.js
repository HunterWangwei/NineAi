'use strict';const _0x41e73f=_0x7e85;function _0x50b8(){const _0x2c9839=['configKey','@nestjs/typeorm','push','userEntity','MidjourneyEntity','getBaseStatistic','UserEntity','217310fJWPqG','9tqhjFe','andWhere','env','getTime','data','countNewUsersToday','order.status\x20=\x20:status','value','get','__decorate','chatlog.type\x20=\x20:type','38196riPvPR','countOrders','../globalConfig/config.entity','935460jsPate','order','countDraws','chatLog.type\x20=\x20:type','typeorm','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','DrawEntity','chatLogEntity','user.createdAt\x20<\x20:tomorrow','ChatLogEntity','length','getOrderStatistic','&start_date=','select','MM.DD','find','8kRGZzV','../../common/constants/balance.constant','MOCK','Repository','DATE(draw.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','chatlog.createdAt\x20>=\x20:startDate','count','412435JEqCon','__esModule','default','date','363gDfNUZ','CHAT_TYPE','configVal','HttpException','InjectRepository','getOwnPropertyDescriptor','draw','countUsers','DATE(order.createdAt)','configEntity','object','HttpStatus','getRawMany','countNewOrdersToday','../draw/draw.entity','countNewChatsToday','decorate','&method=','countOrdersByTimeRange','user.createdAt\x20>=\x20:today','onModuleInit','orderEntity','user','getChatStatistic','12uxZrBP','StatisticService','function','chatLog.createdAt\x20>=\x20:today','setDate','SUM(order.price)\x20AS\x20totalPrice','formatDate','chatLog.createdAt\x20<\x20:tomorrow','order.createdAt\x20>=\x20:startDate','getDate','40YmRfLs','M.DD','chatlog','where','@nestjs/common','126458KjxoMN','isMock','72303mxsuca','87512thArxr','groupBy','draw.createdAt\x20>=\x20:startDate','drawEntity','getBaiduVisit','createQueryBuilder','orderBy','baiduSiteId','metadata','overview/getTimeTrendRpt','order_createdAt','&metrics=','defineProperty','axios','midjourneyEntity','../order/order.entity','countChatsByTimeRange','result','&end_date=','map','countNewMidhourneysToday','ASC','getCount','__param','draw.createdAt\x20>=\x20:today','baiduToken','../midjourney/midjourney.entity','DeductionKey','countChats','toString','setHours','../../common/utils/date','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','BAD_REQUEST'];_0x50b8=function(){return _0x2c9839;};return _0x50b8();}(function(_0x59e53f,_0x241b2a){const _0x19177f=_0x7e85,_0x4afd0b=_0x59e53f();while(!![]){try{const _0x56557b=parseInt(_0x19177f(0x18f))/0x1+-parseInt(_0x19177f(0x192))/0x2*(-parseInt(_0x19177f(0x180))/0x3)+-parseInt(_0x19177f(0x1da))/0x4*(parseInt(_0x19177f(0x164))/0x5)+-parseInt(_0x19177f(0x1ca))/0x6+-parseInt(_0x19177f(0x191))/0x7*(-parseInt(_0x19177f(0x18a))/0x8)+parseInt(_0x19177f(0x1bc))/0x9*(-parseInt(_0x19177f(0x1bb))/0xa)+parseInt(_0x19177f(0x168))/0xb*(parseInt(_0x19177f(0x1c7))/0xc);if(_0x56557b===_0x241b2a)break;else _0x4afd0b['push'](_0x4afd0b['shift']());}catch(_0x5a1ea0){_0x4afd0b['push'](_0x4afd0b['shift']());}}}(_0x50b8,0x1c35f));function _0x7e85(_0x461b1f,_0x2eecb2){const _0x50b871=_0x50b8();return _0x7e85=function(_0x7e8543,_0x453fa1){_0x7e8543=_0x7e8543-0x164;let _0x3224b8=_0x50b871[_0x7e8543];return _0x3224b8;},_0x7e85(_0x461b1f,_0x2eecb2);}var __decorate=this&&this[_0x41e73f(0x1c5)]||function(_0x950b9e,_0x14953c,_0x8c2d02,_0x7cf6bb){const _0x4b6863=_0x41e73f;var _0x35e64e=arguments[_0x4b6863(0x1d4)],_0x1e2029=_0x35e64e<0x3?_0x14953c:_0x7cf6bb===null?_0x7cf6bb=Object[_0x4b6863(0x16d)](_0x14953c,_0x8c2d02):_0x7cf6bb,_0x1ebaa0;if(typeof Reflect===_0x4b6863(0x172)&&typeof Reflect[_0x4b6863(0x178)]===_0x4b6863(0x182))_0x1e2029=Reflect[_0x4b6863(0x178)](_0x950b9e,_0x14953c,_0x8c2d02,_0x7cf6bb);else{for(var _0xb154e=_0x950b9e[_0x4b6863(0x1d4)]-0x1;_0xb154e>=0x0;_0xb154e--)if(_0x1ebaa0=_0x950b9e[_0xb154e])_0x1e2029=(_0x35e64e<0x3?_0x1ebaa0(_0x1e2029):_0x35e64e>0x3?_0x1ebaa0(_0x14953c,_0x8c2d02,_0x1e2029):_0x1ebaa0(_0x14953c,_0x8c2d02))||_0x1e2029;}return _0x35e64e>0x3&&_0x1e2029&&Object[_0x4b6863(0x19e)](_0x14953c,_0x8c2d02,_0x1e2029),_0x1e2029;},__metadata=this&&this['__metadata']||function(_0x491378,_0x332042){const _0x1b8b76=_0x41e73f;if(typeof Reflect===_0x1b8b76(0x172)&&typeof Reflect[_0x1b8b76(0x19a)]===_0x1b8b76(0x182))return Reflect[_0x1b8b76(0x19a)](_0x491378,_0x332042);},__param=this&&this[_0x41e73f(0x1a9)]||function(_0x2678e0,_0x31d294){return function(_0x5a15d2,_0x8e6ce8){_0x31d294(_0x5a15d2,_0x8e6ce8,_0x2678e0);};};Object[_0x41e73f(0x19e)](exports,_0x41e73f(0x165),{'value':!![]}),exports[_0x41e73f(0x181)]=void 0x0;const common_1=require(_0x41e73f(0x18e)),typeorm_1=require(_0x41e73f(0x1b5)),user_entity_1=require('../user/user.entity'),typeorm_2=require(_0x41e73f(0x1ce)),chatLog_entity_1=require('../chatLog/chatLog.entity'),balance_constant_1=require(_0x41e73f(0x1db)),date_1=require(_0x41e73f(0x1b1)),axios_1=require(_0x41e73f(0x19f)),config_entity_1=require(_0x41e73f(0x1c9)),order_entity_1=require(_0x41e73f(0x1a1)),midjourney_entity_1=require(_0x41e73f(0x1ac)),draw_entity_1=require(_0x41e73f(0x176));let StatisticService=class StatisticService{constructor(_0x402d8e,_0x1c08db,_0x4e1a51,_0x149d08,_0x34c4e4,_0x4059c1){const _0x388585=_0x41e73f;this[_0x388585(0x1b7)]=_0x402d8e,this['chatLogEntity']=_0x1c08db,this[_0x388585(0x171)]=_0x4e1a51,this[_0x388585(0x17d)]=_0x149d08,this[_0x388585(0x1a0)]=_0x34c4e4,this[_0x388585(0x195)]=_0x4059c1,this[_0x388585(0x190)]=![];}async[_0x41e73f(0x17c)](){const _0x46aa52=_0x41e73f;this[_0x46aa52(0x190)]=Number(process[_0x46aa52(0x1be)][_0x46aa52(0x1dc)])===0x1;}async[_0x41e73f(0x1b9)](){const _0x256cda=_0x41e73f,_0x2b4807=await this[_0x256cda(0x16f)](),_0x3a3917=await this[_0x256cda(0x1c1)](),_0x6ce35d=await this[_0x256cda(0x1ae)](),_0x37ef21=await this[_0x256cda(0x177)](),_0x2fa819=await this[_0x256cda(0x1cc)](),_0x5e6bcb=await this[_0x256cda(0x1a6)](),_0x31d409=await this[_0x256cda(0x1c8)](),_0xd6e17b=await this['countNewOrdersToday']();return{'userCount':this[_0x256cda(0x190)]?_0x2b4807+0x7d0:_0x2b4807,'newUserCount':this[_0x256cda(0x190)]?_0x3a3917+0xc:_0x3a3917,'chatCount':this['isMock']?_0x6ce35d+0x30d40:_0x6ce35d,'newChatCount':this['isMock']?_0x37ef21+0x335:_0x37ef21,'drawCount':this[_0x256cda(0x190)]?_0x2fa819+0x1394:_0x2fa819,'newDrawCount':this['isMock']?_0x5e6bcb+0x1f:_0x5e6bcb,'orderCount':this['isMock']?_0x31d409+0x190:_0x31d409,'newOrderCount':this[_0x256cda(0x190)]?_0xd6e17b+0xa:_0xd6e17b};}async[_0x41e73f(0x17f)]({days:days=0x7}){const _0x2b6e02=_0x41e73f,_0x5b75da=await this['countChatsByTimeRange'](days),_0x4c0131=await this['countMjDrawsByTimeRange'](days);return{'date':_0x5b75da[_0x2b6e02(0x1a5)](_0x31bf7f=>_0x31bf7f[_0x2b6e02(0x167)]),'chat':_0x5b75da[_0x2b6e02(0x1a5)](_0x49a8f8=>_0x49a8f8['value']),'draw':_0x4c0131[_0x2b6e02(0x1a5)](_0x1362db=>_0x1362db[_0x2b6e02(0x1c3)])};}async[_0x41e73f(0x1d5)](_0x33a367){const _0x18fd2e=_0x41e73f,{days:_0x2dc3d3}=_0x33a367,_0x36a58c=await this[_0x18fd2e(0x17a)](_0x2dc3d3);return{'date':_0x36a58c['map'](_0x1d2ab1=>_0x1d2ab1['date']),'order':_0x36a58c[_0x18fd2e(0x1a5)](_0x588df3=>_0x588df3[_0x18fd2e(0x1c3)])};}async[_0x41e73f(0x196)]({days:days=0x7}){const _0x2952e3=await this['getBaiduStatistics'](days);return _0x2952e3;}async['countUsers'](){const _0x242a18=_0x41e73f,_0x1755d3=await this[_0x242a18(0x1b7)][_0x242a18(0x1e1)]();return _0x1755d3;}async[_0x41e73f(0x1c1)](){const _0x5618d9=_0x41e73f,_0x465878=new Date();_0x465878[_0x5618d9(0x1b0)](0x0,0x0,0x0,0x0);const _0x3d5e11=new Date(_0x465878[_0x5618d9(0x1bf)]()+0x18*0x3c*0x3c*0x3e8),_0x255e44=this['userEntity']['createQueryBuilder'](_0x5618d9(0x17e)),_0x29d4fb=await _0x255e44[_0x5618d9(0x18d)](_0x5618d9(0x17b),{'today':_0x465878})[_0x5618d9(0x1bd)](_0x5618d9(0x1d2),{'tomorrow':_0x3d5e11})['getCount']();return _0x29d4fb;}async['countChats'](){const _0x2ed64f=_0x41e73f,_0x28e2e4=await this[_0x2ed64f(0x1d1)]['count']({'where':{'type':balance_constant_1[_0x2ed64f(0x1ad)][_0x2ed64f(0x169)]}});return _0x28e2e4;}async[_0x41e73f(0x177)](){const _0x4f6267=_0x41e73f,_0xf7af55=new Date();_0xf7af55[_0x4f6267(0x1b0)](0x0,0x0,0x0,0x0);const _0x413333=new Date(_0xf7af55[_0x4f6267(0x1bf)]()+0x18*0x3c*0x3c*0x3e8),_0x131e67=this['chatLogEntity'][_0x4f6267(0x197)]('chatLog'),_0x2e2f2b=await _0x131e67['where'](_0x4f6267(0x1cd),{'type':balance_constant_1[_0x4f6267(0x1ad)]['CHAT_TYPE']})[_0x4f6267(0x1bd)](_0x4f6267(0x183),{'today':_0xf7af55})[_0x4f6267(0x1bd)](_0x4f6267(0x187),{'tomorrow':_0x413333})[_0x4f6267(0x1a8)]();return _0x2e2f2b;}async[_0x41e73f(0x1cc)](){const _0x3fe57e=_0x41e73f,_0x2059a0=await this[_0x3fe57e(0x195)][_0x3fe57e(0x1e1)]();return _0x2059a0;}async[_0x41e73f(0x1a6)](){const _0x45e791=_0x41e73f,_0x1ea020=new Date();_0x1ea020[_0x45e791(0x1b0)](0x0,0x0,0x0,0x0);const _0x29dc47=new Date(_0x1ea020[_0x45e791(0x1bf)]()+0x18*0x3c*0x3c*0x3e8),_0x5385f9=this[_0x45e791(0x195)][_0x45e791(0x197)]('draw'),_0xd522c3=await _0x5385f9['where'](_0x45e791(0x1aa),{'today':_0x1ea020})[_0x45e791(0x1bd)]('draw.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x29dc47})[_0x45e791(0x1a8)]();return _0xd522c3;}async[_0x41e73f(0x1a2)](_0x5668ce){const _0x5350f0=_0x41e73f;var _0x162fd4,_0xc61d;const _0x15ada6=new Date();_0x15ada6[_0x5350f0(0x1b0)](0x0,0x0,0x0,0x0);const _0x11de1d=new Date(_0x15ada6[_0x5350f0(0x1bf)]()-(_0x5668ce-0x1)*0x18*0x3c*0x3c*0x3e8),_0x49bf52=this[_0x5350f0(0x1d1)][_0x5350f0(0x197)](_0x5350f0(0x18c)),_0x31317e=await _0x49bf52[_0x5350f0(0x1d7)](_0x5350f0(0x1b2))[_0x5350f0(0x18d)](_0x5350f0(0x1c6),{'type':balance_constant_1[_0x5350f0(0x1ad)][_0x5350f0(0x169)]})['andWhere'](_0x5350f0(0x1e0),{'startDate':_0x11de1d})[_0x5350f0(0x193)](_0x5350f0(0x167))[_0x5350f0(0x198)](_0x5350f0(0x167))[_0x5350f0(0x174)](),_0x545233=[],_0x2fc834=_0x11de1d;for(let _0x1eb44a=0x0;_0x1eb44a<_0x5668ce;_0x1eb44a++){const _0x1103fa=(0x0,date_1[_0x5350f0(0x186)])(new Date(_0x2fc834),_0x5350f0(0x18b)),_0x45be30=(_0xc61d=(_0x162fd4=_0x31317e[_0x5350f0(0x1d9)](_0x2515f3=>(0x0,date_1['formatDate'])(new Date(_0x2515f3[_0x5350f0(0x167)]),_0x5350f0(0x18b))===_0x1103fa))===null||_0x162fd4===void 0x0?void 0x0:_0x162fd4[_0x5350f0(0x1e1)])!==null&&_0xc61d!==void 0x0?_0xc61d:0x0;_0x45be30>0x0?_0x545233[_0x5350f0(0x1b6)]({'date':_0x1103fa,'value':Number(_0x45be30)}):_0x545233[_0x5350f0(0x1b6)]({'date':_0x1103fa,'value':0x0}),_0x2fc834[_0x5350f0(0x184)](_0x2fc834['getDate']()+0x1);}return _0x545233;}async[_0x41e73f(0x17a)](_0x50a4df){const _0x38975c=_0x41e73f;var _0x289b1c;const _0x4a4ba7=new Date();_0x4a4ba7['setHours'](0x0,0x0,0x0,0x0);const _0x196736=new Date(_0x4a4ba7[_0x38975c(0x1bf)]()-(_0x50a4df-0x1)*0x18*0x3c*0x3c*0x3e8),_0x3f79e4=this[_0x38975c(0x17d)][_0x38975c(0x197)](_0x38975c(0x1cb)),_0x33cf37=await _0x3f79e4['addSelect'](_0x38975c(0x185))[_0x38975c(0x18d)](_0x38975c(0x1c2),{'status':0x1})[_0x38975c(0x1bd)](_0x38975c(0x188),{'startDate':_0x196736})[_0x38975c(0x193)](_0x38975c(0x170))[_0x38975c(0x198)](_0x38975c(0x170),_0x38975c(0x1a7))[_0x38975c(0x174)](),_0x4e9c33=[],_0x22ecb9=_0x196736;for(let _0x1c78e6=0x0;_0x1c78e6<_0x50a4df;_0x1c78e6++){const _0x293364=(0x0,date_1['formatDate'])(new Date(_0x22ecb9),'MM.DD'),_0x26cec1=(_0x289b1c=_0x33cf37['find'](_0x10357c=>{const _0xc19c16=_0x38975c,_0x4a17f5=(0x0,date_1['formatDate'])(new Date(_0x10357c[_0xc19c16(0x19c)]),_0xc19c16(0x1d8))[_0xc19c16(0x1af)]()==_0x293364['toString']();return _0x4a17f5;}))===null||_0x289b1c===void 0x0?void 0x0:_0x289b1c['totalPrice'];_0x26cec1?_0x4e9c33[_0x38975c(0x1b6)]({'date':_0x293364,'value':Number(_0x26cec1)}):_0x4e9c33[_0x38975c(0x1b6)]({'date':_0x293364,'value':0x0}),_0x22ecb9[_0x38975c(0x184)](_0x22ecb9[_0x38975c(0x189)]()+0x1);}return _0x4e9c33;}async['countMjDrawsByTimeRange'](_0x207094){const _0x114a14=_0x41e73f;var _0x2d7457,_0x494b40;const _0x5d9fcd=new Date();_0x5d9fcd[_0x114a14(0x1b0)](0x0,0x0,0x0,0x0);const _0x228721=new Date(_0x5d9fcd[_0x114a14(0x1bf)]()-(_0x207094-0x1)*0x18*0x3c*0x3c*0x3e8),_0x3dc12b=this[_0x114a14(0x195)]['createQueryBuilder'](_0x114a14(0x16e)),_0x3cb55a=await _0x3dc12b['select'](_0x114a14(0x1de))[_0x114a14(0x1bd)](_0x114a14(0x194),{'startDate':_0x228721})['groupBy'](_0x114a14(0x167))[_0x114a14(0x198)](_0x114a14(0x167))[_0x114a14(0x174)](),_0x3786d0=[],_0x526e0d=_0x228721;for(let _0x4dddf3=0x0;_0x4dddf3<_0x207094;_0x4dddf3++){const _0x4c1a6c=(0x0,date_1[_0x114a14(0x186)])(new Date(_0x526e0d),_0x114a14(0x18b)),_0x55ce4a=(_0x494b40=(_0x2d7457=_0x3cb55a[_0x114a14(0x1d9)](_0x4205a5=>(0x0,date_1[_0x114a14(0x186)])(new Date(_0x4205a5[_0x114a14(0x167)]),'M.DD')===_0x4c1a6c))===null||_0x2d7457===void 0x0?void 0x0:_0x2d7457[_0x114a14(0x1e1)])!==null&&_0x494b40!==void 0x0?_0x494b40:0x0;_0x55ce4a>0x0?_0x3786d0['push']({'date':_0x4c1a6c,'value':Number(_0x55ce4a)}):_0x3786d0[_0x114a14(0x1b6)]({'date':_0x4c1a6c,'value':0x0}),_0x526e0d['setDate'](_0x526e0d[_0x114a14(0x189)]()+0x1);}return _0x3786d0;}async['getBaiduStatistics'](_0xc0ad35){const _0x496271=_0x41e73f;var _0x3fcf83,_0x1dc553;const _0x5f0008=(0x0,date_1[_0x496271(0x186)])(new Date(),'YYYYMMDD'),_0x4fadc7=(0x0,date_1[_0x496271(0x186)])(new Date(Date['now']()-Number(_0xc0ad35-0x1)*0x18*0x3c*0x3c*0x3e8),'YYYYMMDD'),_0x24d3e1=_0x496271(0x1df),_0x59e745=_0x496271(0x19b),_0xaba29=await this[_0x496271(0x171)][_0x496271(0x1d9)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x496271(0x1ab),_0x496271(0x199)])}}),_0x1ac3a7=(_0x3fcf83=_0xaba29['find'](_0x361f61=>_0x361f61[_0x496271(0x1b4)]===_0x496271(0x199)))===null||_0x3fcf83===void 0x0?void 0x0:_0x3fcf83['configVal'],_0x416267=(_0x1dc553=_0xaba29[_0x496271(0x1d9)](_0x173679=>_0x173679[_0x496271(0x1b4)]==='baiduToken'))===null||_0x1dc553===void 0x0?void 0x0:_0x1dc553[_0x496271(0x16a)];if(!_0x1ac3a7||!_0x416267)return[];if(!_0x1ac3a7)throw new common_1['HttpException']('请先配置百度统计siteId',common_1[_0x496271(0x173)][_0x496271(0x1b3)]);if(!_0x416267)throw new common_1[(_0x496271(0x16b))]('请先配置百度统计accessToken',common_1[_0x496271(0x173)][_0x496271(0x1b3)]);const _0x132adb=_0x496271(0x1cf)+_0x416267+'&site_id='+_0x1ac3a7+_0x496271(0x179)+_0x59e745+_0x496271(0x1d6)+_0x4fadc7+_0x496271(0x1a4)+_0x5f0008+_0x496271(0x19d)+_0x24d3e1,_0x3b1287=await axios_1[_0x496271(0x166)][_0x496271(0x1c4)](_0x132adb),{error_code:_0x985a80,message:_0x4aca78}=_0x3b1287[_0x496271(0x1c0)];if(_0x985a80===0x6f)throw new common_1[(_0x496271(0x16b))](_0x4aca78||'百度授权码过期',common_1[_0x496271(0x173)][_0x496271(0x1b3)]);if(_0x985a80&&_0x985a80!==0xc8)throw new common_1[(_0x496271(0x16b))](_0x4aca78||'获取百度统计数据失败',common_1[_0x496271(0x173)][_0x496271(0x1b3)]);return _0x3b1287['data'][_0x496271(0x1a3)];}async[_0x41e73f(0x1c8)](){const _0x517c2b=_0x41e73f,_0x35e2fe=await this[_0x517c2b(0x17d)][_0x517c2b(0x1e1)]();return _0x35e2fe;}async[_0x41e73f(0x175)](){const _0x99742f=_0x41e73f,_0x15df45=new Date();_0x15df45['setHours'](0x0,0x0,0x0,0x0);const _0xa78b8=new Date(_0x15df45[_0x99742f(0x1bf)]()+0x18*0x3c*0x3c*0x3e8),_0x488275=this[_0x99742f(0x17d)][_0x99742f(0x197)](_0x99742f(0x1cb)),_0x1ba63a=await _0x488275['where']('order.createdAt\x20>=\x20:today',{'today':_0x15df45})['andWhere']('order.createdAt\x20<\x20:tomorrow',{'tomorrow':_0xa78b8})[_0x99742f(0x1a8)]();return _0x1ba63a;}};StatisticService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x41e73f(0x1ba)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x41e73f(0x1d3)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(config_entity_1['ConfigEntity'])),__param(0x3,(0x0,typeorm_1[_0x41e73f(0x16c)])(order_entity_1['OrderEntity'])),__param(0x4,(0x0,typeorm_1[_0x41e73f(0x16c)])(midjourney_entity_1[_0x41e73f(0x1b8)])),__param(0x5,(0x0,typeorm_1[_0x41e73f(0x16c)])(draw_entity_1[_0x41e73f(0x1d0)])),__metadata('design:paramtypes',[typeorm_2[_0x41e73f(0x1dd)],typeorm_2[_0x41e73f(0x1dd)],typeorm_2[_0x41e73f(0x1dd)],typeorm_2[_0x41e73f(0x1dd)],typeorm_2[_0x41e73f(0x1dd)],typeorm_2[_0x41e73f(0x1dd)]])],StatisticService),exports['StatisticService']=StatisticService;