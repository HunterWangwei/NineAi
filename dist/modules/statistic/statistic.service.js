'use strict';function _0x455b(){const _0x2b4dfb=['user.createdAt\x20>=\x20:today','midjourney','getRawMany','13949523lxeDEN','baiduSiteId','608824khMXrn','chatLogEntity','StatisticService','countNewChatsToday','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','result','chatLog.createdAt\x20<\x20:tomorrow','chatLog.type\x20=\x20:type','function','andWhere','setDate','countNewOrdersToday','createQueryBuilder','UserEntity','chatLog.createdAt\x20>=\x20:today','YYYYMMDD','请先配置百度统计accessToken','../../common/constants/balance.constant','now','getBaiduVisit','length','&site_id=','countChats','midjourney.createdAt\x20<\x20:tomorrow','获取百度统计数据失败','__esModule','overview/getTimeTrendRpt','configKey','configEntity','../../common/utils/date','design:paramtypes','getBaseStatistic','HttpException','HttpStatus','count','DeductionKey','countDrawsByTimeRange','InjectRepository','setHours','orderEntity','&end_date=','order','push','orderBy','请先配置百度统计siteId','Injectable','data','countMjDrawsByTimeRange','../order/order.entity','user.createdAt\x20<\x20:tomorrow','42JkoCRV','M.DD','getDate','BAD_REQUEST','decorate','__param','getChatStatistic','2895xPGYVk','groupBy','userEntity','getCount','countChatsByTimeRange','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','528051YwhEcS','user','countNewUsersToday','countNewDrawsToday','where','OrderEntity','chatLog','configVal','axios','getBaiduStatistics','&method=','formatDate','75340KGATiu','../../common/constants/midjourney.constant','midjourney.createdAt\x20>=\x20:startDate','value','object','order.createdAt\x20<\x20:tomorrow','defineProperty','__metadata','2002641XeANAx','date','chatlog.type\x20=\x20:type','find','select','chatlog.createdAt\x20>=\x20:startDate','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','getTime','midjourneyEntity','PAINT_TYPE','getOwnPropertyDescriptor','MidjourneyEntity','countDraws','&metrics=','1848OtFifP','Repository','3932190eHECzT','ChatLogEntity','map','@nestjs/common','metadata','../globalConfig/config.entity','countOrders','百度授权码过期','CHAT_TYPE'];_0x455b=function(){return _0x2b4dfb;};return _0x455b();}const _0x24c338=_0x38c4;(function(_0xcaa79d,_0x243a1c){const _0x4b01f4=_0x38c4,_0x2e8803=_0xcaa79d();while(!![]){try{const _0x300d5f=-parseInt(_0x4b01f4(0xd5))/0x1+-parseInt(_0x4b01f4(0xe1))/0x2+-parseInt(_0x4b01f4(0xe9))/0x3+-parseInt(_0x4b01f4(0xf7))/0x4*(-parseInt(_0x4b01f4(0xcf))/0x5)+-parseInt(_0x4b01f4(0xf9))/0x6+-parseInt(_0x4b01f4(0xc8))/0x7*(-parseInt(_0x4b01f4(0x107))/0x8)+parseInt(_0x4b01f4(0x105))/0x9;if(_0x300d5f===_0x243a1c)break;else _0x2e8803['push'](_0x2e8803['shift']());}catch(_0xd3510f){_0x2e8803['push'](_0x2e8803['shift']());}}}(_0x455b,0x5e196));function _0x38c4(_0x3884bb,_0xdf0fc0){const _0x455ba7=_0x455b();return _0x38c4=function(_0x38c4d4,_0x3f996c){_0x38c4d4=_0x38c4d4-0xac;let _0x1d631b=_0x455ba7[_0x38c4d4];return _0x1d631b;},_0x38c4(_0x3884bb,_0xdf0fc0);}var __decorate=this&&this['__decorate']||function(_0xd39545,_0x421d12,_0x416cbe,_0x1681c8){const _0x41d613=_0x38c4;var _0x2550f2=arguments[_0x41d613(0x11b)],_0x3b0f12=_0x2550f2<0x3?_0x421d12:_0x1681c8===null?_0x1681c8=Object[_0x41d613(0xf3)](_0x421d12,_0x416cbe):_0x1681c8,_0x189ae3;if(typeof Reflect===_0x41d613(0xe5)&&typeof Reflect[_0x41d613(0xcc)]===_0x41d613(0x10f))_0x3b0f12=Reflect[_0x41d613(0xcc)](_0xd39545,_0x421d12,_0x416cbe,_0x1681c8);else{for(var _0x4f0e38=_0xd39545[_0x41d613(0x11b)]-0x1;_0x4f0e38>=0x0;_0x4f0e38--)if(_0x189ae3=_0xd39545[_0x4f0e38])_0x3b0f12=(_0x2550f2<0x3?_0x189ae3(_0x3b0f12):_0x2550f2>0x3?_0x189ae3(_0x421d12,_0x416cbe,_0x3b0f12):_0x189ae3(_0x421d12,_0x416cbe))||_0x3b0f12;}return _0x2550f2>0x3&&_0x3b0f12&&Object[_0x41d613(0xe7)](_0x421d12,_0x416cbe,_0x3b0f12),_0x3b0f12;},__metadata=this&&this[_0x24c338(0xe8)]||function(_0x595955,_0x3737e6){const _0x13aefb=_0x24c338;if(typeof Reflect===_0x13aefb(0xe5)&&typeof Reflect[_0x13aefb(0xfd)]===_0x13aefb(0x10f))return Reflect[_0x13aefb(0xfd)](_0x595955,_0x3737e6);},__param=this&&this[_0x24c338(0xcd)]||function(_0x300efc,_0x2d69cf){return function(_0x376cf7,_0x2504fd){_0x2d69cf(_0x376cf7,_0x2504fd,_0x300efc);};};Object[_0x24c338(0xe7)](exports,_0x24c338(0xaf),{'value':!![]}),exports[_0x24c338(0x109)]=void 0x0;const common_1=require(_0x24c338(0xfc)),typeorm_1=require('@nestjs/typeorm'),user_entity_1=require('../user/user.entity'),typeorm_2=require('typeorm'),chatLog_entity_1=require('../chatLog/chatLog.entity'),balance_constant_1=require(_0x24c338(0x118)),date_1=require(_0x24c338(0xb3)),axios_1=require(_0x24c338(0xdd)),config_entity_1=require(_0x24c338(0xfe)),order_entity_1=require(_0x24c338(0xc6)),midjourney_entity_1=require('../midjourney/midjourney.entity'),midjourney_constant_1=require(_0x24c338(0xe2));let StatisticService=class StatisticService{constructor(_0x52ea2f,_0x235a61,_0x4c3d9c,_0x494db3,_0x218d91){const _0x5c4ea8=_0x24c338;this[_0x5c4ea8(0xd1)]=_0x52ea2f,this[_0x5c4ea8(0x108)]=_0x235a61,this[_0x5c4ea8(0xb2)]=_0x4c3d9c,this[_0x5c4ea8(0xbd)]=_0x494db3,this[_0x5c4ea8(0xf1)]=_0x218d91;}async[_0x24c338(0xb5)](){const _0x42ea80=_0x24c338,_0x341dd1=await this['countUsers'](),_0x18515f=await this[_0x42ea80(0xd7)](),_0x4ba7de=await this[_0x42ea80(0xac)](),_0xf98551=await this[_0x42ea80(0x10a)](),_0x1fe1f=await this[_0x42ea80(0xf5)](),_0x857807=await this[_0x42ea80(0xd8)](),_0x294ac6=await this['countNewMidhourneysToday'](),_0x5e7c9d=await this[_0x42ea80(0xff)](),_0x3f3770=await this[_0x42ea80(0x112)]();return{'userCount':_0x341dd1,'newUserCount':_0x18515f,'chatCount':_0x4ba7de,'newChatCount':_0xf98551,'drawCount':_0x1fe1f,'newDrawCount':_0x294ac6+_0x857807,'orderCount':_0x5e7c9d,'newOrderCount':_0x3f3770};}async[_0x24c338(0xce)]({days:days=0x7}){const _0x1502b9=_0x24c338,_0x14fef9=await this[_0x1502b9(0xd3)](days),_0x5ecdbb=await this[_0x1502b9(0xba)](days),_0x34eb32=await this[_0x1502b9(0xc5)](days);return{'date':_0x14fef9[_0x1502b9(0xfb)](_0x5dbef9=>_0x5dbef9[_0x1502b9(0xea)]),'chat':_0x14fef9[_0x1502b9(0xfb)](_0x2d9f4e=>_0x2d9f4e[_0x1502b9(0xe4)]),'draw':_0x5ecdbb[_0x1502b9(0xfb)]((_0x4a1b0a,_0x27e514)=>{return _0x4a1b0a['value']+_0x34eb32[_0x27e514]['value'];})};}async[_0x24c338(0x11a)]({days:days=0x7}){const _0x351eef=_0x24c338,_0x291307=await this[_0x351eef(0xde)](days);return _0x291307;}async['countUsers'](){const _0x1efa02=_0x24c338,_0x520991=await this[_0x1efa02(0xd1)][_0x1efa02(0xb8)]();return _0x520991;}async[_0x24c338(0xd7)](){const _0xfaab56=_0x24c338,_0x3f920e=new Date();_0x3f920e['setHours'](0x0,0x0,0x0,0x0);const _0x5bfbad=new Date(_0x3f920e[_0xfaab56(0xf0)]()+0x18*0x3c*0x3c*0x3e8),_0x55073e=this[_0xfaab56(0xd1)][_0xfaab56(0x113)](_0xfaab56(0xd6)),_0x1ffcb6=await _0x55073e[_0xfaab56(0xd9)](_0xfaab56(0x102),{'today':_0x3f920e})[_0xfaab56(0x110)](_0xfaab56(0xc7),{'tomorrow':_0x5bfbad})['getCount']();return _0x1ffcb6;}async[_0x24c338(0xac)](){const _0x4ee174=_0x24c338,_0xeb9525=await this['chatLogEntity'][_0x4ee174(0xb8)]({'where':{'type':balance_constant_1['DeductionKey'][_0x4ee174(0x101)]}});return _0xeb9525;}async[_0x24c338(0x10a)](){const _0xa9e3c0=_0x24c338,_0x487576=new Date();_0x487576[_0xa9e3c0(0xbc)](0x0,0x0,0x0,0x0);const _0x20d9d1=new Date(_0x487576['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x1b0873=this[_0xa9e3c0(0x108)]['createQueryBuilder']('chatLog'),_0x322cbe=await _0x1b0873[_0xa9e3c0(0xd9)](_0xa9e3c0(0x10e),{'type':balance_constant_1[_0xa9e3c0(0xb9)][_0xa9e3c0(0x101)]})[_0xa9e3c0(0x110)](_0xa9e3c0(0x115),{'today':_0x487576})[_0xa9e3c0(0x110)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x20d9d1})[_0xa9e3c0(0xd2)]();return _0x322cbe;}async[_0x24c338(0xf5)](){const _0x353359=_0x24c338,_0x35931a=await this[_0x353359(0x108)][_0x353359(0xb8)]({'where':{'type':balance_constant_1[_0x353359(0xb9)]['PAINT_TYPE']}});return _0x35931a;}async['countNewDrawsToday'](){const _0x12e8e7=_0x24c338,_0x11ec10=new Date();_0x11ec10[_0x12e8e7(0xbc)](0x0,0x0,0x0,0x0);const _0x4329d2=new Date(_0x11ec10[_0x12e8e7(0xf0)]()+0x18*0x3c*0x3c*0x3e8),_0x3b8568=this['chatLogEntity']['createQueryBuilder'](_0x12e8e7(0xdb)),_0x26cb86=await _0x3b8568[_0x12e8e7(0xd9)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x12e8e7(0xb9)][_0x12e8e7(0xf2)]})[_0x12e8e7(0x110)](_0x12e8e7(0x115),{'today':_0x11ec10})[_0x12e8e7(0x110)](_0x12e8e7(0x10d),{'tomorrow':_0x4329d2})[_0x12e8e7(0xd2)]();return _0x26cb86;}async['countNewMidhourneysToday'](){const _0x29bdd=_0x24c338,_0x1e4754=new Date();_0x1e4754[_0x29bdd(0xbc)](0x0,0x0,0x0,0x0);const _0xa0e32e=new Date(_0x1e4754[_0x29bdd(0xf0)]()+0x18*0x3c*0x3c*0x3e8),_0x417a22=this[_0x29bdd(0xf1)][_0x29bdd(0x113)]('midjourney'),_0x23cf1d=await _0x417a22['where']('midjourney.createdAt\x20>=\x20:today',{'today':_0x1e4754})[_0x29bdd(0x110)](_0x29bdd(0xad),{'tomorrow':_0xa0e32e})[_0x29bdd(0xd2)]();return _0x23cf1d;}async[_0x24c338(0xd3)](_0xb2f22d){const _0x45f97c=_0x24c338;var _0x3e4234,_0x3887e2;const _0x172ebe=new Date();_0x172ebe['setHours'](0x0,0x0,0x0,0x0);const _0x33cf92=new Date(_0x172ebe[_0x45f97c(0xf0)]()-(_0xb2f22d-0x1)*0x18*0x3c*0x3c*0x3e8),_0x52d26d=this['chatLogEntity'][_0x45f97c(0x113)]('chatlog'),_0x37fe6b=await _0x52d26d[_0x45f97c(0xed)](_0x45f97c(0x10b))[_0x45f97c(0xd9)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x45f97c(0xb9)][_0x45f97c(0x101)]})['andWhere'](_0x45f97c(0xee),{'startDate':_0x33cf92})[_0x45f97c(0xd0)](_0x45f97c(0xea))['orderBy'](_0x45f97c(0xea))[_0x45f97c(0x104)](),_0x13e5c0=[],_0x4754ca=_0x33cf92;for(let _0x196bf3=0x0;_0x196bf3<_0xb2f22d;_0x196bf3++){const _0x54f8fd=(0x0,date_1[_0x45f97c(0xe0)])(new Date(_0x4754ca),_0x45f97c(0xc9)),_0x2f32ef=(_0x3887e2=(_0x3e4234=_0x37fe6b[_0x45f97c(0xec)](_0x517c11=>(0x0,date_1[_0x45f97c(0xe0)])(new Date(_0x517c11[_0x45f97c(0xea)]),_0x45f97c(0xc9))===_0x54f8fd))===null||_0x3e4234===void 0x0?void 0x0:_0x3e4234[_0x45f97c(0xb8)])!==null&&_0x3887e2!==void 0x0?_0x3887e2:0x0;_0x2f32ef>0x0?_0x13e5c0[_0x45f97c(0xc0)]({'date':_0x54f8fd,'value':Number(_0x2f32ef)}):_0x13e5c0['push']({'date':_0x54f8fd,'value':0x0}),_0x4754ca['setDate'](_0x4754ca[_0x45f97c(0xca)]()+0x1);}return _0x13e5c0;}async[_0x24c338(0xba)](_0x279e81){const _0x2367fc=_0x24c338;var _0x104fba,_0x13b811;const _0x210446=new Date();_0x210446[_0x2367fc(0xbc)](0x0,0x0,0x0,0x0);const _0x10da82=new Date(_0x210446[_0x2367fc(0xf0)]()-(_0x279e81-0x1)*0x18*0x3c*0x3c*0x3e8),_0xfb7a0f=this[_0x2367fc(0x108)]['createQueryBuilder']('chatlog'),_0x195120=await _0xfb7a0f['select'](_0x2367fc(0x10b))[_0x2367fc(0xd9)](_0x2367fc(0xeb),{'type':balance_constant_1[_0x2367fc(0xb9)][_0x2367fc(0xf2)]})[_0x2367fc(0x110)]('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x10da82})[_0x2367fc(0xd0)](_0x2367fc(0xea))[_0x2367fc(0xc1)](_0x2367fc(0xea))['getRawMany'](),_0x4ccbcc=[],_0x240d89=_0x10da82;for(let _0x4e3e00=0x0;_0x4e3e00<_0x279e81;_0x4e3e00++){const _0x3606fb=(0x0,date_1[_0x2367fc(0xe0)])(new Date(_0x240d89),_0x2367fc(0xc9)),_0x2b61fa=(_0x13b811=(_0x104fba=_0x195120['find'](_0x2d894c=>(0x0,date_1[_0x2367fc(0xe0)])(new Date(_0x2d894c[_0x2367fc(0xea)]),_0x2367fc(0xc9))===_0x3606fb))===null||_0x104fba===void 0x0?void 0x0:_0x104fba[_0x2367fc(0xb8)])!==null&&_0x13b811!==void 0x0?_0x13b811:0x0;_0x2b61fa>0x0?_0x4ccbcc['push']({'date':_0x3606fb,'value':Number(_0x2b61fa)}):_0x4ccbcc[_0x2367fc(0xc0)]({'date':_0x3606fb,'value':0x0}),_0x240d89[_0x2367fc(0x111)](_0x240d89[_0x2367fc(0xca)]()+0x1);}return _0x4ccbcc;}async['countMjDrawsByTimeRange'](_0x532759){const _0x337df8=_0x24c338;var _0x54a146,_0x33014e;const _0x58bff6=new Date();_0x58bff6['setHours'](0x0,0x0,0x0,0x0);const _0x196df2=new Date(_0x58bff6['getTime']()-(_0x532759-0x1)*0x18*0x3c*0x3c*0x3e8),_0x344c4f=this[_0x337df8(0xf1)][_0x337df8(0x113)](_0x337df8(0x103)),_0x88bc4=await _0x344c4f[_0x337df8(0xed)]('DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')[_0x337df8(0xd9)]('midjourney.status\x20=\x20:status',{'status':midjourney_constant_1['MidjourneyStatusEnum']['DRAWED']})[_0x337df8(0x110)](_0x337df8(0xe3),{'startDate':_0x196df2})[_0x337df8(0xd0)](_0x337df8(0xea))[_0x337df8(0xc1)](_0x337df8(0xea))['getRawMany'](),_0x5ddb98=[],_0x234961=_0x196df2;for(let _0x5dc167=0x0;_0x5dc167<_0x532759;_0x5dc167++){const _0x548ec5=(0x0,date_1[_0x337df8(0xe0)])(new Date(_0x234961),'M.DD'),_0x48a1c7=(_0x33014e=(_0x54a146=_0x88bc4[_0x337df8(0xec)](_0x356959=>(0x0,date_1['formatDate'])(new Date(_0x356959[_0x337df8(0xea)]),_0x337df8(0xc9))===_0x548ec5))===null||_0x54a146===void 0x0?void 0x0:_0x54a146['count'])!==null&&_0x33014e!==void 0x0?_0x33014e:0x0;_0x48a1c7>0x0?_0x5ddb98[_0x337df8(0xc0)]({'date':_0x548ec5,'value':Number(_0x48a1c7)}):_0x5ddb98[_0x337df8(0xc0)]({'date':_0x548ec5,'value':0x0}),_0x234961[_0x337df8(0x111)](_0x234961[_0x337df8(0xca)]()+0x1);}return _0x5ddb98;}async[_0x24c338(0xde)](_0x435009){const _0x5b632c=_0x24c338;var _0x4bff20,_0x42af03;const _0x2c2864=(0x0,date_1[_0x5b632c(0xe0)])(new Date(),_0x5b632c(0x116)),_0x483f91=(0x0,date_1[_0x5b632c(0xe0)])(new Date(Date[_0x5b632c(0x119)]()-Number(_0x435009-0x1)*0x18*0x3c*0x3c*0x3e8),_0x5b632c(0x116)),_0x591691=_0x5b632c(0xef),_0x30d65e=_0x5b632c(0xb0),_0x3841cb=await this[_0x5b632c(0xb2)][_0x5b632c(0xec)]({'where':{'configKey':(0x0,typeorm_2['In'])(['baiduToken',_0x5b632c(0x106)])}}),_0x2dc1a9=(_0x4bff20=_0x3841cb[_0x5b632c(0xec)](_0xe0fd18=>_0xe0fd18[_0x5b632c(0xb1)]===_0x5b632c(0x106)))===null||_0x4bff20===void 0x0?void 0x0:_0x4bff20[_0x5b632c(0xdc)],_0x445203=(_0x42af03=_0x3841cb[_0x5b632c(0xec)](_0x365825=>_0x365825[_0x5b632c(0xb1)]==='baiduToken'))===null||_0x42af03===void 0x0?void 0x0:_0x42af03['configVal'];if(!_0x2dc1a9||!_0x445203)return[];if(!_0x2dc1a9)throw new common_1[(_0x5b632c(0xb6))](_0x5b632c(0xc2),common_1[_0x5b632c(0xb7)][_0x5b632c(0xcb)]);if(!_0x445203)throw new common_1[(_0x5b632c(0xb6))](_0x5b632c(0x117),common_1[_0x5b632c(0xb7)][_0x5b632c(0xcb)]);const _0x4dd246=_0x5b632c(0xd4)+_0x445203+_0x5b632c(0x11c)+_0x2dc1a9+_0x5b632c(0xdf)+_0x30d65e+'&start_date='+_0x483f91+_0x5b632c(0xbe)+_0x2c2864+_0x5b632c(0xf6)+_0x591691,_0x485d3f=await axios_1['default']['get'](_0x4dd246),{error_code:_0x373236,message:_0x147c27}=_0x485d3f[_0x5b632c(0xc4)];if(_0x373236===0x6f)throw new common_1[(_0x5b632c(0xb6))](_0x147c27||_0x5b632c(0x100),common_1[_0x5b632c(0xb7)]['BAD_REQUEST']);if(_0x373236&&_0x373236!==0xc8)throw new common_1[(_0x5b632c(0xb6))](_0x147c27||_0x5b632c(0xae),common_1[_0x5b632c(0xb7)][_0x5b632c(0xcb)]);return _0x485d3f[_0x5b632c(0xc4)][_0x5b632c(0x10c)];}async[_0x24c338(0xff)](){const _0x250600=_0x24c338,_0x34564c=await this[_0x250600(0xbd)]['count']();return _0x34564c;}async[_0x24c338(0x112)](){const _0x8f17c1=_0x24c338,_0x15fd3e=new Date();_0x15fd3e[_0x8f17c1(0xbc)](0x0,0x0,0x0,0x0);const _0x23abb9=new Date(_0x15fd3e['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x4fec91=this['orderEntity'][_0x8f17c1(0x113)](_0x8f17c1(0xbf)),_0x379a28=await _0x4fec91[_0x8f17c1(0xd9)]('order.createdAt\x20>=\x20:today',{'today':_0x15fd3e})[_0x8f17c1(0x110)](_0x8f17c1(0xe6),{'tomorrow':_0x23abb9})[_0x8f17c1(0xd2)]();return _0x379a28;}};StatisticService=__decorate([(0x0,common_1[_0x24c338(0xc3)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x24c338(0x114)])),__param(0x1,(0x0,typeorm_1[_0x24c338(0xbb)])(chatLog_entity_1[_0x24c338(0xfa)])),__param(0x2,(0x0,typeorm_1[_0x24c338(0xbb)])(config_entity_1['ConfigEntity'])),__param(0x3,(0x0,typeorm_1[_0x24c338(0xbb)])(order_entity_1[_0x24c338(0xda)])),__param(0x4,(0x0,typeorm_1[_0x24c338(0xbb)])(midjourney_entity_1[_0x24c338(0xf4)])),__metadata(_0x24c338(0xb4),[typeorm_2[_0x24c338(0xf8)],typeorm_2[_0x24c338(0xf8)],typeorm_2[_0x24c338(0xf8)],typeorm_2[_0x24c338(0xf8)],typeorm_2['Repository']])],StatisticService),exports['StatisticService']=StatisticService;