'use strict';const _0x8b0b84=_0x54f9;(function(_0x499f4c,_0x311e66){const _0x1593ae=_0x54f9,_0x22310f=_0x499f4c();while(!![]){try{const _0x1a8905=-parseInt(_0x1593ae(0xd4))/0x1+parseInt(_0x1593ae(0x126))/0x2+parseInt(_0x1593ae(0x109))/0x3*(-parseInt(_0x1593ae(0x106))/0x4)+-parseInt(_0x1593ae(0xc9))/0x5*(parseInt(_0x1593ae(0x123))/0x6)+-parseInt(_0x1593ae(0xe9))/0x7*(-parseInt(_0x1593ae(0xda))/0x8)+-parseInt(_0x1593ae(0x111))/0x9+parseInt(_0x1593ae(0xff))/0xa*(parseInt(_0x1593ae(0xf5))/0xb);if(_0x1a8905===_0x311e66)break;else _0x22310f['push'](_0x22310f['shift']());}catch(_0x10b6b3){_0x22310f['push'](_0x22310f['shift']());}}}(_0x6991,0x21054));var __decorate=this&&this[_0x8b0b84(0xce)]||function(_0x2918a1,_0x35ee72,_0x99e8fe,_0x1c9afa){const _0xb858d4=_0x8b0b84;var _0x40ec06=arguments[_0xb858d4(0xfe)],_0x280c3b=_0x40ec06<0x3?_0x35ee72:_0x1c9afa===null?_0x1c9afa=Object[_0xb858d4(0xf3)](_0x35ee72,_0x99e8fe):_0x1c9afa,_0x32dc0d;if(typeof Reflect===_0xb858d4(0xe5)&&typeof Reflect[_0xb858d4(0xf1)]===_0xb858d4(0x12c))_0x280c3b=Reflect[_0xb858d4(0xf1)](_0x2918a1,_0x35ee72,_0x99e8fe,_0x1c9afa);else{for(var _0x3c9182=_0x2918a1[_0xb858d4(0xfe)]-0x1;_0x3c9182>=0x0;_0x3c9182--)if(_0x32dc0d=_0x2918a1[_0x3c9182])_0x280c3b=(_0x40ec06<0x3?_0x32dc0d(_0x280c3b):_0x40ec06>0x3?_0x32dc0d(_0x35ee72,_0x99e8fe,_0x280c3b):_0x32dc0d(_0x35ee72,_0x99e8fe))||_0x280c3b;}return _0x40ec06>0x3&&_0x280c3b&&Object[_0xb858d4(0x130)](_0x35ee72,_0x99e8fe,_0x280c3b),_0x280c3b;},__metadata=this&&this['__metadata']||function(_0x27ee5d,_0x4450ad){const _0x2e492f=_0x8b0b84;if(typeof Reflect===_0x2e492f(0xe5)&&typeof Reflect[_0x2e492f(0xc2)]===_0x2e492f(0x12c))return Reflect[_0x2e492f(0xc2)](_0x27ee5d,_0x4450ad);},__param=this&&this[_0x8b0b84(0xf9)]||function(_0x302f45,_0x4e9d21){return function(_0x47dc8d,_0x4f6ef8){_0x4e9d21(_0x47dc8d,_0x4f6ef8,_0x302f45);};};Object[_0x8b0b84(0x130)](exports,_0x8b0b84(0xe3),{'value':!![]}),exports[_0x8b0b84(0xc6)]=void 0x0;function _0x6991(){const _0x2d008c=['configEntity','function','CHAT_TYPE','orderBy','chatLog.type\x20=\x20:type','defineProperty','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','&start_date=','OrderEntity','user.createdAt\x20<\x20:tomorrow','default','get','metadata','orderEntity','map','InjectRepository','StatisticService','ChatLogEntity','countNewChatsToday','5HUedeP','M.DD','YYYYMMDD','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','configKey','__decorate','DeductionKey','../user/user.entity','getBaiduStatistics','now','getDate','4650guHKvx','result','&site_id=','groupBy','countChatsByTimeRange','createQueryBuilder','64BNCJRh','userEntity','axios','countNewDrawsToday','order.createdAt\x20<\x20:tomorrow','where','countDrawsByTimeRange','DRAWED','ConfigEntity','__esModule','chatLog','object','user.createdAt\x20>=\x20:today','data','midjourneyEntity','52738ixNLjq','design:paramtypes','Repository','countUsers','midjourney.createdAt\x20<\x20:tomorrow','chatlog','countNewOrdersToday','chatlog.type\x20=\x20:type','decorate','&end_date=','getOwnPropertyDescriptor','value','187Feanxo','midjourney.createdAt\x20>=\x20:startDate','&metrics=','countOrders','__param','@nestjs/typeorm','getCount','formatDate','../chatLog/chatLog.entity','length','141010xKvfxz','order','Injectable','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','HttpException','count','countNewUsersToday','4ypchGo','setHours','baiduToken','758811iLixPL','getTime','MidjourneyStatusEnum','andWhere','setDate','chatLogEntity','&method=','chatLog.createdAt\x20<\x20:tomorrow','163575GOudbi','getBaseStatistic','user','countNewMidhourneysToday','overview/getTimeTrendRpt','PAINT_TYPE','chatLog.createdAt\x20>=\x20:today','获取百度统计数据失败','configVal','countMjDrawsByTimeRange','date','chatlog.createdAt\x20>=\x20:startDate','getRawMany','countDraws','find','../order/order.entity','countChats','midjourney','60546hQMVoX','HttpStatus','BAD_REQUEST','242232LSWDvp','push','请先配置百度统计siteId','select','order.createdAt\x20>=\x20:today'];_0x6991=function(){return _0x2d008c;};return _0x6991();}const common_1=require('@nestjs/common'),typeorm_1=require(_0x8b0b84(0xfa)),user_entity_1=require(_0x8b0b84(0xd0)),typeorm_2=require('typeorm'),chatLog_entity_1=require(_0x8b0b84(0xfd)),balance_constant_1=require('../../common/constants/balance.constant'),date_1=require('../../common/utils/date'),axios_1=require(_0x8b0b84(0xdc)),config_entity_1=require('../globalConfig/config.entity'),order_entity_1=require(_0x8b0b84(0x120)),midjourney_entity_1=require('../midjourney/midjourney.entity'),midjourney_constant_1=require('../../common/constants/midjourney.constant');function _0x54f9(_0xe02548,_0x50c816){const _0x6991db=_0x6991();return _0x54f9=function(_0x54f90a,_0x513ded){_0x54f90a=_0x54f90a-0xc1;let _0x4c752a=_0x6991db[_0x54f90a];return _0x4c752a;},_0x54f9(_0xe02548,_0x50c816);}let StatisticService=class StatisticService{constructor(_0x57206c,_0x7d1bfe,_0x5862c1,_0x913d95,_0x307369){const _0x188df3=_0x8b0b84;this[_0x188df3(0xdb)]=_0x57206c,this[_0x188df3(0x10e)]=_0x7d1bfe,this[_0x188df3(0x12b)]=_0x5862c1,this[_0x188df3(0xc3)]=_0x913d95,this[_0x188df3(0xe8)]=_0x307369;}async[_0x8b0b84(0x112)](){const _0x5b967e=_0x8b0b84,_0x12936d=await this[_0x5b967e(0xec)](),_0x3a4013=await this[_0x5b967e(0x105)](),_0x43806f=await this[_0x5b967e(0x121)](),_0x385fc5=await this['countNewChatsToday'](),_0x3fd811=await this[_0x5b967e(0x11e)](),_0x3c87ae=await this[_0x5b967e(0xdd)](),_0x50afee=await this[_0x5b967e(0x114)](),_0x713130=await this[_0x5b967e(0xf8)](),_0xe13ff4=await this['countNewOrdersToday']();return{'userCount':_0x12936d,'newUserCount':_0x3a4013,'chatCount':_0x43806f,'newChatCount':_0x385fc5,'drawCount':_0x3fd811,'newDrawCount':_0x50afee+_0x3c87ae,'orderCount':_0x713130,'newOrderCount':_0xe13ff4};}async['getChatStatistic']({days:days=0x7}){const _0x26cafe=_0x8b0b84,_0x23f47b=await this['countChatsByTimeRange'](days),_0x3be289=await this[_0x26cafe(0xe0)](days),_0x112914=await this['countMjDrawsByTimeRange'](days);return{'date':_0x23f47b[_0x26cafe(0xc4)](_0x195aef=>_0x195aef[_0x26cafe(0x11b)]),'chat':_0x23f47b['map'](_0x23dac4=>_0x23dac4[_0x26cafe(0xf4)]),'draw':_0x3be289['map']((_0x1f30ee,_0x386d03)=>{const _0x87ca64=_0x26cafe;return _0x1f30ee[_0x87ca64(0xf4)]+_0x112914[_0x386d03][_0x87ca64(0xf4)];})};}async['getBaiduVisit']({days:days=0x7}){const _0x596772=_0x8b0b84,_0x5f3a68=await this[_0x596772(0xd1)](days);return _0x5f3a68;}async[_0x8b0b84(0xec)](){const _0x519930=_0x8b0b84,_0x237676=await this[_0x519930(0xdb)]['count']();return _0x237676;}async[_0x8b0b84(0x105)](){const _0x3a9f1f=_0x8b0b84,_0xdfbbdd=new Date();_0xdfbbdd[_0x3a9f1f(0x107)](0x0,0x0,0x0,0x0);const _0xf5ea2c=new Date(_0xdfbbdd[_0x3a9f1f(0x10a)]()+0x18*0x3c*0x3c*0x3e8),_0x1dbf02=this[_0x3a9f1f(0xdb)][_0x3a9f1f(0xd9)](_0x3a9f1f(0x113)),_0xfb431=await _0x1dbf02['where'](_0x3a9f1f(0xe6),{'today':_0xdfbbdd})[_0x3a9f1f(0x10c)](_0x3a9f1f(0x134),{'tomorrow':_0xf5ea2c})['getCount']();return _0xfb431;}async['countChats'](){const _0x201d2b=_0x8b0b84,_0x1f727e=await this['chatLogEntity'][_0x201d2b(0x104)]({'where':{'type':balance_constant_1['DeductionKey'][_0x201d2b(0x12d)]}});return _0x1f727e;}async[_0x8b0b84(0xc8)](){const _0x40c0b6=_0x8b0b84,_0x4ba8af=new Date();_0x4ba8af[_0x40c0b6(0x107)](0x0,0x0,0x0,0x0);const _0x3e530f=new Date(_0x4ba8af['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x447c05=this[_0x40c0b6(0x10e)]['createQueryBuilder'](_0x40c0b6(0xe4)),_0x311537=await _0x447c05['where'](_0x40c0b6(0x12f),{'type':balance_constant_1[_0x40c0b6(0xcf)][_0x40c0b6(0x12d)]})['andWhere'](_0x40c0b6(0x117),{'today':_0x4ba8af})['andWhere'](_0x40c0b6(0x110),{'tomorrow':_0x3e530f})[_0x40c0b6(0xfb)]();return _0x311537;}async[_0x8b0b84(0x11e)](){const _0x24f719=_0x8b0b84,_0x5f13d7=await this[_0x24f719(0x10e)][_0x24f719(0x104)]({'where':{'type':balance_constant_1[_0x24f719(0xcf)][_0x24f719(0x116)]}});return _0x5f13d7;}async['countNewDrawsToday'](){const _0x360e3b=_0x8b0b84,_0x359649=new Date();_0x359649[_0x360e3b(0x107)](0x0,0x0,0x0,0x0);const _0x567da0=new Date(_0x359649[_0x360e3b(0x10a)]()+0x18*0x3c*0x3c*0x3e8),_0x23e3ab=this[_0x360e3b(0x10e)][_0x360e3b(0xd9)](_0x360e3b(0xe4)),_0x1af172=await _0x23e3ab['where'](_0x360e3b(0x12f),{'type':balance_constant_1['DeductionKey'][_0x360e3b(0x116)]})[_0x360e3b(0x10c)](_0x360e3b(0x117),{'today':_0x359649})[_0x360e3b(0x10c)](_0x360e3b(0x110),{'tomorrow':_0x567da0})['getCount']();return _0x1af172;}async[_0x8b0b84(0x114)](){const _0xeadc55=_0x8b0b84,_0x315d6e=new Date();_0x315d6e[_0xeadc55(0x107)](0x0,0x0,0x0,0x0);const _0x2f0747=new Date(_0x315d6e[_0xeadc55(0x10a)]()+0x18*0x3c*0x3c*0x3e8),_0x529827=this[_0xeadc55(0xe8)]['createQueryBuilder'](_0xeadc55(0x122)),_0xd21c9b=await _0x529827[_0xeadc55(0xdf)]('midjourney.createdAt\x20>=\x20:today',{'today':_0x315d6e})[_0xeadc55(0x10c)](_0xeadc55(0xed),{'tomorrow':_0x2f0747})[_0xeadc55(0xfb)]();return _0xd21c9b;}async[_0x8b0b84(0xd8)](_0x3dd80c){const _0x4de012=_0x8b0b84;var _0x6d4335,_0x3550db;const _0x4c2276=new Date();_0x4c2276[_0x4de012(0x107)](0x0,0x0,0x0,0x0);const _0x1577c4=new Date(_0x4c2276[_0x4de012(0x10a)]()-(_0x3dd80c-0x1)*0x18*0x3c*0x3c*0x3e8),_0x4f0ab7=this[_0x4de012(0x10e)][_0x4de012(0xd9)](_0x4de012(0xee)),_0x1cae18=await _0x4f0ab7['select'](_0x4de012(0x131))[_0x4de012(0xdf)](_0x4de012(0xf0),{'type':balance_constant_1[_0x4de012(0xcf)][_0x4de012(0x12d)]})[_0x4de012(0x10c)](_0x4de012(0x11c),{'startDate':_0x1577c4})[_0x4de012(0xd7)](_0x4de012(0x11b))['orderBy'](_0x4de012(0x11b))[_0x4de012(0x11d)](),_0x3a3d3e=[],_0x98dddb=_0x1577c4;for(let _0x480697=0x0;_0x480697<_0x3dd80c;_0x480697++){const _0x330843=(0x0,date_1[_0x4de012(0xfc)])(new Date(_0x98dddb),_0x4de012(0xca)),_0x280995=(_0x3550db=(_0x6d4335=_0x1cae18[_0x4de012(0x11f)](_0x988bd4=>(0x0,date_1[_0x4de012(0xfc)])(new Date(_0x988bd4[_0x4de012(0x11b)]),_0x4de012(0xca))===_0x330843))===null||_0x6d4335===void 0x0?void 0x0:_0x6d4335['count'])!==null&&_0x3550db!==void 0x0?_0x3550db:0x0;_0x280995>0x0?_0x3a3d3e[_0x4de012(0x127)]({'date':_0x330843,'value':Number(_0x280995)}):_0x3a3d3e['push']({'date':_0x330843,'value':0x0}),_0x98dddb[_0x4de012(0x10d)](_0x98dddb[_0x4de012(0xd3)]()+0x1);}return _0x3a3d3e;}async[_0x8b0b84(0xe0)](_0x232062){const _0x14ebef=_0x8b0b84;var _0x43509a,_0x52af6c;const _0x379ca7=new Date();_0x379ca7[_0x14ebef(0x107)](0x0,0x0,0x0,0x0);const _0x140662=new Date(_0x379ca7[_0x14ebef(0x10a)]()-(_0x232062-0x1)*0x18*0x3c*0x3c*0x3e8),_0x359c02=this[_0x14ebef(0x10e)]['createQueryBuilder']('chatlog'),_0x40c6c5=await _0x359c02[_0x14ebef(0x129)](_0x14ebef(0x131))[_0x14ebef(0xdf)](_0x14ebef(0xf0),{'type':balance_constant_1[_0x14ebef(0xcf)][_0x14ebef(0x116)]})[_0x14ebef(0x10c)]('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x140662})[_0x14ebef(0xd7)](_0x14ebef(0x11b))[_0x14ebef(0x12e)](_0x14ebef(0x11b))[_0x14ebef(0x11d)](),_0x3f4fea=[],_0x3dbfad=_0x140662;for(let _0x4b5db6=0x0;_0x4b5db6<_0x232062;_0x4b5db6++){const _0x228587=(0x0,date_1[_0x14ebef(0xfc)])(new Date(_0x3dbfad),_0x14ebef(0xca)),_0x38a548=(_0x52af6c=(_0x43509a=_0x40c6c5[_0x14ebef(0x11f)](_0x5de0cc=>(0x0,date_1[_0x14ebef(0xfc)])(new Date(_0x5de0cc[_0x14ebef(0x11b)]),'M.DD')===_0x228587))===null||_0x43509a===void 0x0?void 0x0:_0x43509a['count'])!==null&&_0x52af6c!==void 0x0?_0x52af6c:0x0;_0x38a548>0x0?_0x3f4fea[_0x14ebef(0x127)]({'date':_0x228587,'value':Number(_0x38a548)}):_0x3f4fea[_0x14ebef(0x127)]({'date':_0x228587,'value':0x0}),_0x3dbfad['setDate'](_0x3dbfad['getDate']()+0x1);}return _0x3f4fea;}async[_0x8b0b84(0x11a)](_0x8b4a99){const _0x3483b3=_0x8b0b84;var _0x3938b3,_0x530950;const _0x581b9f=new Date();_0x581b9f['setHours'](0x0,0x0,0x0,0x0);const _0x1f8249=new Date(_0x581b9f['getTime']()-(_0x8b4a99-0x1)*0x18*0x3c*0x3c*0x3e8),_0x46e5be=this[_0x3483b3(0xe8)][_0x3483b3(0xd9)]('midjourney'),_0x4023d0=await _0x46e5be[_0x3483b3(0x129)]('DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')[_0x3483b3(0xdf)]('midjourney.status\x20=\x20:status',{'status':midjourney_constant_1[_0x3483b3(0x10b)][_0x3483b3(0xe1)]})[_0x3483b3(0x10c)](_0x3483b3(0xf6),{'startDate':_0x1f8249})[_0x3483b3(0xd7)](_0x3483b3(0x11b))['orderBy'](_0x3483b3(0x11b))[_0x3483b3(0x11d)](),_0x330dba=[],_0x14149b=_0x1f8249;for(let _0x2488f5=0x0;_0x2488f5<_0x8b4a99;_0x2488f5++){const _0x492d0b=(0x0,date_1[_0x3483b3(0xfc)])(new Date(_0x14149b),_0x3483b3(0xca)),_0x369db1=(_0x530950=(_0x3938b3=_0x4023d0[_0x3483b3(0x11f)](_0x4e00f5=>(0x0,date_1[_0x3483b3(0xfc)])(new Date(_0x4e00f5['date']),_0x3483b3(0xca))===_0x492d0b))===null||_0x3938b3===void 0x0?void 0x0:_0x3938b3['count'])!==null&&_0x530950!==void 0x0?_0x530950:0x0;_0x369db1>0x0?_0x330dba['push']({'date':_0x492d0b,'value':Number(_0x369db1)}):_0x330dba['push']({'date':_0x492d0b,'value':0x0}),_0x14149b['setDate'](_0x14149b[_0x3483b3(0xd3)]()+0x1);}return _0x330dba;}async[_0x8b0b84(0xd1)](_0x3e3a46){const _0x3b98c7=_0x8b0b84;var _0x6741ba,_0x3ab60b;const _0x2b869d=(0x0,date_1[_0x3b98c7(0xfc)])(new Date(),_0x3b98c7(0xcb)),_0x203b52=(0x0,date_1[_0x3b98c7(0xfc)])(new Date(Date[_0x3b98c7(0xd2)]()-Number(_0x3e3a46-0x1)*0x18*0x3c*0x3c*0x3e8),_0x3b98c7(0xcb)),_0x376970=_0x3b98c7(0xcc),_0xedbe34=_0x3b98c7(0x115),_0x1fb4dd=await this[_0x3b98c7(0x12b)][_0x3b98c7(0x11f)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x3b98c7(0x108),'baiduSiteId'])}}),_0x1bdcdb=(_0x6741ba=_0x1fb4dd[_0x3b98c7(0x11f)](_0x3c2631=>_0x3c2631['configKey']==='baiduSiteId'))===null||_0x6741ba===void 0x0?void 0x0:_0x6741ba['configVal'],_0xeb2d01=(_0x3ab60b=_0x1fb4dd[_0x3b98c7(0x11f)](_0xbd9652=>_0xbd9652[_0x3b98c7(0xcd)]===_0x3b98c7(0x108)))===null||_0x3ab60b===void 0x0?void 0x0:_0x3ab60b[_0x3b98c7(0x119)];if(!_0x1bdcdb||!_0xeb2d01)return[];if(!_0x1bdcdb)throw new common_1[(_0x3b98c7(0x103))](_0x3b98c7(0x128),common_1[_0x3b98c7(0x124)][_0x3b98c7(0x125)]);if(!_0xeb2d01)throw new common_1['HttpException']('请先配置百度统计accessToken',common_1[_0x3b98c7(0x124)]['BAD_REQUEST']);const _0x15862f=_0x3b98c7(0x102)+_0xeb2d01+_0x3b98c7(0xd6)+_0x1bdcdb+_0x3b98c7(0x10f)+_0xedbe34+_0x3b98c7(0x132)+_0x203b52+_0x3b98c7(0xf2)+_0x2b869d+_0x3b98c7(0xf7)+_0x376970,_0x170868=await axios_1[_0x3b98c7(0x135)][_0x3b98c7(0xc1)](_0x15862f),{error_code:_0x404250,message:_0x962ee1}=_0x170868[_0x3b98c7(0xe7)];if(_0x404250===0x6f)throw new common_1[(_0x3b98c7(0x103))](_0x962ee1||'百度授权码过期',common_1['HttpStatus'][_0x3b98c7(0x125)]);if(_0x404250&&_0x404250!==0xc8)throw new common_1['HttpException'](_0x962ee1||_0x3b98c7(0x118),common_1[_0x3b98c7(0x124)][_0x3b98c7(0x125)]);return _0x170868[_0x3b98c7(0xe7)][_0x3b98c7(0xd5)];}async[_0x8b0b84(0xf8)](){const _0x56fe5f=_0x8b0b84,_0x215156=await this[_0x56fe5f(0xc3)]['count']();return _0x215156;}async[_0x8b0b84(0xef)](){const _0x560c6e=_0x8b0b84,_0x2ed023=new Date();_0x2ed023[_0x560c6e(0x107)](0x0,0x0,0x0,0x0);const _0x44ed20=new Date(_0x2ed023['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x3a84b9=this[_0x560c6e(0xc3)][_0x560c6e(0xd9)](_0x560c6e(0x100)),_0x3e0c2e=await _0x3a84b9['where'](_0x560c6e(0x12a),{'today':_0x2ed023})[_0x560c6e(0x10c)](_0x560c6e(0xde),{'tomorrow':_0x44ed20})[_0x560c6e(0xfb)]();return _0x3e0c2e;}};StatisticService=__decorate([(0x0,common_1[_0x8b0b84(0x101)])(),__param(0x0,(0x0,typeorm_1[_0x8b0b84(0xc5)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x8b0b84(0xc5)])(chatLog_entity_1[_0x8b0b84(0xc7)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x8b0b84(0xe2)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x8b0b84(0x133)])),__param(0x4,(0x0,typeorm_1[_0x8b0b84(0xc5)])(midjourney_entity_1['MidjourneyEntity'])),__metadata(_0x8b0b84(0xea),[typeorm_2[_0x8b0b84(0xeb)],typeorm_2['Repository'],typeorm_2[_0x8b0b84(0xeb)],typeorm_2[_0x8b0b84(0xeb)],typeorm_2['Repository']])],StatisticService),exports['StatisticService']=StatisticService;