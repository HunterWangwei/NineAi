'use strict';const _0x469ca0=_0x290a;(function(_0x343567,_0x3f4648){const _0x135253=_0x290a,_0x17a8bf=_0x343567();while(!![]){try{const _0x1921ea=parseInt(_0x135253(0x17b))/0x1*(-parseInt(_0x135253(0x1b6))/0x2)+parseInt(_0x135253(0x165))/0x3+-parseInt(_0x135253(0x157))/0x4*(parseInt(_0x135253(0x1b5))/0x5)+-parseInt(_0x135253(0x193))/0x6*(parseInt(_0x135253(0x151))/0x7)+parseInt(_0x135253(0x1cc))/0x8*(-parseInt(_0x135253(0x1c2))/0x9)+parseInt(_0x135253(0x1cf))/0xa+parseInt(_0x135253(0x1e7))/0xb;if(_0x1921ea===_0x3f4648)break;else _0x17a8bf['push'](_0x17a8bf['shift']());}catch(_0x2638bd){_0x17a8bf['push'](_0x17a8bf['shift']());}}}(_0x22bd,0xed53f));var __decorate=this&&this['__decorate']||function(_0x22d92b,_0x4b30a2,_0x3fa3d9,_0x213acf){const _0x3feb92=_0x290a;var _0x13f48f=arguments[_0x3feb92(0x1a0)],_0x3ae0f6=_0x13f48f<0x3?_0x4b30a2:_0x213acf===null?_0x213acf=Object['getOwnPropertyDescriptor'](_0x4b30a2,_0x3fa3d9):_0x213acf,_0x1183fd;if(typeof Reflect===_0x3feb92(0x18a)&&typeof Reflect['decorate']===_0x3feb92(0x1d9))_0x3ae0f6=Reflect[_0x3feb92(0x192)](_0x22d92b,_0x4b30a2,_0x3fa3d9,_0x213acf);else{for(var _0x4f7d87=_0x22d92b[_0x3feb92(0x1a0)]-0x1;_0x4f7d87>=0x0;_0x4f7d87--)if(_0x1183fd=_0x22d92b[_0x4f7d87])_0x3ae0f6=(_0x13f48f<0x3?_0x1183fd(_0x3ae0f6):_0x13f48f>0x3?_0x1183fd(_0x4b30a2,_0x3fa3d9,_0x3ae0f6):_0x1183fd(_0x4b30a2,_0x3fa3d9))||_0x3ae0f6;}return _0x13f48f>0x3&&_0x3ae0f6&&Object[_0x3feb92(0x179)](_0x4b30a2,_0x3fa3d9,_0x3ae0f6),_0x3ae0f6;},__metadata=this&&this[_0x469ca0(0x174)]||function(_0x53cf84,_0x45cd36){const _0x2cdb7d=_0x469ca0;if(typeof Reflect===_0x2cdb7d(0x18a)&&typeof Reflect[_0x2cdb7d(0x14d)]===_0x2cdb7d(0x1d9))return Reflect['metadata'](_0x53cf84,_0x45cd36);},__param=this&&this[_0x469ca0(0x13d)]||function(_0x2cd7ab,_0x3b7a51){return function(_0x446bd3,_0x33d1a0){_0x3b7a51(_0x446bd3,_0x33d1a0,_0x2cd7ab);};};Object['defineProperty'](exports,_0x469ca0(0x1d2),{'value':!![]}),exports[_0x469ca0(0x14a)]=void 0x0;function _0x22bd(){const _0x23a738=['deductBalance','__esModule','error:\x20','baiduFanyiAppId','baiduFanyiSecret','PAINT_TYPE','message_id','findCurrentPromptResult','function','mjRateLimit','prompt','filter','http://172.247.48.137:8000/mj/list?channel_id=','mjSessionId','发送绘画指令结果:\x20','findCurrentVariationImgResult','开始请求变换图片\x20队列+1:\x20','开始查询绘画结果轮询','当前提示词已经在任务队列中了、请勿重复提交。。。','DeductionKey','绘图指令完成','enlarge','67251624KMlRLl','有历史信息之间返回:\x20','queueCount','match','chatLogEntity','data','createQueryBuilder','放大图片任务结束\x20队列-1:\x20','__param','replace','mjId','发送放大指令成功','components','axios','GlobalConfigService','rateLimits','Repository','由于速率限制、当前普通用户限制为','Injectable','您当前暂无MJ绘画余额！！！','axios\x20get:\x20','MjService','变换当前图片失败','BadwordsService','metadata','放大custom_id:\x20','getConfigs','sleep','262675OVvIqh','fanyiService','./../globalConfig/globalConfig.service','IsNull','getMjDefaultParams','pollForResult','4xUyAsz','变化图片任务异常中断\x20队列-1:\x20','ChatLogEntity','./../upload/upload.service','使用的次数：','Not','INTERNAL_SERVER_ERROR','../fanyi/fanyi.service','\x20次开始查询\x20=>\x20当前查询结果：','当前用户','../chatLog/chatLog.service','秒请求一次、请合理使用！','FanyiService','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','4625544ZFFaSk','getClientIp','@nestjs/common','../../common/constants/balance.constant','find','开始轮询单张变换图片结果','axios:\x20','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','绘画失败','design:paramtypes','本次比对的随机ID:\x20','randomId:\x20','checkBadWords','存入图片完成:\x20','mjGuildId','__metadata','userId\x20=\x20:userId','当前用户\x20','max','response','defineProperty','https://discord.com/api/v9/interactions','1GxEGxM','mjApplicationId','balanceEntity','removeEmoji','uploadService','当前图片已经放大过了、请勿重复放大!','saveChatLog','checkRateLimit','checkAuth','checkFree','Like','绘制图片任务结束\x20队列-1:\x20','parse','放大当前图片失败','message','object','globalConfigService','extractContent','BalanceEntity','BAD_REQUEST','set','网络连接失败，请稍后再试！','chatLogService','decorate','294JjmcDK','放大单张图片请求失败...','mjChannelId','substring','历史记录中不存在当前图片、请确认您放大的图片是否存在','sendDrawInteractions','历史这些id已经被获取过了\x20不能拿了:\x20','error','log','badwordsService','sendSmInteractions','queryMessageList','freeQueueUsers','length','mjNotSaveImg','mjAuthorization','test','variationId','orderId','../../common/utils','开始请求用户','../userBalance/balance.entity','../chatLog/chatLog.entity','stringify','balance\x20-\x201','历史中存在当前图片、直接获取！','变换当前图片超时！','mjDraw','绘制图片任务异常中断\x20队列-1:\x20','user','map','HttpStatus','includes','/messages?limit=50','9146255yhrqIm','2791782mGKEdV','drawWorking','放大图片任务异常中断\x20队列-1:\x20','findOne','查询期间出现错误：','HttpException','url','admin','\x20次开始查询[变换图片]','where','uploadFileFromUrl','http://172.247.48.137:8000/mj/draw','207rPgCsa','now','查询绘制结果失败...','\x20队列+1:\x20','mjVersion','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','本次放大图片的id:\x20','imagine','default','variationSingleImg','649448CBPbLC','pollForUpscaleResult','findCurrentEnlargeImgResult','2474930YteXeo','pollForVariationResult'];_0x22bd=function(){return _0x23a738;};return _0x22bd();}function _0x290a(_0x1a809c,_0x5b7be6){const _0x22bd9f=_0x22bd();return _0x290a=function(_0x290aba,_0x332448){_0x290aba=_0x290aba-0x13a;let _0x13db88=_0x22bd9f[_0x290aba];return _0x13db88;},_0x290a(_0x1a809c,_0x5b7be6);}const globalConfig_service_1=require(_0x469ca0(0x153)),upload_service_1=require(_0x469ca0(0x15a)),common_1=require(_0x469ca0(0x167)),axios_1=require(_0x469ca0(0x142)),chatLog_service_1=require(_0x469ca0(0x161)),balance_constant_1=require(_0x469ca0(0x168)),utils_1=require(_0x469ca0(0x1a6)),chatLog_entity_1=require(_0x469ca0(0x1a9)),typeorm_1=require('typeorm'),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require(_0x469ca0(0x1a8)),fanyi_service_1=require(_0x469ca0(0x15e)),badwords_service_1=require('../badwords/badwords.service');let MjService=class MjService{constructor(_0x279e6b,_0x2e09f0,_0x1cb683,_0x8b6236,_0x3cbeaa,_0x1047cb,_0x55a989){const _0x5c3798=_0x469ca0;this['chatLogEntity']=_0x279e6b,this[_0x5c3798(0x17d)]=_0x2e09f0,this[_0x5c3798(0x17f)]=_0x1cb683,this[_0x5c3798(0x191)]=_0x8b6236,this[_0x5c3798(0x18b)]=_0x3cbeaa,this[_0x5c3798(0x152)]=_0x1047cb,this[_0x5c3798(0x19c)]=_0x55a989,this['rateLimits']={},this[_0x5c3798(0x1b7)]=[],this['enlargeWorking']=[],this[_0x5c3798(0x1e9)]=0x0,this[_0x5c3798(0x19f)]={};}async[_0x469ca0(0x1ae)](_0x9ff8fb){const _0x448ea3=_0x469ca0,{jobId:_0x2d5687,prompt:_0x2d2c62,startTime:_0x551107,userId:_0x1b6c70}=_0x9ff8fb;return console[_0x448ea3(0x19b)]('绘画任务开始','mjservice'),await new Promise(_0x547299=>setTimeout(_0x547299,0x1388)),{'a':0x1,'b':0x2};}async['draw'](_0x37dcd0,_0x3417c3){const _0x6b65f6=_0x469ca0;await this[_0x6b65f6(0x183)](_0x3417c3),await this[_0x6b65f6(0x19c)][_0x6b65f6(0x171)](_0x37dcd0[_0x6b65f6(0x1db)],_0x3417c3[_0x6b65f6(0x1b0)]['id']);const _0x28bc3a=_0x37dcd0[_0x6b65f6(0x1db)];let _0x2316a7=_0x37dcd0[_0x6b65f6(0x1db)];const {baiduFanyiAppId:_0xe92d94,baiduFanyiSecret:_0x45c2a5}=await this[_0x6b65f6(0x18b)]['getConfigs']([_0x6b65f6(0x1d4),_0x6b65f6(0x1d5)]);_0xe92d94&&_0x45c2a5&&(_0x2316a7=await this[_0x6b65f6(0x152)]['convertToEnglish'](_0x28bc3a));const _0x29760f='['+(0x0,utils_1['createRandomUid'])()+']',_0x401caa=_0x29760f+'\x20'+_0x2316a7;console['log'](_0x6b65f6(0x170),_0x29760f),console[_0x6b65f6(0x19b)]('prompt\x20-------->\x20\x20',_0x401caa);const _0x486993=this[_0x6b65f6(0x1b7)]['find'](_0x59f257=>_0x59f257[_0x6b65f6(0x1b3)](_0x37dcd0[_0x6b65f6(0x1db)]));if(_0x486993)throw new common_1['HttpException'](_0x6b65f6(0x1e3),common_1['HttpStatus'][_0x6b65f6(0x18e)]);if(this['queueCount']>=0x3)throw new common_1[(_0x6b65f6(0x1bb))](_0x6b65f6(0x1c7),common_1[_0x6b65f6(0x1b2)]['BAD_REQUEST']);await this['checkRateLimit'](_0x3417c3),this[_0x6b65f6(0x1e9)]++,console[_0x6b65f6(0x19b)](_0x6b65f6(0x1a7)+_0x3417c3[_0x6b65f6(0x1b0)]['id']+_0x6b65f6(0x1c5),this[_0x6b65f6(0x1e9)]);try{const _0x384c8e=await this[_0x6b65f6(0x1eb)][_0x6b65f6(0x169)]({'where':{'prompt':(0x0,typeorm_1[_0x6b65f6(0x185)])('%'+_0x401caa+'%')}}),_0x301f0d=_0x384c8e['map'](_0x19699f=>_0x19699f[_0x6b65f6(0x1d7)]);this['drawWorking']['push'](_0x401caa);let _0x4c4b70;const _0x391391=await this['sendDrawInteractions'](_0x401caa,_0x301f0d,_0x29760f);_0x391391?(console[_0x6b65f6(0x19b)](_0x6b65f6(0x1ac)),_0x4c4b70=_0x391391):_0x4c4b70=await this[_0x6b65f6(0x156)](_0x401caa,_0x301f0d,_0x29760f);this[_0x6b65f6(0x1e9)]--,this[_0x6b65f6(0x1e9)]<0x0&&(this[_0x6b65f6(0x1e9)]=0x0),console['log'](_0x6b65f6(0x186),this[_0x6b65f6(0x1e9)]);const {id:_0x356615,content:_0x191624,channel_id:_0x4472c5,attachments:attachments=[],timestamp:_0x52f57f}=_0x4c4b70;if(!attachments[_0x6b65f6(0x1a0)]||!attachments[0x0][_0x6b65f6(0x1bc)])throw new common_1[(_0x6b65f6(0x1bb))](_0x6b65f6(0x16d),common_1[_0x6b65f6(0x1b2)][_0x6b65f6(0x18e)]);const {filename:_0x5e7256,url:_0x367d01,width:_0x4b0115,height:_0x5e1474,size:_0x215c1a}=attachments[0x0],_0x4991b9=this[_0x6b65f6(0x18b)]['getConfigs']([_0x6b65f6(0x1a1)]);let _0x442296='';(!Number(_0x4991b9)||Number(_0x4991b9)===0x0)&&(_0x442296=await this[_0x6b65f6(0x17f)][_0x6b65f6(0x1c0)]({'filename':_0x5e7256,'url':_0x367d01}),console['log'](_0x6b65f6(0x172),_0x442296));const _0x468ccd={'curIp':(0x0,utils_1[_0x6b65f6(0x166)])(_0x3417c3),'userId':_0x3417c3[_0x6b65f6(0x1b0)]['id'],'type':balance_constant_1[_0x6b65f6(0x1e4)][_0x6b65f6(0x1d6)],'prompt':_0x401caa,'answer':_0x442296,'model':'mj','extend':this[_0x6b65f6(0x17e)](JSON['stringify'](_0x4c4b70)),'message_id':_0x356615,'variationId':_0x356615,'upscaleId':_0x356615,'group':0x1,'isSaveImg':!Number(_0x4991b9)||Number(_0x4991b9)===0x0,'fileInfo':JSON['stringify']({'width':_0x4b0115,'height':_0x5e1474,'size':_0x215c1a,'filename':_0x5e7256,'cosUrl':_0x442296})};return await this[_0x6b65f6(0x191)]['saveChatLog'](_0x468ccd),await this[_0x6b65f6(0x1d1)](_0x3417c3),this[_0x6b65f6(0x1b7)]=this[_0x6b65f6(0x1b7)]['filter'](_0x50079c=>_0x50079c!==_0x37dcd0[_0x6b65f6(0x1db)]),_0x442296;}catch(_0x140fa4){this[_0x6b65f6(0x1e9)]--,this[_0x6b65f6(0x1e9)]<0x0&&(this[_0x6b65f6(0x1e9)]=0x0),console[_0x6b65f6(0x19b)](_0x6b65f6(0x1af),this['queueCount']),this['drawWorking']=this[_0x6b65f6(0x1b7)][_0x6b65f6(0x1dc)](_0x4d82b9=>_0x4d82b9!==_0x37dcd0[_0x6b65f6(0x1db)]);throw new common_1[(_0x6b65f6(0x1bb))](_0x140fa4[_0x6b65f6(0x178)],common_1[_0x6b65f6(0x1b2)]['BAD_REQUEST']);}}async['upscaleSingleImg'](_0x197bb6,_0x6ccee){const _0x11e3c8=_0x469ca0;if(this['queueCount']>=0x3)throw new common_1[(_0x11e3c8(0x1bb))](_0x11e3c8(0x1c7),common_1['HttpStatus']['BAD_REQUEST']);this['queueCount']++,console['log']('用户'+_0x6ccee['user']['id']+'开始请求放大图片\x20队列+1:\x20',this[_0x11e3c8(0x1e9)]);const {message_id:_0x203c5a,orderId:_0x1a0e8b}=_0x197bb6;try{const _0x3425ad=await this[_0x11e3c8(0x1eb)][_0x11e3c8(0x1b9)]({'where':{'message_id':_0x203c5a}});if(!_0x3425ad)throw new common_1['HttpException'](_0x11e3c8(0x197),common_1[_0x11e3c8(0x1b2)][_0x11e3c8(0x18e)]);const _0x4301e6=await this[_0x11e3c8(0x1eb)]['findOne']({'where':{'upscaleId':_0x203c5a,'action':_0x11e3c8(0x1e6),'orderId':_0x1a0e8b}});if(_0x4301e6)throw new common_1[(_0x11e3c8(0x1bb))](_0x11e3c8(0x180),common_1[_0x11e3c8(0x1b2)][_0x11e3c8(0x18e)]);const {prompt:_0x3283e5,extend:_0x52d24c}=_0x3425ad;let _0x4757fa=null;try{_0x4757fa=JSON[_0x11e3c8(0x187)](_0x52d24c);}catch(_0x554b06){_0x4757fa=[];}const {components:components=[]}=_0x4757fa;if(!components[_0x11e3c8(0x1a0)])throw new common_1[(_0x11e3c8(0x1bb))]('当前图片没有绘画信息、无法放大!',common_1[_0x11e3c8(0x1b2)][_0x11e3c8(0x18e)]);const _0x59b74d=components[0x0][_0x11e3c8(0x141)][_0x1a0e8b-0x1],{custom_id:_0x3c5dd9}=_0x59b74d;console[_0x11e3c8(0x19b)](_0x11e3c8(0x14e),_0x3c5dd9);const _0x269849={'message_id':_0x203c5a,'custom_id':_0x3c5dd9,'prompt':_0x3283e5,'orderId':_0x1a0e8b};await this[_0x11e3c8(0x19d)](_0x269849),console[_0x11e3c8(0x19b)](_0x11e3c8(0x140));const _0x4e452c=await this['chatLogEntity'][_0x11e3c8(0x169)]({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0x3283e5+'%')}}),_0xfdffbf=_0x4e452c[_0x11e3c8(0x1b1)](_0xc6d986=>_0xc6d986[_0x11e3c8(0x1d7)]);console[_0x11e3c8(0x19b)](_0x11e3c8(0x199),_0xfdffbf);const _0x408c4f=await this[_0x11e3c8(0x1cd)](_0x269849,_0xfdffbf);this['queueCount']--,this['queueCount']<0x0&&(this[_0x11e3c8(0x1e9)]=0x0),console['log'](_0x11e3c8(0x13c),this['queueCount']);const {id:_0x569104,content:_0x1c9a25,channel_id:_0x3f1586,attachments:attachments=[],timestamp:_0x389457}=_0x408c4f;if(!attachments[_0x11e3c8(0x1a0)]||!attachments[0x0][_0x11e3c8(0x1bc)])throw new common_1['HttpException'](_0x11e3c8(0x188),common_1['HttpStatus'][_0x11e3c8(0x18e)]);const {filename:_0x40a8e7,url:_0x15d81c,width:_0x3cf14a,height:_0x3ff2f3,size:_0x1becd9}=attachments[0x0],_0x14f38b=this[_0x11e3c8(0x18b)][_0x11e3c8(0x14f)]([_0x11e3c8(0x1a1)]);let _0x4ddc03='';(!Number(_0x14f38b)||Number(_0x14f38b)===0x0)&&(_0x4ddc03=await this[_0x11e3c8(0x17f)][_0x11e3c8(0x1c0)]({'filename':_0x40a8e7,'url':_0x15d81c}),console['log'](_0x11e3c8(0x172),_0x4ddc03));const _0x2fce7c={'curIp':(0x0,utils_1[_0x11e3c8(0x166)])(_0x6ccee),'userId':_0x6ccee[_0x11e3c8(0x1b0)]['id'],'type':balance_constant_1['DeductionKey']['PAINT_TYPE'],'prompt':_0x3283e5,'answer':_0x4ddc03,'model':'mj','extend':this[_0x11e3c8(0x17e)](JSON['stringify'](_0x408c4f)),'message_id':_0x203c5a,'upscaleId':_0x569104,'variationId':_0x569104,'action':'enlarge','orderId':_0x269849[_0x11e3c8(0x1a5)],'isSaveImg':!Number(_0x14f38b)||Number(_0x14f38b)===0x0,'fileInfo':JSON['stringify']({'width':_0x3cf14a,'height':_0x3ff2f3,'size':_0x1becd9,'filename':_0x40a8e7,'cosUrl':_0x4ddc03})};return await this[_0x11e3c8(0x191)][_0x11e3c8(0x181)](_0x2fce7c),_0x4ddc03;}catch(_0x36a305){console[_0x11e3c8(0x19b)]('error:\x20',_0x36a305),this[_0x11e3c8(0x1e9)]--,this[_0x11e3c8(0x1e9)]<0x0&&(this[_0x11e3c8(0x1e9)]=0x0),console[_0x11e3c8(0x19b)](_0x11e3c8(0x1b8),this[_0x11e3c8(0x1e9)]);throw new common_1['HttpException'](_0x36a305[_0x11e3c8(0x178)],common_1[_0x11e3c8(0x1b2)][_0x11e3c8(0x18e)]);}}async[_0x469ca0(0x1cb)](_0x547689,_0xef80a){const _0x26c4b8=_0x469ca0;if(this[_0x26c4b8(0x1e9)]>=0x3)throw new common_1[(_0x26c4b8(0x1bb))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1['HttpStatus'][_0x26c4b8(0x18e)]);await this[_0x26c4b8(0x183)](_0xef80a),await this[_0x26c4b8(0x182)](_0xef80a),this[_0x26c4b8(0x1e9)]++,console[_0x26c4b8(0x19b)]('用户'+_0xef80a[_0x26c4b8(0x1b0)]['id']+_0x26c4b8(0x1e1),this[_0x26c4b8(0x1e9)]);const {message_id:_0x25b150,orderId:_0x37fbb0}=_0x547689;try{const _0x237156=await this[_0x26c4b8(0x1eb)][_0x26c4b8(0x1b9)]({'where':{'message_id':_0x25b150}});if(!_0x237156)throw new common_1['HttpException'](_0x26c4b8(0x164),common_1[_0x26c4b8(0x1b2)][_0x26c4b8(0x18e)]);const {prompt:_0x12a49d,extend:_0x14584d}=_0x237156;let _0x2db0e8=null;try{_0x2db0e8=JSON[_0x26c4b8(0x187)](_0x14584d);}catch(_0x249a9d){_0x2db0e8=[];}const {components:components=[]}=_0x2db0e8;if(!components['length'])throw new common_1[(_0x26c4b8(0x1bb))]('当前图片没有绘画信息、无法变体!',common_1[_0x26c4b8(0x1b2)][_0x26c4b8(0x18e)]);const _0x2b1a67=components[0x1][_0x26c4b8(0x141)][_0x37fbb0-0x1],{custom_id:_0xf8c5dd}=_0x2b1a67,_0x172742=await this[_0x26c4b8(0x1eb)][_0x26c4b8(0x169)]({'where':{'variationId':(0x0,typeorm_1[_0x26c4b8(0x15c)])((0x0,typeorm_1[_0x26c4b8(0x154)])()),'prompt':(0x0,typeorm_1[_0x26c4b8(0x185)])('%'+_0x12a49d+'%')}}),_0x76901b=_0x172742[_0x26c4b8(0x1b1)](_0x3f718c=>_0x3f718c[_0x26c4b8(0x1a4)]),_0x1977bd={'message_id':_0x25b150,'custom_id':_0xf8c5dd,'prompt':_0x12a49d,'orderId':_0x37fbb0};await this['sendSmInteractions'](_0x1977bd);const _0x2a333c=await this[_0x26c4b8(0x1d0)](_0x1977bd,_0x76901b);this[_0x26c4b8(0x1e9)]--,this['queueCount']<0x0&&(this[_0x26c4b8(0x1e9)]=0x0),console['log']('变换图片任务结束\x20队列-1:\x20',this['queueCount']);const {id:_0x5d50f0,content:_0x26c17d,channel_id:_0x319dc5,attachments:attachments=[],timestamp:_0x631f63}=_0x2a333c;if(!attachments[_0x26c4b8(0x1a0)]||!attachments[0x0][_0x26c4b8(0x1bc)])throw new common_1[(_0x26c4b8(0x1bb))](_0x26c4b8(0x14b),common_1[_0x26c4b8(0x1b2)][_0x26c4b8(0x18e)]);const {filename:_0x5e1844,url:_0x2ea17b,width:_0x21ea6c,height:_0x4c7b2d,size:_0x3af79a}=attachments[0x0],_0x5e4452=this[_0x26c4b8(0x18b)]['getConfigs']([_0x26c4b8(0x1a1)]);let _0xec1d86='';(!Number(_0x5e4452)||Number(_0x5e4452)===0x0)&&(_0xec1d86=await this['uploadService'][_0x26c4b8(0x1c0)]({'filename':_0x5e1844,'url':_0x2ea17b}),console[_0x26c4b8(0x19b)](_0x26c4b8(0x172),_0xec1d86));const _0x28e66e={'curIp':(0x0,utils_1[_0x26c4b8(0x166)])(_0xef80a),'userId':_0xef80a['user']['id'],'type':balance_constant_1[_0x26c4b8(0x1e4)]['PAINT_TYPE'],'prompt':_0x12a49d,'answer':_0xec1d86,'model':'mj','group':0x1,'extend':this[_0x26c4b8(0x17e)](JSON[_0x26c4b8(0x1aa)](_0x2a333c)),'message_id':_0x5d50f0,'upscaleId':_0x5d50f0,'variationId':_0x5d50f0,'action':_0x26c4b8(0x1e6),'orderId':_0x1977bd[_0x26c4b8(0x1a5)],'isSaveImg':!Number(_0x5e4452)||Number(_0x5e4452)===0x0,'fileInfo':JSON[_0x26c4b8(0x1aa)]({'width':_0x21ea6c,'height':_0x4c7b2d,'size':_0x3af79a,'filename':_0x5e1844,'cosUrl':_0xec1d86})};return await this['chatLogService']['saveChatLog'](_0x28e66e),_0xec1d86;}catch(_0x412c3e){console[_0x26c4b8(0x19b)](_0x26c4b8(0x1d3),_0x412c3e),this[_0x26c4b8(0x1e9)]--,this['queueCount']<0x0&&(this[_0x26c4b8(0x1e9)]=0x0),console[_0x26c4b8(0x19b)](_0x26c4b8(0x158),this[_0x26c4b8(0x1e9)]);throw new common_1['HttpException'](_0x412c3e[_0x26c4b8(0x178)],common_1[_0x26c4b8(0x1b2)][_0x26c4b8(0x18e)]);}}async[_0x469ca0(0x19d)](_0x663abe){const _0x1e1cc4=_0x469ca0,{message_id:_0x11cd86,custom_id:_0x3d43fe}=_0x663abe,{application_id:_0x207e35,guild_id:_0x352158,channel_id:_0x1f1b78,session_id:_0x5d68fd,version:_0x3b8694,id:_0x2813d7,authorization:_0x42de5e,mjProxy:_0x3781b7}=await this[_0x1e1cc4(0x155)](),_0xb35215=_0x3781b7==0x1?_0x1e1cc4(0x1c1):_0x1e1cc4(0x17a),_0x49908c={'authorization':_0x42de5e},_0x1a33c6={'type':0x3,'guild_id':_0x352158,'channel_id':_0x1f1b78,'message_flags':0x0,'message_id':_0x11cd86,'application_id':_0x207e35,'session_id':_0x5d68fd,'data':{'component_type':0x2,'custom_id':_0x3d43fe}};try{await axios_1[_0x1e1cc4(0x1ca)]['post'](_0xb35215,_0x1a33c6,{'headers':_0x49908c}),console[_0x1e1cc4(0x19b)](_0x1e1cc4(0x1e5));}catch(_0x594923){console[_0x1e1cc4(0x19b)](_0x1e1cc4(0x1d3),_0x594923);throw new common_1[(_0x1e1cc4(0x1bb))](_0x1e1cc4(0x194),common_1[_0x1e1cc4(0x1b2)][_0x1e1cc4(0x18e)]);}}async[_0x469ca0(0x1cd)](_0x402f1e,_0x4afb32){const _0x3b9468=_0x469ca0,{message_id:_0x2b7b2d,custom_id:_0x4616cd,prompt:_0x160e51,orderId:_0x311b70}=_0x402f1e;let _0x11949d=null,_0x2a1ec3=0x0;while(!_0x11949d&&_0x2a1ec3<0xa){try{const _0x26d957=Date[_0x3b9468(0x1c3)](),_0x5a000=await this[_0x3b9468(0x19e)]();console[_0x3b9468(0x19b)]('第\x20'+(_0x2a1ec3+0x1)+_0x3b9468(0x15f)+_0x5a000[_0x3b9468(0x1a0)]);_0x5a000&&_0x5a000[_0x3b9468(0x1a0)]&&(_0x11949d=await this[_0x3b9468(0x1ce)](_0x5a000,_0x402f1e,_0x4afb32));const _0x3dbba5=Date['now']()-_0x26d957,_0x1fd672=0xbb8;await this['sleep'](Math[_0x3b9468(0x177)](_0x1fd672-_0x3dbba5,0x0)),_0x2a1ec3++;}catch(_0x30edf5){console[_0x3b9468(0x19a)](_0x3b9468(0x1ba)+_0x30edf5['message']);}}return _0x11949d;}async[_0x469ca0(0x1d0)](_0x4745d7,_0x178bb6){const _0x3980f1=_0x469ca0,{message_id:_0x1a6534,custom_id:_0x3d0a57,prompt:_0x314576,orderId:_0x3aed54}=_0x4745d7;console[_0x3980f1(0x19b)](_0x3980f1(0x16a));let _0x864db=null,_0xd11047=0x0;while(!_0x864db&&_0xd11047<0xa){try{console['log']('第\x20'+(_0xd11047+0x1)+_0x3980f1(0x1be));const _0x322e5c=Date[_0x3980f1(0x1c3)](),_0x171df4=await this['queryMessageList']();_0x171df4&&_0x171df4[_0x3980f1(0x1a0)]&&(_0x864db=await this[_0x3980f1(0x1e0)](_0x171df4,_0x4745d7,_0x178bb6));const _0x21492c=Date[_0x3980f1(0x1c3)]()-_0x322e5c,_0x2a6d3c=0x1f40;await this['sleep'](Math[_0x3980f1(0x177)](_0x2a6d3c-_0x21492c,0x0)),_0xd11047++;}catch(_0x535b8c){console[_0x3980f1(0x19a)](_0x3980f1(0x1ba)+_0x535b8c[_0x3980f1(0x189)]);}}if(!_0x864db)throw new common_1['HttpException'](_0x3980f1(0x1ad),common_1['HttpStatus']['BAD_REQUEST']);return _0x864db;}async['findCurrentEnlargeImgResult'](_0x5bdab0,_0x42e1bc,_0x47c5f0){const _0x206872=_0x469ca0,{message_id:_0x1964b6,custom_id:_0x217ade,prompt:_0x443134,orderId:_0x2789cf}=_0x42e1bc,_0x30863d=_0x443134[_0x206872(0x196)](0x0,0xc);console[_0x206872(0x19b)](_0x206872(0x1c8),_0x30863d);const _0x155e6c=_0x5bdab0[_0x206872(0x169)](_0x5d7646=>{const _0x57e9a4=_0x206872,{content:_0x181210}=_0x5d7646;if(!this[_0x57e9a4(0x18c)](_0x181210))return![];const {prompt:_0x37707d,order:_0x3d6aeb}=this[_0x57e9a4(0x18c)](_0x181210);return _0x37707d[_0x57e9a4(0x1b3)](_0x30863d)&&_0x42e1bc[_0x57e9a4(0x1a5)]===_0x3d6aeb&&!_0x47c5f0['includes'](_0x5d7646['id']);});return _0x155e6c;}async[_0x469ca0(0x1e0)](_0x2bff09,_0x4cd77a,_0x4a7d6e){const _0x49ec27=_0x469ca0,{message_id:_0x58804f,custom_id:_0x288cfe,prompt:_0x1f1fcf,orderId:_0x207bde}=_0x4cd77a,_0x30c407=_0x1f1fcf[_0x49ec27(0x196)](0x0,0xc),_0x99b986=_0x2bff09[_0x49ec27(0x169)](_0x553a17=>{const _0x2e07aa=_0x49ec27,{content:_0x2a415c}=_0x553a17,_0x27d5b1=_0x2a415c[_0x2e07aa(0x1ea)](/\*\*(.+?)\*\*/),_0x36f01c=_0x27d5b1?_0x27d5b1[0x1]:'';if(!_0x36f01c)return![];return _0x36f01c[_0x2e07aa(0x1b3)](_0x30c407)&&!_0x4a7d6e[_0x2e07aa(0x1b3)](_0x553a17['id']);});return _0x99b986;}async[_0x469ca0(0x198)](_0x167bd3,_0x2c2f02,_0x438dce){const _0x5b1b0f=_0x469ca0,_0x3c0f4a=await this[_0x5b1b0f(0x19e)](),_0xed4f8a=await this[_0x5b1b0f(0x1d8)](_0x3c0f4a,_0x438dce,_0x2c2f02);if(_0xed4f8a)return console[_0x5b1b0f(0x19b)](_0x5b1b0f(0x1e8),_0xed4f8a),_0xed4f8a;const {application_id:_0x16307f,guild_id:_0x81f520,channel_id:_0x346f94,session_id:_0x2eb2a3,version:_0xeee401,id:_0x5297a7,authorization:_0x256d44,mjProxy:_0x350d58}=await this[_0x5b1b0f(0x155)](),_0x4527e7={'type':0x2,'application_id':_0x16307f,'guild_id':_0x81f520,'channel_id':_0x346f94,'session_id':_0x2eb2a3,'data':{'version':_0xeee401,'id':_0x5297a7,'name':_0x5b1b0f(0x1c9),'type':0x1,'options':[{'type':0x3,'name':'prompt','value':_0x167bd3}],'attachments':[]}};try{const _0x16f0e5=_0x350d58==0x1?_0x5b1b0f(0x1c1):_0x5b1b0f(0x17a),_0x13d08a={'authorization':_0x256d44},_0x290614=await axios_1['default']['post'](_0x16f0e5,_0x4527e7,{'headers':_0x13d08a});return console[_0x5b1b0f(0x19b)](_0x5b1b0f(0x1df),_0x290614[_0x5b1b0f(0x13a)]),![];}catch(_0x2f0b01){console[_0x5b1b0f(0x19b)](_0x5b1b0f(0x16b),_0x2f0b01);throw new common_1[(_0x5b1b0f(0x1bb))](_0x5b1b0f(0x16c),common_1[_0x5b1b0f(0x1b2)][_0x5b1b0f(0x18e)]);}}async[_0x469ca0(0x156)](_0x469e03,_0x13ed47,_0x3f2d2a){const _0x49e994=_0x469ca0;console[_0x49e994(0x19b)](_0x49e994(0x1e2));const _0x27da1d=Date['now']();try{const _0x41e43d=0xd,_0x55d36b=0x2ee0,_0x7b50fa=0x1388,_0x2127f0=0x3c*0x3e8;let _0x302758=0x0,_0x55a8d6=![],_0x51aac8=null;while(!_0x51aac8&&_0x302758<_0x41e43d){console['log']('第\x20'+(_0x302758+0x1)+'\x20次开始查询');Date[_0x49e994(0x1c3)]()-_0x27da1d>=_0x2127f0&&(_0x55a8d6=!![]);await this[_0x49e994(0x150)](_0x55a8d6?_0x7b50fa:_0x55d36b);const _0x2975f4=await this[_0x49e994(0x19e)]();_0x51aac8=await this['findCurrentPromptResult'](_0x2975f4,_0x3f2d2a,_0x13ed47),_0x302758++;}if(!_0x51aac8)throw new common_1[(_0x49e994(0x1bb))]('绘画超时，请稍后再试！',common_1['HttpStatus'][_0x49e994(0x18e)]);const _0x68d9cc=Date[_0x49e994(0x1c3)]();return console['log']('本次绘图耗时:\x20'+Math['floor']((_0x68d9cc-_0x27da1d)/0x3e8)+'\x20S'),_0x51aac8;}catch(_0x19c0f6){console['error'](_0x19c0f6[_0x49e994(0x189)]);throw new common_1[(_0x49e994(0x1bb))](_0x49e994(0x190),common_1[_0x49e994(0x1b2)][_0x49e994(0x15d)]);}}async[_0x469ca0(0x1d8)](_0x20bac8,_0x5a5f89,_0x4ce37e){const _0x2b8a31=_0x469ca0;if(!_0x20bac8||!_0x20bac8['length'])return;console[_0x2b8a31(0x19b)](_0x2b8a31(0x16f),_0x5a5f89);const _0x169ca7=_0x20bac8['find'](_0x3d2f76=>{const _0x183f6f=_0x2b8a31,{attachments:attachments=[],content:_0xd28486,edited_timestamp:_0x22c645}=_0x3d2f76;return _0xd28486[_0x183f6f(0x1b3)](_0x5a5f89)&&attachments[_0x183f6f(0x1a0)]>0x0&&!_0x22c645&&!_0x4ce37e[_0x183f6f(0x1b3)](_0x3d2f76['id']);});return _0x169ca7||null;}async[_0x469ca0(0x19e)](){const _0x1c4df2=_0x469ca0;try{const {application_id:_0x11730f,guild_id:_0x2f5a9c,channel_id:_0x3ba284,session_id:_0x231995,version:_0x36c1da,id:_0x2444f7,authorization:_0x11c54f,mjProxy:_0x23d38f}=await this['getMjDefaultParams'](),_0x37bc6e=_0x23d38f==0x1?_0x1c4df2(0x1dd)+_0x3ba284:'https://discord.com/api/v9/channels/'+_0x3ba284+_0x1c4df2(0x1b4),_0x7924ba={'authorization':_0x11c54f},_0x57d6b8=await axios_1[_0x1c4df2(0x1ca)]['get'](_0x37bc6e,{'headers':_0x7924ba});return _0x57d6b8[_0x1c4df2(0x13a)];}catch(_0x59a1c8){console['log'](_0x1c4df2(0x149),_0x59a1c8);throw new common_1[(_0x1c4df2(0x1bb))](_0x1c4df2(0x1c4),common_1[_0x1c4df2(0x1b2)]['BAD_REQUEST']);}}async[_0x469ca0(0x150)](_0x3f917c){return new Promise(_0x3908e6=>setTimeout(_0x3908e6,_0x3f917c));}['extractContent'](_0x3fbfea){const _0x35fbb0=_0x469ca0,_0x33d2d7=_0x3fbfea[_0x35fbb0(0x1ea)](/\*\*(.+?)\*\*/),_0x35a309=_0x3fbfea[_0x35fbb0(0x1ea)](/- Image #(\d+)/);if(!_0x33d2d7||!_0x35a309)return null;const _0x5bfa11=_0x33d2d7[0x1],_0x914df0=parseInt(_0x35a309[0x1]);return{'prompt':_0x5bfa11,'order':_0x914df0};}async[_0x469ca0(0x155)](){const _0x21b592=_0x469ca0,_0x1c66e2=await this['globalConfigService'][_0x21b592(0x14f)]([_0x21b592(0x13f),_0x21b592(0x17c),_0x21b592(0x173),_0x21b592(0x195),_0x21b592(0x1de),_0x21b592(0x1c6),_0x21b592(0x1a2),_0x21b592(0x1da),'mjProxy']),_0x423107={'application_id':_0x1c66e2['mjApplicationId'],'guild_id':_0x1c66e2[_0x21b592(0x173)],'channel_id':_0x1c66e2[_0x21b592(0x195)],'session_id':_0x1c66e2[_0x21b592(0x1de)],'version':_0x1c66e2[_0x21b592(0x1c6)],'id':_0x1c66e2[_0x21b592(0x13f)],'authorization':_0x1c66e2[_0x21b592(0x1a2)],'mjRateLimit':_0x1c66e2[_0x21b592(0x1da)],'mjProxy':_0x1c66e2['mjProxy']||0x0};return _0x423107;}[_0x469ca0(0x17e)](_0x405907){const _0x14787a=_0x469ca0,_0x4afc3f=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x405907[_0x14787a(0x13e)](_0x4afc3f,'');}async[_0x469ca0(0x183)](_0x4fb0ce){const _0x3d9d0f=_0x469ca0,_0x3e2a5b=await this['balanceEntity'][_0x3d9d0f(0x1b9)]({'where':{'userId':_0x4fb0ce[_0x3d9d0f(0x1b0)]['id']}}),{id:_0x26d442,balance:_0x53190f}=_0x3e2a5b;if(!_0x53190f||(_0x3e2a5b===null||_0x3e2a5b===void 0x0?void 0x0:_0x3e2a5b['balance'])<0x1)throw new common_1[(_0x3d9d0f(0x1bb))](_0x3d9d0f(0x148),common_1[_0x3d9d0f(0x1b2)][_0x3d9d0f(0x18e)]);}async[_0x469ca0(0x184)](_0xdaf570){const _0x31fb57=_0x469ca0,{id:_0x3ce2ab,role:_0x189a05}=_0xdaf570['user'];!this['freeQueueUsers'][_0x3ce2ab]?this[_0x31fb57(0x19f)][_0x3ce2ab]=0x1:this[_0x31fb57(0x19f)][_0x3ce2ab]=this[_0x31fb57(0x19f)][_0x3ce2ab]+0x1,console['log'](_0x31fb57(0x160)+_0x3ce2ab+_0x31fb57(0x15b),this[_0x31fb57(0x19f)][_0x3ce2ab]);}async['checkRateLimit'](_0xdc3bd0){const _0x5c4725=_0x469ca0,{id:_0xb4b4e4,role:_0x1d1aa2}=_0xdc3bd0[_0x5c4725(0x1b0)];if([_0x5c4725(0x1bd),'super'][_0x5c4725(0x1b3)](_0x1d1aa2))return!![];const {mjRateLimit:_0x55b106}=await this[_0x5c4725(0x155)]();if(this[_0x5c4725(0x144)][_0xb4b4e4]){const _0x493f8c=this['rateLimits'][_0xb4b4e4];if(_0x493f8c>Date[_0x5c4725(0x1c3)]()){console['log'](_0x5c4725(0x176)+_0xb4b4e4+'\x20请求过于频繁！');throw new common_1[(_0x5c4725(0x1bb))](_0x5c4725(0x146)+_0x55b106+_0x5c4725(0x162),common_1[_0x5c4725(0x1b2)]['BAD_REQUEST']);}else this[_0x5c4725(0x144)][_0xb4b4e4]=Date[_0x5c4725(0x1c3)]()+Number(_0x55b106)*0x3e8;}else{const _0x38d4e2=Date[_0x5c4725(0x1c3)]();this['rateLimits'][_0xb4b4e4]=_0x38d4e2+0x3e8*Number(_0x55b106);}}async[_0x469ca0(0x1d1)](_0x4ed457){const _0x659146=_0x469ca0;await this[_0x659146(0x17d)][_0x659146(0x13b)]()['update'](balance_entity_1[_0x659146(0x18d)])[_0x659146(0x18f)]({'balance':()=>_0x659146(0x1ab)})[_0x659146(0x1bf)](_0x659146(0x175),{'userId':_0x4ed457['user']['id']})['execute']();}async[_0x469ca0(0x1a3)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x469ca0(0x147)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(chatLog_entity_1[_0x469ca0(0x159)])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(balance_entity_1[_0x469ca0(0x18d)])),__metadata(_0x469ca0(0x16e),[typeorm_1[_0x469ca0(0x145)],typeorm_1[_0x469ca0(0x145)],upload_service_1['UploadService'],chatLog_service_1['ChatLogService'],globalConfig_service_1[_0x469ca0(0x143)],fanyi_service_1[_0x469ca0(0x163)],badwords_service_1[_0x469ca0(0x14c)]])],MjService),exports[_0x469ca0(0x14a)]=MjService;