'use strict';const _0x50cd44=_0xac14;(function(_0x15eece,_0x28244c){const _0x55553b=_0xac14,_0x18c02a=_0x15eece();while(!![]){try{const _0x4d168e=-parseInt(_0x55553b(0x14a))/0x1+-parseInt(_0x55553b(0x14d))/0x2*(-parseInt(_0x55553b(0x13f))/0x3)+parseInt(_0x55553b(0xe3))/0x4+-parseInt(_0x55553b(0x168))/0x5+-parseInt(_0x55553b(0x185))/0x6*(parseInt(_0x55553b(0x14e))/0x7)+-parseInt(_0x55553b(0x137))/0x8*(parseInt(_0x55553b(0x152))/0x9)+parseInt(_0x55553b(0xdb))/0xa;if(_0x4d168e===_0x28244c)break;else _0x18c02a['push'](_0x18c02a['shift']());}catch(_0x5b58a3){_0x18c02a['push'](_0x18c02a['shift']());}}}(_0x178f,0xe05ed));function _0x178f(){const _0x2c35c9=['MjService','\x20次开始查询\x20=>\x20当前查询结果：','开始轮询单张变换图片结果','mjId','Repository','saveChatLog','\x20次开始查询[变换图片]','变换当前图片失败','../userBalance/balance.entity','../chatLog/chatLog.service','badwordsService','2905215jtVvjs','./../upload/upload.service','push','变换当前图片超时！','HttpStatus','balanceEntity','deductBalance','mjDraw','balance','log','set','查询期间出现错误：','floor','../../common/constants/balance.constant','pollForResult','design:paramtypes','mjAuthorization','InjectRepository','../chatLog/chatLog.entity','freeQueueUsers','where','网络连接失败，请稍后再试！','draw','prompt','findCurrentVariationImgResult','开始请求变换图片\x20队列+1:\x20','components','getConfigs','randomId:\x20','21498rrNmrE','queryMessageList','execute','绘图指令完成','mjChannelId','parse','当前图片已经放大过了、请勿重复放大!','uploadFileFromUrl','getClientIp','@nestjs/common','绘制图片任务结束\x20队列-1:\x20','Injectable','baiduFanyiSecret','find','removeEmoji','15700800EqDKJN','queueCount','历史中存在当前图片、直接获取！','__param','mjNotSaveImg','BalanceEntity','super','__metadata','4422876JeQzsP','substring','本次放大图片的id:\x20','metadata','enlarge','绘画任务开始','@nestjs/typeorm','replace','绘画超时，请稍后再试！','checkRateLimit','rateLimits','createRandomUid','mjSessionId','map','放大单张图片请求失败...','match','UploadService','response','./../globalConfig/globalConfig.service','axios\x20get:\x20','放大custom_id:\x20','globalConfigService','mjProxy','getMjDefaultParams','now','default','prompt\x20-------->\x20\x20','includes','绘制图片任务异常中断\x20队列-1:\x20','sendDrawInteractions','length','秒请求一次、请合理使用！','PAINT_TYPE','userId\x20=\x20:userId','url','drawWorking','extractContent','findCurrentEnlargeImgResult','post','error','查询绘制结果失败...','fanyiService','绘画失败','sleep','mjRateLimit','HttpException','axios','decorate','convertToEnglish','user','message','chatLogEntity','开始请求用户','Not','../fanyi/fanyi.service','Like','get','历史记录中不存在当前图片、请确认您放大的图片是否存在','imagine','__esModule','https://discord.com/api/v9/channels/','本次绘图耗时:\x20','mjservice','变换图片任务结束\x20队列-1:\x20','chatLogService','存入图片完成:\x20','uploadService','\x20队列+1:\x20','IsNull','pollForUpscaleResult','https://discord.com/api/v9/interactions','http://172.247.48.137:8000/mj/list?channel_id=','findOne','ChatLogEntity','INTERNAL_SERVER_ERROR','enlargeWorking','当前用户','defineProperty','由于速率限制、当前普通用户限制为','findCurrentPromptResult','http://172.247.48.137:8000/mj/draw','axios:\x20','sendSmInteractions','error:\x20','8tKOwfp','update','发送放大指令成功','历史这些id已经被获取过了\x20不能拿了:\x20','您当前暂无MJ绘画余额！！！','BadwordsService','upscaleSingleImg','checkBadWords','3YlBROX','balance\x20-\x201','当前图片没有绘画信息、无法变体!','变化图片任务异常中断\x20队列-1:\x20','checkAuth','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','../../common/utils','mjVersion','data','max','test','87492xsgdqo','object','typeorm','2194994TsAghj','3017WfGwZi','BAD_REQUEST','createQueryBuilder','当前图片没有绘画信息、无法放大!','5773203eXxNUH','\x20次开始查询','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','variationId','stringify','message_id','orderId','filter','function','当前用户\x20','DeductionKey'];_0x178f=function(){return _0x2c35c9;};return _0x178f();}function _0xac14(_0x497068,_0x2e5c7d){const _0x178f1d=_0x178f();return _0xac14=function(_0xac1423,_0x99221c){_0xac1423=_0xac1423-0xd5;let _0x1d6cb6=_0x178f1d[_0xac1423];return _0x1d6cb6;},_0xac14(_0x497068,_0x2e5c7d);}var __decorate=this&&this['__decorate']||function(_0x2c8049,_0x35c5df,_0x2d42a8,_0x5d518f){const _0x11ff8a=_0xac14;var _0x2ba86a=arguments['length'],_0x191c2c=_0x2ba86a<0x3?_0x35c5df:_0x5d518f===null?_0x5d518f=Object['getOwnPropertyDescriptor'](_0x35c5df,_0x2d42a8):_0x5d518f,_0x3f1fe3;if(typeof Reflect===_0x11ff8a(0x14b)&&typeof Reflect['decorate']==='function')_0x191c2c=Reflect[_0x11ff8a(0x112)](_0x2c8049,_0x35c5df,_0x2d42a8,_0x5d518f);else{for(var _0xe01f7e=_0x2c8049['length']-0x1;_0xe01f7e>=0x0;_0xe01f7e--)if(_0x3f1fe3=_0x2c8049[_0xe01f7e])_0x191c2c=(_0x2ba86a<0x3?_0x3f1fe3(_0x191c2c):_0x2ba86a>0x3?_0x3f1fe3(_0x35c5df,_0x2d42a8,_0x191c2c):_0x3f1fe3(_0x35c5df,_0x2d42a8))||_0x191c2c;}return _0x2ba86a>0x3&&_0x191c2c&&Object['defineProperty'](_0x35c5df,_0x2d42a8,_0x191c2c),_0x191c2c;},__metadata=this&&this[_0x50cd44(0xe2)]||function(_0x151763,_0x67e11f){const _0x2016fc=_0x50cd44;if(typeof Reflect===_0x2016fc(0x14b)&&typeof Reflect[_0x2016fc(0xe6)]===_0x2016fc(0x15a))return Reflect[_0x2016fc(0xe6)](_0x151763,_0x67e11f);},__param=this&&this[_0x50cd44(0xde)]||function(_0x5773b6,_0x392c1e){return function(_0x395ac3,_0x42d15b){_0x392c1e(_0x395ac3,_0x42d15b,_0x5773b6);};};Object[_0x50cd44(0x130)](exports,_0x50cd44(0x11e),{'value':!![]}),exports[_0x50cd44(0x15d)]=void 0x0;const globalConfig_service_1=require(_0x50cd44(0xf5)),upload_service_1=require(_0x50cd44(0x169)),common_1=require(_0x50cd44(0xd5)),axios_1=require(_0x50cd44(0x111)),chatLog_service_1=require(_0x50cd44(0x166)),balance_constant_1=require(_0x50cd44(0x175)),utils_1=require(_0x50cd44(0x145)),chatLog_entity_1=require(_0x50cd44(0x17a)),typeorm_1=require(_0x50cd44(0x14c)),typeorm_2=require(_0x50cd44(0xe9)),balance_entity_1=require(_0x50cd44(0x165)),fanyi_service_1=require(_0x50cd44(0x119)),badwords_service_1=require('../badwords/badwords.service');let MjService=class MjService{constructor(_0x5ba967,_0x4fec9f,_0x31f605,_0x3f1669,_0xc6533c,_0xa9b253,_0x4e012d){const _0x53435e=_0x50cd44;this['chatLogEntity']=_0x5ba967,this[_0x53435e(0x16d)]=_0x4fec9f,this['uploadService']=_0x31f605,this[_0x53435e(0x123)]=_0x3f1669,this[_0x53435e(0xf8)]=_0xc6533c,this[_0x53435e(0x10c)]=_0xa9b253,this[_0x53435e(0x167)]=_0x4e012d,this[_0x53435e(0xed)]={},this['drawWorking']=[],this[_0x53435e(0x12e)]=[],this['queueCount']=0x0,this[_0x53435e(0x17b)]={};}async[_0x50cd44(0x16f)](_0x249156){const _0x239320=_0x50cd44,{jobId:_0x42f820,prompt:_0x371613,startTime:_0x213820,userId:_0x1272ed}=_0x249156;return console[_0x239320(0x171)](_0x239320(0xe8),_0x239320(0x121)),await new Promise(_0x109d8e=>setTimeout(_0x109d8e,0x1388)),{'a':0x1,'b':0x2};}async[_0x50cd44(0x17e)](_0x3f388f,_0x25a1d8){const _0x883cca=_0x50cd44;await this[_0x883cca(0x143)](_0x25a1d8),await this[_0x883cca(0x167)][_0x883cca(0x13e)](_0x3f388f['prompt'],_0x25a1d8[_0x883cca(0x114)]['id']);const _0x32f548=_0x3f388f[_0x883cca(0x17f)];let _0x5df87c=_0x3f388f['prompt'];const {baiduFanyiAppId:_0x3fb6d6,baiduFanyiSecret:_0x7df6c1}=await this[_0x883cca(0xf8)][_0x883cca(0x183)](['baiduFanyiAppId',_0x883cca(0xd8)]);_0x3fb6d6&&_0x7df6c1&&(_0x5df87c=await this['fanyiService'][_0x883cca(0x113)](_0x32f548));const _0x3ee907='['+(0x0,utils_1[_0x883cca(0xee)])()+']',_0x289b0d=_0x3ee907+'\x20'+_0x5df87c;console[_0x883cca(0x171)](_0x883cca(0x184),_0x3ee907),console[_0x883cca(0x171)](_0x883cca(0xfd),_0x289b0d);const _0x22750e=this[_0x883cca(0x106)]['find'](_0x4bc58e=>_0x4bc58e[_0x883cca(0xfe)](_0x3f388f[_0x883cca(0x17f)]));if(_0x22750e)throw new common_1[(_0x883cca(0x110))]('当前提示词已经在任务队列中了、请勿重复提交。。。',common_1[_0x883cca(0x16c)][_0x883cca(0x14f)]);if(this[_0x883cca(0xdc)]>=0x3)throw new common_1[(_0x883cca(0x110))](_0x883cca(0x154),common_1[_0x883cca(0x16c)][_0x883cca(0x14f)]);await this[_0x883cca(0xec)](_0x25a1d8),this[_0x883cca(0xdc)]++,console['log'](_0x883cca(0x117)+_0x25a1d8[_0x883cca(0x114)]['id']+_0x883cca(0x126),this[_0x883cca(0xdc)]);try{const _0x572dac=await this[_0x883cca(0x116)][_0x883cca(0xd9)]({'where':{'prompt':(0x0,typeorm_1[_0x883cca(0x11a)])('%'+_0x289b0d+'%')}}),_0x522ded=_0x572dac['map'](_0x51e5f7=>_0x51e5f7[_0x883cca(0x157)]);this['drawWorking'][_0x883cca(0x16a)](_0x289b0d);let _0x32ceeb;const _0x3e64b2=await this['sendDrawInteractions'](_0x289b0d,_0x522ded,_0x3ee907);_0x3e64b2?(console[_0x883cca(0x171)](_0x883cca(0xdd)),_0x32ceeb=_0x3e64b2):_0x32ceeb=await this[_0x883cca(0x176)](_0x289b0d,_0x522ded,_0x3ee907);this[_0x883cca(0xdc)]--,this[_0x883cca(0xdc)]<0x0&&(this[_0x883cca(0xdc)]=0x0),console[_0x883cca(0x171)](_0x883cca(0xd6),this[_0x883cca(0xdc)]);const {id:_0x5ca822,content:_0x3e2fb1,channel_id:_0x2a0bcb,attachments:attachments=[],timestamp:_0x31e4e8}=_0x32ceeb;if(!attachments[_0x883cca(0x101)]||!attachments[0x0][_0x883cca(0x105)])throw new common_1[(_0x883cca(0x110))](_0x883cca(0x10d),common_1['HttpStatus'][_0x883cca(0x14f)]);const {filename:_0x360176,url:_0x2a155f,width:_0x3089fa,height:_0x386429,size:_0x2beba5}=attachments[0x0],_0x5bc1ff=this['globalConfigService'][_0x883cca(0x183)]([_0x883cca(0xdf)]);let _0x5d4fdc='';(!Number(_0x5bc1ff)||Number(_0x5bc1ff)===0x0)&&(_0x5d4fdc=await this[_0x883cca(0x125)][_0x883cca(0x18c)]({'filename':_0x360176,'url':_0x2a155f}),console['log'](_0x883cca(0x124),_0x5d4fdc));const _0x44acd9={'curIp':(0x0,utils_1[_0x883cca(0x18d)])(_0x25a1d8),'userId':_0x25a1d8[_0x883cca(0x114)]['id'],'type':balance_constant_1[_0x883cca(0x15c)][_0x883cca(0x103)],'prompt':_0x289b0d,'answer':_0x5d4fdc,'model':'mj','extend':this['removeEmoji'](JSON['stringify'](_0x32ceeb)),'message_id':_0x5ca822,'variationId':_0x5ca822,'upscaleId':_0x5ca822,'group':0x1,'isSaveImg':!Number(_0x5bc1ff)||Number(_0x5bc1ff)===0x0,'fileInfo':JSON['stringify']({'width':_0x3089fa,'height':_0x386429,'size':_0x2beba5,'filename':_0x360176,'cosUrl':_0x5d4fdc})};return await this[_0x883cca(0x123)][_0x883cca(0x162)](_0x44acd9),await this[_0x883cca(0x16e)](_0x25a1d8),this[_0x883cca(0x106)]=this[_0x883cca(0x106)]['filter'](_0x8b38f8=>_0x8b38f8!==_0x3f388f[_0x883cca(0x17f)]),_0x5d4fdc;}catch(_0x32ef81){this[_0x883cca(0xdc)]--,this[_0x883cca(0xdc)]<0x0&&(this['queueCount']=0x0),console[_0x883cca(0x171)](_0x883cca(0xff),this[_0x883cca(0xdc)]),this[_0x883cca(0x106)]=this[_0x883cca(0x106)][_0x883cca(0x159)](_0x3c76bb=>_0x3c76bb!==_0x3f388f[_0x883cca(0x17f)]);throw new common_1[(_0x883cca(0x110))](_0x32ef81['response'],common_1[_0x883cca(0x16c)][_0x883cca(0x14f)]);}}async[_0x50cd44(0x13d)](_0x23b32f,_0x42892a){const _0x5001d7=_0x50cd44;if(this['queueCount']>=0x3)throw new common_1[(_0x5001d7(0x110))](_0x5001d7(0x154),common_1[_0x5001d7(0x16c)][_0x5001d7(0x14f)]);this[_0x5001d7(0xdc)]++,console[_0x5001d7(0x171)]('用户'+_0x42892a[_0x5001d7(0x114)]['id']+'开始请求放大图片\x20队列+1:\x20',this['queueCount']);const {message_id:_0x7a4e04,orderId:_0x348485}=_0x23b32f;try{const _0x454c3c=await this[_0x5001d7(0x116)]['findOne']({'where':{'message_id':_0x7a4e04}});if(!_0x454c3c)throw new common_1[(_0x5001d7(0x110))](_0x5001d7(0x11c),common_1[_0x5001d7(0x16c)][_0x5001d7(0x14f)]);const _0x5a4873=await this[_0x5001d7(0x116)][_0x5001d7(0x12b)]({'where':{'upscaleId':_0x7a4e04,'action':_0x5001d7(0xe7),'orderId':_0x348485}});if(_0x5a4873)throw new common_1['HttpException'](_0x5001d7(0x18b),common_1[_0x5001d7(0x16c)][_0x5001d7(0x14f)]);const {prompt:_0x342270,extend:_0x163727}=_0x454c3c;let _0x56cfef=null;try{_0x56cfef=JSON[_0x5001d7(0x18a)](_0x163727);}catch(_0x575950){_0x56cfef=[];}const {components:components=[]}=_0x56cfef;if(!components[_0x5001d7(0x101)])throw new common_1[(_0x5001d7(0x110))](_0x5001d7(0x151),common_1[_0x5001d7(0x16c)][_0x5001d7(0x14f)]);const _0x3efbf4=components[0x0][_0x5001d7(0x182)][_0x348485-0x1],{custom_id:_0x4805df}=_0x3efbf4;console[_0x5001d7(0x171)](_0x5001d7(0xf7),_0x4805df);const _0x179550={'message_id':_0x7a4e04,'custom_id':_0x4805df,'prompt':_0x342270,'orderId':_0x348485};await this[_0x5001d7(0x135)](_0x179550),console[_0x5001d7(0x171)](_0x5001d7(0x139));const _0x1a8d2f=await this['chatLogEntity']['find']({'where':{'prompt':(0x0,typeorm_1[_0x5001d7(0x11a)])('%'+_0x342270+'%')}}),_0x38a92e=_0x1a8d2f[_0x5001d7(0xf0)](_0x2cdd32=>_0x2cdd32[_0x5001d7(0x157)]);console[_0x5001d7(0x171)](_0x5001d7(0x13a),_0x38a92e);const _0x33d29a=await this['pollForUpscaleResult'](_0x179550,_0x38a92e);this['queueCount']--,this[_0x5001d7(0xdc)]<0x0&&(this[_0x5001d7(0xdc)]=0x0),console[_0x5001d7(0x171)]('放大图片任务结束\x20队列-1:\x20',this[_0x5001d7(0xdc)]);const {id:_0x6cb575,content:_0x89ea6c,channel_id:_0x41f457,attachments:attachments=[],timestamp:_0x444f67}=_0x33d29a;if(!attachments[_0x5001d7(0x101)]||!attachments[0x0]['url'])throw new common_1[(_0x5001d7(0x110))]('放大当前图片失败',common_1[_0x5001d7(0x16c)][_0x5001d7(0x14f)]);const {filename:_0x2b54a0,url:_0x56482d,width:_0x2d9864,height:_0x32c87a,size:_0x3c98a7}=attachments[0x0],_0x2ab0c3=this['globalConfigService'][_0x5001d7(0x183)]([_0x5001d7(0xdf)]);let _0x4261a7='';(!Number(_0x2ab0c3)||Number(_0x2ab0c3)===0x0)&&(_0x4261a7=await this['uploadService'][_0x5001d7(0x18c)]({'filename':_0x2b54a0,'url':_0x56482d}),console[_0x5001d7(0x171)](_0x5001d7(0x124),_0x4261a7));const _0x4bb1d8={'curIp':(0x0,utils_1[_0x5001d7(0x18d)])(_0x42892a),'userId':_0x42892a[_0x5001d7(0x114)]['id'],'type':balance_constant_1[_0x5001d7(0x15c)][_0x5001d7(0x103)],'prompt':_0x342270,'answer':_0x4261a7,'model':'mj','extend':this['removeEmoji'](JSON[_0x5001d7(0x156)](_0x33d29a)),'message_id':_0x7a4e04,'upscaleId':_0x6cb575,'variationId':_0x6cb575,'action':'enlarge','orderId':_0x179550[_0x5001d7(0x158)],'isSaveImg':!Number(_0x2ab0c3)||Number(_0x2ab0c3)===0x0,'fileInfo':JSON[_0x5001d7(0x156)]({'width':_0x2d9864,'height':_0x32c87a,'size':_0x3c98a7,'filename':_0x2b54a0,'cosUrl':_0x4261a7})};return await this['chatLogService'][_0x5001d7(0x162)](_0x4bb1d8),_0x4261a7;}catch(_0x1d710b){console[_0x5001d7(0x171)]('error:\x20',_0x1d710b),this[_0x5001d7(0xdc)]--,this[_0x5001d7(0xdc)]<0x0&&(this['queueCount']=0x0),console['log']('放大图片任务异常中断\x20队列-1:\x20',this[_0x5001d7(0xdc)]);throw new common_1[(_0x5001d7(0x110))](_0x1d710b[_0x5001d7(0xf4)],common_1['HttpStatus'][_0x5001d7(0x14f)]);}}async['variationSingleImg'](_0x308ada,_0x1070fd){const _0x59646e=_0x50cd44;if(this['queueCount']>=0x3)throw new common_1[(_0x59646e(0x110))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x59646e(0x16c)]['BAD_REQUEST']);await this['checkAuth'](_0x1070fd),await this[_0x59646e(0xec)](_0x1070fd),this[_0x59646e(0xdc)]++,console[_0x59646e(0x171)]('用户'+_0x1070fd['user']['id']+_0x59646e(0x181),this[_0x59646e(0xdc)]);const {message_id:_0x566d9e,orderId:_0x429d65}=_0x308ada;try{const _0x5f313a=await this[_0x59646e(0x116)][_0x59646e(0x12b)]({'where':{'message_id':_0x566d9e}});if(!_0x5f313a)throw new common_1[(_0x59646e(0x110))]('历史记录中不存在当前图片、请确认您需要变换的图片是否存在',common_1[_0x59646e(0x16c)][_0x59646e(0x14f)]);const {prompt:_0x1a66eb,extend:_0xa008e7}=_0x5f313a;let _0x11f8de=null;try{_0x11f8de=JSON[_0x59646e(0x18a)](_0xa008e7);}catch(_0x19fa9c){_0x11f8de=[];}const {components:components=[]}=_0x11f8de;if(!components['length'])throw new common_1[(_0x59646e(0x110))](_0x59646e(0x141),common_1['HttpStatus'][_0x59646e(0x14f)]);const _0x278a37=components[0x1]['components'][_0x429d65-0x1],{custom_id:_0x258ab3}=_0x278a37,_0x26e8a3=await this[_0x59646e(0x116)]['find']({'where':{'variationId':(0x0,typeorm_1[_0x59646e(0x118)])((0x0,typeorm_1[_0x59646e(0x127)])()),'prompt':(0x0,typeorm_1[_0x59646e(0x11a)])('%'+_0x1a66eb+'%')}}),_0x1bff34=_0x26e8a3[_0x59646e(0xf0)](_0xd371a7=>_0xd371a7[_0x59646e(0x155)]),_0x574ae3={'message_id':_0x566d9e,'custom_id':_0x258ab3,'prompt':_0x1a66eb,'orderId':_0x429d65};await this[_0x59646e(0x135)](_0x574ae3);const _0x2c0f14=await this['pollForVariationResult'](_0x574ae3,_0x1bff34);this['queueCount']--,this['queueCount']<0x0&&(this[_0x59646e(0xdc)]=0x0),console[_0x59646e(0x171)](_0x59646e(0x122),this[_0x59646e(0xdc)]);const {id:_0x557293,content:_0xbb93b3,channel_id:_0x3e9aff,attachments:attachments=[],timestamp:_0x57b291}=_0x2c0f14;if(!attachments['length']||!attachments[0x0][_0x59646e(0x105)])throw new common_1[(_0x59646e(0x110))](_0x59646e(0x164),common_1[_0x59646e(0x16c)][_0x59646e(0x14f)]);const {filename:_0x1c625d,url:_0x17d2a6,width:_0x13bc46,height:_0x22be0b,size:_0x20c2d9}=attachments[0x0],_0x29b9ec=this[_0x59646e(0xf8)][_0x59646e(0x183)]([_0x59646e(0xdf)]);let _0x50fcf4='';(!Number(_0x29b9ec)||Number(_0x29b9ec)===0x0)&&(_0x50fcf4=await this['uploadService'][_0x59646e(0x18c)]({'filename':_0x1c625d,'url':_0x17d2a6}),console[_0x59646e(0x171)]('存入图片完成:\x20',_0x50fcf4));const _0x5c275f={'curIp':(0x0,utils_1[_0x59646e(0x18d)])(_0x1070fd),'userId':_0x1070fd['user']['id'],'type':balance_constant_1[_0x59646e(0x15c)][_0x59646e(0x103)],'prompt':_0x1a66eb,'answer':_0x50fcf4,'model':'mj','group':0x1,'extend':this[_0x59646e(0xda)](JSON[_0x59646e(0x156)](_0x2c0f14)),'message_id':_0x557293,'upscaleId':_0x557293,'variationId':_0x557293,'action':_0x59646e(0xe7),'orderId':_0x574ae3[_0x59646e(0x158)],'isSaveImg':!Number(_0x29b9ec)||Number(_0x29b9ec)===0x0,'fileInfo':JSON[_0x59646e(0x156)]({'width':_0x13bc46,'height':_0x22be0b,'size':_0x20c2d9,'filename':_0x1c625d,'cosUrl':_0x50fcf4})};return await this['chatLogService']['saveChatLog'](_0x5c275f),_0x50fcf4;}catch(_0x4e68d9){console[_0x59646e(0x171)](_0x59646e(0x136),_0x4e68d9),this[_0x59646e(0xdc)]--,this[_0x59646e(0xdc)]<0x0&&(this[_0x59646e(0xdc)]=0x0),console['log'](_0x59646e(0x142),this['queueCount']);throw new common_1['HttpException'](_0x4e68d9[_0x59646e(0xf4)],common_1['HttpStatus'][_0x59646e(0x14f)]);}}async['sendSmInteractions'](_0x2d9640){const _0x437c9b=_0x50cd44,{message_id:_0x32a432,custom_id:_0x311b0a}=_0x2d9640,{application_id:_0x4c5161,guild_id:_0x4f6182,channel_id:_0x434972,session_id:_0x3eb057,version:_0x654a91,id:_0x1274d2,authorization:_0x5a77a3,mjProxy:_0x3a1825}=await this['getMjDefaultParams'](),_0x19aeab=_0x3a1825==0x1?_0x437c9b(0x133):_0x437c9b(0x129),_0xb066a0={'authorization':_0x5a77a3},_0x5bfc7c={'type':0x3,'guild_id':_0x4f6182,'channel_id':_0x434972,'message_flags':0x0,'message_id':_0x32a432,'application_id':_0x4c5161,'session_id':_0x3eb057,'data':{'component_type':0x2,'custom_id':_0x311b0a}};try{await axios_1[_0x437c9b(0xfc)][_0x437c9b(0x109)](_0x19aeab,_0x5bfc7c,{'headers':_0xb066a0}),console[_0x437c9b(0x171)](_0x437c9b(0x188));}catch(_0x5d3555){console[_0x437c9b(0x171)](_0x437c9b(0x136),_0x5d3555);throw new common_1[(_0x437c9b(0x110))](_0x437c9b(0xf1),common_1['HttpStatus'][_0x437c9b(0x14f)]);}}async[_0x50cd44(0x128)](_0x4d9deb,_0x4ca6ff){const _0x3d5905=_0x50cd44,{message_id:_0x651e31,custom_id:_0x14274c,prompt:_0x44c71b,orderId:_0x352995}=_0x4d9deb;let _0x29ad83=null,_0x5135bf=0x0;while(!_0x29ad83&&_0x5135bf<0xa){try{const _0x54d080=Date[_0x3d5905(0xfb)](),_0x5124f6=await this['queryMessageList']();console[_0x3d5905(0x171)]('第\x20'+(_0x5135bf+0x1)+_0x3d5905(0x15e)+_0x5124f6[_0x3d5905(0x101)]);_0x5124f6&&_0x5124f6['length']&&(_0x29ad83=await this[_0x3d5905(0x108)](_0x5124f6,_0x4d9deb,_0x4ca6ff));const _0x41eadd=Date[_0x3d5905(0xfb)]()-_0x54d080,_0x580f74=0xbb8;await this[_0x3d5905(0x10e)](Math[_0x3d5905(0x148)](_0x580f74-_0x41eadd,0x0)),_0x5135bf++;}catch(_0x2b2c21){console[_0x3d5905(0x10a)](_0x3d5905(0x173)+_0x2b2c21[_0x3d5905(0x115)]);}}return _0x29ad83;}async['pollForVariationResult'](_0x2da00e,_0x4fb7a5){const _0xfc9d26=_0x50cd44,{message_id:_0xb31beb,custom_id:_0x2a4b9,prompt:_0x9f7067,orderId:_0x514664}=_0x2da00e;console[_0xfc9d26(0x171)](_0xfc9d26(0x15f));let _0x1993bf=null,_0x51fbf2=0x0;while(!_0x1993bf&&_0x51fbf2<0xa){try{console['log']('第\x20'+(_0x51fbf2+0x1)+_0xfc9d26(0x163));const _0x39d4f3=Date['now'](),_0x52f5ac=await this[_0xfc9d26(0x186)]();_0x52f5ac&&_0x52f5ac[_0xfc9d26(0x101)]&&(_0x1993bf=await this[_0xfc9d26(0x180)](_0x52f5ac,_0x2da00e,_0x4fb7a5));const _0x3d7669=Date[_0xfc9d26(0xfb)]()-_0x39d4f3,_0x40b795=0x1f40;await this[_0xfc9d26(0x10e)](Math[_0xfc9d26(0x148)](_0x40b795-_0x3d7669,0x0)),_0x51fbf2++;}catch(_0x3ae8){console[_0xfc9d26(0x10a)]('查询期间出现错误：'+_0x3ae8[_0xfc9d26(0x115)]);}}if(!_0x1993bf)throw new common_1[(_0xfc9d26(0x110))](_0xfc9d26(0x16b),common_1[_0xfc9d26(0x16c)][_0xfc9d26(0x14f)]);return _0x1993bf;}async[_0x50cd44(0x108)](_0x52c537,_0x4acf45,_0x1ab071){const _0x2f4153=_0x50cd44,{message_id:_0x2db1cf,custom_id:_0x479b3f,prompt:_0x3cabc3,orderId:_0x158153}=_0x4acf45,_0x3db8d5=_0x3cabc3[_0x2f4153(0xe4)](0x0,0xc);console[_0x2f4153(0x171)](_0x2f4153(0xe5),_0x3db8d5);const _0x1a5301=_0x52c537[_0x2f4153(0xd9)](_0x353b85=>{const _0x4a43ea=_0x2f4153,{content:_0x453dad}=_0x353b85;if(!this[_0x4a43ea(0x107)](_0x453dad))return![];const {prompt:_0x56bb82,order:_0x166b5d}=this[_0x4a43ea(0x107)](_0x453dad);return _0x56bb82[_0x4a43ea(0xfe)](_0x3db8d5)&&_0x4acf45[_0x4a43ea(0x158)]===_0x166b5d&&!_0x1ab071[_0x4a43ea(0xfe)](_0x353b85['id']);});return _0x1a5301;}async[_0x50cd44(0x180)](_0x3b1f54,_0xb41ed5,_0x254fc4){const _0x581f2a=_0x50cd44,{message_id:_0xee8bec,custom_id:_0x5ea29d,prompt:_0x1edd1a,orderId:_0x19ffb9}=_0xb41ed5,_0x33c0ea=_0x1edd1a[_0x581f2a(0xe4)](0x0,0xc),_0x71766e=_0x3b1f54[_0x581f2a(0xd9)](_0x6d08b8=>{const _0x2d4191=_0x581f2a,{content:_0x484c61}=_0x6d08b8,_0x42b27c=_0x484c61['match'](/\*\*(.+?)\*\*/),_0x2af853=_0x42b27c?_0x42b27c[0x1]:'';if(!_0x2af853)return![];return _0x2af853[_0x2d4191(0xfe)](_0x33c0ea)&&!_0x254fc4['includes'](_0x6d08b8['id']);});return _0x71766e;}async[_0x50cd44(0x100)](_0x193ecd,_0x2e5ab8,_0xaaa939){const _0x283633=_0x50cd44,_0x42d292=await this[_0x283633(0x186)](),_0x12e4ab=await this[_0x283633(0x132)](_0x42d292,_0xaaa939,_0x2e5ab8);if(_0x12e4ab)return console[_0x283633(0x171)]('有历史信息之间返回:\x20',_0x12e4ab),_0x12e4ab;const {application_id:_0x2a972d,guild_id:_0x3c1afc,channel_id:_0x168071,session_id:_0x1663f1,version:_0x3d76b0,id:_0x7cbe30,authorization:_0x37fb50,mjProxy:_0x178125}=await this[_0x283633(0xfa)](),_0x50a53b={'type':0x2,'application_id':_0x2a972d,'guild_id':_0x3c1afc,'channel_id':_0x168071,'session_id':_0x1663f1,'data':{'version':_0x3d76b0,'id':_0x7cbe30,'name':_0x283633(0x11d),'type':0x1,'options':[{'type':0x3,'name':_0x283633(0x17f),'value':_0x193ecd}],'attachments':[]}};try{const _0x48e9f8=_0x178125==0x1?_0x283633(0x133):'https://discord.com/api/v9/interactions',_0x2b8496={'authorization':_0x37fb50},_0x246de7=await axios_1['default'][_0x283633(0x109)](_0x48e9f8,_0x50a53b,{'headers':_0x2b8496});return console[_0x283633(0x171)]('发送绘画指令结果:\x20',_0x246de7[_0x283633(0x147)]),![];}catch(_0x2cc247){console[_0x283633(0x171)](_0x283633(0x134),_0x2cc247);throw new common_1[(_0x283633(0x110))](_0x283633(0x144),common_1[_0x283633(0x16c)]['BAD_REQUEST']);}}async[_0x50cd44(0x176)](_0x5a9b4f,_0x191a6a,_0xb73060){const _0x2ee495=_0x50cd44;console[_0x2ee495(0x171)]('开始查询绘画结果轮询');const _0x596448=Date[_0x2ee495(0xfb)]();try{const _0x18efcf=0xd,_0x100407=0x2ee0,_0x3e7488=0x1388,_0x59e447=0x3c*0x3e8;let _0x15e5d3=0x0,_0x4eecbc=![],_0x5ca1dc=null;while(!_0x5ca1dc&&_0x15e5d3<_0x18efcf){console[_0x2ee495(0x171)]('第\x20'+(_0x15e5d3+0x1)+_0x2ee495(0x153));Date[_0x2ee495(0xfb)]()-_0x596448>=_0x59e447&&(_0x4eecbc=!![]);await this[_0x2ee495(0x10e)](_0x4eecbc?_0x3e7488:_0x100407);const _0x3547a0=await this[_0x2ee495(0x186)]();_0x5ca1dc=await this[_0x2ee495(0x132)](_0x3547a0,_0xb73060,_0x191a6a),_0x15e5d3++;}if(!_0x5ca1dc)throw new common_1['HttpException'](_0x2ee495(0xeb),common_1[_0x2ee495(0x16c)][_0x2ee495(0x14f)]);const _0x10c6b2=Date[_0x2ee495(0xfb)]();return console[_0x2ee495(0x171)](_0x2ee495(0x120)+Math[_0x2ee495(0x174)]((_0x10c6b2-_0x596448)/0x3e8)+'\x20S'),_0x5ca1dc;}catch(_0x549f5e){console['error'](_0x549f5e[_0x2ee495(0x115)]);throw new common_1['HttpException'](_0x2ee495(0x17d),common_1[_0x2ee495(0x16c)][_0x2ee495(0x12d)]);}}async['findCurrentPromptResult'](_0x38285a,_0x3ff304,_0x3d79df){const _0x5584aa=_0x50cd44;if(!_0x38285a||!_0x38285a[_0x5584aa(0x101)])return;console[_0x5584aa(0x171)]('本次比对的随机ID:\x20',_0x3ff304);const _0x5bd6e8=_0x38285a[_0x5584aa(0xd9)](_0x3475d0=>{const _0x2c88ea=_0x5584aa,{attachments:attachments=[],content:_0x3bc04d,edited_timestamp:_0x315e4b}=_0x3475d0;return _0x3bc04d[_0x2c88ea(0xfe)](_0x3ff304)&&attachments[_0x2c88ea(0x101)]>0x0&&!_0x315e4b&&!_0x3d79df[_0x2c88ea(0xfe)](_0x3475d0['id']);});return _0x5bd6e8||null;}async['queryMessageList'](){const _0x1aecb6=_0x50cd44;try{const {application_id:_0x184f33,guild_id:_0x442319,channel_id:_0x14e1d0,session_id:_0x2b168d,version:_0x3f7e40,id:_0x1211f9,authorization:_0xeea997,mjProxy:_0x4cc896}=await this['getMjDefaultParams'](),_0x34a5c1=_0x4cc896==0x1?_0x1aecb6(0x12a)+_0x14e1d0:_0x1aecb6(0x11f)+_0x14e1d0+'/messages?limit=50',_0x523f0b={'authorization':_0xeea997},_0x233a5d=await axios_1[_0x1aecb6(0xfc)][_0x1aecb6(0x11b)](_0x34a5c1,{'headers':_0x523f0b});return _0x233a5d[_0x1aecb6(0x147)];}catch(_0x20f239){console['log'](_0x1aecb6(0xf6),_0x20f239);throw new common_1[(_0x1aecb6(0x110))](_0x1aecb6(0x10b),common_1['HttpStatus'][_0x1aecb6(0x14f)]);}}async['sleep'](_0x145c5e){return new Promise(_0x42ec8c=>setTimeout(_0x42ec8c,_0x145c5e));}[_0x50cd44(0x107)](_0x1818ac){const _0x2ba90a=_0x50cd44,_0x3194a3=_0x1818ac['match'](/\*\*(.+?)\*\*/),_0x1d1e2a=_0x1818ac[_0x2ba90a(0xf2)](/- Image #(\d+)/);if(!_0x3194a3||!_0x1d1e2a)return null;const _0x5baaa4=_0x3194a3[0x1],_0xc624cc=parseInt(_0x1d1e2a[0x1]);return{'prompt':_0x5baaa4,'order':_0xc624cc};}async['getMjDefaultParams'](){const _0x46f1b9=_0x50cd44,_0x2478c9=await this[_0x46f1b9(0xf8)][_0x46f1b9(0x183)]([_0x46f1b9(0x160),'mjApplicationId','mjGuildId',_0x46f1b9(0x189),_0x46f1b9(0xef),_0x46f1b9(0x146),'mjAuthorization',_0x46f1b9(0x10f),_0x46f1b9(0xf9)]),_0xe86363={'application_id':_0x2478c9['mjApplicationId'],'guild_id':_0x2478c9['mjGuildId'],'channel_id':_0x2478c9[_0x46f1b9(0x189)],'session_id':_0x2478c9[_0x46f1b9(0xef)],'version':_0x2478c9[_0x46f1b9(0x146)],'id':_0x2478c9[_0x46f1b9(0x160)],'authorization':_0x2478c9[_0x46f1b9(0x178)],'mjRateLimit':_0x2478c9[_0x46f1b9(0x10f)],'mjProxy':_0x2478c9[_0x46f1b9(0xf9)]||0x0};return _0xe86363;}['removeEmoji'](_0x5a06b5){const _0x41d5f4=_0x50cd44,_0x405a98=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x5a06b5[_0x41d5f4(0xea)](_0x405a98,'');}async[_0x50cd44(0x143)](_0x12d611){const _0x5b8e27=_0x50cd44,_0x560541=await this[_0x5b8e27(0x16d)][_0x5b8e27(0x12b)]({'where':{'userId':_0x12d611[_0x5b8e27(0x114)]['id']}}),{id:_0x15f7c8,balance:_0x3757ed}=_0x560541;if(!_0x3757ed||(_0x560541===null||_0x560541===void 0x0?void 0x0:_0x560541[_0x5b8e27(0x170)])<0x1)throw new common_1[(_0x5b8e27(0x110))](_0x5b8e27(0x13b),common_1[_0x5b8e27(0x16c)][_0x5b8e27(0x14f)]);}async['checkFree'](_0x429ada){const _0x243f10=_0x50cd44,{id:_0x57f2a1,role:_0x5d17de}=_0x429ada[_0x243f10(0x114)];!this[_0x243f10(0x17b)][_0x57f2a1]?this[_0x243f10(0x17b)][_0x57f2a1]=0x1:this[_0x243f10(0x17b)][_0x57f2a1]=this[_0x243f10(0x17b)][_0x57f2a1]+0x1,console['log'](_0x243f10(0x12f)+_0x57f2a1+'使用的次数：',this[_0x243f10(0x17b)][_0x57f2a1]);}async['checkRateLimit'](_0x5564f6){const _0xc08e75=_0x50cd44,{id:_0x5b79fe,role:_0x45e42d}=_0x5564f6[_0xc08e75(0x114)];if(['admin',_0xc08e75(0xe1)][_0xc08e75(0xfe)](_0x45e42d))return!![];const {mjRateLimit:_0x180555}=await this[_0xc08e75(0xfa)]();if(this[_0xc08e75(0xed)][_0x5b79fe]){const _0x46ab5d=this[_0xc08e75(0xed)][_0x5b79fe];if(_0x46ab5d>Date[_0xc08e75(0xfb)]()){console[_0xc08e75(0x171)](_0xc08e75(0x15b)+_0x5b79fe+'\x20请求过于频繁！');throw new common_1[(_0xc08e75(0x110))](_0xc08e75(0x131)+_0x180555+_0xc08e75(0x102),common_1[_0xc08e75(0x16c)][_0xc08e75(0x14f)]);}else this[_0xc08e75(0xed)][_0x5b79fe]=Date[_0xc08e75(0xfb)]()+Number(_0x180555)*0x3e8;}else{const _0x171d2b=Date[_0xc08e75(0xfb)]();this[_0xc08e75(0xed)][_0x5b79fe]=_0x171d2b+0x3e8*Number(_0x180555);}}async[_0x50cd44(0x16e)](_0x3cffac){const _0x172e78=_0x50cd44;await this[_0x172e78(0x16d)][_0x172e78(0x150)]()[_0x172e78(0x138)](balance_entity_1[_0x172e78(0xe0)])[_0x172e78(0x172)]({'balance':()=>_0x172e78(0x140)})[_0x172e78(0x17c)](_0x172e78(0x104),{'userId':_0x3cffac[_0x172e78(0x114)]['id']})[_0x172e78(0x187)]();}async[_0x50cd44(0x149)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x50cd44(0xd7)])(),__param(0x0,(0x0,typeorm_2[_0x50cd44(0x179)])(chatLog_entity_1[_0x50cd44(0x12c)])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(balance_entity_1['BalanceEntity'])),__metadata(_0x50cd44(0x177),[typeorm_1[_0x50cd44(0x161)],typeorm_1[_0x50cd44(0x161)],upload_service_1[_0x50cd44(0xf3)],chatLog_service_1['ChatLogService'],globalConfig_service_1['GlobalConfigService'],fanyi_service_1['FanyiService'],badwords_service_1[_0x50cd44(0x13c)]])],MjService),exports['MjService']=MjService;