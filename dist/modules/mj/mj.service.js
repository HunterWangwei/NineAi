'use strict';function _0x3d5a(_0x1ac258,_0x1a3f10){const _0x2593a0=_0x2593();return _0x3d5a=function(_0x3d5a16,_0x49e29f){_0x3d5a16=_0x3d5a16-0x82;let _0x1082c3=_0x2593a0[_0x3d5a16];return _0x1082c3;},_0x3d5a(_0x1ac258,_0x1a3f10);}const _0x1a1aa0=_0x3d5a;(function(_0x4d7ee8,_0x1e7600){const _0x7924d7=_0x3d5a,_0x5b2187=_0x4d7ee8();while(!![]){try{const _0x158956=parseInt(_0x7924d7(0xae))/0x1+-parseInt(_0x7924d7(0x8f))/0x2*(parseInt(_0x7924d7(0x11f))/0x3)+parseInt(_0x7924d7(0xe3))/0x4*(-parseInt(_0x7924d7(0xc7))/0x5)+parseInt(_0x7924d7(0x96))/0x6+-parseInt(_0x7924d7(0xa6))/0x7+-parseInt(_0x7924d7(0xab))/0x8+parseInt(_0x7924d7(0x97))/0x9;if(_0x158956===_0x1e7600)break;else _0x5b2187['push'](_0x5b2187['shift']());}catch(_0x508b8d){_0x5b2187['push'](_0x5b2187['shift']());}}}(_0x2593,0x38328));function _0x2593(){const _0x302efa=['当前提示词已经在任务队列中了、请勿重复提交。。。','baiduFanyiSecret','@nestjs/typeorm','super','秒请求一次、请合理使用！','sendSmInteractions','https://discord.com/api/v9/channels/','PAINT_TYPE','error','BadwordsService','BAD_REQUEST','test','extractContent','放大图片任务异常中断\x20队列-1:\x20','deductBalance','userId\x20=\x20:userId','prompt','变换当前图片超时！','4ryColV','findOne','变化图片任务异常中断\x20队列-1:\x20','replace','绘图指令完成','mjApplicationId','filter','1552278ZqPsae','3806325Fhvgpq','变换当前图片失败','查询期间出现错误：','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','查询绘制结果失败...','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','getClientIp','log','checkRateLimit','uploadService','components','user','绘制图片任务异常中断\x20队列-1:\x20','HttpStatus','variationSingleImg','2118788KikxWX','历史这些id已经被获取过了\x20不能拿了:\x20','pollForVariationResult','Not','当前用户','662040rpMZTV','InjectRepository','开始请求变换图片\x20队列+1:\x20','300782gfMaGN','存入图片完成:\x20','__param','function','http://172.247.48.137:8000/mj/draw','mjChannelId','开始请求用户','removeEmoji','绘画超时，请稍后再试！','当前图片已经放大过了、请勿重复放大!','https://discord.com/api/v9/interactions','网络连接失败，请稍后再试！','../badwords/badwords.service','\x20次开始查询[变换图片]','ChatLogEntity','\x20次开始查询\x20=>\x20当前查询结果：','mjVersion','checkFree','\x20请求过于频繁！','开始查询绘画结果轮询','mjProxy','balanceEntity','rateLimits','http://172.247.48.137:8000/mj/list?channel_id=','substring','75gsCGBS','floor','getConfigs','放大单张图片请求失败...','发送放大指令成功','Like','stringify','variationId','max','error:\x20','balance\x20-\x201','sendDrawInteractions','BalanceEntity','有历史信息之间返回:\x20','pollForUpscaleResult','../chatLog/chatLog.service','HttpException','defineProperty','get','../../common/constants/balance.constant','mjAuthorization','pollForResult','GlobalConfigService','orderId','object','url','decorate','Injectable','32980wdHngP','放大custom_id:\x20','queueCount','now','../chatLog/chatLog.entity','response','本次绘图耗时:\x20','length','当前图片没有绘画信息、无法放大!','update','imagine','使用的次数：','queryMessageList','set','baiduFanyiAppId','axios:\x20','design:paramtypes','__metadata','开始请求放大图片\x20队列+1:\x20','getOwnPropertyDescriptor','includes','sleep','findCurrentVariationImgResult','match','freeQueueUsers','parse','历史记录中不存在当前图片、请确认您放大的图片是否存在','globalConfigService','./../upload/upload.service','createRandomUid','mjSessionId','本次比对的随机ID:\x20','变换图片任务结束\x20队列-1:\x20','__esModule','message','mjGuildId','当前用户\x20','../fanyi/fanyi.service','randomId:\x20','upscaleSingleImg','chatLogService','enlargeWorking','您当前暂无MJ绘画余额！！！','drawWorking','getMjDefaultParams','convertToEnglish','fanyiService','UploadService','mjRateLimit','mjNotSaveImg','INTERNAL_SERVER_ERROR','uploadFileFromUrl','绘画失败','metadata','message_id','push','findCurrentEnlargeImgResult','data','开始轮询单张变换图片结果','放大图片任务结束\x20队列-1:\x20','364683NjuNPc','findCurrentPromptResult','post','mjDraw','Repository','map','checkAuth','@nestjs/common','find','enlarge','default','MjService','saveChatLog','DeductionKey','checkBadWords','prompt\x20-------->\x20\x20','./../globalConfig/globalConfig.service','chatLogEntity','ChatLogService'];_0x2593=function(){return _0x302efa;};return _0x2593();}var __decorate=this&&this['__decorate']||function(_0x22ac32,_0x280db3,_0x10a27a,_0xa46b3f){const _0x205425=_0x3d5a;var _0x3c08e3=arguments[_0x205425(0xea)],_0x2ce0bf=_0x3c08e3<0x3?_0x280db3:_0xa46b3f===null?_0xa46b3f=Object[_0x205425(0xf6)](_0x280db3,_0x10a27a):_0xa46b3f,_0x4c1b58;if(typeof Reflect===_0x205425(0xdf)&&typeof Reflect[_0x205425(0xe1)]===_0x205425(0xb1))_0x2ce0bf=Reflect[_0x205425(0xe1)](_0x22ac32,_0x280db3,_0x10a27a,_0xa46b3f);else{for(var _0x2b743a=_0x22ac32[_0x205425(0xea)]-0x1;_0x2b743a>=0x0;_0x2b743a--)if(_0x4c1b58=_0x22ac32[_0x2b743a])_0x2ce0bf=(_0x3c08e3<0x3?_0x4c1b58(_0x2ce0bf):_0x3c08e3>0x3?_0x4c1b58(_0x280db3,_0x10a27a,_0x2ce0bf):_0x4c1b58(_0x280db3,_0x10a27a))||_0x2ce0bf;}return _0x3c08e3>0x3&&_0x2ce0bf&&Object['defineProperty'](_0x280db3,_0x10a27a,_0x2ce0bf),_0x2ce0bf;},__metadata=this&&this[_0x1a1aa0(0xf4)]||function(_0x28014a,_0x7fc193){const _0xfeeadd=_0x1a1aa0;if(typeof Reflect===_0xfeeadd(0xdf)&&typeof Reflect[_0xfeeadd(0x118)]===_0xfeeadd(0xb1))return Reflect['metadata'](_0x28014a,_0x7fc193);},__param=this&&this[_0x1a1aa0(0xb0)]||function(_0xd3a559,_0x2808b1){return function(_0x3b18f2,_0x12b276){_0x2808b1(_0x3b18f2,_0x12b276,_0xd3a559);};};Object[_0x1a1aa0(0xd8)](exports,_0x1a1aa0(0x104),{'value':!![]}),exports['MjService']=void 0x0;const globalConfig_service_1=require(_0x1a1aa0(0x12f)),upload_service_1=require(_0x1a1aa0(0xff)),common_1=require(_0x1a1aa0(0x126)),axios_1=require('axios'),chatLog_service_1=require(_0x1a1aa0(0xd6)),balance_constant_1=require(_0x1a1aa0(0xda)),utils_1=require('../../common/utils'),chatLog_entity_1=require(_0x1a1aa0(0xe7)),typeorm_1=require('typeorm'),typeorm_2=require(_0x1a1aa0(0x134)),balance_entity_1=require('../userBalance/balance.entity'),fanyi_service_1=require(_0x1a1aa0(0x108)),badwords_service_1=require(_0x1a1aa0(0xba));let MjService=class MjService{constructor(_0x1ec5bc,_0x45b725,_0x25e536,_0x16c0f3,_0x1919ec,_0x5007a7,_0x951cfd){const _0x264572=_0x1a1aa0;this[_0x264572(0x130)]=_0x1ec5bc,this[_0x264572(0xc3)]=_0x45b725,this[_0x264572(0xa0)]=_0x25e536,this[_0x264572(0x10b)]=_0x16c0f3,this['globalConfigService']=_0x1919ec,this[_0x264572(0x111)]=_0x5007a7,this['badwordsService']=_0x951cfd,this[_0x264572(0xc4)]={},this[_0x264572(0x10e)]=[],this[_0x264572(0x10c)]=[],this[_0x264572(0xe5)]=0x0,this[_0x264572(0xfb)]={};}async[_0x1a1aa0(0x122)](_0x407bbb){const _0x2a780a=_0x1a1aa0,{jobId:_0x63ba36,prompt:_0x5e37b0,startTime:_0x89bcb6,userId:_0x1e25e1}=_0x407bbb;return console[_0x2a780a(0x9e)]('绘画任务开始','mjservice'),await new Promise(_0xbc99f4=>setTimeout(_0xbc99f4,0x1388)),{'a':0x1,'b':0x2};}async['draw'](_0x450e22,_0x439c6c){const _0x104601=_0x1a1aa0;await this[_0x104601(0x125)](_0x439c6c),await this['badwordsService'][_0x104601(0x12d)](_0x450e22[_0x104601(0x8d)],_0x439c6c['user']['id']);const _0x4e8775=_0x450e22[_0x104601(0x8d)];let _0x39d962=_0x450e22['prompt'];const {baiduFanyiAppId:_0x3cbd48,baiduFanyiSecret:_0x53e082}=await this[_0x104601(0xfe)][_0x104601(0xc9)]([_0x104601(0xf1),_0x104601(0x133)]);_0x3cbd48&&_0x53e082&&(_0x39d962=await this[_0x104601(0x111)][_0x104601(0x110)](_0x4e8775));const _0x1bc285='['+(0x0,utils_1[_0x104601(0x100)])()+']',_0x1b339f=_0x1bc285+'\x20'+_0x39d962;console['log'](_0x104601(0x109),_0x1bc285),console[_0x104601(0x9e)](_0x104601(0x12e),_0x1b339f);const _0x3cfbbe=this[_0x104601(0x10e)][_0x104601(0x127)](_0x3d6955=>_0x3d6955[_0x104601(0xf7)](_0x450e22[_0x104601(0x8d)]));if(_0x3cfbbe)throw new common_1[(_0x104601(0xd7))](_0x104601(0x132),common_1[_0x104601(0xa4)][_0x104601(0x87)]);if(this[_0x104601(0xe5)]>=0x3)throw new common_1[(_0x104601(0xd7))](_0x104601(0x9c),common_1[_0x104601(0xa4)][_0x104601(0x87)]);await this[_0x104601(0x9f)](_0x439c6c),this['queueCount']++,console[_0x104601(0x9e)](_0x104601(0xb4)+_0x439c6c['user']['id']+'\x20队列+1:\x20',this[_0x104601(0xe5)]);try{const _0x4428e3=await this[_0x104601(0x130)][_0x104601(0x127)]({'where':{'prompt':(0x0,typeorm_1[_0x104601(0xcc)])('%'+_0x1b339f+'%')}}),_0x227142=_0x4428e3[_0x104601(0x124)](_0x1e52f9=>_0x1e52f9[_0x104601(0x119)]);this[_0x104601(0x10e)][_0x104601(0x11a)](_0x1b339f);let _0xe411f;const _0x295a38=await this[_0x104601(0xd2)](_0x1b339f,_0x227142,_0x1bc285);_0x295a38?(console[_0x104601(0x9e)]('历史中存在当前图片、直接获取！'),_0xe411f=_0x295a38):_0xe411f=await this[_0x104601(0xdc)](_0x1b339f,_0x227142,_0x1bc285);this[_0x104601(0xe5)]--,this['queueCount']<0x0&&(this[_0x104601(0xe5)]=0x0),console[_0x104601(0x9e)]('绘制图片任务结束\x20队列-1:\x20',this[_0x104601(0xe5)]);const {id:_0x39fdf4,content:_0xa32f02,channel_id:_0x14cb8c,attachments:attachments=[],timestamp:_0x4b3223}=_0xe411f;if(!attachments[_0x104601(0xea)]||!attachments[0x0]['url'])throw new common_1[(_0x104601(0xd7))](_0x104601(0x117),common_1[_0x104601(0xa4)][_0x104601(0x87)]);const {filename:_0x7b1422,url:_0x47e016,width:_0x3ad9ef,height:_0x5629f2,size:_0xbeabe7}=attachments[0x0],_0x1ca4a2=this[_0x104601(0xfe)][_0x104601(0xc9)](['mjNotSaveImg']);let _0xaf2414='';(!Number(_0x1ca4a2)||Number(_0x1ca4a2)===0x0)&&(_0xaf2414=await this[_0x104601(0xa0)]['uploadFileFromUrl']({'filename':_0x7b1422,'url':_0x47e016}),console[_0x104601(0x9e)](_0x104601(0xaf),_0xaf2414));const _0x478f9b={'curIp':(0x0,utils_1['getClientIp'])(_0x439c6c),'userId':_0x439c6c[_0x104601(0xa2)]['id'],'type':balance_constant_1[_0x104601(0x12c)][_0x104601(0x84)],'prompt':_0x1b339f,'answer':_0xaf2414,'model':'mj','extend':this['removeEmoji'](JSON[_0x104601(0xcd)](_0xe411f)),'message_id':_0x39fdf4,'variationId':_0x39fdf4,'upscaleId':_0x39fdf4,'group':0x1,'isSaveImg':!Number(_0x1ca4a2)||Number(_0x1ca4a2)===0x0,'fileInfo':JSON['stringify']({'width':_0x3ad9ef,'height':_0x5629f2,'size':_0xbeabe7,'filename':_0x7b1422,'cosUrl':_0xaf2414})};return await this[_0x104601(0x10b)]['saveChatLog'](_0x478f9b),await this[_0x104601(0x8b)](_0x439c6c),this[_0x104601(0x10e)]=this[_0x104601(0x10e)][_0x104601(0x95)](_0x36414e=>_0x36414e!==_0x450e22[_0x104601(0x8d)]),_0xaf2414;}catch(_0x301c06){this[_0x104601(0xe5)]--,this[_0x104601(0xe5)]<0x0&&(this[_0x104601(0xe5)]=0x0),console[_0x104601(0x9e)](_0x104601(0xa3),this['queueCount']),this[_0x104601(0x10e)]=this[_0x104601(0x10e)][_0x104601(0x95)](_0x115430=>_0x115430!==_0x450e22[_0x104601(0x8d)]);throw new common_1[(_0x104601(0xd7))](_0x301c06['response'],common_1[_0x104601(0xa4)][_0x104601(0x87)]);}}async[_0x1a1aa0(0x10a)](_0x1e9abc,_0x292372){const _0x5f5037=_0x1a1aa0;if(this[_0x5f5037(0xe5)]>=0x3)throw new common_1[(_0x5f5037(0xd7))](_0x5f5037(0x9c),common_1[_0x5f5037(0xa4)][_0x5f5037(0x87)]);this[_0x5f5037(0xe5)]++,console[_0x5f5037(0x9e)]('用户'+_0x292372[_0x5f5037(0xa2)]['id']+_0x5f5037(0xf5),this[_0x5f5037(0xe5)]);const {message_id:_0x190a01,orderId:_0x4495b0}=_0x1e9abc;try{const _0x3b2733=await this['chatLogEntity']['findOne']({'where':{'message_id':_0x190a01}});if(!_0x3b2733)throw new common_1[(_0x5f5037(0xd7))](_0x5f5037(0xfd),common_1[_0x5f5037(0xa4)][_0x5f5037(0x87)]);const _0x420258=await this[_0x5f5037(0x130)][_0x5f5037(0x90)]({'where':{'upscaleId':_0x190a01,'action':_0x5f5037(0x128),'orderId':_0x4495b0}});if(_0x420258)throw new common_1[(_0x5f5037(0xd7))](_0x5f5037(0xb7),common_1[_0x5f5037(0xa4)][_0x5f5037(0x87)]);const {prompt:_0x3e6ba0,extend:_0x32de9c}=_0x3b2733;let _0x40ce83=null;try{_0x40ce83=JSON['parse'](_0x32de9c);}catch(_0x4302fb){_0x40ce83=[];}const {components:components=[]}=_0x40ce83;if(!components[_0x5f5037(0xea)])throw new common_1[(_0x5f5037(0xd7))](_0x5f5037(0xeb),common_1[_0x5f5037(0xa4)][_0x5f5037(0x87)]);const _0x42d1ef=components[0x0][_0x5f5037(0xa1)][_0x4495b0-0x1],{custom_id:_0x435e76}=_0x42d1ef;console[_0x5f5037(0x9e)](_0x5f5037(0xe4),_0x435e76);const _0x14e7b6={'message_id':_0x190a01,'custom_id':_0x435e76,'prompt':_0x3e6ba0,'orderId':_0x4495b0};await this[_0x5f5037(0x82)](_0x14e7b6),console[_0x5f5037(0x9e)](_0x5f5037(0xcb));const _0x457de2=await this[_0x5f5037(0x130)][_0x5f5037(0x127)]({'where':{'prompt':(0x0,typeorm_1[_0x5f5037(0xcc)])('%'+_0x3e6ba0+'%')}}),_0x2360bd=_0x457de2['map'](_0x493767=>_0x493767[_0x5f5037(0x119)]);console[_0x5f5037(0x9e)](_0x5f5037(0xa7),_0x2360bd);const _0x2a42e1=await this[_0x5f5037(0xd5)](_0x14e7b6,_0x2360bd);this[_0x5f5037(0xe5)]--,this[_0x5f5037(0xe5)]<0x0&&(this[_0x5f5037(0xe5)]=0x0),console[_0x5f5037(0x9e)](_0x5f5037(0x11e),this[_0x5f5037(0xe5)]);const {id:_0x492654,content:_0x3d6b5b,channel_id:_0x298cfd,attachments:attachments=[],timestamp:_0x7e40d4}=_0x2a42e1;if(!attachments[_0x5f5037(0xea)]||!attachments[0x0][_0x5f5037(0xe0)])throw new common_1[(_0x5f5037(0xd7))]('放大当前图片失败',common_1[_0x5f5037(0xa4)][_0x5f5037(0x87)]);const {filename:_0x2f1807,url:_0xef6d61,width:_0x44fbac,height:_0x37d7c0,size:_0x463416}=attachments[0x0],_0x154c47=this[_0x5f5037(0xfe)][_0x5f5037(0xc9)]([_0x5f5037(0x114)]);let _0x58a5f4='';(!Number(_0x154c47)||Number(_0x154c47)===0x0)&&(_0x58a5f4=await this['uploadService'][_0x5f5037(0x116)]({'filename':_0x2f1807,'url':_0xef6d61}),console['log']('存入图片完成:\x20',_0x58a5f4));const _0x1d5470={'curIp':(0x0,utils_1[_0x5f5037(0x9d)])(_0x292372),'userId':_0x292372['user']['id'],'type':balance_constant_1[_0x5f5037(0x12c)][_0x5f5037(0x84)],'prompt':_0x3e6ba0,'answer':_0x58a5f4,'model':'mj','extend':this[_0x5f5037(0xb5)](JSON[_0x5f5037(0xcd)](_0x2a42e1)),'message_id':_0x190a01,'upscaleId':_0x492654,'variationId':_0x492654,'action':'enlarge','orderId':_0x14e7b6[_0x5f5037(0xde)],'isSaveImg':!Number(_0x154c47)||Number(_0x154c47)===0x0,'fileInfo':JSON[_0x5f5037(0xcd)]({'width':_0x44fbac,'height':_0x37d7c0,'size':_0x463416,'filename':_0x2f1807,'cosUrl':_0x58a5f4})};return await this[_0x5f5037(0x10b)]['saveChatLog'](_0x1d5470),_0x58a5f4;}catch(_0x4f3381){console['log'](_0x5f5037(0xd0),_0x4f3381),this[_0x5f5037(0xe5)]--,this[_0x5f5037(0xe5)]<0x0&&(this['queueCount']=0x0),console[_0x5f5037(0x9e)](_0x5f5037(0x8a),this[_0x5f5037(0xe5)]);throw new common_1[(_0x5f5037(0xd7))](_0x4f3381[_0x5f5037(0xe8)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x1a1aa0(0xa5)](_0x1f4844,_0x34c57b){const _0x261419=_0x1a1aa0;if(this[_0x261419(0xe5)]>=0x3)throw new common_1[(_0x261419(0xd7))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x261419(0xa4)][_0x261419(0x87)]);await this[_0x261419(0x125)](_0x34c57b),await this[_0x261419(0x9f)](_0x34c57b),this['queueCount']++,console[_0x261419(0x9e)]('用户'+_0x34c57b['user']['id']+_0x261419(0xad),this[_0x261419(0xe5)]);const {message_id:_0x5b8a08,orderId:_0x1808d4}=_0x1f4844;try{const _0x3103b8=await this['chatLogEntity'][_0x261419(0x90)]({'where':{'message_id':_0x5b8a08}});if(!_0x3103b8)throw new common_1[(_0x261419(0xd7))](_0x261419(0x9a),common_1[_0x261419(0xa4)]['BAD_REQUEST']);const {prompt:_0x183bbc,extend:_0x421780}=_0x3103b8;let _0x1d52af=null;try{_0x1d52af=JSON[_0x261419(0xfc)](_0x421780);}catch(_0xcb80d4){_0x1d52af=[];}const {components:components=[]}=_0x1d52af;if(!components['length'])throw new common_1[(_0x261419(0xd7))]('当前图片没有绘画信息、无法变体!',common_1['HttpStatus'][_0x261419(0x87)]);const _0x3ea7c9=components[0x1][_0x261419(0xa1)][_0x1808d4-0x1],{custom_id:_0x4170e6}=_0x3ea7c9,_0x8b79b5=await this[_0x261419(0x130)][_0x261419(0x127)]({'where':{'variationId':(0x0,typeorm_1[_0x261419(0xa9)])((0x0,typeorm_1['IsNull'])()),'prompt':(0x0,typeorm_1[_0x261419(0xcc)])('%'+_0x183bbc+'%')}}),_0x261883=_0x8b79b5['map'](_0x13acf2=>_0x13acf2[_0x261419(0xce)]),_0x3417c2={'message_id':_0x5b8a08,'custom_id':_0x4170e6,'prompt':_0x183bbc,'orderId':_0x1808d4};await this['sendSmInteractions'](_0x3417c2);const _0x5038a0=await this[_0x261419(0xa8)](_0x3417c2,_0x261883);this[_0x261419(0xe5)]--,this[_0x261419(0xe5)]<0x0&&(this[_0x261419(0xe5)]=0x0),console[_0x261419(0x9e)](_0x261419(0x103),this[_0x261419(0xe5)]);const {id:_0x508e3c,content:_0x46f597,channel_id:_0x3152af,attachments:attachments=[],timestamp:_0x40dcac}=_0x5038a0;if(!attachments['length']||!attachments[0x0]['url'])throw new common_1['HttpException'](_0x261419(0x98),common_1[_0x261419(0xa4)]['BAD_REQUEST']);const {filename:_0x4d4ffa,url:_0x493474,width:_0x344eed,height:_0x18ea1e,size:_0x8427f9}=attachments[0x0],_0x323aee=this[_0x261419(0xfe)][_0x261419(0xc9)]([_0x261419(0x114)]);let _0x24f7ee='';(!Number(_0x323aee)||Number(_0x323aee)===0x0)&&(_0x24f7ee=await this[_0x261419(0xa0)]['uploadFileFromUrl']({'filename':_0x4d4ffa,'url':_0x493474}),console['log'](_0x261419(0xaf),_0x24f7ee));const _0x4e91f6={'curIp':(0x0,utils_1[_0x261419(0x9d)])(_0x34c57b),'userId':_0x34c57b[_0x261419(0xa2)]['id'],'type':balance_constant_1[_0x261419(0x12c)]['PAINT_TYPE'],'prompt':_0x183bbc,'answer':_0x24f7ee,'model':'mj','group':0x1,'extend':this['removeEmoji'](JSON[_0x261419(0xcd)](_0x5038a0)),'message_id':_0x508e3c,'upscaleId':_0x508e3c,'variationId':_0x508e3c,'action':_0x261419(0x128),'orderId':_0x3417c2[_0x261419(0xde)],'isSaveImg':!Number(_0x323aee)||Number(_0x323aee)===0x0,'fileInfo':JSON[_0x261419(0xcd)]({'width':_0x344eed,'height':_0x18ea1e,'size':_0x8427f9,'filename':_0x4d4ffa,'cosUrl':_0x24f7ee})};return await this[_0x261419(0x10b)][_0x261419(0x12b)](_0x4e91f6),_0x24f7ee;}catch(_0x3cd746){console[_0x261419(0x9e)]('error:\x20',_0x3cd746),this[_0x261419(0xe5)]--,this['queueCount']<0x0&&(this[_0x261419(0xe5)]=0x0),console[_0x261419(0x9e)](_0x261419(0x91),this['queueCount']);throw new common_1[(_0x261419(0xd7))](_0x3cd746[_0x261419(0xe8)],common_1[_0x261419(0xa4)][_0x261419(0x87)]);}}async['sendSmInteractions'](_0x1beaec){const _0xdb3241=_0x1a1aa0,{message_id:_0x2acf39,custom_id:_0x17e7e0}=_0x1beaec,{application_id:_0xfb57b7,guild_id:_0xfcf828,channel_id:_0x4e0c17,session_id:_0x38c30e,version:_0x1b8838,id:_0xc603e3,authorization:_0x4980d1,mjProxy:_0x15eccb}=await this[_0xdb3241(0x10f)](),_0x1a213b=_0x15eccb==0x1?'http://172.247.48.137:8000/mj/draw':_0xdb3241(0xb8),_0x2a5bcf={'authorization':_0x4980d1},_0x3019a3={'type':0x3,'guild_id':_0xfcf828,'channel_id':_0x4e0c17,'message_flags':0x0,'message_id':_0x2acf39,'application_id':_0xfb57b7,'session_id':_0x38c30e,'data':{'component_type':0x2,'custom_id':_0x17e7e0}};try{await axios_1[_0xdb3241(0x129)][_0xdb3241(0x121)](_0x1a213b,_0x3019a3,{'headers':_0x2a5bcf}),console[_0xdb3241(0x9e)](_0xdb3241(0x93));}catch(_0x56d55c){console[_0xdb3241(0x9e)](_0xdb3241(0xd0),_0x56d55c);throw new common_1[(_0xdb3241(0xd7))](_0xdb3241(0xca),common_1[_0xdb3241(0xa4)][_0xdb3241(0x87)]);}}async[_0x1a1aa0(0xd5)](_0xa62018,_0x2777fd){const _0x2410c4=_0x1a1aa0,{message_id:_0xf9c52c,custom_id:_0x4fd00c,prompt:_0x43bcd6,orderId:_0x2a090b}=_0xa62018;let _0x3cdf3e=null,_0x4c2774=0x0;while(!_0x3cdf3e&&_0x4c2774<0xa){try{const _0x471c05=Date['now'](),_0x5497a2=await this[_0x2410c4(0xef)]();console['log']('第\x20'+(_0x4c2774+0x1)+_0x2410c4(0xbd)+_0x5497a2[_0x2410c4(0xea)]);_0x5497a2&&_0x5497a2[_0x2410c4(0xea)]&&(_0x3cdf3e=await this[_0x2410c4(0x11b)](_0x5497a2,_0xa62018,_0x2777fd));const _0x570738=Date['now']()-_0x471c05,_0x3f370c=0xbb8;await this[_0x2410c4(0xf8)](Math[_0x2410c4(0xcf)](_0x3f370c-_0x570738,0x0)),_0x4c2774++;}catch(_0x32d79e){console['error']('查询期间出现错误：'+_0x32d79e['message']);}}return _0x3cdf3e;}async['pollForVariationResult'](_0x48680d,_0x1a28b0){const _0x51e908=_0x1a1aa0,{message_id:_0x1a6cb5,custom_id:_0x4801fb,prompt:_0x439e5f,orderId:_0x3213af}=_0x48680d;console['log'](_0x51e908(0x11d));let _0x291de5=null,_0x2eb409=0x0;while(!_0x291de5&&_0x2eb409<0xa){try{console[_0x51e908(0x9e)]('第\x20'+(_0x2eb409+0x1)+_0x51e908(0xbb));const _0x33dac6=Date[_0x51e908(0xe6)](),_0x3f624a=await this['queryMessageList']();_0x3f624a&&_0x3f624a['length']&&(_0x291de5=await this[_0x51e908(0xf9)](_0x3f624a,_0x48680d,_0x1a28b0));const _0x212245=Date['now']()-_0x33dac6,_0x52ff45=0x1f40;await this[_0x51e908(0xf8)](Math[_0x51e908(0xcf)](_0x52ff45-_0x212245,0x0)),_0x2eb409++;}catch(_0x2a9704){console[_0x51e908(0x85)](_0x51e908(0x99)+_0x2a9704[_0x51e908(0x105)]);}}if(!_0x291de5)throw new common_1['HttpException'](_0x51e908(0x8e),common_1[_0x51e908(0xa4)][_0x51e908(0x87)]);return _0x291de5;}async[_0x1a1aa0(0x11b)](_0x234f3d,_0x568cab,_0x32410c){const _0x53bcb8=_0x1a1aa0,{message_id:_0x1f7a33,custom_id:_0x38c31b,prompt:_0x5cb9b2,orderId:_0x3abfbc}=_0x568cab,_0x396c60=_0x5cb9b2['substring'](0x0,0xc);console[_0x53bcb8(0x9e)]('本次放大图片的id:\x20',_0x396c60);const _0x573e54=_0x234f3d[_0x53bcb8(0x127)](_0x4cb791=>{const _0x17d79c=_0x53bcb8,{content:_0x402436}=_0x4cb791;if(!this[_0x17d79c(0x89)](_0x402436))return![];const {prompt:_0x17e907,order:_0x165ce4}=this[_0x17d79c(0x89)](_0x402436);return _0x17e907[_0x17d79c(0xf7)](_0x396c60)&&_0x568cab[_0x17d79c(0xde)]===_0x165ce4&&!_0x32410c['includes'](_0x4cb791['id']);});return _0x573e54;}async['findCurrentVariationImgResult'](_0x5a2ca0,_0x3183ff,_0x1016fa){const _0x54ab43=_0x1a1aa0,{message_id:_0x4244d6,custom_id:_0x50dbd8,prompt:_0x2b88df,orderId:_0x144ca7}=_0x3183ff,_0x1a676e=_0x2b88df[_0x54ab43(0xc6)](0x0,0xc),_0x21b221=_0x5a2ca0[_0x54ab43(0x127)](_0x1d5a29=>{const _0x462ec3=_0x54ab43,{content:_0x38268b}=_0x1d5a29,_0x1478ec=_0x38268b[_0x462ec3(0xfa)](/\*\*(.+?)\*\*/),_0x21c78b=_0x1478ec?_0x1478ec[0x1]:'';if(!_0x21c78b)return![];return _0x21c78b[_0x462ec3(0xf7)](_0x1a676e)&&!_0x1016fa[_0x462ec3(0xf7)](_0x1d5a29['id']);});return _0x21b221;}async[_0x1a1aa0(0xd2)](_0x24c7e2,_0x36abb2,_0x3fe199){const _0x3cee6e=_0x1a1aa0,_0x5be706=await this[_0x3cee6e(0xef)](),_0x534735=await this['findCurrentPromptResult'](_0x5be706,_0x3fe199,_0x36abb2);if(_0x534735)return console[_0x3cee6e(0x9e)](_0x3cee6e(0xd4),_0x534735),_0x534735;const {application_id:_0x20fefb,guild_id:_0x4ab504,channel_id:_0x4659e9,session_id:_0x4f02cc,version:_0x5f068e,id:_0x4aa106,authorization:_0x2756e5,mjProxy:_0x16216d}=await this[_0x3cee6e(0x10f)](),_0x374056={'type':0x2,'application_id':_0x20fefb,'guild_id':_0x4ab504,'channel_id':_0x4659e9,'session_id':_0x4f02cc,'data':{'version':_0x5f068e,'id':_0x4aa106,'name':_0x3cee6e(0xed),'type':0x1,'options':[{'type':0x3,'name':_0x3cee6e(0x8d),'value':_0x24c7e2}],'attachments':[]}};try{const _0x5be10a=_0x16216d==0x1?_0x3cee6e(0xb2):'https://discord.com/api/v9/interactions',_0x4a2ca7={'authorization':_0x2756e5},_0x3f178c=await axios_1['default'][_0x3cee6e(0x121)](_0x5be10a,_0x374056,{'headers':_0x4a2ca7});return console[_0x3cee6e(0x9e)]('发送绘画指令结果:\x20',_0x3f178c[_0x3cee6e(0x11c)]),![];}catch(_0x5d1dbc){console[_0x3cee6e(0x9e)](_0x3cee6e(0xf2),_0x5d1dbc);throw new common_1['HttpException']('绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...',common_1[_0x3cee6e(0xa4)][_0x3cee6e(0x87)]);}}async[_0x1a1aa0(0xdc)](_0x4b5c00,_0x1febca,_0x4d6110){const _0x20945e=_0x1a1aa0;console[_0x20945e(0x9e)](_0x20945e(0xc1));const _0x123a1b=Date[_0x20945e(0xe6)]();try{const _0x2a306d=0xd,_0x5b4218=0x2ee0,_0x292226=0x1388,_0x2bc58a=0x3c*0x3e8;let _0x2517b6=0x0,_0x2d9f62=![],_0x448867=null;while(!_0x448867&&_0x2517b6<_0x2a306d){console['log']('第\x20'+(_0x2517b6+0x1)+'\x20次开始查询');Date[_0x20945e(0xe6)]()-_0x123a1b>=_0x2bc58a&&(_0x2d9f62=!![]);await this['sleep'](_0x2d9f62?_0x292226:_0x5b4218);const _0x4f5a79=await this[_0x20945e(0xef)]();_0x448867=await this['findCurrentPromptResult'](_0x4f5a79,_0x4d6110,_0x1febca),_0x2517b6++;}if(!_0x448867)throw new common_1[(_0x20945e(0xd7))](_0x20945e(0xb6),common_1[_0x20945e(0xa4)][_0x20945e(0x87)]);const _0x479127=Date['now']();return console[_0x20945e(0x9e)](_0x20945e(0xe9)+Math[_0x20945e(0xc8)]((_0x479127-_0x123a1b)/0x3e8)+'\x20S'),_0x448867;}catch(_0x4332d9){console[_0x20945e(0x85)](_0x4332d9[_0x20945e(0x105)]);throw new common_1['HttpException'](_0x20945e(0xb9),common_1[_0x20945e(0xa4)][_0x20945e(0x115)]);}}async[_0x1a1aa0(0x120)](_0x12cc68,_0x4ad042,_0x1ef6f3){const _0x224889=_0x1a1aa0;if(!_0x12cc68||!_0x12cc68[_0x224889(0xea)])return;console[_0x224889(0x9e)](_0x224889(0x102),_0x4ad042);const _0x474304=_0x12cc68['find'](_0x305c3c=>{const _0x725e27=_0x224889,{attachments:attachments=[],content:_0x3817d2,edited_timestamp:_0x3b6054}=_0x305c3c;return _0x3817d2[_0x725e27(0xf7)](_0x4ad042)&&attachments[_0x725e27(0xea)]>0x0&&!_0x3b6054&&!_0x1ef6f3[_0x725e27(0xf7)](_0x305c3c['id']);});return _0x474304||null;}async['queryMessageList'](){const _0x127a9f=_0x1a1aa0;try{const {application_id:_0x2c0f87,guild_id:_0x231f1e,channel_id:_0x21351a,session_id:_0x243798,version:_0x5c4d69,id:_0x3d4a55,authorization:_0x5a2df4,mjProxy:_0x4a0970}=await this[_0x127a9f(0x10f)](),_0x1c0ff2=_0x4a0970==0x1?_0x127a9f(0xc5)+_0x21351a:_0x127a9f(0x83)+_0x21351a+'/messages?limit=50',_0x2dfb3f={'authorization':_0x5a2df4},_0x1199ca=await axios_1[_0x127a9f(0x129)][_0x127a9f(0xd9)](_0x1c0ff2,{'headers':_0x2dfb3f});return _0x1199ca[_0x127a9f(0x11c)];}catch(_0x800bbc){console['log']('axios\x20get:\x20',_0x800bbc);throw new common_1[(_0x127a9f(0xd7))](_0x127a9f(0x9b),common_1[_0x127a9f(0xa4)][_0x127a9f(0x87)]);}}async[_0x1a1aa0(0xf8)](_0x3a0ba0){return new Promise(_0x17d67b=>setTimeout(_0x17d67b,_0x3a0ba0));}['extractContent'](_0x49dc03){const _0x1c9603=_0x1a1aa0,_0x473934=_0x49dc03[_0x1c9603(0xfa)](/\*\*(.+?)\*\*/),_0x4a584f=_0x49dc03['match'](/- Image #(\d+)/);if(!_0x473934||!_0x4a584f)return null;const _0x9f8f67=_0x473934[0x1],_0x490f30=parseInt(_0x4a584f[0x1]);return{'prompt':_0x9f8f67,'order':_0x490f30};}async['getMjDefaultParams'](){const _0x8fb99c=_0x1a1aa0,_0x5644ca=await this[_0x8fb99c(0xfe)][_0x8fb99c(0xc9)](['mjId','mjApplicationId',_0x8fb99c(0x106),_0x8fb99c(0xb3),_0x8fb99c(0x101),_0x8fb99c(0xbe),'mjAuthorization',_0x8fb99c(0x113),_0x8fb99c(0xc2)]),_0x78b6a6={'application_id':_0x5644ca[_0x8fb99c(0x94)],'guild_id':_0x5644ca[_0x8fb99c(0x106)],'channel_id':_0x5644ca[_0x8fb99c(0xb3)],'session_id':_0x5644ca['mjSessionId'],'version':_0x5644ca[_0x8fb99c(0xbe)],'id':_0x5644ca['mjId'],'authorization':_0x5644ca[_0x8fb99c(0xdb)],'mjRateLimit':_0x5644ca['mjRateLimit'],'mjProxy':_0x5644ca[_0x8fb99c(0xc2)]||0x0};return _0x78b6a6;}[_0x1a1aa0(0xb5)](_0x3bfee3){const _0xfd9542=_0x1a1aa0,_0x684f82=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x3bfee3[_0xfd9542(0x92)](_0x684f82,'');}async[_0x1a1aa0(0x125)](_0x13697b){const _0x4f456c=_0x1a1aa0,_0x1cd8f2=await this[_0x4f456c(0xc3)]['findOne']({'where':{'userId':_0x13697b['user']['id']}}),{id:_0x389914,balance:_0x43badf}=_0x1cd8f2;if(!_0x43badf||(_0x1cd8f2===null||_0x1cd8f2===void 0x0?void 0x0:_0x1cd8f2['balance'])<0x1)throw new common_1[(_0x4f456c(0xd7))](_0x4f456c(0x10d),common_1[_0x4f456c(0xa4)][_0x4f456c(0x87)]);}async[_0x1a1aa0(0xbf)](_0x200e8f){const _0x32ea9c=_0x1a1aa0,{id:_0x410172,role:_0x59c4ef}=_0x200e8f[_0x32ea9c(0xa2)];!this[_0x32ea9c(0xfb)][_0x410172]?this['freeQueueUsers'][_0x410172]=0x1:this['freeQueueUsers'][_0x410172]=this[_0x32ea9c(0xfb)][_0x410172]+0x1,console[_0x32ea9c(0x9e)](_0x32ea9c(0xaa)+_0x410172+_0x32ea9c(0xee),this['freeQueueUsers'][_0x410172]);}async[_0x1a1aa0(0x9f)](_0x21afd8){const _0xa40063=_0x1a1aa0,{id:_0x3f8aec,role:_0x3af913}=_0x21afd8['user'];if(['admin',_0xa40063(0x135)]['includes'](_0x3af913))return!![];const {mjRateLimit:_0x1e18e0}=await this[_0xa40063(0x10f)]();if(this[_0xa40063(0xc4)][_0x3f8aec]){const _0x3da814=this['rateLimits'][_0x3f8aec];if(_0x3da814>Date[_0xa40063(0xe6)]()){console[_0xa40063(0x9e)](_0xa40063(0x107)+_0x3f8aec+_0xa40063(0xc0));throw new common_1[(_0xa40063(0xd7))]('由于速率限制、当前普通用户限制为'+_0x1e18e0+_0xa40063(0x136),common_1[_0xa40063(0xa4)]['BAD_REQUEST']);}else this[_0xa40063(0xc4)][_0x3f8aec]=Date['now']()+Number(_0x1e18e0)*0x3e8;}else{const _0x54d781=Date['now']();this[_0xa40063(0xc4)][_0x3f8aec]=_0x54d781+0x3e8*Number(_0x1e18e0);}}async[_0x1a1aa0(0x8b)](_0x36562a){const _0x3c10a7=_0x1a1aa0;await this[_0x3c10a7(0xc3)]['createQueryBuilder']()[_0x3c10a7(0xec)](balance_entity_1[_0x3c10a7(0xd3)])[_0x3c10a7(0xf0)]({'balance':()=>_0x3c10a7(0xd1)})['where'](_0x3c10a7(0x8c),{'userId':_0x36562a[_0x3c10a7(0xa2)]['id']})['execute']();}async[_0x1a1aa0(0x88)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x1a1aa0(0xe2)])(),__param(0x0,(0x0,typeorm_2[_0x1a1aa0(0xac)])(chatLog_entity_1[_0x1a1aa0(0xbc)])),__param(0x1,(0x0,typeorm_2[_0x1a1aa0(0xac)])(balance_entity_1[_0x1a1aa0(0xd3)])),__metadata(_0x1a1aa0(0xf3),[typeorm_1[_0x1a1aa0(0x123)],typeorm_1['Repository'],upload_service_1[_0x1a1aa0(0x112)],chatLog_service_1[_0x1a1aa0(0x131)],globalConfig_service_1[_0x1a1aa0(0xdd)],fanyi_service_1['FanyiService'],badwords_service_1[_0x1a1aa0(0x86)]])],MjService),exports[_0x1a1aa0(0x12a)]=MjService;