'use strict';const _0xfc6b5b=_0x4c5e;(function(_0x15eff2,_0x26273c){const _0x366304=_0x4c5e,_0x2939da=_0x15eff2();while(!![]){try{const _0x387868=-parseInt(_0x366304(0xa3))/0x1*(-parseInt(_0x366304(0x7d))/0x2)+parseInt(_0x366304(0xa2))/0x3*(parseInt(_0x366304(0xa8))/0x4)+-parseInt(_0x366304(0x82))/0x5*(-parseInt(_0x366304(0xa7))/0x6)+parseInt(_0x366304(0xe1))/0x7+parseInt(_0x366304(0xd1))/0x8*(parseInt(_0x366304(0xbf))/0x9)+parseInt(_0x366304(0x72))/0xa*(parseInt(_0x366304(0xcc))/0xb)+-parseInt(_0x366304(0xdd))/0xc;if(_0x387868===_0x26273c)break;else _0x2939da['push'](_0x2939da['shift']());}catch(_0x5716a9){_0x2939da['push'](_0x2939da['shift']());}}}(_0x4835,0xb51f6));function _0x4c5e(_0x38b67e,_0x3023ab){const _0x4835f9=_0x4835();return _0x4c5e=function(_0x4c5e05,_0x2cf5a2){_0x4c5e05=_0x4c5e05-0x65;let _0x310f4e=_0x4835f9[_0x4c5e05];return _0x310f4e;},_0x4c5e(_0x38b67e,_0x3023ab);}var __decorate=this&&this['__decorate']||function(_0x1d0f7d,_0x4f7fc0,_0x357ce4,_0x37ebf9){const _0x57a885=_0x4c5e;var _0xe5dcf6=arguments['length'],_0x590fb3=_0xe5dcf6<0x3?_0x4f7fc0:_0x37ebf9===null?_0x37ebf9=Object[_0x57a885(0x10d)](_0x4f7fc0,_0x357ce4):_0x37ebf9,_0x4cebe4;if(typeof Reflect==='object'&&typeof Reflect[_0x57a885(0x96)]===_0x57a885(0x111))_0x590fb3=Reflect[_0x57a885(0x96)](_0x1d0f7d,_0x4f7fc0,_0x357ce4,_0x37ebf9);else{for(var _0x42c0f8=_0x1d0f7d[_0x57a885(0x7f)]-0x1;_0x42c0f8>=0x0;_0x42c0f8--)if(_0x4cebe4=_0x1d0f7d[_0x42c0f8])_0x590fb3=(_0xe5dcf6<0x3?_0x4cebe4(_0x590fb3):_0xe5dcf6>0x3?_0x4cebe4(_0x4f7fc0,_0x357ce4,_0x590fb3):_0x4cebe4(_0x4f7fc0,_0x357ce4))||_0x590fb3;}return _0xe5dcf6>0x3&&_0x590fb3&&Object['defineProperty'](_0x4f7fc0,_0x357ce4,_0x590fb3),_0x590fb3;},__metadata=this&&this['__metadata']||function(_0x50d338,_0x2cde45){const _0x273936=_0x4c5e;if(typeof Reflect===_0x273936(0xb2)&&typeof Reflect[_0x273936(0xfa)]==='function')return Reflect['metadata'](_0x50d338,_0x2cde45);},__param=this&&this[_0xfc6b5b(0x8d)]||function(_0xeb7b95,_0x46b683){return function(_0x10f6f1,_0x580e09){_0x46b683(_0x10f6f1,_0x580e09,_0xeb7b95);};};Object['defineProperty'](exports,_0xfc6b5b(0x10f),{'value':!![]}),exports[_0xfc6b5b(0x84)]=void 0x0;const globalConfig_service_1=require(_0xfc6b5b(0xc5)),upload_service_1=require('./../upload/upload.service'),common_1=require(_0xfc6b5b(0x80)),axios_1=require('axios'),chatLog_service_1=require(_0xfc6b5b(0xa0)),balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require(_0xfc6b5b(0xc9)),chatLog_entity_1=require(_0xfc6b5b(0xf2)),typeorm_1=require('typeorm'),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require('../userBalance/balance.entity'),fanyi_service_1=require(_0xfc6b5b(0xf0)),badwords_service_1=require(_0xfc6b5b(0x78));let MjService=class MjService{constructor(_0xcc0d18,_0x2007df,_0x374eb3,_0x63ffc0,_0x16bc24,_0x4f5efe,_0x4a3cab){const _0x41ae08=_0xfc6b5b;this['chatLogEntity']=_0xcc0d18,this[_0x41ae08(0xde)]=_0x2007df,this['uploadService']=_0x374eb3,this[_0x41ae08(0x116)]=_0x63ffc0,this[_0x41ae08(0xaa)]=_0x16bc24,this[_0x41ae08(0xe7)]=_0x4f5efe,this['badwordsService']=_0x4a3cab,this[_0x41ae08(0xcd)]={},this['drawWorking']=[],this[_0x41ae08(0x109)]=[],this[_0x41ae08(0x76)]=0x0,this[_0x41ae08(0xe8)]={};}async[_0xfc6b5b(0x65)](_0x31784a){const _0x3ba338=_0xfc6b5b,{jobId:_0x124a41,prompt:_0x23399f,startTime:_0x26d869,userId:_0x1f315b}=_0x31784a;return console[_0x3ba338(0xea)]('绘画任务开始',_0x3ba338(0xf3)),await new Promise(_0x3c8445=>setTimeout(_0x3c8445,0x1388)),{'a':0x1,'b':0x2};}async[_0xfc6b5b(0xed)](_0xac59ad,_0x7c2ef2){const _0x5aca56=_0xfc6b5b;await this[_0x5aca56(0x8a)](_0x7c2ef2),await this[_0x5aca56(0xff)][_0x5aca56(0x99)](_0xac59ad['prompt'],_0x7c2ef2[_0x5aca56(0xc1)]['id']);const _0x5bd3d9=_0xac59ad[_0x5aca56(0x7c)];let _0xe13ce2=_0xac59ad[_0x5aca56(0x7c)];const {baiduFanyiAppId:_0xb5aa46,baiduFanyiSecret:_0x48faf1}=await this[_0x5aca56(0xaa)][_0x5aca56(0x9d)](['baiduFanyiAppId',_0x5aca56(0xae)]);_0xb5aa46&&_0x48faf1&&(_0xe13ce2=await this[_0x5aca56(0xe7)][_0x5aca56(0x112)](_0x5bd3d9));const _0x429e08='['+(0x0,utils_1['createRandomUid'])()+']',_0x4d76ed=_0x429e08+'\x20'+_0xe13ce2;console[_0x5aca56(0xea)](_0x5aca56(0x91),_0x429e08),console[_0x5aca56(0xea)](_0x5aca56(0x101),_0x4d76ed);const _0xa3936c=this[_0x5aca56(0xa9)]['find'](_0xdf8273=>_0xdf8273[_0x5aca56(0x9e)](_0xac59ad['prompt']));if(_0xa3936c)throw new common_1[(_0x5aca56(0x6c))](_0x5aca56(0xe0),common_1[_0x5aca56(0x106)][_0x5aca56(0x115)]);if(this['queueCount']>=0x3)throw new common_1[(_0x5aca56(0x6c))](_0x5aca56(0xf4),common_1[_0x5aca56(0x106)][_0x5aca56(0x115)]);await this[_0x5aca56(0x8f)](_0x7c2ef2),this[_0x5aca56(0x76)]++,console[_0x5aca56(0xea)]('开始请求用户'+_0x7c2ef2[_0x5aca56(0xc1)]['id']+_0x5aca56(0x9b),this[_0x5aca56(0x76)]);try{const _0x45eb41=await this[_0x5aca56(0xd9)]['find']({'where':{'prompt':(0x0,typeorm_1[_0x5aca56(0xda)])('%'+_0x4d76ed+'%')}}),_0x49e1fd=_0x45eb41[_0x5aca56(0x77)](_0x50cc5c=>_0x50cc5c[_0x5aca56(0xe3)]);this[_0x5aca56(0xa9)][_0x5aca56(0xc2)](_0x4d76ed);let _0x223200;const _0x1677c3=await this[_0x5aca56(0xfc)](_0x4d76ed,_0x49e1fd,_0x429e08);_0x1677c3?(console[_0x5aca56(0xea)](_0x5aca56(0xf8)),_0x223200=_0x1677c3):_0x223200=await this[_0x5aca56(0xd6)](_0x4d76ed,_0x49e1fd,_0x429e08);this[_0x5aca56(0x76)]--,this[_0x5aca56(0x76)]<0x0&&(this[_0x5aca56(0x76)]=0x0),console[_0x5aca56(0xea)](_0x5aca56(0xb6),this['queueCount']);const {id:_0xdace32,content:_0x525a29,channel_id:_0x4f5b28,attachments:attachments=[],timestamp:_0x3edbab}=_0x223200;if(!attachments['length']||!attachments[0x0][_0x5aca56(0x71)])throw new common_1[(_0x5aca56(0x6c))](_0x5aca56(0xbb),common_1['HttpStatus'][_0x5aca56(0x115)]);const {filename:_0x581ced,url:_0x255d92,width:_0x42f204,height:_0x947d3d,size:_0x4a3589}=attachments[0x0],_0x5ae21d=this['globalConfigService'][_0x5aca56(0x9d)](['mjNotSaveImg']);let _0x4f3e27='';(!Number(_0x5ae21d)||Number(_0x5ae21d)===0x0)&&(_0x4f3e27=await this['uploadService'][_0x5aca56(0xee)]({'filename':_0x581ced,'url':_0x255d92}),console[_0x5aca56(0xea)]('存入图片完成:\x20',_0x4f3e27));const _0x257719={'curIp':(0x0,utils_1[_0x5aca56(0x105)])(_0x7c2ef2),'userId':_0x7c2ef2['user']['id'],'type':balance_constant_1['DeductionKey'][_0x5aca56(0xc0)],'prompt':_0x4d76ed,'answer':_0x4f3e27,'model':'mj','extend':this[_0x5aca56(0x87)](JSON['stringify'](_0x223200)),'message_id':_0xdace32,'variationId':_0xdace32,'upscaleId':_0xdace32,'group':0x1,'isSaveImg':!Number(_0x5ae21d)||Number(_0x5ae21d)===0x0,'fileInfo':JSON[_0x5aca56(0x86)]({'width':_0x42f204,'height':_0x947d3d,'size':_0x4a3589,'filename':_0x581ced,'cosUrl':_0x4f3e27})};return await this[_0x5aca56(0x116)]['saveChatLog'](_0x257719),await this['deductBalance'](_0x7c2ef2),this[_0x5aca56(0xa9)]=this[_0x5aca56(0xa9)]['filter'](_0x5ce3b3=>_0x5ce3b3!==_0xac59ad[_0x5aca56(0x7c)]),_0x4f3e27;}catch(_0x3a1ee8){this[_0x5aca56(0x76)]--,this[_0x5aca56(0x76)]<0x0&&(this[_0x5aca56(0x76)]=0x0),console['log'](_0x5aca56(0x79),this['queueCount']),this[_0x5aca56(0xa9)]=this[_0x5aca56(0xa9)][_0x5aca56(0xbd)](_0x14dfa4=>_0x14dfa4!==_0xac59ad[_0x5aca56(0x7c)]);throw new common_1[(_0x5aca56(0x6c))](_0x3a1ee8[_0x5aca56(0xb0)],common_1['HttpStatus'][_0x5aca56(0x115)]);}}async[_0xfc6b5b(0x70)](_0x5034a0,_0x4ff27d){const _0x5afca7=_0xfc6b5b;if(this[_0x5afca7(0x76)]>=0x3)throw new common_1[(_0x5afca7(0x6c))](_0x5afca7(0xf4),common_1[_0x5afca7(0x106)][_0x5afca7(0x115)]);this['queueCount']++,console['log']('用户'+_0x4ff27d['user']['id']+_0x5afca7(0x113),this[_0x5afca7(0x76)]);const {message_id:_0x564ff1,orderId:_0x54989e}=_0x5034a0;try{const _0x4c59c4=await this[_0x5afca7(0xd9)][_0x5afca7(0x114)]({'where':{'message_id':_0x564ff1}});if(!_0x4c59c4)throw new common_1['HttpException'](_0x5afca7(0x8c),common_1['HttpStatus'][_0x5afca7(0x115)]);const _0x265424=await this[_0x5afca7(0xd9)][_0x5afca7(0x114)]({'where':{'upscaleId':_0x564ff1,'action':_0x5afca7(0xb9),'orderId':_0x54989e}});if(_0x265424)throw new common_1['HttpException'](_0x5afca7(0x6d),common_1[_0x5afca7(0x106)][_0x5afca7(0x115)]);const {prompt:_0x453b5a,extend:_0x18f3c2}=_0x4c59c4;let _0x5379a4=null;try{_0x5379a4=JSON[_0x5afca7(0xb8)](_0x18f3c2);}catch(_0x5b13e4){_0x5379a4=[];}const {components:components=[]}=_0x5379a4;if(!components[_0x5afca7(0x7f)])throw new common_1[(_0x5afca7(0x6c))](_0x5afca7(0xb7),common_1[_0x5afca7(0x106)]['BAD_REQUEST']);const _0xfc21d6=components[0x0][_0x5afca7(0xef)][_0x54989e-0x1],{custom_id:_0x2c0406}=_0xfc21d6;console[_0x5afca7(0xea)]('放大custom_id:\x20',_0x2c0406);const _0x44d692={'message_id':_0x564ff1,'custom_id':_0x2c0406,'prompt':_0x453b5a,'orderId':_0x54989e};await this[_0x5afca7(0x69)](_0x44d692),console[_0x5afca7(0xea)](_0x5afca7(0xd8));const _0x50163e=await this[_0x5afca7(0xd9)]['find']({'where':{'prompt':(0x0,typeorm_1[_0x5afca7(0xda)])('%'+_0x453b5a+'%')}}),_0x4a6bd2=_0x50163e[_0x5afca7(0x77)](_0xdc3bc2=>_0xdc3bc2[_0x5afca7(0xe3)]);console[_0x5afca7(0xea)](_0x5afca7(0x95),_0x4a6bd2);const _0x54eac6=await this[_0x5afca7(0xbc)](_0x44d692,_0x4a6bd2);this['queueCount']--,this[_0x5afca7(0x76)]<0x0&&(this['queueCount']=0x0),console['log'](_0x5afca7(0x73),this[_0x5afca7(0x76)]);const {id:_0x54f4c6,content:_0x525628,channel_id:_0x120020,attachments:attachments=[],timestamp:_0x5d5345}=_0x54eac6;if(!attachments['length']||!attachments[0x0]['url'])throw new common_1[(_0x5afca7(0x6c))](_0x5afca7(0x92),common_1[_0x5afca7(0x106)][_0x5afca7(0x115)]);const {filename:_0x2ce39f,url:_0x55cca9,width:_0x403642,height:_0x5bb0d6,size:_0x3afc56}=attachments[0x0],_0x376f05=this[_0x5afca7(0xaa)]['getConfigs']([_0x5afca7(0x10e)]);let _0x2d876a='';(!Number(_0x376f05)||Number(_0x376f05)===0x0)&&(_0x2d876a=await this[_0x5afca7(0x94)][_0x5afca7(0xee)]({'filename':_0x2ce39f,'url':_0x55cca9}),console[_0x5afca7(0xea)](_0x5afca7(0xce),_0x2d876a));const _0x5577d={'curIp':(0x0,utils_1[_0x5afca7(0x105)])(_0x4ff27d),'userId':_0x4ff27d[_0x5afca7(0xc1)]['id'],'type':balance_constant_1[_0x5afca7(0xec)][_0x5afca7(0xc0)],'prompt':_0x453b5a,'answer':_0x2d876a,'model':'mj','extend':this['removeEmoji'](JSON[_0x5afca7(0x86)](_0x54eac6)),'message_id':_0x564ff1,'upscaleId':_0x54f4c6,'variationId':_0x54f4c6,'action':'enlarge','orderId':_0x44d692['orderId'],'isSaveImg':!Number(_0x376f05)||Number(_0x376f05)===0x0,'fileInfo':JSON[_0x5afca7(0x86)]({'width':_0x403642,'height':_0x5bb0d6,'size':_0x3afc56,'filename':_0x2ce39f,'cosUrl':_0x2d876a})};return await this['chatLogService'][_0x5afca7(0x93)](_0x5577d),_0x2d876a;}catch(_0x325b53){console[_0x5afca7(0xea)](_0x5afca7(0x90),_0x325b53),this['queueCount']--,this[_0x5afca7(0x76)]<0x0&&(this[_0x5afca7(0x76)]=0x0),console[_0x5afca7(0xea)](_0x5afca7(0xcb),this['queueCount']);throw new common_1[(_0x5afca7(0x6c))](_0x325b53[_0x5afca7(0xb0)],common_1[_0x5afca7(0x106)][_0x5afca7(0x115)]);}}async[_0xfc6b5b(0xb1)](_0x508c29,_0x1e51e1){const _0x25410f=_0xfc6b5b;if(this[_0x25410f(0x76)]>=0x3)throw new common_1[(_0x25410f(0x6c))](_0x25410f(0xf4),common_1[_0x25410f(0x106)]['BAD_REQUEST']);await this['checkAuth'](_0x1e51e1),await this[_0x25410f(0x8f)](_0x1e51e1),this[_0x25410f(0x76)]++,console[_0x25410f(0xea)]('用户'+_0x1e51e1[_0x25410f(0xc1)]['id']+_0x25410f(0xaf),this[_0x25410f(0x76)]);const {message_id:_0x120ae9,orderId:_0x222239}=_0x508c29;try{const _0x3731c3=await this['chatLogEntity'][_0x25410f(0x114)]({'where':{'message_id':_0x120ae9}});if(!_0x3731c3)throw new common_1['HttpException'](_0x25410f(0xe9),common_1[_0x25410f(0x106)][_0x25410f(0x115)]);const {prompt:_0xbc1d33,extend:_0x2b59ce}=_0x3731c3;let _0x172152=null;try{_0x172152=JSON[_0x25410f(0xb8)](_0x2b59ce);}catch(_0x42cda2){_0x172152=[];}const {components:components=[]}=_0x172152;if(!components[_0x25410f(0x7f)])throw new common_1['HttpException']('当前图片没有绘画信息、无法变体!',common_1[_0x25410f(0x106)]['BAD_REQUEST']);const _0xed7384=components[0x1]['components'][_0x222239-0x1],{custom_id:_0x54578f}=_0xed7384,_0x11c9ed=await this[_0x25410f(0xd9)]['find']({'where':{'variationId':(0x0,typeorm_1[_0x25410f(0x97)])((0x0,typeorm_1[_0x25410f(0xd4)])()),'prompt':(0x0,typeorm_1[_0x25410f(0xda)])('%'+_0xbc1d33+'%')}}),_0x1c7cb8=_0x11c9ed['map'](_0x28c2a3=>_0x28c2a3['variationId']),_0x1d4bdf={'message_id':_0x120ae9,'custom_id':_0x54578f,'prompt':_0xbc1d33,'orderId':_0x222239};await this['sendSmInteractions'](_0x1d4bdf);const _0xe059ca=await this['pollForVariationResult'](_0x1d4bdf,_0x1c7cb8);this[_0x25410f(0x76)]--,this[_0x25410f(0x76)]<0x0&&(this[_0x25410f(0x76)]=0x0),console['log'](_0x25410f(0x110),this[_0x25410f(0x76)]);const {id:_0x329fd9,content:_0x20b3cd,channel_id:_0x34b831,attachments:attachments=[],timestamp:_0x119fbc}=_0xe059ca;if(!attachments['length']||!attachments[0x0][_0x25410f(0x71)])throw new common_1[(_0x25410f(0x6c))]('变换当前图片失败',common_1[_0x25410f(0x106)][_0x25410f(0x115)]);const {filename:_0x3d6290,url:_0xfacf9c,width:_0x35cd09,height:_0x2ebc48,size:_0x5bb467}=attachments[0x0],_0x57e041=this['globalConfigService']['getConfigs']([_0x25410f(0x10e)]);let _0x26f03c='';(!Number(_0x57e041)||Number(_0x57e041)===0x0)&&(_0x26f03c=await this[_0x25410f(0x94)][_0x25410f(0xee)]({'filename':_0x3d6290,'url':_0xfacf9c}),console[_0x25410f(0xea)]('存入图片完成:\x20',_0x26f03c));const _0xb56932={'curIp':(0x0,utils_1['getClientIp'])(_0x1e51e1),'userId':_0x1e51e1[_0x25410f(0xc1)]['id'],'type':balance_constant_1[_0x25410f(0xec)][_0x25410f(0xc0)],'prompt':_0xbc1d33,'answer':_0x26f03c,'model':'mj','group':0x1,'extend':this[_0x25410f(0x87)](JSON[_0x25410f(0x86)](_0xe059ca)),'message_id':_0x329fd9,'upscaleId':_0x329fd9,'variationId':_0x329fd9,'action':'enlarge','orderId':_0x1d4bdf[_0x25410f(0xe6)],'isSaveImg':!Number(_0x57e041)||Number(_0x57e041)===0x0,'fileInfo':JSON['stringify']({'width':_0x35cd09,'height':_0x2ebc48,'size':_0x5bb467,'filename':_0x3d6290,'cosUrl':_0x26f03c})};return await this[_0x25410f(0x116)][_0x25410f(0x93)](_0xb56932),_0x26f03c;}catch(_0x5bb0f2){console[_0x25410f(0xea)](_0x25410f(0x90),_0x5bb0f2),this['queueCount']--,this['queueCount']<0x0&&(this[_0x25410f(0x76)]=0x0),console[_0x25410f(0xea)]('变化图片任务异常中断\x20队列-1:\x20',this[_0x25410f(0x76)]);throw new common_1[(_0x25410f(0x6c))](_0x5bb0f2[_0x25410f(0xb0)],common_1[_0x25410f(0x106)][_0x25410f(0x115)]);}}async[_0xfc6b5b(0x69)](_0x486803){const _0x1eea7b=_0xfc6b5b,{message_id:_0x1e075a,custom_id:_0x20a387}=_0x486803,{application_id:_0x505abb,guild_id:_0x5f48c4,channel_id:_0x5120ea,session_id:_0x410c6f,version:_0x363e27,id:_0x1fb287,authorization:_0x24d192,mjProxy:_0x47265e}=await this[_0x1eea7b(0xeb)](),_0x16c24e=_0x47265e==0x1?_0x1eea7b(0xfd):_0x1eea7b(0xd0),_0x256556={'authorization':_0x24d192},_0x1e69f0={'type':0x3,'guild_id':_0x5f48c4,'channel_id':_0x5120ea,'message_flags':0x0,'message_id':_0x1e075a,'application_id':_0x505abb,'session_id':_0x410c6f,'data':{'component_type':0x2,'custom_id':_0x20a387}};try{await axios_1[_0x1eea7b(0xfe)][_0x1eea7b(0x83)](_0x16c24e,_0x1e69f0,{'headers':_0x256556}),console['log'](_0x1eea7b(0x74));}catch(_0x137046){console['log']('error:\x20',_0x137046);throw new common_1[(_0x1eea7b(0x6c))]('放大单张图片请求失败...',common_1['HttpStatus']['BAD_REQUEST']);}}async[_0xfc6b5b(0xbc)](_0x2e933a,_0x22241a){const _0x334362=_0xfc6b5b,{message_id:_0x46e95f,custom_id:_0x2f4db9,prompt:_0x5dfc3d,orderId:_0x5c8799}=_0x2e933a;let _0x318c42=null,_0xb72bb2=0x0;while(!_0x318c42&&_0xb72bb2<0xa){try{const _0x215a27=Date[_0x334362(0x107)](),_0x1eaf98=await this[_0x334362(0x75)]();console[_0x334362(0xea)]('第\x20'+(_0xb72bb2+0x1)+_0x334362(0x9f)+_0x1eaf98[_0x334362(0x7f)]);_0x1eaf98&&_0x1eaf98[_0x334362(0x7f)]&&(_0x318c42=await this['findCurrentEnlargeImgResult'](_0x1eaf98,_0x2e933a,_0x22241a));const _0x25476e=Date[_0x334362(0x107)]()-_0x215a27,_0x25d292=0xbb8;await this[_0x334362(0x66)](Math['max'](_0x25d292-_0x25476e,0x0)),_0xb72bb2++;}catch(_0x2e1dae){console[_0x334362(0xb4)](_0x334362(0x7e)+_0x2e1dae['message']);}}return _0x318c42;}async['pollForVariationResult'](_0x3060d5,_0xd98221){const _0x79538f=_0xfc6b5b,{message_id:_0x718c1e,custom_id:_0x306d0f,prompt:_0x39d496,orderId:_0x498da4}=_0x3060d5;console[_0x79538f(0xea)](_0x79538f(0xca));let _0x597a43=null,_0x4384a4=0x0;while(!_0x597a43&&_0x4384a4<0xa){try{console[_0x79538f(0xea)]('第\x20'+(_0x4384a4+0x1)+_0x79538f(0x6f));const _0x1b0029=Date[_0x79538f(0x107)](),_0x5eef69=await this[_0x79538f(0x75)]();_0x5eef69&&_0x5eef69['length']&&(_0x597a43=await this[_0x79538f(0x68)](_0x5eef69,_0x3060d5,_0xd98221));const _0x3151be=Date[_0x79538f(0x107)]()-_0x1b0029,_0x11fc63=0x1f40;await this['sleep'](Math[_0x79538f(0x89)](_0x11fc63-_0x3151be,0x0)),_0x4384a4++;}catch(_0x4dad21){console[_0x79538f(0xb4)](_0x79538f(0x7e)+_0x4dad21['message']);}}if(!_0x597a43)throw new common_1[(_0x79538f(0x6c))]('变换当前图片超时！',common_1[_0x79538f(0x106)][_0x79538f(0x115)]);return _0x597a43;}async[_0xfc6b5b(0x8e)](_0x897aa9,_0x2efd25,_0x288cd9){const _0xa70248=_0xfc6b5b,{message_id:_0x2be23c,custom_id:_0x1b3705,prompt:_0x5b4224,orderId:_0x318ccd}=_0x2efd25,_0x4e0118=_0x5b4224[_0xa70248(0x98)](0x0,0xc);console[_0xa70248(0xea)](_0xa70248(0xc8),_0x4e0118);const _0x46db52=_0x897aa9[_0xa70248(0x10c)](_0x381ae2=>{const _0xf65f65=_0xa70248,{content:_0x54e4d6}=_0x381ae2;if(!this['extractContent'](_0x54e4d6))return![];const {prompt:_0x142885,order:_0x20bd5a}=this[_0xf65f65(0xf7)](_0x54e4d6);return _0x142885[_0xf65f65(0x9e)](_0x4e0118)&&_0x2efd25[_0xf65f65(0xe6)]===_0x20bd5a&&!_0x288cd9[_0xf65f65(0x9e)](_0x381ae2['id']);});return _0x46db52;}async[_0xfc6b5b(0x68)](_0xcaed46,_0x31410d,_0x3436b7){const _0x56b902=_0xfc6b5b,{message_id:_0x1f4685,custom_id:_0x42d4fe,prompt:_0xea2b4d,orderId:_0x331de2}=_0x31410d,_0x105f52=_0xea2b4d[_0x56b902(0x98)](0x0,0xc),_0x1ad47d=_0xcaed46[_0x56b902(0x10c)](_0x10be0d=>{const _0x56cb75=_0x56b902,{content:_0x2f1754}=_0x10be0d,_0x169eb2=_0x2f1754[_0x56cb75(0x88)](/\*\*(.+?)\*\*/),_0x13090a=_0x169eb2?_0x169eb2[0x1]:'';if(!_0x13090a)return![];return _0x13090a['includes'](_0x105f52)&&!_0x3436b7[_0x56cb75(0x9e)](_0x10be0d['id']);});return _0x1ad47d;}async[_0xfc6b5b(0xfc)](_0x581996,_0x5d4c4a,_0x3d6fc8){const _0x20db43=_0xfc6b5b,_0x3f5681=await this[_0x20db43(0x75)](),_0x442458=await this[_0x20db43(0xd2)](_0x3f5681,_0x3d6fc8,_0x5d4c4a);if(_0x442458)return console[_0x20db43(0xea)](_0x20db43(0x6e),_0x442458),_0x442458;const {application_id:_0x2466af,guild_id:_0x3a6ed7,channel_id:_0x236b3e,session_id:_0x43c5c3,version:_0x2b5096,id:_0x8c23db,authorization:_0x34467f,mjProxy:_0x563f9f}=await this[_0x20db43(0xeb)](),_0x31604={'type':0x2,'application_id':_0x2466af,'guild_id':_0x3a6ed7,'channel_id':_0x236b3e,'session_id':_0x43c5c3,'data':{'version':_0x2b5096,'id':_0x8c23db,'name':_0x20db43(0x103),'type':0x1,'options':[{'type':0x3,'name':_0x20db43(0x7c),'value':_0x581996}],'attachments':[]}};try{const _0x148719=_0x563f9f==0x1?_0x20db43(0xfd):_0x20db43(0xd0),_0x52383d={'authorization':_0x34467f},_0x36c54b=await axios_1[_0x20db43(0xfe)][_0x20db43(0x83)](_0x148719,_0x31604,{'headers':_0x52383d});return console[_0x20db43(0xea)](_0x20db43(0xdc),_0x36c54b['data']),![];}catch(_0x5def81){console[_0x20db43(0xea)](_0x20db43(0xf5),_0x5def81);throw new common_1[(_0x20db43(0x6c))](_0x20db43(0x104),common_1['HttpStatus'][_0x20db43(0x115)]);}}async['pollForResult'](_0x114b89,_0x2e5f3a,_0x298dde){const _0x35735e=_0xfc6b5b;console[_0x35735e(0xea)](_0x35735e(0xb3));const _0x3615db=Date[_0x35735e(0x107)]();try{const _0x4f448b=0xd,_0x5ad427=0x2ee0,_0x403c59=0x1388,_0x434533=0x3c*0x3e8;let _0x31aca8=0x0,_0x566c7f=![],_0x520d96=null;while(!_0x520d96&&_0x31aca8<_0x4f448b){console['log']('第\x20'+(_0x31aca8+0x1)+_0x35735e(0xa6));Date[_0x35735e(0x107)]()-_0x3615db>=_0x434533&&(_0x566c7f=!![]);await this[_0x35735e(0x66)](_0x566c7f?_0x403c59:_0x5ad427);const _0x43d390=await this[_0x35735e(0x75)]();_0x520d96=await this[_0x35735e(0xd2)](_0x43d390,_0x298dde,_0x2e5f3a),_0x31aca8++;}if(!_0x520d96)throw new common_1[(_0x35735e(0x6c))](_0x35735e(0xe4),common_1[_0x35735e(0x106)][_0x35735e(0x115)]);const _0x5eaf32=Date[_0x35735e(0x107)]();return console[_0x35735e(0xea)](_0x35735e(0x6a)+Math[_0x35735e(0xd3)]((_0x5eaf32-_0x3615db)/0x3e8)+'\x20S'),_0x520d96;}catch(_0x4915f7){console[_0x35735e(0xb4)](_0x4915f7['message']);throw new common_1['HttpException'](_0x35735e(0xab),common_1[_0x35735e(0x106)][_0x35735e(0x9a)]);}}async[_0xfc6b5b(0xd2)](_0x584486,_0x3c6b2f,_0x328d88){const _0x5ec955=_0xfc6b5b;if(!_0x584486||!_0x584486['length'])return;console['log'](_0x5ec955(0x10a),_0x3c6b2f);const _0x53528c=_0x584486[_0x5ec955(0x10c)](_0xf89bed=>{const _0x26437b=_0x5ec955,{attachments:attachments=[],content:_0x478ed5,edited_timestamp:_0x1c29f0}=_0xf89bed;return _0x478ed5[_0x26437b(0x9e)](_0x3c6b2f)&&attachments[_0x26437b(0x7f)]>0x0&&!_0x1c29f0&&!_0x328d88['includes'](_0xf89bed['id']);});return _0x53528c||null;}async[_0xfc6b5b(0x75)](){const _0x2e98b5=_0xfc6b5b;try{const {application_id:_0x5d6f74,guild_id:_0x34343a,channel_id:_0xf01d2a,session_id:_0x1e8a7e,version:_0x4b606b,id:_0x1efe5e,authorization:_0x3a56a3,mjProxy:_0x2d743a}=await this[_0x2e98b5(0xeb)](),_0x450d0e=_0x2d743a==0x1?'http://172.247.48.137:8000/mj/list?channel_id='+_0xf01d2a:_0x2e98b5(0xbe)+_0xf01d2a+'/messages?limit=50',_0x30d9b1={'authorization':_0x3a56a3},_0x34557a=await axios_1['default']['get'](_0x450d0e,{'headers':_0x30d9b1});return _0x34557a[_0x2e98b5(0x7a)];}catch(_0x2ffd4e){console[_0x2e98b5(0xea)](_0x2e98b5(0x81),_0x2ffd4e);throw new common_1[(_0x2e98b5(0x6c))](_0x2e98b5(0x67),common_1[_0x2e98b5(0x106)][_0x2e98b5(0x115)]);}}async[_0xfc6b5b(0x66)](_0x4d4b9b){return new Promise(_0x50f6a4=>setTimeout(_0x50f6a4,_0x4d4b9b));}[_0xfc6b5b(0xf7)](_0x1d6717){const _0x413ff9=_0xfc6b5b,_0x5e37ab=_0x1d6717[_0x413ff9(0x88)](/\*\*(.+?)\*\*/),_0x50aa21=_0x1d6717[_0x413ff9(0x88)](/- Image #(\d+)/);if(!_0x5e37ab||!_0x50aa21)return null;const _0x19d63e=_0x5e37ab[0x1],_0x2a557e=parseInt(_0x50aa21[0x1]);return{'prompt':_0x19d63e,'order':_0x2a557e};}async[_0xfc6b5b(0xeb)](){const _0x121f5b=_0xfc6b5b,_0x5c9d5d=await this[_0x121f5b(0xaa)]['getConfigs'](['mjId',_0x121f5b(0xb5),'mjGuildId',_0x121f5b(0xf1),'mjSessionId',_0x121f5b(0xc6),_0x121f5b(0xf6),_0x121f5b(0xdb),_0x121f5b(0xd5)]),_0xc89319={'application_id':_0x5c9d5d['mjApplicationId'],'guild_id':_0x5c9d5d['mjGuildId'],'channel_id':_0x5c9d5d[_0x121f5b(0xf1)],'session_id':_0x5c9d5d[_0x121f5b(0x7b)],'version':_0x5c9d5d[_0x121f5b(0xc6)],'id':_0x5c9d5d[_0x121f5b(0xa4)],'authorization':_0x5c9d5d[_0x121f5b(0xf6)],'mjRateLimit':_0x5c9d5d['mjRateLimit'],'mjProxy':_0x5c9d5d[_0x121f5b(0xd5)]||0x0};return _0xc89319;}[_0xfc6b5b(0x87)](_0x2b2243){const _0x19ba87=_0xfc6b5b,_0x3f286c=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x2b2243[_0x19ba87(0xcf)](_0x3f286c,'');}async[_0xfc6b5b(0x8a)](_0xb54623){const _0xf1b3e2=_0xfc6b5b,_0x10cd8c=await this['balanceEntity']['findOne']({'where':{'userId':_0xb54623[_0xf1b3e2(0xc1)]['id']}}),{id:_0x13e716,balance:_0x50a1e3}=_0x10cd8c;if(!_0x50a1e3||(_0x10cd8c===null||_0x10cd8c===void 0x0?void 0x0:_0x10cd8c['balance'])<0x1)throw new common_1[(_0xf1b3e2(0x6c))]('您当前暂无MJ绘画余额！！！',common_1[_0xf1b3e2(0x106)][_0xf1b3e2(0x115)]);}async[_0xfc6b5b(0xfb)](_0x5107ee){const _0x297f8d=_0xfc6b5b,{id:_0x36d24a,role:_0x21aab5}=_0x5107ee[_0x297f8d(0xc1)];!this[_0x297f8d(0xe8)][_0x36d24a]?this[_0x297f8d(0xe8)][_0x36d24a]=0x1:this[_0x297f8d(0xe8)][_0x36d24a]=this[_0x297f8d(0xe8)][_0x36d24a]+0x1,console[_0x297f8d(0xea)](_0x297f8d(0x9c)+_0x36d24a+_0x297f8d(0xf9),this[_0x297f8d(0xe8)][_0x36d24a]);}async['checkRateLimit'](_0x1cd254){const _0x18d758=_0xfc6b5b,{id:_0x3e6731,role:_0x43593f}=_0x1cd254[_0x18d758(0xc1)];if([_0x18d758(0x100),_0x18d758(0xc7)]['includes'](_0x43593f))return!![];const {mjRateLimit:_0x4112be}=await this[_0x18d758(0xeb)]();if(this[_0x18d758(0xcd)][_0x3e6731]){const _0x2abe8e=this['rateLimits'][_0x3e6731];if(_0x2abe8e>Date[_0x18d758(0x107)]()){console[_0x18d758(0xea)](_0x18d758(0xad)+_0x3e6731+'\x20请求过于频繁！');throw new common_1['HttpException'](_0x18d758(0xa1)+_0x4112be+_0x18d758(0xba),common_1[_0x18d758(0x106)][_0x18d758(0x115)]);}else this['rateLimits'][_0x3e6731]=Date['now']()+Number(_0x4112be)*0x3e8;}else{const _0x29bad3=Date['now']();this[_0x18d758(0xcd)][_0x3e6731]=_0x29bad3+0x3e8*Number(_0x4112be);}}async[_0xfc6b5b(0xa5)](_0x20c161){const _0x1a929f=_0xfc6b5b;await this[_0x1a929f(0xde)][_0x1a929f(0xe2)]()[_0x1a929f(0x10b)](balance_entity_1[_0x1a929f(0xd7)])['set']({'balance':()=>_0x1a929f(0x102)})[_0x1a929f(0xac)](_0x1a929f(0x6b),{'userId':_0x20c161[_0x1a929f(0xc1)]['id']})['execute']();}async[_0xfc6b5b(0x108)](){return 0x1;}};function _0x4835(){const _0x40c347=['uploadService','历史这些id已经被获取过了\x20不能拿了:\x20','decorate','Not','substring','checkBadWords','INTERNAL_SERVER_ERROR','\x20队列+1:\x20','当前用户','getConfigs','includes','\x20次开始查询\x20=>\x20当前查询结果：','../chatLog/chatLog.service','由于速率限制、当前普通用户限制为','18AdcpTD','1QPpQtn','mjId','deductBalance','\x20次开始查询','5262WYiPda','650612nlODWx','drawWorking','globalConfigService','网络连接失败，请稍后再试！','where','当前用户\x20','baiduFanyiSecret','开始请求变换图片\x20队列+1:\x20','response','variationSingleImg','object','开始查询绘画结果轮询','error','mjApplicationId','绘制图片任务结束\x20队列-1:\x20','当前图片没有绘画信息、无法放大!','parse','enlarge','秒请求一次、请合理使用！','绘画失败','pollForUpscaleResult','filter','https://discord.com/api/v9/channels/','3146103oQJbjZ','PAINT_TYPE','user','push','design:paramtypes','InjectRepository','./../globalConfig/globalConfig.service','mjVersion','super','本次放大图片的id:\x20','../../common/utils','开始轮询单张变换图片结果','放大图片任务异常中断\x20队列-1:\x20','3234qTslnE','rateLimits','存入图片完成:\x20','replace','https://discord.com/api/v9/interactions','24uOTmZh','findCurrentPromptResult','floor','IsNull','mjProxy','pollForResult','BalanceEntity','发送放大指令成功','chatLogEntity','Like','mjRateLimit','发送绘画指令结果:\x20','40204068DxchZu','balanceEntity','FanyiService','当前提示词已经在任务队列中了、请勿重复提交。。。','1297002kHQncd','createQueryBuilder','message_id','绘画超时，请稍后再试！','Repository','orderId','fanyiService','freeQueueUsers','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','log','getMjDefaultParams','DeductionKey','draw','uploadFileFromUrl','components','../fanyi/fanyi.service','mjChannelId','../chatLog/chatLog.entity','mjservice','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','axios:\x20','mjAuthorization','extractContent','历史中存在当前图片、直接获取！','使用的次数：','metadata','checkFree','sendDrawInteractions','http://172.247.48.137:8000/mj/draw','default','badwordsService','admin','prompt\x20-------->\x20\x20','balance\x20-\x201','imagine','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','getClientIp','HttpStatus','now','test','enlargeWorking','本次比对的随机ID:\x20','update','find','getOwnPropertyDescriptor','mjNotSaveImg','__esModule','变换图片任务结束\x20队列-1:\x20','function','convertToEnglish','开始请求放大图片\x20队列+1:\x20','findOne','BAD_REQUEST','chatLogService','mjDraw','sleep','查询绘制结果失败...','findCurrentVariationImgResult','sendSmInteractions','本次绘图耗时:\x20','userId\x20=\x20:userId','HttpException','当前图片已经放大过了、请勿重复放大!','有历史信息之间返回:\x20','\x20次开始查询[变换图片]','upscaleSingleImg','url','24880KFmPYQ','放大图片任务结束\x20队列-1:\x20','绘图指令完成','queryMessageList','queueCount','map','../badwords/badwords.service','绘制图片任务异常中断\x20队列-1:\x20','data','mjSessionId','prompt','367018aRjzVY','查询期间出现错误：','length','@nestjs/common','axios\x20get:\x20','5515RuZbwh','post','MjService','BadwordsService','stringify','removeEmoji','match','max','checkAuth','ChatLogService','历史记录中不存在当前图片、请确认您放大的图片是否存在','__param','findCurrentEnlargeImgResult','checkRateLimit','error:\x20','randomId:\x20','放大当前图片失败','saveChatLog'];_0x4835=function(){return _0x40c347;};return _0x4835();}MjService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0xfc6b5b(0xc4)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(balance_entity_1[_0xfc6b5b(0xd7)])),__metadata(_0xfc6b5b(0xc3),[typeorm_1['Repository'],typeorm_1[_0xfc6b5b(0xe5)],upload_service_1['UploadService'],chatLog_service_1[_0xfc6b5b(0x8b)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0xfc6b5b(0xdf)],badwords_service_1[_0xfc6b5b(0x85)]])],MjService),exports['MjService']=MjService;