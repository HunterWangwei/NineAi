'use strict';function _0x30e4(_0x242bc0,_0x54e380){const _0x5caff2=_0x5caf();return _0x30e4=function(_0x30e4a8,_0x572eb7){_0x30e4a8=_0x30e4a8-0x71;let _0x2d0e66=_0x5caff2[_0x30e4a8];return _0x2d0e66;},_0x30e4(_0x242bc0,_0x54e380);}function _0x5caf(){const _0x3ead6b=['绘制图片任务结束\x20队列-1:\x20','getConfigs','39TZiFzR','本次比对的随机ID:\x20','您当前暂无MJ绘画余额！！！','mjApplicationId','checkAuth','metadata','uploadFileFromUrl','存入图片完成:\x20','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','badwordsService','match','http://172.247.48.137:8000/mj/draw','log','drawWorking','where','response','max','54pgYLCg','length','https://discord.com/api/v9/interactions','有历史信息之间返回:\x20','get','InjectRepository','BalanceEntity','__esModule','__metadata','update','mjChannelId','开始轮询单张变换图片结果','error:\x20','queueCount','createRandomUid','axios\x20get:\x20','MjService','__decorate','sendSmInteractions','当前用户\x20','uploadService','freeQueueUsers','../fanyi/fanyi.service','randomId:\x20','defineProperty','balanceEntity','prompt\x20-------->\x20\x20','放大图片任务结束\x20队列-1:\x20','http://172.247.48.137:8000/mj/list?channel_id=','chatLogEntity','放大当前图片失败','当前用户','pollForUpscaleResult','chatLogService','balance\x20-\x201','../chatLog/chatLog.service','findOne','576220iKKEjh','Like','floor','checkBadWords','\x20次开始查询','开始请求用户','mjDraw','replace','350088DYCbCl','url','mjSessionId','BAD_REQUEST','imagine','/messages?limit=50','变换当前图片超时！','test','发送放大指令成功','历史中存在当前图片、直接获取！','开始请求变换图片\x20队列+1:\x20','queryMessageList','data','message_id','admin','pollForResult','function','IsNull','mjGuildId','saveChatLog','findCurrentVariationImgResult','components','11yfEyQA','axios','baiduFanyiAppId','33NIFovw','放大custom_id:\x20','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','super','execute','now','sleep','parse','sendDrawInteractions','Repository','checkFree','mjProxy','本次绘图耗时:\x20','mjAuthorization','user','网络连接失败，请稍后再试！','message','prompt','5Ntsohh','mjNotSaveImg','发送绘画指令结果:\x20','变换图片任务结束\x20队列-1:\x20','759956EUniTw','由于速率限制、当前普通用户限制为','error','fanyiService','194787FRBIhj','extractContent','enlarge','开始请求放大图片\x20队列+1:\x20','秒请求一次、请合理使用！','orderId','userId\x20=\x20:userId','当前图片没有绘画信息、无法变体!','../chatLog/chatLog.entity','../../common/constants/balance.constant','19691kbzppG','removeEmoji','834vpjBjN','object','绘画超时，请稍后再试！','96cQjPzy','HttpStatus','map','开始查询绘画结果轮询','@nestjs/typeorm','绘制图片任务异常中断\x20队列-1:\x20','ChatLogEntity','rateLimits','getMjDefaultParams','PAINT_TYPE','checkRateLimit','../userBalance/balance.entity','DeductionKey','findCurrentEnlargeImgResult','HttpException','\x20次开始查询\x20=>\x20当前查询结果：','stringify','./../globalConfig/globalConfig.service','includes','\x20次开始查询[变换图片]','convertToEnglish','放大图片任务异常中断\x20队列-1:\x20','绘画任务开始','push','当前图片没有绘画信息、无法放大!','mjRateLimit','decorate','deductBalance','post','变化图片任务异常中断\x20队列-1:\x20','globalConfigService','本次放大图片的id:\x20','FanyiService','variationSingleImg','findCurrentPromptResult','filter','@nestjs/common','ChatLogService','getOwnPropertyDescriptor','UploadService','变换当前图片失败','\x20队列+1:\x20','baiduFanyiSecret','Not','mjVersion','find','mjId','https://discord.com/api/v9/channels/','default','查询期间出现错误：','INTERNAL_SERVER_ERROR','1527468tdKElp','Injectable','substring','绘画失败'];_0x5caf=function(){return _0x3ead6b;};return _0x5caf();}const _0x1e2d87=_0x30e4;(function(_0x7de460,_0x5a5391){const _0x546ac2=_0x30e4,_0x3e77d7=_0x7de460();while(!![]){try{const _0x559ff1=-parseInt(_0x546ac2(0x11e))/0x1*(parseInt(_0x546ac2(0x91))/0x2)+-parseInt(_0x546ac2(0x82))/0x3+-parseInt(_0x546ac2(0x7e))/0x4*(-parseInt(_0x546ac2(0x7a))/0x5)+-parseInt(_0x546ac2(0x8e))/0x6*(parseInt(_0x546ac2(0x8c))/0x7)+parseInt(_0x546ac2(0x108))/0x8*(parseInt(_0x546ac2(0xdb))/0x9)+parseInt(_0x546ac2(0x100))/0xa*(-parseInt(_0x546ac2(0x121))/0xb)+parseInt(_0x546ac2(0xc4))/0xc*(parseInt(_0x546ac2(0xca))/0xd);if(_0x559ff1===_0x5a5391)break;else _0x3e77d7['push'](_0x3e77d7['shift']());}catch(_0x227dc0){_0x3e77d7['push'](_0x3e77d7['shift']());}}}(_0x5caf,0x32124));var __decorate=this&&this[_0x1e2d87(0xec)]||function(_0x1521ab,_0x1f858b,_0xa9cb6a,_0x182d0b){const _0x58e50b=_0x1e2d87;var _0x5eab51=arguments['length'],_0x595d30=_0x5eab51<0x3?_0x1f858b:_0x182d0b===null?_0x182d0b=Object[_0x58e50b(0xb7)](_0x1f858b,_0xa9cb6a):_0x182d0b,_0x1ea896;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x58e50b(0x118))_0x595d30=Reflect[_0x58e50b(0xab)](_0x1521ab,_0x1f858b,_0xa9cb6a,_0x182d0b);else{for(var _0x26f7e6=_0x1521ab[_0x58e50b(0xdc)]-0x1;_0x26f7e6>=0x0;_0x26f7e6--)if(_0x1ea896=_0x1521ab[_0x26f7e6])_0x595d30=(_0x5eab51<0x3?_0x1ea896(_0x595d30):_0x5eab51>0x3?_0x1ea896(_0x1f858b,_0xa9cb6a,_0x595d30):_0x1ea896(_0x1f858b,_0xa9cb6a))||_0x595d30;}return _0x5eab51>0x3&&_0x595d30&&Object[_0x58e50b(0xf3)](_0x1f858b,_0xa9cb6a,_0x595d30),_0x595d30;},__metadata=this&&this[_0x1e2d87(0xe3)]||function(_0x90c07a,_0x321616){const _0x2edbf8=_0x1e2d87;if(typeof Reflect===_0x2edbf8(0x8f)&&typeof Reflect[_0x2edbf8(0xcf)]===_0x2edbf8(0x118))return Reflect['metadata'](_0x90c07a,_0x321616);},__param=this&&this['__param']||function(_0x3ecd4b,_0xfe49a4){return function(_0x5ed711,_0x34e510){_0xfe49a4(_0x5ed711,_0x34e510,_0x3ecd4b);};};Object[_0x1e2d87(0xf3)](exports,_0x1e2d87(0xe2),{'value':!![]}),exports[_0x1e2d87(0xeb)]=void 0x0;const globalConfig_service_1=require(_0x1e2d87(0xa2)),upload_service_1=require('./../upload/upload.service'),common_1=require(_0x1e2d87(0xb5)),axios_1=require(_0x1e2d87(0x11f)),chatLog_service_1=require(_0x1e2d87(0xfe)),balance_constant_1=require(_0x1e2d87(0x8b)),utils_1=require('../../common/utils'),chatLog_entity_1=require(_0x1e2d87(0x8a)),typeorm_1=require('typeorm'),typeorm_2=require(_0x1e2d87(0x95)),balance_entity_1=require(_0x1e2d87(0x9c)),fanyi_service_1=require(_0x1e2d87(0xf1)),badwords_service_1=require('../badwords/badwords.service');let MjService=class MjService{constructor(_0x346656,_0x5fed0b,_0x228eb6,_0x4d6864,_0x25b8f4,_0x277197,_0x33f265){const _0x473328=_0x1e2d87;this[_0x473328(0xf8)]=_0x346656,this[_0x473328(0xf4)]=_0x5fed0b,this[_0x473328(0xef)]=_0x228eb6,this['chatLogService']=_0x4d6864,this['globalConfigService']=_0x25b8f4,this['fanyiService']=_0x277197,this['badwordsService']=_0x33f265,this['rateLimits']={},this[_0x473328(0xd7)]=[],this['enlargeWorking']=[],this[_0x473328(0xe8)]=0x0,this['freeQueueUsers']={};}async[_0x1e2d87(0x106)](_0x47a043){const _0x5586e1=_0x1e2d87,{jobId:_0x25f0b7,prompt:_0x87de37,startTime:_0x2a3758,userId:_0x2c272e}=_0x47a043;return console[_0x5586e1(0xd6)](_0x5586e1(0xa7),'mjservice'),await new Promise(_0x4eb5dc=>setTimeout(_0x4eb5dc,0x1388)),{'a':0x1,'b':0x2};}async['draw'](_0x2b9b5c,_0x2b5033){const _0x485e62=_0x1e2d87;await this[_0x485e62(0xce)](_0x2b5033),await this[_0x485e62(0xd3)][_0x485e62(0x103)](_0x2b9b5c[_0x485e62(0x79)],_0x2b5033['user']['id']);const _0x5d9c6c=_0x2b9b5c['prompt'];let _0x24e65f=_0x2b9b5c[_0x485e62(0x79)];const {baiduFanyiAppId:_0x3b317b,baiduFanyiSecret:_0x281131}=await this[_0x485e62(0xaf)][_0x485e62(0xc9)]([_0x485e62(0x120),_0x485e62(0xbb)]);_0x3b317b&&_0x281131&&(_0x24e65f=await this[_0x485e62(0x81)][_0x485e62(0xa5)](_0x5d9c6c));const _0x58079a='['+(0x0,utils_1[_0x485e62(0xe9)])()+']',_0x2b0c60=_0x58079a+'\x20'+_0x24e65f;console[_0x485e62(0xd6)](_0x485e62(0xf2),_0x58079a),console[_0x485e62(0xd6)](_0x485e62(0xf5),_0x2b0c60);const _0x49e723=this[_0x485e62(0xd7)]['find'](_0x15b40e=>_0x15b40e[_0x485e62(0xa3)](_0x2b9b5c['prompt']));if(_0x49e723)throw new common_1['HttpException']('当前提示词已经在任务队列中了、请勿重复提交。。。',common_1[_0x485e62(0x92)][_0x485e62(0x10b)]);if(this[_0x485e62(0xe8)]>=0x3)throw new common_1[(_0x485e62(0x9f))](_0x485e62(0xd2),common_1['HttpStatus'][_0x485e62(0x10b)]);await this[_0x485e62(0x9b)](_0x2b5033),this['queueCount']++,console['log'](_0x485e62(0x105)+_0x2b5033[_0x485e62(0x76)]['id']+_0x485e62(0xba),this[_0x485e62(0xe8)]);try{const _0x3eb8d3=await this[_0x485e62(0xf8)][_0x485e62(0xbe)]({'where':{'prompt':(0x0,typeorm_1[_0x485e62(0x101)])('%'+_0x2b0c60+'%')}}),_0x3144c6=_0x3eb8d3['map'](_0xd847d3=>_0xd847d3[_0x485e62(0x115)]);this['drawWorking'][_0x485e62(0xa8)](_0x2b0c60);let _0x2cb557;const _0x2b7fd1=await this['sendDrawInteractions'](_0x2b0c60,_0x3144c6,_0x58079a);_0x2b7fd1?(console[_0x485e62(0xd6)](_0x485e62(0x111)),_0x2cb557=_0x2b7fd1):_0x2cb557=await this['pollForResult'](_0x2b0c60,_0x3144c6,_0x58079a);this['queueCount']--,this[_0x485e62(0xe8)]<0x0&&(this[_0x485e62(0xe8)]=0x0),console[_0x485e62(0xd6)](_0x485e62(0xc8),this[_0x485e62(0xe8)]);const {id:_0x4e21bf,content:_0x390368,channel_id:_0x3033cd,attachments:attachments=[],timestamp:_0x1e3889}=_0x2cb557;if(!attachments[_0x485e62(0xdc)]||!attachments[0x0][_0x485e62(0x109)])throw new common_1[(_0x485e62(0x9f))](_0x485e62(0xc7),common_1['HttpStatus'][_0x485e62(0x10b)]);const {filename:_0xb9d608,url:_0xad7e5a,width:_0x24390c,height:_0x3630df,size:_0x5bdfee}=attachments[0x0],_0x1d309e=this[_0x485e62(0xaf)]['getConfigs']([_0x485e62(0x7b)]);let _0x46e74f='';(!Number(_0x1d309e)||Number(_0x1d309e)===0x0)&&(_0x46e74f=await this[_0x485e62(0xef)][_0x485e62(0xd0)]({'filename':_0xb9d608,'url':_0xad7e5a}),console[_0x485e62(0xd6)](_0x485e62(0xd1),_0x46e74f));const _0x37e40c={'curIp':(0x0,utils_1['getClientIp'])(_0x2b5033),'userId':_0x2b5033[_0x485e62(0x76)]['id'],'type':balance_constant_1[_0x485e62(0x9d)][_0x485e62(0x9a)],'prompt':_0x2b0c60,'answer':_0x46e74f,'model':'mj','extend':this[_0x485e62(0x8d)](JSON[_0x485e62(0xa1)](_0x2cb557)),'message_id':_0x4e21bf,'variationId':_0x4e21bf,'upscaleId':_0x4e21bf,'group':0x1,'isSaveImg':!Number(_0x1d309e)||Number(_0x1d309e)===0x0,'fileInfo':JSON[_0x485e62(0xa1)]({'width':_0x24390c,'height':_0x3630df,'size':_0x5bdfee,'filename':_0xb9d608,'cosUrl':_0x46e74f})};return await this[_0x485e62(0xfc)][_0x485e62(0x11b)](_0x37e40c),await this[_0x485e62(0xac)](_0x2b5033),this[_0x485e62(0xd7)]=this[_0x485e62(0xd7)][_0x485e62(0xb4)](_0x4b35bc=>_0x4b35bc!==_0x2b9b5c[_0x485e62(0x79)]),_0x46e74f;}catch(_0x14a4c8){this[_0x485e62(0xe8)]--,this[_0x485e62(0xe8)]<0x0&&(this['queueCount']=0x0),console[_0x485e62(0xd6)](_0x485e62(0x96),this[_0x485e62(0xe8)]),this[_0x485e62(0xd7)]=this[_0x485e62(0xd7)][_0x485e62(0xb4)](_0x5cdf11=>_0x5cdf11!==_0x2b9b5c[_0x485e62(0x79)]);throw new common_1[(_0x485e62(0x9f))](_0x14a4c8['response'],common_1[_0x485e62(0x92)][_0x485e62(0x10b)]);}}async['upscaleSingleImg'](_0x13646a,_0x1a4cf6){const _0x5defc2=_0x1e2d87;if(this[_0x5defc2(0xe8)]>=0x3)throw new common_1[(_0x5defc2(0x9f))](_0x5defc2(0xd2),common_1[_0x5defc2(0x92)][_0x5defc2(0x10b)]);this['queueCount']++,console[_0x5defc2(0xd6)]('用户'+_0x1a4cf6['user']['id']+_0x5defc2(0x85),this[_0x5defc2(0xe8)]);const {message_id:_0x43ff97,orderId:_0x401490}=_0x13646a;try{const _0x45166e=await this['chatLogEntity'][_0x5defc2(0xff)]({'where':{'message_id':_0x43ff97}});if(!_0x45166e)throw new common_1[(_0x5defc2(0x9f))]('历史记录中不存在当前图片、请确认您放大的图片是否存在',common_1[_0x5defc2(0x92)]['BAD_REQUEST']);const _0x200ea1=await this[_0x5defc2(0xf8)][_0x5defc2(0xff)]({'where':{'upscaleId':_0x43ff97,'action':'enlarge','orderId':_0x401490}});if(_0x200ea1)throw new common_1['HttpException']('当前图片已经放大过了、请勿重复放大!',common_1[_0x5defc2(0x92)][_0x5defc2(0x10b)]);const {prompt:_0x2d4185,extend:_0x505b80}=_0x45166e;let _0x157945=null;try{_0x157945=JSON[_0x5defc2(0x128)](_0x505b80);}catch(_0x5f19ed){_0x157945=[];}const {components:components=[]}=_0x157945;if(!components['length'])throw new common_1['HttpException'](_0x5defc2(0xa9),common_1[_0x5defc2(0x92)]['BAD_REQUEST']);const _0x9cc972=components[0x0]['components'][_0x401490-0x1],{custom_id:_0x36aa30}=_0x9cc972;console['log'](_0x5defc2(0x122),_0x36aa30);const _0x1d9019={'message_id':_0x43ff97,'custom_id':_0x36aa30,'prompt':_0x2d4185,'orderId':_0x401490};await this[_0x5defc2(0xed)](_0x1d9019),console[_0x5defc2(0xd6)](_0x5defc2(0x110));const _0x266b44=await this[_0x5defc2(0xf8)][_0x5defc2(0xbe)]({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0x2d4185+'%')}}),_0x47e841=_0x266b44[_0x5defc2(0x93)](_0x233817=>_0x233817['message_id']);console[_0x5defc2(0xd6)]('历史这些id已经被获取过了\x20不能拿了:\x20',_0x47e841);const _0x1ba6af=await this[_0x5defc2(0xfb)](_0x1d9019,_0x47e841);this[_0x5defc2(0xe8)]--,this[_0x5defc2(0xe8)]<0x0&&(this[_0x5defc2(0xe8)]=0x0),console[_0x5defc2(0xd6)](_0x5defc2(0xf6),this[_0x5defc2(0xe8)]);const {id:_0x3871b1,content:_0x2d286f,channel_id:_0x41467e,attachments:attachments=[],timestamp:_0x1a9038}=_0x1ba6af;if(!attachments['length']||!attachments[0x0]['url'])throw new common_1[(_0x5defc2(0x9f))](_0x5defc2(0xf9),common_1[_0x5defc2(0x92)][_0x5defc2(0x10b)]);const {filename:_0x1a257b,url:_0x5b2fc2,width:_0x4264a3,height:_0x5da6a9,size:_0x19abd6}=attachments[0x0],_0x25a522=this[_0x5defc2(0xaf)][_0x5defc2(0xc9)]([_0x5defc2(0x7b)]);let _0x39d59a='';(!Number(_0x25a522)||Number(_0x25a522)===0x0)&&(_0x39d59a=await this['uploadService'][_0x5defc2(0xd0)]({'filename':_0x1a257b,'url':_0x5b2fc2}),console[_0x5defc2(0xd6)](_0x5defc2(0xd1),_0x39d59a));const _0x363c85={'curIp':(0x0,utils_1['getClientIp'])(_0x1a4cf6),'userId':_0x1a4cf6[_0x5defc2(0x76)]['id'],'type':balance_constant_1[_0x5defc2(0x9d)][_0x5defc2(0x9a)],'prompt':_0x2d4185,'answer':_0x39d59a,'model':'mj','extend':this['removeEmoji'](JSON[_0x5defc2(0xa1)](_0x1ba6af)),'message_id':_0x43ff97,'upscaleId':_0x3871b1,'variationId':_0x3871b1,'action':_0x5defc2(0x84),'orderId':_0x1d9019['orderId'],'isSaveImg':!Number(_0x25a522)||Number(_0x25a522)===0x0,'fileInfo':JSON['stringify']({'width':_0x4264a3,'height':_0x5da6a9,'size':_0x19abd6,'filename':_0x1a257b,'cosUrl':_0x39d59a})};return await this[_0x5defc2(0xfc)]['saveChatLog'](_0x363c85),_0x39d59a;}catch(_0x1d0e0d){console[_0x5defc2(0xd6)](_0x5defc2(0xe7),_0x1d0e0d),this[_0x5defc2(0xe8)]--,this[_0x5defc2(0xe8)]<0x0&&(this['queueCount']=0x0),console['log'](_0x5defc2(0xa6),this['queueCount']);throw new common_1[(_0x5defc2(0x9f))](_0x1d0e0d[_0x5defc2(0xd9)],common_1[_0x5defc2(0x92)][_0x5defc2(0x10b)]);}}async[_0x1e2d87(0xb2)](_0x181893,_0xb7145d){const _0x5f1294=_0x1e2d87;if(this[_0x5f1294(0xe8)]>=0x3)throw new common_1['HttpException'](_0x5f1294(0xd2),common_1[_0x5f1294(0x92)][_0x5f1294(0x10b)]);await this[_0x5f1294(0xce)](_0xb7145d),await this[_0x5f1294(0x9b)](_0xb7145d),this['queueCount']++,console[_0x5f1294(0xd6)]('用户'+_0xb7145d['user']['id']+_0x5f1294(0x112),this[_0x5f1294(0xe8)]);const {message_id:_0x230fe4,orderId:_0x481358}=_0x181893;try{const _0x1988b3=await this[_0x5f1294(0xf8)][_0x5f1294(0xff)]({'where':{'message_id':_0x230fe4}});if(!_0x1988b3)throw new common_1[(_0x5f1294(0x9f))]('历史记录中不存在当前图片、请确认您需要变换的图片是否存在',common_1[_0x5f1294(0x92)][_0x5f1294(0x10b)]);const {prompt:_0x43b7c5,extend:_0x12dcb8}=_0x1988b3;let _0x4b1f5a=null;try{_0x4b1f5a=JSON[_0x5f1294(0x128)](_0x12dcb8);}catch(_0x258010){_0x4b1f5a=[];}const {components:components=[]}=_0x4b1f5a;if(!components[_0x5f1294(0xdc)])throw new common_1[(_0x5f1294(0x9f))](_0x5f1294(0x89),common_1[_0x5f1294(0x92)][_0x5f1294(0x10b)]);const _0x5dfe11=components[0x1][_0x5f1294(0x11d)][_0x481358-0x1],{custom_id:_0xd90057}=_0x5dfe11,_0x261911=await this['chatLogEntity'][_0x5f1294(0xbe)]({'where':{'variationId':(0x0,typeorm_1[_0x5f1294(0xbc)])((0x0,typeorm_1[_0x5f1294(0x119)])()),'prompt':(0x0,typeorm_1[_0x5f1294(0x101)])('%'+_0x43b7c5+'%')}}),_0x1de763=_0x261911[_0x5f1294(0x93)](_0x4d73e8=>_0x4d73e8['variationId']),_0x19b17e={'message_id':_0x230fe4,'custom_id':_0xd90057,'prompt':_0x43b7c5,'orderId':_0x481358};await this['sendSmInteractions'](_0x19b17e);const _0x1f48a2=await this['pollForVariationResult'](_0x19b17e,_0x1de763);this['queueCount']--,this[_0x5f1294(0xe8)]<0x0&&(this['queueCount']=0x0),console[_0x5f1294(0xd6)](_0x5f1294(0x7d),this[_0x5f1294(0xe8)]);const {id:_0x545af2,content:_0x2a4acf,channel_id:_0x5b2076,attachments:attachments=[],timestamp:_0x3db01a}=_0x1f48a2;if(!attachments[_0x5f1294(0xdc)]||!attachments[0x0][_0x5f1294(0x109)])throw new common_1[(_0x5f1294(0x9f))](_0x5f1294(0xb9),common_1['HttpStatus']['BAD_REQUEST']);const {filename:_0x510297,url:_0x4ba3e4,width:_0x5d44b7,height:_0x1dab4f,size:_0x53287c}=attachments[0x0],_0x596d87=this[_0x5f1294(0xaf)][_0x5f1294(0xc9)]([_0x5f1294(0x7b)]);let _0x41782e='';(!Number(_0x596d87)||Number(_0x596d87)===0x0)&&(_0x41782e=await this[_0x5f1294(0xef)]['uploadFileFromUrl']({'filename':_0x510297,'url':_0x4ba3e4}),console['log'](_0x5f1294(0xd1),_0x41782e));const _0x48583b={'curIp':(0x0,utils_1['getClientIp'])(_0xb7145d),'userId':_0xb7145d['user']['id'],'type':balance_constant_1[_0x5f1294(0x9d)][_0x5f1294(0x9a)],'prompt':_0x43b7c5,'answer':_0x41782e,'model':'mj','group':0x1,'extend':this[_0x5f1294(0x8d)](JSON[_0x5f1294(0xa1)](_0x1f48a2)),'message_id':_0x545af2,'upscaleId':_0x545af2,'variationId':_0x545af2,'action':_0x5f1294(0x84),'orderId':_0x19b17e[_0x5f1294(0x87)],'isSaveImg':!Number(_0x596d87)||Number(_0x596d87)===0x0,'fileInfo':JSON[_0x5f1294(0xa1)]({'width':_0x5d44b7,'height':_0x1dab4f,'size':_0x53287c,'filename':_0x510297,'cosUrl':_0x41782e})};return await this[_0x5f1294(0xfc)][_0x5f1294(0x11b)](_0x48583b),_0x41782e;}catch(_0x31ec3a){console[_0x5f1294(0xd6)](_0x5f1294(0xe7),_0x31ec3a),this[_0x5f1294(0xe8)]--,this[_0x5f1294(0xe8)]<0x0&&(this[_0x5f1294(0xe8)]=0x0),console[_0x5f1294(0xd6)](_0x5f1294(0xae),this[_0x5f1294(0xe8)]);throw new common_1[(_0x5f1294(0x9f))](_0x31ec3a[_0x5f1294(0xd9)],common_1[_0x5f1294(0x92)]['BAD_REQUEST']);}}async[_0x1e2d87(0xed)](_0x1f01e0){const _0x317ae7=_0x1e2d87,{message_id:_0x2fb641,custom_id:_0x158c58}=_0x1f01e0,{application_id:_0x4542fe,guild_id:_0x3d3fcf,channel_id:_0x1e631a,session_id:_0x2bad0a,version:_0x5f29cd,id:_0x3dfee4,authorization:_0x35b1ab,mjProxy:_0x6269bb}=await this['getMjDefaultParams'](),_0x57000e=_0x6269bb==0x1?_0x317ae7(0xd5):_0x317ae7(0xdd),_0x7cc64={'authorization':_0x35b1ab},_0x587d70={'type':0x3,'guild_id':_0x3d3fcf,'channel_id':_0x1e631a,'message_flags':0x0,'message_id':_0x2fb641,'application_id':_0x4542fe,'session_id':_0x2bad0a,'data':{'component_type':0x2,'custom_id':_0x158c58}};try{await axios_1[_0x317ae7(0xc1)][_0x317ae7(0xad)](_0x57000e,_0x587d70,{'headers':_0x7cc64}),console[_0x317ae7(0xd6)]('绘图指令完成');}catch(_0xe59556){console[_0x317ae7(0xd6)](_0x317ae7(0xe7),_0xe59556);throw new common_1['HttpException']('放大单张图片请求失败...',common_1[_0x317ae7(0x92)][_0x317ae7(0x10b)]);}}async[_0x1e2d87(0xfb)](_0x15fb5c,_0x18fe31){const _0x37c923=_0x1e2d87,{message_id:_0x37519f,custom_id:_0x45d94d,prompt:_0x3dbfcf,orderId:_0x147d83}=_0x15fb5c;let _0x19840d=null,_0x2cd93d=0x0;while(!_0x19840d&&_0x2cd93d<0xa){try{const _0x4cdfe8=Date[_0x37c923(0x126)](),_0x43611e=await this[_0x37c923(0x113)]();console['log']('第\x20'+(_0x2cd93d+0x1)+_0x37c923(0xa0)+_0x43611e[_0x37c923(0xdc)]);_0x43611e&&_0x43611e[_0x37c923(0xdc)]&&(_0x19840d=await this[_0x37c923(0x9e)](_0x43611e,_0x15fb5c,_0x18fe31));const _0x1b2e9b=Date[_0x37c923(0x126)]()-_0x4cdfe8,_0x2604aa=0xbb8;await this['sleep'](Math[_0x37c923(0xda)](_0x2604aa-_0x1b2e9b,0x0)),_0x2cd93d++;}catch(_0x4bddb5){console[_0x37c923(0x80)]('查询期间出现错误：'+_0x4bddb5[_0x37c923(0x78)]);}}return _0x19840d;}async['pollForVariationResult'](_0x78e67a,_0x342459){const _0x530628=_0x1e2d87,{message_id:_0xa71f38,custom_id:_0x322993,prompt:_0x457b35,orderId:_0x3044bd}=_0x78e67a;console[_0x530628(0xd6)](_0x530628(0xe6));let _0x3b20c6=null,_0xef2e15=0x0;while(!_0x3b20c6&&_0xef2e15<0xa){try{console[_0x530628(0xd6)]('第\x20'+(_0xef2e15+0x1)+_0x530628(0xa4));const _0x340ebc=Date['now'](),_0x52f4be=await this[_0x530628(0x113)]();_0x52f4be&&_0x52f4be['length']&&(_0x3b20c6=await this[_0x530628(0x11c)](_0x52f4be,_0x78e67a,_0x342459));const _0x46f31e=Date[_0x530628(0x126)]()-_0x340ebc,_0x28fa84=0x1f40;await this[_0x530628(0x127)](Math[_0x530628(0xda)](_0x28fa84-_0x46f31e,0x0)),_0xef2e15++;}catch(_0x4accc3){console[_0x530628(0x80)](_0x530628(0xc2)+_0x4accc3[_0x530628(0x78)]);}}if(!_0x3b20c6)throw new common_1[(_0x530628(0x9f))](_0x530628(0x10e),common_1[_0x530628(0x92)][_0x530628(0x10b)]);return _0x3b20c6;}async[_0x1e2d87(0x9e)](_0x3e19f2,_0x3df795,_0x52eae8){const _0x1e0ece=_0x1e2d87,{message_id:_0x5a381c,custom_id:_0x2e8acc,prompt:_0x418198,orderId:_0x15e2b9}=_0x3df795,_0xccd9f9=_0x418198[_0x1e0ece(0xc6)](0x0,0xc);console[_0x1e0ece(0xd6)](_0x1e0ece(0xb0),_0xccd9f9);const _0x1b20cd=_0x3e19f2[_0x1e0ece(0xbe)](_0x556c56=>{const _0x2b3d5a=_0x1e0ece,{content:_0x24b726}=_0x556c56;if(!this[_0x2b3d5a(0x83)](_0x24b726))return![];const {prompt:_0x5ee608,order:_0x1c1be8}=this['extractContent'](_0x24b726);return _0x5ee608[_0x2b3d5a(0xa3)](_0xccd9f9)&&_0x3df795[_0x2b3d5a(0x87)]===_0x1c1be8&&!_0x52eae8[_0x2b3d5a(0xa3)](_0x556c56['id']);});return _0x1b20cd;}async['findCurrentVariationImgResult'](_0x5bd750,_0x5b2210,_0x39abff){const _0x495e24=_0x1e2d87,{message_id:_0x232215,custom_id:_0x24a5b3,prompt:_0x203a71,orderId:_0x376314}=_0x5b2210,_0x5c9ac1=_0x203a71[_0x495e24(0xc6)](0x0,0xc),_0x262c8c=_0x5bd750[_0x495e24(0xbe)](_0x2a363d=>{const _0x544a8d=_0x495e24,{content:_0x206981}=_0x2a363d,_0xd050d7=_0x206981['match'](/\*\*(.+?)\*\*/),_0x31d6ea=_0xd050d7?_0xd050d7[0x1]:'';if(!_0x31d6ea)return![];return _0x31d6ea['includes'](_0x5c9ac1)&&!_0x39abff[_0x544a8d(0xa3)](_0x2a363d['id']);});return _0x262c8c;}async[_0x1e2d87(0x129)](_0x224acd,_0x338c01,_0x5e19db){const _0x55728c=_0x1e2d87,_0x4939a9=await this[_0x55728c(0x113)](),_0x37a188=await this[_0x55728c(0xb3)](_0x4939a9,_0x5e19db,_0x338c01);if(_0x37a188)return console[_0x55728c(0xd6)](_0x55728c(0xde),_0x37a188),_0x37a188;const {application_id:_0x13c4b1,guild_id:_0x148954,channel_id:_0x197690,session_id:_0x7d863d,version:_0x1680fd,id:_0x295ffe,authorization:_0x1dfa02,mjProxy:_0x5b1c07}=await this['getMjDefaultParams'](),_0x5c6cd7={'type':0x2,'application_id':_0x13c4b1,'guild_id':_0x148954,'channel_id':_0x197690,'session_id':_0x7d863d,'data':{'version':_0x1680fd,'id':_0x295ffe,'name':_0x55728c(0x10c),'type':0x1,'options':[{'type':0x3,'name':_0x55728c(0x79),'value':_0x224acd}],'attachments':[]}};try{const _0x25e127=_0x5b1c07==0x1?_0x55728c(0xd5):_0x55728c(0xdd),_0x363f07={'authorization':_0x1dfa02},_0x118496=await axios_1[_0x55728c(0xc1)][_0x55728c(0xad)](_0x25e127,_0x5c6cd7,{'headers':_0x363f07});return console['log'](_0x55728c(0x7c),_0x118496['data']),![];}catch(_0x8698f4){console[_0x55728c(0xd6)]('axios:\x20',_0x8698f4);throw new common_1[(_0x55728c(0x9f))](_0x55728c(0x123),common_1[_0x55728c(0x92)][_0x55728c(0x10b)]);}}async[_0x1e2d87(0x117)](_0x42cb38,_0x4f533f,_0x265e63){const _0x36c449=_0x1e2d87;console[_0x36c449(0xd6)](_0x36c449(0x94));const _0x16c0ca=Date['now']();try{const _0x182c28=0xd,_0x499b0c=0x2ee0,_0x968e6=0x1388,_0x16a1cc=0x3c*0x3e8;let _0x108a8b=0x0,_0x3c720b=![],_0x22837e=null;while(!_0x22837e&&_0x108a8b<_0x182c28){console['log']('第\x20'+(_0x108a8b+0x1)+_0x36c449(0x104));Date[_0x36c449(0x126)]()-_0x16c0ca>=_0x16a1cc&&(_0x3c720b=!![]);await this['sleep'](_0x3c720b?_0x968e6:_0x499b0c);const _0x48193b=await this[_0x36c449(0x113)]();_0x22837e=await this[_0x36c449(0xb3)](_0x48193b,_0x265e63,_0x4f533f),_0x108a8b++;}if(!_0x22837e)throw new common_1[(_0x36c449(0x9f))](_0x36c449(0x90),common_1[_0x36c449(0x92)][_0x36c449(0x10b)]);const _0x1f0c5b=Date[_0x36c449(0x126)]();return console[_0x36c449(0xd6)](_0x36c449(0x74)+Math[_0x36c449(0x102)]((_0x1f0c5b-_0x16c0ca)/0x3e8)+'\x20S'),_0x22837e;}catch(_0x4596fd){console['error'](_0x4596fd[_0x36c449(0x78)]);throw new common_1[(_0x36c449(0x9f))](_0x36c449(0x77),common_1['HttpStatus'][_0x36c449(0xc3)]);}}async[_0x1e2d87(0xb3)](_0x37ef9e,_0x40e40b,_0x2d4751){const _0x3ed4bf=_0x1e2d87;if(!_0x37ef9e||!_0x37ef9e[_0x3ed4bf(0xdc)])return;console[_0x3ed4bf(0xd6)](_0x3ed4bf(0xcb),_0x40e40b);const _0x23c39d=_0x37ef9e[_0x3ed4bf(0xbe)](_0x45284e=>{const _0x17e773=_0x3ed4bf,{attachments:attachments=[],content:_0x56849e,edited_timestamp:_0x337120}=_0x45284e;return _0x56849e[_0x17e773(0xa3)](_0x40e40b)&&attachments['length']>0x0&&!_0x337120&&!_0x2d4751[_0x17e773(0xa3)](_0x45284e['id']);});return _0x23c39d||null;}async['queryMessageList'](){const _0x180c5c=_0x1e2d87;try{const {application_id:_0x218e4c,guild_id:_0x287b2e,channel_id:_0x827204,session_id:_0x40809e,version:_0x5636db,id:_0x32dd4f,authorization:_0x1379e0,mjProxy:_0x412a4e}=await this['getMjDefaultParams'](),_0x5e2db3=_0x412a4e==0x1?_0x180c5c(0xf7)+_0x827204:_0x180c5c(0xc0)+_0x827204+_0x180c5c(0x10d),_0x161ac4={'authorization':_0x1379e0},_0x5dc196=await axios_1[_0x180c5c(0xc1)][_0x180c5c(0xdf)](_0x5e2db3,{'headers':_0x161ac4});return _0x5dc196[_0x180c5c(0x114)];}catch(_0x269a22){console['log'](_0x180c5c(0xea),_0x269a22);throw new common_1[(_0x180c5c(0x9f))]('查询绘制结果失败...',common_1[_0x180c5c(0x92)]['BAD_REQUEST']);}}async['sleep'](_0x2a2f6a){return new Promise(_0x4d59d3=>setTimeout(_0x4d59d3,_0x2a2f6a));}[_0x1e2d87(0x83)](_0x55e1a1){const _0x424bcf=_0x1e2d87,_0x4a7f9a=_0x55e1a1[_0x424bcf(0xd4)](/\*\*(.+?)\*\*/),_0x338e67=_0x55e1a1[_0x424bcf(0xd4)](/- Image #(\d+)/);if(!_0x4a7f9a||!_0x338e67)return null;const _0x3f163d=_0x4a7f9a[0x1],_0x8fd1ea=parseInt(_0x338e67[0x1]);return{'prompt':_0x3f163d,'order':_0x8fd1ea};}async[_0x1e2d87(0x99)](){const _0x5817a4=_0x1e2d87,_0x246e64=await this[_0x5817a4(0xaf)][_0x5817a4(0xc9)](['mjId',_0x5817a4(0xcd),_0x5817a4(0x11a),'mjChannelId',_0x5817a4(0x10a),_0x5817a4(0xbd),_0x5817a4(0x75),_0x5817a4(0xaa),'mjProxy']),_0x343073={'application_id':_0x246e64[_0x5817a4(0xcd)],'guild_id':_0x246e64['mjGuildId'],'channel_id':_0x246e64[_0x5817a4(0xe5)],'session_id':_0x246e64[_0x5817a4(0x10a)],'version':_0x246e64[_0x5817a4(0xbd)],'id':_0x246e64[_0x5817a4(0xbf)],'authorization':_0x246e64[_0x5817a4(0x75)],'mjRateLimit':_0x246e64['mjRateLimit'],'mjProxy':_0x246e64[_0x5817a4(0x73)]||0x0};return _0x343073;}['removeEmoji'](_0x4d605a){const _0x55da4c=_0x1e2d87,_0x2e61ed=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x4d605a[_0x55da4c(0x107)](_0x2e61ed,'');}async[_0x1e2d87(0xce)](_0x1a266c){const _0x43c84f=_0x1e2d87,_0x1a2d89=await this[_0x43c84f(0xf4)][_0x43c84f(0xff)]({'where':{'userId':_0x1a266c[_0x43c84f(0x76)]['id']}}),{id:_0x317dd6,balance:_0x1ac9ef}=_0x1a2d89;if(!_0x1ac9ef||(_0x1a2d89===null||_0x1a2d89===void 0x0?void 0x0:_0x1a2d89['balance'])<0x1)throw new common_1[(_0x43c84f(0x9f))](_0x43c84f(0xcc),common_1['HttpStatus'][_0x43c84f(0x10b)]);}async[_0x1e2d87(0x72)](_0x3b9474){const _0xebee73=_0x1e2d87,{id:_0x239cc4,role:_0x1d5c95}=_0x3b9474[_0xebee73(0x76)];!this[_0xebee73(0xf0)][_0x239cc4]?this[_0xebee73(0xf0)][_0x239cc4]=0x1:this['freeQueueUsers'][_0x239cc4]=this[_0xebee73(0xf0)][_0x239cc4]+0x1,console[_0xebee73(0xd6)](_0xebee73(0xfa)+_0x239cc4+'使用的次数：',this[_0xebee73(0xf0)][_0x239cc4]);}async['checkRateLimit'](_0x4c10a9){const _0x3734a2=_0x1e2d87,{id:_0x202f2d,role:_0x55fa29}=_0x4c10a9['user'];if([_0x3734a2(0x116),_0x3734a2(0x124)][_0x3734a2(0xa3)](_0x55fa29))return!![];const {mjRateLimit:_0x311b3d}=await this['getMjDefaultParams']();if(this[_0x3734a2(0x98)][_0x202f2d]){const _0x30af6f=this[_0x3734a2(0x98)][_0x202f2d];if(_0x30af6f>Date[_0x3734a2(0x126)]()){console['log'](_0x3734a2(0xee)+_0x202f2d+'\x20请求过于频繁！');throw new common_1[(_0x3734a2(0x9f))](_0x3734a2(0x7f)+_0x311b3d+_0x3734a2(0x86),common_1[_0x3734a2(0x92)]['BAD_REQUEST']);}else this[_0x3734a2(0x98)][_0x202f2d]=Date['now']()+Number(_0x311b3d)*0x3e8;}else{const _0x28f1b6=Date[_0x3734a2(0x126)]();this[_0x3734a2(0x98)][_0x202f2d]=_0x28f1b6+0x3e8*Number(_0x311b3d);}}async[_0x1e2d87(0xac)](_0x2a5f55){const _0x151983=_0x1e2d87;await this['balanceEntity']['createQueryBuilder']()[_0x151983(0xe4)](balance_entity_1[_0x151983(0xe1)])['set']({'balance':()=>_0x151983(0xfd)})[_0x151983(0xd8)](_0x151983(0x88),{'userId':_0x2a5f55['user']['id']})[_0x151983(0x125)]();}async[_0x1e2d87(0x10f)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x1e2d87(0xc5)])(),__param(0x0,(0x0,typeorm_2[_0x1e2d87(0xe0)])(chatLog_entity_1[_0x1e2d87(0x97)])),__param(0x1,(0x0,typeorm_2[_0x1e2d87(0xe0)])(balance_entity_1['BalanceEntity'])),__metadata('design:paramtypes',[typeorm_1[_0x1e2d87(0x71)],typeorm_1[_0x1e2d87(0x71)],upload_service_1[_0x1e2d87(0xb8)],chatLog_service_1[_0x1e2d87(0xb6)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0x1e2d87(0xb1)],badwords_service_1['BadwordsService']])],MjService),exports[_0x1e2d87(0xeb)]=MjService;