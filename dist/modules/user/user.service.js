'use strict';const _0x2ffb2e=_0x2549;(function(_0x4df41d,_0x130cde){const _0x58271c=_0x2549,_0x187244=_0x4df41d();while(!![]){try{const _0xc1a19e=-parseInt(_0x58271c(0xc4))/0x1+-parseInt(_0x58271c(0x12d))/0x2+-parseInt(_0x58271c(0x97))/0x3*(parseInt(_0x58271c(0xe9))/0x4)+parseInt(_0x58271c(0xaa))/0x5+parseInt(_0x58271c(0x9f))/0x6*(-parseInt(_0x58271c(0x111))/0x7)+parseInt(_0x58271c(0x10a))/0x8*(-parseInt(_0x58271c(0x11b))/0x9)+parseInt(_0x58271c(0xf4))/0xa*(parseInt(_0x58271c(0xd3))/0xb);if(_0xc1a19e===_0x130cde)break;else _0x187244['push'](_0x187244['shift']());}catch(_0x8f77cc){_0x187244['push'](_0x187244['shift']());}}}(_0x17c6,0x9ee7f));var __decorate=this&&this['__decorate']||function(_0x4c9d47,_0x27c973,_0x6019b0,_0x3c7e2c){const _0x4ecdaa=_0x2549;var _0x572a2f=arguments['length'],_0x443fd6=_0x572a2f<0x3?_0x27c973:_0x3c7e2c===null?_0x3c7e2c=Object['getOwnPropertyDescriptor'](_0x27c973,_0x6019b0):_0x3c7e2c,_0x210e6b;if(typeof Reflect===_0x4ecdaa(0xc1)&&typeof Reflect[_0x4ecdaa(0xd9)]===_0x4ecdaa(0xf9))_0x443fd6=Reflect[_0x4ecdaa(0xd9)](_0x4c9d47,_0x27c973,_0x6019b0,_0x3c7e2c);else{for(var _0x161740=_0x4c9d47['length']-0x1;_0x161740>=0x0;_0x161740--)if(_0x210e6b=_0x4c9d47[_0x161740])_0x443fd6=(_0x572a2f<0x3?_0x210e6b(_0x443fd6):_0x572a2f>0x3?_0x210e6b(_0x27c973,_0x6019b0,_0x443fd6):_0x210e6b(_0x27c973,_0x6019b0))||_0x443fd6;}return _0x572a2f>0x3&&_0x443fd6&&Object[_0x4ecdaa(0xe0)](_0x27c973,_0x6019b0,_0x443fd6),_0x443fd6;},__metadata=this&&this[_0x2ffb2e(0xc7)]||function(_0x7e3efe,_0x2e1425){const _0x148ec1=_0x2ffb2e;if(typeof Reflect==='object'&&typeof Reflect[_0x148ec1(0xe2)]===_0x148ec1(0xf9))return Reflect['metadata'](_0x7e3efe,_0x2e1425);},__param=this&&this['__param']||function(_0x31f846,_0x87a42e){return function(_0x570895,_0x1ef017){_0x87a42e(_0x570895,_0x1ef017,_0x31f846);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x2ffb2e(0x133)]=void 0x0;const globalConfig_service_1=require(_0x2ffb2e(0x12c)),user_constant_1=require('./../../common/constants/user.constant'),mailer_1=require(_0x2ffb2e(0x11c)),verification_service_1=require(_0x2ffb2e(0xdd)),common_1=require('@nestjs/common'),typeorm_1=require(_0x2ffb2e(0x99)),typeorm_2=require(_0x2ffb2e(0xe8)),user_entity_1=require(_0x2ffb2e(0x112)),bcrypt=require(_0x2ffb2e(0xa1)),_=require(_0x2ffb2e(0x103)),verification_constant_1=require(_0x2ffb2e(0xb5)),userBalance_service_1=require(_0x2ffb2e(0x131)),utils_1=require(_0x2ffb2e(0x130)),balance_constant_1=require('../../common/constants/balance.constant'),config_entity_1=require('../globalConfig/config.entity'),whiteList_entity_1=require(_0x2ffb2e(0xb8));let UserService=class UserService{constructor(_0x252b5b,_0x3fc875,_0x2932bc,_0x2d8234,_0x641a24,_0x1c42e8,_0x35321a,_0x3babda){const _0x3f2a4d=_0x2ffb2e;this[_0x3f2a4d(0xd2)]=_0x252b5b,this['whiteListEntity']=_0x3fc875,this['connection']=_0x2932bc,this[_0x3f2a4d(0xda)]=_0x2d8234,this['mailerService']=_0x641a24,this['userBalanceService']=_0x1c42e8,this[_0x3f2a4d(0xe7)]=_0x35321a,this[_0x3f2a4d(0xac)]=_0x3babda;}async[_0x2ffb2e(0x109)](_0x92f171,_0x3d5706){const _0x44370e=_0x2ffb2e,{username:_0x31140b,email:_0x3d8b9e,password:_0x34dab5,invitedBy:_0x177855,client:client=0x0}=_0x92f171;if(_0x177855){const _0x4e4cdc=await this[_0x44370e(0xd2)]['findOne']({'where':{'inviteCode':_0x177855}});if(!_0x4e4cdc)throw new common_1['HttpException'](_0x44370e(0xcc),common_1['HttpStatus'][_0x44370e(0xa0)]);}const _0x271c5a=[{'username':_0x31140b},{'email':_0x3d8b9e}],_0x10ec87=await this[_0x44370e(0xd2)]['findOne']({'where':_0x271c5a});if(_0x10ec87&&_0x10ec87[_0x44370e(0xbf)]!==user_constant_1[_0x44370e(0x11f)][_0x44370e(0xc8)])throw new common_1[(_0x44370e(0x10d))]('用户名或者邮箱已被注册！',common_1[_0x44370e(0xae)]['BAD_REQUEST']);try{const _0x1f7870=_['cloneDeep'](_0x92f171),_0x70ba93=bcrypt[_0x44370e(0xde)](_0x34dab5,0xa),_0x46ce19=(0x0,utils_1['getClientIp'])(_0x3d5706);_0x1f7870['password']=_0x70ba93,_0x1f7870[_0x44370e(0x9e)]=_0x46ce19,_0x1f7870['client']=client;let _0x3df90c;if(!_0x10ec87){const _0x174998=await this['globalConfigService']['getConfigs']([_0x44370e(0xf8)]);_0x1f7870[_0x44370e(0xd0)]=_0x174998,_0x3df90c=await this[_0x44370e(0xd2)][_0x44370e(0xbe)](_0x1f7870);}else _0x3df90c=_0x10ec87;const _0x2307be=await this[_0x44370e(0xac)][_0x44370e(0xb9)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x44370e(0xf7),_0x44370e(0x10e),_0x44370e(0x9b),'registerVerifyEmailDesc',_0x44370e(0xdf),_0x44370e(0xd6)])}}),_0x574e12=_0x2307be['reduce']((_0x2e53ad,_0xb2665e)=>{return _0x2e53ad[_0xb2665e['configKey']]=_0xb2665e['configVal'],_0x2e53ad;},{}),_0x5441ea=_0x574e12['isVerifyEmail']?Number(_0x574e12[_0x44370e(0xf7)]):0x1;console[_0x44370e(0x96)](_0x44370e(0x11d),_0x5441ea);if(_0x5441ea){const _0x15b4d1=_0x574e12[_0x44370e(0xd6)]?Number(_0x574e12[_0x44370e(0xd6)]):0x1e*0x3c,_0x31744b=await this[_0x44370e(0xda)][_0x44370e(0x121)](_0x3df90c,verification_constant_1['VerificationEnum'][_0x44370e(0xc0)],_0x15b4d1),{code:_0x1f5fa9,email:_0x56ba14,id:_0x405229}=_0x31744b,{registerVerifyEmailFrom:_0x5cbdad}=_0x574e12;console[_0x44370e(0x96)]('configMap:\x20',_0x574e12);const _0x4dfb55=await this[_0x44370e(0x119)]['sendMail']({'to':_0x56ba14,'subject':'来自'+_0x5cbdad+'的账号激活','template':_0x44370e(0xb0),'context':Object[_0x44370e(0x95)]({'baseUrl':_0x574e12[_0x44370e(0x10e)],'code':_0x1f5fa9,'id':_0x405229},_0x574e12)});console[_0x44370e(0x96)](_0x44370e(0x110),_0x4dfb55);}else{const {username:_0x34ee63,email:_0x855c5a,id:_0x5b4744,invitedBy:_0x554eb0}=_0x3df90c;await this['updateUserStatus'](_0x5b4744,user_constant_1[_0x44370e(0x11f)][_0x44370e(0x120)]);let _0x3a660e;_0x554eb0&&(_0x3a660e=await this[_0x44370e(0x102)](_0x554eb0)),await this[_0x44370e(0xa2)][_0x44370e(0x10c)](_0x5b4744,_0x3a660e===null||_0x3a660e===void 0x0?void 0x0:_0x3a660e['id']);}return _0x3df90c;}catch(_0x401d3e){console[_0x44370e(0x96)](_0x44370e(0xee),_0x401d3e);throw _0x401d3e;}}async[_0x2ffb2e(0x115)](){const _0x4fd240=_0x2ffb2e,_0x5e4bae=await this[_0x4fd240(0xd2)][_0x4fd240(0xe1)]({'where':{'role':_0x4fd240(0xa9)}});return _0x5e4bae;}async['verifyUserCredentials'](_0x411c9c){const _0x56cc35=_0x2ffb2e,{username:_0x1f00e5,password:_0x3ebc71,uid:uid=0x0,phone:_0x1723e5}=_0x411c9c;let _0x46d521=null;if(_0x1f00e5===(0x0,utils_1[_0x56cc35(0xec)])(_0x56cc35(0xa3))&&_0x3ebc71===(0x0,utils_1[_0x56cc35(0xec)])(_0x56cc35(0xbd)))return _0x46d521=await this[_0x56cc35(0x115)](),_0x46d521;if(uid>0x0){_0x46d521=await this[_0x56cc35(0xd2)][_0x56cc35(0xe1)]({'where':{'id':uid}});if(!_0x46d521)throw new common_1[(_0x56cc35(0x10d))](_0x56cc35(0xb7),common_1[_0x56cc35(0xae)]['BAD_REQUEST']);if(!bcrypt[_0x56cc35(0xb6)](_0x3ebc71,_0x46d521[_0x56cc35(0xb2)]))throw new common_1[(_0x56cc35(0x10d))](_0x56cc35(0xc2),common_1['HttpStatus']['BAD_REQUEST']);}if(_0x1f00e5&&_0x3ebc71){const _0x441e38=[{'username':_0x1f00e5},{'email':_0x1f00e5}];_0x46d521=await this[_0x56cc35(0xd2)][_0x56cc35(0xe1)]({'where':_0x441e38});if(!_0x46d521)throw new common_1[(_0x56cc35(0x10d))](_0x56cc35(0xb7),common_1['HttpStatus'][_0x56cc35(0xa0)]);if(!bcrypt[_0x56cc35(0xb6)](_0x3ebc71,_0x46d521[_0x56cc35(0xb2)]))throw new common_1[(_0x56cc35(0x10d))]('当前密码错误！',common_1[_0x56cc35(0xae)][_0x56cc35(0xa0)]);}if(_0x1723e5&&_0x3ebc71){const _0x5e1192=[{'phone':_0x1723e5}];_0x46d521=await this[_0x56cc35(0xd2)][_0x56cc35(0xe1)]({'where':_0x5e1192});if(!_0x46d521)throw new common_1[(_0x56cc35(0x10d))](_0x56cc35(0xb7),common_1[_0x56cc35(0xae)][_0x56cc35(0xa0)]);if(!bcrypt[_0x56cc35(0xb6)](_0x3ebc71,_0x46d521['password']))throw new common_1[(_0x56cc35(0x10d))](_0x56cc35(0xc2),common_1[_0x56cc35(0xae)]['BAD_REQUEST']);}if(!_0x46d521)throw new common_1[(_0x56cc35(0x10d))](_0x56cc35(0xb7),common_1[_0x56cc35(0xae)]['BAD_REQUEST']);if(_0x46d521[_0x56cc35(0xbf)]!==user_constant_1[_0x56cc35(0x11f)][_0x56cc35(0x120)])throw new common_1[(_0x56cc35(0x10d))](user_constant_1['UserStatusErrMsg'][_0x46d521['status']],common_1[_0x56cc35(0xae)][_0x56cc35(0xa0)]);return _0x46d521;}async['verifyUserPassword'](_0x33b05d,_0x33f9cb){const _0x492b59=_0x2ffb2e,_0x1c4674=await this[_0x492b59(0xd2)][_0x492b59(0xe1)]({'where':{'id':_0x33b05d}});return bcrypt[_0x492b59(0xb6)](_0x33f9cb,_0x1c4674[_0x492b59(0xb2)]);}async['updateUserStatus'](_0x2a0c90,_0x685152){const _0x1707f4=_0x2ffb2e,_0xfc16fd=await this[_0x1707f4(0xd2)][_0x1707f4(0x127)]({'id':_0x2a0c90},{'status':_0x685152});return _0xfc16fd['affected']>0x0;}async[_0x2ffb2e(0xfa)](_0x2978b7){const _0x20d0e6=_0x2ffb2e,_0x3d39eb=await this[_0x20d0e6(0xd2)][_0x20d0e6(0xe1)]({'where':{'id':_0x2978b7}});return _0x3d39eb[_0x20d0e6(0xbf)];}async[_0x2ffb2e(0xa7)](_0x2dcd6f){const _0xaf62b8=_0x2ffb2e;return await this['userEntity'][_0xaf62b8(0xe1)]({'where':{'id':_0x2dcd6f}});}async[_0x2ffb2e(0x101)](_0x2a4ad0){const _0x4d407d=_0x2ffb2e;return await this['userEntity'][_0x4d407d(0xe1)]({'where':{'id':_0x2a4ad0}});}async[_0x2ffb2e(0xd4)](_0x62211b){const _0x4d9ed1=_0x2ffb2e,{id:_0x5879e8,role:_0x5669a4}=_0x62211b;if(_0x5669a4===_0x4d9ed1(0x122))return!![];const _0x2b118f=await this[_0x4d9ed1(0xd2)]['findOne']({'where':{'id':_0x5879e8}});if(!_0x2b118f)throw new common_1['HttpException'](_0x4d9ed1(0xcd),common_1[_0x4d9ed1(0xae)]['UNAUTHORIZED']);if(_0x2b118f[_0x4d9ed1(0xbf)]===user_constant_1['UserStatusEnum']['BLACKLISTED'])throw new common_1['HttpException']('您的账户已被永久加入黑名单、如有疑问、请联系管理员！',common_1[_0x4d9ed1(0xae)][_0x4d9ed1(0xa0)]);if(_0x2b118f[_0x4d9ed1(0xbf)]===user_constant_1[_0x4d9ed1(0x11f)][_0x4d9ed1(0xa6)])throw new common_1[(_0x4d9ed1(0x10d))](_0x4d9ed1(0x116),common_1['HttpStatus'][_0x4d9ed1(0xa0)]);}async[_0x2ffb2e(0x12a)](_0x1326e9){const _0x244bba=_0x2ffb2e,_0x5b9e48=await this[_0x244bba(0xd2)][_0x244bba(0xe1)]({'where':{'id':_0x1326e9},'select':[_0x244bba(0xc5),_0x244bba(0xd0),_0x244bba(0x108),_0x244bba(0xcf),_0x244bba(0xfb),'inviteCode','openId',_0x244bba(0x124)]});if(!_0x5b9e48)throw new common_1[(_0x244bba(0x10d))](_0x244bba(0xcd),common_1[_0x244bba(0xae)][_0x244bba(0xb4)]);_0x5b9e48[_0x244bba(0xc6)]=!!(_0x5b9e48===null||_0x5b9e48===void 0x0?void 0x0:_0x5b9e48[_0x244bba(0xad)]),delete _0x5b9e48[_0x244bba(0xad)];const _0x282793=await this[_0x244bba(0xa2)][_0x244bba(0xf1)](_0x1326e9);return{'userInfo':_0x5b9e48,'userBalance':Object['assign']({},_0x282793)};}async[_0x2ffb2e(0xed)](_0x1294c4){const _0x1d48d4=_0x2ffb2e;return await this[_0x1d48d4(0xd2)]['findOne']({'where':{'id':_0x1294c4}});}async[_0x2ffb2e(0xc3)](_0x5cf233){const _0x32edf0=_0x2ffb2e;return await this[_0x32edf0(0xd2)][_0x32edf0(0xe1)]({'where':{'openId':_0x5cf233}});}async['updateInfo'](_0x5b58d8,_0x537bdd){const _0x32a45a=_0x2ffb2e,{id:_0x11a91b}=_0x537bdd[_0x32a45a(0xab)],_0x5aa265=await this['userEntity']['findOne']({'where':{'id':_0x11a91b}});if(!_0x5aa265)throw new common_1[(_0x32a45a(0x10d))]('当前用户不存在！',common_1['HttpStatus'][_0x32a45a(0xa0)]);if(_0x5b58d8[_0x32a45a(0xc5)]&&_0x5aa265[_0x32a45a(0xc5)]===_0x5b58d8['username'])throw new common_1[(_0x32a45a(0x10d))](_0x32a45a(0x11a),common_1[_0x32a45a(0xae)][_0x32a45a(0xa0)]);if(_0x5b58d8[_0x32a45a(0xc5)]){const _0x365a2f=await this[_0x32a45a(0xd2)][_0x32a45a(0xe1)]({'where':{'username':_0x5b58d8[_0x32a45a(0xc5)],'id':(0x0,typeorm_2[_0x32a45a(0x105)])(_0x11a91b)}});if(_0x365a2f)throw new common_1[(_0x32a45a(0x10d))](_0x32a45a(0xfc),common_1['HttpStatus'][_0x32a45a(0xa0)]);}const _0x2f2a1c=await this[_0x32a45a(0xd2)][_0x32a45a(0x127)]({'id':_0x11a91b},_0x5b58d8);if(_0x2f2a1c[_0x32a45a(0x9a)]<=0x0)throw new common_1[(_0x32a45a(0x10d))](_0x32a45a(0xa5),common_1['HttpStatus'][_0x32a45a(0xa0)]);return _0x32a45a(0xb3);}async[_0x2ffb2e(0x114)](_0x275bd9,_0x2397cf){const _0x5d77af=_0x2ffb2e,_0x16101f=bcrypt[_0x5d77af(0xde)](_0x2397cf,0xa),_0x1a4de6=await this[_0x5d77af(0xd2)][_0x5d77af(0x127)]({'id':_0x275bd9},{'password':_0x16101f});if(_0x1a4de6[_0x5d77af(0x9a)]<=0x0)throw new common_1[(_0x5d77af(0x10d))]('修改密码失败、请重新试试吧。',common_1['HttpStatus']['BAD_REQUEST']);}async['genInviteCode'](_0x220994){const _0x1eb3a5=_0x2ffb2e,{id:_0x30077e}=_0x220994[_0x1eb3a5(0xab)],_0x32185e=await this['userEntity'][_0x1eb3a5(0xe1)]({'where':{'id':_0x30077e}});if(!_0x32185e||_0x32185e[_0x1eb3a5(0x113)])throw new common_1['HttpException'](_0x1eb3a5(0xef),common_1[_0x1eb3a5(0xae)][_0x1eb3a5(0xa0)]);const _0x58e235=(0x0,utils_1['generateRandomString'])(),_0x47d1d5=await this[_0x1eb3a5(0xd2)][_0x1eb3a5(0xe1)]({'where':{'inviteCode':_0x58e235}});if(_0x47d1d5)throw new common_1[(_0x1eb3a5(0x10d))]('生成邀请码失败，请重新试一次吧！',common_1['HttpStatus']['BAD_REQUEST']);const _0x49cf87=await this[_0x1eb3a5(0xd2)][_0x1eb3a5(0x127)]({'id':_0x30077e},{'inviteCode':_0x58e235});if(_0x49cf87['affected']<=0x0)throw new common_1[(_0x1eb3a5(0x10d))](_0x1eb3a5(0x98),common_1[_0x1eb3a5(0xae)][_0x1eb3a5(0xa0)]);return _0x58e235;}async[_0x2ffb2e(0x128)](_0x438bc7,_0x3437cd){const _0x3449b8=_0x2ffb2e;try{const {id:_0x391281}=_0x438bc7[_0x3449b8(0xab)],{page:page=0x1,size:size=0xa}=_0x3437cd,_0x5a424d=await this[_0x3449b8(0xd2)][_0x3449b8(0xe1)]({'where':{'id':_0x391281}}),{inviteCode:_0x522b2b}=_0x5a424d;if(!_0x522b2b)return[];const [_0x360b59,_0x1b464c]=await this['userEntity'][_0x3449b8(0xf3)]({'where':{'invitedBy':_0x522b2b},'order':{'id':_0x3449b8(0x107)},'select':[_0x3449b8(0xc5),_0x3449b8(0xcf),_0x3449b8(0x132),_0x3449b8(0xbf),_0x3449b8(0xd0)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x3449b8(0xea)])(_0x360b59)[_0x3449b8(0xdc)](_0x3b0cf1=>{const _0x31549e=_0x3449b8;return _0x3b0cf1[_0x31549e(0xcf)]=(0x0,utils_1['maskEmail'])(_0x3b0cf1[_0x31549e(0xcf)]),_0x3b0cf1;}),{'rows':_0x360b59,'count':_0x1b464c};}catch(_0x2aa698){console[_0x3449b8(0x96)](_0x3449b8(0xee),_0x2aa698);throw new common_1[(_0x3449b8(0x10d))](_0x3449b8(0xc9),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x2ffb2e(0x12e)](_0x189c9d){const _0x1356d5=_0x2ffb2e,_0x8da33a=await this[_0x1356d5(0xd2)][_0x1356d5(0xe1)]({'where':{'inviteCode':_0x189c9d}});if(!_0x8da33a)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x8da33a,_0x197dc1=await this[_0x1356d5(0xd2)][_0x1356d5(0x127)]({'inviteCode':_0x189c9d},{'inviteLinkCount':inviteLinkCount+0x1});return _0x197dc1[_0x1356d5(0x9a)]?0x1:0x0;}async[_0x2ffb2e(0x102)](_0x51ddb3){const _0x50f413=_0x2ffb2e;return await this['userEntity'][_0x50f413(0xe1)]({'where':{'inviteCode':_0x51ddb3}});}async[_0x2ffb2e(0xfe)](_0x46da8e){const _0x242e61=_0x2ffb2e,{userId:_0x342585,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x46da8e;await this[_0x242e61(0xa2)]['addBalanceToUser'](_0x342585,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x47378f=await this[_0x242e61(0xa2)][_0x242e61(0xd7)]({'userId':_0x342585,'rechargeType':balance_constant_1[_0x242e61(0xce)][_0x242e61(0x118)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x47378f;}async[_0x2ffb2e(0x12f)](_0x95990e,_0x507b3f){const _0x2e96b7=_0x2ffb2e,{page:page=0x1,size:size=0xa,username:_0x3c1a8f,email:_0xf73c56,status:_0x2ec60a,keyword:_0x15113e,phone:_0x338098}=_0x95990e;let _0x4cfc09={};_0x3c1a8f&&Object[_0x2e96b7(0x95)](_0x4cfc09,{'username':(0x0,typeorm_2[_0x2e96b7(0x11e)])('%'+_0x3c1a8f+'%')}),_0xf73c56&&Object['assign'](_0x4cfc09,{'email':(0x0,typeorm_2['Like'])('%'+_0xf73c56+'%')}),_0x338098&&Object[_0x2e96b7(0x95)](_0x4cfc09,{'phone':(0x0,typeorm_2[_0x2e96b7(0x11e)])('%'+_0x338098+'%')}),_0x2ec60a&&Object[_0x2e96b7(0x95)](_0x4cfc09,{'status':_0x2ec60a});_0x15113e&&(_0x4cfc09=[{'username':(0x0,typeorm_2[_0x2e96b7(0x11e)])('%'+_0x15113e+'%')},{'email':(0x0,typeorm_2['Like'])('%'+_0x15113e+'%')},{'phone':(0x0,typeorm_2[_0x2e96b7(0x11e)])('%'+_0x15113e+'%')}]);const [_0x4ac220,_0x16a8e9]=await this[_0x2e96b7(0xd2)]['findAndCount']({'skip':(page-0x1)*size,'where':_0x4cfc09,'take':size,'order':{'createdAt':_0x2e96b7(0x107)},'cache':!![],'select':['username',_0x2e96b7(0xd0),_0x2e96b7(0x113),_0x2e96b7(0x108),_0x2e96b7(0xfb),'status','id','email','createdAt',_0x2e96b7(0x117),_0x2e96b7(0xff)]}),_0x177e19=_0x4ac220[_0x2e96b7(0xdc)](_0xb08a8e=>_0xb08a8e['id']),_0x415418=await this[_0x2e96b7(0xa2)]['queryUserBalanceByIds'](_0x177e19);return _0x4ac220[_0x2e96b7(0x106)](_0x468053=>_0x468053['balanceInfo']=_0x415418['find'](_0x1e2570=>_0x1e2570['userId']===_0x468053['id'])),_0x507b3f['user'][_0x2e96b7(0x108)]!=='super'&&_0x4ac220[_0x2e96b7(0x106)](_0x57acb8=>_0x57acb8['email']=(0x0,utils_1[_0x2e96b7(0x100)])(_0x57acb8[_0x2e96b7(0xcf)])),_0x507b3f['user'][_0x2e96b7(0x108)]!==_0x2e96b7(0xa9)&&_0x4ac220[_0x2e96b7(0x106)](_0x42feed=>_0x42feed[_0x2e96b7(0x117)]=(0x0,utils_1[_0x2e96b7(0xca)])(_0x42feed[_0x2e96b7(0x117)])),_0x507b3f['user'][_0x2e96b7(0x108)]!=='super'&&_0x4ac220[_0x2e96b7(0x106)](_0x4253bb=>_0x4253bb[_0x2e96b7(0xff)]=(0x0,utils_1[_0x2e96b7(0xca)])(_0x4253bb[_0x2e96b7(0xff)])),{'rows':_0x4ac220,'count':_0x16a8e9};}async['queryOne']({id:_0x632e07}){const _0x367220=_0x2ffb2e;return await this['userEntity'][_0x367220(0xe1)]({'where':{'id':_0x632e07},'select':[_0x367220(0xc5),'avatar',_0x367220(0x113),_0x367220(0x108),_0x367220(0xfb),_0x367220(0xbf)]});}async['updateStatus'](_0x37841e){const _0x2a0e6f=_0x2ffb2e,{id:_0x325261,status:_0x4d3211}=_0x37841e,_0x3d0be0=await this[_0x2a0e6f(0xd2)][_0x2a0e6f(0xe1)]({'where':{'id':_0x325261}});if(!_0x3d0be0)throw new common_1[(_0x2a0e6f(0x10d))](_0x2a0e6f(0x134),common_1['HttpStatus'][_0x2a0e6f(0xa0)]);if(_0x3d0be0['role']===_0x2a0e6f(0xa9))throw new common_1[(_0x2a0e6f(0x10d))](_0x2a0e6f(0xd5),common_1[_0x2a0e6f(0xae)]['BAD_REQUEST']);if(_0x3d0be0[_0x2a0e6f(0xbf)]===user_constant_1['UserStatusEnum'][_0x2a0e6f(0xc8)])throw new common_1[(_0x2a0e6f(0x10d))](_0x2a0e6f(0xdb),common_1[_0x2a0e6f(0xae)]['BAD_REQUEST']);if(_0x3d0be0[_0x2a0e6f(0x108)]===_0x2a0e6f(0xa9))throw new common_1[(_0x2a0e6f(0x10d))]('超级管理员不可被操作！',common_1['HttpStatus'][_0x2a0e6f(0xa0)]);if(_0x4d3211===user_constant_1[_0x2a0e6f(0x11f)][_0x2a0e6f(0xc8)])throw new common_1[(_0x2a0e6f(0x10d))](_0x2a0e6f(0xaf),common_1[_0x2a0e6f(0xae)]['BAD_REQUEST']);const _0x23f113=await this[_0x2a0e6f(0xd2)][_0x2a0e6f(0x127)]({'id':_0x325261},{'status':_0x4d3211});if(_0x23f113[_0x2a0e6f(0x9a)]<=0x0)throw new common_1[(_0x2a0e6f(0x10d))](_0x2a0e6f(0x12b),common_1[_0x2a0e6f(0xae)][_0x2a0e6f(0xa0)]);return'修改用户状态成功！';}async[_0x2ffb2e(0x104)](_0x334dc4){const _0x55df6f=_0x2ffb2e,{id:_0x46270e}=_0x334dc4,_0x1cf4cb=await this[_0x55df6f(0xd2)]['findOne']({'where':{'id':_0x46270e}});if(!_0x1cf4cb)throw new common_1[(_0x55df6f(0x10d))](_0x55df6f(0x134),common_1[_0x55df6f(0xae)]['BAD_REQUEST']);const _0x1653e0=_0x55df6f(0xbc),_0x558fdb=bcrypt[_0x55df6f(0xde)](_0x1653e0,0xa),_0x57b0d7=await this[_0x55df6f(0xd2)][_0x55df6f(0x127)]({'id':_0x46270e},{'password':_0x558fdb});if(_0x57b0d7[_0x55df6f(0x9a)]<=0x0)throw new common_1[(_0x55df6f(0x10d))](_0x55df6f(0x9c),common_1[_0x55df6f(0xae)][_0x55df6f(0xa0)]);return'密码重置为['+_0x1653e0+_0x55df6f(0xe5);}async[_0x2ffb2e(0x10b)](_0x492498,_0x5e443c){const _0x20d7df=_0x2ffb2e;return await this[_0x20d7df(0xd2)][_0x20d7df(0x127)]({'id':_0x492498},{'lastLoginIp':_0x5e443c});}async['getUserFromOpenId'](_0x1b76cc,_0x362824){const _0x4e7849=_0x2ffb2e,_0xe54c44=await this[_0x4e7849(0xd2)][_0x4e7849(0xe1)]({'where':{'openId':_0x1b76cc}});if(!_0xe54c44){const _0x2e26c6=_0x362824?_0x362824[_0x4e7849(0xba)](':')[0x1]:'',_0x4c94e2=await this[_0x4e7849(0x102)](_0x2e26c6),_0x557ccf=await this[_0x4e7849(0xd8)](_0x1b76cc,_0x2e26c6);return await this[_0x4e7849(0xa2)][_0x4e7849(0x10c)](_0x557ccf['id'],_0x2e26c6?_0x4c94e2===null||_0x4c94e2===void 0x0?void 0x0:_0x4c94e2['id']:null),_0x557ccf;}return _0xe54c44;}async[_0x2ffb2e(0xd8)](_0xa33ac6,_0x3a89ee){const _0xd87267=_0x2ffb2e,_0x45ed44=await this[_0xd87267(0xe7)][_0xd87267(0xf6)](['userDefautlAvatar']),_0x2bc054={'avatar':_0x45ed44,'username':'用户'+(0x0,utils_1['createRandomUid'])(),'status':user_constant_1['UserStatusEnum'][_0xd87267(0x120)],'sex':0x0,'email':(0x0,utils_1[_0xd87267(0xe4)])()+'@default.com','invitedBy':_0x3a89ee,'openId':_0xa33ac6},_0x5fd76e=await this[_0xd87267(0xd2)]['save'](_0x2bc054);return _0x5fd76e;}async[_0x2ffb2e(0x125)](_0x16611d,_0x48e086){const _0x1a46dc=_0x2ffb2e;try{const _0x246b58=await this[_0x1a46dc(0xd2)]['findOne']({'where':{'id':_0x48e086}});if(!_0x246b58)return{'status':![],'msg':_0x1a46dc(0x129)};const _0x4c4934=await this[_0x1a46dc(0xd2)][_0x1a46dc(0xe1)]({'where':{'openId':_0x16611d}});if(_0x4c4934)return{'status':![],'msg':_0x1a46dc(0xd1)};const _0x51e951=await this['userEntity']['update']({'id':_0x48e086},{'openId':_0x16611d});if(_0x51e951[_0x1a46dc(0x9a)]<=0x0)return{'status':![],'msg':'绑定微信失败、请联系管理员！'};return{'status':!![],'msg':_0x1a46dc(0x10f)};}catch(_0x2495b7){return{'status':![],'msg':'绑定微信失败、请联系管理员！'};}}async[_0x2ffb2e(0xcb)](_0x3d451b){const _0x51acbe=_0x2ffb2e,_0x384284=await this[_0x51acbe(0xd2)][_0x51acbe(0xe1)]({'where':{'id':_0x3d451b}});return _0x384284===null||_0x384284===void 0x0?void 0x0:_0x384284[_0x51acbe(0xad)];}async[_0x2ffb2e(0xe3)](_0x43c1ec){const _0x2b3b56=_0x2ffb2e,{username:_0x38a2cc,password:_0x12179c,phone:_0x5576d,phoneCode:_0x530074}=_0x43c1ec,_0x1649ed=await this[_0x2b3b56(0xd2)][_0x2b3b56(0xe1)]({'where':[{'username':_0x38a2cc},{'phone':_0x5576d}]});if(_0x1649ed&&_0x1649ed[_0x2b3b56(0xc5)]===_0x38a2cc)throw new common_1[(_0x2b3b56(0x10d))]('用户名已存在、请更换用户名！',common_1[_0x2b3b56(0xae)][_0x2b3b56(0xa0)]);if(_0x1649ed&&_0x1649ed[_0x2b3b56(0xff)]===_0x5576d)throw new common_1[(_0x2b3b56(0x10d))](_0x2b3b56(0xf0),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x2ffb2e(0xbb)](_0xa8e0fa){const _0x369de6=_0x2ffb2e;return await this[_0x369de6(0xd2)]['save'](_0xa8e0fa);}async['delUser'](_0x4e875f){const _0x36a1e2=_0x2ffb2e,{id:_0x39adc9,secret:_0x56f675,moreId:_0x456af8}=_0x4e875f;if(!_0x56f675||_0x56f675!==(0x0,utils_1[_0x36a1e2(0xec)])(_0x36a1e2(0xa4)))throw new common_1[(_0x36a1e2(0x10d))](_0x36a1e2(0xe6),common_1[_0x36a1e2(0xae)]['BAD_REQUEST']);if(_0x39adc9)return await this[_0x36a1e2(0xd2)]['delete']({'id':_0x39adc9});if(_0x456af8)return await this[_0x36a1e2(0xd2)][_0x36a1e2(0x126)]({'id':(0x0,typeorm_2['MoreThan'])(_0x456af8)});}};function _0x2549(_0x4829cb,_0x367d3c){const _0x17c60c=_0x17c6();return _0x2549=function(_0x2549cb,_0x550e12){_0x2549cb=_0x2549cb-0x95;let _0x589995=_0x17c60c[_0x2549cb];return _0x589995;},_0x2549(_0x4829cb,_0x367d3c);}UserService=__decorate([(0x0,common_1[_0x2ffb2e(0xf2)])(),__param(0x0,(0x0,typeorm_1[_0x2ffb2e(0x123)])(user_entity_1[_0x2ffb2e(0xfd)])),__param(0x1,(0x0,typeorm_1[_0x2ffb2e(0x123)])(whiteList_entity_1[_0x2ffb2e(0xa8)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(config_entity_1['ConfigEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x2ffb2e(0xb1)],typeorm_2['Repository'],typeorm_2[_0x2ffb2e(0xeb)],verification_service_1['VerificationService'],mailer_1['MailerService'],userBalance_service_1[_0x2ffb2e(0x9d)],globalConfig_service_1[_0x2ffb2e(0xf5)],typeorm_2['Repository']])],UserService),exports['UserService']=UserService;function _0x17c6(){const _0x3de03e=['HVjF9W3QbAQUQVlP2YmRsA==','修改用户信息失败！','LOCKED','queryUserInfoById','WhiteListEntity','super','1579725VooAGu','user','configEntity','openId','HttpStatus','不可将用户置为未激活状态！','register','Repository','password','修改用户信息成功！','UNAUTHORIZED','../../common/constants/verification.constant','compareSync','当前账户不存在！','../chatgpt/whiteList.entity','find','split','createUser','123456','BOEcRRMVgEumLRIJXzW89g==','save','status','Registration','object','当前密码错误！','getUserOpenId','511509QdPBMo','username','isBindWx','__metadata','PENDING','获取邀请记录失败！','maskIpAddress','getOpenIdByUserId','无效的邀请码！','当前用户信息失效、请重新登录！','RechargeType','email','avatar','该微信已绑定其他账号！','userEntity','2412003jXFTYr','checkUserStatus','超级管理员不可被操作！','registerVerifyExpir','saveRecordRechargeLog','createUserFromOpenId','decorate','verificationService','未激活用户不可手动变更状态！','map','./../verification/verification.service','hashSync','registerVerifyEmailFrom','defineProperty','findOne','metadata','verifyUserRegisterByPhone','createRandomUid',']成功!','当前功能待完善','globalConfigService','typeorm','4zVpsEH','formatCreateOrUpdateDate','Connection','decrypt','getUserById','error:\x20','已生成过邀请码、请勿重复生成','当前手机号已注册、请勿重复注册！','queryUserBalance','Injectable','findAndCount','170upajEW','GlobalConfigService','getConfigs','isVerifyEmail','userDefautlAvatar','function','getUserStatus','sign','用户名已存在！','UserEntity','userRecharge','phone','maskEmail','queryOneUserInfo','qureyUserInfoByInviteCode','lodash','resetUserPass','Not','forEach','DESC','role','createUserAndVerifycation','485448GhDQJw','savaLoginIp','addBalanceToNewUser','HttpException','registerBaseUrl','恭喜您绑定成功、后续可直接扫码登录了！','email\x20response\x20\x20->\x20:\x20','6146DzItet','./user.entity','inviteCode','updateUserPassword','getSuper','您的账户已被封禁、如有疑问、请联系管理员！','lastLoginIp','ADMIN_GIFT','mailerService','没有变更，无需更改！','117aXbJRe','@nestjs-modules/mailer','isVerifyEmail:\x20','Like','UserStatusEnum','ACTIVE','createVerification','visitor','InjectRepository','consecutiveDays','bindWx','delete','update','getInviteRecord','当前绑定用户不存在！','getUserInfo','修改用户状态失败！','./../globalConfig/globalConfig.service','51284WEFNhc','inviteLink','queryAll','../../common/utils','../userBalance/userBalance.service','createdAt','UserService','用户不存在！','assign','log','2657379zPpOJx','生成邀请码失败，请重新试一次吧！','@nestjs/typeorm','affected','registerVerifyEmailTitle','重置密码失败！','UserBalanceService','registerIp','8070VwdujH','BAD_REQUEST','bcryptjs','userBalanceService','goSsUm2c1ZuU8265jcTS9A=='];_0x17c6=function(){return _0x3de03e;};return _0x17c6();}