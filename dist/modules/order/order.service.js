'use strict';const _0x5a9435=_0x1fa7;(function(_0x47ac06,_0x193565){const _0x425a56=_0x1fa7,_0x36acc7=_0x47ac06();while(!![]){try{const _0x21eef4=-parseInt(_0x425a56(0x1e3))/0x1*(parseInt(_0x425a56(0x1ec))/0x2)+-parseInt(_0x425a56(0x1cf))/0x3+parseInt(_0x425a56(0x1f0))/0x4+-parseInt(_0x425a56(0x1a9))/0x5+-parseInt(_0x425a56(0x1b6))/0x6+parseInt(_0x425a56(0x1e7))/0x7+parseInt(_0x425a56(0x1c3))/0x8;if(_0x21eef4===_0x193565)break;else _0x36acc7['push'](_0x36acc7['shift']());}catch(_0x350384){_0x36acc7['push'](_0x36acc7['shift']());}}}(_0x2ca9,0x35066));function _0x2ca9(){const _0x3a353e=['OrderEntity','total','1043397BISaVg','deleteOrder','findAndCount','Injectable','price','getRawOne','HttpException','createQueryBuilder','__esModule','createOrderId','globalConfigService','findOne','order','status','orderEntity','../globalConfig/globalConfig.service','payService','__metadata','length','where','1789zjijgf','payPlatform','SUM(order.price)','forEach','867335BaJDrU','goodsId','套餐不存在!','defineProperty','channel','464boGNvO','user','UserEntity','./../user/user.entity','1464924KJNJKu','./order.entity','CramiPackageEntity','decorate','../../common/utils','message','orderId','UNAUTHORIZED','create','pay','order.status\x20=\x20:status','1484275sSHMlf','metadata','@nestjs/typeorm','map','find','DESC','../pay/pay.service','userId','cramiPackageEntity','log','username','BAD_REQUEST','请先注册账号后购买商品！','2303136JjVcqM','OrderService','queryAllOrder','HttpStatus','save','query','des','InjectRepository','订单不存在!','buy','__decorate','assign','../crami/cramiPackage.entity','9364896azEpBB','Repository','order:\x20','userInfo','coverImg','count','total_price','select','delete','name'];_0x2ca9=function(){return _0x3a353e;};return _0x2ca9();}var __decorate=this&&this[_0x5a9435(0x1c0)]||function(_0x1e3548,_0x4bb638,_0x15df4f,_0x1c2da0){const _0x21af50=_0x5a9435;var _0x5b1b3a=arguments[_0x21af50(0x1e1)],_0x44824c=_0x5b1b3a<0x3?_0x4bb638:_0x1c2da0===null?_0x1c2da0=Object['getOwnPropertyDescriptor'](_0x4bb638,_0x15df4f):_0x1c2da0,_0x470753;if(typeof Reflect==='object'&&typeof Reflect[_0x21af50(0x1f3)]==='function')_0x44824c=Reflect['decorate'](_0x1e3548,_0x4bb638,_0x15df4f,_0x1c2da0);else{for(var _0x3be246=_0x1e3548[_0x21af50(0x1e1)]-0x1;_0x3be246>=0x0;_0x3be246--)if(_0x470753=_0x1e3548[_0x3be246])_0x44824c=(_0x5b1b3a<0x3?_0x470753(_0x44824c):_0x5b1b3a>0x3?_0x470753(_0x4bb638,_0x15df4f,_0x44824c):_0x470753(_0x4bb638,_0x15df4f))||_0x44824c;}return _0x5b1b3a>0x3&&_0x44824c&&Object[_0x21af50(0x1ea)](_0x4bb638,_0x15df4f,_0x44824c),_0x44824c;},__metadata=this&&this[_0x5a9435(0x1e0)]||function(_0x2043fe,_0x3ff0d7){const _0x8e61e9=_0x5a9435;if(typeof Reflect==='object'&&typeof Reflect[_0x8e61e9(0x1aa)]==='function')return Reflect[_0x8e61e9(0x1aa)](_0x2043fe,_0x3ff0d7);},__param=this&&this['__param']||function(_0x4e5430,_0x234deb){return function(_0x386577,_0x11e044){_0x234deb(_0x386577,_0x11e044,_0x4e5430);};};Object[_0x5a9435(0x1ea)](exports,_0x5a9435(0x1d7),{'value':!![]}),exports[_0x5a9435(0x1b7)]=void 0x0;const user_entity_1=require(_0x5a9435(0x1ef)),typeorm_1=require(_0x5a9435(0x1ab)),common_1=require('@nestjs/common'),typeorm_2=require('typeorm'),order_entity_1=require(_0x5a9435(0x1f1)),cramiPackage_entity_1=require(_0x5a9435(0x1c2)),utils_1=require(_0x5a9435(0x1f4)),pay_service_1=require(_0x5a9435(0x1af)),globalConfig_service_1=require(_0x5a9435(0x1de));let OrderService=class OrderService{constructor(_0x200307,_0xe32d4c,_0x2ea4d1,_0xeb2f52,_0x5cb045){const _0x4d1de5=_0x5a9435;this[_0x4d1de5(0x1dd)]=_0x200307,this[_0x4d1de5(0x1b1)]=_0xe32d4c,this['userEntity']=_0x2ea4d1,this[_0x4d1de5(0x1df)]=_0xeb2f52,this['globalConfigService']=_0x5cb045;}async[_0x5a9435(0x1bf)](_0x5a63cd,_0x56275a){const _0x4e9209=_0x5a9435;try{const {goodsId:_0x36928e,count:count=0x1,payType:_0x54189e}=_0x5a63cd,{id:_0x4eb228}=_0x56275a['user'];if(_0x4eb228>0xf4240)throw new common_1[(_0x4e9209(0x1d5))](_0x4e9209(0x1b5),common_1['HttpStatus']['UNAUTHORIZED']);const _0x55472f=await this['create'](_0x4eb228,_0x36928e,count,_0x54189e),_0x4e92db=await this[_0x4e9209(0x1df)][_0x4e9209(0x1f9)](_0x4eb228,_0x55472f['orderId'],_0x54189e);return Object[_0x4e9209(0x1c1)](Object[_0x4e9209(0x1c1)]({},_0x4e92db),{'orderId':_0x55472f[_0x4e9209(0x1f6)],'platform':_0x55472f['payPlatform'],'total':_0x55472f[_0x4e9209(0x1ce)]});}catch(_0x5d6eda){if(_0x5d6eda['status']===0x191)throw new common_1[(_0x4e9209(0x1d5))](_0x5d6eda[_0x4e9209(0x1f5)],common_1[_0x4e9209(0x1b9)][_0x4e9209(0x1f7)]);throw new common_1[(_0x4e9209(0x1d5))](_0x5d6eda[_0x4e9209(0x1f5)]||'购买失败!',common_1[_0x4e9209(0x1b9)][_0x4e9209(0x1b4)]);}}async['queryByOrderId'](_0x4083c1,_0x1d660a){const _0x11b096=_0x5a9435,{id:_0x448c5e}=_0x4083c1[_0x11b096(0x1ed)],{orderId:_0x49bdda}=_0x1d660a,_0x382866=await this[_0x11b096(0x1dd)][_0x11b096(0x1da)]({'where':{'userId':_0x448c5e,'orderId':_0x49bdda}});if(!_0x382866)throw new common_1[(_0x11b096(0x1d5))](_0x11b096(0x1be),common_1[_0x11b096(0x1b9)][_0x11b096(0x1b4)]);return _0x382866;}async[_0x5a9435(0x1f8)](_0x29e666,_0x302236,_0x1c7482,_0x2f74c7){const _0x1ccd1a=_0x5a9435,_0x20f7d9=await this[_0x1ccd1a(0x1d9)]['queryPayType'](),_0x2d6340=await this[_0x1ccd1a(0x1b1)]['findOne']({'where':{'id':_0x302236}});if(!_0x2d6340)throw new common_1['HttpException'](_0x1ccd1a(0x1e9),common_1[_0x1ccd1a(0x1b9)][_0x1ccd1a(0x1b4)]);const _0x2473a8={};_0x2473a8[_0x1ccd1a(0x1f6)]=(0x0,utils_1[_0x1ccd1a(0x1d8)])(),_0x2473a8[_0x1ccd1a(0x1b0)]=_0x29e666,_0x2473a8[_0x1ccd1a(0x1e8)]=_0x302236,_0x2473a8[_0x1ccd1a(0x1d3)]=Number(_0x2d6340[_0x1ccd1a(0x1d3)]),_0x2473a8[_0x1ccd1a(0x1c8)]=_0x1c7482,_0x2473a8[_0x1ccd1a(0x1ce)]=Number(_0x2d6340[_0x1ccd1a(0x1d3)])*_0x1c7482,_0x2473a8['payPlatform']=_0x20f7d9,_0x2473a8[_0x1ccd1a(0x1eb)]=_0x2f74c7;const _0xf6cac5=await this[_0x1ccd1a(0x1dd)][_0x1ccd1a(0x1ba)](_0x2473a8);return console[_0x1ccd1a(0x1b2)](_0x1ccd1a(0x1c5),_0xf6cac5),_0xf6cac5;}async[_0x5a9435(0x1bb)](_0x3b1145,_0x5d9a72,_0x484317){const _0x22127a=_0x5a9435;return await this[_0x22127a(0x1dd)][_0x22127a(0x1d1)]({'where':{'userId':_0x3b1145},'order':{'id':_0x22127a(0x1ae)},'skip':(_0x5d9a72-0x1)*_0x484317,'take':_0x484317});}async[_0x5a9435(0x1b8)](_0x5e6465){const _0x73be15=_0x5a9435,{page:_0x176574,size:_0x56e854,userId:_0x5b51c2,platform:_0x2efd85,status:_0x990bef}=_0x5e6465,_0x73ac34={};if(_0x5b51c2)_0x73ac34['userId']=_0x5b51c2;if(_0x2efd85)_0x73ac34[_0x73be15(0x1e4)]=_0x2efd85;if(_0x990bef)_0x73ac34[_0x73be15(0x1dc)]=_0x990bef;const [_0x597651,_0x2d8e1b]=await this[_0x73be15(0x1dd)]['findAndCount']({'order':{'id':_0x73be15(0x1ae)},'where':_0x73ac34,'skip':(_0x176574-0x1)*_0x56e854,'take':_0x56e854}),_0x1aef86=_0x597651['map'](_0x4a4c07=>_0x4a4c07[_0x73be15(0x1b0)]),_0xbd73f6=_0x597651[_0x73be15(0x1ac)](_0x1964ae=>_0x1964ae[_0x73be15(0x1e8)]),_0x2cd10f=await this['userEntity'][_0x73be15(0x1ad)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1aef86)},'select':['id',_0x73be15(0x1b3),'email']}),_0x270e2e=await this['cramiPackageEntity'][_0x73be15(0x1ad)]({'where':{'id':(0x0,typeorm_2['In'])(_0xbd73f6)},'select':['id',_0x73be15(0x1cc),_0x73be15(0x1c7),_0x73be15(0x1bc)]});_0x597651[_0x73be15(0x1e6)](_0x2219af=>{const _0x552738=_0x73be15;_0x2219af[_0x552738(0x1c6)]=_0x2cd10f['find'](_0x28ffcc=>_0x28ffcc['id']===_0x2219af[_0x552738(0x1b0)]),_0x2219af['goodsInfo']=_0x270e2e['find'](_0x55d4d6=>_0x55d4d6['id']===_0x2219af[_0x552738(0x1e8)]);});const _0x3685fa=await this[_0x73be15(0x1dd)][_0x73be15(0x1d6)](_0x73be15(0x1db))[_0x73be15(0x1e2)](_0x73be15(0x1a8),{'status':0x1})[_0x73be15(0x1ca)](_0x73be15(0x1e5),_0x73be15(0x1c9))[_0x73be15(0x1d4)]();return Object[_0x73be15(0x1c1)]({'rows':_0x597651,'count':_0x2d8e1b},_0x3685fa);}async[_0x5a9435(0x1d0)](_0x35b378){const _0x3fd12e=_0x5a9435,{orderId:_0x503769}=_0x35b378,_0x342633=await this[_0x3fd12e(0x1dd)][_0x3fd12e(0x1da)]({'where':{'orderId':_0x503769}});if(!_0x342633)throw new common_1[(_0x3fd12e(0x1d5))](_0x3fd12e(0x1be),common_1[_0x3fd12e(0x1b9)][_0x3fd12e(0x1b4)]);return await this[_0x3fd12e(0x1dd)][_0x3fd12e(0x1cb)]({'orderId':_0x503769});}async['deleteNotPay'](){const _0x3ceb09=_0x5a9435;return await this[_0x3ceb09(0x1dd)]['delete']({'status':0x0});}};function _0x1fa7(_0x45b7b0,_0x1b4f89){const _0x2ca918=_0x2ca9();return _0x1fa7=function(_0x1fa771,_0x249e4c){_0x1fa771=_0x1fa771-0x1a8;let _0x5bc2b7=_0x2ca918[_0x1fa771];return _0x5bc2b7;},_0x1fa7(_0x45b7b0,_0x1b4f89);}OrderService=__decorate([(0x0,common_1[_0x5a9435(0x1d2)])(),__param(0x0,(0x0,typeorm_1[_0x5a9435(0x1bd)])(order_entity_1[_0x5a9435(0x1cd)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x5a9435(0x1f2)])),__param(0x2,(0x0,typeorm_1[_0x5a9435(0x1bd)])(user_entity_1[_0x5a9435(0x1ee)])),__metadata('design:paramtypes',[typeorm_2[_0x5a9435(0x1c4)],typeorm_2['Repository'],typeorm_2['Repository'],pay_service_1['PayService'],globalConfig_service_1['GlobalConfigService']])],OrderService),exports[_0x5a9435(0x1b7)]=OrderService;