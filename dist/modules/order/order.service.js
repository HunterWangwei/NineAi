'use strict';const _0x5e5b04=_0x5620;(function(_0x16271a,_0xdf4bb){const _0x4b77b9=_0x5620,_0x25f402=_0x16271a();while(!![]){try{const _0x2784d3=parseInt(_0x4b77b9(0x188))/0x1*(parseInt(_0x4b77b9(0x19c))/0x2)+-parseInt(_0x4b77b9(0x19f))/0x3*(parseInt(_0x4b77b9(0x1c5))/0x4)+parseInt(_0x4b77b9(0x1d5))/0x5*(-parseInt(_0x4b77b9(0x1c4))/0x6)+-parseInt(_0x4b77b9(0x1be))/0x7+-parseInt(_0x4b77b9(0x19a))/0x8+parseInt(_0x4b77b9(0x1cd))/0x9*(parseInt(_0x4b77b9(0x1d2))/0xa)+parseInt(_0x4b77b9(0x1b9))/0xb;if(_0x2784d3===_0xdf4bb)break;else _0x25f402['push'](_0x25f402['shift']());}catch(_0x9fe612){_0x25f402['push'](_0x25f402['shift']());}}}(_0x21e3,0x46712));function _0x5620(_0x121e19,_0x4e06f8){const _0x21e396=_0x21e3();return _0x5620=function(_0x56203a,_0x4fb9c3){_0x56203a=_0x56203a-0x182;let _0x51bb3c=_0x21e396[_0x56203a];return _0x51bb3c;},_0x5620(_0x121e19,_0x4e06f8);}var __decorate=this&&this[_0x5e5b04(0x1ca)]||function(_0x342912,_0x5bfa62,_0x290033,_0x51e703){const _0x174f0b=_0x5e5b04;var _0x3a3119=arguments[_0x174f0b(0x1a8)],_0x3e1854=_0x3a3119<0x3?_0x5bfa62:_0x51e703===null?_0x51e703=Object[_0x174f0b(0x1cb)](_0x5bfa62,_0x290033):_0x51e703,_0x8f4671;if(typeof Reflect===_0x174f0b(0x193)&&typeof Reflect[_0x174f0b(0x195)]===_0x174f0b(0x1a2))_0x3e1854=Reflect['decorate'](_0x342912,_0x5bfa62,_0x290033,_0x51e703);else{for(var _0x314a1f=_0x342912['length']-0x1;_0x314a1f>=0x0;_0x314a1f--)if(_0x8f4671=_0x342912[_0x314a1f])_0x3e1854=(_0x3a3119<0x3?_0x8f4671(_0x3e1854):_0x3a3119>0x3?_0x8f4671(_0x5bfa62,_0x290033,_0x3e1854):_0x8f4671(_0x5bfa62,_0x290033))||_0x3e1854;}return _0x3a3119>0x3&&_0x3e1854&&Object['defineProperty'](_0x5bfa62,_0x290033,_0x3e1854),_0x3e1854;},__metadata=this&&this['__metadata']||function(_0x2a3eda,_0x3dd4de){const _0x43958d=_0x5e5b04;if(typeof Reflect===_0x43958d(0x193)&&typeof Reflect[_0x43958d(0x1c3)]===_0x43958d(0x1a2))return Reflect[_0x43958d(0x1c3)](_0x2a3eda,_0x3dd4de);},__param=this&&this['__param']||function(_0x29ee90,_0x280156){return function(_0xf5524f,_0x4e200e){_0x280156(_0xf5524f,_0x4e200e,_0x29ee90);};};Object[_0x5e5b04(0x1b3)](exports,_0x5e5b04(0x186),{'value':!![]}),exports[_0x5e5b04(0x18e)]=void 0x0;function _0x21e3(){const _0x14628b=['buy','defineProperty','UNAUTHORIZED','SUM(order.price)','订单不存在!','order','@nestjs/common','11408639aNBFdE','findAndCount','deleteOrder','email','createOrderId','1468271ktcNts','GlobalConfigService','name','getRawOne','HttpStatus','metadata','12CRNFNC','914468LkNkjY','globalConfigService','count','../pay/pay.service','cramiPackageEntity','__decorate','getOwnPropertyDescriptor','InjectRepository','9IgKgwu','./../user/user.entity','PayService','./order.entity','UserEntity','2570210vSKmvr','userId','queryAllOrder','1442305aYJlpu','请先注册账号后购买商品！','queryByOrderId','Injectable','orderEntity','create','__esModule','userInfo','29BhtiXy','userEntity','DESC','typeorm','Repository','../crami/cramiPackage.entity','OrderService','save','map','payService','deleteNotPay','object','@nestjs/typeorm','decorate','findOne','../globalConfig/globalConfig.service','find','BAD_REQUEST','2210072zeIlvF','price','19718jUoCvR','query','orderId','3WMFaUG','assign','delete','function','channel','createQueryBuilder','where','HttpException','goodsInfo','length','套餐不存在!','goodsId','user','status','../../common/utils','payPlatform','CramiPackageEntity','total_price','message'];_0x21e3=function(){return _0x14628b;};return _0x21e3();}const user_entity_1=require(_0x5e5b04(0x1ce)),typeorm_1=require(_0x5e5b04(0x194)),common_1=require(_0x5e5b04(0x1b8)),typeorm_2=require(_0x5e5b04(0x18b)),order_entity_1=require(_0x5e5b04(0x1d0)),cramiPackage_entity_1=require(_0x5e5b04(0x18d)),utils_1=require(_0x5e5b04(0x1ad)),pay_service_1=require(_0x5e5b04(0x1c8)),globalConfig_service_1=require(_0x5e5b04(0x197));let OrderService=class OrderService{constructor(_0x1c6b7b,_0x6e41b8,_0x2ce89c,_0x363153,_0x441ab1){const _0x2011e9=_0x5e5b04;this[_0x2011e9(0x184)]=_0x1c6b7b,this['cramiPackageEntity']=_0x6e41b8,this[_0x2011e9(0x189)]=_0x2ce89c,this[_0x2011e9(0x191)]=_0x363153,this[_0x2011e9(0x1c6)]=_0x441ab1;}async[_0x5e5b04(0x1b2)](_0xc3ebde,_0x3a3655){const _0x31265a=_0x5e5b04;try{const {goodsId:_0x16960b,count:count=0x1,payType:_0x1341e7}=_0xc3ebde,{id:_0xecbcec}=_0x3a3655[_0x31265a(0x1ab)];if(_0xecbcec>0xf4240)throw new common_1['HttpException'](_0x31265a(0x1d6),common_1[_0x31265a(0x1c2)][_0x31265a(0x1b4)]);const _0x474940=await this['create'](_0xecbcec,_0x16960b,count,_0x1341e7),_0x1b0020=await this[_0x31265a(0x191)]['pay'](_0xecbcec,_0x474940[_0x31265a(0x19e)],_0x1341e7);return Object['assign'](Object[_0x31265a(0x1a0)]({},_0x1b0020),{'orderId':_0x474940[_0x31265a(0x19e)],'platform':_0x474940[_0x31265a(0x1ae)],'total':_0x474940['total']});}catch(_0x4f73aa){if(_0x4f73aa[_0x31265a(0x1ac)]===0x191)throw new common_1[(_0x31265a(0x1a6))](_0x4f73aa['message'],common_1[_0x31265a(0x1c2)][_0x31265a(0x1b4)]);throw new common_1[(_0x31265a(0x1a6))](_0x4f73aa[_0x31265a(0x1b1)]||'购买失败!',common_1[_0x31265a(0x1c2)][_0x31265a(0x199)]);}}async[_0x5e5b04(0x182)](_0x26bd9b,_0x34e6d2){const _0x320c91=_0x5e5b04,{id:_0x47b301}=_0x26bd9b[_0x320c91(0x1ab)],{orderId:_0x5320a4}=_0x34e6d2,_0x27a81f=await this[_0x320c91(0x184)][_0x320c91(0x196)]({'where':{'userId':_0x47b301,'orderId':_0x5320a4}});if(!_0x27a81f)throw new common_1[(_0x320c91(0x1a6))](_0x320c91(0x1b6),common_1[_0x320c91(0x1c2)]['BAD_REQUEST']);return _0x27a81f;}async[_0x5e5b04(0x185)](_0x41fc03,_0x560cc7,_0x3c4ffb,_0x2ba9bb){const _0x30aa76=_0x5e5b04,_0x322c5f=await this[_0x30aa76(0x1c6)]['queryPayType'](),_0x2314d4=await this[_0x30aa76(0x1c9)][_0x30aa76(0x196)]({'where':{'id':_0x560cc7}});if(!_0x2314d4)throw new common_1[(_0x30aa76(0x1a6))](_0x30aa76(0x1a9),common_1['HttpStatus'][_0x30aa76(0x199)]);const _0x4c9d2f={};_0x4c9d2f[_0x30aa76(0x19e)]=(0x0,utils_1[_0x30aa76(0x1bd)])(),_0x4c9d2f[_0x30aa76(0x1d3)]=_0x41fc03,_0x4c9d2f['goodsId']=_0x560cc7,_0x4c9d2f[_0x30aa76(0x19b)]=Number(_0x2314d4[_0x30aa76(0x19b)]),_0x4c9d2f[_0x30aa76(0x1c7)]=_0x3c4ffb,_0x4c9d2f['total']=Number(_0x2314d4[_0x30aa76(0x19b)])*_0x3c4ffb,_0x4c9d2f[_0x30aa76(0x1ae)]=_0x322c5f,_0x4c9d2f[_0x30aa76(0x1a3)]=_0x2ba9bb;const _0x2d945c=await this[_0x30aa76(0x184)][_0x30aa76(0x18f)](_0x4c9d2f);return console['log']('order:\x20',_0x2d945c),_0x2d945c;}async[_0x5e5b04(0x19d)](_0x36864a,_0x357593,_0x22454d){const _0x34ed4e=_0x5e5b04;return await this[_0x34ed4e(0x184)][_0x34ed4e(0x1ba)]({'where':{'userId':_0x36864a},'order':{'id':'DESC'},'skip':(_0x357593-0x1)*_0x22454d,'take':_0x22454d});}async[_0x5e5b04(0x1d4)](_0x204ae8){const _0x1e63f7=_0x5e5b04,{page:_0x4effca,size:_0x27e3f0,userId:_0x64c1cc,platform:_0x43b66f,status:_0x1a73c6}=_0x204ae8,_0x3e8be3={};if(_0x64c1cc)_0x3e8be3['userId']=_0x64c1cc;if(_0x43b66f)_0x3e8be3[_0x1e63f7(0x1ae)]=_0x43b66f;if(_0x1a73c6)_0x3e8be3['status']=_0x1a73c6;const [_0x5e50d8,_0x2676bb]=await this[_0x1e63f7(0x184)][_0x1e63f7(0x1ba)]({'order':{'id':_0x1e63f7(0x18a)},'where':_0x3e8be3,'skip':(_0x4effca-0x1)*_0x27e3f0,'take':_0x27e3f0}),_0x52db82=_0x5e50d8['map'](_0x429058=>_0x429058[_0x1e63f7(0x1d3)]),_0x59c661=_0x5e50d8[_0x1e63f7(0x190)](_0x21d801=>_0x21d801[_0x1e63f7(0x1aa)]),_0xfe44f4=await this[_0x1e63f7(0x189)][_0x1e63f7(0x198)]({'where':{'id':(0x0,typeorm_2['In'])(_0x52db82)},'select':['id','username',_0x1e63f7(0x1bc)]}),_0x2cb794=await this[_0x1e63f7(0x1c9)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x59c661)},'select':['id',_0x1e63f7(0x1c0),'coverImg','des']});_0x5e50d8['forEach'](_0x3b7faa=>{const _0x1af0f8=_0x1e63f7;_0x3b7faa[_0x1af0f8(0x187)]=_0xfe44f4[_0x1af0f8(0x198)](_0x387327=>_0x387327['id']===_0x3b7faa['userId']),_0x3b7faa[_0x1af0f8(0x1a7)]=_0x2cb794['find'](_0x80da45=>_0x80da45['id']===_0x3b7faa[_0x1af0f8(0x1aa)]);});const _0x242155=await this['orderEntity'][_0x1e63f7(0x1a4)](_0x1e63f7(0x1b7))[_0x1e63f7(0x1a5)]('order.status\x20=\x20:status',{'status':0x1})['select'](_0x1e63f7(0x1b5),_0x1e63f7(0x1b0))[_0x1e63f7(0x1c1)]();return Object[_0x1e63f7(0x1a0)]({'rows':_0x5e50d8,'count':_0x2676bb},_0x242155);}async[_0x5e5b04(0x1bb)](_0x3de1d4){const _0x22c6c2=_0x5e5b04,{orderId:_0xc82901}=_0x3de1d4,_0x38385d=await this[_0x22c6c2(0x184)][_0x22c6c2(0x196)]({'where':{'orderId':_0xc82901}});if(!_0x38385d)throw new common_1[(_0x22c6c2(0x1a6))]('订单不存在!',common_1[_0x22c6c2(0x1c2)]['BAD_REQUEST']);return await this['orderEntity'][_0x22c6c2(0x1a1)]({'orderId':_0xc82901});}async[_0x5e5b04(0x192)](){const _0x269d62=_0x5e5b04;return await this[_0x269d62(0x184)][_0x269d62(0x1a1)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x5e5b04(0x183)])(),__param(0x0,(0x0,typeorm_1[_0x5e5b04(0x1cc)])(order_entity_1['OrderEntity'])),__param(0x1,(0x0,typeorm_1[_0x5e5b04(0x1cc)])(cramiPackage_entity_1[_0x5e5b04(0x1af)])),__param(0x2,(0x0,typeorm_1[_0x5e5b04(0x1cc)])(user_entity_1[_0x5e5b04(0x1d1)])),__metadata('design:paramtypes',[typeorm_2[_0x5e5b04(0x18c)],typeorm_2[_0x5e5b04(0x18c)],typeorm_2[_0x5e5b04(0x18c)],pay_service_1[_0x5e5b04(0x1cf)],globalConfig_service_1[_0x5e5b04(0x1bf)]])],OrderService),exports[_0x5e5b04(0x18e)]=OrderService;