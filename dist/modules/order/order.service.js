'use strict';const _0x2f881c=_0x12ac;(function(_0x3d769a,_0x2af7ea){const _0x59105e=_0x12ac,_0x1f33e6=_0x3d769a();while(!![]){try{const _0x364e28=-parseInt(_0x59105e(0xe4))/0x1+-parseInt(_0x59105e(0xda))/0x2*(parseInt(_0x59105e(0xc9))/0x3)+-parseInt(_0x59105e(0xd8))/0x4+parseInt(_0x59105e(0xee))/0x5*(-parseInt(_0x59105e(0xf0))/0x6)+parseInt(_0x59105e(0xcd))/0x7+parseInt(_0x59105e(0xb7))/0x8+-parseInt(_0x59105e(0xce))/0x9*(-parseInt(_0x59105e(0xf1))/0xa);if(_0x364e28===_0x2af7ea)break;else _0x1f33e6['push'](_0x1f33e6['shift']());}catch(_0x41895e){_0x1f33e6['push'](_0x1f33e6['shift']());}}}(_0x4b29,0xba8a0));var __decorate=this&&this[_0x2f881c(0xe0)]||function(_0x8b38e6,_0x23f7ef,_0x5c31e5,_0xfab282){const _0x37be96=_0x2f881c;var _0x3edbaf=arguments[_0x37be96(0xc8)],_0xe5a211=_0x3edbaf<0x3?_0x23f7ef:_0xfab282===null?_0xfab282=Object[_0x37be96(0xaf)](_0x23f7ef,_0x5c31e5):_0xfab282,_0x5edd0e;if(typeof Reflect===_0x37be96(0xc2)&&typeof Reflect[_0x37be96(0xa5)]==='function')_0xe5a211=Reflect[_0x37be96(0xa5)](_0x8b38e6,_0x23f7ef,_0x5c31e5,_0xfab282);else{for(var _0x4ab2cc=_0x8b38e6[_0x37be96(0xc8)]-0x1;_0x4ab2cc>=0x0;_0x4ab2cc--)if(_0x5edd0e=_0x8b38e6[_0x4ab2cc])_0xe5a211=(_0x3edbaf<0x3?_0x5edd0e(_0xe5a211):_0x3edbaf>0x3?_0x5edd0e(_0x23f7ef,_0x5c31e5,_0xe5a211):_0x5edd0e(_0x23f7ef,_0x5c31e5))||_0xe5a211;}return _0x3edbaf>0x3&&_0xe5a211&&Object['defineProperty'](_0x23f7ef,_0x5c31e5,_0xe5a211),_0xe5a211;},__metadata=this&&this['__metadata']||function(_0x2a5a64,_0x2f30c4){const _0x1e1e40=_0x2f881c;if(typeof Reflect===_0x1e1e40(0xc2)&&typeof Reflect[_0x1e1e40(0xc7)]==='function')return Reflect[_0x1e1e40(0xc7)](_0x2a5a64,_0x2f30c4);},__param=this&&this[_0x2f881c(0xb0)]||function(_0x21dc1a,_0x435ee1){return function(_0x48cb8f,_0x1a8d6f){_0x435ee1(_0x48cb8f,_0x1a8d6f,_0x21dc1a);};};Object[_0x2f881c(0xbd)](exports,_0x2f881c(0xac),{'value':!![]}),exports[_0x2f881c(0xa2)]=void 0x0;function _0x4b29(){const _0x29ce7c=['getRawOne','234367SVsLvI','25729614VWGqzc','buy','where','deleteOrder','typeorm','SUM(order.price)','HttpStatus','Injectable','findAndCount','userId','5625616VUYrNa','DESC','33340KCuZCz','InjectRepository','./order.entity','@nestjs/typeorm','../globalConfig/globalConfig.service','queryAllOrder','__decorate','select','deleteNotPay','count','960915ZKcRKX','name','create','price','queryPayType','des','OrderEntity','./../user/user.entity','BAD_REQUEST','payService','2393945zJrfcE','../../common/utils','6mYLUGz','10gDbyPw','CramiPackageEntity','queryByOrderId','findOne','username','OrderService','email','购买失败!','decorate','orderId','orderEntity','globalConfigService','user','cramiPackageEntity','payPlatform','__esModule','pay','save','getOwnPropertyDescriptor','__param','PayService','log','order','find','HttpException','map','7876520MnvkkW','Repository','status','请先注册账号后购买商品！','assign','订单不存在!','defineProperty','delete','coverImg','UNAUTHORIZED','message','object','order:\x20','userInfo','createQueryBuilder','套餐不存在!','metadata','length','48lbMWIi','userEntity','@nestjs/common'];_0x4b29=function(){return _0x29ce7c;};return _0x4b29();}function _0x12ac(_0x528ce7,_0x5d71df){const _0x4b2960=_0x4b29();return _0x12ac=function(_0x12acb8,_0x10f526){_0x12acb8=_0x12acb8-0x9e;let _0x1cd8d8=_0x4b2960[_0x12acb8];return _0x1cd8d8;},_0x12ac(_0x528ce7,_0x5d71df);}const user_entity_1=require(_0x2f881c(0xeb)),typeorm_1=require(_0x2f881c(0xdd)),common_1=require(_0x2f881c(0xcb)),typeorm_2=require(_0x2f881c(0xd2)),order_entity_1=require(_0x2f881c(0xdc)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),utils_1=require(_0x2f881c(0xef)),pay_service_1=require('../pay/pay.service'),globalConfig_service_1=require(_0x2f881c(0xde));let OrderService=class OrderService{constructor(_0x20643b,_0x53809f,_0x207c3b,_0x5c6bd3,_0x5b4eca){const _0x5c6c3c=_0x2f881c;this['orderEntity']=_0x20643b,this[_0x5c6c3c(0xaa)]=_0x53809f,this[_0x5c6c3c(0xca)]=_0x207c3b,this[_0x5c6c3c(0xed)]=_0x5c6bd3,this[_0x5c6c3c(0xa8)]=_0x5b4eca;}async[_0x2f881c(0xcf)](_0x2572d5,_0x3f2fa6){const _0x29cb83=_0x2f881c;try{const {goodsId:_0x41fa84,count:count=0x1,payType:_0x3a3069}=_0x2572d5,{id:_0x8505bc}=_0x3f2fa6[_0x29cb83(0xa9)];if(_0x8505bc>0xf4240)throw new common_1['HttpException'](_0x29cb83(0xba),common_1[_0x29cb83(0xd4)][_0x29cb83(0xc0)]);const _0x53b5dd=await this[_0x29cb83(0xe6)](_0x8505bc,_0x41fa84,count,_0x3a3069),_0x2b5177=await this[_0x29cb83(0xed)][_0x29cb83(0xad)](_0x8505bc,_0x53b5dd['orderId'],_0x3a3069);return Object['assign'](Object['assign']({},_0x2b5177),{'orderId':_0x53b5dd[_0x29cb83(0xa6)],'platform':_0x53b5dd[_0x29cb83(0xab)],'total':Number(_0x53b5dd['total'])});}catch(_0x11b8bc){if(_0x11b8bc[_0x29cb83(0xb9)]===0x191)throw new common_1['HttpException'](_0x11b8bc['message'],common_1[_0x29cb83(0xd4)][_0x29cb83(0xc0)]);throw new common_1[(_0x29cb83(0xb5))](_0x11b8bc[_0x29cb83(0xc1)]||_0x29cb83(0xa4),common_1[_0x29cb83(0xd4)][_0x29cb83(0xec)]);}}async[_0x2f881c(0x9f)](_0x4c8488,_0x596d78){const _0x7428fe=_0x2f881c,{id:_0x12c350}=_0x4c8488[_0x7428fe(0xa9)],{orderId:_0x2da8a5}=_0x596d78,_0xac3903=await this[_0x7428fe(0xa7)][_0x7428fe(0xa0)]({'where':{'userId':_0x12c350,'orderId':_0x2da8a5}});if(!_0xac3903)throw new common_1[(_0x7428fe(0xb5))](_0x7428fe(0xbc),common_1[_0x7428fe(0xd4)][_0x7428fe(0xec)]);return _0xac3903;}async[_0x2f881c(0xe6)](_0x222df9,_0x32ae77,_0x1dac72,_0x309024){const _0x2e4f52=_0x2f881c,_0x1bebc4=await this['globalConfigService'][_0x2e4f52(0xe8)](),_0x234471=await this[_0x2e4f52(0xaa)]['findOne']({'where':{'id':_0x32ae77}});if(!_0x234471)throw new common_1[(_0x2e4f52(0xb5))](_0x2e4f52(0xc6),common_1['HttpStatus']['BAD_REQUEST']);const _0x51726d={};_0x51726d[_0x2e4f52(0xa6)]=(0x0,utils_1['createOrderId'])(),_0x51726d[_0x2e4f52(0xd7)]=_0x222df9,_0x51726d['goodsId']=_0x32ae77,_0x51726d[_0x2e4f52(0xe7)]=Number(_0x234471['price']),_0x51726d[_0x2e4f52(0xe3)]=_0x1dac72,_0x51726d['total']=_0x234471[_0x2e4f52(0xe7)],_0x51726d[_0x2e4f52(0xab)]=_0x1bebc4,_0x51726d['channel']=_0x309024;const _0x186cc8=await this[_0x2e4f52(0xa7)][_0x2e4f52(0xae)](_0x51726d);return console[_0x2e4f52(0xb2)](_0x2e4f52(0xc3),_0x186cc8),_0x186cc8;}async['query'](_0x483eb3,_0x2196b9,_0x1fffad){const _0x124b19=_0x2f881c;return await this['orderEntity'][_0x124b19(0xd6)]({'where':{'userId':_0x483eb3},'order':{'id':_0x124b19(0xd9)},'skip':(_0x2196b9-0x1)*_0x1fffad,'take':_0x1fffad});}async[_0x2f881c(0xdf)](_0xa05a61){const _0x14bcd5=_0x2f881c,{page:_0x1a584d,size:_0x18854b,userId:_0x28a5fa,platform:_0x523c7b,status:_0x5a57b1}=_0xa05a61,_0x6b3ae={};if(_0x28a5fa)_0x6b3ae[_0x14bcd5(0xd7)]=_0x28a5fa;if(_0x523c7b)_0x6b3ae[_0x14bcd5(0xab)]=_0x523c7b;if(_0x5a57b1)_0x6b3ae['status']=_0x5a57b1;const [_0x78ee7,_0x226a32]=await this[_0x14bcd5(0xa7)][_0x14bcd5(0xd6)]({'order':{'id':_0x14bcd5(0xd9)},'where':_0x6b3ae,'skip':(_0x1a584d-0x1)*_0x18854b,'take':_0x18854b}),_0x5eaa89=_0x78ee7[_0x14bcd5(0xb6)](_0x196371=>_0x196371[_0x14bcd5(0xd7)]),_0x2af662=_0x78ee7[_0x14bcd5(0xb6)](_0x4264ba=>_0x4264ba['goodsId']),_0xbb8ba9=await this[_0x14bcd5(0xca)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x5eaa89)},'select':['id',_0x14bcd5(0xa1),_0x14bcd5(0xa3)]}),_0x10c06d=await this[_0x14bcd5(0xaa)][_0x14bcd5(0xb4)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2af662)},'select':['id',_0x14bcd5(0xe5),_0x14bcd5(0xbf),_0x14bcd5(0xe9)]});_0x78ee7['forEach'](_0xbe6566=>{const _0x178c4d=_0x14bcd5;_0xbe6566[_0x178c4d(0xc4)]=_0xbb8ba9[_0x178c4d(0xb4)](_0xd8bed6=>_0xd8bed6['id']===_0xbe6566[_0x178c4d(0xd7)]),_0xbe6566['goodsInfo']=_0x10c06d[_0x178c4d(0xb4)](_0x1d6bbf=>_0x1d6bbf['id']===_0xbe6566['goodsId']);});const _0x29b26c=await this['orderEntity'][_0x14bcd5(0xc5)](_0x14bcd5(0xb3))[_0x14bcd5(0xd0)]('order.status\x20=\x20:status',{'status':0x1})[_0x14bcd5(0xe1)](_0x14bcd5(0xd3),'total_price')[_0x14bcd5(0xcc)]();return Object[_0x14bcd5(0xbb)]({'rows':_0x78ee7,'count':_0x226a32},_0x29b26c);}async[_0x2f881c(0xd1)](_0x20148e){const _0x585b87=_0x2f881c,{orderId:_0x46bc43}=_0x20148e,_0x31b2dc=await this[_0x585b87(0xa7)]['findOne']({'where':{'orderId':_0x46bc43}});if(!_0x31b2dc)throw new common_1[(_0x585b87(0xb5))](_0x585b87(0xbc),common_1[_0x585b87(0xd4)][_0x585b87(0xec)]);return await this['orderEntity'][_0x585b87(0xbe)]({'orderId':_0x46bc43});}async[_0x2f881c(0xe2)](){const _0x5efcb5=_0x2f881c;return await this['orderEntity'][_0x5efcb5(0xbe)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x2f881c(0xd5)])(),__param(0x0,(0x0,typeorm_1[_0x2f881c(0xdb)])(order_entity_1[_0x2f881c(0xea)])),__param(0x1,(0x0,typeorm_1[_0x2f881c(0xdb)])(cramiPackage_entity_1[_0x2f881c(0x9e)])),__param(0x2,(0x0,typeorm_1[_0x2f881c(0xdb)])(user_entity_1['UserEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x2f881c(0xb8)],typeorm_2['Repository'],typeorm_2['Repository'],pay_service_1[_0x2f881c(0xb1)],globalConfig_service_1['GlobalConfigService']])],OrderService),exports[_0x2f881c(0xa2)]=OrderService;