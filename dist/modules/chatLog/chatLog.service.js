'use strict';function _0x2309(_0x5baccf,_0x286851){const _0x88bfec=_0x88bf();return _0x2309=function(_0x230960,_0x5302f8){_0x230960=_0x230960-0x194;let _0x43458b=_0x88bfec[_0x230960];return _0x43458b;},_0x2309(_0x5baccf,_0x286851);}const _0x355668=_0x2309;(function(_0x5516fa,_0x149986){const _0x4d1a64=_0x2309,_0x3744b1=_0x5516fa();while(!![]){try{const _0x18c53c=parseInt(_0x4d1a64(0x1f2))/0x1*(parseInt(_0x4d1a64(0x1b4))/0x2)+-parseInt(_0x4d1a64(0x1b5))/0x3*(parseInt(_0x4d1a64(0x1b0))/0x4)+parseInt(_0x4d1a64(0x1ce))/0x5*(parseInt(_0x4d1a64(0x1d0))/0x6)+-parseInt(_0x4d1a64(0x1fc))/0x7+-parseInt(_0x4d1a64(0x206))/0x8*(parseInt(_0x4d1a64(0x19c))/0x9)+parseInt(_0x4d1a64(0x1dc))/0xa+parseInt(_0x4d1a64(0x19d))/0xb;if(_0x18c53c===_0x149986)break;else _0x3744b1['push'](_0x3744b1['shift']());}catch(_0x2403dc){_0x3744b1['push'](_0x3744b1['shift']());}}}(_0x88bf,0xa4b23));var __decorate=this&&this['__decorate']||function(_0x39bb76,_0xf9d6f,_0xd1d926,_0x146dde){const _0x21c984=_0x2309;var _0x4e2a71=arguments['length'],_0x3eea33=_0x4e2a71<0x3?_0xf9d6f:_0x146dde===null?_0x146dde=Object[_0x21c984(0x1a1)](_0xf9d6f,_0xd1d926):_0x146dde,_0xb89fd4;if(typeof Reflect===_0x21c984(0x1f1)&&typeof Reflect[_0x21c984(0x1df)]===_0x21c984(0x1ea))_0x3eea33=Reflect[_0x21c984(0x1df)](_0x39bb76,_0xf9d6f,_0xd1d926,_0x146dde);else{for(var _0x5d9438=_0x39bb76[_0x21c984(0x1f3)]-0x1;_0x5d9438>=0x0;_0x5d9438--)if(_0xb89fd4=_0x39bb76[_0x5d9438])_0x3eea33=(_0x4e2a71<0x3?_0xb89fd4(_0x3eea33):_0x4e2a71>0x3?_0xb89fd4(_0xf9d6f,_0xd1d926,_0x3eea33):_0xb89fd4(_0xf9d6f,_0xd1d926))||_0x3eea33;}return _0x4e2a71>0x3&&_0x3eea33&&Object[_0x21c984(0x1fb)](_0xf9d6f,_0xd1d926,_0x3eea33),_0x3eea33;},__metadata=this&&this[_0x355668(0x1bb)]||function(_0xbd31fe,_0x259847){const _0xe0ca7d=_0x355668;if(typeof Reflect===_0xe0ca7d(0x1f1)&&typeof Reflect[_0xe0ca7d(0x1bf)]===_0xe0ca7d(0x1ea))return Reflect[_0xe0ca7d(0x1bf)](_0xbd31fe,_0x259847);},__param=this&&this[_0x355668(0x1ec)]||function(_0x40c103,_0x323b8f){return function(_0xa55a3d,_0x2eba9b){_0x323b8f(_0xa55a3d,_0x2eba9b,_0x40c103);};};function _0x88bf(){const _0x582fa1=['@nestjs/typeorm','typeorm','../chatGroup/chatGroup.entity','Like','__metadata','deleteChatLog','取消推荐','PAINT_TYPE','metadata','formatDate','type','update','chatlog','affected','你推荐的图片不存在、请检查！','querAllChatLog','thumbImg','findAndCount','ChatLogService','error:\x20','email','username','fileInfo','5malTyV','userId','7148742ebQJEA','图片成功！','maskEmail','addWorksheet','count','parse','createdAt','model','forEach','tencent','querAllDrawLog\x20Json\x20parse\x20error','default','9556400bKqpnh','ChatGroupEntity','HttpException','decorate','group','chatGroupEntity','cos','saveChatLog','Repository','includes','querAllDrawLog','components','attachment;\x20filename=','DeductionKey','function','BAD_REQUEST','__param','byAppId','paintCount','__esModule','提问时间','object','352724pNozny','length','DESC','super','./chatLog.entity','recDrawImg','chat.xlsx','你删除的对话记录不存在、请检查！','DALL-E2','defineProperty','7759696jntPcR','find','删除对话记录成功！','delByGroupId','dall-e-3','user','/q/55','prompt','map','addRow','4612232hmNVPi','InjectRepository','role','message_id','findOne','@default.com','log','Not','ChatLogEntity','ali','Content-Disposition','isGroup','exceljs','9JbGtsa','9510479ZCNaqV','assign','?imageView2/1/w/','chatLogEntity','getOwnPropertyDescriptor','UserEntity','用户邮箱','?x-oss-process=image/resize,w_','CHAT_TYPE','@nestjs/common','answer','setHeader','xlsx','Content-Type','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','rec','write','design:paramtypes','chatList','152BzrcHR','你操作的图片不存在、请检查！','extend','HttpStatus','2MVqRYn','79323SytdzR','userEntity'];_0x88bf=function(){return _0x582fa1;};return _0x88bf();}Object[_0x355668(0x1fb)](exports,_0x355668(0x1ef),{'value':!![]}),exports[_0x355668(0x1c9)]=void 0x0;const common_1=require(_0x355668(0x1a6)),typeorm_1=require(_0x355668(0x1b7)),chatLog_entity_1=require(_0x355668(0x1f6)),typeorm_2=require(_0x355668(0x1b8)),balance_constant_1=require('../../common/constants/balance.constant'),user_entity_1=require('../user/user.entity'),utils_1=require('../../common/utils'),exceljs_1=require(_0x355668(0x19b)),chatGroup_entity_1=require(_0x355668(0x1b9));let ChatLogService=class ChatLogService{constructor(_0x12b42b,_0xd72660,_0x33b071){const _0x2dea8d=_0x355668;this[_0x2dea8d(0x1a0)]=_0x12b42b,this[_0x2dea8d(0x1b6)]=_0xd72660,this['chatGroupEntity']=_0x33b071;}async[_0x355668(0x1e3)](_0x17a1f6){const _0x29d95d=_0x355668;return await this[_0x29d95d(0x1a0)]['save'](_0x17a1f6);}['getChatInfoFromId'](_0x133cec){const _0x548b50=_0x355668;return this['chatLogEntity'][_0x548b50(0x20a)]({'where':{'id':_0x133cec}});}async['querDrawLog'](_0x4c91b4,_0x2bf3bb){const _0x12a065=_0x355668,{id:_0x164a43}=_0x4c91b4[_0x12a065(0x201)],{model:_0x46360a}=_0x2bf3bb,_0xeaa181={'userId':_0x164a43,'type':balance_constant_1['DeductionKey'][_0x12a065(0x1be)]};_0x46360a&&(_0xeaa181[_0x12a065(0x1d7)]=_0x46360a,_0x46360a===_0x12a065(0x1fa)&&(_0xeaa181['model']=(0x0,typeorm_2['In'])([_0x12a065(0x1fa),_0x12a065(0x200)])));const _0x44e3fb=await this[_0x12a065(0x1a0)][_0x12a065(0x1fd)]({'where':_0xeaa181,'order':{'id':'DESC'},'select':['id',_0x12a065(0x1a7),_0x12a065(0x203),_0x12a065(0x209),_0x12a065(0x1e0),'model',_0x12a065(0x1b2),_0x12a065(0x1c1),_0x12a065(0x1cd)]});return _0x44e3fb['forEach'](_0x5dad65=>{const _0x2d2762=_0x12a065;if(_0x5dad65[_0x2d2762(0x1c1)]===_0x2d2762(0x1ee)){const _0x5f1a4d=_0x5dad65['model']==='mj'?0x136:0xa0,_0x412089=_0x5dad65['answer'][_0x2d2762(0x1e5)](_0x2d2762(0x1e2))?_0x2d2762(0x1d9):_0x2d2762(0x198),_0xcd3230=_0x412089===_0x2d2762(0x1d9)?'?imageView2/1/w/'+_0x5f1a4d+_0x2d2762(0x202):_0x2d2762(0x1a4)+_0x5f1a4d;_0x5dad65['thumbImg']=_0x5dad65[_0x2d2762(0x1a7)]+_0xcd3230;try{_0x5dad65[_0x2d2762(0x1cd)]=_0x5dad65[_0x2d2762(0x1cd)]?JSON[_0x2d2762(0x1d5)](_0x5dad65[_0x2d2762(0x1cd)]):null;}catch(_0x34367e){_0x5dad65[_0x2d2762(0x1cd)]={};}}}),_0x44e3fb;}async[_0x355668(0x1e6)](_0x342bfe){const _0x5bdd99=_0x355668,{page:page=0x1,size:size=0x14,rec:_0x426965,userId:_0xe5dd16,model:_0x2c4c33}=_0x342bfe,_0xf99991={'type':balance_constant_1[_0x5bdd99(0x1e9)][_0x5bdd99(0x1be)],'prompt':(0x0,typeorm_2[_0x5bdd99(0x196)])(''),'answer':(0x0,typeorm_2[_0x5bdd99(0x196)])('')};_0x426965&&Object['assign'](_0xf99991,{'rec':_0x426965}),_0xe5dd16&&Object[_0x5bdd99(0x19e)](_0xf99991,{'userId':_0xe5dd16});_0x2c4c33&&(_0xf99991[_0x5bdd99(0x1d7)]=_0x2c4c33,_0x2c4c33==='DALL-E2'&&(_0xf99991['model']=(0x0,typeorm_2['In'])([_0x5bdd99(0x1fa),'dall-e-3'])));const [_0xd0e5e9,_0x33597b]=await this[_0x5bdd99(0x1a0)][_0x5bdd99(0x1c8)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0xf99991});return _0xd0e5e9[_0x5bdd99(0x1d8)](_0x1aa5c3=>{const _0x2a3cfb=_0x5bdd99;var _0x16bf0f;if(_0x1aa5c3[_0x2a3cfb(0x1c1)]===_0x2a3cfb(0x1ee)){const _0x213e4e=_0x1aa5c3[_0x2a3cfb(0x1d7)]==='mj'?0x136:0xa0,_0x209405=_0x1aa5c3['answer'][_0x2a3cfb(0x1e5)](_0x2a3cfb(0x1e2))?_0x2a3cfb(0x1d9):_0x2a3cfb(0x198),_0x546bb1=_0x209405==='tencent'?_0x2a3cfb(0x19f)+_0x213e4e+'/q/55':_0x2a3cfb(0x1a4)+_0x213e4e;_0x1aa5c3[_0x2a3cfb(0x1c7)]=_0x1aa5c3[_0x2a3cfb(0x1a7)]+_0x546bb1;try{const _0x320494=_0x1aa5c3[_0x2a3cfb(0x1b2)]?JSON['parse'](_0x1aa5c3[_0x2a3cfb(0x1b2)]):null;_0x320494&&(_0x320494?_0x1aa5c3[_0x2a3cfb(0x19a)]=((_0x16bf0f=_0x320494===null||_0x320494===void 0x0?void 0x0:_0x320494[_0x2a3cfb(0x1e7)][0x0])===null||_0x16bf0f===void 0x0?void 0x0:_0x16bf0f[_0x2a3cfb(0x1e7)]['length'])===0x5:_0x1aa5c3['isGroup']=![]);}catch(_0x4fb3b7){console[_0x2a3cfb(0x195)](_0x2a3cfb(0x1da),_0x4fb3b7);}}}),{'rows':_0xd0e5e9,'count':_0x33597b};}async[_0x355668(0x1f7)](_0x1d1dc0){const _0x4af4a3=_0x355668,{id:_0x160556}=_0x1d1dc0,_0x473e5c=await this[_0x4af4a3(0x1a0)][_0x4af4a3(0x20a)]({'where':{'id':_0x160556,'type':balance_constant_1[_0x4af4a3(0x1e9)][_0x4af4a3(0x1be)]}});if(!_0x473e5c)throw new common_1[(_0x4af4a3(0x1de))](_0x4af4a3(0x1c5),common_1['HttpStatus'][_0x4af4a3(0x1eb)]);const _0x42fdc4=_0x473e5c[_0x4af4a3(0x1ac)]===0x1?0x0:0x1,_0x5c79d0=await this[_0x4af4a3(0x1a0)]['update']({'id':_0x160556},{'rec':_0x42fdc4});if(_0x5c79d0[_0x4af4a3(0x1c4)]>0x0)return(_0x42fdc4?'推荐':_0x4af4a3(0x1bd))+_0x4af4a3(0x1d1);throw new common_1[(_0x4af4a3(0x1de))](_0x4af4a3(0x1b1),common_1['HttpStatus'][_0x4af4a3(0x1eb)]);}async['exportExcel'](_0x546fe7,_0x13fd38){const _0x567fa8=_0x355668,_0x237b5a={'type':balance_constant_1[_0x567fa8(0x1e9)][_0x567fa8(0x1a5)]},{page:page=0x1,size:size=0x1e,prompt:_0x4d4993,email:_0x4542d7}=_0x546fe7;_0x4d4993&&Object[_0x567fa8(0x19e)](_0x237b5a,{'prompt':(0x0,typeorm_2[_0x567fa8(0x1ba)])('%'+_0x4d4993+'%')});if(_0x4542d7){const _0xf0ebaa=await this[_0x567fa8(0x1b6)][_0x567fa8(0x20a)]({'where':{'email':_0x4542d7}});(_0xf0ebaa===null||_0xf0ebaa===void 0x0?void 0x0:_0xf0ebaa['id'])&&Object['assign'](_0x237b5a,{'userId':_0xf0ebaa['id']});}const [_0x24d3c1,_0x526208]=await this[_0x567fa8(0x1a0)][_0x567fa8(0x1c8)]({'order':{'id':_0x567fa8(0x1f4)},'skip':(page-0x1)*size,'take':size,'where':_0x237b5a}),_0x576814=_0x24d3c1[_0x567fa8(0x204)](_0x1914c2=>_0x1914c2[_0x567fa8(0x1cf)]),_0x4b5458=await this[_0x567fa8(0x1b6)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x576814)}}),_0x4a147a=_0x24d3c1['map'](_0x16eda8=>{const _0x561d12=_0x567fa8,_0x4fb657=_0x4b5458[_0x561d12(0x1fd)](_0x4ba09b=>_0x4ba09b['id']===_0x16eda8['userId']);return{'username':_0x4fb657?_0x4fb657['username']:'','email':_0x4fb657?_0x4fb657[_0x561d12(0x1cb)]:'','prompt':_0x16eda8['prompt'],'answer':_0x16eda8[_0x561d12(0x1a7)],'createdAt':(0x0,utils_1[_0x561d12(0x1c0)])(_0x16eda8['createdAt'])};}),_0x7f2cba=new exceljs_1[(_0x567fa8(0x1db))]['Workbook'](),_0x2403fd=_0x7f2cba[_0x567fa8(0x1d3)](_0x567fa8(0x1c3));_0x2403fd['columns']=[{'header':'用户名','key':_0x567fa8(0x1cc),'width':0x14},{'header':_0x567fa8(0x1a3),'key':_0x567fa8(0x1cb),'width':0x14},{'header':_0x567fa8(0x1f0),'key':_0x567fa8(0x1d6),'width':0x14},{'header':'提问问题','key':_0x567fa8(0x203),'width':0x50},{'header':'回答答案','key':_0x567fa8(0x1a7),'width':0x96}],_0x4a147a[_0x567fa8(0x1d8)](_0x4c0430=>_0x2403fd[_0x567fa8(0x205)](_0x4c0430)),_0x13fd38[_0x567fa8(0x1a8)](_0x567fa8(0x1aa),_0x567fa8(0x1ab)),_0x13fd38[_0x567fa8(0x1a8)](_0x567fa8(0x199),_0x567fa8(0x1e8)+_0x567fa8(0x1f8)),await _0x7f2cba[_0x567fa8(0x1a9)][_0x567fa8(0x1ad)](_0x13fd38),_0x13fd38['end']();}async[_0x355668(0x1c6)](_0x182dc8,_0x2581db){const _0x5dbb64=_0x355668,{page:page=0x1,size:size=0x14,userId:_0x25e36e,prompt:_0x3d451e}=_0x182dc8,_0x3ce8d0={'type':balance_constant_1[_0x5dbb64(0x1e9)][_0x5dbb64(0x1a5)],'prompt':(0x0,typeorm_2[_0x5dbb64(0x196)])('')};_0x25e36e&&Object[_0x5dbb64(0x19e)](_0x3ce8d0,{'userId':_0x25e36e}),_0x3d451e&&Object[_0x5dbb64(0x19e)](_0x3ce8d0,{'prompt':(0x0,typeorm_2[_0x5dbb64(0x1ba)])('%'+_0x3d451e+'%')});const [_0x5844af,_0x4f771a]=await this[_0x5dbb64(0x1a0)]['findAndCount']({'order':{'id':_0x5dbb64(0x1f4)},'skip':(page-0x1)*size,'take':size,'where':_0x3ce8d0}),_0x106074=_0x5844af[_0x5dbb64(0x204)](_0x22b3bb=>_0x22b3bb[_0x5dbb64(0x1cf)]),_0x563762=await this[_0x5dbb64(0x1b6)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x106074)},'select':['id',_0x5dbb64(0x1cc),_0x5dbb64(0x1cb)]});return _0x5844af[_0x5dbb64(0x1d8)](_0x549ed5=>{const _0x151d10=_0x5dbb64,{username:_0x4aca8f,email:_0xa0cf58}=_0x563762[_0x151d10(0x1fd)](_0x3a4bf7=>_0x3a4bf7['id']===_0x549ed5[_0x151d10(0x1cf)])||{};_0x549ed5[_0x151d10(0x1cc)]=_0x4aca8f,_0x549ed5[_0x151d10(0x1cb)]=_0xa0cf58;}),_0x2581db[_0x5dbb64(0x201)][_0x5dbb64(0x208)]!==_0x5dbb64(0x1f5)&&_0x5844af['forEach'](_0x20c9c4=>_0x20c9c4[_0x5dbb64(0x1cb)]=(0x0,utils_1[_0x5dbb64(0x1d2)])(_0x20c9c4['email'])),_0x5844af['forEach'](_0x5bbf48=>{const _0x115d70=_0x5dbb64;!_0x5bbf48['email']&&(_0x5bbf48[_0x115d70(0x1cb)]=(_0x5bbf48===null||_0x5bbf48===void 0x0?void 0x0:_0x5bbf48[_0x115d70(0x1cf)])+_0x115d70(0x194)),!_0x5bbf48['username']&&(_0x5bbf48['username']='游客'+(_0x5bbf48===null||_0x5bbf48===void 0x0?void 0x0:_0x5bbf48[_0x115d70(0x1cf)]));}),{'rows':_0x5844af,'count':_0x4f771a};}async[_0x355668(0x1af)](_0x2c99c2,_0x47b688){const _0x51f74e=_0x355668,{id:_0x321b8e}=_0x2c99c2[_0x51f74e(0x201)],{groupId:_0x43753a}=_0x47b688,_0x1283c6={'userId':_0x321b8e,'isDelete':![]};_0x43753a&&Object[_0x51f74e(0x19e)](_0x1283c6,{'groupId':_0x43753a});if(_0x43753a){const _0x2e40e6=await this[_0x51f74e(0x1e1)][_0x51f74e(0x1d4)]({'where':{'isDelete':![]}});if(_0x2e40e6===0x0)return[];}const _0x38d3d6=await this['chatLogEntity'][_0x51f74e(0x1fd)]({'where':_0x1283c6});return _0x38d3d6[_0x51f74e(0x204)](_0xb65686=>{const _0x300083=_0x51f74e,{prompt:_0x424308,role:_0x3482cd,answer:_0x4c395e,createdAt:_0x4b8201,model:_0x4fb3ee,conversationOptions:_0x4f393e,requestOptions:_0x32c9a1,id:_0x378669,promptTokens:_0x32eaff,completionTokens:_0x26ae48,totalTokens:_0x1fbdf7,tts:_0x35a537,file:_0x1ea763}=_0xb65686;let _0x44a78b=null,_0x4a9247=null;try{_0x44a78b=JSON[_0x300083(0x1d5)](_0x4f393e),_0x4a9247=JSON['parse'](_0x32c9a1);}catch(_0xe714a){console[_0x300083(0x195)](_0x300083(0x1ca),_0xe714a);}return{'chatId':_0x378669,'tts':_0x35a537,'dateTime':(0x0,utils_1[_0x300083(0x1c0)])(_0x4b8201),'text':_0x3482cd===_0x300083(0x201)?_0x424308:_0x4c395e,'inversion':_0x3482cd==='user','error':![],'conversationOptions':_0x44a78b,'requestOptions':_0x4a9247,'promptTokens':_0x32eaff,'completionTokens':_0x26ae48,'totalTokens':_0x1fbdf7,'file':_0x1ea763};});}async[_0x355668(0x1bc)](_0x27b1e8,_0x3aaedf){const _0x1260e5=_0x355668,{id:_0x169c8e}=_0x27b1e8['user'],{id:_0x32dba0}=_0x3aaedf,_0x23ff93=await this[_0x1260e5(0x1a0)][_0x1260e5(0x20a)]({'where':{'id':_0x32dba0,'userId':_0x169c8e}});if(!_0x23ff93)throw new common_1[(_0x1260e5(0x1de))](_0x1260e5(0x1f9),common_1[_0x1260e5(0x1b3)][_0x1260e5(0x1eb)]);const _0x204309=await this[_0x1260e5(0x1a0)][_0x1260e5(0x1c2)]({'id':_0x32dba0},{'isDelete':!![]});if(_0x204309[_0x1260e5(0x1c4)]>0x0)return _0x1260e5(0x1fe);else throw new common_1[(_0x1260e5(0x1de))](_0x1260e5(0x1f9),common_1['HttpStatus'][_0x1260e5(0x1eb)]);}async[_0x355668(0x1ff)](_0xef5ca7,_0x15a81){const _0x1418b6=_0x355668,{groupId:_0x5ca844}=_0x15a81,{id:_0x489d11}=_0xef5ca7[_0x1418b6(0x201)],_0xfea850=await this['chatGroupEntity'][_0x1418b6(0x20a)]({'where':{'id':_0x5ca844,'userId':_0x489d11}});if(!_0xfea850)throw new common_1['HttpException'](_0x1418b6(0x1f9),common_1[_0x1418b6(0x1b3)][_0x1418b6(0x1eb)]);const _0x23f4c3=await this[_0x1418b6(0x1a0)]['update']({'groupId':_0x5ca844},{'isDelete':!![]});if(_0x23f4c3[_0x1418b6(0x1c4)]>0x0)return _0x1418b6(0x1fe);if(_0x23f4c3[_0x1418b6(0x1c4)]===0x0)throw new common_1[(_0x1418b6(0x1de))]('当前页面已经没有东西可以删除了！',common_1['HttpStatus'][_0x1418b6(0x1eb)]);}async[_0x355668(0x1ed)](_0x3d5832,_0x35c337){const _0x50c305=_0x355668,{id:_0x5c43d2}=_0x3d5832[_0x50c305(0x201)],{appId:_0x514787,page:page=0x1,size:size=0xa}=_0x35c337,[_0x52fb84,_0xf186c6]=await this[_0x50c305(0x1a0)][_0x50c305(0x1c8)]({'where':{'userId':_0x5c43d2,'appId':_0x514787,'role':'assistant'},'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size});return{'rows':_0x52fb84,'count':_0xf186c6};}};ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x355668(0x207)])(chatLog_entity_1[_0x355668(0x197)])),__param(0x1,(0x0,typeorm_1[_0x355668(0x207)])(user_entity_1[_0x355668(0x1a2)])),__param(0x2,(0x0,typeorm_1[_0x355668(0x207)])(chatGroup_entity_1[_0x355668(0x1dd)])),__metadata(_0x355668(0x1ae),[typeorm_2[_0x355668(0x1e4)],typeorm_2['Repository'],typeorm_2[_0x355668(0x1e4)]])],ChatLogService),exports['ChatLogService']=ChatLogService;