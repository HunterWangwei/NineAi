'use strict';const _0x1c5eec=_0x2486;(function(_0x5173c9,_0x1857db){const _0x1bdbce=_0x2486,_0x477b3f=_0x5173c9();while(!![]){try{const _0x423444=parseInt(_0x1bdbce(0x19a))/0x1*(-parseInt(_0x1bdbce(0x193))/0x2)+parseInt(_0x1bdbce(0x161))/0x3+parseInt(_0x1bdbce(0x185))/0x4+-parseInt(_0x1bdbce(0x18f))/0x5*(parseInt(_0x1bdbce(0x181))/0x6)+parseInt(_0x1bdbce(0x174))/0x7*(-parseInt(_0x1bdbce(0x16f))/0x8)+parseInt(_0x1bdbce(0x15b))/0x9*(parseInt(_0x1bdbce(0x178))/0xa)+parseInt(_0x1bdbce(0x13c))/0xb*(parseInt(_0x1bdbce(0x16d))/0xc);if(_0x423444===_0x1857db)break;else _0x477b3f['push'](_0x477b3f['shift']());}catch(_0x438063){_0x477b3f['push'](_0x477b3f['shift']());}}}(_0x499e,0x22a78));var __decorate=this&&this[_0x1c5eec(0x17b)]||function(_0x21361b,_0x43063b,_0x22a158,_0x261945){const _0x453bf5=_0x1c5eec;var _0x5093ec=arguments['length'],_0x1ca353=_0x5093ec<0x3?_0x43063b:_0x261945===null?_0x261945=Object[_0x453bf5(0x155)](_0x43063b,_0x22a158):_0x261945,_0x46c63e;if(typeof Reflect===_0x453bf5(0x182)&&typeof Reflect[_0x453bf5(0x168)]===_0x453bf5(0x18b))_0x1ca353=Reflect[_0x453bf5(0x168)](_0x21361b,_0x43063b,_0x22a158,_0x261945);else{for(var _0x3bc6f3=_0x21361b[_0x453bf5(0x176)]-0x1;_0x3bc6f3>=0x0;_0x3bc6f3--)if(_0x46c63e=_0x21361b[_0x3bc6f3])_0x1ca353=(_0x5093ec<0x3?_0x46c63e(_0x1ca353):_0x5093ec>0x3?_0x46c63e(_0x43063b,_0x22a158,_0x1ca353):_0x46c63e(_0x43063b,_0x22a158))||_0x1ca353;}return _0x5093ec>0x3&&_0x1ca353&&Object[_0x453bf5(0x198)](_0x43063b,_0x22a158,_0x1ca353),_0x1ca353;},__metadata=this&&this[_0x1c5eec(0x140)]||function(_0x23a36a,_0x1e0328){const _0x5c1e7b=_0x1c5eec;if(typeof Reflect===_0x5c1e7b(0x182)&&typeof Reflect['metadata']===_0x5c1e7b(0x18b))return Reflect[_0x5c1e7b(0x19c)](_0x23a36a,_0x1e0328);},__param=this&&this[_0x1c5eec(0x15f)]||function(_0x6b5be8,_0x109fdb){return function(_0x4f31fb,_0x3f3de5){_0x109fdb(_0x4f31fb,_0x3f3de5,_0x6b5be8);};};function _0x499e(){const _0x4ede20=['10VTqQtX','UserEntity','model','__decorate','chatlog','tencent','Not','answer','querAllDrawLog\x20Json\x20parse\x20error','246sbEWWf','object','includes','BAD_REQUEST','755804YvAXst','super','取消推荐','addRow','querAllDrawLog','DeductionKey','function','/q/55','你删除的对话记录不存在、请检查！','deleteChatLog','8285AEUPBd','username','?x-oss-process=image/resize,w_','dall-e-3','2CjUZTX','createdAt','formatDate','querAllChatLog','saveChatLog','defineProperty','map','238207CGrDts','byAppId','metadata','userId','@nestjs/typeorm','userEntity','email','paintCount','fileInfo','cos','prompt','setHeader','ChatGroupEntity','extend','maskEmail','HttpException','getChatInfoFromId','../../common/utils','count','affected','chat.xlsx','358721POwqlZ','exportExcel','@nestjs/common','../../common/constants/balance.constant','__metadata','findAndCount','attachment;\x20filename=','delByGroupId','components','../user/user.entity','HttpStatus','querDrawLog','Like','当前页面已经没有东西可以删除了！','rec','group','DESC','ali','xlsx','?imageView2/1/w/','用户名','find','ChatLogEntity','提问时间','type','getOwnPropertyDescriptor','design:paramtypes','Repository','Content-Type','thumbImg','end','1504539RsqJWQ','Content-Disposition','你操作的图片不存在、请检查！','save','__param','InjectRepository','786645OPHPpl','forEach','../chatGroup/chatGroup.entity','CHAT_TYPE','findOne','@default.com','Workbook','decorate','chatGroupEntity','user','assign','你推荐的图片不存在、请检查！','24ZqWsfI','ChatLogService','1883768uivrnR','parse','update','DALL-E2','isGroup','7CGsnlB','PAINT_TYPE','length','chatLogEntity'];_0x499e=function(){return _0x4ede20;};return _0x499e();}Object[_0x1c5eec(0x198)](exports,'__esModule',{'value':!![]}),exports['ChatLogService']=void 0x0;const common_1=require(_0x1c5eec(0x13e)),typeorm_1=require(_0x1c5eec(0x19e)),chatLog_entity_1=require('./chatLog.entity'),typeorm_2=require('typeorm'),balance_constant_1=require(_0x1c5eec(0x13f)),user_entity_1=require(_0x1c5eec(0x145)),utils_1=require(_0x1c5eec(0x138)),exceljs_1=require('exceljs'),chatGroup_entity_1=require(_0x1c5eec(0x163));let ChatLogService=class ChatLogService{constructor(_0x101b31,_0x47a62f,_0x389300){const _0x13c5cd=_0x1c5eec;this[_0x13c5cd(0x177)]=_0x101b31,this['userEntity']=_0x47a62f,this[_0x13c5cd(0x169)]=_0x389300;}async[_0x1c5eec(0x197)](_0x544317){const _0x5e6342=_0x1c5eec;return await this[_0x5e6342(0x177)][_0x5e6342(0x15e)](_0x544317);}[_0x1c5eec(0x137)](_0x49b0ee){const _0x56af52=_0x1c5eec;return this[_0x56af52(0x177)]['findOne']({'where':{'id':_0x49b0ee}});}async[_0x1c5eec(0x147)](_0x77b8e9,_0x52690e){const _0x1af159=_0x1c5eec,{id:_0x41f14b}=_0x77b8e9[_0x1af159(0x16a)],{model:_0x1dee4d}=_0x52690e,_0x436a9f={'userId':_0x41f14b,'type':balance_constant_1['DeductionKey']['PAINT_TYPE']};_0x1dee4d&&(_0x436a9f[_0x1af159(0x17a)]=_0x1dee4d,_0x1dee4d===_0x1af159(0x172)&&(_0x436a9f['model']=(0x0,typeorm_2['In'])([_0x1af159(0x172),_0x1af159(0x192)])));const _0x1ecd18=await this['chatLogEntity'][_0x1af159(0x151)]({'where':_0x436a9f,'order':{'id':'DESC'},'select':['id',_0x1af159(0x17f),_0x1af159(0x131),'message_id',_0x1af159(0x14b),_0x1af159(0x17a),_0x1af159(0x134),_0x1af159(0x154),_0x1af159(0x1a2)]});return _0x1ecd18[_0x1af159(0x162)](_0x1fae24=>{const _0x557910=_0x1af159;if(_0x1fae24['type']==='paintCount'){const _0x38ddf9=_0x1fae24[_0x557910(0x17a)]==='mj'?0x136:0xa0,_0xb8e94e=_0x1fae24['answer'][_0x557910(0x183)]('cos')?'tencent':_0x557910(0x14d),_0x11f28f=_0xb8e94e===_0x557910(0x17d)?_0x557910(0x14f)+_0x38ddf9+_0x557910(0x18c):_0x557910(0x191)+_0x38ddf9;_0x1fae24[_0x557910(0x159)]=_0x1fae24[_0x557910(0x17f)]+_0x11f28f;try{_0x1fae24['fileInfo']=_0x1fae24[_0x557910(0x1a2)]?JSON[_0x557910(0x170)](_0x1fae24[_0x557910(0x1a2)]):null;}catch(_0x161f18){_0x1fae24[_0x557910(0x1a2)]={};}}}),_0x1ecd18;}async[_0x1c5eec(0x189)](_0x43c419){const _0x56c877=_0x1c5eec,{page:page=0x1,size:size=0x14,rec:_0x3cadab,userId:_0x567062,model:_0x28a25d}=_0x43c419,_0x3214d6={'type':balance_constant_1[_0x56c877(0x18a)][_0x56c877(0x175)],'prompt':(0x0,typeorm_2[_0x56c877(0x17e)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x3cadab&&Object[_0x56c877(0x16b)](_0x3214d6,{'rec':_0x3cadab}),_0x567062&&Object['assign'](_0x3214d6,{'userId':_0x567062});_0x28a25d&&(_0x3214d6[_0x56c877(0x17a)]=_0x28a25d,_0x28a25d===_0x56c877(0x172)&&(_0x3214d6['model']=(0x0,typeorm_2['In'])([_0x56c877(0x172),_0x56c877(0x192)])));const [_0x52c25f,_0x5c716d]=await this[_0x56c877(0x177)]['findAndCount']({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x3214d6});return _0x52c25f[_0x56c877(0x162)](_0x327c50=>{const _0x11304e=_0x56c877;var _0x38da26;if(_0x327c50['type']===_0x11304e(0x1a1)){const _0x5ae289=_0x327c50[_0x11304e(0x17a)]==='mj'?0x136:0xa0,_0x80d15=_0x327c50[_0x11304e(0x17f)]['includes'](_0x11304e(0x1a3))?_0x11304e(0x17d):_0x11304e(0x14d),_0x2aadbc=_0x80d15==='tencent'?_0x11304e(0x14f)+_0x5ae289+'/q/55':_0x11304e(0x191)+_0x5ae289;_0x327c50['thumbImg']=_0x327c50['answer']+_0x2aadbc;try{const _0x4d839e=_0x327c50['extend']?JSON[_0x11304e(0x170)](_0x327c50[_0x11304e(0x134)]):null;_0x4d839e&&(_0x4d839e?_0x327c50[_0x11304e(0x173)]=((_0x38da26=_0x4d839e===null||_0x4d839e===void 0x0?void 0x0:_0x4d839e['components'][0x0])===null||_0x38da26===void 0x0?void 0x0:_0x38da26[_0x11304e(0x144)][_0x11304e(0x176)])===0x5:_0x327c50[_0x11304e(0x173)]=![]);}catch(_0x4a04c6){console['log'](_0x11304e(0x180),_0x4a04c6);}}}),{'rows':_0x52c25f,'count':_0x5c716d};}async['recDrawImg'](_0x1e23ed){const _0x3be9b4=_0x1c5eec,{id:_0x198217}=_0x1e23ed,_0x160f6f=await this['chatLogEntity']['findOne']({'where':{'id':_0x198217,'type':balance_constant_1['DeductionKey'][_0x3be9b4(0x175)]}});if(!_0x160f6f)throw new common_1[(_0x3be9b4(0x136))](_0x3be9b4(0x16c),common_1['HttpStatus']['BAD_REQUEST']);const _0x3c0402=_0x160f6f[_0x3be9b4(0x14a)]===0x1?0x0:0x1,_0x20ce45=await this['chatLogEntity'][_0x3be9b4(0x171)]({'id':_0x198217},{'rec':_0x3c0402});if(_0x20ce45[_0x3be9b4(0x13a)]>0x0)return(_0x3c0402?'推荐':_0x3be9b4(0x187))+'图片成功！';throw new common_1[(_0x3be9b4(0x136))](_0x3be9b4(0x15d),common_1['HttpStatus'][_0x3be9b4(0x184)]);}async[_0x1c5eec(0x13d)](_0x2e37e8,_0x59d208){const _0x1f0f36=_0x1c5eec,_0x36e680={'type':balance_constant_1['DeductionKey'][_0x1f0f36(0x164)]},{page:page=0x1,size:size=0x1e,prompt:_0x101800,email:_0x1bc479}=_0x2e37e8;_0x101800&&Object[_0x1f0f36(0x16b)](_0x36e680,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x101800+'%')});if(_0x1bc479){const _0x32a36f=await this[_0x1f0f36(0x19f)][_0x1f0f36(0x165)]({'where':{'email':_0x1bc479}});(_0x32a36f===null||_0x32a36f===void 0x0?void 0x0:_0x32a36f['id'])&&Object[_0x1f0f36(0x16b)](_0x36e680,{'userId':_0x32a36f['id']});}const [_0x4ea10d,_0x55b3e8]=await this['chatLogEntity']['findAndCount']({'order':{'id':_0x1f0f36(0x14c)},'skip':(page-0x1)*size,'take':size,'where':_0x36e680}),_0x5e8f13=_0x4ea10d[_0x1f0f36(0x199)](_0x5de29e=>_0x5de29e[_0x1f0f36(0x19d)]),_0x12c97b=await this[_0x1f0f36(0x19f)][_0x1f0f36(0x151)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5e8f13)}}),_0x29b2dc=_0x4ea10d['map'](_0x381378=>{const _0x455088=_0x1f0f36,_0x42acb9=_0x12c97b[_0x455088(0x151)](_0x4f021d=>_0x4f021d['id']===_0x381378[_0x455088(0x19d)]);return{'username':_0x42acb9?_0x42acb9[_0x455088(0x190)]:'','email':_0x42acb9?_0x42acb9['email']:'','prompt':_0x381378[_0x455088(0x131)],'answer':_0x381378[_0x455088(0x17f)],'createdAt':(0x0,utils_1[_0x455088(0x195)])(_0x381378[_0x455088(0x194)])};}),_0x5e2c29=new exceljs_1['default'][(_0x1f0f36(0x167))](),_0x477572=_0x5e2c29['addWorksheet'](_0x1f0f36(0x17c));_0x477572['columns']=[{'header':_0x1f0f36(0x150),'key':_0x1f0f36(0x190),'width':0x14},{'header':'用户邮箱','key':_0x1f0f36(0x1a0),'width':0x14},{'header':_0x1f0f36(0x153),'key':_0x1f0f36(0x194),'width':0x14},{'header':'提问问题','key':_0x1f0f36(0x131),'width':0x50},{'header':'回答答案','key':_0x1f0f36(0x17f),'width':0x96}],_0x29b2dc[_0x1f0f36(0x162)](_0x442ebf=>_0x477572[_0x1f0f36(0x188)](_0x442ebf)),_0x59d208[_0x1f0f36(0x132)](_0x1f0f36(0x158),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x59d208['setHeader'](_0x1f0f36(0x15c),_0x1f0f36(0x142)+_0x1f0f36(0x13b)),await _0x5e2c29[_0x1f0f36(0x14e)]['write'](_0x59d208),_0x59d208[_0x1f0f36(0x15a)]();}async[_0x1c5eec(0x196)](_0xd9f038,_0x2db2a3){const _0x4203a2=_0x1c5eec,{page:page=0x1,size:size=0x14,userId:_0x240f56,prompt:_0x13a9b1}=_0xd9f038,_0x3a338a={'type':balance_constant_1[_0x4203a2(0x18a)]['CHAT_TYPE'],'prompt':(0x0,typeorm_2[_0x4203a2(0x17e)])('')};_0x240f56&&Object[_0x4203a2(0x16b)](_0x3a338a,{'userId':_0x240f56}),_0x13a9b1&&Object[_0x4203a2(0x16b)](_0x3a338a,{'prompt':(0x0,typeorm_2[_0x4203a2(0x148)])('%'+_0x13a9b1+'%')});const [_0x2d7bd5,_0x38e73b]=await this[_0x4203a2(0x177)][_0x4203a2(0x141)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x3a338a}),_0x5cc453=_0x2d7bd5[_0x4203a2(0x199)](_0x2b7d3b=>_0x2b7d3b['userId']),_0x3318c3=await this[_0x4203a2(0x19f)][_0x4203a2(0x151)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5cc453)},'select':['id',_0x4203a2(0x190),_0x4203a2(0x1a0)]});return _0x2d7bd5['forEach'](_0x9ebf79=>{const _0x1c69e1=_0x4203a2,{username:_0x36aa8c,email:_0x1e57ce}=_0x3318c3[_0x1c69e1(0x151)](_0x21cf23=>_0x21cf23['id']===_0x9ebf79['userId'])||{};_0x9ebf79['username']=_0x36aa8c,_0x9ebf79[_0x1c69e1(0x1a0)]=_0x1e57ce;}),_0x2db2a3[_0x4203a2(0x16a)]['role']!==_0x4203a2(0x186)&&_0x2d7bd5[_0x4203a2(0x162)](_0x307396=>_0x307396[_0x4203a2(0x1a0)]=(0x0,utils_1[_0x4203a2(0x135)])(_0x307396[_0x4203a2(0x1a0)])),_0x2d7bd5['forEach'](_0x28fa89=>{const _0x7911de=_0x4203a2;!_0x28fa89[_0x7911de(0x1a0)]&&(_0x28fa89[_0x7911de(0x1a0)]=(_0x28fa89===null||_0x28fa89===void 0x0?void 0x0:_0x28fa89[_0x7911de(0x19d)])+_0x7911de(0x166)),!_0x28fa89['username']&&(_0x28fa89[_0x7911de(0x190)]='游客'+(_0x28fa89===null||_0x28fa89===void 0x0?void 0x0:_0x28fa89[_0x7911de(0x19d)]));}),{'rows':_0x2d7bd5,'count':_0x38e73b};}async['chatList'](_0x2dc2d7,_0xa86d0f){const _0x569ff5=_0x1c5eec,{id:_0x18c8bf}=_0x2dc2d7['user'],{groupId:_0x2c5b98}=_0xa86d0f,_0x4300e0={'userId':_0x18c8bf,'isDelete':![]};_0x2c5b98&&Object[_0x569ff5(0x16b)](_0x4300e0,{'groupId':_0x2c5b98});if(_0x2c5b98){const _0x2aeb23=await this[_0x569ff5(0x169)][_0x569ff5(0x139)]({'where':{'isDelete':![]}});if(_0x2aeb23===0x0)return[];}const _0x37976d=await this[_0x569ff5(0x177)]['find']({'where':_0x4300e0});return _0x37976d[_0x569ff5(0x199)](_0x1ef57b=>{const _0xa7ac61=_0x569ff5,{prompt:_0x5a5ddf,role:_0x2d646d,answer:_0x4548e4,createdAt:_0x136ce8,model:_0x1a4580,conversationOptions:_0xdd60e1,requestOptions:_0x4e5865,id:_0x24ac4c,promptTokens:_0x3d741c,completionTokens:_0x4ef041,totalTokens:_0x4b7dae,tts:_0x52bd8c,file:_0x5690ef}=_0x1ef57b;let _0x362c8a=null,_0x2b2e70=null;try{_0x362c8a=JSON['parse'](_0xdd60e1),_0x2b2e70=JSON[_0xa7ac61(0x170)](_0x4e5865);}catch(_0x3064d0){console['log']('error:\x20',_0x3064d0);}return{'chatId':_0x24ac4c,'tts':_0x52bd8c,'dateTime':(0x0,utils_1['formatDate'])(_0x136ce8),'text':_0x2d646d===_0xa7ac61(0x16a)?_0x5a5ddf:_0x4548e4,'inversion':_0x2d646d===_0xa7ac61(0x16a),'error':![],'conversationOptions':_0x362c8a,'requestOptions':_0x2b2e70,'promptTokens':_0x3d741c,'completionTokens':_0x4ef041,'totalTokens':_0x4b7dae,'file':_0x5690ef};});}async[_0x1c5eec(0x18e)](_0x3cf0f0,_0x33e749){const _0x263d59=_0x1c5eec,{id:_0x522681}=_0x3cf0f0[_0x263d59(0x16a)],{id:_0x1d0648}=_0x33e749,_0x80c2db=await this[_0x263d59(0x177)][_0x263d59(0x165)]({'where':{'id':_0x1d0648,'userId':_0x522681}});if(!_0x80c2db)throw new common_1[(_0x263d59(0x136))](_0x263d59(0x18d),common_1[_0x263d59(0x146)][_0x263d59(0x184)]);const _0x2a55fa=await this['chatLogEntity'][_0x263d59(0x171)]({'id':_0x1d0648},{'isDelete':!![]});if(_0x2a55fa[_0x263d59(0x13a)]>0x0)return'删除对话记录成功！';else throw new common_1['HttpException'](_0x263d59(0x18d),common_1['HttpStatus'][_0x263d59(0x184)]);}async[_0x1c5eec(0x143)](_0x512ffa,_0x50396e){const _0x18e82f=_0x1c5eec,{groupId:_0x4cd4b6}=_0x50396e,{id:_0x134ead}=_0x512ffa[_0x18e82f(0x16a)],_0x20884f=await this[_0x18e82f(0x169)][_0x18e82f(0x165)]({'where':{'id':_0x4cd4b6,'userId':_0x134ead}});if(!_0x20884f)throw new common_1[(_0x18e82f(0x136))]('你删除的对话记录不存在、请检查！',common_1['HttpStatus'][_0x18e82f(0x184)]);const _0x5b6ffd=await this[_0x18e82f(0x177)][_0x18e82f(0x171)]({'groupId':_0x4cd4b6},{'isDelete':!![]});if(_0x5b6ffd[_0x18e82f(0x13a)]>0x0)return'删除对话记录成功！';if(_0x5b6ffd[_0x18e82f(0x13a)]===0x0)throw new common_1['HttpException'](_0x18e82f(0x149),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x1c5eec(0x19b)](_0x263edd,_0x45ed0a){const _0x31b049=_0x1c5eec,{id:_0x2d80c3}=_0x263edd[_0x31b049(0x16a)],{appId:_0x2e8216,page:page=0x1,size:size=0xa}=_0x45ed0a,[_0x2ea330,_0x1d599a]=await this[_0x31b049(0x177)][_0x31b049(0x141)]({'where':{'userId':_0x2d80c3,'appId':_0x2e8216,'role':'assistant'},'order':{'id':_0x31b049(0x14c)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x2ea330,'count':_0x1d599a};}};function _0x2486(_0x156ad0,_0x232e5a){const _0x499e67=_0x499e();return _0x2486=function(_0x2486a7,_0x15d2d0){_0x2486a7=_0x2486a7-0x131;let _0x39df3a=_0x499e67[_0x2486a7];return _0x39df3a;},_0x2486(_0x156ad0,_0x232e5a);}ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x1c5eec(0x160)])(chatLog_entity_1[_0x1c5eec(0x152)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x1c5eec(0x179)])),__param(0x2,(0x0,typeorm_1[_0x1c5eec(0x160)])(chatGroup_entity_1[_0x1c5eec(0x133)])),__metadata(_0x1c5eec(0x156),[typeorm_2[_0x1c5eec(0x157)],typeorm_2[_0x1c5eec(0x157)],typeorm_2[_0x1c5eec(0x157)]])],ChatLogService),exports[_0x1c5eec(0x16e)]=ChatLogService;