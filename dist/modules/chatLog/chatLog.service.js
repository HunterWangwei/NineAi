'use strict';const _0xc681bc=_0x46a9;(function(_0x403cb7,_0x47b74a){const _0x5500be=_0x46a9,_0x330478=_0x403cb7();while(!![]){try{const _0x38f6d1=parseInt(_0x5500be(0x14c))/0x1+parseInt(_0x5500be(0x14f))/0x2+-parseInt(_0x5500be(0x179))/0x3*(-parseInt(_0x5500be(0x17f))/0x4)+-parseInt(_0x5500be(0x143))/0x5*(-parseInt(_0x5500be(0x16c))/0x6)+-parseInt(_0x5500be(0x170))/0x7*(-parseInt(_0x5500be(0x15c))/0x8)+parseInt(_0x5500be(0x12b))/0x9+parseInt(_0x5500be(0x195))/0xa*(-parseInt(_0x5500be(0x14e))/0xb);if(_0x38f6d1===_0x47b74a)break;else _0x330478['push'](_0x330478['shift']());}catch(_0x1fca74){_0x330478['push'](_0x330478['shift']());}}}(_0x1a3d,0xdccaf));function _0x46a9(_0x5bdd72,_0x14e2c0){const _0x1a3ddf=_0x1a3d();return _0x46a9=function(_0x46a9a7,_0x4e9407){_0x46a9a7=_0x46a9a7-0x126;let _0x5d60ae=_0x1a3ddf[_0x46a9a7];return _0x5d60ae;},_0x46a9(_0x5bdd72,_0x14e2c0);}var __decorate=this&&this[_0xc681bc(0x133)]||function(_0x2f2c32,_0x4c56eb,_0x2d4108,_0x264bc6){const _0x61fbf1=_0xc681bc;var _0x4def45=arguments[_0x61fbf1(0x17e)],_0x268ef9=_0x4def45<0x3?_0x4c56eb:_0x264bc6===null?_0x264bc6=Object[_0x61fbf1(0x17b)](_0x4c56eb,_0x2d4108):_0x264bc6,_0x194e11;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x61fbf1(0x177))_0x268ef9=Reflect[_0x61fbf1(0x192)](_0x2f2c32,_0x4c56eb,_0x2d4108,_0x264bc6);else{for(var _0x4d58a8=_0x2f2c32[_0x61fbf1(0x17e)]-0x1;_0x4d58a8>=0x0;_0x4d58a8--)if(_0x194e11=_0x2f2c32[_0x4d58a8])_0x268ef9=(_0x4def45<0x3?_0x194e11(_0x268ef9):_0x4def45>0x3?_0x194e11(_0x4c56eb,_0x2d4108,_0x268ef9):_0x194e11(_0x4c56eb,_0x2d4108))||_0x268ef9;}return _0x4def45>0x3&&_0x268ef9&&Object[_0x61fbf1(0x189)](_0x4c56eb,_0x2d4108,_0x268ef9),_0x268ef9;},__metadata=this&&this[_0xc681bc(0x163)]||function(_0x255390,_0x325328){const _0x3d6b6b=_0xc681bc;if(typeof Reflect==='object'&&typeof Reflect['metadata']==='function')return Reflect[_0x3d6b6b(0x131)](_0x255390,_0x325328);},__param=this&&this['__param']||function(_0x4056c0,_0x486f80){return function(_0x4324f1,_0x5adf5b){_0x486f80(_0x4324f1,_0x5adf5b,_0x4056c0);};};Object[_0xc681bc(0x189)](exports,'__esModule',{'value':!![]}),exports[_0xc681bc(0x13f)]=void 0x0;function _0x1a3d(){const _0x4ad94d=['log','attachment;\x20filename=','assistant','Injectable','defineProperty','@nestjs/typeorm','thumbImg','model','querDrawLog','tencent','HttpException','BAD_REQUEST','super','decorate','DeductionKey','querAllDrawLog\x20Json\x20parse\x20error','280960rsvbUT','update','CHAT_TYPE','ChatLogEntity','answer','maskEmail','count','chatList','prompt','columns','用户名','取消推荐','?x-oss-process=image/resize,w_','dall-e-3','4239135ymbXGD','findAndCount','当前页面已经没有东西可以删除了！','design:paramtypes','write','assign','metadata','byAppId','__decorate','InjectRepository','exportExcel','../chatGroup/chatGroup.entity','?imageView2/1/w/','Not','fileInfo','components','addRow','querAllChatLog','formatDate','cos','ChatLogService','createdAt','用户邮箱','../../common/constants/balance.constant','190ntSQdy','find','saveChatLog','PAINT_TYPE','./chatLog.entity','getChatInfoFromId','forEach','error:\x20','图片成功！','890383MTTXgM','Content-Disposition','1441ASigUb','3095068XuFKUC','HttpStatus','default','删除对话记录成功！','chat.xlsx','ali','DESC','exceljs','affected','你推荐的图片不存在、请检查！','save','type','你删除的对话记录不存在、请检查！','77032HGSPsf','includes','userId','username','email','UserEntity','role','__metadata','rec','deleteChatLog','user','Repository','@nestjs/common','../../common/utils','extend','map','58278YGjkQX','xlsx','end','findOne','525bHwbXI','@default.com','你操作的图片不存在、请检查！','chatLogEntity','Like','typeorm','group','function','parse','18IvPmYD','DALL-E2','getOwnPropertyDescriptor','/q/55','chatGroupEntity','length','389828WPDhEG','提问问题','setHeader','../user/user.entity','recDrawImg','userEntity'];_0x1a3d=function(){return _0x4ad94d;};return _0x1a3d();}const common_1=require(_0xc681bc(0x168)),typeorm_1=require(_0xc681bc(0x18a)),chatLog_entity_1=require(_0xc681bc(0x147)),typeorm_2=require(_0xc681bc(0x175)),balance_constant_1=require(_0xc681bc(0x142)),user_entity_1=require(_0xc681bc(0x182)),utils_1=require(_0xc681bc(0x169)),exceljs_1=require(_0xc681bc(0x156)),chatGroup_entity_1=require(_0xc681bc(0x136));let ChatLogService=class ChatLogService{constructor(_0x64ca5c,_0x319b7b,_0x29463b){const _0xdf4c87=_0xc681bc;this['chatLogEntity']=_0x64ca5c,this[_0xdf4c87(0x184)]=_0x319b7b,this['chatGroupEntity']=_0x29463b;}async[_0xc681bc(0x145)](_0x576508){const _0x2c9995=_0xc681bc;return await this['chatLogEntity'][_0x2c9995(0x159)](_0x576508);}[_0xc681bc(0x148)](_0x4e5a42){const _0x4cb9cf=_0xc681bc;return this[_0x4cb9cf(0x173)][_0x4cb9cf(0x16f)]({'where':{'id':_0x4e5a42}});}async[_0xc681bc(0x18d)](_0x216f52,_0xa068a5){const _0x64d3a9=_0xc681bc,{id:_0xc4bf2e}=_0x216f52[_0x64d3a9(0x166)],{model:_0x34c6aa}=_0xa068a5,_0x389388={'userId':_0xc4bf2e,'type':balance_constant_1[_0x64d3a9(0x193)][_0x64d3a9(0x146)]};_0x34c6aa&&(_0x389388[_0x64d3a9(0x18c)]=_0x34c6aa,_0x34c6aa===_0x64d3a9(0x17a)&&(_0x389388[_0x64d3a9(0x18c)]=(0x0,typeorm_2['In'])([_0x64d3a9(0x17a),'dall-e-3'])));const _0x34d330=await this[_0x64d3a9(0x173)][_0x64d3a9(0x144)]({'where':_0x389388,'order':{'id':'DESC'},'select':['id',_0x64d3a9(0x199),_0x64d3a9(0x19d),'message_id',_0x64d3a9(0x176),_0x64d3a9(0x18c),_0x64d3a9(0x16a),'type',_0x64d3a9(0x139)]});return _0x34d330[_0x64d3a9(0x149)](_0x20b709=>{const _0x12d939=_0x64d3a9;if(_0x20b709[_0x12d939(0x15a)]==='paintCount'){const _0x5cd027=_0x20b709[_0x12d939(0x18c)]==='mj'?0x136:0xa0,_0x3d00c9=_0x20b709[_0x12d939(0x199)][_0x12d939(0x15d)]('cos')?_0x12d939(0x18e):'ali',_0x566083=_0x3d00c9===_0x12d939(0x18e)?_0x12d939(0x137)+_0x5cd027+_0x12d939(0x17c):_0x12d939(0x129)+_0x5cd027;_0x20b709[_0x12d939(0x18b)]=_0x20b709[_0x12d939(0x199)]+_0x566083;try{_0x20b709[_0x12d939(0x139)]=_0x20b709[_0x12d939(0x139)]?JSON[_0x12d939(0x178)](_0x20b709['fileInfo']):null;}catch(_0x3a6da1){_0x20b709[_0x12d939(0x139)]={};}}}),_0x34d330;}async['querAllDrawLog'](_0x1148c3){const _0x1d83f3=_0xc681bc,{page:page=0x1,size:size=0x14,rec:_0x5e2818,userId:_0x193459,model:_0x58fbca}=_0x1148c3,_0x436c44={'type':balance_constant_1[_0x1d83f3(0x193)][_0x1d83f3(0x146)],'prompt':(0x0,typeorm_2[_0x1d83f3(0x138)])(''),'answer':(0x0,typeorm_2[_0x1d83f3(0x138)])('')};_0x5e2818&&Object['assign'](_0x436c44,{'rec':_0x5e2818}),_0x193459&&Object[_0x1d83f3(0x130)](_0x436c44,{'userId':_0x193459});_0x58fbca&&(_0x436c44[_0x1d83f3(0x18c)]=_0x58fbca,_0x58fbca===_0x1d83f3(0x17a)&&(_0x436c44['model']=(0x0,typeorm_2['In'])([_0x1d83f3(0x17a),_0x1d83f3(0x12a)])));const [_0xd5cc52,_0x366e6d]=await this['chatLogEntity'][_0x1d83f3(0x12c)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x436c44});return _0xd5cc52[_0x1d83f3(0x149)](_0x20f93f=>{const _0x31d8cb=_0x1d83f3;var _0x5cf2fd;if(_0x20f93f[_0x31d8cb(0x15a)]==='paintCount'){const _0x2973fa=_0x20f93f[_0x31d8cb(0x18c)]==='mj'?0x136:0xa0,_0xc696cc=_0x20f93f[_0x31d8cb(0x199)][_0x31d8cb(0x15d)](_0x31d8cb(0x13e))?_0x31d8cb(0x18e):_0x31d8cb(0x154),_0x272ec4=_0xc696cc===_0x31d8cb(0x18e)?_0x31d8cb(0x137)+_0x2973fa+_0x31d8cb(0x17c):_0x31d8cb(0x129)+_0x2973fa;_0x20f93f['thumbImg']=_0x20f93f['answer']+_0x272ec4;try{const _0x2ed99e=_0x20f93f[_0x31d8cb(0x16a)]?JSON[_0x31d8cb(0x178)](_0x20f93f[_0x31d8cb(0x16a)]):null;_0x2ed99e&&(_0x2ed99e?_0x20f93f['isGroup']=((_0x5cf2fd=_0x2ed99e===null||_0x2ed99e===void 0x0?void 0x0:_0x2ed99e[_0x31d8cb(0x13a)][0x0])===null||_0x5cf2fd===void 0x0?void 0x0:_0x5cf2fd[_0x31d8cb(0x13a)]['length'])===0x5:_0x20f93f['isGroup']=![]);}catch(_0x351e96){console[_0x31d8cb(0x185)](_0x31d8cb(0x194),_0x351e96);}}}),{'rows':_0xd5cc52,'count':_0x366e6d};}async[_0xc681bc(0x183)](_0x2721fd){const _0xb3775=_0xc681bc,{id:_0x998aed}=_0x2721fd,_0x528753=await this[_0xb3775(0x173)]['findOne']({'where':{'id':_0x998aed,'type':balance_constant_1[_0xb3775(0x193)]['PAINT_TYPE']}});if(!_0x528753)throw new common_1[(_0xb3775(0x18f))](_0xb3775(0x158),common_1[_0xb3775(0x150)][_0xb3775(0x190)]);const _0x3a8e8f=_0x528753[_0xb3775(0x164)]===0x1?0x0:0x1,_0x59ca7b=await this[_0xb3775(0x173)][_0xb3775(0x196)]({'id':_0x998aed},{'rec':_0x3a8e8f});if(_0x59ca7b[_0xb3775(0x157)]>0x0)return(_0x3a8e8f?'推荐':_0xb3775(0x128))+_0xb3775(0x14b);throw new common_1[(_0xb3775(0x18f))](_0xb3775(0x172),common_1[_0xb3775(0x150)][_0xb3775(0x190)]);}async[_0xc681bc(0x135)](_0x2ca093,_0x4bd229){const _0x2c3955=_0xc681bc,_0x3aef6d={'type':balance_constant_1[_0x2c3955(0x193)][_0x2c3955(0x197)]},{page:page=0x1,size:size=0x1e,prompt:_0x29d5ee,email:_0x14c903}=_0x2ca093;_0x29d5ee&&Object[_0x2c3955(0x130)](_0x3aef6d,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x29d5ee+'%')});if(_0x14c903){const _0x91f43d=await this[_0x2c3955(0x184)][_0x2c3955(0x16f)]({'where':{'email':_0x14c903}});(_0x91f43d===null||_0x91f43d===void 0x0?void 0x0:_0x91f43d['id'])&&Object[_0x2c3955(0x130)](_0x3aef6d,{'userId':_0x91f43d['id']});}const [_0xb5e787,_0x232282]=await this[_0x2c3955(0x173)][_0x2c3955(0x12c)]({'order':{'id':_0x2c3955(0x155)},'skip':(page-0x1)*size,'take':size,'where':_0x3aef6d}),_0x28b893=_0xb5e787[_0x2c3955(0x16b)](_0x440b9d=>_0x440b9d['userId']),_0x3c7ccf=await this[_0x2c3955(0x184)][_0x2c3955(0x144)]({'where':{'id':(0x0,typeorm_2['In'])(_0x28b893)}}),_0x3e17ce=_0xb5e787[_0x2c3955(0x16b)](_0x3704e0=>{const _0xe1a552=_0x2c3955,_0x22a7c4=_0x3c7ccf[_0xe1a552(0x144)](_0x376127=>_0x376127['id']===_0x3704e0[_0xe1a552(0x15e)]);return{'username':_0x22a7c4?_0x22a7c4[_0xe1a552(0x15f)]:'','email':_0x22a7c4?_0x22a7c4['email']:'','prompt':_0x3704e0[_0xe1a552(0x19d)],'answer':_0x3704e0[_0xe1a552(0x199)],'createdAt':(0x0,utils_1[_0xe1a552(0x13d)])(_0x3704e0[_0xe1a552(0x140)])};}),_0x2eb732=new exceljs_1[(_0x2c3955(0x151))]['Workbook'](),_0x1533fd=_0x2eb732['addWorksheet']('chatlog');_0x1533fd[_0x2c3955(0x126)]=[{'header':_0x2c3955(0x127),'key':_0x2c3955(0x15f),'width':0x14},{'header':_0x2c3955(0x141),'key':_0x2c3955(0x160),'width':0x14},{'header':'提问时间','key':_0x2c3955(0x140),'width':0x14},{'header':_0x2c3955(0x180),'key':_0x2c3955(0x19d),'width':0x50},{'header':'回答答案','key':_0x2c3955(0x199),'width':0x96}],_0x3e17ce[_0x2c3955(0x149)](_0x1f1760=>_0x1533fd[_0x2c3955(0x13b)](_0x1f1760)),_0x4bd229[_0x2c3955(0x181)]('Content-Type','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x4bd229[_0x2c3955(0x181)](_0x2c3955(0x14d),_0x2c3955(0x186)+_0x2c3955(0x153)),await _0x2eb732[_0x2c3955(0x16d)][_0x2c3955(0x12f)](_0x4bd229),_0x4bd229[_0x2c3955(0x16e)]();}async[_0xc681bc(0x13c)](_0x251016,_0x9a1d70){const _0x416f90=_0xc681bc,{page:page=0x1,size:size=0x14,userId:_0x19c90d,prompt:_0x2dc82a}=_0x251016,_0x5a6cc2={'type':balance_constant_1['DeductionKey'][_0x416f90(0x197)],'prompt':(0x0,typeorm_2['Not'])('')};_0x19c90d&&Object[_0x416f90(0x130)](_0x5a6cc2,{'userId':_0x19c90d}),_0x2dc82a&&Object[_0x416f90(0x130)](_0x5a6cc2,{'prompt':(0x0,typeorm_2[_0x416f90(0x174)])('%'+_0x2dc82a+'%')});const [_0x14e910,_0x4f400a]=await this[_0x416f90(0x173)][_0x416f90(0x12c)]({'order':{'id':_0x416f90(0x155)},'skip':(page-0x1)*size,'take':size,'where':_0x5a6cc2}),_0x22b4d7=_0x14e910[_0x416f90(0x16b)](_0x4558d7=>_0x4558d7[_0x416f90(0x15e)]),_0x2f0609=await this[_0x416f90(0x184)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x22b4d7)},'select':['id','username','email']});return _0x14e910[_0x416f90(0x149)](_0x1777c2=>{const _0xc3d735=_0x416f90,{username:_0x143180,email:_0x7b6a87}=_0x2f0609[_0xc3d735(0x144)](_0x21bb02=>_0x21bb02['id']===_0x1777c2[_0xc3d735(0x15e)])||{};_0x1777c2[_0xc3d735(0x15f)]=_0x143180,_0x1777c2[_0xc3d735(0x160)]=_0x7b6a87;}),_0x9a1d70['user'][_0x416f90(0x162)]!==_0x416f90(0x191)&&_0x14e910[_0x416f90(0x149)](_0x28361e=>_0x28361e[_0x416f90(0x160)]=(0x0,utils_1[_0x416f90(0x19a)])(_0x28361e[_0x416f90(0x160)])),_0x14e910[_0x416f90(0x149)](_0x5b210e=>{const _0x59dd14=_0x416f90;!_0x5b210e[_0x59dd14(0x160)]&&(_0x5b210e[_0x59dd14(0x160)]=(_0x5b210e===null||_0x5b210e===void 0x0?void 0x0:_0x5b210e[_0x59dd14(0x15e)])+_0x59dd14(0x171)),!_0x5b210e['username']&&(_0x5b210e[_0x59dd14(0x15f)]='游客'+(_0x5b210e===null||_0x5b210e===void 0x0?void 0x0:_0x5b210e['userId']));}),{'rows':_0x14e910,'count':_0x4f400a};}async[_0xc681bc(0x19c)](_0x17b32b,_0x4906d5){const _0x13c21b=_0xc681bc,{id:_0x54dcb4}=_0x17b32b[_0x13c21b(0x166)],{groupId:_0x2d7b18}=_0x4906d5,_0x4e371e={'userId':_0x54dcb4,'isDelete':![]};_0x2d7b18&&Object['assign'](_0x4e371e,{'groupId':_0x2d7b18});if(_0x2d7b18){const _0x570d48=await this[_0x13c21b(0x17d)][_0x13c21b(0x19b)]({'where':{'isDelete':![]}});if(_0x570d48===0x0)return[];}const _0x45e00d=await this[_0x13c21b(0x173)][_0x13c21b(0x144)]({'where':_0x4e371e});return _0x45e00d[_0x13c21b(0x16b)](_0x54b91c=>{const _0x4cd2db=_0x13c21b,{prompt:_0xd190c3,role:_0x2ec732,answer:_0x9dc6cb,createdAt:_0x2faee9,model:_0x523b54,conversationOptions:_0xf7ff07,requestOptions:_0x179171,id:_0x5d0993,promptTokens:_0x2a6ab9,completionTokens:_0x111b87,totalTokens:_0x228613,tts:_0x2fc4ac,file:_0x2deb0f}=_0x54b91c;let _0x4c9548=null,_0x3df1ee=null;try{_0x4c9548=JSON['parse'](_0xf7ff07),_0x3df1ee=JSON['parse'](_0x179171);}catch(_0x2cfeeb){console[_0x4cd2db(0x185)](_0x4cd2db(0x14a),_0x2cfeeb);}return{'chatId':_0x5d0993,'tts':_0x2fc4ac,'dateTime':(0x0,utils_1[_0x4cd2db(0x13d)])(_0x2faee9),'text':_0x2ec732===_0x4cd2db(0x166)?_0xd190c3:_0x9dc6cb,'inversion':_0x2ec732==='user','error':![],'conversationOptions':_0x4c9548,'requestOptions':_0x3df1ee,'promptTokens':_0x2a6ab9,'completionTokens':_0x111b87,'totalTokens':_0x228613,'file':_0x2deb0f};});}async[_0xc681bc(0x165)](_0x397f15,_0x27a1ee){const _0x17fa53=_0xc681bc,{id:_0x186e33}=_0x397f15[_0x17fa53(0x166)],{id:_0x9fa826}=_0x27a1ee,_0x288f52=await this[_0x17fa53(0x173)]['findOne']({'where':{'id':_0x9fa826,'userId':_0x186e33}});if(!_0x288f52)throw new common_1[(_0x17fa53(0x18f))](_0x17fa53(0x15b),common_1[_0x17fa53(0x150)][_0x17fa53(0x190)]);const _0xe123ca=await this[_0x17fa53(0x173)][_0x17fa53(0x196)]({'id':_0x9fa826},{'isDelete':!![]});if(_0xe123ca[_0x17fa53(0x157)]>0x0)return _0x17fa53(0x152);else throw new common_1['HttpException'](_0x17fa53(0x15b),common_1[_0x17fa53(0x150)][_0x17fa53(0x190)]);}async['delByGroupId'](_0x33db19,_0x63c8a){const _0x462d3d=_0xc681bc,{groupId:_0x1f1250}=_0x63c8a,{id:_0x19bb96}=_0x33db19[_0x462d3d(0x166)],_0x4b2803=await this[_0x462d3d(0x17d)][_0x462d3d(0x16f)]({'where':{'id':_0x1f1250,'userId':_0x19bb96}});if(!_0x4b2803)throw new common_1[(_0x462d3d(0x18f))]('你删除的对话记录不存在、请检查！',common_1[_0x462d3d(0x150)][_0x462d3d(0x190)]);const _0x4391b0=await this[_0x462d3d(0x173)]['update']({'groupId':_0x1f1250},{'isDelete':!![]});if(_0x4391b0['affected']>0x0)return _0x462d3d(0x152);if(_0x4391b0[_0x462d3d(0x157)]===0x0)throw new common_1[(_0x462d3d(0x18f))](_0x462d3d(0x12d),common_1['HttpStatus']['BAD_REQUEST']);}async[_0xc681bc(0x132)](_0x17bff0,_0x7a5f22){const _0x4f251b=_0xc681bc,{id:_0x46c303}=_0x17bff0['user'],{appId:_0x4de7ac,page:page=0x1,size:size=0xa}=_0x7a5f22,[_0x4dab73,_0x1f6f02]=await this[_0x4f251b(0x173)]['findAndCount']({'where':{'userId':_0x46c303,'appId':_0x4de7ac,'role':_0x4f251b(0x187)},'order':{'id':_0x4f251b(0x155)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x4dab73,'count':_0x1f6f02};}};ChatLogService=__decorate([(0x0,common_1[_0xc681bc(0x188)])(),__param(0x0,(0x0,typeorm_1[_0xc681bc(0x134)])(chatLog_entity_1[_0xc681bc(0x198)])),__param(0x1,(0x0,typeorm_1[_0xc681bc(0x134)])(user_entity_1[_0xc681bc(0x161)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1['ChatGroupEntity'])),__metadata(_0xc681bc(0x12e),[typeorm_2[_0xc681bc(0x167)],typeorm_2['Repository'],typeorm_2[_0xc681bc(0x167)]])],ChatLogService),exports[_0xc681bc(0x13f)]=ChatLogService;