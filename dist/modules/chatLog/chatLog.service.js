'use strict';const _0x49e9b1=_0x5d30;(function(_0x5cc65f,_0x4cd1f2){const _0x4eaf12=_0x5d30,_0x3dc3c4=_0x5cc65f();while(!![]){try{const _0x276346=parseInt(_0x4eaf12(0xce))/0x1+parseInt(_0x4eaf12(0x11b))/0x2+-parseInt(_0x4eaf12(0xe1))/0x3*(-parseInt(_0x4eaf12(0x115))/0x4)+-parseInt(_0x4eaf12(0x10a))/0x5+-parseInt(_0x4eaf12(0x126))/0x6+parseInt(_0x4eaf12(0x12b))/0x7+parseInt(_0x4eaf12(0xe4))/0x8;if(_0x276346===_0x4cd1f2)break;else _0x3dc3c4['push'](_0x3dc3c4['shift']());}catch(_0x1adcd8){_0x3dc3c4['push'](_0x3dc3c4['shift']());}}}(_0x171c,0x3f0e4));var __decorate=this&&this[_0x49e9b1(0x139)]||function(_0x4665fc,_0x239477,_0x31537a,_0x50f30e){const _0x197fb1=_0x49e9b1;var _0x11dd09=arguments['length'],_0x4ea0cb=_0x11dd09<0x3?_0x239477:_0x50f30e===null?_0x50f30e=Object[_0x197fb1(0x10e)](_0x239477,_0x31537a):_0x50f30e,_0x4364c9;if(typeof Reflect===_0x197fb1(0x123)&&typeof Reflect[_0x197fb1(0x137)]==='function')_0x4ea0cb=Reflect['decorate'](_0x4665fc,_0x239477,_0x31537a,_0x50f30e);else{for(var _0x18e85b=_0x4665fc[_0x197fb1(0xee)]-0x1;_0x18e85b>=0x0;_0x18e85b--)if(_0x4364c9=_0x4665fc[_0x18e85b])_0x4ea0cb=(_0x11dd09<0x3?_0x4364c9(_0x4ea0cb):_0x11dd09>0x3?_0x4364c9(_0x239477,_0x31537a,_0x4ea0cb):_0x4364c9(_0x239477,_0x31537a))||_0x4ea0cb;}return _0x11dd09>0x3&&_0x4ea0cb&&Object[_0x197fb1(0xd2)](_0x239477,_0x31537a,_0x4ea0cb),_0x4ea0cb;},__metadata=this&&this[_0x49e9b1(0xf7)]||function(_0x296591,_0x157293){const _0x148662=_0x49e9b1;if(typeof Reflect===_0x148662(0x123)&&typeof Reflect[_0x148662(0xf1)]==='function')return Reflect[_0x148662(0xf1)](_0x296591,_0x157293);},__param=this&&this['__param']||function(_0x124cad,_0x269963){return function(_0x28ee47,_0x1cb9ee){_0x269963(_0x28ee47,_0x1cb9ee,_0x124cad);};};Object['defineProperty'](exports,_0x49e9b1(0x119),{'value':!![]}),exports[_0x49e9b1(0x10d)]=void 0x0;function _0x5d30(_0x173d2a,_0xcd0624){const _0x171c62=_0x171c();return _0x5d30=function(_0x5d30f3,_0x3488df){_0x5d30f3=_0x5d30f3-0xcd;let _0x17e338=_0x171c62[_0x5d30f3];return _0x17e338;},_0x5d30(_0x173d2a,_0xcd0624);}const common_1=require(_0x49e9b1(0x11f)),typeorm_1=require('@nestjs/typeorm'),chatLog_entity_1=require(_0x49e9b1(0xe2)),typeorm_2=require(_0x49e9b1(0x110)),balance_constant_1=require(_0x49e9b1(0x136)),user_entity_1=require(_0x49e9b1(0x121)),utils_1=require(_0x49e9b1(0x122)),exceljs_1=require('exceljs'),chatGroup_entity_1=require(_0x49e9b1(0x13a));function _0x171c(){const _0xbbe3a9=['2517816nLdtsA','InjectRepository','addWorksheet','Like','xlsx','53977buniyi','end','username','save','用户邮箱','Content-Disposition','getChatInfoFromId','你推荐的图片不存在、请检查！','message_id','Not','HttpException','../../common/constants/balance.constant','decorate','type','__decorate','../chatGroup/chatGroup.entity','saveChatLog','8358zrBGBg','你删除的对话记录不存在、请检查！','parse','fileInfo','defineProperty','DeductionKey','findOne','extend','cos','提问问题','图片成功！','ChatGroupEntity','回答答案','log','setHeader','role','chatlog','chatLogEntity','dall-e-3','15yTUAHu','./chatLog.entity','删除对话记录成功！','3630720EtRGfn','createdAt','components','error:\x20','findAndCount','DESC','email','DALL-E2','assign','formatDate','length','/q/55','CHAT_TYPE','metadata','forEach','model','super','Repository','paintCount','__metadata','maskEmail','PAINT_TYPE','user','ChatLogEntity','affected','thumbImg','map','你操作的图片不存在、请检查！','?imageView2/1/w/','answer','count','Content-Type','chat.xlsx','chatList','delByGroupId','isGroup','BAD_REQUEST','write','1715160nHCPQg','?x-oss-process=image/resize,w_','tencent','ChatLogService','getOwnPropertyDescriptor','ali','typeorm','update','design:paramtypes','rec','find','124880ttWVxN','chatGroupEntity','@nine.com','querAllDrawLog\x20Json\x20parse\x20error','__esModule','includes','789870akKbmS','HttpStatus','userEntity','assistant','@nestjs/common','prompt','../user/user.entity','../../common/utils','object','userId','提问时间'];_0x171c=function(){return _0xbbe3a9;};return _0x171c();}let ChatLogService=class ChatLogService{constructor(_0x16a9f0,_0x515dbe,_0x5e1ffe){const _0x5a879d=_0x49e9b1;this[_0x5a879d(0xdf)]=_0x16a9f0,this[_0x5a879d(0x11d)]=_0x515dbe,this[_0x5a879d(0x116)]=_0x5e1ffe;}async[_0x49e9b1(0xcd)](_0x5a79ec){const _0x216fd0=_0x49e9b1;return await this[_0x216fd0(0xdf)][_0x216fd0(0x12e)](_0x5a79ec);}[_0x49e9b1(0x131)](_0x3e0f86){const _0x320aa5=_0x49e9b1;return this[_0x320aa5(0xdf)]['findOne']({'where':{'id':_0x3e0f86}});}async['querDrawLog'](_0x336013,_0x43b550){const _0x3c795f=_0x49e9b1,{id:_0x36379c}=_0x336013['user'],{model:_0x3e2588}=_0x43b550,_0x59d415={'userId':_0x36379c,'type':balance_constant_1[_0x3c795f(0xd3)][_0x3c795f(0xf9)]};_0x3e2588&&(_0x59d415[_0x3c795f(0xf3)]=_0x3e2588,_0x3e2588===_0x3c795f(0xeb)&&(_0x59d415[_0x3c795f(0xf3)]=(0x0,typeorm_2['In'])([_0x3c795f(0xeb),'dall-e-3'])));const _0x3506d1=await this['chatLogEntity'][_0x3c795f(0x114)]({'where':_0x59d415,'order':{'id':_0x3c795f(0xe9)},'select':['id',_0x3c795f(0x101),'prompt',_0x3c795f(0x133),'group','model',_0x3c795f(0xd5),'type','fileInfo']});return _0x3506d1[_0x3c795f(0xf2)](_0x48423f=>{const _0x244726=_0x3c795f;if(_0x48423f['type']===_0x244726(0xf6)){const _0x3cfe50=_0x48423f[_0x244726(0xf3)]==='mj'?0x136:0xa0,_0x33755b=_0x48423f[_0x244726(0x101)]['includes']('cos')?_0x244726(0x10c):'ali',_0x9df953=_0x33755b===_0x244726(0x10c)?_0x244726(0x100)+_0x3cfe50+_0x244726(0xef):_0x244726(0x10b)+_0x3cfe50;_0x48423f[_0x244726(0xfd)]=_0x48423f['answer']+_0x9df953;try{_0x48423f['fileInfo']=_0x48423f['fileInfo']?JSON[_0x244726(0xd0)](_0x48423f[_0x244726(0xd1)]):null;}catch(_0x2d983e){_0x48423f[_0x244726(0xd1)]={};}}}),_0x3506d1;}async['querAllDrawLog'](_0x2892fd){const _0x3c4236=_0x49e9b1,{page:page=0x1,size:size=0x14,rec:_0x1cd650,userId:_0xcb4173,model:_0x7eccca}=_0x2892fd,_0x4975ba={'type':balance_constant_1[_0x3c4236(0xd3)][_0x3c4236(0xf9)],'prompt':(0x0,typeorm_2[_0x3c4236(0x134)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x1cd650&&Object[_0x3c4236(0xec)](_0x4975ba,{'rec':_0x1cd650}),_0xcb4173&&Object[_0x3c4236(0xec)](_0x4975ba,{'userId':_0xcb4173});_0x7eccca&&(_0x4975ba[_0x3c4236(0xf3)]=_0x7eccca,_0x7eccca===_0x3c4236(0xeb)&&(_0x4975ba[_0x3c4236(0xf3)]=(0x0,typeorm_2['In'])([_0x3c4236(0xeb),_0x3c4236(0xe0)])));const [_0x8bbe2d,_0x52a3f8]=await this['chatLogEntity']['findAndCount']({'order':{'id':_0x3c4236(0xe9)},'skip':(page-0x1)*size,'take':size,'where':_0x4975ba});return _0x8bbe2d[_0x3c4236(0xf2)](_0x530d28=>{const _0x4a0a6b=_0x3c4236;var _0x8069ec;if(_0x530d28[_0x4a0a6b(0x138)]===_0x4a0a6b(0xf6)){const _0x161c47=_0x530d28[_0x4a0a6b(0xf3)]==='mj'?0x136:0xa0,_0x10c5f1=_0x530d28['answer'][_0x4a0a6b(0x11a)](_0x4a0a6b(0xd6))?_0x4a0a6b(0x10c):_0x4a0a6b(0x10f),_0x550de8=_0x10c5f1===_0x4a0a6b(0x10c)?_0x4a0a6b(0x100)+_0x161c47+_0x4a0a6b(0xef):_0x4a0a6b(0x10b)+_0x161c47;_0x530d28[_0x4a0a6b(0xfd)]=_0x530d28[_0x4a0a6b(0x101)]+_0x550de8;try{const _0x2d69ea=_0x530d28[_0x4a0a6b(0xd5)]?JSON[_0x4a0a6b(0xd0)](_0x530d28[_0x4a0a6b(0xd5)]):null;_0x2d69ea&&(_0x2d69ea?_0x530d28['isGroup']=((_0x8069ec=_0x2d69ea===null||_0x2d69ea===void 0x0?void 0x0:_0x2d69ea[_0x4a0a6b(0xe6)][0x0])===null||_0x8069ec===void 0x0?void 0x0:_0x8069ec[_0x4a0a6b(0xe6)][_0x4a0a6b(0xee)])===0x5:_0x530d28[_0x4a0a6b(0x107)]=![]);}catch(_0x12f725){console[_0x4a0a6b(0xdb)](_0x4a0a6b(0x118),_0x12f725);}}}),{'rows':_0x8bbe2d,'count':_0x52a3f8};}async['recDrawImg'](_0x2f3473){const _0x38234a=_0x49e9b1,{id:_0x598883}=_0x2f3473,_0x510896=await this[_0x38234a(0xdf)]['findOne']({'where':{'id':_0x598883,'type':balance_constant_1['DeductionKey'][_0x38234a(0xf9)]}});if(!_0x510896)throw new common_1[(_0x38234a(0x135))](_0x38234a(0x132),common_1[_0x38234a(0x11c)]['BAD_REQUEST']);const _0x4e069c=_0x510896[_0x38234a(0x113)]===0x1?0x0:0x1,_0x573d1c=await this[_0x38234a(0xdf)][_0x38234a(0x111)]({'id':_0x598883},{'rec':_0x4e069c});if(_0x573d1c[_0x38234a(0xfc)]>0x0)return(_0x4e069c?'推荐':'取消推荐')+_0x38234a(0xd8);throw new common_1[(_0x38234a(0x135))](_0x38234a(0xff),common_1[_0x38234a(0x11c)][_0x38234a(0x108)]);}async['exportExcel'](_0x1486eb,_0x3647a7){const _0x2a125a=_0x49e9b1,_0x403286={'type':balance_constant_1[_0x2a125a(0xd3)][_0x2a125a(0xf0)]},{page:page=0x1,size:size=0x1e,prompt:_0x2ffe32,email:_0x58191c}=_0x1486eb;_0x2ffe32&&Object[_0x2a125a(0xec)](_0x403286,{'prompt':(0x0,typeorm_2[_0x2a125a(0x129)])('%'+_0x2ffe32+'%')});if(_0x58191c){const _0x368193=await this[_0x2a125a(0x11d)]['findOne']({'where':{'email':_0x58191c}});(_0x368193===null||_0x368193===void 0x0?void 0x0:_0x368193['id'])&&Object[_0x2a125a(0xec)](_0x403286,{'userId':_0x368193['id']});}const [_0x1a4b25,_0x4a4605]=await this[_0x2a125a(0xdf)][_0x2a125a(0xe8)]({'order':{'id':_0x2a125a(0xe9)},'skip':(page-0x1)*size,'take':size,'where':_0x403286}),_0x46e2d0=_0x1a4b25[_0x2a125a(0xfe)](_0x3ecd1a=>_0x3ecd1a[_0x2a125a(0x124)]),_0x2f1cb2=await this['userEntity'][_0x2a125a(0x114)]({'where':{'id':(0x0,typeorm_2['In'])(_0x46e2d0)}}),_0x587c21=_0x1a4b25[_0x2a125a(0xfe)](_0x86ba45=>{const _0x5d1600=_0x2a125a,_0x3ffa40=_0x2f1cb2[_0x5d1600(0x114)](_0x25d8dd=>_0x25d8dd['id']===_0x86ba45[_0x5d1600(0x124)]);return{'username':_0x3ffa40?_0x3ffa40[_0x5d1600(0x12d)]:'','email':_0x3ffa40?_0x3ffa40[_0x5d1600(0xea)]:'','prompt':_0x86ba45[_0x5d1600(0x120)],'answer':_0x86ba45[_0x5d1600(0x101)],'createdAt':(0x0,utils_1[_0x5d1600(0xed)])(_0x86ba45[_0x5d1600(0xe5)])};}),_0x3c5fd2=new exceljs_1['default']['Workbook'](),_0x426d43=_0x3c5fd2[_0x2a125a(0x128)](_0x2a125a(0xde));_0x426d43['columns']=[{'header':'用户名','key':_0x2a125a(0x12d),'width':0x14},{'header':_0x2a125a(0x12f),'key':'email','width':0x14},{'header':_0x2a125a(0x125),'key':'createdAt','width':0x14},{'header':_0x2a125a(0xd7),'key':_0x2a125a(0x120),'width':0x50},{'header':_0x2a125a(0xda),'key':'answer','width':0x96}],_0x587c21[_0x2a125a(0xf2)](_0x39e284=>_0x426d43['addRow'](_0x39e284)),_0x3647a7[_0x2a125a(0xdc)](_0x2a125a(0x103),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x3647a7[_0x2a125a(0xdc)](_0x2a125a(0x130),'attachment;\x20filename='+_0x2a125a(0x104)),await _0x3c5fd2[_0x2a125a(0x12a)][_0x2a125a(0x109)](_0x3647a7),_0x3647a7[_0x2a125a(0x12c)]();}async['querAllChatLog'](_0x1863a9,_0x348882){const _0x124874=_0x49e9b1,{page:page=0x1,size:size=0x14,userId:_0x447e1b,prompt:_0x2df25b}=_0x1863a9,_0x4daa19={'type':balance_constant_1[_0x124874(0xd3)]['CHAT_TYPE'],'prompt':(0x0,typeorm_2[_0x124874(0x134)])('')};_0x447e1b&&Object[_0x124874(0xec)](_0x4daa19,{'userId':_0x447e1b}),_0x2df25b&&Object[_0x124874(0xec)](_0x4daa19,{'prompt':(0x0,typeorm_2[_0x124874(0x129)])('%'+_0x2df25b+'%')});const [_0x4e31f3,_0x28d8f0]=await this[_0x124874(0xdf)][_0x124874(0xe8)]({'order':{'id':_0x124874(0xe9)},'skip':(page-0x1)*size,'take':size,'where':_0x4daa19}),_0x445243=_0x4e31f3['map'](_0x1b2c5e=>_0x1b2c5e[_0x124874(0x124)]),_0x53d2ff=await this[_0x124874(0x11d)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x445243)},'select':['id',_0x124874(0x12d),'email']});return _0x4e31f3[_0x124874(0xf2)](_0xe99ba2=>{const _0x2baf13=_0x124874,{username:_0xc405c,email:_0x49cf47}=_0x53d2ff[_0x2baf13(0x114)](_0x473708=>_0x473708['id']===_0xe99ba2[_0x2baf13(0x124)])||{};_0xe99ba2['username']=_0xc405c,_0xe99ba2[_0x2baf13(0xea)]=_0x49cf47;}),_0x348882[_0x124874(0xfa)][_0x124874(0xdd)]!==_0x124874(0xf4)&&_0x4e31f3['forEach'](_0x8fc0f2=>_0x8fc0f2[_0x124874(0xea)]=(0x0,utils_1[_0x124874(0xf8)])(_0x8fc0f2[_0x124874(0xea)])),_0x4e31f3['forEach'](_0x3bb390=>{const _0xbd67ef=_0x124874;!_0x3bb390['email']&&(_0x3bb390[_0xbd67ef(0xea)]=(_0x3bb390===null||_0x3bb390===void 0x0?void 0x0:_0x3bb390['userId'])+_0xbd67ef(0x117)),!_0x3bb390[_0xbd67ef(0x12d)]&&(_0x3bb390[_0xbd67ef(0x12d)]='游客'+(_0x3bb390===null||_0x3bb390===void 0x0?void 0x0:_0x3bb390['userId']));}),{'rows':_0x4e31f3,'count':_0x28d8f0};}async[_0x49e9b1(0x105)](_0x183f9a,_0x5212c1){const _0x2aadbc=_0x49e9b1,{id:_0x436191}=_0x183f9a[_0x2aadbc(0xfa)],{groupId:_0x50aaa2}=_0x5212c1,_0xe97e47={'userId':_0x436191,'isDelete':![]};_0x50aaa2&&Object['assign'](_0xe97e47,{'groupId':_0x50aaa2});if(_0x50aaa2){const _0x4128bc=await this[_0x2aadbc(0x116)][_0x2aadbc(0x102)]({'where':{'isDelete':![]}});if(_0x4128bc===0x0)return[];}const _0x3616d4=await this['chatLogEntity'][_0x2aadbc(0x114)]({'where':_0xe97e47});return _0x3616d4[_0x2aadbc(0xfe)](_0x301a4d=>{const _0x8c01eb=_0x2aadbc,{prompt:_0x46ebf1,role:_0x70bdd2,answer:_0x20f314,createdAt:_0x15ee45,model:_0x2bc5b1,conversationOptions:_0x40a9ee,requestOptions:_0x162c61,id:_0x4d72d9,promptTokens:_0x3dfad0,completionTokens:_0x4d957a,totalTokens:_0x367034,tts:_0x23d3d3,file:_0x4b554b}=_0x301a4d;let _0x14ea2a=null,_0x33beec=null;try{_0x14ea2a=JSON[_0x8c01eb(0xd0)](_0x40a9ee),_0x33beec=JSON[_0x8c01eb(0xd0)](_0x162c61);}catch(_0x575017){console[_0x8c01eb(0xdb)](_0x8c01eb(0xe7),_0x575017);}return{'chatId':_0x4d72d9,'tts':_0x23d3d3,'dateTime':(0x0,utils_1[_0x8c01eb(0xed)])(_0x15ee45),'text':_0x70bdd2===_0x8c01eb(0xfa)?_0x46ebf1:_0x20f314,'inversion':_0x70bdd2===_0x8c01eb(0xfa),'error':![],'conversationOptions':_0x14ea2a,'requestOptions':_0x33beec,'promptTokens':_0x3dfad0,'completionTokens':_0x4d957a,'totalTokens':_0x367034,'file':_0x4b554b};});}async['deleteChatLog'](_0x5a89c7,_0x345855){const _0x10a9dd=_0x49e9b1,{id:_0x4db4e7}=_0x5a89c7[_0x10a9dd(0xfa)],{id:_0x3d0e7a}=_0x345855,_0x101510=await this[_0x10a9dd(0xdf)][_0x10a9dd(0xd4)]({'where':{'id':_0x3d0e7a,'userId':_0x4db4e7}});if(!_0x101510)throw new common_1[(_0x10a9dd(0x135))](_0x10a9dd(0xcf),common_1['HttpStatus']['BAD_REQUEST']);const _0xe8ba2f=await this[_0x10a9dd(0xdf)][_0x10a9dd(0x111)]({'id':_0x3d0e7a},{'isDelete':!![]});if(_0xe8ba2f['affected']>0x0)return _0x10a9dd(0xe3);else throw new common_1[(_0x10a9dd(0x135))]('你删除的对话记录不存在、请检查！',common_1[_0x10a9dd(0x11c)][_0x10a9dd(0x108)]);}async[_0x49e9b1(0x106)](_0xdd0e88,_0x97ba5d){const _0x2308df=_0x49e9b1,{groupId:_0xafcca6}=_0x97ba5d,{id:_0x341233}=_0xdd0e88[_0x2308df(0xfa)],_0x4783d2=await this['chatGroupEntity']['findOne']({'where':{'id':_0xafcca6,'userId':_0x341233}});if(!_0x4783d2)throw new common_1['HttpException'](_0x2308df(0xcf),common_1[_0x2308df(0x11c)][_0x2308df(0x108)]);const _0x30e546=await this[_0x2308df(0xdf)][_0x2308df(0x111)]({'groupId':_0xafcca6},{'isDelete':!![]});if(_0x30e546['affected']>0x0)return _0x2308df(0xe3);if(_0x30e546[_0x2308df(0xfc)]===0x0)throw new common_1[(_0x2308df(0x135))]('当前页面已经没有东西可以删除了！',common_1[_0x2308df(0x11c)][_0x2308df(0x108)]);}async['byAppId'](_0x5e61b0,_0x40dde4){const _0x93a5a4=_0x49e9b1,{id:_0x1fe305}=_0x5e61b0['user'],{appId:_0x12d982,page:page=0x1,size:size=0xa}=_0x40dde4,[_0x1a1e95,_0x56c65c]=await this[_0x93a5a4(0xdf)]['findAndCount']({'where':{'userId':_0x1fe305,'appId':_0x12d982,'role':_0x93a5a4(0x11e)},'order':{'id':_0x93a5a4(0xe9)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x1a1e95,'count':_0x56c65c};}};ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x49e9b1(0x127)])(chatLog_entity_1[_0x49e9b1(0xfb)])),__param(0x1,(0x0,typeorm_1[_0x49e9b1(0x127)])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1[_0x49e9b1(0x127)])(chatGroup_entity_1[_0x49e9b1(0xd9)])),__metadata(_0x49e9b1(0x112),[typeorm_2[_0x49e9b1(0xf5)],typeorm_2['Repository'],typeorm_2['Repository']])],ChatLogService),exports[_0x49e9b1(0x10d)]=ChatLogService;