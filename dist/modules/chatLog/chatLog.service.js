'use strict';const _0x3cc1bf=_0x1e3a;function _0x1f4d(){const _0x29a23a=['user','43038OWCzwz','HttpException','1532636kfwNcN','tencent','../../common/utils','__decorate','chatLogEntity','你推荐的图片不存在、请检查！','assistant','Not','querAllDrawLog\x20Json\x20parse\x20error','columns','你操作的图片不存在、请检查！','cos','model','function','find','write','recDrawImg','object','prompt','assign','formatDate','../../common/constants/balance.constant','ali','chatGroupEntity','?x-oss-process=image/resize,w_','thumbImg','answer','count','ChatGroupEntity','exceljs','forEach','ChatLogService','dall-e-3','userId','deleteChatLog','save','findAndCount','update','DALL-E2','username','UserEntity','BAD_REQUEST','/q/55','Repository','paintCount','5232440wJrXbn','getOwnPropertyDescriptor','xlsx','isGroup','267552VaExQt','typeorm','decorate','getChatInfoFromId','maskEmail','660IqQBlz','@nine.com','DESC','../chatGroup/chatGroup.entity','delByGroupId','userEntity','chatlog','addWorksheet','metadata','affected','用户邮箱','email','components','当前页面已经没有东西可以删除了！','Content-Type','group','setHeader','message_id','DeductionKey','default','../user/user.entity','length','3WmJtaF','addRow','CHAT_TYPE','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','@nestjs/typeorm','?imageView2/1/w/','extend','HttpStatus','map','byAppId','2555732MdKaVP','图片成功！','querAllChatLog','3437832mUFqtF','chat.xlsx','2893300iQYurB','chatList','Workbook','includes','Like','31YrJCrJ','@nestjs/common','defineProperty','findOne','PAINT_TYPE','fileInfo','super','type','你删除的对话记录不存在、请检查！','parse','取消推荐'];_0x1f4d=function(){return _0x29a23a;};return _0x1f4d();}(function(_0x3fb7fa,_0x572de4){const _0x2eb015=_0x1e3a,_0x388514=_0x3fb7fa();while(!![]){try{const _0x3eb5e9=parseInt(_0x2eb015(0x169))/0x1*(parseInt(_0x2eb015(0x175))/0x2)+-parseInt(_0x2eb015(0x155))/0x3*(parseInt(_0x2eb015(0x15f))/0x4)+-parseInt(_0x2eb015(0x164))/0x5+-parseInt(_0x2eb015(0x162))/0x6+parseInt(_0x2eb015(0x177))/0x7+-parseInt(_0x2eb015(0x1a4))/0x8+-parseInt(_0x2eb015(0x13a))/0x9*(-parseInt(_0x2eb015(0x13f))/0xa);if(_0x3eb5e9===_0x572de4)break;else _0x388514['push'](_0x388514['shift']());}catch(_0x35f945){_0x388514['push'](_0x388514['shift']());}}}(_0x1f4d,0x62809));var __decorate=this&&this[_0x3cc1bf(0x17a)]||function(_0x1e09df,_0x53bcda,_0x43da25,_0x217edc){const _0x5283ef=_0x3cc1bf;var _0x1d1dc1=arguments['length'],_0x384e22=_0x1d1dc1<0x3?_0x53bcda:_0x217edc===null?_0x217edc=Object[_0x5283ef(0x1a5)](_0x53bcda,_0x43da25):_0x217edc,_0x44a74a;if(typeof Reflect==='object'&&typeof Reflect[_0x5283ef(0x13c)]===_0x5283ef(0x184))_0x384e22=Reflect['decorate'](_0x1e09df,_0x53bcda,_0x43da25,_0x217edc);else{for(var _0x200816=_0x1e09df[_0x5283ef(0x154)]-0x1;_0x200816>=0x0;_0x200816--)if(_0x44a74a=_0x1e09df[_0x200816])_0x384e22=(_0x1d1dc1<0x3?_0x44a74a(_0x384e22):_0x1d1dc1>0x3?_0x44a74a(_0x53bcda,_0x43da25,_0x384e22):_0x44a74a(_0x53bcda,_0x43da25))||_0x384e22;}return _0x1d1dc1>0x3&&_0x384e22&&Object[_0x5283ef(0x16b)](_0x53bcda,_0x43da25,_0x384e22),_0x384e22;},__metadata=this&&this['__metadata']||function(_0x4c703d,_0x28df63){const _0x4908e5=_0x3cc1bf;if(typeof Reflect===_0x4908e5(0x188)&&typeof Reflect[_0x4908e5(0x147)]==='function')return Reflect[_0x4908e5(0x147)](_0x4c703d,_0x28df63);},__param=this&&this['__param']||function(_0x45951f,_0x4cb7c6){return function(_0x1699d9,_0x3fa67c){_0x4cb7c6(_0x1699d9,_0x3fa67c,_0x45951f);};};function _0x1e3a(_0x1c7c3d,_0x4ce88d){const _0x1f4dd0=_0x1f4d();return _0x1e3a=function(_0x1e3a81,_0x2fbf0b){_0x1e3a81=_0x1e3a81-0x138;let _0x398e21=_0x1f4dd0[_0x1e3a81];return _0x398e21;},_0x1e3a(_0x1c7c3d,_0x4ce88d);}Object[_0x3cc1bf(0x16b)](exports,'__esModule',{'value':!![]}),exports[_0x3cc1bf(0x196)]=void 0x0;const common_1=require(_0x3cc1bf(0x16a)),typeorm_1=require(_0x3cc1bf(0x159)),chatLog_entity_1=require('./chatLog.entity'),typeorm_2=require(_0x3cc1bf(0x13b)),balance_constant_1=require(_0x3cc1bf(0x18c)),user_entity_1=require(_0x3cc1bf(0x153)),utils_1=require(_0x3cc1bf(0x179)),exceljs_1=require(_0x3cc1bf(0x194)),chatGroup_entity_1=require(_0x3cc1bf(0x142));let ChatLogService=class ChatLogService{constructor(_0x2633ec,_0x3dbcd9,_0x2d316f){const _0x45d290=_0x3cc1bf;this[_0x45d290(0x17b)]=_0x2633ec,this[_0x45d290(0x144)]=_0x3dbcd9,this[_0x45d290(0x18e)]=_0x2d316f;}async['saveChatLog'](_0x1f7fa3){const _0x5c44f1=_0x3cc1bf;return await this[_0x5c44f1(0x17b)][_0x5c44f1(0x19a)](_0x1f7fa3);}[_0x3cc1bf(0x13d)](_0x4c0baf){const _0x239186=_0x3cc1bf;return this[_0x239186(0x17b)][_0x239186(0x16c)]({'where':{'id':_0x4c0baf}});}async['querDrawLog'](_0x1dfaf9,_0x1aa1d4){const _0x40595c=_0x3cc1bf,{id:_0x508fb3}=_0x1dfaf9['user'],{model:_0x5b502c}=_0x1aa1d4,_0x21493e={'userId':_0x508fb3,'type':balance_constant_1[_0x40595c(0x151)][_0x40595c(0x16d)]};_0x5b502c&&(_0x21493e[_0x40595c(0x183)]=_0x5b502c,_0x5b502c===_0x40595c(0x19d)&&(_0x21493e[_0x40595c(0x183)]=(0x0,typeorm_2['In'])([_0x40595c(0x19d),_0x40595c(0x197)])));const _0x3bc458=await this['chatLogEntity'][_0x40595c(0x185)]({'where':_0x21493e,'order':{'id':_0x40595c(0x141)},'select':['id',_0x40595c(0x191),'prompt',_0x40595c(0x150),_0x40595c(0x14e),_0x40595c(0x183),'extend',_0x40595c(0x170),_0x40595c(0x16e)]});return _0x3bc458[_0x40595c(0x195)](_0x3f0e4a=>{const _0x1c6c21=_0x40595c;if(_0x3f0e4a[_0x1c6c21(0x170)]===_0x1c6c21(0x1a3)){const _0x52f2c6=_0x3f0e4a[_0x1c6c21(0x183)]==='mj'?0x136:0xa0,_0x35124e=_0x3f0e4a[_0x1c6c21(0x191)]['includes'](_0x1c6c21(0x182))?_0x1c6c21(0x178):_0x1c6c21(0x18d),_0x38b99e=_0x35124e==='tencent'?_0x1c6c21(0x15a)+_0x52f2c6+_0x1c6c21(0x1a1):_0x1c6c21(0x18f)+_0x52f2c6;_0x3f0e4a[_0x1c6c21(0x190)]=_0x3f0e4a['answer']+_0x38b99e;try{_0x3f0e4a[_0x1c6c21(0x16e)]=_0x3f0e4a[_0x1c6c21(0x16e)]?JSON[_0x1c6c21(0x172)](_0x3f0e4a['fileInfo']):null;}catch(_0x444ffe){_0x3f0e4a[_0x1c6c21(0x16e)]={};}}}),_0x3bc458;}async['querAllDrawLog'](_0x24e69b){const _0x4c179e=_0x3cc1bf,{page:page=0x1,size:size=0x14,rec:_0x5cee2e,userId:_0x121cdd,model:_0x5a4ec6}=_0x24e69b,_0x2aea23={'type':balance_constant_1[_0x4c179e(0x151)][_0x4c179e(0x16d)],'prompt':(0x0,typeorm_2[_0x4c179e(0x17e)])(''),'answer':(0x0,typeorm_2[_0x4c179e(0x17e)])('')};_0x5cee2e&&Object[_0x4c179e(0x18a)](_0x2aea23,{'rec':_0x5cee2e}),_0x121cdd&&Object[_0x4c179e(0x18a)](_0x2aea23,{'userId':_0x121cdd});_0x5a4ec6&&(_0x2aea23[_0x4c179e(0x183)]=_0x5a4ec6,_0x5a4ec6===_0x4c179e(0x19d)&&(_0x2aea23[_0x4c179e(0x183)]=(0x0,typeorm_2['In'])([_0x4c179e(0x19d),_0x4c179e(0x197)])));const [_0x51f4b2,_0x3e4d3e]=await this[_0x4c179e(0x17b)][_0x4c179e(0x19b)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x2aea23});return _0x51f4b2[_0x4c179e(0x195)](_0x236551=>{const _0x42255f=_0x4c179e;var _0x4a3565;if(_0x236551['type']===_0x42255f(0x1a3)){const _0xb205cc=_0x236551[_0x42255f(0x183)]==='mj'?0x136:0xa0,_0x55c4e9=_0x236551['answer'][_0x42255f(0x167)]('cos')?_0x42255f(0x178):_0x42255f(0x18d),_0x5d56a3=_0x55c4e9===_0x42255f(0x178)?_0x42255f(0x15a)+_0xb205cc+_0x42255f(0x1a1):'?x-oss-process=image/resize,w_'+_0xb205cc;_0x236551['thumbImg']=_0x236551['answer']+_0x5d56a3;try{const _0x3c57c8=_0x236551[_0x42255f(0x15b)]?JSON[_0x42255f(0x172)](_0x236551[_0x42255f(0x15b)]):null;_0x3c57c8&&(_0x3c57c8?_0x236551[_0x42255f(0x139)]=((_0x4a3565=_0x3c57c8===null||_0x3c57c8===void 0x0?void 0x0:_0x3c57c8[_0x42255f(0x14b)][0x0])===null||_0x4a3565===void 0x0?void 0x0:_0x4a3565[_0x42255f(0x14b)][_0x42255f(0x154)])===0x5:_0x236551[_0x42255f(0x139)]=![]);}catch(_0x3b3c1b){console['log'](_0x42255f(0x17f),_0x3b3c1b);}}}),{'rows':_0x51f4b2,'count':_0x3e4d3e};}async[_0x3cc1bf(0x187)](_0x5bbefb){const _0x20da66=_0x3cc1bf,{id:_0x14d2e8}=_0x5bbefb,_0x3f9eae=await this[_0x20da66(0x17b)][_0x20da66(0x16c)]({'where':{'id':_0x14d2e8,'type':balance_constant_1[_0x20da66(0x151)][_0x20da66(0x16d)]}});if(!_0x3f9eae)throw new common_1[(_0x20da66(0x176))](_0x20da66(0x17c),common_1[_0x20da66(0x15c)][_0x20da66(0x1a0)]);const _0x47dcc2=_0x3f9eae['rec']===0x1?0x0:0x1,_0x352f1f=await this[_0x20da66(0x17b)][_0x20da66(0x19c)]({'id':_0x14d2e8},{'rec':_0x47dcc2});if(_0x352f1f[_0x20da66(0x148)]>0x0)return(_0x47dcc2?'推荐':_0x20da66(0x173))+_0x20da66(0x160);throw new common_1[(_0x20da66(0x176))](_0x20da66(0x181),common_1[_0x20da66(0x15c)][_0x20da66(0x1a0)]);}async['exportExcel'](_0x388315,_0x328a40){const _0x1fbb1a=_0x3cc1bf,_0x99d4c0={'type':balance_constant_1[_0x1fbb1a(0x151)][_0x1fbb1a(0x157)]},{page:page=0x1,size:size=0x1e,prompt:_0x315c25,email:_0x45cd42}=_0x388315;_0x315c25&&Object[_0x1fbb1a(0x18a)](_0x99d4c0,{'prompt':(0x0,typeorm_2[_0x1fbb1a(0x168)])('%'+_0x315c25+'%')});if(_0x45cd42){const _0x56499a=await this[_0x1fbb1a(0x144)][_0x1fbb1a(0x16c)]({'where':{'email':_0x45cd42}});(_0x56499a===null||_0x56499a===void 0x0?void 0x0:_0x56499a['id'])&&Object[_0x1fbb1a(0x18a)](_0x99d4c0,{'userId':_0x56499a['id']});}const [_0xf13476,_0x36433c]=await this[_0x1fbb1a(0x17b)][_0x1fbb1a(0x19b)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x99d4c0}),_0xfe86c0=_0xf13476[_0x1fbb1a(0x15d)](_0xcdc179=>_0xcdc179[_0x1fbb1a(0x198)]),_0x4cd63a=await this['userEntity'][_0x1fbb1a(0x185)]({'where':{'id':(0x0,typeorm_2['In'])(_0xfe86c0)}}),_0x5701fd=_0xf13476[_0x1fbb1a(0x15d)](_0x1a38d8=>{const _0x33f1f4=_0x1fbb1a,_0x857666=_0x4cd63a[_0x33f1f4(0x185)](_0x24e20b=>_0x24e20b['id']===_0x1a38d8['userId']);return{'username':_0x857666?_0x857666['username']:'','email':_0x857666?_0x857666[_0x33f1f4(0x14a)]:'','prompt':_0x1a38d8[_0x33f1f4(0x189)],'answer':_0x1a38d8['answer'],'createdAt':(0x0,utils_1[_0x33f1f4(0x18b)])(_0x1a38d8['createdAt'])};}),_0x59b2d0=new exceljs_1[(_0x1fbb1a(0x152))][(_0x1fbb1a(0x166))](),_0x542644=_0x59b2d0[_0x1fbb1a(0x146)](_0x1fbb1a(0x145));_0x542644[_0x1fbb1a(0x180)]=[{'header':'用户名','key':'username','width':0x14},{'header':_0x1fbb1a(0x149),'key':_0x1fbb1a(0x14a),'width':0x14},{'header':'提问时间','key':'createdAt','width':0x14},{'header':'提问问题','key':_0x1fbb1a(0x189),'width':0x50},{'header':'回答答案','key':'answer','width':0x96}],_0x5701fd['forEach'](_0x249f18=>_0x542644[_0x1fbb1a(0x156)](_0x249f18)),_0x328a40[_0x1fbb1a(0x14f)](_0x1fbb1a(0x14d),_0x1fbb1a(0x158)),_0x328a40[_0x1fbb1a(0x14f)]('Content-Disposition','attachment;\x20filename='+_0x1fbb1a(0x163)),await _0x59b2d0[_0x1fbb1a(0x138)][_0x1fbb1a(0x186)](_0x328a40),_0x328a40['end']();}async[_0x3cc1bf(0x161)](_0x5eaf2f,_0x55ee7d){const _0x1564ea=_0x3cc1bf,{page:page=0x1,size:size=0x14,userId:_0x288245,prompt:_0x5ec9c5}=_0x5eaf2f,_0x4d2dea={'type':balance_constant_1[_0x1564ea(0x151)][_0x1564ea(0x157)],'prompt':(0x0,typeorm_2[_0x1564ea(0x17e)])('')};_0x288245&&Object[_0x1564ea(0x18a)](_0x4d2dea,{'userId':_0x288245}),_0x5ec9c5&&Object[_0x1564ea(0x18a)](_0x4d2dea,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x5ec9c5+'%')});const [_0x46bc66,_0x4e70aa]=await this['chatLogEntity'][_0x1564ea(0x19b)]({'order':{'id':_0x1564ea(0x141)},'skip':(page-0x1)*size,'take':size,'where':_0x4d2dea}),_0x6ff18a=_0x46bc66[_0x1564ea(0x15d)](_0x1d00cb=>_0x1d00cb['userId']),_0x76f6cb=await this['userEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x6ff18a)},'select':['id',_0x1564ea(0x19e),'email']});return _0x46bc66[_0x1564ea(0x195)](_0x57c7f2=>{const _0x533469=_0x1564ea,{username:_0x18ea4e,email:_0x323ca3}=_0x76f6cb[_0x533469(0x185)](_0xb94570=>_0xb94570['id']===_0x57c7f2[_0x533469(0x198)])||{};_0x57c7f2[_0x533469(0x19e)]=_0x18ea4e,_0x57c7f2[_0x533469(0x14a)]=_0x323ca3;}),_0x55ee7d[_0x1564ea(0x174)]['role']!==_0x1564ea(0x16f)&&_0x46bc66['forEach'](_0x55c927=>_0x55c927[_0x1564ea(0x14a)]=(0x0,utils_1[_0x1564ea(0x13e)])(_0x55c927['email'])),_0x46bc66['forEach'](_0xa97b5f=>{const _0x28b89c=_0x1564ea;!_0xa97b5f[_0x28b89c(0x14a)]&&(_0xa97b5f[_0x28b89c(0x14a)]=(_0xa97b5f===null||_0xa97b5f===void 0x0?void 0x0:_0xa97b5f[_0x28b89c(0x198)])+_0x28b89c(0x140)),!_0xa97b5f[_0x28b89c(0x19e)]&&(_0xa97b5f[_0x28b89c(0x19e)]='游客'+(_0xa97b5f===null||_0xa97b5f===void 0x0?void 0x0:_0xa97b5f[_0x28b89c(0x198)]));}),{'rows':_0x46bc66,'count':_0x4e70aa};}async[_0x3cc1bf(0x165)](_0x477283,_0x3c527e){const _0x5db9d2=_0x3cc1bf,{id:_0x41206e}=_0x477283['user'],{groupId:_0x564e88}=_0x3c527e,_0x76310a={'userId':_0x41206e,'isDelete':![]};_0x564e88&&Object[_0x5db9d2(0x18a)](_0x76310a,{'groupId':_0x564e88});if(_0x564e88){const _0x21a946=await this[_0x5db9d2(0x18e)][_0x5db9d2(0x192)]({'where':{'isDelete':![]}});if(_0x21a946===0x0)return[];}const _0x4f4dd6=await this['chatLogEntity'][_0x5db9d2(0x185)]({'where':_0x76310a});return _0x4f4dd6[_0x5db9d2(0x15d)](_0x1242ab=>{const _0x596710=_0x5db9d2,{prompt:_0x483272,role:_0x1c2811,answer:_0x22abdd,createdAt:_0x48d1ad,model:_0x42b0a0,conversationOptions:_0x357f42,requestOptions:_0x57e2ed,id:_0x5bbf7d,promptTokens:_0x1b5e0d,completionTokens:_0x2abd05,totalTokens:_0x2b29d7,tts:_0x488bdc,file:_0x272dbc}=_0x1242ab;let _0x336b96=null,_0x166bb5=null;try{_0x336b96=JSON['parse'](_0x357f42),_0x166bb5=JSON['parse'](_0x57e2ed);}catch(_0x12e4e1){console['log']('error:\x20',_0x12e4e1);}return{'chatId':_0x5bbf7d,'tts':_0x488bdc,'dateTime':(0x0,utils_1[_0x596710(0x18b)])(_0x48d1ad),'text':_0x1c2811==='user'?_0x483272:_0x22abdd,'inversion':_0x1c2811==='user','error':![],'conversationOptions':_0x336b96,'requestOptions':_0x166bb5,'promptTokens':_0x1b5e0d,'completionTokens':_0x2abd05,'totalTokens':_0x2b29d7,'file':_0x272dbc};});}async[_0x3cc1bf(0x199)](_0x1b183d,_0x4bb87b){const _0x5e5128=_0x3cc1bf,{id:_0x5a38b5}=_0x1b183d[_0x5e5128(0x174)],{id:_0x4efc14}=_0x4bb87b,_0x259b8b=await this['chatLogEntity'][_0x5e5128(0x16c)]({'where':{'id':_0x4efc14,'userId':_0x5a38b5}});if(!_0x259b8b)throw new common_1[(_0x5e5128(0x176))](_0x5e5128(0x171),common_1[_0x5e5128(0x15c)][_0x5e5128(0x1a0)]);const _0x5251eb=await this['chatLogEntity'][_0x5e5128(0x19c)]({'id':_0x4efc14},{'isDelete':!![]});if(_0x5251eb['affected']>0x0)return'删除对话记录成功！';else throw new common_1['HttpException'](_0x5e5128(0x171),common_1[_0x5e5128(0x15c)][_0x5e5128(0x1a0)]);}async[_0x3cc1bf(0x143)](_0x596d71,_0x9b082a){const _0x3e45aa=_0x3cc1bf,{groupId:_0x302014}=_0x9b082a,{id:_0x50518b}=_0x596d71['user'],_0x33cede=await this[_0x3e45aa(0x18e)][_0x3e45aa(0x16c)]({'where':{'id':_0x302014,'userId':_0x50518b}});if(!_0x33cede)throw new common_1[(_0x3e45aa(0x176))](_0x3e45aa(0x171),common_1[_0x3e45aa(0x15c)]['BAD_REQUEST']);const _0x2c19bc=await this[_0x3e45aa(0x17b)]['update']({'groupId':_0x302014},{'isDelete':!![]});if(_0x2c19bc[_0x3e45aa(0x148)]>0x0)return'删除对话记录成功！';if(_0x2c19bc['affected']===0x0)throw new common_1[(_0x3e45aa(0x176))](_0x3e45aa(0x14c),common_1[_0x3e45aa(0x15c)][_0x3e45aa(0x1a0)]);}async[_0x3cc1bf(0x15e)](_0x3af77f,_0x5d63da){const _0x294915=_0x3cc1bf,{id:_0x3b2c74}=_0x3af77f[_0x294915(0x174)],{appId:_0x404d86,page:page=0x1,size:size=0xa}=_0x5d63da,[_0x41f08f,_0x4ed1f8]=await this[_0x294915(0x17b)][_0x294915(0x19b)]({'where':{'userId':_0x3b2c74,'appId':_0x404d86,'role':_0x294915(0x17d)},'order':{'id':_0x294915(0x141)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x41f08f,'count':_0x4ed1f8};}};ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x3cc1bf(0x19f)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x3cc1bf(0x193)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x3cc1bf(0x1a2)],typeorm_2[_0x3cc1bf(0x1a2)]])],ChatLogService),exports['ChatLogService']=ChatLogService;