'use strict';function _0x3f6f(){const _0x4c78e4=['SUCCESS','unsupported\x20pay\x20type','套餐不存在!','payPlatform','payWeChatAppId','21jxkzlM','../globalConfig/globalConfig.service','payMpayPid','hupi','payEpaySecret','payMpayReturnUrl','payWeChat','createRandomNonceStr','支付请求失败!','toFixed','now','2mcUvoR','HttpStatus','payWeChatH5Name','userBalanceService','userService','crypto','@nestjs/common','pay','time','wxpay','failed','toString','getOpenIdByUserId','wechat-pay:\x20','WxPay','sign_type','wx-native','payMpayApiQueryUrl','type','notify_url','UserService','订单不存在!','transactions_h5','affected','out_trade_no','trade_state','getOwnPropertyDescriptor','2717442lDPzVs','payEpayPid','decipher_gcm','__esModule','payWeChatNotifyUrl','本次支付类型:\x20','payEpayReturnUrl','payHupi','h5_info','payWeChatH5Url','money','text','join','total_fee','decorate','payHupiReturnUrl','wechat','UserBalanceService','native','支付请求失败:\x20','notifyMpay','payHupiAppId','submit.php','epay\x20--->\x20res:\x20','Injectable','typeorm','appid','__decorate','../userBalance/userBalance.service','mpay','name','payEpay','payMpayApiPayUrl','notifyHupi','event_type','1321518xkAyqf','payMpayNotifyUrl','trade_status','queryMpay','includes','2016900yMlCvc','payEpayApiPayUrl','1.1','payType:\x20','wechatpay-node-v3','10rPdrih','payMpaySecret','notifyEpay','payEpayNotifyUrl','status','function','payHupiGatewayUrl','addBalanceToOrder','length','payMpay','sort','keys','jsapi','axios','校验签名','update','response','defineProperty','payWeChatPublicKey','object','queryHupi','get','OrderEntity','342930DRPvNh','GlobalConfigService','epay','key','366382FmhPyu','payEpayApiQueryUrl','clientip','hex','param','TRADE_SUCCESS','orderEntity','resource','payHupiSecret','nonce_str','2674872JbqEjY','payWeChatMchId','https://api.xunhupay.com/payment/do.html','version','digest','findOne','success','total','query','微信H5支付失败！','md5','../crami/cramiPackage.entity','sign','BAD_REQUEST','getConfigs','Wap','cramiPackageEntity','Repository','trade_order_id','message','default','InjectRepository','log','onModuleInit','MD5','微信支付通知params:\x20','@nestjs/typeorm','order_no','design:paramtypes','pid','status:\x20','globalConfigService','metadata','goodsId','scene_info','notifyWeChat','payer','../../common/utils','216692YxliUh','../order/order.entity','192.168.1.100','hash','attach','post','return_url','HttpException','TRANSACTION.SUCCESS','payWeChatPrivateKey','../user/user.service','__metadata','alipay'];_0x3f6f=function(){return _0x4c78e4;};return _0x3f6f();}const _0x1e5596=_0x2e72;(function(_0x230d9e,_0x6bc27b){const _0x56c213=_0x2e72,_0x5bf79d=_0x230d9e();while(!![]){try{const _0x405780=-parseInt(_0x56c213(0x1a8))/0x1*(-parseInt(_0x56c213(0x15b))/0x2)+-parseInt(_0x56c213(0x19d))/0x3*(parseInt(_0x56c213(0x18b))/0x4)+-parseInt(_0x56c213(0x140))/0x5*(-parseInt(_0x56c213(0x136))/0x6)+parseInt(_0x56c213(0x157))/0x7+-parseInt(_0x56c213(0x165))/0x8+parseInt(_0x56c213(0x1c3))/0x9+-parseInt(_0x56c213(0x13b))/0xa;if(_0x405780===_0x6bc27b)break;else _0x5bf79d['push'](_0x5bf79d['shift']());}catch(_0x4fe97b){_0x5bf79d['push'](_0x5bf79d['shift']());}}}(_0x3f6f,0x3b37c));var __decorate=this&&this[_0x1e5596(0x1de)]||function(_0x1fe461,_0x59305b,_0x3bd2a1,_0x1f1f34){const _0xc43546=_0x1e5596;var _0x72341e=arguments[_0xc43546(0x148)],_0x30e9a1=_0x72341e<0x3?_0x59305b:_0x1f1f34===null?_0x1f1f34=Object[_0xc43546(0x1c2)](_0x59305b,_0x3bd2a1):_0x1f1f34,_0x4a6cf3;if(typeof Reflect===_0xc43546(0x153)&&typeof Reflect[_0xc43546(0x1d1)]==='function')_0x30e9a1=Reflect[_0xc43546(0x1d1)](_0x1fe461,_0x59305b,_0x3bd2a1,_0x1f1f34);else{for(var _0x3a2fdf=_0x1fe461[_0xc43546(0x148)]-0x1;_0x3a2fdf>=0x0;_0x3a2fdf--)if(_0x4a6cf3=_0x1fe461[_0x3a2fdf])_0x30e9a1=(_0x72341e<0x3?_0x4a6cf3(_0x30e9a1):_0x72341e>0x3?_0x4a6cf3(_0x59305b,_0x3bd2a1,_0x30e9a1):_0x4a6cf3(_0x59305b,_0x3bd2a1))||_0x30e9a1;}return _0x72341e>0x3&&_0x30e9a1&&Object['defineProperty'](_0x59305b,_0x3bd2a1,_0x30e9a1),_0x30e9a1;},__metadata=this&&this[_0x1e5596(0x196)]||function(_0x1f453d,_0x3ba84a){const _0xf884c4=_0x1e5596;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0xf884c4(0x145))return Reflect[_0xf884c4(0x185)](_0x1f453d,_0x3ba84a);},__param=this&&this['__param']||function(_0x31f809,_0x5ef01b){return function(_0x50d393,_0x35140c){_0x5ef01b(_0x50d393,_0x35140c,_0x31f809);};};Object[_0x1e5596(0x151)](exports,_0x1e5596(0x1c6),{'value':!![]}),exports['PayService']=void 0x0;const typeorm_1=require(_0x1e5596(0x17f)),typeorm_2=require(_0x1e5596(0x1dc)),common_1=require(_0x1e5596(0x1ae)),crypto=require(_0x1e5596(0x1ad)),axios_1=require(_0x1e5596(0x14d)),order_entity_1=require(_0x1e5596(0x18c)),cramiPackage_entity_1=require(_0x1e5596(0x170)),userBalance_service_1=require(_0x1e5596(0x1df)),globalConfig_service_1=require(_0x1e5596(0x19e)),utils_1=require(_0x1e5596(0x18a)),user_service_1=require(_0x1e5596(0x195));let PayService=class PayService{constructor(_0x5c81b3,_0x49b67d,_0x2e5ca3,_0x1a63b0,_0x538eee){const _0x4c48a3=_0x1e5596;this[_0x4c48a3(0x175)]=_0x5c81b3,this['orderEntity']=_0x49b67d,this[_0x4c48a3(0x1ab)]=_0x2e5ca3,this[_0x4c48a3(0x184)]=_0x1a63b0,this[_0x4c48a3(0x1ac)]=_0x538eee;}async[_0x1e5596(0x17c)](){const _0x82c58d=_0x1e5596,_0x181db9=await(0x0,utils_1['importDynamic'])(_0x82c58d(0x13f));this[_0x82c58d(0x1b6)]=(_0x181db9===null||_0x181db9===void 0x0?void 0x0:_0x181db9['default'])?_0x181db9[_0x82c58d(0x179)]:_0x181db9;}async['notify'](_0x264985){const _0xa18d50=_0x1e5596;if(_0x264985[_0xa18d50(0x15f)]==_0xa18d50(0x159))return this[_0xa18d50(0x142)](_0x264985);if(_0x264985['attach']==_0xa18d50(0x1a0))return this[_0xa18d50(0x134)](_0x264985);if(typeof _0x264985[_0xa18d50(0x162)]==_0xa18d50(0x153))return this['notifyWeChat'](_0x264985);return this[_0xa18d50(0x1d7)](_0x264985);}async[_0x1e5596(0x1af)](_0x2f1752,_0x3a2b61,_0x4bef4e='wxpay'){const _0x36f450=_0x1e5596,_0x333ec0=await this['orderEntity'][_0x36f450(0x16a)]({'where':{'userId':_0x2f1752,'orderId':_0x3a2b61}});if(!_0x333ec0)throw new common_1[(_0x36f450(0x192))](_0x36f450(0x1bd),common_1[_0x36f450(0x1a9)][_0x36f450(0x172)]);const _0x91b4ef=await this[_0x36f450(0x175)][_0x36f450(0x16a)]({'where':{'id':_0x333ec0[_0x36f450(0x186)]}});if(!_0x91b4ef)throw new common_1[(_0x36f450(0x192))]('套餐不存在!',common_1[_0x36f450(0x1a9)][_0x36f450(0x172)]);console[_0x36f450(0x17b)](_0x36f450(0x1c8),_0x333ec0[_0x36f450(0x19b)]);try{if(_0x333ec0['payPlatform']==_0x36f450(0x1d3))return this[_0x36f450(0x1a3)](_0x2f1752,_0x3a2b61,_0x4bef4e);if(_0x333ec0['payPlatform']=='epay')return this[_0x36f450(0x132)](_0x2f1752,_0x3a2b61,_0x4bef4e);if(_0x333ec0[_0x36f450(0x19b)]==_0x36f450(0x1e0))return this['payMpay'](_0x2f1752,_0x3a2b61,_0x4bef4e);if(_0x333ec0[_0x36f450(0x19b)]==_0x36f450(0x1a0))return this[_0x36f450(0x1ca)](_0x2f1752,_0x3a2b61,_0x4bef4e);}catch(_0xabe0a2){console[_0x36f450(0x17b)](_0x36f450(0x1d6),_0xabe0a2);throw new common_1[(_0x36f450(0x192))](_0x36f450(0x1a5),common_1[_0x36f450(0x1a9)]['BAD_REQUEST']);}}async[_0x1e5596(0x16d)](_0x1645ab){const _0x3cc79d=_0x1e5596,_0x2ca759=await this[_0x3cc79d(0x161)][_0x3cc79d(0x16a)]({'where':{'orderId':_0x1645ab}});if(!_0x2ca759)throw new common_1[(_0x3cc79d(0x192))](_0x3cc79d(0x1bd),common_1[_0x3cc79d(0x1a9)][_0x3cc79d(0x172)]);return _0x2ca759;}async[_0x1e5596(0x134)](_0x496c33){const _0x40dccf=_0x1e5596,_0x1aec2a=await this[_0x40dccf(0x184)][_0x40dccf(0x173)](['payHupiSecret']),_0x44afe0=_0x496c33[_0x40dccf(0x18e)];delete _0x496c33['hash'];if(this[_0x40dccf(0x171)](_0x496c33,_0x1aec2a)!=_0x44afe0)return _0x40dccf(0x1b2);const _0x4533c5=await this[_0x40dccf(0x161)][_0x40dccf(0x16a)]({'where':{'orderId':_0x496c33['trade_order_id'],'status':0x0}});if(!_0x4533c5)return'failed';await this[_0x40dccf(0x1ab)][_0x40dccf(0x147)](_0x4533c5);const _0x352d81=await this[_0x40dccf(0x161)][_0x40dccf(0x14f)]({'orderId':_0x496c33[_0x40dccf(0x177)]},{'status':0x1,'paydAt':new Date()});if(_0x352d81[_0x40dccf(0x1bf)]!=0x1)return _0x40dccf(0x1b2);return'success';}async[_0x1e5596(0x1ca)](_0x25fa19,_0x29ed55,_0x542e21=_0x1e5596(0x1b1)){const _0xc518d=_0x1e5596,_0x37f39d=await this[_0xc518d(0x161)][_0xc518d(0x16a)]({'where':{'userId':_0x25fa19,'orderId':_0x29ed55}});if(!_0x37f39d)throw new common_1[(_0xc518d(0x192))]('订单不存在!',common_1['HttpStatus'][_0xc518d(0x172)]);const _0x27b34a=await this[_0xc518d(0x175)][_0xc518d(0x16a)]({'where':{'id':_0x37f39d[_0xc518d(0x186)]}});if(!_0x27b34a)throw new common_1[(_0xc518d(0x192))]('套餐不存在!',common_1[_0xc518d(0x1a9)]['BAD_REQUEST']);const {payHupiAppId:_0x3fa4a3,payHupiSecret:_0xb5a647,payHupiNotifyUrl:_0x1984d7,payHupiReturnUrl:_0x102eae,payHupiGatewayUrl:_0x1530c0}=await this['globalConfigService'][_0xc518d(0x173)]([_0xc518d(0x1d8),_0xc518d(0x163),'payHupiNotifyUrl',_0xc518d(0x1d2),_0xc518d(0x146)]),_0x454566={};_0x454566[_0xc518d(0x168)]=_0xc518d(0x13d),_0x454566[_0xc518d(0x1dd)]=_0x3fa4a3,_0x454566['time']=(Date[_0xc518d(0x1a7)]()/0x3e8)['toFixed'](0x0),_0x454566[_0xc518d(0x164)]=(0x0,utils_1[_0xc518d(0x1a4)])(0x20),_0x454566['trade_order_id']=_0x29ed55,_0x454566['title']=_0x27b34a['name'],_0x454566[_0xc518d(0x1d0)]=_0x37f39d['total'],_0x454566[_0xc518d(0x1bb)]=_0x1984d7,_0x454566[_0xc518d(0x191)]=_0x102eae,_0x454566[_0xc518d(0x18f)]=_0xc518d(0x1a0),_0x454566[_0xc518d(0x18e)]=this['sign'](_0x454566,_0xb5a647);const {data:{errcode:_0x1c2e72,errmsg:_0x4fd1e4,url_qrcode:_0x276363,url:_0x3aa50e}}=await axios_1[_0xc518d(0x179)][_0xc518d(0x190)](_0x1530c0||_0xc518d(0x167),_0x454566);if(_0x1c2e72!=0x0)throw new common_1['HttpException'](_0x4fd1e4,common_1[_0xc518d(0x1a9)]['BAD_REQUEST']);return{'url_qrcode':_0x276363,'url':_0x3aa50e};}async[_0x1e5596(0x154)](_0xa08c2f){const _0x2c4445=_0x1e5596,{payHupiAppId:_0x435e13,payHupiSecret:_0xde46a5}=await this[_0x2c4445(0x184)][_0x2c4445(0x173)](['payHupiAppId',_0x2c4445(0x163)]),_0x9751ce={};_0x9751ce['version']='1.1',_0x9751ce[_0x2c4445(0x1dd)]=_0x435e13,_0x9751ce[_0x2c4445(0x1b0)]=(Date['now']()/0x3e8)[_0x2c4445(0x1a6)](0x0),_0x9751ce[_0x2c4445(0x164)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x9751ce['out_trade_order']=_0xa08c2f,_0x9751ce['hash']=this['sign'](_0x9751ce,_0xde46a5);const {data:{errcode:_0x3a5294,errmsg:_0x500d13,data:_0x39b5d7}}=await axios_1[_0x2c4445(0x179)][_0x2c4445(0x190)]('https://api.xunhupay.com/payment/query.html',_0x9751ce);if(_0x3a5294!=0x0)throw new common_1[(_0x2c4445(0x192))](_0x500d13,common_1['HttpStatus'][_0x2c4445(0x172)]);return _0x39b5d7;}async[_0x1e5596(0x142)](_0x3ca449){const _0x1f7654=_0x1e5596,_0x14252f=_0x3ca449['sign'];delete _0x3ca449['sign'],delete _0x3ca449['sign_type'];const _0x30ead7=await this['globalConfigService'][_0x1f7654(0x173)](['payEpaySecret']);if(this[_0x1f7654(0x171)](_0x3ca449,_0x30ead7)!=_0x14252f)return _0x1f7654(0x1b2);console[_0x1f7654(0x17b)]('校验签名通过');const _0x19b94c=await this[_0x1f7654(0x161)][_0x1f7654(0x16a)]({'where':{'orderId':_0x3ca449['out_trade_no'],'status':0x0}});if(!_0x19b94c)return _0x1f7654(0x1b2);const _0x5107a6=_0x3ca449[_0x1f7654(0x138)]==_0x1f7654(0x160)?0x1:0x2,_0x3ad6f2=await this[_0x1f7654(0x161)]['update']({'orderId':_0x3ca449[_0x1f7654(0x1c0)]},{'status':_0x5107a6,'paydAt':new Date()});_0x5107a6===0x1&&await this[_0x1f7654(0x1ab)][_0x1f7654(0x147)](_0x19b94c);if(_0x3ad6f2[_0x1f7654(0x1bf)]!=0x1)return'failed';return _0x1f7654(0x16b);}async[_0x1e5596(0x132)](_0x5d68c5,_0x21dc0c,_0x4af57f=_0x1e5596(0x197)){const _0x1b586c=_0x1e5596,_0x2d1cf7=await this[_0x1b586c(0x161)][_0x1b586c(0x16a)]({'where':{'userId':_0x5d68c5,'orderId':_0x21dc0c}});if(!_0x2d1cf7)throw new common_1['HttpException'](_0x1b586c(0x1bd),common_1['HttpStatus'][_0x1b586c(0x172)]);const _0x3f32cc=await this[_0x1b586c(0x175)][_0x1b586c(0x16a)]({'where':{'id':_0x2d1cf7[_0x1b586c(0x186)]}});if(!_0x3f32cc)throw new common_1[(_0x1b586c(0x192))](_0x1b586c(0x19a),common_1[_0x1b586c(0x1a9)][_0x1b586c(0x172)]);const {payEpayPid:_0x18368b,payEpaySecret:_0x57c9c0,payEpayNotifyUrl:_0x348ab2,payEpayReturnUrl:_0x481fc2,payEpayApiPayUrl:_0x185f23}=await this[_0x1b586c(0x184)][_0x1b586c(0x173)]([_0x1b586c(0x1c4),_0x1b586c(0x1a1),_0x1b586c(0x143),_0x1b586c(0x1c9),_0x1b586c(0x13c)]);let _0x38f9d8;_0x18368b['length']<=0x10?_0x38f9d8=Number(_0x18368b):_0x38f9d8=BigInt(_0x18368b);const _0x7f7b94={};_0x7f7b94['pid']=_0x38f9d8,_0x7f7b94[_0x1b586c(0x1ba)]=_0x4af57f,_0x7f7b94['out_trade_no']=_0x21dc0c,_0x7f7b94[_0x1b586c(0x131)]=_0x3f32cc[_0x1b586c(0x131)],_0x7f7b94[_0x1b586c(0x1cd)]=_0x2d1cf7[_0x1b586c(0x16c)],_0x7f7b94[_0x1b586c(0x15d)]=_0x1b586c(0x18d),_0x7f7b94['device']='pc',_0x7f7b94['notify_url']=_0x348ab2,_0x7f7b94[_0x1b586c(0x191)]=_0x481fc2,_0x7f7b94[_0x1b586c(0x15f)]=_0x1b586c(0x159),_0x7f7b94['sign']=this[_0x1b586c(0x171)](_0x7f7b94,_0x57c9c0),_0x7f7b94['sign_type']=_0x1b586c(0x17d);const _0x3ca952=new URLSearchParams(_0x7f7b94)['toString'](),_0xa54e48=_0x185f23+'?'+_0x3ca952;if(_0x185f23[_0x1b586c(0x13a)](_0x1b586c(0x1d9)))return{'url_qrcode':null,'redirectUrl':_0xa54e48,'channel':_0x4af57f,'isRedirect':!![]};else{const _0x378c57=await axios_1[_0x1b586c(0x179)][_0x1b586c(0x155)](_0x185f23,{'params':_0x7f7b94});console[_0x1b586c(0x17b)](_0x1b586c(0x1da),_0x378c57['data']);const {data:{code:_0x4be2c5,msg:_0x579b46,qrcode:_0x2e4952}}=_0x378c57;if(_0x4be2c5!=0x1)throw new common_1[(_0x1b586c(0x192))](_0x579b46,common_1[_0x1b586c(0x1a9)][_0x1b586c(0x172)]);return{'url_qrcode':_0x2e4952,'redirectUrl':null,'channel':_0x4af57f,'isRedirect':![]};}}async['queryEpay'](_0x27590e){const _0x9fdbe0=_0x1e5596,{payEpayPid:_0x3ac53d,payEpaySecret:_0x22199c,payEpayApiQueryUrl:_0x9d7ef9}=await this[_0x9fdbe0(0x184)][_0x9fdbe0(0x173)]([_0x9fdbe0(0x1c4),'payEpaySecret',_0x9fdbe0(0x15c)]),_0x1cc5e4={};_0x1cc5e4['act']='order',_0x1cc5e4[_0x9fdbe0(0x1c0)]=_0x27590e,_0x1cc5e4[_0x9fdbe0(0x182)]=_0x3ac53d,_0x1cc5e4[_0x9fdbe0(0x15a)]=_0x22199c;const {data:{code:_0x3f5186,msg:_0x396b31,data:_0xfdcf45}}=await axios_1[_0x9fdbe0(0x179)][_0x9fdbe0(0x155)](_0x9d7ef9,{'params':_0x1cc5e4});if(_0x3f5186!=0x1)throw new common_1[(_0x9fdbe0(0x192))](_0x396b31,common_1[_0x9fdbe0(0x1a9)]['BAD_REQUEST']);return _0xfdcf45;}async[_0x1e5596(0x1d7)](_0x4d537a){const _0x2984c6=_0x1e5596,_0x5daf2d=_0x4d537a['sign'];delete _0x4d537a[_0x2984c6(0x171)],delete _0x4d537a[_0x2984c6(0x1b7)];const _0x73efbf=await this[_0x2984c6(0x184)][_0x2984c6(0x173)](['payMpaySecret']);console['log'](_0x2984c6(0x14e));if(this[_0x2984c6(0x171)](_0x4d537a,_0x73efbf)!=_0x5daf2d)return _0x2984c6(0x1b2);console['log']('校验签名通过');const _0x357c71=await this['orderEntity'][_0x2984c6(0x16a)]({'where':{'orderId':_0x4d537a[_0x2984c6(0x1c0)],'status':0x0}});if(!_0x357c71)return _0x2984c6(0x1b2);const _0x3667b8=_0x4d537a[_0x2984c6(0x138)]==_0x2984c6(0x160)?0x1:0x2;console[_0x2984c6(0x17b)](_0x2984c6(0x183),_0x3667b8);const _0x4421e1=await this[_0x2984c6(0x161)]['update']({'orderId':_0x4d537a[_0x2984c6(0x1c0)]},{'status':_0x3667b8,'paydAt':new Date()});_0x3667b8===0x1&&await this[_0x2984c6(0x1ab)][_0x2984c6(0x147)](_0x357c71);if(_0x4421e1[_0x2984c6(0x1bf)]!=0x1)return _0x2984c6(0x1b2);return _0x2984c6(0x16b);}async[_0x1e5596(0x149)](_0x43ab2e,_0x50c10d,_0xbe5202=_0x1e5596(0x1b1)){const _0x1cb022=_0x1e5596,_0x323af4=await this[_0x1cb022(0x161)][_0x1cb022(0x16a)]({'where':{'userId':_0x43ab2e,'orderId':_0x50c10d}});if(!_0x323af4)throw new common_1['HttpException'](_0x1cb022(0x1bd),common_1[_0x1cb022(0x1a9)]['BAD_REQUEST']);const _0x267bda=await this[_0x1cb022(0x175)][_0x1cb022(0x16a)]({'where':{'id':_0x323af4[_0x1cb022(0x186)]}});if(!_0x267bda)throw new common_1[(_0x1cb022(0x192))](_0x1cb022(0x19a),common_1[_0x1cb022(0x1a9)][_0x1cb022(0x172)]);const {payMpayPid:_0xe5e467,payMpaySecret:_0x35db10,payMpayNotifyUrl:_0x4e484b,payMpayReturnUrl:_0x30a54c,payMpayApiPayUrl:_0x29527e}=await this[_0x1cb022(0x184)]['getConfigs'](['payMpayPid',_0x1cb022(0x141),_0x1cb022(0x137),_0x1cb022(0x1a2),_0x1cb022(0x133)]),_0x1e317e={};_0x1e317e[_0x1cb022(0x182)]=Number(_0xe5e467),_0x1e317e[_0x1cb022(0x1ba)]=_0xbe5202,_0x1e317e[_0x1cb022(0x1c0)]=_0x50c10d,_0x1e317e['name']=_0x267bda[_0x1cb022(0x131)],_0x1e317e[_0x1cb022(0x1cd)]=_0x323af4[_0x1cb022(0x16c)],_0x1e317e['notify_url']=_0x4e484b,_0x1e317e[_0x1cb022(0x191)]=_0x30a54c,_0x1e317e[_0x1cb022(0x171)]=this[_0x1cb022(0x171)](_0x1e317e,_0x35db10),_0x1e317e['sign_type']=_0x1cb022(0x17d);const _0x8b777c=new URLSearchParams(_0x1e317e)[_0x1cb022(0x1b3)](),_0x5cfb08=_0x29527e+'?'+_0x8b777c;return{'url_qrcode':null,'redirectUrl':_0x5cfb08,'channel':_0xbe5202,'isRedirect':!![]};const _0x29e48c=await axios_1[_0x1cb022(0x179)][_0x1cb022(0x155)](_0x29527e,{'params':_0x1e317e});}async[_0x1e5596(0x139)](_0x25e0b0){const _0x469860=_0x1e5596,{payMpayApiQueryUrl:_0xd37416}=await this[_0x469860(0x184)][_0x469860(0x173)]([_0x469860(0x19f),'payMpaySecret',_0x469860(0x1b9)]),_0x2e7065={};_0x2e7065[_0x469860(0x1ba)]=0x2,_0x2e7065[_0x469860(0x180)]=_0x25e0b0;const {data:{code:_0x30317a,msg:_0x22bc01,data:_0xf83dad}}=await axios_1['default'][_0x469860(0x155)](_0xd37416,{'params':_0x2e7065});if(_0x30317a!=0x1)throw new common_1[(_0x469860(0x192))](_0x22bc01,common_1[_0x469860(0x1a9)][_0x469860(0x172)]);return _0xf83dad;}async[_0x1e5596(0x188)](_0xe838fa){const _0x174715=_0x1e5596;console['log'](_0x174715(0x17e),_0xe838fa);const {payWeChatAppId:_0x331873,payWeChatMchId:_0x369307,payWeChatSecret:_0xb9aa56,payWeChatPublicKey:_0x4e31e4,payWeChatPrivateKey:_0x475879}=await this['globalConfigService'][_0x174715(0x173)]([_0x174715(0x19c),'payWeChatMchId','payWeChatSecret','payWeChatPublicKey',_0x174715(0x194)]),_0xf6e9d5=new this['WxPay']({'appid':_0x331873,'mchid':_0x369307,'publicKey':_0x4e31e4,'privateKey':_0x475879});try{if(_0xe838fa[_0x174715(0x135)]==_0x174715(0x193)){const {ciphertext:_0x169fff,associated_data:_0x185ebd,nonce:_0x4558c5}=_0xe838fa['resource'],_0x47f2d7=_0xf6e9d5[_0x174715(0x1c5)](_0x169fff,_0x185ebd,_0x4558c5,_0xb9aa56),_0x3e8f12=await this[_0x174715(0x161)]['findOne']({'where':{'orderId':_0x47f2d7[_0x174715(0x1c0)],'status':0x0}});if(!_0x3e8f12)return'failed';const _0x2c79db=_0x47f2d7[_0x174715(0x1c1)]==_0x174715(0x198)?0x1:0x2,_0x317283=await this[_0x174715(0x161)][_0x174715(0x14f)]({'orderId':_0x47f2d7[_0x174715(0x1c0)]},{'status':_0x2c79db,'paydAt':new Date()});_0x2c79db===0x1&&await this[_0x174715(0x1ab)][_0x174715(0x147)](_0x3e8f12);if(_0x317283[_0x174715(0x1bf)]!=0x1)return _0x174715(0x1b2);}return'success';}catch(_0x4e7d4f){return console[_0x174715(0x17b)]('error:\x20',_0x4e7d4f),console['log']('支付通知验证失败:\x20',_0x4e7d4f),_0x174715(0x1b2);}}async['payWeChat'](_0x2fd33f,_0x454713,_0x33e76b=_0x1e5596(0x1d5)){const _0x2cae63=_0x1e5596;var _0x3f38a6,_0x719a86,_0x4582e7;console[_0x2cae63(0x17b)](_0x2cae63(0x13e),_0x33e76b);const _0x2140c2=await this[_0x2cae63(0x161)][_0x2cae63(0x16a)]({'where':{'userId':_0x2fd33f,'orderId':_0x454713}});if(!_0x2140c2)throw new common_1[(_0x2cae63(0x192))](_0x2cae63(0x1bd),common_1[_0x2cae63(0x1a9)][_0x2cae63(0x172)]);const _0x17b1d6=await this[_0x2cae63(0x175)][_0x2cae63(0x16a)]({'where':{'id':_0x2140c2['goodsId']}});if(!_0x17b1d6)throw new common_1[(_0x2cae63(0x192))](_0x2cae63(0x19a),common_1[_0x2cae63(0x1a9)][_0x2cae63(0x172)]);const {payWeChatAppId:_0x49c414,payWeChatMchId:_0x39b847,payWeChatPublicKey:_0xacce6a,payWeChatPrivateKey:_0x536438,payWeChatNotifyUrl:_0x1d9a20,payWeChatH5Name:_0x4e799a,payWeChatH5Url:_0x57b757}=await this['globalConfigService'][_0x2cae63(0x173)]([_0x2cae63(0x19c),_0x2cae63(0x166),_0x2cae63(0x152),_0x2cae63(0x194),_0x2cae63(0x1c7),_0x2cae63(0x1aa),_0x2cae63(0x1cc)]),_0x3ecae0=new this[(_0x2cae63(0x1b6))]({'appid':_0x49c414,'mchid':_0x39b847,'publicKey':_0xacce6a,'privateKey':_0x536438}),_0x410d98={'appid':_0x49c414,'mchid':_0x39b847,'description':_0x17b1d6[_0x2cae63(0x131)],'out_trade_no':_0x454713,'notify_url':_0x1d9a20,'amount':{'total':Number(_0x2140c2[_0x2cae63(0x16c)]*0x64)},'scene_info':{'payer_client_ip':'192.168.1.100'}};console[_0x2cae63(0x17b)](_0x2cae63(0x1b5),_0x410d98);if(_0x33e76b=='h5'){_0x410d98[_0x2cae63(0x187)][_0x2cae63(0x1cb)]={'type':_0x2cae63(0x174),'app_name':_0x4e799a,'app_url':_0x57b757};const _0x3b1e7e=await _0x3ecae0[_0x2cae63(0x1be)](_0x410d98);if(_0x3b1e7e[_0x2cae63(0x144)]===0x193){const _0xf36cc0=(_0x4582e7=(_0x719a86=(_0x3f38a6=_0x3b1e7e===null||_0x3b1e7e===void 0x0?void 0x0:_0x3b1e7e['errRaw'])===null||_0x3f38a6===void 0x0?void 0x0:_0x3f38a6[_0x2cae63(0x150)])===null||_0x719a86===void 0x0?void 0x0:_0x719a86[_0x2cae63(0x1ce)])===null||_0x4582e7===void 0x0?void 0x0:_0x4582e7['message'];throw new common_1[(_0x2cae63(0x192))]((_0x3b1e7e===null||_0x3b1e7e===void 0x0?void 0x0:_0x3b1e7e[_0x2cae63(0x178)])||_0x2cae63(0x16e),common_1[_0x2cae63(0x1a9)][_0x2cae63(0x172)]);}const {h5_url:_0xaaf02c}=_0x3b1e7e;return{'url':_0xaaf02c};}if(_0x33e76b==_0x2cae63(0x14c)){const _0x142669=await this[_0x2cae63(0x1ac)][_0x2cae63(0x1b4)](_0x2fd33f);console[_0x2cae63(0x17b)]('用户openId:\x20',_0x142669),_0x410d98[_0x2cae63(0x189)]={'openid':_0x142669};const _0x5f9b42=await _0x3ecae0['transactions_jsapi'](_0x410d98);return console[_0x2cae63(0x17b)]('jsapi支付结果返回值:\x20',_0x5f9b42),_0x5f9b42;}if(_0x33e76b==_0x2cae63(0x1d5)){const _0xeeb5a5=await _0x3ecae0['transactions_native'](_0x410d98),{code_url:_0x24efcf}=_0xeeb5a5;return!_0x24efcf&&console[_0x2cae63(0x17b)](_0x2cae63(0x1b8),_0xeeb5a5),{'url_qrcode':_0x24efcf,'isRedirect':![]};}throw new common_1[(_0x2cae63(0x192))](_0x2cae63(0x199),common_1[_0x2cae63(0x1a9)][_0x2cae63(0x172)]);}async['queryWeChat'](_0x11edb1){const _0x36f368=_0x1e5596,{payWeChatAppId:_0x8d2d21,payWeChatMchId:_0x4f46b0,payWeChatPublicKey:_0x426bdb,payWeChatPrivateKey:_0x3470a6,payWeChatNotifyUrl:_0x3dbb7d,payWeChatH5Name:_0x489a06,payWeChatH5Url:_0x1aab19}=await this[_0x36f368(0x184)][_0x36f368(0x173)](['payWeChatAppId',_0x36f368(0x166),_0x36f368(0x152),'payWeChatPrivateKey']),_0x33f8dd=new this[(_0x36f368(0x1b6))]({'appid':_0x8d2d21,'mchid':_0x4f46b0,'publicKey':_0x426bdb,'privateKey':_0x3470a6}),_0x3e0a6b=await _0x33f8dd[_0x36f368(0x16d)]({'out_trade_no':_0x11edb1});return _0x3e0a6b;}[_0x1e5596(0x171)](_0x1f6eae,_0x5b32e4){const _0x301b28=_0x1e5596,_0x1c69fe=Object[_0x301b28(0x14b)](_0x1f6eae)[_0x301b28(0x14a)]()['map'](_0xb4aeb3=>_0xb4aeb3+'='+_0x1f6eae[_0xb4aeb3])[_0x301b28(0x1cf)]('&')+_0x5b32e4;return crypto['createHash'](_0x301b28(0x16f))[_0x301b28(0x14f)](_0x1c69fe)[_0x301b28(0x169)](_0x301b28(0x15e));}};function _0x2e72(_0x1b1faa,_0x28a0e9){const _0x3f6fff=_0x3f6f();return _0x2e72=function(_0x2e7208,_0x4dfe58){_0x2e7208=_0x2e7208-0x131;let _0x1e8546=_0x3f6fff[_0x2e7208];return _0x1e8546;},_0x2e72(_0x1b1faa,_0x28a0e9);}PayService=__decorate([(0x0,common_1[_0x1e5596(0x1db)])(),__param(0x0,(0x0,typeorm_1[_0x1e5596(0x17a)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x1e5596(0x156)])),__metadata(_0x1e5596(0x181),[typeorm_2[_0x1e5596(0x176)],typeorm_2['Repository'],userBalance_service_1[_0x1e5596(0x1d4)],globalConfig_service_1[_0x1e5596(0x158)],user_service_1[_0x1e5596(0x1bc)]])],PayService),exports['PayService']=PayService;