'use strict';const _0x4aa1ab=_0x4d84;(function(_0x1c0e76,_0x391961){const _0x510c6b=_0x4d84,_0x18be58=_0x1c0e76();while(!![]){try{const _0x2eb005=parseInt(_0x510c6b(0x26d))/0x1*(-parseInt(_0x510c6b(0x212))/0x2)+-parseInt(_0x510c6b(0x1fe))/0x3*(parseInt(_0x510c6b(0x209))/0x4)+-parseInt(_0x510c6b(0x240))/0x5+-parseInt(_0x510c6b(0x21f))/0x6+parseInt(_0x510c6b(0x27c))/0x7+parseInt(_0x510c6b(0x1f6))/0x8*(-parseInt(_0x510c6b(0x270))/0x9)+parseInt(_0x510c6b(0x247))/0xa*(parseInt(_0x510c6b(0x238))/0xb);if(_0x2eb005===_0x391961)break;else _0x18be58['push'](_0x18be58['shift']());}catch(_0x2cc040){_0x18be58['push'](_0x18be58['shift']());}}}(_0x5016,0xd41a7));function _0x5016(){const _0x601891=['findOne','4tVaTRi','join','wechatpay-node-v3','typeorm','unsupported\x20pay\x20type','epay\x20--->\x20res:\x20','jsapi','onModuleInit','payWeChat','172178cYlfOf','default','log','MD5','wechat','type','OrderEntity','axios','sign_type','https://api.xunhupay.com/payment/query.html','importDynamic','trade_order_id','digest','4664988LxlDud','__decorate','notifyWeChat','crypto','notifyEpay','payEpay','globalConfigService','notify','微信H5支付失败！','failed','act','套餐不存在!','PayService','queryWeChat','update','HttpStatus','GlobalConfigService','wx-native','createRandomNonceStr','hupi','notify_url','payPlatform','../crami/cramiPackage.entity','scene_info','length','11bTeJvg','mpay','includes','Repository','toString','payEpayPid','192.168.1.100','goodsId','7285060LHKkyR','money','device','decipher_gcm','total','queryMpay','payHupiSecret','54901190qEFwli','trade_status','payMpaySecret','metadata','https://api.xunhupay.com/payment/do.html','function','getOpenIdByUserId','payWeChatH5Url','__metadata','payMpayNotifyUrl','param','key','../userBalance/userBalance.service','userService','wxpay','jsapi支付结果返回值:\x20','version','epay','response','title','out_trade_no','status','name','WxPay','Injectable','SUCCESS','hash','createHash','payEpayApiQueryUrl','UserService','resource','transactions_native','hex','../globalConfig/globalConfig.service','getConfigs','payHupi','notifyMpay','payEpaySecret','3XDuyDl','appid','payWeChatMchId','4041306WXeHkS','wechat-pay:\x20','sign','payer','message','post','payWeChatPrivateKey','__param','affected','TRADE_SUCCESS','sort','success','1019011HTSpEk','pid','notifyHupi','status:\x20','now','用户openId:\x20','payMpay','addBalanceToOrder','decorate','pay','errRaw','payHupiGatewayUrl','@nestjs/typeorm','payHupiReturnUrl','BAD_REQUEST','object','HttpException','query','1.1','payWeChatAppId','toFixed','alipay','../user/user.service','payHupiAppId','支付请求失败!','payWeChatNotifyUrl','payMpayApiPayUrl','get','transactions_h5','text','userBalanceService','InjectRepository','16uHmVoR','attach','orderEntity','payMpayPid','h5_info','订单不存在!','UserBalanceService','map','4128216cyDfIY','../../common/utils','time','payWeChatPublicKey','return_url','keys','total_fee','Wap','支付请求失败:\x20','cramiPackageEntity'];_0x5016=function(){return _0x601891;};return _0x5016();}var __decorate=this&&this[_0x4aa1ab(0x220)]||function(_0x1b2c3c,_0x55384d,_0x17ba3f,_0x9a979c){const _0x1e6b21=_0x4aa1ab;var _0x164102=arguments[_0x1e6b21(0x237)],_0x159871=_0x164102<0x3?_0x55384d:_0x9a979c===null?_0x9a979c=Object['getOwnPropertyDescriptor'](_0x55384d,_0x17ba3f):_0x9a979c,_0x457e12;if(typeof Reflect===_0x1e6b21(0x28b)&&typeof Reflect[_0x1e6b21(0x284)]===_0x1e6b21(0x24c))_0x159871=Reflect[_0x1e6b21(0x284)](_0x1b2c3c,_0x55384d,_0x17ba3f,_0x9a979c);else{for(var _0x3aacbf=_0x1b2c3c[_0x1e6b21(0x237)]-0x1;_0x3aacbf>=0x0;_0x3aacbf--)if(_0x457e12=_0x1b2c3c[_0x3aacbf])_0x159871=(_0x164102<0x3?_0x457e12(_0x159871):_0x164102>0x3?_0x457e12(_0x55384d,_0x17ba3f,_0x159871):_0x457e12(_0x55384d,_0x17ba3f))||_0x159871;}return _0x164102>0x3&&_0x159871&&Object['defineProperty'](_0x55384d,_0x17ba3f,_0x159871),_0x159871;},__metadata=this&&this[_0x4aa1ab(0x24f)]||function(_0x14b7eb,_0x1f71ce){const _0x4800c6=_0x4aa1ab;if(typeof Reflect===_0x4800c6(0x28b)&&typeof Reflect[_0x4800c6(0x24a)]===_0x4800c6(0x24c))return Reflect[_0x4800c6(0x24a)](_0x14b7eb,_0x1f71ce);},__param=this&&this[_0x4aa1ab(0x277)]||function(_0x5f5df4,_0x53c965){return function(_0x255404,_0xe2633e){_0x53c965(_0x255404,_0xe2633e,_0x5f5df4);};};function _0x4d84(_0x346f0b,_0x438d04){const _0x5016f4=_0x5016();return _0x4d84=function(_0x4d840b,_0xc4f984){_0x4d840b=_0x4d840b-0x1ee;let _0x1ff293=_0x5016f4[_0x4d840b];return _0x1ff293;},_0x4d84(_0x346f0b,_0x438d04);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['PayService']=void 0x0;const typeorm_1=require(_0x4aa1ab(0x288)),typeorm_2=require(_0x4aa1ab(0x20c)),common_1=require('@nestjs/common'),crypto=require(_0x4aa1ab(0x222)),axios_1=require(_0x4aa1ab(0x219)),order_entity_1=require('../order/order.entity'),cramiPackage_entity_1=require(_0x4aa1ab(0x235)),userBalance_service_1=require(_0x4aa1ab(0x253)),globalConfig_service_1=require(_0x4aa1ab(0x268)),utils_1=require(_0x4aa1ab(0x1ff)),user_service_1=require(_0x4aa1ab(0x292));let PayService=class PayService{constructor(_0x259b4f,_0x5b6219,_0xa4bf1d,_0x3e3af8,_0x2a5d33){const _0x13c8bb=_0x4aa1ab;this[_0x13c8bb(0x207)]=_0x259b4f,this['orderEntity']=_0x5b6219,this['userBalanceService']=_0xa4bf1d,this[_0x13c8bb(0x225)]=_0x3e3af8,this[_0x13c8bb(0x254)]=_0x2a5d33;}async[_0x4aa1ab(0x210)](){const _0x5ef53e=_0x4aa1ab,_0x168323=await(0x0,utils_1[_0x5ef53e(0x21c)])(_0x5ef53e(0x20b));this[_0x5ef53e(0x25e)]=(_0x168323===null||_0x168323===void 0x0?void 0x0:_0x168323[_0x5ef53e(0x213)])?_0x168323[_0x5ef53e(0x213)]:_0x168323;}async[_0x4aa1ab(0x226)](_0x5d2411){const _0x5f22f0=_0x4aa1ab;if(_0x5d2411['param']=='epay')return this[_0x5f22f0(0x223)](_0x5d2411);if(_0x5d2411[_0x5f22f0(0x1f7)]=='hupi')return this[_0x5f22f0(0x27e)](_0x5d2411);if(typeof _0x5d2411[_0x5f22f0(0x265)]==_0x5f22f0(0x28b))return this[_0x5f22f0(0x221)](_0x5d2411);return this['notifyMpay'](_0x5d2411);}async[_0x4aa1ab(0x285)](_0x5848a3,_0x580ffe,_0x1271ea=_0x4aa1ab(0x255)){const _0x5e7550=_0x4aa1ab,_0x26b9d2=await this['orderEntity'][_0x5e7550(0x208)]({'where':{'userId':_0x5848a3,'orderId':_0x580ffe}});if(!_0x26b9d2)throw new common_1[(_0x5e7550(0x28c))](_0x5e7550(0x1fb),common_1['HttpStatus'][_0x5e7550(0x28a)]);const _0x18107c=await this[_0x5e7550(0x207)][_0x5e7550(0x208)]({'where':{'id':_0x26b9d2['goodsId']}});if(!_0x18107c)throw new common_1[(_0x5e7550(0x28c))]('套餐不存在!',common_1[_0x5e7550(0x22e)]['BAD_REQUEST']);try{if(_0x26b9d2[_0x5e7550(0x234)]==_0x5e7550(0x216))return this[_0x5e7550(0x211)](_0x5848a3,_0x580ffe,_0x1271ea);if(_0x26b9d2[_0x5e7550(0x234)]==_0x5e7550(0x258))return this[_0x5e7550(0x224)](_0x5848a3,_0x580ffe,_0x1271ea);if(_0x26b9d2['payPlatform']==_0x5e7550(0x239))return this['payMpay'](_0x5848a3,_0x580ffe,_0x1271ea);if(_0x26b9d2[_0x5e7550(0x234)]==_0x5e7550(0x232))return this['payHupi'](_0x5848a3,_0x580ffe,_0x1271ea);}catch(_0x4bb5a6){console['log'](_0x5e7550(0x206),_0x4bb5a6);throw new common_1[(_0x5e7550(0x28c))](_0x5e7550(0x1ee),common_1[_0x5e7550(0x22e)][_0x5e7550(0x28a)]);}}async[_0x4aa1ab(0x28d)](_0x5ac5d8){const _0x4dd500=_0x4aa1ab,_0x5c59d1=await this[_0x4dd500(0x1f8)][_0x4dd500(0x208)]({'where':{'orderId':_0x5ac5d8}});if(!_0x5c59d1)throw new common_1['HttpException'](_0x4dd500(0x1fb),common_1[_0x4dd500(0x22e)]['BAD_REQUEST']);return _0x5c59d1;}async[_0x4aa1ab(0x27e)](_0x2c0fa3){const _0x51dade=_0x4aa1ab,_0xf99254=await this['globalConfigService'][_0x51dade(0x269)]([_0x51dade(0x246)]),_0x3a63ce=_0x2c0fa3['hash'];delete _0x2c0fa3[_0x51dade(0x261)];if(this[_0x51dade(0x272)](_0x2c0fa3,_0xf99254)!=_0x3a63ce)return _0x51dade(0x228);const _0x1c4511=await this[_0x51dade(0x1f8)][_0x51dade(0x208)]({'where':{'orderId':_0x2c0fa3['trade_order_id'],'status':0x0}});if(!_0x1c4511)return _0x51dade(0x228);await this['userBalanceService'][_0x51dade(0x283)](_0x1c4511);const _0x58381d=await this['orderEntity'][_0x51dade(0x22d)]({'orderId':_0x2c0fa3[_0x51dade(0x21d)]},{'status':0x1,'paydAt':new Date()});if(_0x58381d[_0x51dade(0x278)]!=0x1)return _0x51dade(0x228);return _0x51dade(0x27b);}async[_0x4aa1ab(0x26a)](_0x5ac5c7,_0xdd2212,_0xba5a85='wxpay'){const _0x541b62=_0x4aa1ab,_0x3dbc10=await this['orderEntity'][_0x541b62(0x208)]({'where':{'userId':_0x5ac5c7,'orderId':_0xdd2212}});if(!_0x3dbc10)throw new common_1[(_0x541b62(0x28c))](_0x541b62(0x1fb),common_1[_0x541b62(0x22e)][_0x541b62(0x28a)]);const _0x5343f4=await this[_0x541b62(0x207)]['findOne']({'where':{'id':_0x3dbc10[_0x541b62(0x23f)]}});if(!_0x5343f4)throw new common_1[(_0x541b62(0x28c))]('套餐不存在!',common_1['HttpStatus'][_0x541b62(0x28a)]);const {payHupiAppId:_0x371969,payHupiSecret:_0x4ce86d,payHupiNotifyUrl:_0x62dc4d,payHupiReturnUrl:_0x3e7795,payHupiGatewayUrl:_0x1ac8c5}=await this[_0x541b62(0x225)][_0x541b62(0x269)]([_0x541b62(0x293),'payHupiSecret','payHupiNotifyUrl',_0x541b62(0x289),_0x541b62(0x287)]),_0x23ea95={};_0x23ea95['version']=_0x541b62(0x28e),_0x23ea95[_0x541b62(0x26e)]=_0x371969,_0x23ea95[_0x541b62(0x200)]=(Date[_0x541b62(0x280)]()/0x3e8)[_0x541b62(0x290)](0x0),_0x23ea95['nonce_str']=(0x0,utils_1[_0x541b62(0x231)])(0x20),_0x23ea95[_0x541b62(0x21d)]=_0xdd2212,_0x23ea95[_0x541b62(0x25a)]=_0x5343f4[_0x541b62(0x25d)],_0x23ea95[_0x541b62(0x204)]=_0x3dbc10[_0x541b62(0x244)],_0x23ea95[_0x541b62(0x233)]=_0x62dc4d,_0x23ea95[_0x541b62(0x202)]=_0x3e7795,_0x23ea95['attach']='hupi',_0x23ea95[_0x541b62(0x261)]=this[_0x541b62(0x272)](_0x23ea95,_0x4ce86d);const {data:{errcode:_0x1944fd,errmsg:_0x3910dc,url_qrcode:_0x316a81,url:_0x160a74}}=await axios_1['default']['post'](_0x1ac8c5||_0x541b62(0x24b),_0x23ea95);if(_0x1944fd!=0x0)throw new common_1[(_0x541b62(0x28c))](_0x3910dc,common_1[_0x541b62(0x22e)]['BAD_REQUEST']);return{'url_qrcode':_0x316a81,'url':_0x160a74};}async['queryHupi'](_0x111a64){const _0x23ffc4=_0x4aa1ab,{payHupiAppId:_0x4567fc,payHupiSecret:_0x5e790f}=await this['globalConfigService']['getConfigs']([_0x23ffc4(0x293),_0x23ffc4(0x246)]),_0x24dc78={};_0x24dc78[_0x23ffc4(0x257)]=_0x23ffc4(0x28e),_0x24dc78[_0x23ffc4(0x26e)]=_0x4567fc,_0x24dc78[_0x23ffc4(0x200)]=(Date[_0x23ffc4(0x280)]()/0x3e8)['toFixed'](0x0),_0x24dc78['nonce_str']=(0x0,utils_1[_0x23ffc4(0x231)])(0x20),_0x24dc78['out_trade_order']=_0x111a64,_0x24dc78[_0x23ffc4(0x261)]=this['sign'](_0x24dc78,_0x5e790f);const {data:{errcode:_0x1c3826,errmsg:_0x5c4663,data:_0x4e2e32}}=await axios_1[_0x23ffc4(0x213)][_0x23ffc4(0x275)](_0x23ffc4(0x21b),_0x24dc78);if(_0x1c3826!=0x0)throw new common_1[(_0x23ffc4(0x28c))](_0x5c4663,common_1['HttpStatus'][_0x23ffc4(0x28a)]);return _0x4e2e32;}async[_0x4aa1ab(0x223)](_0x1fb50a){const _0x45904b=_0x4aa1ab,_0x49b67e=_0x1fb50a['sign'];delete _0x1fb50a[_0x45904b(0x272)],delete _0x1fb50a[_0x45904b(0x21a)];const _0x1c6890=await this['globalConfigService'][_0x45904b(0x269)]([_0x45904b(0x26c)]);if(this['sign'](_0x1fb50a,_0x1c6890)!=_0x49b67e)return _0x45904b(0x228);const _0x510032=await this[_0x45904b(0x1f8)][_0x45904b(0x208)]({'where':{'orderId':_0x1fb50a['out_trade_no'],'status':0x0}});if(!_0x510032)return'failed';const _0x4a1e07=_0x1fb50a[_0x45904b(0x248)]==_0x45904b(0x279)?0x1:0x2,_0xed7706=await this[_0x45904b(0x1f8)]['update']({'orderId':_0x1fb50a[_0x45904b(0x25b)]},{'status':_0x4a1e07,'paydAt':new Date()});_0x4a1e07===0x1&&await this['userBalanceService'][_0x45904b(0x283)](_0x510032);if(_0xed7706['affected']!=0x1)return _0x45904b(0x228);return'success';}async['payEpay'](_0x34bedc,_0x15b624,_0x57cc3e=_0x4aa1ab(0x291)){const _0x124f03=_0x4aa1ab,_0x75576c=await this[_0x124f03(0x1f8)]['findOne']({'where':{'userId':_0x34bedc,'orderId':_0x15b624}});if(!_0x75576c)throw new common_1['HttpException']('订单不存在!',common_1[_0x124f03(0x22e)][_0x124f03(0x28a)]);const _0x2bca8f=await this['cramiPackageEntity'][_0x124f03(0x208)]({'where':{'id':_0x75576c[_0x124f03(0x23f)]}});if(!_0x2bca8f)throw new common_1[(_0x124f03(0x28c))]('套餐不存在!',common_1['HttpStatus'][_0x124f03(0x28a)]);const {payEpayPid:_0x5b8a83,payEpaySecret:_0x200d27,payEpayNotifyUrl:_0x9eb437,payEpayReturnUrl:_0x59eeb3,payEpayApiPayUrl:_0x25294f}=await this[_0x124f03(0x225)]['getConfigs']([_0x124f03(0x23d),'payEpaySecret','payEpayNotifyUrl','payEpayReturnUrl','payEpayApiPayUrl']);let _0x4a49d6;_0x5b8a83['length']<=0x10?_0x4a49d6=Number(_0x5b8a83):_0x4a49d6=BigInt(_0x5b8a83);const _0x28bf0d={};_0x28bf0d[_0x124f03(0x27d)]=_0x4a49d6,_0x28bf0d[_0x124f03(0x217)]=_0x57cc3e,_0x28bf0d[_0x124f03(0x25b)]=_0x15b624,_0x28bf0d[_0x124f03(0x25d)]=_0x2bca8f[_0x124f03(0x25d)],_0x28bf0d[_0x124f03(0x241)]=_0x75576c[_0x124f03(0x244)],_0x28bf0d['clientip']=_0x124f03(0x23e),_0x28bf0d[_0x124f03(0x242)]='pc',_0x28bf0d[_0x124f03(0x233)]=_0x9eb437,_0x28bf0d['return_url']=_0x59eeb3,_0x28bf0d[_0x124f03(0x251)]='epay',_0x28bf0d[_0x124f03(0x272)]=this[_0x124f03(0x272)](_0x28bf0d,_0x200d27),_0x28bf0d[_0x124f03(0x21a)]=_0x124f03(0x215);const _0x5b34b8=new URLSearchParams(_0x28bf0d)['toString'](),_0x335ecd=_0x25294f+'?'+_0x5b34b8;if(_0x25294f[_0x124f03(0x23a)]('submit.php'))return{'url_qrcode':null,'redirectUrl':_0x335ecd,'channel':_0x57cc3e,'isRedirect':!![]};else{const _0x3de619=await axios_1['default'][_0x124f03(0x1f1)](_0x25294f,{'params':_0x28bf0d});console['log'](_0x124f03(0x20e),_0x3de619['data']);const {data:{code:_0xba6a8e,msg:_0x512c7d,qrcode:_0x5ee866}}=_0x3de619;if(_0xba6a8e!=0x1)throw new common_1[(_0x124f03(0x28c))](_0x512c7d,common_1[_0x124f03(0x22e)][_0x124f03(0x28a)]);return{'url_qrcode':_0x5ee866,'redirectUrl':null,'channel':_0x57cc3e,'isRedirect':![]};}}async['queryEpay'](_0x47592f){const _0x114fc3=_0x4aa1ab,{payEpayPid:_0x60af0c,payEpaySecret:_0x478b28,payEpayApiQueryUrl:_0xce9d5a}=await this['globalConfigService'][_0x114fc3(0x269)](['payEpayPid',_0x114fc3(0x26c),_0x114fc3(0x263)]),_0x2d7619={};_0x2d7619[_0x114fc3(0x229)]='order',_0x2d7619['out_trade_no']=_0x47592f,_0x2d7619['pid']=_0x60af0c,_0x2d7619[_0x114fc3(0x252)]=_0x478b28;const {data:{code:_0x4a2174,msg:_0xbfd2c3,data:_0x276716}}=await axios_1[_0x114fc3(0x213)]['get'](_0xce9d5a,{'params':_0x2d7619});if(_0x4a2174!=0x1)throw new common_1[(_0x114fc3(0x28c))](_0xbfd2c3,common_1['HttpStatus']['BAD_REQUEST']);return _0x276716;}async[_0x4aa1ab(0x26b)](_0x523f07){const _0x142f0a=_0x4aa1ab,_0x379fe8=_0x523f07[_0x142f0a(0x272)];delete _0x523f07[_0x142f0a(0x272)],delete _0x523f07[_0x142f0a(0x21a)];const _0x4f4afe=await this[_0x142f0a(0x225)][_0x142f0a(0x269)](['payMpaySecret']);if(this[_0x142f0a(0x272)](_0x523f07,_0x4f4afe)!=_0x379fe8)return _0x142f0a(0x228);const _0x5ec5d4=await this[_0x142f0a(0x1f8)]['findOne']({'where':{'orderId':_0x523f07[_0x142f0a(0x25b)],'status':0x0}});if(!_0x5ec5d4)return _0x142f0a(0x228);const _0x157634=_0x523f07[_0x142f0a(0x248)]==_0x142f0a(0x279)?0x1:0x2;console[_0x142f0a(0x214)](_0x142f0a(0x27f),_0x157634);const _0x4544f0=await this[_0x142f0a(0x1f8)]['update']({'orderId':_0x523f07[_0x142f0a(0x25b)]},{'status':_0x157634,'paydAt':new Date()});_0x157634===0x1&&await this['userBalanceService']['addBalanceToOrder'](_0x5ec5d4);if(_0x4544f0[_0x142f0a(0x278)]!=0x1)return'failed';return _0x142f0a(0x27b);}async[_0x4aa1ab(0x282)](_0x3c0870,_0x307aa8,_0x3cee83='wxpay'){const _0x2c0e92=_0x4aa1ab,_0x3d3799=await this['orderEntity'][_0x2c0e92(0x208)]({'where':{'userId':_0x3c0870,'orderId':_0x307aa8}});if(!_0x3d3799)throw new common_1['HttpException'](_0x2c0e92(0x1fb),common_1[_0x2c0e92(0x22e)]['BAD_REQUEST']);const _0x4f70af=await this['cramiPackageEntity'][_0x2c0e92(0x208)]({'where':{'id':_0x3d3799[_0x2c0e92(0x23f)]}});if(!_0x4f70af)throw new common_1[(_0x2c0e92(0x28c))](_0x2c0e92(0x22a),common_1[_0x2c0e92(0x22e)]['BAD_REQUEST']);const {payMpayPid:_0x44eca2,payMpaySecret:_0x5adb6b,payMpayNotifyUrl:_0xd53a32,payMpayReturnUrl:_0x4ffee9,payMpayApiPayUrl:_0x2683d1}=await this[_0x2c0e92(0x225)][_0x2c0e92(0x269)](['payMpayPid',_0x2c0e92(0x249),_0x2c0e92(0x250),'payMpayReturnUrl',_0x2c0e92(0x1f0)]),_0xf14b7a={};_0xf14b7a[_0x2c0e92(0x27d)]=Number(_0x44eca2),_0xf14b7a[_0x2c0e92(0x217)]=_0x3cee83,_0xf14b7a['out_trade_no']=_0x307aa8,_0xf14b7a[_0x2c0e92(0x25d)]=_0x4f70af['name'],_0xf14b7a[_0x2c0e92(0x241)]=_0x3d3799[_0x2c0e92(0x244)],_0xf14b7a[_0x2c0e92(0x233)]=_0xd53a32,_0xf14b7a['return_url']=_0x4ffee9,_0xf14b7a[_0x2c0e92(0x272)]=this[_0x2c0e92(0x272)](_0xf14b7a,_0x5adb6b),_0xf14b7a[_0x2c0e92(0x21a)]=_0x2c0e92(0x215);const _0x328ac0=new URLSearchParams(_0xf14b7a)[_0x2c0e92(0x23c)](),_0x2140df=_0x2683d1+'?'+_0x328ac0;return{'url_qrcode':null,'redirectUrl':_0x2140df,'channel':_0x3cee83,'isRedirect':!![]};}async[_0x4aa1ab(0x245)](_0x36f9ab){const _0x369bdc=_0x4aa1ab,{payMpayApiQueryUrl:_0x196b5b}=await this[_0x369bdc(0x225)][_0x369bdc(0x269)]([_0x369bdc(0x1f9),_0x369bdc(0x249),'payMpayApiQueryUrl']),_0x857ef4={};_0x857ef4['type']=0x2,_0x857ef4['order_no']=_0x36f9ab;const {data:{code:_0x491dd7,msg:_0x133af5,data:_0x3880b3}}=await axios_1['default'][_0x369bdc(0x1f1)](_0x196b5b,{'params':_0x857ef4});if(_0x491dd7!=0x1)throw new common_1[(_0x369bdc(0x28c))](_0x133af5,common_1['HttpStatus'][_0x369bdc(0x28a)]);return _0x3880b3;}async[_0x4aa1ab(0x221)](_0x1f1e7a){const _0x299efa=_0x4aa1ab;console[_0x299efa(0x214)]('微信支付通知params:\x20',_0x1f1e7a);const {payWeChatAppId:_0x79535a,payWeChatMchId:_0x5bb36f,payWeChatSecret:_0x57946b,payWeChatPublicKey:_0x54a2d,payWeChatPrivateKey:_0x19c0c6}=await this[_0x299efa(0x225)][_0x299efa(0x269)]([_0x299efa(0x28f),_0x299efa(0x26f),'payWeChatSecret',_0x299efa(0x201),_0x299efa(0x276)]),_0x8615d1=new this[(_0x299efa(0x25e))]({'appid':_0x79535a,'mchid':_0x5bb36f,'publicKey':_0x54a2d,'privateKey':_0x19c0c6});try{if(_0x1f1e7a['event_type']=='TRANSACTION.SUCCESS'){const {ciphertext:_0x1a191d,associated_data:_0x236cfd,nonce:_0x2dfc75}=_0x1f1e7a[_0x299efa(0x265)],_0x388402=_0x8615d1[_0x299efa(0x243)](_0x1a191d,_0x236cfd,_0x2dfc75,_0x57946b),_0x4c2df4=await this['orderEntity'][_0x299efa(0x208)]({'where':{'orderId':_0x388402[_0x299efa(0x25b)],'status':0x0}});if(!_0x4c2df4)return _0x299efa(0x228);const _0x37b93c=_0x388402['trade_state']==_0x299efa(0x260)?0x1:0x2,_0x1ea0b3=await this[_0x299efa(0x1f8)][_0x299efa(0x22d)]({'orderId':_0x388402[_0x299efa(0x25b)]},{'status':_0x37b93c,'paydAt':new Date()});_0x37b93c===0x1&&await this[_0x299efa(0x1f4)]['addBalanceToOrder'](_0x4c2df4);if(_0x1ea0b3[_0x299efa(0x278)]!=0x1)return'failed';}return _0x299efa(0x27b);}catch(_0x2fa7d9){return console['log']('error:\x20',_0x2fa7d9),console['log']('支付通知验证失败:\x20',_0x2fa7d9),_0x299efa(0x228);}}async[_0x4aa1ab(0x211)](_0x3f1fe8,_0x1b9ac9,_0x570acd='native'){const _0x5a114d=_0x4aa1ab;var _0x22d799,_0x215081,_0x2831d7;console[_0x5a114d(0x214)]('payType:\x20',_0x570acd);const _0x58dc9c=await this[_0x5a114d(0x1f8)][_0x5a114d(0x208)]({'where':{'userId':_0x3f1fe8,'orderId':_0x1b9ac9}});if(!_0x58dc9c)throw new common_1['HttpException']('订单不存在!',common_1[_0x5a114d(0x22e)][_0x5a114d(0x28a)]);const _0x46d1c9=await this[_0x5a114d(0x207)][_0x5a114d(0x208)]({'where':{'id':_0x58dc9c[_0x5a114d(0x23f)]}});if(!_0x46d1c9)throw new common_1[(_0x5a114d(0x28c))](_0x5a114d(0x22a),common_1[_0x5a114d(0x22e)][_0x5a114d(0x28a)]);const {payWeChatAppId:_0x2a6649,payWeChatMchId:_0x717861,payWeChatPublicKey:_0x31936a,payWeChatPrivateKey:_0x143899,payWeChatNotifyUrl:_0x4ddb98,payWeChatH5Name:_0xcb198,payWeChatH5Url:_0x342efe}=await this[_0x5a114d(0x225)][_0x5a114d(0x269)]([_0x5a114d(0x28f),_0x5a114d(0x26f),_0x5a114d(0x201),_0x5a114d(0x276),_0x5a114d(0x1ef),'payWeChatH5Name',_0x5a114d(0x24e)]),_0x1cd053=new this['WxPay']({'appid':_0x2a6649,'mchid':_0x717861,'publicKey':_0x31936a,'privateKey':_0x143899}),_0x1249ce={'appid':_0x2a6649,'mchid':_0x717861,'description':_0x46d1c9[_0x5a114d(0x25d)],'out_trade_no':_0x1b9ac9,'notify_url':_0x4ddb98,'amount':{'total':Number(_0x58dc9c[_0x5a114d(0x244)]*0x64)},'scene_info':{'payer_client_ip':_0x5a114d(0x23e)}};console[_0x5a114d(0x214)](_0x5a114d(0x271),_0x1249ce);if(_0x570acd=='h5'){_0x1249ce[_0x5a114d(0x236)][_0x5a114d(0x1fa)]={'type':_0x5a114d(0x205),'app_name':_0xcb198,'app_url':_0x342efe};const _0x356822=await _0x1cd053[_0x5a114d(0x1f2)](_0x1249ce);if(_0x356822[_0x5a114d(0x25c)]===0x193){const _0x1debf5=(_0x2831d7=(_0x215081=(_0x22d799=_0x356822===null||_0x356822===void 0x0?void 0x0:_0x356822[_0x5a114d(0x286)])===null||_0x22d799===void 0x0?void 0x0:_0x22d799[_0x5a114d(0x259)])===null||_0x215081===void 0x0?void 0x0:_0x215081[_0x5a114d(0x1f3)])===null||_0x2831d7===void 0x0?void 0x0:_0x2831d7['message'];throw new common_1[(_0x5a114d(0x28c))]((_0x356822===null||_0x356822===void 0x0?void 0x0:_0x356822[_0x5a114d(0x274)])||_0x5a114d(0x227),common_1[_0x5a114d(0x22e)]['BAD_REQUEST']);}const {h5_url:_0x5c78c1}=_0x356822;return{'url':_0x5c78c1};}if(_0x570acd==_0x5a114d(0x20f)){const _0x4c803b=await this['userService'][_0x5a114d(0x24d)](_0x3f1fe8);console[_0x5a114d(0x214)](_0x5a114d(0x281),_0x4c803b),_0x1249ce[_0x5a114d(0x273)]={'openid':_0x4c803b};const _0x98add3=await _0x1cd053['transactions_jsapi'](_0x1249ce);return console[_0x5a114d(0x214)](_0x5a114d(0x256),_0x98add3),_0x98add3;}if(_0x570acd=='native'){const _0x19c274=await _0x1cd053[_0x5a114d(0x266)](_0x1249ce),{code_url:_0x3a29b9}=_0x19c274;return!_0x3a29b9&&console[_0x5a114d(0x214)](_0x5a114d(0x230),_0x19c274),{'url_qrcode':_0x3a29b9,'isRedirect':![]};}throw new common_1[(_0x5a114d(0x28c))](_0x5a114d(0x20d),common_1[_0x5a114d(0x22e)][_0x5a114d(0x28a)]);}async[_0x4aa1ab(0x22c)](_0x1d1318){const _0x3be97e=_0x4aa1ab,{payWeChatAppId:_0x55a815,payWeChatMchId:_0x3665e3,payWeChatPublicKey:_0x1051db,payWeChatPrivateKey:_0x2fb303,payWeChatNotifyUrl:_0x452c54,payWeChatH5Name:_0x5aa948,payWeChatH5Url:_0x286e5c}=await this['globalConfigService'][_0x3be97e(0x269)](['payWeChatAppId','payWeChatMchId',_0x3be97e(0x201),_0x3be97e(0x276)]),_0x514cea=new this['WxPay']({'appid':_0x55a815,'mchid':_0x3665e3,'publicKey':_0x1051db,'privateKey':_0x2fb303}),_0x504c55=await _0x514cea[_0x3be97e(0x28d)]({'out_trade_no':_0x1d1318});return _0x504c55;}[_0x4aa1ab(0x272)](_0x2dd6c2,_0x4ba9cb){const _0x289e48=_0x4aa1ab,_0x1dee15=Object[_0x289e48(0x203)](_0x2dd6c2)[_0x289e48(0x27a)]()[_0x289e48(0x1fd)](_0x1f88c9=>_0x1f88c9+'='+_0x2dd6c2[_0x1f88c9])[_0x289e48(0x20a)]('&')+_0x4ba9cb;return crypto[_0x289e48(0x262)]('md5')['update'](_0x1dee15)[_0x289e48(0x21e)](_0x289e48(0x267));}};PayService=__decorate([(0x0,common_1[_0x4aa1ab(0x25f)])(),__param(0x0,(0x0,typeorm_1[_0x4aa1ab(0x1f5)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1[_0x4aa1ab(0x1f5)])(order_entity_1[_0x4aa1ab(0x218)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x4aa1ab(0x23b)],userBalance_service_1[_0x4aa1ab(0x1fc)],globalConfig_service_1[_0x4aa1ab(0x22f)],user_service_1[_0x4aa1ab(0x264)]])],PayService),exports[_0x4aa1ab(0x22b)]=PayService;