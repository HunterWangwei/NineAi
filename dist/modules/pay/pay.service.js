'use strict';const _0x3bcfd7=_0x46d4;(function(_0x267d76,_0x490eb2){const _0x542564=_0x46d4,_0x143be5=_0x267d76();while(!![]){try{const _0x20273b=parseInt(_0x542564(0xcd))/0x1*(parseInt(_0x542564(0xdf))/0x2)+-parseInt(_0x542564(0xc6))/0x3+-parseInt(_0x542564(0xd2))/0x4+parseInt(_0x542564(0x100))/0x5*(-parseInt(_0x542564(0x107))/0x6)+parseInt(_0x542564(0x149))/0x7+-parseInt(_0x542564(0x124))/0x8+parseInt(_0x542564(0x129))/0x9*(parseInt(_0x542564(0x131))/0xa);if(_0x20273b===_0x490eb2)break;else _0x143be5['push'](_0x143be5['shift']());}catch(_0x433665){_0x143be5['push'](_0x143be5['shift']());}}}(_0x5da4,0x8c403));var __decorate=this&&this[_0x3bcfd7(0x133)]||function(_0x330d68,_0x208fcd,_0x2cf21e,_0x35d5c0){const _0x4c4b14=_0x3bcfd7;var _0xac6e56=arguments['length'],_0x5f2de1=_0xac6e56<0x3?_0x208fcd:_0x35d5c0===null?_0x35d5c0=Object['getOwnPropertyDescriptor'](_0x208fcd,_0x2cf21e):_0x35d5c0,_0x461cc3;if(typeof Reflect===_0x4c4b14(0x123)&&typeof Reflect[_0x4c4b14(0x143)]===_0x4c4b14(0xf8))_0x5f2de1=Reflect['decorate'](_0x330d68,_0x208fcd,_0x2cf21e,_0x35d5c0);else{for(var _0x1606c5=_0x330d68[_0x4c4b14(0x16d)]-0x1;_0x1606c5>=0x0;_0x1606c5--)if(_0x461cc3=_0x330d68[_0x1606c5])_0x5f2de1=(_0xac6e56<0x3?_0x461cc3(_0x5f2de1):_0xac6e56>0x3?_0x461cc3(_0x208fcd,_0x2cf21e,_0x5f2de1):_0x461cc3(_0x208fcd,_0x2cf21e))||_0x5f2de1;}return _0xac6e56>0x3&&_0x5f2de1&&Object[_0x4c4b14(0x168)](_0x208fcd,_0x2cf21e,_0x5f2de1),_0x5f2de1;},__metadata=this&&this['__metadata']||function(_0xd6fbc2,_0x196a01){const _0x4cc6cb=_0x3bcfd7;if(typeof Reflect===_0x4cc6cb(0x123)&&typeof Reflect[_0x4cc6cb(0xe1)]===_0x4cc6cb(0xf8))return Reflect['metadata'](_0xd6fbc2,_0x196a01);},__param=this&&this[_0x3bcfd7(0x160)]||function(_0xbfeadb,_0x5ba1d2){return function(_0x201a67,_0x488cae){_0x5ba1d2(_0x201a67,_0x488cae,_0xbfeadb);};};Object[_0x3bcfd7(0x168)](exports,_0x3bcfd7(0x119),{'value':!![]}),exports[_0x3bcfd7(0x14d)]=void 0x0;function _0x46d4(_0x421ba2,_0x367395){const _0x5da477=_0x5da4();return _0x46d4=function(_0x46d459,_0xa056fa){_0x46d459=_0x46d459-0xc6;let _0x8b1ded=_0x5da477[_0x46d459];return _0x8b1ded;},_0x46d4(_0x421ba2,_0x367395);}const typeorm_1=require(_0x3bcfd7(0x173)),typeorm_2=require('typeorm'),common_1=require('@nestjs/common'),crypto=require('crypto'),axios_1=require('axios'),order_entity_1=require(_0x3bcfd7(0xed)),cramiPackage_entity_1=require(_0x3bcfd7(0xd1)),userBalance_service_1=require(_0x3bcfd7(0x104)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),utils_1=require('../../common/utils'),user_service_1=require('../user/user.service');let PayService=class PayService{constructor(_0x5f2c1e,_0x25b09b,_0x17994e,_0x2a12c4,_0x2ee4b4){const _0x48b64=_0x3bcfd7;this[_0x48b64(0x116)]=_0x5f2c1e,this[_0x48b64(0xd5)]=_0x25b09b,this[_0x48b64(0xfc)]=_0x17994e,this[_0x48b64(0x106)]=_0x2a12c4,this['userService']=_0x2ee4b4;}async['onModuleInit'](){const _0x8b664a=_0x3bcfd7,_0x54e0b5=await(0x0,utils_1[_0x8b664a(0xce)])('wechatpay-node-v3');this['WxPay']=(_0x54e0b5===null||_0x54e0b5===void 0x0?void 0x0:_0x54e0b5[_0x8b664a(0xc8)])?_0x54e0b5[_0x8b664a(0xc8)]:_0x54e0b5;}async['notify'](_0x1b86d8){const _0x4783b4=_0x3bcfd7;if(_0x1b86d8[_0x4783b4(0xf9)]==_0x4783b4(0xcc))return this[_0x4783b4(0xf2)](_0x1b86d8);if(_0x1b86d8[_0x4783b4(0x148)]=='hupi')return this[_0x4783b4(0x147)](_0x1b86d8);if(typeof _0x1b86d8['resource']==_0x4783b4(0x123))return this[_0x4783b4(0x132)](_0x1b86d8);return this[_0x4783b4(0x109)](_0x1b86d8);}async['pay'](_0x6ef46e,_0x383642,_0x27dc6e=_0x3bcfd7(0xe9)){const _0x1fa6e0=_0x3bcfd7,_0x533e8f=await this[_0x1fa6e0(0xd5)][_0x1fa6e0(0x13c)]({'where':{'userId':_0x6ef46e,'orderId':_0x383642}});if(!_0x533e8f)throw new common_1['HttpException'](_0x1fa6e0(0xca),common_1[_0x1fa6e0(0x16e)]['BAD_REQUEST']);const _0x1c3e8e=await this[_0x1fa6e0(0x116)][_0x1fa6e0(0x13c)]({'where':{'id':_0x533e8f['goodsId']}});if(!_0x1c3e8e)throw new common_1[(_0x1fa6e0(0x13b))](_0x1fa6e0(0x11d),common_1[_0x1fa6e0(0x16e)][_0x1fa6e0(0x121)]);console[_0x1fa6e0(0x172)](_0x1fa6e0(0x15e),_0x533e8f[_0x1fa6e0(0x111)]);try{if(_0x533e8f['payPlatform']==_0x1fa6e0(0xee))return this[_0x1fa6e0(0x130)](_0x6ef46e,_0x383642,_0x27dc6e);if(_0x533e8f[_0x1fa6e0(0x111)]==_0x1fa6e0(0xcc))return this[_0x1fa6e0(0xfb)](_0x6ef46e,_0x383642,_0x27dc6e);if(_0x533e8f[_0x1fa6e0(0x111)]==_0x1fa6e0(0xfa))return this[_0x1fa6e0(0x10f)](_0x6ef46e,_0x383642,_0x27dc6e);if(_0x533e8f['payPlatform']=='hupi')return this[_0x1fa6e0(0x125)](_0x6ef46e,_0x383642,_0x27dc6e);}catch(_0x295c6d){console[_0x1fa6e0(0x172)](_0x1fa6e0(0x158),_0x295c6d);throw new common_1['HttpException'](_0x1fa6e0(0x138),common_1[_0x1fa6e0(0x16e)]['BAD_REQUEST']);}}async[_0x3bcfd7(0xe3)](_0x5e8acb){const _0x10b655=_0x3bcfd7,_0x2e21ac=await this[_0x10b655(0xd5)][_0x10b655(0x13c)]({'where':{'orderId':_0x5e8acb}});if(!_0x2e21ac)throw new common_1[(_0x10b655(0x13b))]('订单不存在!',common_1[_0x10b655(0x16e)][_0x10b655(0x121)]);return _0x2e21ac;}async[_0x3bcfd7(0x147)](_0x540882){const _0x2d1224=_0x3bcfd7,_0x23ac5a=await this[_0x2d1224(0x106)]['getConfigs']([_0x2d1224(0x141)]),_0x5077de=_0x540882[_0x2d1224(0xcf)];delete _0x540882[_0x2d1224(0xcf)];if(this[_0x2d1224(0x14f)](_0x540882,_0x23ac5a)!=_0x5077de)return _0x2d1224(0x151);const _0x51a726=await this[_0x2d1224(0xd5)]['findOne']({'where':{'orderId':_0x540882['trade_order_id'],'status':0x0}});if(!_0x51a726)return'failed';await this[_0x2d1224(0xfc)]['addBalanceToOrder'](_0x51a726);const _0x5202bb=await this[_0x2d1224(0xd5)][_0x2d1224(0x162)]({'orderId':_0x540882[_0x2d1224(0xd4)]},{'status':0x1,'paydAt':new Date()});if(_0x5202bb[_0x2d1224(0xf5)]!=0x1)return _0x2d1224(0x151);return _0x2d1224(0x12f);}async[_0x3bcfd7(0x125)](_0x550b3e,_0x534e24,_0x9d8d01=_0x3bcfd7(0xe9)){const _0x184a1c=_0x3bcfd7,_0x57e1a9=await this[_0x184a1c(0xd5)][_0x184a1c(0x13c)]({'where':{'userId':_0x550b3e,'orderId':_0x534e24}});if(!_0x57e1a9)throw new common_1[(_0x184a1c(0x13b))](_0x184a1c(0xca),common_1[_0x184a1c(0x16e)][_0x184a1c(0x121)]);const _0x332a73=await this[_0x184a1c(0x116)][_0x184a1c(0x13c)]({'where':{'id':_0x57e1a9['goodsId']}});if(!_0x332a73)throw new common_1[(_0x184a1c(0x13b))](_0x184a1c(0x11d),common_1[_0x184a1c(0x16e)][_0x184a1c(0x121)]);const {payHupiAppId:_0x20100d,payHupiSecret:_0x1f456a,payHupiNotifyUrl:_0x2094da,payHupiReturnUrl:_0x3a9914,payHupiGatewayUrl:_0x110215}=await this[_0x184a1c(0x106)][_0x184a1c(0xda)]([_0x184a1c(0x11a),_0x184a1c(0x141),_0x184a1c(0xe5),'payHupiReturnUrl','payHupiGatewayUrl']),_0x527e92={};_0x527e92[_0x184a1c(0xf7)]=_0x184a1c(0xe0),_0x527e92[_0x184a1c(0x12b)]=_0x20100d,_0x527e92[_0x184a1c(0xf0)]=(Date['now']()/0x3e8)[_0x184a1c(0x140)](0x0),_0x527e92[_0x184a1c(0xcb)]=(0x0,utils_1[_0x184a1c(0xd9)])(0x20),_0x527e92[_0x184a1c(0xd4)]=_0x534e24,_0x527e92[_0x184a1c(0x175)]=_0x332a73[_0x184a1c(0x163)],_0x527e92[_0x184a1c(0x14b)]=_0x57e1a9[_0x184a1c(0xf4)],_0x527e92['notify_url']=_0x2094da,_0x527e92[_0x184a1c(0x15c)]=_0x3a9914,_0x527e92[_0x184a1c(0x148)]=_0x184a1c(0xc7),_0x527e92[_0x184a1c(0xcf)]=this[_0x184a1c(0x14f)](_0x527e92,_0x1f456a);const {data:{errcode:_0xcad5c2,errmsg:_0x357e28,url_qrcode:_0x4a6501,url:_0x4e12f6}}=await axios_1[_0x184a1c(0xc8)]['post'](_0x110215||_0x184a1c(0x169),_0x527e92);if(_0xcad5c2!=0x0)throw new common_1['HttpException'](_0x357e28,common_1[_0x184a1c(0x16e)][_0x184a1c(0x121)]);return{'url_qrcode':_0x4a6501,'url':_0x4e12f6};}async[_0x3bcfd7(0xeb)](_0x456912){const _0x28ca5e=_0x3bcfd7,{payHupiAppId:_0x46a16e,payHupiSecret:_0x9edefc}=await this[_0x28ca5e(0x106)][_0x28ca5e(0xda)]([_0x28ca5e(0x11a),_0x28ca5e(0x141)]),_0x19d0d0={};_0x19d0d0['version']='1.1',_0x19d0d0[_0x28ca5e(0x12b)]=_0x46a16e,_0x19d0d0[_0x28ca5e(0xf0)]=(Date[_0x28ca5e(0xd3)]()/0x3e8)[_0x28ca5e(0x140)](0x0),_0x19d0d0['nonce_str']=(0x0,utils_1[_0x28ca5e(0xd9)])(0x20),_0x19d0d0[_0x28ca5e(0x14e)]=_0x456912,_0x19d0d0[_0x28ca5e(0xcf)]=this['sign'](_0x19d0d0,_0x9edefc);const {data:{errcode:_0x180884,errmsg:_0x41765f,data:_0x53a9ae}}=await axios_1[_0x28ca5e(0xc8)][_0x28ca5e(0x16a)](_0x28ca5e(0x13f),_0x19d0d0);if(_0x180884!=0x0)throw new common_1[(_0x28ca5e(0x13b))](_0x41765f,common_1[_0x28ca5e(0x16e)]['BAD_REQUEST']);return _0x53a9ae;}async['notifyEpay'](_0x2cfde8){const _0x5a3c7f=_0x3bcfd7,_0x13d552=_0x2cfde8['sign'];delete _0x2cfde8[_0x5a3c7f(0x14f)],delete _0x2cfde8[_0x5a3c7f(0x11b)];const _0x19d17a=await this[_0x5a3c7f(0x106)][_0x5a3c7f(0xda)]([_0x5a3c7f(0xd8)]);if(this[_0x5a3c7f(0x14f)](_0x2cfde8,_0x19d17a)!=_0x13d552)return _0x5a3c7f(0x151);console[_0x5a3c7f(0x172)]('校验签名通过');const _0x9c0e49=await this[_0x5a3c7f(0xd5)][_0x5a3c7f(0x13c)]({'where':{'orderId':_0x2cfde8[_0x5a3c7f(0x136)],'status':0x0}});if(!_0x9c0e49)return'failed';const _0x295a1c=_0x2cfde8['trade_status']==_0x5a3c7f(0x137)?0x1:0x2,_0x570d7d=await this['orderEntity']['update']({'orderId':_0x2cfde8[_0x5a3c7f(0x136)]},{'status':_0x295a1c,'paydAt':new Date()});_0x295a1c===0x1&&await this[_0x5a3c7f(0xfc)]['addBalanceToOrder'](_0x9c0e49);if(_0x570d7d[_0x5a3c7f(0xf5)]!=0x1)return _0x5a3c7f(0x151);return _0x5a3c7f(0x12f);}async[_0x3bcfd7(0xfb)](_0x36d259,_0x2dbd58,_0x458d53='alipay'){const _0x536aa5=_0x3bcfd7,_0x2f43d6=await this[_0x536aa5(0xd5)][_0x536aa5(0x13c)]({'where':{'userId':_0x36d259,'orderId':_0x2dbd58}});if(!_0x2f43d6)throw new common_1[(_0x536aa5(0x13b))](_0x536aa5(0xca),common_1[_0x536aa5(0x16e)]['BAD_REQUEST']);const _0x16d912=await this[_0x536aa5(0x116)][_0x536aa5(0x13c)]({'where':{'id':_0x2f43d6[_0x536aa5(0xdb)]}});if(!_0x16d912)throw new common_1[(_0x536aa5(0x13b))](_0x536aa5(0x11d),common_1[_0x536aa5(0x16e)][_0x536aa5(0x121)]);const {payEpayPid:_0x49b09f,payEpaySecret:_0x34369b,payEpayNotifyUrl:_0x12771f,payEpayReturnUrl:_0x2ef751,payEpayApiPayUrl:_0x19f928}=await this[_0x536aa5(0x106)][_0x536aa5(0xda)]([_0x536aa5(0x15a),_0x536aa5(0xd8),_0x536aa5(0x135),_0x536aa5(0x153),_0x536aa5(0xde)]);let _0x3fb244;_0x49b09f[_0x536aa5(0x16d)]<=0x10?_0x3fb244=Number(_0x49b09f):_0x3fb244=BigInt(_0x49b09f);const _0x477b30={};_0x477b30[_0x536aa5(0xf6)]=_0x3fb244,_0x477b30[_0x536aa5(0x114)]=_0x458d53,_0x477b30['out_trade_no']=_0x2dbd58,_0x477b30[_0x536aa5(0x163)]=_0x16d912[_0x536aa5(0x163)],_0x477b30[_0x536aa5(0x134)]=_0x2f43d6[_0x536aa5(0xf4)],_0x477b30[_0x536aa5(0x128)]=_0x536aa5(0x157),_0x477b30[_0x536aa5(0x145)]='pc',_0x477b30['notify_url']=_0x12771f,_0x477b30[_0x536aa5(0x15c)]=_0x2ef751,_0x477b30[_0x536aa5(0xf9)]=_0x536aa5(0xcc),_0x477b30[_0x536aa5(0x14f)]=this['sign'](_0x477b30,_0x34369b),_0x477b30[_0x536aa5(0x11b)]=_0x536aa5(0x12e);const _0x2c0b90=new URLSearchParams(_0x477b30)[_0x536aa5(0x166)](),_0x422f04=_0x19f928+'?'+_0x2c0b90;if(_0x19f928[_0x536aa5(0x167)](_0x536aa5(0x11e)))return{'url_qrcode':null,'redirectUrl':_0x422f04,'channel':_0x458d53,'isRedirect':!![]};else{const _0x5187e0=await axios_1['default'][_0x536aa5(0x118)](_0x19f928,{'params':_0x477b30});console[_0x536aa5(0x172)](_0x536aa5(0x10b),_0x5187e0[_0x536aa5(0x103)]);const {data:{code:_0x27aee6,msg:_0x3225d8,qrcode:_0x33b970}}=_0x5187e0;if(_0x27aee6!=0x1)throw new common_1[(_0x536aa5(0x13b))](_0x3225d8,common_1[_0x536aa5(0x16e)][_0x536aa5(0x121)]);return{'url_qrcode':_0x33b970,'redirectUrl':null,'channel':_0x458d53,'isRedirect':![]};}}async[_0x3bcfd7(0x11c)](_0x4836f0){const _0x5aec05=_0x3bcfd7,{payEpayPid:_0x4219bb,payEpaySecret:_0x20a565,payEpayApiQueryUrl:_0x2a2b78}=await this[_0x5aec05(0x106)]['getConfigs'](['payEpayPid',_0x5aec05(0xd8),_0x5aec05(0x156)]),_0x5544dc={};_0x5544dc['act']='order',_0x5544dc[_0x5aec05(0x136)]=_0x4836f0,_0x5544dc[_0x5aec05(0xf6)]=_0x4219bb,_0x5544dc[_0x5aec05(0xe7)]=_0x20a565;const {data:{code:_0x2160b6,msg:_0x1f21ab,data:_0x224feb}}=await axios_1[_0x5aec05(0xc8)]['get'](_0x2a2b78,{'params':_0x5544dc});if(_0x2160b6!=0x1)throw new common_1[(_0x5aec05(0x13b))](_0x1f21ab,common_1[_0x5aec05(0x16e)][_0x5aec05(0x121)]);return _0x224feb;}async[_0x3bcfd7(0x109)](_0x401f6c){const _0x35dde8=_0x3bcfd7,_0x18b040=_0x401f6c[_0x35dde8(0x14f)];delete _0x401f6c[_0x35dde8(0x14f)],delete _0x401f6c[_0x35dde8(0x11b)];const _0x59a1e9=await this[_0x35dde8(0x106)][_0x35dde8(0xda)]([_0x35dde8(0x139)]);console[_0x35dde8(0x172)]('校验签名');if(this[_0x35dde8(0x14f)](_0x401f6c,_0x59a1e9)!=_0x18b040)return'failed';console[_0x35dde8(0x172)](_0x35dde8(0x12d));const _0x20bbaa=await this[_0x35dde8(0xd5)][_0x35dde8(0x13c)]({'where':{'orderId':_0x401f6c[_0x35dde8(0x136)],'status':0x0}});if(!_0x20bbaa)return'failed';const _0x284521=_0x401f6c[_0x35dde8(0x105)]==_0x35dde8(0x137)?0x1:0x2;console[_0x35dde8(0x172)](_0x35dde8(0x10a),_0x284521);const _0x46920c=await this[_0x35dde8(0xd5)]['update']({'orderId':_0x401f6c[_0x35dde8(0x136)]},{'status':_0x284521,'paydAt':new Date()});_0x284521===0x1&&await this['userBalanceService'][_0x35dde8(0x144)](_0x20bbaa);if(_0x46920c['affected']!=0x1)return _0x35dde8(0x151);return _0x35dde8(0x12f);}async[_0x3bcfd7(0x10f)](_0x5447be,_0x8f4d99,_0x2fdf84=_0x3bcfd7(0xe9)){const _0x3ccc21=_0x3bcfd7,_0x3d7670=await this[_0x3ccc21(0xd5)][_0x3ccc21(0x13c)]({'where':{'userId':_0x5447be,'orderId':_0x8f4d99}});if(!_0x3d7670)throw new common_1[(_0x3ccc21(0x13b))](_0x3ccc21(0xca),common_1[_0x3ccc21(0x16e)][_0x3ccc21(0x121)]);const _0x36942d=await this[_0x3ccc21(0x116)][_0x3ccc21(0x13c)]({'where':{'id':_0x3d7670[_0x3ccc21(0xdb)]}});if(!_0x36942d)throw new common_1[(_0x3ccc21(0x13b))](_0x3ccc21(0x11d),common_1['HttpStatus'][_0x3ccc21(0x121)]);const {payMpayPid:_0x5cc396,payMpaySecret:_0x36a97b,payMpayNotifyUrl:_0x35bbb1,payMpayReturnUrl:_0x3006e4,payMpayApiPayUrl:_0x17dc1b}=await this[_0x3ccc21(0x106)][_0x3ccc21(0xda)]([_0x3ccc21(0x13d),_0x3ccc21(0x139),_0x3ccc21(0x120),_0x3ccc21(0x171),_0x3ccc21(0xdd)]),_0x3262fc={};_0x3262fc[_0x3ccc21(0xf6)]=Number(_0x5cc396),_0x3262fc['type']=_0x2fdf84,_0x3262fc['out_trade_no']=_0x8f4d99,_0x3262fc[_0x3ccc21(0x163)]=_0x36942d[_0x3ccc21(0x163)],_0x3262fc[_0x3ccc21(0x134)]=_0x3d7670[_0x3ccc21(0xf4)],_0x3262fc[_0x3ccc21(0x10c)]=_0x35bbb1,_0x3262fc[_0x3ccc21(0x15c)]=_0x3006e4,_0x3262fc[_0x3ccc21(0x14f)]=this[_0x3ccc21(0x14f)](_0x3262fc,_0x36a97b),_0x3262fc[_0x3ccc21(0x11b)]='MD5';const _0x38959b=new URLSearchParams(_0x3262fc)['toString'](),_0x50a1dc=_0x17dc1b+'?'+_0x38959b;return{'url_qrcode':null,'redirectUrl':_0x50a1dc,'channel':_0x2fdf84,'isRedirect':!![]};const _0x25212d=await axios_1['default']['get'](_0x17dc1b,{'params':_0x3262fc});}async[_0x3bcfd7(0xd0)](_0x8c4f85){const _0x1de3fd=_0x3bcfd7,{payMpayApiQueryUrl:_0x389040}=await this[_0x1de3fd(0x106)][_0x1de3fd(0xda)]([_0x1de3fd(0x13d),_0x1de3fd(0x139),_0x1de3fd(0x16b)]),_0x4f03cf={};_0x4f03cf[_0x1de3fd(0x114)]=0x2,_0x4f03cf[_0x1de3fd(0x146)]=_0x8c4f85;const {data:{code:_0x6d0f6e,msg:_0x538fee,data:_0x5111b4}}=await axios_1[_0x1de3fd(0xc8)][_0x1de3fd(0x118)](_0x389040,{'params':_0x4f03cf});if(_0x6d0f6e!=0x1)throw new common_1['HttpException'](_0x538fee,common_1['HttpStatus'][_0x1de3fd(0x121)]);return _0x5111b4;}async[_0x3bcfd7(0x132)](_0x51d0fc){const _0x45a837=_0x3bcfd7;console['log']('微信支付通知params:\x20',_0x51d0fc);const {payWeChatAppId:_0x110c68,payWeChatMchId:_0x5213cc,payWeChatSecret:_0x1b634a,payWeChatPublicKey:_0x29f61f,payWeChatPrivateKey:_0x113d1e}=await this['globalConfigService'][_0x45a837(0xda)](['payWeChatAppId',_0x45a837(0xf3),_0x45a837(0x16c),_0x45a837(0x15f),_0x45a837(0xdc)]),_0x345507=new this[(_0x45a837(0x12a))]({'appid':_0x110c68,'mchid':_0x5213cc,'publicKey':_0x29f61f,'privateKey':_0x113d1e});try{if(_0x51d0fc[_0x45a837(0x11f)]==_0x45a837(0x102)){const {ciphertext:_0x5ca5ac,associated_data:_0x4038c4,nonce:_0x3af33f}=_0x51d0fc[_0x45a837(0x101)],_0x282443=_0x345507[_0x45a837(0xff)](_0x5ca5ac,_0x4038c4,_0x3af33f,_0x1b634a),_0x5a82f6=await this[_0x45a837(0xd5)][_0x45a837(0x13c)]({'where':{'orderId':_0x282443[_0x45a837(0x136)],'status':0x0}});if(!_0x5a82f6)return'failed';const _0x33c77f=_0x282443[_0x45a837(0x117)]==_0x45a837(0x10d)?0x1:0x2,_0x944b2=await this[_0x45a837(0xd5)]['update']({'orderId':_0x282443[_0x45a837(0x136)]},{'status':_0x33c77f,'paydAt':new Date()});_0x33c77f===0x1&&await this[_0x45a837(0xfc)][_0x45a837(0x144)](_0x5a82f6);if(_0x944b2[_0x45a837(0xf5)]!=0x1)return _0x45a837(0x151);}return _0x45a837(0x12f);}catch(_0x2bd2ed){return console['log'](_0x45a837(0x165),_0x2bd2ed),console[_0x45a837(0x172)](_0x45a837(0x112),_0x2bd2ed),_0x45a837(0x151);}}async[_0x3bcfd7(0x130)](_0x436249,_0x20938a,_0x384cbf='native'){const _0x271809=_0x3bcfd7;var _0x594e9b,_0x48e535,_0x12ec13;console[_0x271809(0x172)](_0x271809(0x110),_0x384cbf);const _0x1692e5=await this[_0x271809(0xd5)][_0x271809(0x13c)]({'where':{'userId':_0x436249,'orderId':_0x20938a}});if(!_0x1692e5)throw new common_1[(_0x271809(0x13b))](_0x271809(0xca),common_1[_0x271809(0x16e)][_0x271809(0x121)]);const _0x540688=await this['cramiPackageEntity'][_0x271809(0x13c)]({'where':{'id':_0x1692e5[_0x271809(0xdb)]}});if(!_0x540688)throw new common_1[(_0x271809(0x13b))](_0x271809(0x11d),common_1[_0x271809(0x16e)]['BAD_REQUEST']);const {payWeChatAppId:_0x367ed8,payWeChatMchId:_0x17efae,payWeChatPublicKey:_0x213e73,payWeChatPrivateKey:_0x39a2a1,payWeChatNotifyUrl:_0x446e16,payWeChatH5Name:_0x388c65,payWeChatH5Url:_0x4d8364}=await this[_0x271809(0x106)]['getConfigs']([_0x271809(0x127),_0x271809(0xf3),_0x271809(0x15f),_0x271809(0xdc),_0x271809(0xd6),_0x271809(0x12c),_0x271809(0x155)]),_0x44a7d7=new this[(_0x271809(0x12a))]({'appid':_0x367ed8,'mchid':_0x17efae,'publicKey':_0x213e73,'privateKey':_0x39a2a1}),_0x1b0953={'appid':_0x367ed8,'mchid':_0x17efae,'description':_0x540688[_0x271809(0x163)],'out_trade_no':_0x20938a,'notify_url':_0x446e16,'amount':{'total':Number(_0x1692e5[_0x271809(0xf4)]*0x64)},'scene_info':{'payer_client_ip':_0x271809(0x157)}};console[_0x271809(0x172)](_0x271809(0x115),_0x1b0953);if(_0x384cbf=='h5'){_0x1b0953[_0x271809(0xef)][_0x271809(0x161)]={'type':_0x271809(0x122),'app_name':_0x388c65,'app_url':_0x4d8364};const _0x36edd2=await _0x44a7d7[_0x271809(0x16f)](_0x1b0953);if(_0x36edd2[_0x271809(0xf1)]===0x193){const _0x1f0af1=(_0x12ec13=(_0x48e535=(_0x594e9b=_0x36edd2===null||_0x36edd2===void 0x0?void 0x0:_0x36edd2[_0x271809(0xfd)])===null||_0x594e9b===void 0x0?void 0x0:_0x594e9b[_0x271809(0x14c)])===null||_0x48e535===void 0x0?void 0x0:_0x48e535['text'])===null||_0x12ec13===void 0x0?void 0x0:_0x12ec13[_0x271809(0x150)];throw new common_1['HttpException']((_0x36edd2===null||_0x36edd2===void 0x0?void 0x0:_0x36edd2[_0x271809(0x150)])||_0x271809(0x10e),common_1[_0x271809(0x16e)][_0x271809(0x121)]);}const {h5_url:_0x32fd0a}=_0x36edd2;return{'url':_0x32fd0a};}if(_0x384cbf==_0x271809(0x13a)){const _0x1f8caa=await this[_0x271809(0xe8)][_0x271809(0xc9)](_0x436249);console[_0x271809(0x172)]('用户openId:\x20',_0x1f8caa),_0x1b0953[_0x271809(0xea)]={'openid':_0x1f8caa};const _0x3383f5=await _0x44a7d7[_0x271809(0x170)](_0x1b0953);return console[_0x271809(0x172)](_0x271809(0xe6),_0x3383f5),_0x3383f5;}if(_0x384cbf==_0x271809(0x164)){const _0x5ad935=await _0x44a7d7[_0x271809(0x159)](_0x1b0953),{code_url:_0x21f4cf}=_0x5ad935;return!_0x21f4cf&&console[_0x271809(0x172)](_0x271809(0xe2),_0x5ad935),{'url_qrcode':_0x21f4cf,'isRedirect':![]};}throw new common_1[(_0x271809(0x13b))](_0x271809(0x126),common_1[_0x271809(0x16e)][_0x271809(0x121)]);}async['queryWeChat'](_0x2f2208){const _0x2224dd=_0x3bcfd7,{payWeChatAppId:_0x12d5ed,payWeChatMchId:_0x5bfc87,payWeChatPublicKey:_0x3f1fe0,payWeChatPrivateKey:_0x17f930,payWeChatNotifyUrl:_0x1174f3,payWeChatH5Name:_0x1e740f,payWeChatH5Url:_0x411cee}=await this['globalConfigService']['getConfigs']([_0x2224dd(0x127),_0x2224dd(0xf3),'payWeChatPublicKey',_0x2224dd(0xdc)]),_0x33784f=new this['WxPay']({'appid':_0x12d5ed,'mchid':_0x5bfc87,'publicKey':_0x3f1fe0,'privateKey':_0x17f930}),_0x483347=await _0x33784f['query']({'out_trade_no':_0x2f2208});return _0x483347;}[_0x3bcfd7(0x14f)](_0x49a992,_0x932cca){const _0x11190d=_0x3bcfd7,_0x490a4b=Object['keys'](_0x49a992)['sort']()[_0x11190d(0x152)](_0xe81bba=>_0xe81bba+'='+_0x49a992[_0xe81bba])[_0x11190d(0x15b)]('&')+_0x932cca;return crypto[_0x11190d(0xe4)](_0x11190d(0x142))[_0x11190d(0x162)](_0x490a4b)[_0x11190d(0x174)](_0x11190d(0x15d));}};PayService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x3bcfd7(0xec)])),__param(0x1,(0x0,typeorm_1[_0x3bcfd7(0x113)])(order_entity_1[_0x3bcfd7(0x108)])),__metadata(_0x3bcfd7(0x14a),[typeorm_2[_0x3bcfd7(0xd7)],typeorm_2[_0x3bcfd7(0xd7)],userBalance_service_1[_0x3bcfd7(0x154)],globalConfig_service_1[_0x3bcfd7(0x13e)],user_service_1[_0x3bcfd7(0xfe)]])],PayService),exports[_0x3bcfd7(0x14d)]=PayService;function _0x5da4(){const _0x325409=['clientip','9rhmEdq','WxPay','appid','payWeChatH5Name','校验签名通过','MD5','success','payWeChat','802330PTPdqC','notifyWeChat','__decorate','money','payEpayNotifyUrl','out_trade_no','TRADE_SUCCESS','支付请求失败!','payMpaySecret','jsapi','HttpException','findOne','payMpayPid','GlobalConfigService','https://api.xunhupay.com/payment/query.html','toFixed','payHupiSecret','md5','decorate','addBalanceToOrder','device','order_no','notifyHupi','attach','3226594tpBhia','design:paramtypes','total_fee','response','PayService','out_trade_order','sign','message','failed','map','payEpayReturnUrl','UserBalanceService','payWeChatH5Url','payEpayApiQueryUrl','192.168.1.100','支付请求失败:\x20','transactions_native','payEpayPid','join','return_url','hex','本次支付类型:\x20','payWeChatPublicKey','__param','h5_info','update','name','native','error:\x20','toString','includes','defineProperty','https://api.xunhupay.com/payment/do.html','post','payMpayApiQueryUrl','payWeChatSecret','length','HttpStatus','transactions_h5','transactions_jsapi','payMpayReturnUrl','log','@nestjs/typeorm','digest','title','242313wGxXiS','hupi','default','getOpenIdByUserId','订单不存在!','nonce_str','epay','9ocudIh','importDynamic','hash','queryMpay','../crami/cramiPackage.entity','396568LhIYKg','now','trade_order_id','orderEntity','payWeChatNotifyUrl','Repository','payEpaySecret','createRandomNonceStr','getConfigs','goodsId','payWeChatPrivateKey','payMpayApiPayUrl','payEpayApiPayUrl','214576BaRpOK','1.1','metadata','wx-native','query','createHash','payHupiNotifyUrl','jsapi支付结果返回值:\x20','key','userService','wxpay','payer','queryHupi','CramiPackageEntity','../order/order.entity','wechat','scene_info','time','status','notifyEpay','payWeChatMchId','total','affected','pid','version','function','param','mpay','payEpay','userBalanceService','errRaw','UserService','decipher_gcm','51115QZzBOg','resource','TRANSACTION.SUCCESS','data','../userBalance/userBalance.service','trade_status','globalConfigService','102AlaQyC','OrderEntity','notifyMpay','status:\x20','epay\x20--->\x20res:\x20','notify_url','SUCCESS','微信H5支付失败！','payMpay','payType:\x20','payPlatform','支付通知验证失败:\x20','InjectRepository','type','wechat-pay:\x20','cramiPackageEntity','trade_state','get','__esModule','payHupiAppId','sign_type','queryEpay','套餐不存在!','submit.php','event_type','payMpayNotifyUrl','BAD_REQUEST','Wap','object','4628768HkZyPK','payHupi','unsupported\x20pay\x20type','payWeChatAppId'];_0x5da4=function(){return _0x325409;};return _0x5da4();}