'use strict';function _0x31c5(){const _0x3e7322=['now','PayService','message','nonce_str','230965NAMPnj','notify_url','https://api.xunhupay.com/payment/query.html','hash','payHupiNotifyUrl','userService','payWeChatPrivateKey','payMpaySecret','362721RyUElz','goodsId','payType:\x20','payHupiSecret','payEpayApiPayUrl','__decorate','globalConfigService','HttpException','scene_info','clientip','param','money','payHupiGatewayUrl','createRandomNonceStr','total_fee','total','crypto','hupi','length','includes','h5_info','attach','update','本次支付类型:\x20','appid','transactions_native','transactions_jsapi','WxPay','affected','getConfigs','notifyWeChat','queryMpay','GlobalConfigService','payEpay','1.1','UserService','decorate','payEpayPid','epay\x20--->\x20res:\x20','jsapi','payHupiReturnUrl','design:paramtypes','wechatpay-node-v3','校验签名','payWeChatPublicKey','../user/user.service','native','version','OrderEntity','pay','支付请求失败!','payWeChatH5Url','onModuleInit','md5','pid','UserBalanceService','submit.php','getOwnPropertyDescriptor','HttpStatus','post','unsupported\x20pay\x20type','findOne','微信支付通知params:\x20','1350888CkWFtz','payWeChatSecret','wechat-pay:\x20','BAD_REQUEST','TRANSACTION.SUCCESS','382562STfTct','payHupiAppId','join','query','notify','text','error:\x20','Repository','orderEntity','支付通知验证失败:\x20','Wap','order_no','time','act','InjectRepository','createHash','metadata','out_trade_no','type','addBalanceToOrder','Injectable','../userBalance/userBalance.service','get','@nestjs/typeorm','notifyMpay','success','payWeChatMchId','toString','payEpaySecret','hex','key','__esModule','TRADE_SUCCESS','套餐不存在!','trade_status','alipay','digest','cramiPackageEntity','status','payWeChatH5Name','return_url','payWeChatAppId','notifyHupi','trade_order_id','payMpayReturnUrl','2968497OfEvPp','payMpayApiPayUrl','sign_type','getOpenIdByUserId','../../common/utils','wechat','用户openId:\x20','response','payWeChatNotifyUrl','payMpayNotifyUrl','wxpay','object','failed','校验签名通过','wx-native','userBalanceService','epay','jsapi支付结果返回值:\x20','MD5','log','trade_state','48vFubyL','defineProperty','payPlatform','订单不存在!','out_trade_order','sort','transactions_h5','queryHupi','192.168.1.100','importDynamic','331246CxdOZQ','payEpayApiQueryUrl','default','axios','status:\x20','event_type','order','payWeChat','function','payMpayPid','5682688fDnDNR','title','toFixed','name','sign','https://api.xunhupay.com/payment/do.html'];_0x31c5=function(){return _0x3e7322;};return _0x31c5();}function _0x492d(_0x4a637a,_0x28a287){const _0x31c55a=_0x31c5();return _0x492d=function(_0x492d31,_0x3310be){_0x492d31=_0x492d31-0xcb;let _0x1515ea=_0x31c55a[_0x492d31];return _0x1515ea;},_0x492d(_0x4a637a,_0x28a287);}const _0x3ee756=_0x492d;(function(_0x357b80,_0x2799cf){const _0x4c0ffd=_0x492d,_0x3602f8=_0x357b80();while(!![]){try{const _0x4289b1=parseInt(_0x4c0ffd(0xf8))/0x1+-parseInt(_0x4c0ffd(0x158))/0x2+-parseInt(_0x4c0ffd(0x114))/0x3+parseInt(_0x4c0ffd(0x153))/0x4+-parseInt(_0x4c0ffd(0x10c))/0x5*(parseInt(_0x4c0ffd(0xee))/0x6)+-parseInt(_0x4c0ffd(0xd9))/0x7+parseInt(_0x4c0ffd(0x102))/0x8;if(_0x4289b1===_0x2799cf)break;else _0x3602f8['push'](_0x3602f8['shift']());}catch(_0x3c6d4a){_0x3602f8['push'](_0x3602f8['shift']());}}}(_0x31c5,0x42c5d));var __decorate=this&&this[_0x3ee756(0x119)]||function(_0x26fb0d,_0x333e13,_0xafe46f,_0x584361){const _0x2865c8=_0x3ee756;var _0x535204=arguments['length'],_0x22dfbb=_0x535204<0x3?_0x333e13:_0x584361===null?_0x584361=Object[_0x2865c8(0x14d)](_0x333e13,_0xafe46f):_0x584361,_0xb61ea8;if(typeof Reflect===_0x2865c8(0xe4)&&typeof Reflect[_0x2865c8(0x138)]===_0x2865c8(0x100))_0x22dfbb=Reflect['decorate'](_0x26fb0d,_0x333e13,_0xafe46f,_0x584361);else{for(var _0x9c0c99=_0x26fb0d[_0x2865c8(0x126)]-0x1;_0x9c0c99>=0x0;_0x9c0c99--)if(_0xb61ea8=_0x26fb0d[_0x9c0c99])_0x22dfbb=(_0x535204<0x3?_0xb61ea8(_0x22dfbb):_0x535204>0x3?_0xb61ea8(_0x333e13,_0xafe46f,_0x22dfbb):_0xb61ea8(_0x333e13,_0xafe46f))||_0x22dfbb;}return _0x535204>0x3&&_0x22dfbb&&Object[_0x2865c8(0xef)](_0x333e13,_0xafe46f,_0x22dfbb),_0x22dfbb;},__metadata=this&&this['__metadata']||function(_0x273168,_0x56fdd3){const _0x156d42=_0x3ee756;if(typeof Reflect===_0x156d42(0xe4)&&typeof Reflect[_0x156d42(0x168)]===_0x156d42(0x100))return Reflect[_0x156d42(0x168)](_0x273168,_0x56fdd3);},__param=this&&this['__param']||function(_0x346250,_0x372bd3){return function(_0x1b655f,_0x59b2b7){_0x372bd3(_0x1b655f,_0x59b2b7,_0x346250);};};Object[_0x3ee756(0xef)](exports,_0x3ee756(0xcb),{'value':!![]}),exports[_0x3ee756(0x109)]=void 0x0;const typeorm_1=require(_0x3ee756(0x16f)),typeorm_2=require('typeorm'),common_1=require('@nestjs/common'),crypto=require(_0x3ee756(0x124)),axios_1=require(_0x3ee756(0xfb)),order_entity_1=require('../order/order.entity'),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_service_1=require(_0x3ee756(0x16d)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),utils_1=require(_0x3ee756(0xdd)),user_service_1=require(_0x3ee756(0x141));let PayService=class PayService{constructor(_0x11a629,_0x1c4d3f,_0x1587b7,_0x2fa12d,_0xfdb4ad){const _0x37fcdd=_0x3ee756;this[_0x37fcdd(0xd1)]=_0x11a629,this[_0x37fcdd(0x160)]=_0x1c4d3f,this[_0x37fcdd(0xe8)]=_0x1587b7,this[_0x37fcdd(0x11a)]=_0x2fa12d,this[_0x37fcdd(0x111)]=_0xfdb4ad;}async[_0x3ee756(0x148)](){const _0x4e3210=_0x3ee756,_0x3be12d=await(0x0,utils_1[_0x4e3210(0xf7)])(_0x4e3210(0x13e));this[_0x4e3210(0x12f)]=(_0x3be12d===null||_0x3be12d===void 0x0?void 0x0:_0x3be12d[_0x4e3210(0xfa)])?_0x3be12d[_0x4e3210(0xfa)]:_0x3be12d;}async[_0x3ee756(0x15c)](_0xaf0953){const _0x52e896=_0x3ee756;if(_0xaf0953[_0x52e896(0x11e)]==_0x52e896(0xe9))return this['notifyEpay'](_0xaf0953);if(_0xaf0953[_0x52e896(0x129)]==_0x52e896(0x125))return this[_0x52e896(0xd6)](_0xaf0953);if(typeof _0xaf0953['resource']==_0x52e896(0xe4))return this['notifyWeChat'](_0xaf0953);return this[_0x52e896(0x170)](_0xaf0953);}async[_0x3ee756(0x145)](_0x3e02a7,_0x5e3635,_0xee1020='wxpay'){const _0x41b52d=_0x3ee756,_0x12e9df=await this[_0x41b52d(0x160)]['findOne']({'where':{'userId':_0x3e02a7,'orderId':_0x5e3635}});if(!_0x12e9df)throw new common_1[(_0x41b52d(0x11b))](_0x41b52d(0xf1),common_1[_0x41b52d(0x14e)][_0x41b52d(0x156)]);const _0x39218a=await this[_0x41b52d(0xd1)]['findOne']({'where':{'id':_0x12e9df[_0x41b52d(0x115)]}});if(!_0x39218a)throw new common_1['HttpException'](_0x41b52d(0xcd),common_1['HttpStatus']['BAD_REQUEST']);console[_0x41b52d(0xec)](_0x41b52d(0x12b),_0x12e9df[_0x41b52d(0xf0)]);try{if(_0x12e9df[_0x41b52d(0xf0)]==_0x41b52d(0xde))return this[_0x41b52d(0xff)](_0x3e02a7,_0x5e3635,_0xee1020);if(_0x12e9df[_0x41b52d(0xf0)]=='epay')return this[_0x41b52d(0x135)](_0x3e02a7,_0x5e3635,_0xee1020);if(_0x12e9df[_0x41b52d(0xf0)]=='mpay')return this['payMpay'](_0x3e02a7,_0x5e3635,_0xee1020);if(_0x12e9df[_0x41b52d(0xf0)]==_0x41b52d(0x125))return this['payHupi'](_0x3e02a7,_0x5e3635,_0xee1020);}catch(_0x4f042d){console[_0x41b52d(0xec)]('支付请求失败:\x20',_0x4f042d);throw new common_1[(_0x41b52d(0x11b))](_0x41b52d(0x146),common_1[_0x41b52d(0x14e)][_0x41b52d(0x156)]);}}async[_0x3ee756(0x15b)](_0x555cab){const _0x4d6c78=_0x3ee756,_0x28289d=await this['orderEntity']['findOne']({'where':{'orderId':_0x555cab}});if(!_0x28289d)throw new common_1[(_0x4d6c78(0x11b))](_0x4d6c78(0xf1),common_1['HttpStatus']['BAD_REQUEST']);return _0x28289d;}async[_0x3ee756(0xd6)](_0x142612){const _0x22457e=_0x3ee756,_0x29d61b=await this[_0x22457e(0x11a)][_0x22457e(0x131)]([_0x22457e(0x117)]),_0x1dadef=_0x142612[_0x22457e(0x10f)];delete _0x142612[_0x22457e(0x10f)];if(this['sign'](_0x142612,_0x29d61b)!=_0x1dadef)return _0x22457e(0xe5);const _0x4feb52=await this[_0x22457e(0x160)]['findOne']({'where':{'orderId':_0x142612[_0x22457e(0xd7)],'status':0x0}});if(!_0x4feb52)return _0x22457e(0xe5);await this[_0x22457e(0xe8)]['addBalanceToOrder'](_0x4feb52);const _0x1e08b9=await this['orderEntity'][_0x22457e(0x12a)]({'orderId':_0x142612[_0x22457e(0xd7)]},{'status':0x1,'paydAt':new Date()});if(_0x1e08b9[_0x22457e(0x130)]!=0x1)return _0x22457e(0xe5);return'success';}async['payHupi'](_0x3bc4ce,_0x448993,_0x363f95=_0x3ee756(0xe3)){const _0x1eb36d=_0x3ee756,_0x1243bd=await this[_0x1eb36d(0x160)][_0x1eb36d(0x151)]({'where':{'userId':_0x3bc4ce,'orderId':_0x448993}});if(!_0x1243bd)throw new common_1[(_0x1eb36d(0x11b))](_0x1eb36d(0xf1),common_1['HttpStatus'][_0x1eb36d(0x156)]);const _0x5f444=await this['cramiPackageEntity'][_0x1eb36d(0x151)]({'where':{'id':_0x1243bd[_0x1eb36d(0x115)]}});if(!_0x5f444)throw new common_1[(_0x1eb36d(0x11b))](_0x1eb36d(0xcd),common_1['HttpStatus'][_0x1eb36d(0x156)]);const {payHupiAppId:_0x28aac8,payHupiSecret:_0x438f84,payHupiNotifyUrl:_0x22554c,payHupiReturnUrl:_0x1e2bd3,payHupiGatewayUrl:_0x31d5f3}=await this[_0x1eb36d(0x11a)][_0x1eb36d(0x131)]([_0x1eb36d(0x159),_0x1eb36d(0x117),_0x1eb36d(0x110),_0x1eb36d(0x13c),_0x1eb36d(0x120)]),_0x476c6b={};_0x476c6b[_0x1eb36d(0x143)]=_0x1eb36d(0x136),_0x476c6b[_0x1eb36d(0x12c)]=_0x28aac8,_0x476c6b[_0x1eb36d(0x164)]=(Date[_0x1eb36d(0x108)]()/0x3e8)[_0x1eb36d(0x104)](0x0),_0x476c6b[_0x1eb36d(0x10b)]=(0x0,utils_1[_0x1eb36d(0x121)])(0x20),_0x476c6b[_0x1eb36d(0xd7)]=_0x448993,_0x476c6b[_0x1eb36d(0x103)]=_0x5f444[_0x1eb36d(0x105)],_0x476c6b[_0x1eb36d(0x122)]=_0x1243bd['total'],_0x476c6b[_0x1eb36d(0x10d)]=_0x22554c,_0x476c6b['return_url']=_0x1e2bd3,_0x476c6b[_0x1eb36d(0x129)]=_0x1eb36d(0x125),_0x476c6b[_0x1eb36d(0x10f)]=this['sign'](_0x476c6b,_0x438f84);const {data:{errcode:_0x2e7db0,errmsg:_0x5078e4,url_qrcode:_0x3ee220,url:_0xff9fe7}}=await axios_1[_0x1eb36d(0xfa)]['post'](_0x31d5f3||_0x1eb36d(0x107),_0x476c6b);if(_0x2e7db0!=0x0)throw new common_1[(_0x1eb36d(0x11b))](_0x5078e4,common_1['HttpStatus'][_0x1eb36d(0x156)]);return{'url_qrcode':_0x3ee220,'url':_0xff9fe7};}async[_0x3ee756(0xf5)](_0x579c26){const _0x4e2e11=_0x3ee756,{payHupiAppId:_0x26c634,payHupiSecret:_0x57d1a2}=await this[_0x4e2e11(0x11a)][_0x4e2e11(0x131)]([_0x4e2e11(0x159),'payHupiSecret']),_0x435e75={};_0x435e75[_0x4e2e11(0x143)]=_0x4e2e11(0x136),_0x435e75[_0x4e2e11(0x12c)]=_0x26c634,_0x435e75[_0x4e2e11(0x164)]=(Date['now']()/0x3e8)[_0x4e2e11(0x104)](0x0),_0x435e75[_0x4e2e11(0x10b)]=(0x0,utils_1[_0x4e2e11(0x121)])(0x20),_0x435e75[_0x4e2e11(0xf2)]=_0x579c26,_0x435e75[_0x4e2e11(0x10f)]=this[_0x4e2e11(0x106)](_0x435e75,_0x57d1a2);const {data:{errcode:_0x51a26d,errmsg:_0x3cb04b,data:_0x48329b}}=await axios_1[_0x4e2e11(0xfa)][_0x4e2e11(0x14f)](_0x4e2e11(0x10e),_0x435e75);if(_0x51a26d!=0x0)throw new common_1[(_0x4e2e11(0x11b))](_0x3cb04b,common_1[_0x4e2e11(0x14e)]['BAD_REQUEST']);return _0x48329b;}async['notifyEpay'](_0x1b7086){const _0xe0f9db=_0x3ee756,_0x14167d=_0x1b7086['sign'];delete _0x1b7086['sign'],delete _0x1b7086[_0xe0f9db(0xdb)];const _0x185400=await this[_0xe0f9db(0x11a)]['getConfigs'](['payEpaySecret']);if(this[_0xe0f9db(0x106)](_0x1b7086,_0x185400)!=_0x14167d)return'failed';console[_0xe0f9db(0xec)]('校验签名通过');const _0x3684a7=await this[_0xe0f9db(0x160)][_0xe0f9db(0x151)]({'where':{'orderId':_0x1b7086['out_trade_no'],'status':0x0}});if(!_0x3684a7)return'failed';const _0x556c61=_0x1b7086['trade_status']==_0xe0f9db(0xcc)?0x1:0x2,_0x4ac49b=await this[_0xe0f9db(0x160)]['update']({'orderId':_0x1b7086['out_trade_no']},{'status':_0x556c61,'paydAt':new Date()});_0x556c61===0x1&&await this[_0xe0f9db(0xe8)][_0xe0f9db(0x16b)](_0x3684a7);if(_0x4ac49b[_0xe0f9db(0x130)]!=0x1)return _0xe0f9db(0xe5);return _0xe0f9db(0x171);}async[_0x3ee756(0x135)](_0x3219ff,_0x573936,_0x1547ac=_0x3ee756(0xcf)){const _0x44734d=_0x3ee756,_0x4b8072=await this['orderEntity'][_0x44734d(0x151)]({'where':{'userId':_0x3219ff,'orderId':_0x573936}});if(!_0x4b8072)throw new common_1[(_0x44734d(0x11b))](_0x44734d(0xf1),common_1[_0x44734d(0x14e)][_0x44734d(0x156)]);const _0x400054=await this[_0x44734d(0xd1)][_0x44734d(0x151)]({'where':{'id':_0x4b8072[_0x44734d(0x115)]}});if(!_0x400054)throw new common_1[(_0x44734d(0x11b))]('套餐不存在!',common_1[_0x44734d(0x14e)]['BAD_REQUEST']);const {payEpayPid:_0xc21970,payEpaySecret:_0x59d3bf,payEpayNotifyUrl:_0x414759,payEpayReturnUrl:_0x5d484b,payEpayApiPayUrl:_0x74def0}=await this[_0x44734d(0x11a)]['getConfigs']([_0x44734d(0x139),_0x44734d(0x174),'payEpayNotifyUrl','payEpayReturnUrl',_0x44734d(0x118)]);let _0x4f1160;_0xc21970['length']<=0x10?_0x4f1160=Number(_0xc21970):_0x4f1160=BigInt(_0xc21970);const _0x407a88={};_0x407a88[_0x44734d(0x14a)]=_0x4f1160,_0x407a88[_0x44734d(0x16a)]=_0x1547ac,_0x407a88[_0x44734d(0x169)]=_0x573936,_0x407a88[_0x44734d(0x105)]=_0x400054['name'],_0x407a88['money']=_0x4b8072[_0x44734d(0x123)],_0x407a88[_0x44734d(0x11d)]='192.168.1.100',_0x407a88['device']='pc',_0x407a88['notify_url']=_0x414759,_0x407a88[_0x44734d(0xd4)]=_0x5d484b,_0x407a88[_0x44734d(0x11e)]=_0x44734d(0xe9),_0x407a88['sign']=this[_0x44734d(0x106)](_0x407a88,_0x59d3bf),_0x407a88['sign_type']=_0x44734d(0xeb);const _0x5869d8=new URLSearchParams(_0x407a88)[_0x44734d(0x173)](),_0x38ef35=_0x74def0+'?'+_0x5869d8;if(_0x74def0[_0x44734d(0x127)](_0x44734d(0x14c)))return{'url_qrcode':null,'redirectUrl':_0x38ef35,'channel':_0x1547ac,'isRedirect':!![]};else{const _0x143a16=await axios_1[_0x44734d(0xfa)][_0x44734d(0x16e)](_0x74def0,{'params':_0x407a88});console['log'](_0x44734d(0x13a),_0x143a16['data']);const {data:{code:_0x3bca3a,msg:_0x4a284d,qrcode:_0x182dbd}}=_0x143a16;if(_0x3bca3a!=0x1)throw new common_1[(_0x44734d(0x11b))](_0x4a284d,common_1['HttpStatus'][_0x44734d(0x156)]);return{'url_qrcode':_0x182dbd,'redirectUrl':null,'channel':_0x1547ac,'isRedirect':![]};}}async['queryEpay'](_0x534a26){const _0xc17d13=_0x3ee756,{payEpayPid:_0x1cd7fb,payEpaySecret:_0x4fa176,payEpayApiQueryUrl:_0x573831}=await this[_0xc17d13(0x11a)][_0xc17d13(0x131)]([_0xc17d13(0x139),_0xc17d13(0x174),_0xc17d13(0xf9)]),_0x2224c6={};_0x2224c6[_0xc17d13(0x165)]=_0xc17d13(0xfe),_0x2224c6[_0xc17d13(0x169)]=_0x534a26,_0x2224c6['pid']=_0x1cd7fb,_0x2224c6[_0xc17d13(0x176)]=_0x4fa176;const {data:{code:_0x2b3f16,msg:_0x3cf488,data:_0x537e50}}=await axios_1[_0xc17d13(0xfa)]['get'](_0x573831,{'params':_0x2224c6});if(_0x2b3f16!=0x1)throw new common_1['HttpException'](_0x3cf488,common_1[_0xc17d13(0x14e)]['BAD_REQUEST']);return _0x537e50;}async[_0x3ee756(0x170)](_0x29eefd){const _0xbf5e35=_0x3ee756,_0x399a8f=_0x29eefd[_0xbf5e35(0x106)];delete _0x29eefd[_0xbf5e35(0x106)],delete _0x29eefd[_0xbf5e35(0xdb)];const _0x2e8aa3=await this[_0xbf5e35(0x11a)]['getConfigs']([_0xbf5e35(0x113)]);console['log'](_0xbf5e35(0x13f));if(this[_0xbf5e35(0x106)](_0x29eefd,_0x2e8aa3)!=_0x399a8f)return _0xbf5e35(0xe5);console[_0xbf5e35(0xec)](_0xbf5e35(0xe6));const _0x8724e6=await this['orderEntity'][_0xbf5e35(0x151)]({'where':{'orderId':_0x29eefd['out_trade_no'],'status':0x0}});if(!_0x8724e6)return'failed';const _0x5c5243=_0x29eefd[_0xbf5e35(0xce)]==_0xbf5e35(0xcc)?0x1:0x2;console['log'](_0xbf5e35(0xfc),_0x5c5243);const _0x4a8cdc=await this[_0xbf5e35(0x160)]['update']({'orderId':_0x29eefd[_0xbf5e35(0x169)]},{'status':_0x5c5243,'paydAt':new Date()});_0x5c5243===0x1&&await this['userBalanceService'][_0xbf5e35(0x16b)](_0x8724e6);if(_0x4a8cdc[_0xbf5e35(0x130)]!=0x1)return _0xbf5e35(0xe5);return'success';}async['payMpay'](_0xb069c2,_0x5f296e,_0x11cd87=_0x3ee756(0xe3)){const _0x3ed0d9=_0x3ee756,_0x34ab8c=await this[_0x3ed0d9(0x160)][_0x3ed0d9(0x151)]({'where':{'userId':_0xb069c2,'orderId':_0x5f296e}});if(!_0x34ab8c)throw new common_1[(_0x3ed0d9(0x11b))](_0x3ed0d9(0xf1),common_1[_0x3ed0d9(0x14e)]['BAD_REQUEST']);const _0x4304a4=await this[_0x3ed0d9(0xd1)][_0x3ed0d9(0x151)]({'where':{'id':_0x34ab8c['goodsId']}});if(!_0x4304a4)throw new common_1[(_0x3ed0d9(0x11b))](_0x3ed0d9(0xcd),common_1['HttpStatus'][_0x3ed0d9(0x156)]);const {payMpayPid:_0xb77696,payMpaySecret:_0x33a0d1,payMpayNotifyUrl:_0x36e0c2,payMpayReturnUrl:_0x204c42,payMpayApiPayUrl:_0x309acb}=await this[_0x3ed0d9(0x11a)][_0x3ed0d9(0x131)]([_0x3ed0d9(0x101),_0x3ed0d9(0x113),_0x3ed0d9(0xe2),_0x3ed0d9(0xd8),_0x3ed0d9(0xda)]),_0x1adaf6={};_0x1adaf6[_0x3ed0d9(0x14a)]=Number(_0xb77696),_0x1adaf6[_0x3ed0d9(0x16a)]=_0x11cd87,_0x1adaf6[_0x3ed0d9(0x169)]=_0x5f296e,_0x1adaf6[_0x3ed0d9(0x105)]=_0x4304a4[_0x3ed0d9(0x105)],_0x1adaf6[_0x3ed0d9(0x11f)]=_0x34ab8c[_0x3ed0d9(0x123)],_0x1adaf6['notify_url']=_0x36e0c2,_0x1adaf6[_0x3ed0d9(0xd4)]=_0x204c42,_0x1adaf6[_0x3ed0d9(0x106)]=this[_0x3ed0d9(0x106)](_0x1adaf6,_0x33a0d1),_0x1adaf6['sign_type']=_0x3ed0d9(0xeb);const _0x5642e8=new URLSearchParams(_0x1adaf6)[_0x3ed0d9(0x173)](),_0x2c9aa5=_0x309acb+'?'+_0x5642e8;return{'url_qrcode':null,'redirectUrl':_0x2c9aa5,'channel':_0x11cd87,'isRedirect':!![]};const _0x245f0d=await axios_1[_0x3ed0d9(0xfa)][_0x3ed0d9(0x16e)](_0x309acb,{'params':_0x1adaf6});}async[_0x3ee756(0x133)](_0x3407dd){const _0x89f25a=_0x3ee756,{payMpayApiQueryUrl:_0x53df8f}=await this[_0x89f25a(0x11a)][_0x89f25a(0x131)]([_0x89f25a(0x101),'payMpaySecret','payMpayApiQueryUrl']),_0x38e587={};_0x38e587[_0x89f25a(0x16a)]=0x2,_0x38e587[_0x89f25a(0x163)]=_0x3407dd;const {data:{code:_0x52cb82,msg:_0x549f43,data:_0x48c8c0}}=await axios_1[_0x89f25a(0xfa)][_0x89f25a(0x16e)](_0x53df8f,{'params':_0x38e587});if(_0x52cb82!=0x1)throw new common_1['HttpException'](_0x549f43,common_1[_0x89f25a(0x14e)][_0x89f25a(0x156)]);return _0x48c8c0;}async[_0x3ee756(0x132)](_0xdc12a2){const _0x25e1e5=_0x3ee756;console['log'](_0x25e1e5(0x152),_0xdc12a2);const {payWeChatAppId:_0x351794,payWeChatMchId:_0x2bee5d,payWeChatSecret:_0x5b3807,payWeChatPublicKey:_0x564b37,payWeChatPrivateKey:_0x4d91e8}=await this[_0x25e1e5(0x11a)][_0x25e1e5(0x131)]([_0x25e1e5(0xd5),_0x25e1e5(0x172),_0x25e1e5(0x154),_0x25e1e5(0x140),_0x25e1e5(0x112)]),_0x41e040=new this[(_0x25e1e5(0x12f))]({'appid':_0x351794,'mchid':_0x2bee5d,'publicKey':_0x564b37,'privateKey':_0x4d91e8});try{if(_0xdc12a2[_0x25e1e5(0xfd)]==_0x25e1e5(0x157)){const {ciphertext:_0x5915cd,associated_data:_0x5d8987,nonce:_0x3260e9}=_0xdc12a2['resource'],_0x89a378=_0x41e040['decipher_gcm'](_0x5915cd,_0x5d8987,_0x3260e9,_0x5b3807),_0x39b21a=await this['orderEntity']['findOne']({'where':{'orderId':_0x89a378[_0x25e1e5(0x169)],'status':0x0}});if(!_0x39b21a)return _0x25e1e5(0xe5);const _0x266017=_0x89a378[_0x25e1e5(0xed)]=='SUCCESS'?0x1:0x2,_0x475881=await this[_0x25e1e5(0x160)][_0x25e1e5(0x12a)]({'orderId':_0x89a378[_0x25e1e5(0x169)]},{'status':_0x266017,'paydAt':new Date()});_0x266017===0x1&&await this[_0x25e1e5(0xe8)][_0x25e1e5(0x16b)](_0x39b21a);if(_0x475881[_0x25e1e5(0x130)]!=0x1)return _0x25e1e5(0xe5);}return _0x25e1e5(0x171);}catch(_0x53e34e){return console[_0x25e1e5(0xec)](_0x25e1e5(0x15e),_0x53e34e),console['log'](_0x25e1e5(0x161),_0x53e34e),_0x25e1e5(0xe5);}}async[_0x3ee756(0xff)](_0x2baffe,_0x4fce4c,_0x4a3d23=_0x3ee756(0x142)){const _0x4bb247=_0x3ee756;var _0x659a3f,_0x5da512,_0x566953;console[_0x4bb247(0xec)](_0x4bb247(0x116),_0x4a3d23);const _0x5c04ee=await this['orderEntity'][_0x4bb247(0x151)]({'where':{'userId':_0x2baffe,'orderId':_0x4fce4c}});if(!_0x5c04ee)throw new common_1['HttpException']('订单不存在!',common_1[_0x4bb247(0x14e)]['BAD_REQUEST']);const _0x504042=await this[_0x4bb247(0xd1)][_0x4bb247(0x151)]({'where':{'id':_0x5c04ee['goodsId']}});if(!_0x504042)throw new common_1['HttpException']('套餐不存在!',common_1[_0x4bb247(0x14e)][_0x4bb247(0x156)]);const {payWeChatAppId:_0x375170,payWeChatMchId:_0x2c679b,payWeChatPublicKey:_0x267a29,payWeChatPrivateKey:_0x207705,payWeChatNotifyUrl:_0x23df85,payWeChatH5Name:_0x1518fe,payWeChatH5Url:_0x55881e}=await this['globalConfigService']['getConfigs']([_0x4bb247(0xd5),'payWeChatMchId',_0x4bb247(0x140),_0x4bb247(0x112),_0x4bb247(0xe1),_0x4bb247(0xd3),_0x4bb247(0x147)]),_0x13d52a=new this['WxPay']({'appid':_0x375170,'mchid':_0x2c679b,'publicKey':_0x267a29,'privateKey':_0x207705}),_0x524c1f={'appid':_0x375170,'mchid':_0x2c679b,'description':_0x504042['name'],'out_trade_no':_0x4fce4c,'notify_url':_0x23df85,'amount':{'total':Number(_0x5c04ee[_0x4bb247(0x123)]*0x64)},'scene_info':{'payer_client_ip':_0x4bb247(0xf6)}};console['log'](_0x4bb247(0x155),_0x524c1f);if(_0x4a3d23=='h5'){_0x524c1f[_0x4bb247(0x11c)][_0x4bb247(0x128)]={'type':_0x4bb247(0x162),'app_name':_0x1518fe,'app_url':_0x55881e};const _0x4e9688=await _0x13d52a[_0x4bb247(0xf4)](_0x524c1f);if(_0x4e9688[_0x4bb247(0xd2)]===0x193){const _0x11f331=(_0x566953=(_0x5da512=(_0x659a3f=_0x4e9688===null||_0x4e9688===void 0x0?void 0x0:_0x4e9688['errRaw'])===null||_0x659a3f===void 0x0?void 0x0:_0x659a3f[_0x4bb247(0xe0)])===null||_0x5da512===void 0x0?void 0x0:_0x5da512[_0x4bb247(0x15d)])===null||_0x566953===void 0x0?void 0x0:_0x566953['message'];throw new common_1['HttpException']((_0x4e9688===null||_0x4e9688===void 0x0?void 0x0:_0x4e9688[_0x4bb247(0x10a)])||'微信H5支付失败！',common_1[_0x4bb247(0x14e)][_0x4bb247(0x156)]);}const {h5_url:_0x1ebca2}=_0x4e9688;return{'url':_0x1ebca2};}if(_0x4a3d23==_0x4bb247(0x13b)){const _0xc4e647=await this[_0x4bb247(0x111)][_0x4bb247(0xdc)](_0x2baffe);console[_0x4bb247(0xec)](_0x4bb247(0xdf),_0xc4e647),_0x524c1f['payer']={'openid':_0xc4e647};const _0x857182=await _0x13d52a[_0x4bb247(0x12e)](_0x524c1f);return console[_0x4bb247(0xec)](_0x4bb247(0xea),_0x857182),_0x857182;}if(_0x4a3d23=='native'){const _0x474337=await _0x13d52a[_0x4bb247(0x12d)](_0x524c1f),{code_url:_0x36c86e}=_0x474337;return!_0x36c86e&&console['log'](_0x4bb247(0xe7),_0x474337),{'url_qrcode':_0x36c86e,'isRedirect':![]};}throw new common_1[(_0x4bb247(0x11b))](_0x4bb247(0x150),common_1[_0x4bb247(0x14e)]['BAD_REQUEST']);}async['queryWeChat'](_0x343ae2){const _0x34bc60=_0x3ee756,{payWeChatAppId:_0x3ab86a,payWeChatMchId:_0x59309c,payWeChatPublicKey:_0x2afd9d,payWeChatPrivateKey:_0x4cdd02,payWeChatNotifyUrl:_0x25fffc,payWeChatH5Name:_0x1c5797,payWeChatH5Url:_0x5c8d0d}=await this[_0x34bc60(0x11a)][_0x34bc60(0x131)](['payWeChatAppId','payWeChatMchId',_0x34bc60(0x140),_0x34bc60(0x112)]),_0x2e896f=new this['WxPay']({'appid':_0x3ab86a,'mchid':_0x59309c,'publicKey':_0x2afd9d,'privateKey':_0x4cdd02}),_0x5e334e=await _0x2e896f[_0x34bc60(0x15b)]({'out_trade_no':_0x343ae2});return _0x5e334e;}[_0x3ee756(0x106)](_0x484134,_0x55bff2){const _0x27e8d2=_0x3ee756,_0x11e429=Object['keys'](_0x484134)[_0x27e8d2(0xf3)]()['map'](_0x2c2672=>_0x2c2672+'='+_0x484134[_0x2c2672])[_0x27e8d2(0x15a)]('&')+_0x55bff2;return crypto[_0x27e8d2(0x167)](_0x27e8d2(0x149))[_0x27e8d2(0x12a)](_0x11e429)[_0x27e8d2(0xd0)](_0x27e8d2(0x175));}};PayService=__decorate([(0x0,common_1[_0x3ee756(0x16c)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1[_0x3ee756(0x166)])(order_entity_1[_0x3ee756(0x144)])),__metadata(_0x3ee756(0x13d),[typeorm_2[_0x3ee756(0x15f)],typeorm_2[_0x3ee756(0x15f)],userBalance_service_1[_0x3ee756(0x14b)],globalConfig_service_1[_0x3ee756(0x134)],user_service_1[_0x3ee756(0x137)]])],PayService),exports[_0x3ee756(0x109)]=PayService;