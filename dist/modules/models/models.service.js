'use strict';const _0x39785a=_0xb48d;function _0x5122(){const _0x2cf33b=['typeorm','useToken\x20+\x20','affected','1JMToNm','save','decorate','data','number','find','length','getModelTypeDetailFromId','pluginList','assign','design:paramtypes','order','set','无效参数！','findAndCount','includes','useCount\x20+\x201','HttpStatus','getModelTypeIdFromModelName','getOwnPropertyDescriptor','keyType','content','modelTypeId','264uqguZP','key:\x20','getBaseConfig','queryModelType','搜索异常！','function','maxTokens','where','stringify','ModelsService','ModelsTypeEntity','compilerParams','getUseDrawModelKey','gpt-4-gizmo','modelKeysEntity','initPluginList','push','219GjUGov','defineProperty','../../common/utils','getPluginList','axios','message','Injectable','super','12pNBYHg','endsWith','89810gFrJOF','tts','forEach','isUseTool','InjectRepository','管理员未开放此功能、敬请期待！','init','join','../../common/constants/plugin','695893VrgNIb','debug','ModelKeysEntity','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','__esModule','747EOOrZt','delModelType','filter','26484YwQVJL','lockKey','./modelKeys.entity','parse','removeSpecialCharacters','choices','https://api.openai.com','map','keyPoolIndexMap','update','error','error:\x20','log','DESC','key','object','42wejYhJ','isGpts','findOne','modelsTypeEntity','options:\x20','modelInfo','setModelKey','modelsList','\x20已经添加过！','findBy','default','createQueryBuilder','metadata','133198ELfhbU','getDefaultModel','模型名称\x20->\x20','getTtsModelKey','getCurrentModelKeyInfo','./modelType.entity','1462232vNukBv','ModelMaxtokenMap','getFullUrl','model','isDallDraw','BAD_REQUEST','delModelKey','HttpException','__decorate','secret','id\x20=\x20:id','status','Logger','1380348UoeVLv','delete','modelMaps','refreshBaiduAccesstoken','isArray','search-gpts','system','modelTypes','user','keyPoolMap','isDefaultModel','getMaxToken','添加Key失败！','336mDQZCm','4339045JePooJ','maxResponseTokens'];_0x5122=function(){return _0x2cf33b;};return _0x5122();}(function(_0x58a28c,_0x5d7fec){const _0x62f491=_0xb48d,_0xb495e4=_0x58a28c();while(!![]){try{const _0x32e756=parseInt(_0x62f491(0xe7))/0x1*(parseInt(_0x62f491(0xd4))/0x2)+parseInt(_0x62f491(0x89))/0x3*(parseInt(_0x62f491(0xa4))/0x4)+parseInt(_0x62f491(0xe2))/0x5*(parseInt(_0x62f491(0x91))/0x6)+-parseInt(_0x62f491(0xb4))/0x7*(parseInt(_0x62f491(0xc7))/0x8)+parseInt(_0x62f491(0xa1))/0x9*(parseInt(_0x62f491(0x93))/0xa)+parseInt(_0x62f491(0x9c))/0xb*(-parseInt(_0x62f491(0xfe))/0xc)+parseInt(_0x62f491(0xc1))/0xd*(-parseInt(_0x62f491(0xe1))/0xe);if(_0x32e756===_0x5d7fec)break;else _0xb495e4['push'](_0xb495e4['shift']());}catch(_0x48dd5e){_0xb495e4['push'](_0xb495e4['shift']());}}}(_0x5122,0xe0a78));var __decorate=this&&this[_0x39785a(0xcf)]||function(_0x35210a,_0x2f2bfb,_0x5e3cb2,_0x10f1b2){const _0x38f38a=_0x39785a;var _0x3db128=arguments[_0x38f38a(0xed)],_0x3344ca=_0x3db128<0x3?_0x2f2bfb:_0x10f1b2===null?_0x10f1b2=Object[_0x38f38a(0xfa)](_0x2f2bfb,_0x5e3cb2):_0x10f1b2,_0x4edc93;if(typeof Reflect===_0x38f38a(0xb3)&&typeof Reflect[_0x38f38a(0xe9)]===_0x38f38a(0x103))_0x3344ca=Reflect[_0x38f38a(0xe9)](_0x35210a,_0x2f2bfb,_0x5e3cb2,_0x10f1b2);else{for(var _0x5a429e=_0x35210a[_0x38f38a(0xed)]-0x1;_0x5a429e>=0x0;_0x5a429e--)if(_0x4edc93=_0x35210a[_0x5a429e])_0x3344ca=(_0x3db128<0x3?_0x4edc93(_0x3344ca):_0x3db128>0x3?_0x4edc93(_0x2f2bfb,_0x5e3cb2,_0x3344ca):_0x4edc93(_0x2f2bfb,_0x5e3cb2))||_0x3344ca;}return _0x3db128>0x3&&_0x3344ca&&Object[_0x38f38a(0x8a)](_0x2f2bfb,_0x5e3cb2,_0x3344ca),_0x3344ca;},__metadata=this&&this['__metadata']||function(_0xd3ba44,_0x2f17ed){const _0x4b0ee2=_0x39785a;if(typeof Reflect===_0x4b0ee2(0xb3)&&typeof Reflect[_0x4b0ee2(0xc0)]==='function')return Reflect[_0x4b0ee2(0xc0)](_0xd3ba44,_0x2f17ed);},__param=this&&this['__param']||function(_0x43139c,_0x180645){return function(_0x5cf42a,_0x5ad0c5){_0x180645(_0x5cf42a,_0x5ad0c5,_0x43139c);};};Object['defineProperty'](exports,_0x39785a(0xa0),{'value':!![]}),exports[_0x39785a(0x81)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x39785a(0xe4)),utils_1=require(_0x39785a(0x8b)),modelType_entity_1=require(_0x39785a(0xc6)),modelKeys_entity_1=require(_0x39785a(0xa6)),models_1=require('../../common/constants/models'),plugin_1=require(_0x39785a(0x9b)),axios_1=require(_0x39785a(0x8d));function _0xb48d(_0x2e690e,_0x5c9c62){const _0x512256=_0x5122();return _0xb48d=function(_0xb48dbb,_0x28bd9f){_0xb48dbb=_0xb48dbb-0x80;let _0x5d7f4f=_0x512256[_0xb48dbb];return _0x5d7f4f;},_0xb48d(_0x2e690e,_0x5c9c62);}let ModelsService=class ModelsService{constructor(_0x5f40bd,_0x1e2fdf){const _0x481dfb=_0x39785a;this[_0x481dfb(0xb7)]=_0x5f40bd,this['modelKeysEntity']=_0x1e2fdf,this['modelTypes']=[],this[_0x481dfb(0xd6)]={},this[_0x481dfb(0xdd)]={},this[_0x481dfb(0xac)]={},this['pluginList']=[];}async['onModuleInit'](){const _0x514838=_0x39785a;await this[_0x514838(0x99)]();}async[_0x39785a(0x99)](){const _0x1fcc95=_0x39785a;this['modelTypes']=[],this[_0x1fcc95(0xd6)]={},this[_0x1fcc95(0xdd)]={},this[_0x1fcc95(0xac)]={},this[_0x1fcc95(0xdb)]=await this[_0x1fcc95(0xb7)][_0x1fcc95(0xec)]();const _0x378746=this['modelTypes'][_0x1fcc95(0xab)](_0x92ad33=>_0x92ad33['id']),_0xc85605=await this[_0x1fcc95(0x86)]['find']({'where':{'modelTypeId':(0x0,typeorm_2['In'])(_0x378746)}});this['modelTypes'][_0x1fcc95(0x95)](_0x5c9709=>{const _0x52eead=_0x1fcc95,_0x303e78=_0xc85605[_0x52eead(0xa3)](_0x9a866a=>_0x9a866a[_0x52eead(0xfd)]===_0x5c9709['id']);this[_0x52eead(0xd6)][_0x5c9709['id']]=_0x303e78;}),this[_0x1fcc95(0xdb)]['forEach'](_0x12cd7a=>{const _0x40fcc0=_0x1fcc95,{id:_0x26faca}=_0x12cd7a,_0x2ca678=this[_0x40fcc0(0xd6)][_0x26faca];if(!this[_0x40fcc0(0xdd)][_0x26faca])this['keyPoolMap'][_0x26faca]=[];_0x2ca678['forEach'](_0x1eaf6c=>{const _0x4cde59=_0x40fcc0,{keyWeight:_0x10ce5d,id:_0xa1bbe0}=_0x1eaf6c;let _0x20abb0=Number(_0x10ce5d);if(typeof _0x20abb0!==_0x4cde59(0xeb))_0x20abb0=0x1;for(let _0x3abd35=0x0;_0x3abd35<_0x10ce5d;_0x3abd35++){this[_0x4cde59(0xdd)][_0x26faca][_0x4cde59(0x88)](_0xa1bbe0);}});if(!this[_0x40fcc0(0xac)][_0x26faca])this[_0x40fcc0(0xac)][_0x26faca]=0x0;}),await this[_0x1fcc95(0x87)]();}['getModelTypeIdFromPluginId'](_0x294f65){const _0x47c489=_0x39785a;var _0x16d9ab;return(_0x16d9ab=this[_0x47c489(0xef)][_0x47c489(0xec)](_0x48a99d=>_0x48a99d['id']===_0x294f65))===null||_0x16d9ab===void 0x0?void 0x0:_0x16d9ab[_0x47c489(0xfd)];}async['getModelTypeIdFromGpts'](){const _0x26a9bd=_0x39785a;var _0x4fba3f;return(_0x4fba3f=this[_0x26a9bd(0xdb)][_0x26a9bd(0xec)](_0x3f26fb=>_0x3f26fb[_0x26a9bd(0xca)]===_0x26a9bd(0x85)))===null||_0x4fba3f===void 0x0?void 0x0:_0x4fba3f['id'];}[_0x39785a(0x87)](){const _0x52f550=_0x39785a,_0x14c0f0=plugin_1['PluginDefaultList']['filter'](_0x52959e=>{const _0x3398e1=_0xb48d,{pluginModelName:_0x1d7822}=_0x52959e,_0x5f59c1=this[_0x3398e1(0xdb)][_0x3398e1(0xa3)](_0x351235=>{const _0x57115a=_0x3398e1;var _0x34b480;const {id:_0x4473a5}=_0x351235;return((_0x34b480=this['keyPoolMap'][_0x4473a5])===null||_0x34b480===void 0x0?void 0x0:_0x34b480[_0x57115a(0xed)])||!_0x1d7822;})[_0x3398e1(0xab)](_0x3c9e73=>{return _0x3c9e73['model'];});return _0x5f59c1['includes'](_0x1d7822)||!_0x1d7822;});this[_0x52f550(0xef)]=_0x14c0f0['map'](_0x5ac05c=>{const _0x5ada74=_0x52f550;var _0x42035f;const {pluginModelName:_0x4a921a}=_0x5ac05c,_0x537a6c=(_0x42035f=this[_0x5ada74(0xdb)][_0x5ada74(0xec)](_0x240220=>_0x240220[_0x5ada74(0xca)]===_0x4a921a))===null||_0x42035f===void 0x0?void 0x0:_0x42035f['id'];return Object[_0x5ada74(0xf0)](Object['assign']({},_0x5ac05c),{'modelTypeId':_0x537a6c});});}['getOpenPluginList'](){const _0x13e102=_0x39785a;return this[_0x13e102(0xef)][_0x13e102(0xab)](_0x239c76=>{const _0x95e223=_0x13e102;var _0x4aa549;const {pluginModelName:_0x4df1b0,pluginName:_0x127da4,icon:_0x37b758,id:_0xa7f63c}=_0x239c76,_0x1184ce=(_0x4aa549=this[_0x95e223(0xdb)]['find'](_0xe5ce84=>_0xe5ce84[_0x95e223(0xca)]===_0x4df1b0))===null||_0x4aa549===void 0x0?void 0x0:_0x4aa549['id'];return Object[_0x95e223(0xf0)](Object[_0x95e223(0xf0)]({},_0x239c76),{'pluginId':_0xa7f63c,'modelTypeId':_0x1184ce});});}async[_0x39785a(0xa5)](_0x47a05e,_0x10488c,_0x45efbf=-0x1){const _0x5d5542=_0x39785a,_0x594c0c=await this[_0x5d5542(0x86)]['update']({'id':_0x47a05e},{'status':![],'keyStatus':_0x45efbf,'remark':_0x10488c});common_1[_0x5d5542(0xd3)][_0x5d5542(0xae)](_0x5d5542(0xff)+_0x47a05e+_0x5d5542(0x9f)),this['init']();}async[_0x39785a(0x100)](_0x3fd20f){const _0x5eb3bf=_0x39785a;if(!this['modelTypes'][_0x5eb3bf(0xed)]){common_1[_0x5eb3bf(0xd3)][_0x5eb3bf(0x9d)]('当前未配置任何模型分类，请先配置模型分类！');return;}let _0x4644af=null;if(_0x3fd20f===null||_0x3fd20f===void 0x0?void 0x0:_0x3fd20f[_0x5eb3bf(0xfd)])_0x4644af=await this[_0x5eb3bf(0xee)](_0x3fd20f===null||_0x3fd20f===void 0x0?void 0x0:_0x3fd20f[_0x5eb3bf(0xfd)]);else{if(_0x3fd20f===null||_0x3fd20f===void 0x0?void 0x0:_0x3fd20f[_0x5eb3bf(0xb5)]){const _0x27cf62=await this[_0x5eb3bf(0xf9)](_0x5eb3bf(0x85));_0x4644af=this['modelTypes'][_0x5eb3bf(0xec)](_0x1ceb91=>_0x1ceb91['id']===_0x27cf62);}else _0x4644af=await this[_0x5eb3bf(0xc2)]();}if(!_0x4644af)return;const {id:_0x331bdf,maxRounds:_0x476fbe,maxResponseTokens:_0x43328e}=_0x4644af;return{'modelTypeId':_0x331bdf,'modelConfig':{'maxResponseTokens':_0x43328e,'topN':1.2,'systemMessage':'','rounds':_0x476fbe}};}async[_0x39785a(0xc2)](){const _0x181746=_0x39785a;let _0x2c8488=null;_0x2c8488=this[_0x181746(0xdb)]['find'](_0x52e942=>_0x52e942[_0x181746(0xde)]);if(!_0x2c8488){const _0x5a4215=this[_0x181746(0xdb)][_0x181746(0xa3)](_0x2c0318=>_0x2c0318[_0x181746(0xd2)]);_0x5a4215[_0x181746(0xed)]&&(_0x2c8488=_0x5a4215[0x0]);}return _0x2c8488;}async[_0x39785a(0xbb)](){const _0x48e2d0=_0x39785a,_0x450e56=await this[_0x48e2d0(0xb7)]['find']({'order':{'order':_0x48e2d0(0xb1)}});return _0x450e56;}async[_0x39785a(0x8c)](){const _0x190548=_0x39785a;return this[_0x190548(0xef)];}async['saveUseLog'](_0x40f621,_0x4afa9b,_0x5aa3fd){const _0x26ec83=_0x39785a;await this[_0x26ec83(0x86)][_0x26ec83(0xbf)]()[_0x26ec83(0xad)](modelKeys_entity_1['ModelKeysEntity'])[_0x26ec83(0xf3)]({'useCount':()=>_0x26ec83(0xf7),'useToken':()=>'useToken\x20+\x20'+_0x5aa3fd})['where'](_0x26ec83(0xd1),{'id':_0x40f621})['execute'](),await this['modelsTypeEntity'][_0x26ec83(0xbf)]()[_0x26ec83(0xad)](modelType_entity_1['ModelsTypeEntity'])[_0x26ec83(0xf3)]({'useCount':()=>_0x26ec83(0xf7),'useToken':()=>_0x26ec83(0xe5)+_0x5aa3fd})[_0x26ec83(0x105)](_0x26ec83(0xd1),{'id':_0x4afa9b})['execute']();}async[_0x39785a(0xd7)](){}async[_0x39785a(0x101)](_0x4f712b){const _0x3748fc=_0x39785a,{keyType:_0x45b933,status:_0xe3d9d4,model:_0x2b2843,page:page=0x1,size:size=0xa}=_0x4f712b,_0x1f0fff={};_0x45b933&&(_0x1f0fff[_0x3748fc(0xfb)]=_0x45b933),_0x2b2843&&(_0x1f0fff[_0x3748fc(0xca)]=_0x2b2843),_0xe3d9d4&&(_0x1f0fff[_0x3748fc(0xd2)]=Number(_0xe3d9d4)===0x1?!![]:![]);const [_0x5016d8,_0x468357]=await this['modelsTypeEntity'][_0x3748fc(0xf5)]({'where':_0x1f0fff,'skip':(page-0x1)*size,'take':size,'order':{'order':_0x3748fc(0xb1)}});return{'rows':_0x5016d8,'count':_0x468357};}async['setModelType'](_0x5a72a4){const _0x4a4e97=_0x39785a;try{const {id:_0x4c84f2,modelName:_0x45ce6f}=_0x5a72a4,_0x3298a4=this[_0x4a4e97(0x83)](_0x5a72a4);if(_0x4c84f2){const _0x511bdf=await this[_0x4a4e97(0xb7)]['update']({'id':_0x4c84f2},_0x3298a4);return await this[_0x4a4e97(0x99)](),_0x511bdf[_0x4a4e97(0xe6)]>0x0;}else{const _0x2af6c7=await this[_0x4a4e97(0xb7)][_0x4a4e97(0xb6)]({'where':{'modelName':_0x45ce6f}});if(_0x2af6c7)throw new common_1[(_0x4a4e97(0xce))](_0x4a4e97(0xc3)+_0x45ce6f+_0x4a4e97(0xbc),common_1['HttpStatus'][_0x4a4e97(0xcc)]);const _0x1bb8ab=await this['modelsTypeEntity']['save'](_0x3298a4);return await this[_0x4a4e97(0x99)](),_0x1bb8ab;}}catch(_0x3b63f5){throw new common_1[(_0x4a4e97(0xce))]('编辑模型失败\x20->\x20'+(_0x3b63f5===null||_0x3b63f5===void 0x0?void 0x0:_0x3b63f5['response']),common_1[_0x4a4e97(0xf8)][_0x4a4e97(0xcc)]);}}async[_0x39785a(0xa2)](_0x1c2cd8){const _0x3199d1=_0x39785a,{id:_0x3f70e0}=_0x1c2cd8;if(!_0x3f70e0)throw new common_1[(_0x3199d1(0xce))]('无效参数！',common_1[_0x3199d1(0xf8)][_0x3199d1(0xcc)]);const _0x30d278=await this[_0x3199d1(0xb7)]['findOne']({'where':{'id':_0x3f70e0}});if(!_0x30d278)throw new common_1[(_0x3199d1(0xce))](_0x3199d1(0xf4),common_1['HttpStatus'][_0x3199d1(0xcc)]);else{const _0x24d4b6=await this[_0x3199d1(0xb7)][_0x3199d1(0xd5)]({'id':_0x3f70e0});return _0x24d4b6[_0x3199d1(0xe6)];}}async['queryModelKey'](_0x226703,_0x3ba30e){const _0x3ed3f4=_0x39785a,{role:_0x514f90}=_0x226703[_0x3ed3f4(0xdc)],{modelTypeId:_0x354b36,status:_0x1fe3d1,page:page=0x1,size:size=0xa}=_0x3ba30e,_0x2506a8={};_0x354b36&&(_0x2506a8[_0x3ed3f4(0xfd)]=_0x354b36),_0x1fe3d1&&(_0x2506a8[_0x3ed3f4(0xd2)]=Number(_0x1fe3d1)===0x1?!![]:![]);const [_0x7bf3c6,_0x4ec4ec]=await this[_0x3ed3f4(0x86)]['findAndCount']({'where':_0x2506a8,'skip':(page-0x1)*size,'take':size}),_0x20dbf9=_0x7bf3c6[_0x3ed3f4(0xab)](_0x3efdd8=>_0x3efdd8[_0x3ed3f4(0xfd)]),_0x39a355=await this['modelsTypeEntity'][_0x3ed3f4(0xbd)]({'id':(0x0,typeorm_2['In'])(_0x20dbf9)});return _0x7bf3c6[_0x3ed3f4(0x95)](_0x3fb7d5=>{const _0x261f39=_0x3ed3f4,_0x2e6a7e=_0x39a355[_0x261f39(0xec)](_0x36a6c7=>_0x36a6c7['id']===_0x3fb7d5['modelTypeId']);_0x3fb7d5[_0x261f39(0xb9)]=_0x2e6a7e,_0x514f90!==_0x261f39(0x90)&&(_0x3fb7d5[_0x261f39(0xb2)]&&(_0x3fb7d5[_0x261f39(0xb2)]=(0x0,utils_1['hideString'])(_0x3fb7d5[_0x261f39(0xb2)])),_0x3fb7d5['secret']&&(_0x3fb7d5[_0x261f39(0xd0)]=(0x0,utils_1['hideString'])(_0x3fb7d5['secret'])));}),{'rows':_0x7bf3c6,'count':_0x4ec4ec};}async[_0x39785a(0xba)](_0x11309c){const _0x506a5d=_0x39785a;try{const {id:_0x1a7149,key:_0x197b78}=_0x11309c;if(_0x1a7149){const _0x41285b=Array['isArray'](_0x11309c[_0x506a5d(0xb2)]);_0x41285b&&(_0x11309c[_0x506a5d(0xb2)]=_0x11309c[_0x506a5d(0xb2)][0x0]);const _0x11a318=await this[_0x506a5d(0x86)][_0x506a5d(0xad)]({'id':_0x1a7149},_0x11309c);return await this[_0x506a5d(0x99)](),_0x11a318[_0x506a5d(0xe6)]>0x0;}if(!_0x1a7149){const _0x43ba0e=Array[_0x506a5d(0xd8)](_0x11309c[_0x506a5d(0xb2)]);if(!_0x43ba0e){const _0x23e1dc=await this[_0x506a5d(0x86)][_0x506a5d(0xe8)](_0x11309c);return await this['init'](),this[_0x506a5d(0xd7)](),_0x23e1dc;}else{const _0x288992=_0x197b78[_0x506a5d(0xab)](_0x6a13e7=>{const _0x1d2fd4=_0x506a5d;try{const _0x1cd9f0=JSON[_0x1d2fd4(0xa7)](JSON[_0x1d2fd4(0x80)](_0x11309c));return _0x1cd9f0[_0x1d2fd4(0xb2)]=_0x6a13e7,!_0x1cd9f0['order']&&(_0x1cd9f0[_0x1d2fd4(0xf2)]=0x64),_0x1cd9f0;}catch(_0x246072){}})['filter'](_0x5a9e43=>_0x5a9e43),_0x1840c3=await this[_0x506a5d(0x86)]['save'](_0x288992);return await this[_0x506a5d(0x99)](),_0x1840c3;}}}catch(_0x100ab3){throw new common_1[(_0x506a5d(0xce))](_0x506a5d(0xe0),common_1[_0x506a5d(0xf8)]['BAD_REQUEST']);}}async[_0x39785a(0xcd)](_0x55395a){const _0x4feb8d=_0x39785a,{id:_0x9769c5}=_0x55395a;if(!_0x9769c5)throw new common_1[(_0x4feb8d(0xce))](_0x4feb8d(0xf4),common_1[_0x4feb8d(0xf8)][_0x4feb8d(0xcc)]);const _0x45f864=await this[_0x4feb8d(0x86)][_0x4feb8d(0xb6)]({'where':{'id':_0x9769c5}});if(!_0x45f864)throw new common_1[(_0x4feb8d(0xce))]('无效参数！',common_1[_0x4feb8d(0xf8)]['BAD_REQUEST']);else{const _0x2845b5=await this[_0x4feb8d(0x86)][_0x4feb8d(0xd5)]({'id':_0x9769c5});return _0x2845b5[_0x4feb8d(0xe6)];}}[_0x39785a(0xdf)](_0x3b76cc,_0x4b1da0){const _0xed300e=_0x39785a;let _0x411df8=models_1[_0xed300e(0xc8)][_0x3b76cc];return!_0x411df8?_0x411df8=0x1000:_0x4b1da0<_0x411df8&&_0x4b1da0>0x0&&(_0x411df8=_0x4b1da0),_0x411df8;}[_0x39785a(0x83)](_0x46e8e2){const _0x475e87=_0x39785a,_0x1f20f5=JSON[_0x475e87(0xa7)](JSON[_0x475e87(0x80)](_0x46e8e2)),{model:_0x38f4a3,maxTokens:_0x213433}=_0x1f20f5,_0x2b837b=models_1[_0x475e87(0xc8)][_0x38f4a3];return _0x1f20f5['maxTokens']=this[_0x475e87(0xdf)](_0x38f4a3,_0x213433),_0x1f20f5[_0x475e87(0x104)]<0x1388&&(_0x1f20f5['maxResponseTokens']=0x800),_0x1f20f5[_0x475e87(0x104)]>0x1388&&_0x1f20f5[_0x475e87(0x104)]<0x2710&&(_0x1f20f5['maxResponseTokens']=0x1000),_0x1f20f5['maxTokens']>0x2710&&_0x1f20f5['maxTokens']<0x7530&&(_0x1f20f5[_0x475e87(0xe3)]=0x2000),_0x1f20f5[_0x475e87(0x104)]>0x7530&&_0x1f20f5[_0x475e87(0x104)]<0xc350&&(_0x1f20f5[_0x475e87(0xe3)]=0x3e80),_0x1f20f5[_0x475e87(0x104)]>0xc350&&(_0x1f20f5[_0x475e87(0xe3)]=0x9c4),_0x1f20f5;}async[_0x39785a(0xee)](_0x42794c){const _0x3522d9=_0x39785a;return await this[_0x3522d9(0xdb)][_0x3522d9(0xec)](_0x3d84d9=>_0x3d84d9['id']===_0x42794c);}async['getUseToolsModelKey'](){const _0x26c7dd=_0x39785a;var _0x55788b;const _0x5e83e9=(_0x55788b=this['modelTypes'][_0x26c7dd(0xec)](_0x127caf=>_0x127caf[_0x26c7dd(0x96)]))===null||_0x55788b===void 0x0?void 0x0:_0x55788b['id'];if(!_0x5e83e9)return;const _0x272858=this['modelMaps'][_0x5e83e9];if(!_0x272858[_0x26c7dd(0xed)])return;const _0x139e12=this['keyPoolIndexMap'][_0x5e83e9],_0x5bd73d=_0x272858[_0x139e12];return this[_0x26c7dd(0xac)][_0x5e83e9]++,this[_0x26c7dd(0xac)][_0x5e83e9]>=_0x272858[_0x26c7dd(0xed)]&&(this['keyPoolIndexMap'][_0x5e83e9]=0x0),_0x5bd73d;}async[_0x39785a(0xc5)](_0x389c0e){const _0x2a6bca=_0x39785a;if(!_0x389c0e)return;const _0x43b545=this['modelMaps'][_0x389c0e];if(!_0x43b545['length'])return;const _0x3aeb8b=this['keyPoolIndexMap'][_0x389c0e],_0x31e666=_0x43b545[_0x3aeb8b];return this['keyPoolIndexMap'][_0x389c0e]++,this[_0x2a6bca(0xac)][_0x389c0e]>=_0x43b545[_0x2a6bca(0xed)]&&(this[_0x2a6bca(0xac)][_0x389c0e]=0x0),_0x31e666;}async[_0x39785a(0x84)](){const _0x4fdc78=_0x39785a;var _0x525b0d;const _0x44e6a5=(_0x525b0d=this[_0x4fdc78(0xdb)][_0x4fdc78(0xec)](_0x3f2dde=>_0x3f2dde[_0x4fdc78(0xcb)]))===null||_0x525b0d===void 0x0?void 0x0:_0x525b0d['id'];if(!_0x44e6a5)return;const _0x39892a=this[_0x4fdc78(0xd6)][_0x44e6a5];if(!_0x39892a[_0x4fdc78(0xed)])return;const _0x487cd9=this[_0x4fdc78(0xac)][_0x44e6a5],_0x1a0d6d=_0x39892a[_0x487cd9];return this[_0x4fdc78(0xac)][_0x44e6a5]++,this[_0x4fdc78(0xac)][_0x44e6a5]>=_0x39892a[_0x4fdc78(0xed)]&&(this['keyPoolIndexMap'][_0x44e6a5]=0x0),_0x1a0d6d;}async[_0x39785a(0xc4)](){const _0x219157=_0x39785a;var _0x463f1d;const _0x235780=await((_0x463f1d=this[_0x219157(0xdb)][_0x219157(0xec)](_0x3f9d5e=>_0x3f9d5e['model'][_0x219157(0xf6)](_0x219157(0x94))))===null||_0x463f1d===void 0x0?void 0x0:_0x463f1d['id']);return this[_0x219157(0xc5)](_0x235780);}async['getModelTypeIdFromModelName'](_0x1f3340){const _0x5f1c9d=_0x39785a;var _0x22c06b;if(!_0x1f3340){const _0x4b5768=await this[_0x5f1c9d(0xc2)]();return _0x4b5768?_0x4b5768['id']:null;}return(_0x22c06b=this['modelTypes'][_0x5f1c9d(0xec)](_0x57594e=>_0x57594e[_0x5f1c9d(0xca)]===_0x1f3340))===null||_0x22c06b===void 0x0?void 0x0:_0x22c06b['id'];}[_0x39785a(0xc9)](_0x49aec0){const _0x3fea3f=_0x39785a,_0x3480f5=_0x49aec0[_0x3fea3f(0x92)]('/')?_0x49aec0['slice'](0x0,-0x1):_0x49aec0,_0x16d5fb=_0x3480f5||_0x3fea3f(0xaa);return _0x16d5fb+'/v1/chat/completions';}async['searchGpts'](_0x8c03bc,_0x2a109d){const _0x222725=_0x39785a;var _0x54a55e,_0x372bcf,_0x20f337,_0x4992ce;const {keyword:_0x59e473}=_0x2a109d,_0x137cb4=await this[_0x222725(0xf9)](_0x222725(0xd9)),_0x59b667=await this['getCurrentModelKeyInfo'](_0x137cb4);if(!_0x59b667)throw new common_1[(_0x222725(0xce))](_0x222725(0x98),common_1[_0x222725(0xf8)][_0x222725(0xcc)]);const {key:_0x50ec3c,proxyUrl:_0x13d383}=_0x59b667,_0x1e6681={'method':'POST','url':this['getFullUrl'](_0x13d383),'headers':{'Content-Type':'application/json','Authorization':'Bearer\x20'+(0x0,utils_1[_0x222725(0xa8)])(_0x50ec3c)},'data':{'max_tokens':0xc8,'model':'search-gpts','messages':[{'role':_0x222725(0xda),'content':_0x59e473}]}};console[_0x222725(0xb0)](_0x222725(0xb8),_0x1e6681);try{const _0x125861=await(0x0,axios_1[_0x222725(0xbe)])(_0x1e6681);if(_0x125861['status']!==0xc8||!((_0x54a55e=_0x125861===null||_0x125861===void 0x0?void 0x0:_0x125861[_0x222725(0xea)])===null||_0x54a55e===void 0x0?void 0x0:_0x54a55e['choices']['length']))throw new common_1['HttpException'](_0x222725(0x102),common_1['HttpStatus'][_0x222725(0xcc)]);const _0x229602=(_0x4992ce=(_0x20f337=(_0x372bcf=_0x125861===null||_0x125861===void 0x0?void 0x0:_0x125861['data'])===null||_0x372bcf===void 0x0?void 0x0:_0x372bcf[_0x222725(0xa9)][0x0])===null||_0x20f337===void 0x0?void 0x0:_0x20f337[_0x222725(0x8e)])===null||_0x4992ce===void 0x0?void 0x0:_0x4992ce[_0x222725(0xfc)],_0x324d66=JSON[_0x222725(0xa7)](_0x229602);return _0x324d66['items'][_0x222725(0xab)](_0x16d6f9=>{const _0x52f75a=_0x222725,{gizmo:_0x482461,tools:_0x8ffcf1}=_0x16d6f9,{id:_0x51ab97,display:_0x587e4d,vanity_metrics:_0x1cac98}=_0x482461,{name:_0x32f734,description:_0xaa4742,prompt_starters:_0x2ea146,profile_picture_url:_0xe41b05,welcome_message:_0x409076}=_0x587e4d,{num_conversations_str:_0x5b5058,created_ago_str:_0x2dfca7}=_0x1cac98;return{'gptsId':_0x51ab97,'name':_0x32f734,'des':_0xaa4742,'demoData':Array['isArray'](_0x2ea146)?_0x2ea146[_0x52f75a(0x9a)]('\x0a'):_0x2ea146,'coverImg':_0xe41b05,'heat':_0x5b5058,'createTime':_0x2dfca7,'welcome_message':_0x409076,'isGpts':!![]};});}catch(_0x551c14){console['log'](_0x222725(0xaf),_0x551c14);throw new common_1['HttpException']('搜索异常！',common_1[_0x222725(0xf8)]['BAD_REQUEST']);}}};ModelsService=__decorate([(0x0,common_1[_0x39785a(0x8f)])(),__param(0x0,(0x0,typeorm_1[_0x39785a(0x97)])(modelType_entity_1[_0x39785a(0x82)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(modelKeys_entity_1[_0x39785a(0x9e)])),__metadata(_0x39785a(0xf1),[typeorm_2['Repository'],typeorm_2['Repository']])],ModelsService),exports[_0x39785a(0x81)]=ModelsService;