'use strict';const _0x483a66=_0x5e46;(function(_0x3ce06e,_0x1bb894){const _0x37d59c=_0x5e46,_0x5828bb=_0x3ce06e();while(!![]){try{const _0x5b8db1=parseInt(_0x37d59c(0x1d4))/0x1*(-parseInt(_0x37d59c(0x236))/0x2)+-parseInt(_0x37d59c(0x243))/0x3+parseInt(_0x37d59c(0x251))/0x4*(-parseInt(_0x37d59c(0x1a7))/0x5)+-parseInt(_0x37d59c(0x21a))/0x6+-parseInt(_0x37d59c(0x268))/0x7*(-parseInt(_0x37d59c(0x294))/0x8)+-parseInt(_0x37d59c(0x2a4))/0x9+parseInt(_0x37d59c(0x2c0))/0xa*(parseInt(_0x37d59c(0x1f8))/0xb);if(_0x5b8db1===_0x1bb894)break;else _0x5828bb['push'](_0x5828bb['shift']());}catch(_0x5736a8){_0x5828bb['push'](_0x5828bb['shift']());}}}(_0x2c44,0x72483));function _0x2c44(){const _0x138ee5=['chat-error-detail\x20\x20<----------------------------------------->','307623lvoXAU','chat-error\x20<----------------------------------------->','result','./chatBoxType.entity','REDIS_PASSWORD','../fanyi/fanyi.service','forEach','typeId','openaiModel4MaxTokens32kRes','chatGroupService','modelTypeId','getModelProxyUrl','uploadService','path','28NTcZmj','nineai-chatlog','getDefaultModel','default','userBalanceService','keyPool','modelConfig','DeductionKey','proxyUrl','chatSpeechToText','b64_json','audio','usage','32k','tts-1','queryUserBalance','DESC','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','../autoreply/autoreply.service','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','write','AutoreplyService','当前应用使用的模型已被管理员下架、请联系管理员上架此模型！','250460DFDwWm','onModuleInit','Catch\x20Error\x20','systemMessage','语音转文字失败:\x20','importDynamic','../userBalance/userBalance.service','coverImg','getConfigs','conversationId','fanyiService','chatPreEntity','buildMessageFromParentMessageId','appInfo','REDIS_HOST','function','/v1/images/generations','./helper','replace','ChatPreEntity','__param','response','base64','message','push','ChatBoxEntity','dall-e-3','getTtsModelKey','size','error:\x20','Please\x20check\x20the\x20back-end\x20console','当前分类下有未处理数据不可移除！','请将语言转为中文简体','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','BadwordsService','delChatPreType','parse','end','__esModule','queryChatPreType','../chatGroup/chatGroup.service','DrawService','delChatPre','fable','8RCyHRJ','../chatLog/chatLog.service','当前语音转文字模型暂未上架、请联系管理员上架此模型！','unifiedFormattingResponse','keyv','CHAT_TYPE','post','statusText','InjectRepository','getBaseConfig','非法操作！','redis://','config','__metadata','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型或更换模型使用！','appEntity','224559uvxotr','PAYMENT_REQUIRED','body','服务异常、请重新试试吧！！！','https://api.openai.com','find','getClientIp','当前模型调用过于频繁、请重新试试吧！','../globalConfig/config.entity','modelsService','getUseDrawModelKey','toLowerCase','is_end','setChatPreType','REDIS_PORT','1106','../../common/constants/errorMessage.constant','openaiTimeoutMs','../../common/constants/balance.constant','sendMessageFromOpenAi','../../common/utils','pipe','statusCode','openaiProxyUrl','extractFilePath','speech',',\x20最大回复token:\x20','\x20key\x20->\x20','9348110GfZwAa','当前Key余额已不足、请重新再试一次吧！','NineStore','gptKeysEntity','billing','OpenAiErrorCodeMessage','HttpException','HttpStatus','toISOString','getModelTypeIdFromGpts','log','49185FtOcft','queryChatPre','chatBoxTypeEntity','./chatPreType.entity','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','childList','user','setHeader','from','data','chat','./gptkeys.entity','model','UserBalanceService','Incorrect\x20API\x20key\x20provided','typeInfo','/v1','chatPreTypeEntity','checkBadWords','chatBoxEntity','delChatBoxType','decorate','getModelTypeIdFromPluginId','maxModelTokens','getModelTypeDetailFromId','queryChatPreList','缺失必要参数！','getGroupInfoFromId','语音转文字失败、请稍后试试吧！','standard','openai','quality','env','./store','saveChatLog','queryChatBoxType','\x20model:\x20','setChatPre','getAllKeyList','badwordsService','mjDraw','ChatBoxTypeEntity','split','prevChatId','findOne','1ejteRY','includes','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','saveUseLog','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','model3','ConfigEntity','validateBalance',',\x20key\x20===>\x20','filter','formatModelToken','getMaxTokenFromModelWithOpenAi','@nestjs/typeorm','statusText:','lockKey','openaiModel3MaxTokens16k','object','UploadService','绘制图片失败，请稍后试试吧！','systemPreMessage','count','./baidu','chatLogService','Bearer\x20','UserService','globalConfigService','nineStore','__decorate','map','length','sendMessageFromZhipu','GlobalConfigService','getCurrentModelKeyInfo','sendMessageFromBaidu','16k','\x0a\x20Current\x20date:\x20','11ryHNEv','removeSpecialCharacters','REDIS_USER','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','checkUserStatus','gpt-4','realTimeTextToSpeech','userBanance','ModelsService','getUuid','typeorm','ChatgptService','../badwords/badwords.service','当前绘画模型暂未上架、请联系管理员上架此模型！','prompt','ChatGroupService','axios','openaiBaseUrl','appId','./zhipu','endsWith','getTokenCount','debug','Billing\x20hard\x20limit\x20has\x20been\x20reached','slice',',\x20模型名称:\x20','setChatBox','assistant','../../public','uuid','stringify','genPluginSystemMessage','../models/models.service','text','1777260fAcSrU','error','userService','openaiModel4MaxTokensRes','update','close','whisper-1','metadata','deductFromBalance','BAD_REQUEST','addOneIfOdd','openaiModel3MaxTokensRes','Content-type','configService','create','Repository','语音转文字识别失败、请稍后试试吧！','queryChatBoxFrontend','setData','uploadFile','draw\x20paompt\x20info\x20<==**==>\x20','./../upload/upload.service','nestjs-config','assign','openaiModel3MaxTokens16kRes','application/octet-stream;\x20charset=utf-8','@keyv/redis','delete','19862kzUtAi','Too\x20Many\x20Requests','提供了错误的模型秘钥','ChatPreTypeEntity','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','getUploadType','save','transcriptions','status','code:\x20','autoreplyService','gpt-3'];_0x2c44=function(){return _0x138ee5;};return _0x2c44();}var __decorate=this&&this[_0x483a66(0x1ef)]||function(_0x435188,_0xb64a76,_0x5cef6e,_0x31d679){const _0x23edad=_0x483a66;var _0x5117f3=arguments[_0x23edad(0x1f1)],_0x4d8cf1=_0x5117f3<0x3?_0xb64a76:_0x31d679===null?_0x31d679=Object['getOwnPropertyDescriptor'](_0xb64a76,_0x5cef6e):_0x31d679,_0x5c57db;if(typeof Reflect===_0x23edad(0x1e4)&&typeof Reflect[_0x23edad(0x1bc)]===_0x23edad(0x277))_0x4d8cf1=Reflect['decorate'](_0x435188,_0xb64a76,_0x5cef6e,_0x31d679);else{for(var _0x1fff52=_0x435188['length']-0x1;_0x1fff52>=0x0;_0x1fff52--)if(_0x5c57db=_0x435188[_0x1fff52])_0x4d8cf1=(_0x5117f3<0x3?_0x5c57db(_0x4d8cf1):_0x5117f3>0x3?_0x5c57db(_0xb64a76,_0x5cef6e,_0x4d8cf1):_0x5c57db(_0xb64a76,_0x5cef6e))||_0x4d8cf1;}return _0x5117f3>0x3&&_0x4d8cf1&&Object['defineProperty'](_0xb64a76,_0x5cef6e,_0x4d8cf1),_0x4d8cf1;},__metadata=this&&this[_0x483a66(0x2a1)]||function(_0x983495,_0x37ed84){const _0x33c5cc=_0x483a66;if(typeof Reflect===_0x33c5cc(0x1e4)&&typeof Reflect[_0x33c5cc(0x221)]==='function')return Reflect[_0x33c5cc(0x221)](_0x983495,_0x37ed84);},__param=this&&this[_0x483a66(0x27c)]||function(_0x541ca3,_0x1c7c96){return function(_0xfac521,_0x2c310e){_0x1c7c96(_0xfac521,_0x2c310e,_0x541ca3);};};Object['defineProperty'](exports,_0x483a66(0x28e),{'value':!![]}),exports[_0x483a66(0x203)]=void 0x0;const upload_service_1=require(_0x483a66(0x22f)),user_service_1=require('./../user/user.service'),nestjs_config_1=require(_0x483a66(0x230)),common_1=require('@nestjs/common'),errorMessage_constant_1=require(_0x483a66(0x2b4)),openai_1=require(_0x483a66(0x1c5)),utils_1=require(_0x483a66(0x2b8)),axios_1=require(_0x483a66(0x208)),userBalance_service_1=require(_0x483a66(0x26e)),balance_constant_1=require(_0x483a66(0x2b6)),chatLog_service_1=require(_0x483a66(0x295)),uuid=require(_0x483a66(0x215)),config_entity_1=require(_0x483a66(0x2ac)),typeorm_1=require(_0x483a66(0x202)),typeorm_2=require(_0x483a66(0x1e0)),badwords_service_1=require(_0x483a66(0x204)),autoreply_service_1=require(_0x483a66(0x263)),gptkeys_entity_1=require(_0x483a66(0x1b2)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),fanyi_service_1=require(_0x483a66(0x248)),app_entity_1=require('../app/app.entity'),chatGroup_service_1=require(_0x483a66(0x290)),models_service_1=require(_0x483a66(0x218)),baidu_1=require(_0x483a66(0x1e9)),helper_1=require(_0x483a66(0x279)),store_1=require(_0x483a66(0x1c8)),zhipu_1=require(_0x483a66(0x20b)),openai_2=require('./openai'),chatBoxType_entity_1=require(_0x483a66(0x246)),chatBox_entity_1=require('./chatBox.entity'),chatPre_entity_1=require('./chatPre.entity'),chatPreType_entity_1=require(_0x483a66(0x1aa)),fs=require('fs'),path_1=require(_0x483a66(0x250));function _0x5e46(_0x5842e6,_0x576c7b){const _0x2c44b6=_0x2c44();return _0x5e46=function(_0x5e464b,_0x1566df){_0x5e464b=_0x5e464b-0x1a4;let _0xce14ac=_0x2c44b6[_0x5e464b];return _0xce14ac;},_0x5e46(_0x5842e6,_0x576c7b);}let ChatgptService=class ChatgptService{constructor(_0x83eb73,_0x1b02e2,_0x521988,_0x9cebb6,_0x54c0f5,_0x349caf,_0x2e800b,_0x59bcc3,_0xff6cfb,_0x48080e,_0x3fa646,_0x66269e,_0x50c194,_0x555223,_0x2c2003,_0x3d5158,_0x33c13e,_0x25b51e){const _0xc373fb=_0x483a66;this['gptKeysEntity']=_0x83eb73,this['configEntity']=_0x1b02e2,this[_0xc373fb(0x1a9)]=_0x521988,this[_0xc373fb(0x1ba)]=_0x9cebb6,this[_0xc373fb(0x2a3)]=_0x54c0f5,this[_0xc373fb(0x1b8)]=_0x349caf,this[_0xc373fb(0x273)]=_0x2e800b,this[_0xc373fb(0x227)]=_0x59bcc3,this[_0xc373fb(0x255)]=_0xff6cfb,this[_0xc373fb(0x1ea)]=_0x48080e,this[_0xc373fb(0x21c)]=_0x3fa646,this['uploadService']=_0x66269e,this['badwordsService']=_0x50c194,this[_0xc373fb(0x240)]=_0x555223,this[_0xc373fb(0x1ed)]=_0x2c2003,this[_0xc373fb(0x272)]=_0x3d5158,this[_0xc373fb(0x24c)]=_0x33c13e,this[_0xc373fb(0x2ad)]=_0x25b51e,this[_0xc373fb(0x1ee)]=null,this['whiteListUser']=[],this[_0xc373fb(0x256)]={'list3':[],'list4':[]};}async[_0x483a66(0x269)](){const _0x1804c9=_0x483a66;let _0x4047e9=await(0x0,utils_1['importDynamic'])('chatgpt-nine-ai'),_0x5d958e=await(0x0,utils_1[_0x1804c9(0x26d)])(_0x1804c9(0x234)),_0x204a7d=await(0x0,utils_1[_0x1804c9(0x26d)])(_0x1804c9(0x298));_0x4047e9=(_0x4047e9===null||_0x4047e9===void 0x0?void 0x0:_0x4047e9[_0x1804c9(0x254)])?_0x4047e9[_0x1804c9(0x254)]:_0x4047e9,_0x5d958e=(_0x5d958e===null||_0x5d958e===void 0x0?void 0x0:_0x5d958e[_0x1804c9(0x254)])?_0x5d958e['default']:_0x5d958e,_0x204a7d=(_0x204a7d===null||_0x204a7d===void 0x0?void 0x0:_0x204a7d[_0x1804c9(0x254)])?_0x204a7d[_0x1804c9(0x254)]:_0x204a7d;const {ChatGPTAPI:_0x52a062,ChatGPTError:_0x582855,ChatGPTUnofficialProxyAPI:_0xd451db}=_0x4047e9,_0x559608=+process[_0x1804c9(0x1c7)][_0x1804c9(0x2b2)],_0x509a2d=process[_0x1804c9(0x1c7)][_0x1804c9(0x276)],_0x32cbd2=process['env'][_0x1804c9(0x247)],_0x35cc7c=process[_0x1804c9(0x1c7)][_0x1804c9(0x1fa)],_0x587e07=_0x1804c9(0x29f)+(_0x35cc7c||'')+':'+(_0x32cbd2||'')+'@'+_0x509a2d+':'+_0x559608,_0xf43e9d=new _0x5d958e(_0x587e07),_0x2295f4=new _0x204a7d({'store':_0xf43e9d,'namespace':_0x1804c9(0x252)});this[_0x1804c9(0x1ee)]=new store_1[(_0x1804c9(0x2c2))]({'store':_0x2295f4,'namespace':_0x1804c9(0x1b1)});}async['chatSyncFree'](_0x5183ba){const _0x4937a5=_0x483a66,_0x49cc6b=await this[_0x4937a5(0x2ad)][_0x4937a5(0x253)]();if(!_0x49cc6b)return;const {model:_0x7607b1,maxTokens:_0x5f0089}=_0x49cc6b,_0x47d29e=await this[_0x4937a5(0x2ad)][_0x4937a5(0x1f4)](_0x49cc6b['id']);if(!_0x47d29e)return;const _0x79247e=await this[_0x4937a5(0x1ed)][_0x4937a5(0x270)]([_0x4937a5(0x1e7)]),{key:_0x2a1d26,proxyUrl:_0x44371d}=_0x47d29e,{context:_0x14219a}=await this['nineStore'][_0x4937a5(0x274)](_0x5183ba,{'parentMessageId':'','systemMessage':_0x79247e});try{const _0x35d4c9=await(0x0,openai_2['sendMessageFromOpenAi'])(_0x14219a,{'apiKey':(0x0,utils_1[_0x4937a5(0x1f9)])(_0x2a1d26),'model':_0x7607b1,'proxyUrl':_0x44371d,'maxToken':_0x5f0089,'onProgress':null});return _0x35d4c9===null||_0x35d4c9===void 0x0?void 0x0:_0x35d4c9['text'];}catch(_0x350a36){console[_0x4937a5(0x1a6)](_0x4937a5(0x285),_0x350a36);}}[_0x483a66(0x2bc)](_0x3b9d87){const _0x59d67b=new URL(_0x3b9d87);return _0x59d67b['pathname'];}async[_0x483a66(0x25a)](_0x86d1d){const _0x4f5a2f=_0x483a66,_0x49060a=await this[_0x4f5a2f(0x2ad)][_0x4f5a2f(0x283)]();if(!_0x49060a)throw new common_1[(_0x4f5a2f(0x2c6))](_0x4f5a2f(0x296),common_1[_0x4f5a2f(0x2c7)][_0x4f5a2f(0x223)]);const {key:_0x490fe3,proxyUrl:_0x36626d}=_0x49060a,_0xfce70c=_0x36626d[_0x4f5a2f(0x20c)]('/')?_0x36626d+'v1':_0x36626d+_0x4f5a2f(0x1b7),_0xeb1797=new openai_1['default']({'baseURL':_0xfce70c,'apiKey':_0x490fe3}),_0x4fe301=this[_0x4f5a2f(0x2bc)](_0x86d1d),_0x22225a=(0x0,path_1['join'])(__dirname,_0x4f5a2f(0x214),_0x4fe301)[_0x4f5a2f(0x27a)]('/dist',''),_0x3483cb=await _0xeb1797['audio'][_0x4f5a2f(0x23d)][_0x4f5a2f(0x228)]({'model':_0x4f5a2f(0x220),'prompt':_0x4f5a2f(0x288),'file':fs['createReadStream'](_0x22225a)});return console['log'](_0x4f5a2f(0x26c),_0x3483cb),(_0x3483cb===null||_0x3483cb===void 0x0?void 0x0:_0x3483cb[_0x4f5a2f(0x219)])||null;}async['chatRealTimeTextToSpeech'](_0x37fb87,_0x1d6a32,_0x37b862){const _0x4ba962=_0x483a66,{name:name=_0x4ba962(0x293),text:text=''}=_0x37b862;try{const _0x3ffba7=await this[_0x4ba962(0x2ad)]['getTtsModelKey']();if(!_0x3ffba7)throw new common_1[(_0x4ba962(0x2c6))](_0x4ba962(0x296),common_1[_0x4ba962(0x2c7)][_0x4ba962(0x223)]);const {key:_0xa18353,proxyUrl:_0x4c87fb}=_0x3ffba7,_0x18a942=_0x4c87fb['endsWith']('/')?_0x4c87fb+'v1':_0x4c87fb+_0x4ba962(0x1b7),_0xade37=new openai_1['default']({'baseURL':_0x18a942,'apiKey':_0xa18353}),_0xedb08c=await _0xade37['audio'][_0x4ba962(0x2bd)][_0x4ba962(0x228)]({'model':_0x4ba962(0x25f),'voice':name,'input':text});_0xedb08c[_0x4ba962(0x2a6)]['pipe'](_0x37fb87);}catch(_0x505035){console[_0x4ba962(0x1a6)](_0x4ba962(0x285),_0x505035);throw new common_1[(_0x4ba962(0x2c6))](_0x4ba962(0x1c3),common_1['HttpStatus'][_0x4ba962(0x223)]);}}async['realTimeTextToSpeechChat'](_0x46acbf,_0x5c2a99){const _0x9b9f6c=_0x483a66,{id:_0x511b2f,voiceType:_0xe989f1}=_0x5c2a99;if(!_0x511b2f)return;const _0x21d05b=await this[_0x9b9f6c(0x1ea)]['getChatInfoFromId'](_0x511b2f);if(!_0x21d05b)return;const {answer:_0x188951,prompt:_0x5df7bc}=_0x21d05b,_0x3680fa=_0x188951||_0x5df7bc;return this['realTimeTextToSpeech'](_0x46acbf,_0x3680fa,_0xe989f1);}async[_0x483a66(0x1fe)](_0x56a8b0,_0x47b004,_0x2b15c4=_0x483a66(0x293)){const _0xbd008c=_0x483a66,_0x15425b=await this[_0xbd008c(0x2ad)][_0xbd008c(0x283)]();if(!_0x15425b)throw new common_1[(_0xbd008c(0x2c6))](_0xbd008c(0x296),common_1['HttpStatus']['BAD_REQUEST']);const {key:_0x497d9d,proxyUrl:_0x2f82b2}=_0x15425b,_0x34a83f=_0x2f82b2[_0xbd008c(0x20c)]('/')?_0x2f82b2+'v1':_0x2f82b2+'/v1',_0x6062b=new openai_1['default']({'baseURL':_0x34a83f,'apiKey':_0x497d9d}),_0x3fb935=await _0x6062b[_0xbd008c(0x25c)][_0xbd008c(0x2bd)][_0xbd008c(0x228)]({'model':'tts-1','voice':_0x2b15c4,'input':_0x47b004});_0x3fb935[_0xbd008c(0x2a6)][_0xbd008c(0x2b9)](_0x56a8b0);}async['chatTextToSpeech'](_0x1a6427){const _0x37ddce=_0x483a66;try{const _0x2e6abd=await this[_0x37ddce(0x2ad)][_0x37ddce(0x283)]();if(!_0x2e6abd)throw new common_1[(_0x37ddce(0x2c6))](_0x37ddce(0x296),common_1[_0x37ddce(0x2c7)][_0x37ddce(0x223)]);const {key:_0x57285f,proxyUrl:_0x182899}=_0x2e6abd,_0x475a84=_0x182899[_0x37ddce(0x20c)]('/')?_0x182899+'v1':_0x182899+'/v1',_0x4ad1d2=new openai_1[(_0x37ddce(0x254))]({'baseURL':_0x475a84,'apiKey':_0x57285f});}catch(_0x37a7df){console[_0x37ddce(0x1a6)]('error:\x20',_0x37a7df);throw new common_1[(_0x37ddce(0x2c6))](_0x37ddce(0x1c3),common_1[_0x37ddce(0x2c7)]['BAD_REQUEST']);}}async['chatProcess'](_0x2e13e9,_0x59868d,_0x4761f2){const _0xb62991=_0x483a66;var _0x402c1e,_0x5e9634,_0x2fa8b8;const _0x2730a2=_0x59868d['abortController'],{options:options={},appId:_0xd94e46,cusromPrompt:_0x5842b5,systemMessage:systemMessage='',tts:tts=''}=_0x2e13e9;let _0x243973=_0x2e13e9[_0xb62991(0x206)];const {parentMessageId:_0x2f8c0d,file:_0x3cc3d8,groupId:_0x3af81e,usingNetwork:_0x3ecccf}=options;let _0x4c7a8b=systemMessage,_0x13c7dc=_0x3cc3d8;if(!tts&&!_0x243973&&!_0x3cc3d8)throw new common_1[(_0xb62991(0x2c6))]('请输入对话内容',common_1['HttpStatus']['BAD_REQUEST']);if(tts){const _0x4f3e43=await this[_0xb62991(0x25a)](tts);if(!_0x4f3e43)throw new common_1[(_0xb62991(0x2c6))](_0xb62991(0x22a),common_1[_0xb62991(0x2c7)]['BAD_REQUEST']);_0x243973=_0x4f3e43;}const _0x3a2666=await this['chatGroupService'][_0xb62991(0x1c2)](_0x3af81e),_0x5a571d=(_0x3a2666===null||_0x3a2666===void 0x0?void 0x0:_0x3a2666['pluginId'])||0x0;let _0x597046=(_0x3a2666===null||_0x3a2666===void 0x0?void 0x0:_0x3a2666[_0xb62991(0x2a0)])?JSON[_0xb62991(0x28c)](_0x3a2666[_0xb62991(0x2a0)]):null;(!_0x597046||!_0x597046[_0xb62991(0x24d)]||!_0x597046[_0xb62991(0x257)])&&!_0x5a571d&&(_0x597046=await this['modelsService'][_0xb62991(0x29d)]());let _0x2659bd=0x0,_0x2b195b='',_0x4f36fc=null;_0x5a571d&&(_0x2659bd=await this[_0xb62991(0x2ad)][_0xb62991(0x1bd)](_0x5a571d));if(_0xd94e46){const _0x3448f0=await this['appEntity'][_0xb62991(0x1d3)]({'where':{'id':_0xd94e46,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x3448f0)throw new common_1[(_0xb62991(0x2c6))](_0xb62991(0x264),common_1[_0xb62991(0x2c7)][_0xb62991(0x223)]);const {modelTypeId:_0x135946,isGpts:_0x4cb058,preset:_0x5e3701,gptsId:_0x2c7cfd}=_0x3448f0;if(_0x4cb058){_0x2659bd=await this['modelsService'][_0xb62991(0x1a5)]();if(!_0x2659bd)throw new common_1['HttpException'](_0xb62991(0x267),common_1['HttpStatus'][_0xb62991(0x223)]);_0x4f36fc=_0x2c7cfd;}else _0x2659bd=_0x135946,_0x2b195b=_0x5e3701;}(!_0x5a571d&&!_0xd94e46||!_0x2659bd)&&(_0x2659bd=_0x597046['modelTypeId']);const _0x1951e6=await this[_0xb62991(0x2ad)][_0xb62991(0x1bf)](_0x2659bd);if(!_0x1951e6)throw new common_1['HttpException']('当前流程所需要的模型已被管理员下架、请联系管理员上架此模型或更换其他模型使用！',common_1[_0xb62991(0x2c7)][_0xb62991(0x223)]);const {deduct:_0x354569,deductType:_0x5d3139,model:_0x114351,maxTokens:_0x410c72,modelType:_0x53773a,modelName:_0x266aac}=_0x1951e6,{systemMessage:_0x4a8302,topN:_0x48f658,maxResponseTokens:_0x4a36f5,rounds:_0x3cdd79}=_0x597046[_0xb62991(0x257)];let _0x59702f=null;!_0x5842b5?_0x59702f=await this[_0xb62991(0x2ad)][_0xb62991(0x1f4)](_0x2659bd):_0x59702f=await this[_0xb62991(0x2ad)]['getUseToolsModelKey']();if(!_0x59702f)throw new common_1['HttpException'](_0xb62991(0x2a2),common_1[_0xb62991(0x2c7)][_0xb62991(0x223)]);const {key:_0x59dbc4,secret:_0x166167,id:_0x11fa9e,accessToken:_0x16c27e,proxyUrl:_0x1c4805}=_0x59702f;await this[_0xb62991(0x21c)][_0xb62991(0x1fc)](_0x59868d[_0xb62991(0x1ad)]),await this[_0xb62991(0x255)][_0xb62991(0x1db)](_0x59868d,_0x5d3139===0x1?_0xb62991(0x1d9):'model4',_0x354569),_0x4761f2&&_0x4761f2[_0xb62991(0x1ae)](_0xb62991(0x226),_0xb62991(0x233)),await this[_0xb62991(0x1ce)][_0xb62991(0x1b9)](_0x243973,_0x59868d[_0xb62991(0x1ad)]['id']);const _0x3c9db3=await this[_0xb62991(0x240)]['checkAutoReply'](_0x243973);if(_0x3c9db3&&_0x4761f2){const _0x380582={'message':_0x3c9db3,'code':0x1f4};return _0x4761f2[_0xb62991(0x265)](JSON[_0xb62991(0x216)](_0x380582)),_0x4761f2[_0xb62991(0x28d)]();}if(_0xd94e46)_0x2b195b&&(_0x4c7a8b=_0x2b195b);else{if(_0x5842b5)_0x4c7a8b=_0x2e13e9[_0xb62991(0x26b)];else{if(_0x4a8302)_0x4c7a8b=_0x4a8302;else{const _0x568334=new Date()[_0xb62991(0x1a4)]()[_0xb62991(0x1d1)]('T')[0x0],_0x4f7ece=await this['globalConfigService']['getConfigs'](['systemPreMessage']);_0x4c7a8b=_0x4f7ece+(_0xb62991(0x1f7)+_0x568334);}}}if(_0x5a571d){_0x4c7a8b=null;const {imgUrl:_0x331c9e,documentUrl:_0x58bbb8}=_0x3a2666;_0x13c7dc=_0x331c9e||_0x58bbb8,_0x4c7a8b=(0x0,helper_1[_0xb62991(0x217)])(Object[_0xb62991(0x231)](Object[_0xb62991(0x231)]({},_0x3a2666),{'pluginId':_0x5a571d}));}_0x4761f2&&_0x4761f2[_0xb62991(0x23e)](0xc8);let _0x1e404f=null,_0x38d978=null;try{if(_0x4761f2){let _0x2f6e2d=null,_0xea17dc=![];_0x4761f2['on'](_0xb62991(0x21f),async()=>{const _0x211ef2=_0xb62991;if(_0xea17dc)return;_0x2730a2['abort']();const _0xd31b3c=await(0x0,openai_2[_0x211ef2(0x20d)])(_0x243973)||0x0,_0x4270d3=await(0x0,openai_2[_0x211ef2(0x20d)])(_0x2f6e2d===null||_0x2f6e2d===void 0x0?void 0x0:_0x2f6e2d[_0x211ef2(0x219)])||0x0,_0x4359d1=_0xd31b3c+_0x4270d3,_0x44d8ce=(0x0,utils_1[_0x211ef2(0x2aa)])(_0x59868d);await this[_0x211ef2(0x1ea)][_0x211ef2(0x1c9)]({'appId':_0xd94e46,'curIp':_0x44d8ce,'userId':_0x59868d[_0x211ef2(0x1ad)]['id'],'type':balance_constant_1[_0x211ef2(0x258)]['CHAT_TYPE'],'prompt':_0x243973,'answer':'','promptTokens':_0xd31b3c,'completionTokens':0x0,'totalTokens':_0xd31b3c,'model':_0x114351,'role':_0x211ef2(0x1ad),'groupId':_0x3af81e,'tts':tts,'file':_0x13c7dc,'requestOptions':JSON[_0x211ef2(0x216)]({'options':null,'prompt':_0x243973})}),await this[_0x211ef2(0x1ea)][_0x211ef2(0x1c9)]({'appId':_0xd94e46,'curIp':_0x44d8ce,'userId':_0x59868d['user']['id'],'type':balance_constant_1[_0x211ef2(0x258)][_0x211ef2(0x299)],'prompt':_0x243973,'answer':_0x2f6e2d===null||_0x2f6e2d===void 0x0?void 0x0:_0x2f6e2d[_0x211ef2(0x219)],'promptTokens':_0xd31b3c,'completionTokens':_0x4270d3,'totalTokens':_0x4359d1,'model':_0x114351,'role':_0x211ef2(0x213),'groupId':_0x3af81e,'requestOptions':JSON[_0x211ef2(0x216)]({'options':{'model':_0x114351,'temperature':_0x48f658},'prompt':_0x243973}),'conversationOptions':JSON[_0x211ef2(0x216)]({'conversationId':_0x2f6e2d===null||_0x2f6e2d===void 0x0?void 0x0:_0x2f6e2d['conversationId'],'model':_0x114351,'parentMessageId':_0x2f6e2d===null||_0x2f6e2d===void 0x0?void 0x0:_0x2f6e2d['id'],'temperature':_0x48f658})}),await this['userBalanceService'][_0x211ef2(0x222)](_0x59868d['user']['id'],'model'+(_0x5d3139===0x1?0x3:0x4),_0x354569,_0x4359d1);});const _0x8d7f31=_0x243973;if(Number(_0x53773a)===0x1){const {context:_0x360223}=await this[_0xb62991(0x1ee)]['buildMessageFromParentMessageId'](_0x8d7f31,{'parentMessageId':_0x2f8c0d,'systemMessage':_0x4c7a8b,'maxModelToken':_0x410c72,'maxResponseTokens':_0x4a36f5,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x3cdd79),'file':_0x13c7dc});let _0x490c1b=!![];_0x1e404f=await(0x0,openai_2[_0xb62991(0x2b7)])(_0x360223,{'maxToken':_0x4a36f5,'apiKey':_0x59dbc4,'model':_0x114351,'temperature':_0x48f658,'proxyUrl':_0x1c4805,'usingNetwork':_0x3ecccf,'gptsId':_0x4f36fc,'onProgress':_0x2bce78=>{const _0x92c231=_0xb62991;_0x4761f2[_0x92c231(0x265)](_0x490c1b?JSON[_0x92c231(0x216)](_0x2bce78):'\x0a'+JSON[_0x92c231(0x216)](_0x2bce78)),_0x2f6e2d=_0x2bce78,_0x490c1b=![];}}),_0xea17dc=!![];}if(Number(_0x53773a)===0x2){let _0x5c9203=!![];const {context:_0x22d205}=await this[_0xb62991(0x1ee)]['buildMessageFromParentMessageId'](_0x243973,{'parentMessageId':_0x2f8c0d,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x3cdd79)});_0x1e404f=await(0x0,baidu_1[_0xb62991(0x1f5)])(_0x22d205,{'temperature':_0x48f658,'accessToken':_0x16c27e,'model':_0x114351,'onProgress':_0x5be464=>{const _0x2c47e8=_0xb62991;_0x4761f2[_0x2c47e8(0x265)](_0x5c9203?JSON['stringify'](_0x5be464):'\x0a'+JSON[_0x2c47e8(0x216)](_0x5be464)),_0x5c9203=![],_0x2f6e2d=_0x5be464;}}),_0xea17dc=!![];}if(Number(_0x53773a)===0x3){let _0x22de6c=!![];const {context:_0x231ec4}=await this['nineStore'][_0xb62991(0x274)](_0x243973,{'parentMessageId':_0x2f8c0d,'maxRounds':(0x0,helper_1[_0xb62991(0x224)])(_0x3cdd79)});_0x1e404f=await(0x0,zhipu_1[_0xb62991(0x1f2)])(_0x231ec4,{'temperature':_0x48f658,'key':_0x59dbc4,'model':_0x114351,'onProgress':_0xdc83b7=>{const _0x3c5dd3=_0xb62991;_0x4761f2['write'](_0x22de6c?JSON['stringify'](_0xdc83b7):'\x0a'+JSON[_0x3c5dd3(0x216)](_0xdc83b7)),_0x22de6c=![],_0x2f6e2d=_0xdc83b7;}}),_0xea17dc=!![];}const _0x343e88={'id':this['nineStore'][_0xb62991(0x201)](),'text':_0x243973,'file':_0x13c7dc,'role':_0xb62991(0x1ad),'name':undefined,'usage':null,'parentMessageId':_0x2f8c0d,'conversationId':_0x1e404f===null||_0x1e404f===void 0x0?void 0x0:_0x1e404f['conversationId']};_0x38d978={'model':_0x114351,'parentMessageId':_0x2f8c0d},await this[_0xb62991(0x1ee)]['setData'](_0x343e88);const _0x2a05a9={'id':_0x1e404f['id'],'text':_0x1e404f[_0xb62991(0x219)],'role':_0xb62991(0x213),'name':undefined,'usage':_0x1e404f[_0xb62991(0x25d)],'parentMessageId':_0x343e88['id'],'conversationId':_0x1e404f===null||_0x1e404f===void 0x0?void 0x0:_0x1e404f[_0xb62991(0x271)]};await this['nineStore'][_0xb62991(0x22c)](_0x2a05a9),_0x38d978={'model':_0x114351,'parentMessageId':_0x343e88['id']};}else{const _0x263353=_0x243973,{context:_0xd7ddb4}=await this[_0xb62991(0x1ee)][_0xb62991(0x274)](_0x263353,{'parentMessageId':_0x2f8c0d,'systemMessage':_0x4c7a8b,'maxRounds':(0x0,helper_1[_0xb62991(0x224)])(_0x3cdd79)});_0x1e404f=await(0x0,openai_2[_0xb62991(0x2b7)])(_0xd7ddb4,{'apiKey':_0x59dbc4,'model':_0x114351,'temperature':_0x48f658,'proxyUrl':_0x1c4805,'onProgress':null});}const _0x569cba=await(0x0,helper_1[_0xb62991(0x297)])(_0x53773a,_0x1e404f,_0x38d978),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x569cba[_0xb62991(0x25d)];await this[_0xb62991(0x255)][_0xb62991(0x222)](_0x59868d['user']['id'],_0xb62991(0x1b3)+(_0x5d3139===0x1?0x3:0x4),_0x354569,total_tokens),await this[_0xb62991(0x2ad)][_0xb62991(0x1d7)](_0x11fa9e,_0x2659bd,total_tokens);const _0x467d71=(0x0,utils_1[_0xb62991(0x2aa)])(_0x59868d),_0x318432=await this[_0xb62991(0x1ea)]['saveChatLog']({'appId':_0xd94e46,'curIp':_0x467d71,'userId':_0x59868d[_0xb62991(0x1ad)]['id'],'type':balance_constant_1['DeductionKey'][_0xb62991(0x299)],'prompt':_0x243973,'answer':'','promptTokens':prompt_tokens,'completionTokens':0x0,'totalTokens':total_tokens,'model':(_0x569cba===null||_0x569cba===void 0x0?void 0x0:_0x569cba[_0xb62991(0x1b3)])||_0x114351,'role':_0xb62991(0x1ad),'groupId':_0x3af81e,'tts':tts,'file':_0x13c7dc,'requestOptions':JSON[_0xb62991(0x216)]({'options':null,'prompt':_0x243973})}),_0x51d050=await this[_0xb62991(0x1ea)][_0xb62991(0x1c9)]({'appId':_0xd94e46,'curIp':_0x467d71,'userId':_0x59868d['user']['id'],'type':balance_constant_1[_0xb62991(0x258)][_0xb62991(0x299)],'prompt':_0x243973,'answer':_0x569cba===null||_0x569cba===void 0x0?void 0x0:_0x569cba[_0xb62991(0x219)],'promptTokens':prompt_tokens,'completionTokens':completion_tokens,'totalTokens':total_tokens,'model':(_0x569cba===null||_0x569cba===void 0x0?void 0x0:_0x569cba[_0xb62991(0x1b3)])||_0x114351,'role':_0xb62991(0x213),'groupId':_0x3af81e,'requestOptions':JSON[_0xb62991(0x216)]({'options':{'model':_0x114351,'temperature':_0x48f658},'prompt':_0x243973}),'conversationOptions':JSON['stringify']({'conversationId':_0x1e404f['conversationId'],'model':_0x114351,'parentMessageId':_0x1e404f['id'],'temperature':_0x48f658})});common_1['Logger'][_0xb62991(0x20e)]('本次调用:\x20'+_0x59868d[_0xb62991(0x1ad)]['id']+_0xb62991(0x1cb)+_0x114351+_0xb62991(0x2bf)+_0x59dbc4+_0xb62991(0x211)+_0x266aac+_0xb62991(0x2be)+_0x4a36f5,'ChatgptService');const _0x4382a8=await this[_0xb62991(0x255)][_0xb62991(0x260)](_0x59868d['user']['id']);return _0x1e404f[_0xb62991(0x1ff)]=Object[_0xb62991(0x231)]({},_0x4382a8),_0x1e404f['chatId']=_0x51d050['id'],_0x1e404f[_0xb62991(0x1d2)]=_0x318432['id'],_0x1e404f[_0xb62991(0x245)]&&(_0x1e404f[_0xb62991(0x245)]=''),_0x1e404f[_0xb62991(0x2b0)]=!![],_0x4761f2?_0x4761f2['write']('\x0a'+JSON[_0xb62991(0x216)](_0x1e404f)):_0x1e404f[_0xb62991(0x219)];}catch(_0xa2bee2){console[_0xb62991(0x1a6)](_0xb62991(0x244),_0x59dbc4,_0xa2bee2);const _0x3b1aab=(_0xa2bee2===null||_0xa2bee2===void 0x0?void 0x0:_0xa2bee2[_0xb62991(0x2ba)])||0x190,_0x31bb91=((_0x402c1e=_0xa2bee2===null||_0xa2bee2===void 0x0?void 0x0:_0xa2bee2['response'])===null||_0x402c1e===void 0x0?void 0x0:_0x402c1e['status'])||(_0xa2bee2===null||_0xa2bee2===void 0x0?void 0x0:_0xa2bee2['statusCode'])||0x190;console['log'](_0xb62991(0x242),_0xb62991(0x23f),_0x3b1aab,'message',_0xa2bee2===null||_0xa2bee2===void 0x0?void 0x0:_0xa2bee2[_0xb62991(0x27f)],_0xb62991(0x1e1),(_0x5e9634=_0xa2bee2===null||_0xa2bee2===void 0x0?void 0x0:_0xa2bee2[_0xb62991(0x27d)])===null||_0x5e9634===void 0x0?void 0x0:_0x5e9634[_0xb62991(0x29b)],_0xb62991(0x23e),(_0x2fa8b8=_0xa2bee2===null||_0xa2bee2===void 0x0?void 0x0:_0xa2bee2['response'])===null||_0x2fa8b8===void 0x0?void 0x0:_0x2fa8b8[_0xb62991(0x23e)]);if(_0xa2bee2['status']&&_0xa2bee2[_0xb62991(0x23e)]===0x192){const _0xd9d2bc={'message':_0xb62991(0x26a)+_0xa2bee2['message'],'code':0x192};if(_0x4761f2)return _0x4761f2[_0xb62991(0x265)](JSON['stringify'](_0xd9d2bc));else throw new common_1[(_0xb62991(0x2c6))](_0xa2bee2[_0xb62991(0x27f)],common_1['HttpStatus'][_0xb62991(0x2a5)]);}if(!_0x31bb91){if(_0x4761f2)return _0x4761f2[_0xb62991(0x265)](JSON[_0xb62991(0x216)]({'message':_0xa2bee2[_0xb62991(0x27f)],'code':0x1f4}));else throw new common_1[(_0xb62991(0x2c6))](_0xa2bee2[_0xb62991(0x27f)],common_1[_0xb62991(0x2c7)]['BAD_REQUEST']);}let _0x45fda5=errorMessage_constant_1[_0xb62991(0x2c5)][_0x31bb91]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x31bb91]:_0xb62991(0x2a7);(_0xa2bee2===null||_0xa2bee2===void 0x0?void 0x0:_0xa2bee2[_0xb62991(0x27f)][_0xb62991(0x1d5)]('The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.'))&&Number(_0x53773a)===0x1&&(await this[_0xb62991(0x2ad)][_0xb62991(0x1e2)](_0x11fa9e,_0xb62991(0x1d8),-0x1),_0x45fda5='当前模型key已被封禁');(_0xa2bee2===null||_0xa2bee2===void 0x0?void 0x0:_0xa2bee2[_0xb62991(0x2ba)])===0x1ad&&_0xa2bee2['message']['includes'](_0xb62991(0x2c4))&&Number(_0x53773a)===0x1&&(await this['modelsService'][_0xb62991(0x1e2)](_0x11fa9e,_0xb62991(0x1d6),-0x3),_0x45fda5='当前模型key余额已耗尽');(_0xa2bee2===null||_0xa2bee2===void 0x0?void 0x0:_0xa2bee2[_0xb62991(0x2ba)])===0x1ad&&(_0xa2bee2===null||_0xa2bee2===void 0x0?void 0x0:_0xa2bee2[_0xb62991(0x29b)])===_0xb62991(0x237)&&(_0x45fda5=_0xb62991(0x2ab));(_0xa2bee2===null||_0xa2bee2===void 0x0?void 0x0:_0xa2bee2['statusCode'])===0x191&&_0xa2bee2['message'][_0xb62991(0x1d5)](_0xb62991(0x1b5))&&Number(_0x53773a)===0x1&&(await this['modelsService'][_0xb62991(0x1e2)](_0x11fa9e,_0xb62991(0x238),-0x2),_0x45fda5=_0xb62991(0x1ab));(_0xa2bee2===null||_0xa2bee2===void 0x0?void 0x0:_0xa2bee2['statusCode'])===0x194&&_0xa2bee2[_0xb62991(0x27f)]['includes'](_0xb62991(0x289))&&Number(_0x53773a)===0x1&&(await this[_0xb62991(0x2ad)][_0xb62991(0x1e2)](_0x11fa9e,'当前模型不是聊天模型',-0x4),_0x45fda5=_0xb62991(0x23a));_0x3b1aab===0x190&&console['log']('400\x20error',_0xa2bee2,_0xa2bee2['message']);const _0x2d43f7={'message':_0x45fda5||_0xb62991(0x286),'code':_0x3b1aab===0x191?0x190:_0x3b1aab||0x1f4};if(_0x4761f2)return _0x4761f2[_0xb62991(0x265)](JSON[_0xb62991(0x216)](_0x2d43f7));else throw new common_1[(_0xb62991(0x2c6))](_0x2d43f7[_0xb62991(0x27f)],common_1[_0xb62991(0x2c7)][_0xb62991(0x223)]);}finally{_0x4761f2&&_0x4761f2[_0xb62991(0x28d)]();}}async['draw'](_0xd8945d,_0x17db7d){const _0x18bfb6=_0x483a66;var _0x175abd,_0x328340,_0x3c0065,_0x247de7;await this[_0x18bfb6(0x1ce)]['checkBadWords'](_0xd8945d[_0x18bfb6(0x206)],_0x17db7d[_0x18bfb6(0x1ad)]['id']),await this[_0x18bfb6(0x21c)][_0x18bfb6(0x1fc)](_0x17db7d['user']);const _0xaa5c19=(_0xd8945d===null||_0xd8945d===void 0x0?void 0x0:_0xd8945d[_0x18bfb6(0x1c6)])==='hd'?0x4:0x2;await this[_0x18bfb6(0x255)][_0x18bfb6(0x1db)](_0x17db7d,'mjDraw',_0xaa5c19);let _0x30d8c4=[];const _0x31885d=await this[_0x18bfb6(0x2ad)][_0x18bfb6(0x2ae)]();if(!_0x31885d)throw new common_1[(_0x18bfb6(0x2c6))](_0x18bfb6(0x205),common_1[_0x18bfb6(0x2c7)][_0x18bfb6(0x223)]);const _0x5ad696=_0x31885d===null||_0x31885d===void 0x0?void 0x0:_0x31885d['id'],{key:_0x34f47a}=_0x31885d;let _0x8f713=_0x31885d[_0x18bfb6(0x259)];common_1['Logger']['log'](_0x18bfb6(0x22e)+_0xd8945d['prompt']+_0x18bfb6(0x1dc)+_0x34f47a,_0x18bfb6(0x291));try{_0x8f713['endsWith']('/')&&(_0x8f713=_0x8f713[_0x18bfb6(0x210)](0x0,_0x8f713[_0x18bfb6(0x1f1)]-0x1));const _0x2c1159=_0x8f713+_0x18bfb6(0x278),_0x22aa22=Object[_0x18bfb6(0x231)](Object['assign']({},_0xd8945d),{'model':_0x18bfb6(0x282)}),_0x4e31c3=await axios_1['default'][_0x18bfb6(0x29a)](_0x2c1159,Object[_0x18bfb6(0x231)](Object[_0x18bfb6(0x231)]({},_0x22aa22),{'response_format':_0x18bfb6(0x25b)}),{'headers':{'Authorization':_0x18bfb6(0x1eb)+_0x34f47a}});_0x30d8c4=_0x4e31c3[_0x18bfb6(0x1b0)][_0x18bfb6(0x1b0)];const _0x1e3b2f=[];for(const _0x28ba35 of _0x30d8c4){const _0xdd317b=uuid['v4']()[_0x18bfb6(0x210)](0x0,0xa)+'.png',_0x6cdfd8=Buffer[_0x18bfb6(0x1af)](_0x28ba35[_0x18bfb6(0x25b)],_0x18bfb6(0x27e));_0x1e3b2f[_0x18bfb6(0x280)](this['uploadService'][_0x18bfb6(0x22d)]({'filename':_0xdd317b,'buffer':_0x6cdfd8}));}const _0x235bbe=await Promise['all'](_0x1e3b2f);await this[_0x18bfb6(0x255)]['deductFromBalance'](_0x17db7d[_0x18bfb6(0x1ad)]['id'],_0x18bfb6(0x1cf),(_0x22aa22===null||_0x22aa22===void 0x0?void 0x0:_0x22aa22[_0x18bfb6(0x1c6)])===_0x18bfb6(0x1c4)?0x2:0x4,_0xaa5c19);const _0x1bf390=(0x0,utils_1[_0x18bfb6(0x2aa)])(_0x17db7d),_0x2d1279=[],_0x3f38b8=await this[_0x18bfb6(0x24f)][_0x18bfb6(0x23b)](),[_0x136696,_0x451de9]=_0xd8945d[_0x18bfb6(0x284)]['split']('x');return _0x235bbe[_0x18bfb6(0x249)](_0x74518a=>{const _0x2be542=_0x18bfb6;_0x2d1279[_0x2be542(0x280)](this[_0x2be542(0x1ea)][_0x2be542(0x1c9)]({'curIp':_0x1bf390,'userId':_0x17db7d['user']['id'],'type':balance_constant_1[_0x2be542(0x258)]['PAINT_TYPE'],'prompt':_0xd8945d['prompt'],'answer':_0x74518a,'fileInfo':JSON[_0x2be542(0x216)]({'cosType':_0x3f38b8,'width':_0x136696,'height':_0x451de9,'cosUrl':_0x74518a}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x2be542(0x282)}));}),await Promise['all'](_0x2d1279),_0x235bbe;}catch(_0x1f8498){console[_0x18bfb6(0x1a6)](_0x18bfb6(0x285),_0x1f8498);const _0x2dab3e=((_0x175abd=_0x1f8498===null||_0x1f8498===void 0x0?void 0x0:_0x1f8498[_0x18bfb6(0x27d)])===null||_0x175abd===void 0x0?void 0x0:_0x175abd[_0x18bfb6(0x23e)])||0x1f4,_0x263201=(_0x247de7=(_0x3c0065=(_0x328340=_0x1f8498===null||_0x1f8498===void 0x0?void 0x0:_0x1f8498[_0x18bfb6(0x27d)])===null||_0x328340===void 0x0?void 0x0:_0x328340['data'])===null||_0x3c0065===void 0x0?void 0x0:_0x3c0065[_0x18bfb6(0x21b)])===null||_0x247de7===void 0x0?void 0x0:_0x247de7[_0x18bfb6(0x27f)];if(_0x2dab3e===0x1ad)throw new common_1[(_0x18bfb6(0x2c6))]('当前请求已过载、请稍等会儿再试试吧！',common_1['HttpStatus']['BAD_REQUEST']);if(_0x2dab3e===0x190&&_0x263201[_0x18bfb6(0x1d5)](_0x18bfb6(0x1fb)))throw new common_1[(_0x18bfb6(0x2c6))](_0x18bfb6(0x262),common_1['HttpStatus'][_0x18bfb6(0x223)]);if(_0x2dab3e===0x190&&_0x263201[_0x18bfb6(0x1d5)](_0x18bfb6(0x20f))){await this[_0x18bfb6(0x2ad)]['lockKey'](_0x5ad696,_0x18bfb6(0x1d8),-0x1);throw new common_1['HttpException'](_0x18bfb6(0x2c1),common_1['HttpStatus'][_0x18bfb6(0x223)]);}if(_0x2dab3e===0x1f4)throw new common_1['HttpException']('当前配置模型可能不支持Dall-e-3模型、请检查！',common_1['HttpStatus']['BAD_REQUEST']);if(_0x2dab3e===0x191)throw new common_1[(_0x18bfb6(0x2c6))]('绘制图片失败，此次绘画被拒绝了！',common_1['HttpStatus'][_0x18bfb6(0x223)]);throw new common_1[(_0x18bfb6(0x2c6))](_0x18bfb6(0x1e6),common_1[_0x18bfb6(0x2c7)][_0x18bfb6(0x223)]);}}async[_0x483a66(0x1cd)](){const _0xe009ce=_0x483a66,_0x265acd=await this[_0xe009ce(0x2c3)][_0xe009ce(0x2a9)]({'where':{'status':0x1},'select':['id','key','weight',_0xe009ce(0x1b3),_0xe009ce(0x1be),'maxResponseTokens',_0xe009ce(0x2bb),_0xe009ce(0x2b5)]}),_0x5553e0=_0x265acd[_0xe009ce(0x1dd)](_0x2268e9=>_0x2268e9[_0xe009ce(0x1b3)][_0xe009ce(0x1d5)](_0xe009ce(0x241))),_0x3b9ffd=_0x265acd['filter'](_0x30933d=>_0x30933d['model'][_0xe009ce(0x1d5)](_0xe009ce(0x1fd)));this['keyPool']={'list3':_0x5553e0,'list4':_0x3b9ffd};}async[_0x483a66(0x24e)](_0x1751dc){const _0x419ae0=_0x483a66,_0xde36ec=await this[_0x419ae0(0x1ed)][_0x419ae0(0x270)]([_0x419ae0(0x209)]);return(_0x1751dc===null||_0x1751dc===void 0x0?void 0x0:_0x1751dc[_0x419ae0(0x259)])||_0xde36ec||_0x419ae0(0x2a8);}async[_0x483a66(0x1de)](_0x6a17a4){const _0x39213a=_0x483a66,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x39213a(0x1ed)][_0x39213a(0x270)](['openaiModel3MaxTokens',_0x39213a(0x225),_0x39213a(0x1e3),_0x39213a(0x232),'openaiModel4MaxTokens',_0x39213a(0x21d),'openaiModel4MaxTokens32k',_0x39213a(0x24b),_0x39213a(0x209)]);let _0x306df2=null,_0x26b892=null,_0x302844=null,{model:_0x2dc6a9,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x253152}=_0x6a17a4;return _0x2dc6a9['toLowerCase']()['includes']('gpt-4')&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x26b892>=0x1000&&(maxModelTokens=0x1000),_0x306df2=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x26b892=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x2dc6a9[_0x39213a(0x2af)]()[_0x39213a(0x1d5)](_0x39213a(0x25e))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x26b892>=0x4000&&(maxModelTokens=0x4000),_0x306df2=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x26b892=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x2dc6a9['toLowerCase']()[_0x39213a(0x1d5)](_0x39213a(0x2b3))&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x26b892>=0x1000&&(maxModelTokens=0x1000),_0x306df2=maxModelTokens||0x3ffc,_0x26b892=maxResponseTokens||0x1000)),_0x2dc6a9[_0x39213a(0x2af)]()[_0x39213a(0x1d5)]('gpt-3')&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x26b892>=0x7d0&&(maxModelTokens=0x7d0),_0x306df2=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x26b892=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x2dc6a9[_0x39213a(0x2af)]()[_0x39213a(0x1d5)](_0x39213a(0x1f6))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x26b892>=0x2000&&(maxModelTokens=0x2000),_0x306df2=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x26b892=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x2dc6a9['toLowerCase']()[_0x39213a(0x1d5)](_0x39213a(0x2b3))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x26b892>=0x1000&&(maxModelTokens=0x1000),_0x306df2=maxModelTokens||0x4000,_0x26b892=maxResponseTokens||0x1000)),_0x302844=proxyUrl||openaiBaseUrl||_0x39213a(0x2a8),_0x26b892>=_0x306df2&&(_0x26b892=Math['floor'](_0x306df2/0x2)),{'key':_0x253152,'maxToken':_0x306df2,'maxTokenRes':_0x26b892,'proxyResUrl':_0x302844};}async['setChatBoxType'](_0x59a113,_0x1480c9){const _0x2cfbae=_0x483a66;try{const {name:_0x24924a,icon:_0x2b7bdf,order:_0x3ff185,id:_0x38c16f,status:_0x3d84a8}=_0x1480c9;return _0x38c16f?await this['chatBoxTypeEntity'][_0x2cfbae(0x21e)]({'id':_0x38c16f},{'name':_0x24924a,'icon':_0x2b7bdf,'order':_0x3ff185,'status':_0x3d84a8}):await this['chatBoxTypeEntity'][_0x2cfbae(0x23c)]({'name':_0x24924a,'icon':_0x2b7bdf,'order':_0x3ff185,'status':_0x3d84a8});}catch(_0x53fced){console['log'](_0x2cfbae(0x285),_0x53fced);}}async[_0x483a66(0x1bb)](_0x38679d,_0x542e44){const _0x3db938=_0x483a66,{id:_0x3213c8}=_0x542e44;if(!_0x3213c8)throw new common_1[(_0x3db938(0x2c6))](_0x3db938(0x29e),common_1[_0x3db938(0x2c7)]['BAD_REQUEST']);const _0x5dc52a=await this[_0x3db938(0x1ba)][_0x3db938(0x1e8)]({'where':{'typeId':_0x3213c8}});if(_0x5dc52a)throw new common_1[(_0x3db938(0x2c6))](_0x3db938(0x287),common_1[_0x3db938(0x2c7)]['BAD_REQUEST']);return await this[_0x3db938(0x1a9)]['delete']({'id':_0x3213c8});}async[_0x483a66(0x1ca)](){const _0xb4f32d=_0x483a66;return await this['chatBoxTypeEntity'][_0xb4f32d(0x2a9)]({'order':{'order':_0xb4f32d(0x261)}});}async[_0x483a66(0x212)](_0x48d23f,_0x5eb5ab){const _0x1fb109=_0x483a66,{title:_0x4d36f4,prompt:_0x1a6953,appId:_0x1ffd52,order:_0x9acdd3,status:_0x4057a4,typeId:_0x355f05,id:_0x52549a,url:_0x56262d}=_0x5eb5ab;if(!_0x355f05)throw new common_1['HttpException'](_0x1fb109(0x1c1),common_1['HttpStatus'][_0x1fb109(0x223)]);try{const _0x260aaf={'title':_0x4d36f4,'order':_0x9acdd3,'status':_0x4057a4,'typeId':_0x355f05,'url':_0x56262d};return _0x260aaf[_0x1fb109(0x20a)]=_0x1ffd52||0x0,_0x260aaf[_0x1fb109(0x206)]=_0x1a6953||'',_0x52549a?await this['chatBoxEntity'][_0x1fb109(0x21e)]({'id':_0x52549a},_0x260aaf):await this['chatBoxEntity'][_0x1fb109(0x23c)](_0x260aaf);}catch(_0x5e232c){console['log'](_0x1fb109(0x285),_0x5e232c);}}async['delChatBox'](_0x3c2f4e,_0x340fda){const _0x442a6b=_0x483a66,{id:_0x1186aa}=_0x340fda;if(!_0x1186aa)throw new common_1[(_0x442a6b(0x2c6))](_0x442a6b(0x29e),common_1['HttpStatus'][_0x442a6b(0x223)]);return await this['chatBoxEntity'][_0x442a6b(0x235)]({'id':_0x1186aa});}async['queryChatBox'](){const _0x1da887=_0x483a66,_0x1b41a0=await this[_0x1da887(0x1ba)][_0x1da887(0x2a9)]({'order':{'order':_0x1da887(0x261)}}),_0x5a9e83=[...new Set(_0x1b41a0['map'](_0x3d13c5=>_0x3d13c5[_0x1da887(0x24a)]))],_0xc5a0bc=[...new Set(_0x1b41a0[_0x1da887(0x1f0)](_0x163520=>_0x163520[_0x1da887(0x20a)]))],_0x23f1b9=await this[_0x1da887(0x1a9)][_0x1da887(0x2a9)]({'where':{'id':(0x0,typeorm_1['In'])(_0x5a9e83)}}),_0x328fea=await this[_0x1da887(0x2a3)][_0x1da887(0x2a9)]({'where':{'id':(0x0,typeorm_1['In'])(_0xc5a0bc)}});return _0x1b41a0[_0x1da887(0x1f0)](_0x3f9fbb=>{const _0x53efed=_0x1da887,{typeId:_0x7a5e5f,appId:_0x583eb8}=_0x3f9fbb;return _0x3f9fbb[_0x53efed(0x1b6)]=_0x23f1b9[_0x53efed(0x2a9)](_0x9a9493=>_0x9a9493['id']===_0x7a5e5f),_0x3f9fbb[_0x53efed(0x275)]=_0x328fea[_0x53efed(0x2a9)](_0x268b8e=>_0x268b8e['id']===_0x583eb8),_0x3f9fbb;});}async[_0x483a66(0x22b)](){const _0x46054d=_0x483a66,_0x5ea61b=await this[_0x46054d(0x1a9)][_0x46054d(0x2a9)]({'order':{'order':_0x46054d(0x261)},'where':{'status':!![]}}),_0x4eefca=await this[_0x46054d(0x1ba)]['find']({'where':{'status':!![]}}),_0x3a39f4=[...new Set(_0x4eefca[_0x46054d(0x1f0)](_0x35b5e1=>_0x35b5e1[_0x46054d(0x20a)]))],_0x1e6b89=await this[_0x46054d(0x2a3)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x3a39f4)}});return _0x4eefca[_0x46054d(0x249)](_0x2ce535=>{const _0x25135c=_0x46054d,_0x4f90ae=_0x1e6b89['find'](_0x210137=>_0x210137['id']===_0x2ce535[_0x25135c(0x20a)]);return _0x2ce535[_0x25135c(0x26f)]=_0x4f90ae===null||_0x4f90ae===void 0x0?void 0x0:_0x4f90ae[_0x25135c(0x26f)],_0x2ce535;}),_0x5ea61b[_0x46054d(0x1f0)](_0x278ac5=>{const _0x6f1a7f=_0x46054d;return _0x278ac5[_0x6f1a7f(0x1ac)]=_0x4eefca['filter'](_0x4e4956=>_0x4e4956[_0x6f1a7f(0x24a)]===_0x278ac5['id']&&_0x4e4956['status']),_0x278ac5;});}async[_0x483a66(0x2b1)](_0x197880,_0x43fe76){const _0x5ac07f=_0x483a66;try{const {name:_0x5eab6e,icon:_0x25191e,order:_0x243744,id:_0x411858,status:_0x28f70d}=_0x43fe76;return _0x411858?await this['chatPreTypeEntity'][_0x5ac07f(0x21e)]({'id':_0x411858},{'name':_0x5eab6e,'icon':_0x25191e,'order':_0x243744,'status':_0x28f70d}):await this[_0x5ac07f(0x1b8)][_0x5ac07f(0x23c)]({'name':_0x5eab6e,'icon':_0x25191e,'order':_0x243744,'status':_0x28f70d});}catch(_0x51479d){console['log'](_0x5ac07f(0x285),_0x51479d);}}async[_0x483a66(0x28b)](_0x14386e,_0x26a1e1){const _0x214049=_0x483a66,{id:_0x47f1eb}=_0x26a1e1;if(!_0x47f1eb)throw new common_1['HttpException'](_0x214049(0x29e),common_1[_0x214049(0x2c7)][_0x214049(0x223)]);const _0x3863c5=await this[_0x214049(0x1ba)][_0x214049(0x1e8)]({'where':{'typeId':_0x47f1eb}});if(_0x3863c5)throw new common_1['HttpException']('当前分类下有未处理数据不可移除！',common_1[_0x214049(0x2c7)][_0x214049(0x223)]);return await this[_0x214049(0x1b8)][_0x214049(0x235)]({'id':_0x47f1eb});}async[_0x483a66(0x28f)](){const _0x39261d=_0x483a66;return await this['chatPreTypeEntity'][_0x39261d(0x2a9)]({'order':{'order':'DESC'}});}async[_0x483a66(0x1cc)](_0x3eb5c1,_0x5ef393){const _0x298e23=_0x483a66,{title:_0x1923dc,prompt:_0x2563e7,appId:_0x1d7589,order:_0x179267,status:_0x21895d,typeId:_0x3bc714,id:_0x1dab2b,url:_0xfac783}=_0x5ef393;if(!_0x3bc714)throw new common_1[(_0x298e23(0x2c6))]('缺失必要参数！',common_1[_0x298e23(0x2c7)]['BAD_REQUEST']);try{const _0x26ce61={'title':_0x1923dc,'prompt':_0x2563e7,'order':_0x179267,'status':_0x21895d,'typeId':_0x3bc714,'url':_0xfac783};return _0x1dab2b?await this[_0x298e23(0x273)][_0x298e23(0x21e)]({'id':_0x1dab2b},_0x26ce61):await this[_0x298e23(0x273)][_0x298e23(0x23c)](_0x26ce61);}catch(_0x93204e){console[_0x298e23(0x1a6)](_0x298e23(0x285),_0x93204e);}}async[_0x483a66(0x292)](_0x3369e5,_0x3fbf7a){const _0x2f3f19=_0x483a66,{id:_0xd0b28a}=_0x3fbf7a;if(!_0xd0b28a)throw new common_1['HttpException'](_0x2f3f19(0x29e),common_1[_0x2f3f19(0x2c7)][_0x2f3f19(0x223)]);return await this[_0x2f3f19(0x273)][_0x2f3f19(0x235)]({'id':_0xd0b28a});}async[_0x483a66(0x1a8)](){const _0x5ed189=_0x483a66,_0x59014c=await this['chatPreEntity'][_0x5ed189(0x2a9)]({'order':{'order':_0x5ed189(0x261)}}),_0x4e145c=[...new Set(_0x59014c[_0x5ed189(0x1f0)](_0x28d49e=>_0x28d49e[_0x5ed189(0x24a)]))],_0x5d491e=await this['chatPreTypeEntity'][_0x5ed189(0x2a9)]({'where':{'id':(0x0,typeorm_1['In'])(_0x4e145c)}});return _0x59014c['map'](_0x294594=>{const _0x37d6d8=_0x5ed189,{typeId:_0x2df147,appId:_0x5ed279}=_0x294594;return _0x294594[_0x37d6d8(0x1b6)]=_0x5d491e['find'](_0x2f4298=>_0x2f4298['id']===_0x2df147),_0x294594;});}async[_0x483a66(0x1c0)](){const _0x2ae944=_0x483a66,_0x13c151=await this[_0x2ae944(0x1b8)][_0x2ae944(0x2a9)]({'order':{'order':'DESC'},'where':{'status':!![]}}),_0xf94b9f=await this[_0x2ae944(0x273)][_0x2ae944(0x2a9)]({'where':{'status':!![]}});return _0x13c151[_0x2ae944(0x1f0)](_0x55b41c=>{const _0x2b1743=_0x2ae944;return _0x55b41c[_0x2b1743(0x1ac)]=_0xf94b9f[_0x2b1743(0x1dd)](_0x358d0a=>_0x358d0a['typeId']===_0x55b41c['id']&&_0x358d0a[_0x2b1743(0x23e)]),_0x55b41c;});}async[_0x483a66(0x1df)](_0x58c9c1,_0x356e5c,_0x2a33fb){const _0x43978e=_0x483a66;let _0x17a82b=0x1000,_0x419108=0x800;return _0x58c9c1[_0x43978e(0x2af)]()[_0x43978e(0x1d5)](_0x43978e(0x1fd))&&(_0x17a82b=_0x356e5c>=0x2004?0x2004:_0x356e5c,_0x419108=_0x2a33fb>=0x1000?0x1000:_0x2a33fb,_0x58c9c1[_0x43978e(0x2af)]()[_0x43978e(0x1d5)](_0x43978e(0x25e))&&(_0x17a82b=_0x356e5c>=0x8000?0x8000:_0x356e5c,_0x419108=_0x2a33fb>=0x3e80?0x3e80:_0x2a33fb),(_0x58c9c1[_0x43978e(0x2af)]()[_0x43978e(0x1d5)]('gpt-4-1106')||_0x58c9c1[_0x43978e(0x2af)]()['includes']('gpt-4-vision-preview'))&&(_0x17a82b=_0x356e5c>=0x1f400?0x1f400:_0x356e5c,_0x419108=_0x2a33fb>=0x1000?0x1000:_0x2a33fb)),_0x58c9c1[_0x43978e(0x2af)]()[_0x43978e(0x1d5)](_0x43978e(0x241))&&(_0x17a82b=_0x356e5c>=0x1000?0x1000:_0x356e5c,_0x419108=_0x2a33fb>=0x800?0x800:_0x2a33fb,_0x58c9c1['toLowerCase']()[_0x43978e(0x1d5)](_0x43978e(0x1f6))&&(_0x17a82b=_0x356e5c>=0x4000?0x4000:_0x356e5c,_0x419108=_0x2a33fb>=0x1f40?0x1f40:_0x2a33fb),_0x58c9c1[_0x43978e(0x2af)]()['includes']('1106')&&(_0x17a82b=_0x356e5c>=0x4000?0x4000:_0x356e5c,_0x419108=_0x2a33fb>=0x1f40?0x1f40:_0x2a33fb)),{'maxToken':_0x17a82b,'maxRes':_0x419108};}};ChatgptService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x483a66(0x29c)])(gptkeys_entity_1['GptKeysEntity'])),__param(0x1,(0x0,typeorm_2[_0x483a66(0x29c)])(config_entity_1[_0x483a66(0x1da)])),__param(0x2,(0x0,typeorm_2['InjectRepository'])(chatBoxType_entity_1[_0x483a66(0x1d0)])),__param(0x3,(0x0,typeorm_2['InjectRepository'])(chatBox_entity_1[_0x483a66(0x281)])),__param(0x4,(0x0,typeorm_2[_0x483a66(0x29c)])(app_entity_1['AppEntity'])),__param(0x5,(0x0,typeorm_2[_0x483a66(0x29c)])(chatPreType_entity_1[_0x483a66(0x239)])),__param(0x6,(0x0,typeorm_2[_0x483a66(0x29c)])(chatPre_entity_1[_0x483a66(0x27b)])),__metadata('design:paramtypes',[typeorm_1[_0x483a66(0x229)],typeorm_1[_0x483a66(0x229)],typeorm_1[_0x483a66(0x229)],typeorm_1[_0x483a66(0x229)],typeorm_1[_0x483a66(0x229)],typeorm_1[_0x483a66(0x229)],typeorm_1['Repository'],nestjs_config_1['ConfigService'],userBalance_service_1[_0x483a66(0x1b4)],chatLog_service_1['ChatLogService'],user_service_1[_0x483a66(0x1ec)],upload_service_1[_0x483a66(0x1e5)],badwords_service_1[_0x483a66(0x28a)],autoreply_service_1[_0x483a66(0x266)],globalConfig_service_1[_0x483a66(0x1f3)],fanyi_service_1['FanyiService'],chatGroup_service_1[_0x483a66(0x207)],models_service_1[_0x483a66(0x200)]])],ChatgptService),exports['ChatgptService']=ChatgptService;