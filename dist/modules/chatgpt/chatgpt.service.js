'use strict';const _0x56780d=_0x57db;function _0x57db(_0x24e9e7,_0xd63e72){const _0x150f95=_0x150f();return _0x57db=function(_0x57db82,_0x14ae3e){_0x57db82=_0x57db82-0x117;let _0x472477=_0x150f95[_0x57db82];return _0x472477;},_0x57db(_0x24e9e7,_0xd63e72);}(function(_0x39e0e0,_0xdc1a0d){const _0x18d3b3=_0x57db,_0x52180c=_0x39e0e0();while(!![]){try{const _0x5a5e60=parseInt(_0x18d3b3(0x11c))/0x1*(-parseInt(_0x18d3b3(0x1dd))/0x2)+parseInt(_0x18d3b3(0x1d9))/0x3+-parseInt(_0x18d3b3(0x1b9))/0x4+-parseInt(_0x18d3b3(0x232))/0x5*(-parseInt(_0x18d3b3(0x1e2))/0x6)+parseInt(_0x18d3b3(0x1b5))/0x7+parseInt(_0x18d3b3(0x1f7))/0x8*(parseInt(_0x18d3b3(0x13f))/0x9)+-parseInt(_0x18d3b3(0x244))/0xa;if(_0x5a5e60===_0xdc1a0d)break;else _0x52180c['push'](_0x52180c['shift']());}catch(_0x17d896){_0x52180c['push'](_0x52180c['shift']());}}}(_0x150f,0x35083));var __decorate=this&&this[_0x56780d(0x1ef)]||function(_0x4a451f,_0x51d521,_0x2e0cdc,_0xdd337c){const _0x305d64=_0x56780d;var _0x2df359=arguments['length'],_0x94ad05=_0x2df359<0x3?_0x51d521:_0xdd337c===null?_0xdd337c=Object['getOwnPropertyDescriptor'](_0x51d521,_0x2e0cdc):_0xdd337c,_0x18f284;if(typeof Reflect===_0x305d64(0x19c)&&typeof Reflect['decorate']==='function')_0x94ad05=Reflect[_0x305d64(0x198)](_0x4a451f,_0x51d521,_0x2e0cdc,_0xdd337c);else{for(var _0x19e6a6=_0x4a451f[_0x305d64(0x1a5)]-0x1;_0x19e6a6>=0x0;_0x19e6a6--)if(_0x18f284=_0x4a451f[_0x19e6a6])_0x94ad05=(_0x2df359<0x3?_0x18f284(_0x94ad05):_0x2df359>0x3?_0x18f284(_0x51d521,_0x2e0cdc,_0x94ad05):_0x18f284(_0x51d521,_0x2e0cdc))||_0x94ad05;}return _0x2df359>0x3&&_0x94ad05&&Object[_0x305d64(0x1a4)](_0x51d521,_0x2e0cdc,_0x94ad05),_0x94ad05;},__metadata=this&&this[_0x56780d(0x1d7)]||function(_0x46eacd,_0x45b22b){const _0x55438a=_0x56780d;if(typeof Reflect==='object'&&typeof Reflect[_0x55438a(0x19b)]===_0x55438a(0x1c1))return Reflect[_0x55438a(0x19b)](_0x46eacd,_0x45b22b);},__param=this&&this[_0x56780d(0x176)]||function(_0x4fd4f9,_0x56a4c8){return function(_0x48d977,_0x38f7a8){_0x56a4c8(_0x48d977,_0x38f7a8,_0x4fd4f9);};};Object[_0x56780d(0x1a4)](exports,_0x56780d(0x128),{'value':!![]}),exports[_0x56780d(0x219)]=void 0x0;function _0x150f(){const _0x31617c=['close','../../common/utils','32k','chatId','DrawService','assign','genPluginSystemMessage','Billing\x20hard\x20limit\x20has\x20been\x20reached','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','./store','HttpStatus','本次调用:\x20','getTtsModelKey','__param','whisper-1','modelConfig','removeSpecialCharacters','globalConfigService','create','mjDraw','Bearer\x20','userBalanceService','chatTextToSpeech','checkBadWords','push','语音转文字识别失败、请稍后试试吧！','modelsService','statusText','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','ChatGroupService','ChatLogService','当前应用使用的模型已被管理员下架、请联系管理员上架此模型！','config','badwordsService','Incorrect\x20API\x20key\x20provided','AppEntity','redis://','gpt-4','UploadService','debug','proxyUrl','chatLogService','缺失必要参数！','getMaxTokenFromModelWithOpenAi','usage','env','REDIS_USER','decorate','split','realTimeTextToSpeechChat','metadata','object','../fanyi/fanyi.service','findOne','chatSpeechToText','map','../models/models.service','model','当前语音转文字模型暂未上架、请联系管理员上架此模型！','defineProperty','length','billing','当前模型调用过于频繁、请重新试试吧！','configEntity','getGroupInfoFromId','join','../userBalance/userBalance.service','Catch\x20Error\x20','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！',',\x20模型名称:\x20','getUploadType','system','end','typeInfo','.png','@nestjs/common','995841gLZHnq','url','key:\x20','size','725564OJQIvc','当前配置模型可能不支持Dall-e-3模型、请检查！','application/octet-stream;\x20charset=utf-8','abortController','replace','DeductionKey','result','abort','function','uploadFile','chatgpt-nine-ai','getDeductTypeMap','提供了错误的模型秘钥','lockKey','chatBoxEntity','openai','ConfigService','from','GptKeysEntity','forEach','Please\x20check\x20the\x20back-end\x20console','transcriptions','queryChatBox','../../common/constants/verification.constant','statusCode','语音转文字内容:\x20','prevChatId','nestjs-config','count','delChatBox','__metadata','write','896808KBMkuO','keyPool','POST','pipe','5266iymshg','validateBalance','getUseDrawModelKey','当前模型不是聊天模型','buildMessageFromParentMessageId','6fOhQbD','getModelProxyUrl','GlobalConfigService','choices','ChatPreEntity','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','userBanance','ModelsService','appEntity','getModelTypeDetailFromId','setChatBox','./baidu','uuid','__decorate','toISOString','fanyiService','application/json','default','speech','childList','语音转文字失败、请稍后试试吧！','2432TktTpv','REDIS_PASSWORD','realTimeTextToSpeech','../badwords/badwords.service','keyv','setChatPre','maxModelTokens','parse','ChatPreTypeEntity','configService','typeId','design:paramtypes','weight','InjectRepository','./zhipu','Injectable','PAYMENT_REQUIRED','audio','sendMessageFromZhipu','当前模型key余额已耗尽',',\x20key\x20===>\x20','./helper','../chatGroup/chatGroup.service','400\x20error','请输入对话内容','REDIS_PORT','chatPreEntity','importDynamic','Content-type','error:\x20','all','slice','当前分类下有未处理数据不可移除！','Too\x20Many\x20Requests','ChatgptService','unifiedFormattingResponse','includes','chat','saveUseLog','uploadService','assistant','quality','chatPreTypeEntity','filter','ChatBoxTypeEntity','../../public','queryChatBoxType','deductFromBalance','@keyv/redis','../chatLog/chatLog.service','getUuid','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','queryChatBoxFrontend','dall-e-3','appInfo','appId','toLowerCase','typeorm','tts-1','1374785tHOLIk','setData','绘制图片失败，请稍后试试吧！','Logger','delete','./gptkeys.entity','getConfigs','post','queryUserBalance','BAD_REQUEST','请添加一个系统内置工具模型用于翻译优化！','delChatPreType','queryChatPre','find','addOneIfOdd','CHAT_TYPE','../app/app.entity','message','1400690gnadQD','content','gpt-3.5-turbo','16k','Repository','./chatBox.entity','DESC','157ygIXir','standard','../../common/constants/balance.constant','prompt','userService','draw','PAINT_TYPE','pluginId','checkUserStatus','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','非法操作！','\x0a\x20Current\x20date:\x20','__esModule','save','FanyiService','UserService','getClientIp','conversationId','error','HttpException','is_end','messages','../globalConfig/config.entity','nineStore','modelTypeId','chatProcess','sendMessageFromOpenAi','key','extractFilePath','text','openaiProxyUrl','getUseToolsModelKey','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','gpt-4-vision-preview','getTokenCount','6984upgvJR','./chatPre.entity','data','gptKeysEntity','https://api.openai.com','axios','queryChatPreList','getCurrentModelKeyInfo','当前模型key已被封禁','setChatPreType','systemPreMessage','saveChatLog','OpenAiErrorCodeMessage','endsWith','/v1/images/generations','fable','error-----:\x20','status','user','chatGlobaltools','chatGroupService','chatBoxTypeEntity','gpt-4-1106','autoreplyService','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！',',\x20最大回复token:\x20','NineStore','getChatInfoFromId','\x20model:\x20','/v1','log','当前流程所需要的模型已被管理员下架、请联系管理员上架此模型或更换其他模型使用！','update','coverImg','stringify','UserBalanceService','response','ChatBoxEntity','body','unshift','openaiTimeoutMs','./chatBoxType.entity'];_0x150f=function(){return _0x31617c;};return _0x150f();}const upload_service_1=require('./../upload/upload.service'),user_service_1=require('./../user/user.service'),nestjs_config_1=require(_0x56780d(0x1d4)),common_1=require(_0x56780d(0x1b4)),errorMessage_constant_1=require('../../common/constants/errorMessage.constant'),openai_1=require(_0x56780d(0x1c8)),utils_1=require(_0x56780d(0x16a)),axios_1=require(_0x56780d(0x144)),userBalance_service_1=require(_0x56780d(0x1ab)),balance_constant_1=require(_0x56780d(0x11e)),chatLog_service_1=require(_0x56780d(0x228)),uuid=require(_0x56780d(0x1ee)),config_entity_1=require(_0x56780d(0x132)),typeorm_1=require(_0x56780d(0x230)),typeorm_2=require('@nestjs/typeorm'),badwords_service_1=require(_0x56780d(0x1fa)),autoreply_service_1=require('../autoreply/autoreply.service'),gptkeys_entity_1=require(_0x56780d(0x237)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),fanyi_service_1=require(_0x56780d(0x19d)),app_entity_1=require(_0x56780d(0x242)),chatGroup_service_1=require(_0x56780d(0x20d)),models_service_1=require(_0x56780d(0x1a1)),baidu_1=require(_0x56780d(0x1ed)),helper_1=require(_0x56780d(0x20c)),store_1=require(_0x56780d(0x172)),zhipu_1=require(_0x56780d(0x205)),openai_2=require('./openai'),chatBoxType_entity_1=require(_0x56780d(0x168)),chatBox_entity_1=require(_0x56780d(0x11a)),chatPre_entity_1=require(_0x56780d(0x140)),chatPreType_entity_1=require('./chatPreType.entity'),fs=require('fs'),path_1=require('path'),verification_constant_1=require(_0x56780d(0x1d0));let ChatgptService=class ChatgptService{constructor(_0x244bd5,_0x362657,_0x127c2a,_0x27816d,_0x4d4b7f,_0x3759f3,_0x562da5,_0x375575,_0x4d1296,_0x466d23,_0x128a56,_0x353925,_0x25ddb3,_0x5505ca,_0x5e7075,_0x11cd64,_0x2ae2ee,_0x362785){const _0x2e59d9=_0x56780d;this[_0x2e59d9(0x142)]=_0x244bd5,this[_0x2e59d9(0x1a8)]=_0x362657,this[_0x2e59d9(0x154)]=_0x127c2a,this['chatBoxEntity']=_0x27816d,this[_0x2e59d9(0x1ea)]=_0x4d4b7f,this[_0x2e59d9(0x221)]=_0x3759f3,this[_0x2e59d9(0x211)]=_0x562da5,this[_0x2e59d9(0x200)]=_0x375575,this[_0x2e59d9(0x17e)]=_0x4d1296,this['chatLogService']=_0x466d23,this[_0x2e59d9(0x120)]=_0x128a56,this['uploadService']=_0x353925,this['badwordsService']=_0x25ddb3,this['autoreplyService']=_0x5505ca,this[_0x2e59d9(0x17a)]=_0x5e7075,this[_0x2e59d9(0x1f1)]=_0x11cd64,this[_0x2e59d9(0x153)]=_0x2ae2ee,this[_0x2e59d9(0x183)]=_0x362785,this['nineStore']=null,this['whiteListUser']=[],this['keyPool']={'list3':[],'list4':[]};}async['onModuleInit'](){const _0x2ba10e=_0x56780d;let _0xc57281=await(0x0,utils_1[_0x2ba10e(0x212)])(_0x2ba10e(0x1c3)),_0x2839cd=await(0x0,utils_1[_0x2ba10e(0x212)])(_0x2ba10e(0x227)),_0x1231f2=await(0x0,utils_1[_0x2ba10e(0x212)])(_0x2ba10e(0x1fb));_0xc57281=(_0xc57281===null||_0xc57281===void 0x0?void 0x0:_0xc57281[_0x2ba10e(0x1f3)])?_0xc57281[_0x2ba10e(0x1f3)]:_0xc57281,_0x2839cd=(_0x2839cd===null||_0x2839cd===void 0x0?void 0x0:_0x2839cd['default'])?_0x2839cd[_0x2ba10e(0x1f3)]:_0x2839cd,_0x1231f2=(_0x1231f2===null||_0x1231f2===void 0x0?void 0x0:_0x1231f2[_0x2ba10e(0x1f3)])?_0x1231f2['default']:_0x1231f2;const {ChatGPTAPI:_0x30ceb5,ChatGPTError:_0xc0c90f,ChatGPTUnofficialProxyAPI:_0x213317}=_0xc57281,_0x5c14fc=+process[_0x2ba10e(0x196)][_0x2ba10e(0x210)],_0x49cfa5=process[_0x2ba10e(0x196)]['REDIS_HOST'],_0x3ced39=process[_0x2ba10e(0x196)][_0x2ba10e(0x1f8)],_0xf3a9f7=process[_0x2ba10e(0x196)][_0x2ba10e(0x197)],_0x7c7d21=_0x2ba10e(0x18d)+(_0xf3a9f7||'')+':'+(_0x3ced39||'')+'@'+_0x49cfa5+':'+_0x5c14fc,_0x7e8cef=new _0x2839cd(_0x7c7d21),_0x22fe69=new _0x1231f2({'store':_0x7e8cef,'namespace':'nineai-chatlog'});this['nineStore']=new store_1[(_0x2ba10e(0x159))]({'store':_0x22fe69,'namespace':_0x2ba10e(0x21c)});}async['chatSyncFree'](_0x53691f){const _0x48c86b=_0x56780d,_0x12fbd0=await this[_0x48c86b(0x183)]['getDefaultModel']();if(!_0x12fbd0)return;const {model:_0x46f173,maxTokens:_0x7759fa}=_0x12fbd0,_0x2c890a=await this['modelsService'][_0x48c86b(0x146)](_0x12fbd0['id']);if(!_0x2c890a)return;const _0x1ef720=await this[_0x48c86b(0x17a)][_0x48c86b(0x238)]([_0x48c86b(0x149)]),{key:_0x155e5a,proxyUrl:_0x19127f}=_0x2c890a,{context:_0x15ee29}=await this[_0x48c86b(0x133)]['buildMessageFromParentMessageId'](_0x53691f,{'parentMessageId':'','systemMessage':_0x1ef720});try{const _0x1b5e43=await(0x0,openai_2['sendMessageFromOpenAi'])(_0x15ee29,{'apiKey':(0x0,utils_1[_0x48c86b(0x179)])(_0x155e5a),'model':_0x46f173,'proxyUrl':_0x19127f,'maxToken':_0x7759fa,'onProgress':null});return _0x1b5e43===null||_0x1b5e43===void 0x0?void 0x0:_0x1b5e43[_0x48c86b(0x139)];}catch(_0x23968b){console['log']('error:\x20',_0x23968b);}}['extractFilePath'](_0x3971ae){const _0x4054eb=new URL(_0x3971ae);return _0x4054eb['pathname'];}async[_0x56780d(0x152)](_0x218bb0){const _0x296178=_0x56780d;var _0x45f56c;try{const _0x2490e2=await this[_0x296178(0x183)][_0x296178(0x13b)]();if(!_0x2490e2)throw new common_1[(_0x296178(0x12f))](_0x296178(0x23c),common_1[_0x296178(0x173)]['BAD_REQUEST']);const {key:_0x154f39,proxyUrl:_0x1f9f6b}=_0x2490e2,{systemMessage:_0x59eecc,prompt:_0x40efbd}=_0x218bb0,_0x35e741={'method':_0x296178(0x1db),'url':(0x0,openai_2['getFullUrl'])(_0x1f9f6b),'headers':{'Content-Type':_0x296178(0x1f2),'Authorization':_0x296178(0x17d)+(0x0,utils_1[_0x296178(0x179)])(_0x154f39)},'data':{'max_tokens':0xbb8,'model':_0x296178(0x117),'messages':[{'role':_0x296178(0x151),'content':_0x40efbd}]}};_0x59eecc&&_0x35e741['data'][_0x296178(0x131)][_0x296178(0x166)]({'role':_0x296178(0x1b0),'content':_0x59eecc});const _0x31c8a7=await(0x0,axios_1[_0x296178(0x1f3)])(_0x35e741);return((_0x45f56c=_0x31c8a7===null||_0x31c8a7===void 0x0?void 0x0:_0x31c8a7[_0x296178(0x141)])===null||_0x45f56c===void 0x0?void 0x0:_0x45f56c[_0x296178(0x1e5)][0x0][_0x296178(0x243)][_0x296178(0x245)])||_0x40efbd;}catch(_0x5becd1){return console[_0x296178(0x15d)]('chatGlobaltools\x20\x20-->\x20error:\x20',_0x5becd1),prompt;}}async[_0x56780d(0x19f)](_0x35733b){const _0x58d061=_0x56780d,_0x195486=await this['modelsService'][_0x58d061(0x175)]();if(!_0x195486)throw new common_1[(_0x58d061(0x12f))](_0x58d061(0x1a3),common_1['HttpStatus']['BAD_REQUEST']);const {key:_0x2230c9,proxyUrl:_0x16fcb5}=_0x195486,_0x542aab=_0x16fcb5['endsWith']('/')?_0x16fcb5+'v1':_0x16fcb5+'/v1',_0x247fcb=new openai_1[(_0x58d061(0x1f3))]({'baseURL':_0x542aab,'apiKey':_0x2230c9}),_0x152644=this[_0x58d061(0x138)](_0x35733b),_0x402445=(0x0,path_1[_0x58d061(0x1aa)])(__dirname,_0x58d061(0x224),_0x152644)['replace']('/dist',''),_0x418c88=await _0x247fcb[_0x58d061(0x208)][_0x58d061(0x1ce)]['create']({'model':_0x58d061(0x177),'prompt':'请将语言转为中文简体','file':fs['createReadStream'](_0x402445)});return console['log'](_0x58d061(0x1d2),_0x418c88===null||_0x418c88===void 0x0?void 0x0:_0x418c88[_0x58d061(0x139)]),this[_0x58d061(0x183)][_0x58d061(0x21d)](_0x195486===null||_0x195486===void 0x0?void 0x0:_0x195486['id'],_0x195486===null||_0x195486===void 0x0?void 0x0:_0x195486[_0x58d061(0x134)],0x0),(_0x418c88===null||_0x418c88===void 0x0?void 0x0:_0x418c88[_0x58d061(0x139)])||null;}async['chatRealTimeTextToSpeech'](_0x1c7452,_0x2ccaeb,_0x466881){const _0x5c5683=_0x56780d,{name:name=_0x5c5683(0x14e),text:text=''}=_0x466881;try{const _0x15e5b6=await this['modelsService']['getTtsModelKey']();if(!_0x15e5b6)throw new common_1[(_0x5c5683(0x12f))](_0x5c5683(0x1a3),common_1[_0x5c5683(0x173)][_0x5c5683(0x23b)]);const {key:_0x559bb2,proxyUrl:_0x43a07e}=_0x15e5b6,_0x113062=_0x43a07e[_0x5c5683(0x14c)]('/')?_0x43a07e+'v1':_0x43a07e+_0x5c5683(0x15c),_0x4e2d10=new openai_1[(_0x5c5683(0x1f3))]({'baseURL':_0x113062,'apiKey':_0x559bb2}),_0x1fe6cf=await _0x4e2d10[_0x5c5683(0x208)][_0x5c5683(0x1f4)][_0x5c5683(0x17b)]({'model':_0x5c5683(0x231),'voice':name,'input':text});this[_0x5c5683(0x183)][_0x5c5683(0x21d)](_0x15e5b6===null||_0x15e5b6===void 0x0?void 0x0:_0x15e5b6['id'],_0x15e5b6===null||_0x15e5b6===void 0x0?void 0x0:_0x15e5b6[_0x5c5683(0x134)],0x0),_0x1fe6cf[_0x5c5683(0x165)][_0x5c5683(0x1dc)](_0x1c7452);}catch(_0x36ad1d){console[_0x5c5683(0x15d)](_0x5c5683(0x214),_0x36ad1d);throw new common_1[(_0x5c5683(0x12f))](_0x5c5683(0x1f6),common_1[_0x5c5683(0x173)][_0x5c5683(0x23b)]);}}async[_0x56780d(0x19a)](_0x4ad6cd,_0x16d1a5){const _0x543ee1=_0x56780d,{id:_0x24dbf7,voiceType:_0x2b0a6e}=_0x16d1a5;if(!_0x24dbf7)return;const _0x814bd9=await this[_0x543ee1(0x192)][_0x543ee1(0x15a)](_0x24dbf7);if(!_0x814bd9)return;const {answer:_0x495119,prompt:_0x4ec7ea}=_0x814bd9,_0xd9af7e=_0x495119||_0x4ec7ea;return this[_0x543ee1(0x1f9)](_0x4ad6cd,_0xd9af7e,_0x2b0a6e);}async[_0x56780d(0x1f9)](_0xb62a9a,_0x53a15c,_0x59233e=_0x56780d(0x14e)){const _0x1b6380=_0x56780d,_0x309482=await this[_0x1b6380(0x183)][_0x1b6380(0x175)]();if(!_0x309482)throw new common_1['HttpException'](_0x1b6380(0x1a3),common_1[_0x1b6380(0x173)][_0x1b6380(0x23b)]);const {key:_0x5656f7,proxyUrl:_0x71f269}=_0x309482,_0x28a4d9=_0x71f269[_0x1b6380(0x14c)]('/')?_0x71f269+'v1':_0x71f269+_0x1b6380(0x15c),_0xdf8566=new openai_1[(_0x1b6380(0x1f3))]({'baseURL':_0x28a4d9,'apiKey':_0x5656f7}),_0x316e95=await _0xdf8566[_0x1b6380(0x208)][_0x1b6380(0x1f4)]['create']({'model':'tts-1','voice':_0x59233e,'input':_0x53a15c});_0x316e95[_0x1b6380(0x165)][_0x1b6380(0x1dc)](_0xb62a9a);}async[_0x56780d(0x17f)](_0x4c1c7a){const _0x236823=_0x56780d;try{const _0x9b4e94=await this[_0x236823(0x183)][_0x236823(0x175)]();if(!_0x9b4e94)throw new common_1[(_0x236823(0x12f))](_0x236823(0x1a3),common_1[_0x236823(0x173)][_0x236823(0x23b)]);const {key:_0x4e724a,proxyUrl:_0x3a8c77}=_0x9b4e94,_0x572ebe=_0x3a8c77['endsWith']('/')?_0x3a8c77+'v1':_0x3a8c77+_0x236823(0x15c),_0x3c87d0=new openai_1['default']({'baseURL':_0x572ebe,'apiKey':_0x4e724a});}catch(_0x5df03d){console[_0x236823(0x15d)](_0x236823(0x214),_0x5df03d);throw new common_1[(_0x236823(0x12f))](_0x236823(0x1f6),common_1[_0x236823(0x173)][_0x236823(0x23b)]);}}async[_0x56780d(0x135)](_0x6472ed,_0x554291,_0x2a0471){const _0x4a74ba=_0x56780d;var _0x485c06;const _0x136061=_0x554291[_0x4a74ba(0x1bc)],{options:options={},appId:_0x39b135,cusromPrompt:_0x21d468,systemMessage:systemMessage='',tts:tts=''}=_0x6472ed;let _0x4fa854=_0x6472ed['prompt'];const {parentMessageId:_0x56bd27,file:_0x2a6e46,groupId:_0x510fe8,usingNetwork:_0x1f6e70}=options;let _0x43b5a0=systemMessage,_0x5d0b7a=_0x2a6e46;if(!tts&&!_0x4fa854&&!_0x2a6e46)throw new common_1[(_0x4a74ba(0x12f))](_0x4a74ba(0x20f),common_1[_0x4a74ba(0x173)]['BAD_REQUEST']);if(tts){const _0x32fc8a=await this['chatSpeechToText'](tts);if(!_0x32fc8a)throw new common_1[(_0x4a74ba(0x12f))](_0x4a74ba(0x182),common_1[_0x4a74ba(0x173)][_0x4a74ba(0x23b)]);_0x4fa854=_0x32fc8a;}const _0x1cbbab=await this['chatGroupService'][_0x4a74ba(0x1a9)](_0x510fe8),_0x4e096a=(_0x1cbbab===null||_0x1cbbab===void 0x0?void 0x0:_0x1cbbab[_0x4a74ba(0x123)])||0x0;let _0x3c266d=(_0x1cbbab===null||_0x1cbbab===void 0x0?void 0x0:_0x1cbbab[_0x4a74ba(0x189)])?JSON[_0x4a74ba(0x1fe)](_0x1cbbab['config']):null;(!_0x3c266d||!_0x3c266d[_0x4a74ba(0x134)]||!_0x3c266d[_0x4a74ba(0x178)])&&!_0x4e096a&&(_0x3c266d=await this[_0x4a74ba(0x183)]['getBaseConfig']());let _0x556cd5=0x0,_0xcba907='',_0x521564=null;_0x4e096a&&(_0x556cd5=await this[_0x4a74ba(0x183)]['getModelTypeIdFromPluginId'](_0x4e096a));if(_0x39b135){const _0x3fda0f=await this['appEntity'][_0x4a74ba(0x19e)]({'where':{'id':_0x39b135,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x3fda0f)throw new common_1['HttpException'](_0x4a74ba(0x125),common_1[_0x4a74ba(0x173)][_0x4a74ba(0x23b)]);const {modelTypeId:_0x34cee4,isGpts:_0x44c7dd,preset:_0x13f732,gptsId:_0x6c6a38}=_0x3fda0f;if(_0x44c7dd){_0x556cd5=await this[_0x4a74ba(0x183)]['getModelTypeIdFromGpts']();if(!_0x556cd5)throw new common_1[(_0x4a74ba(0x12f))](_0x4a74ba(0x188),common_1[_0x4a74ba(0x173)][_0x4a74ba(0x23b)]);_0x521564=_0x6c6a38;}else _0x556cd5=_0x34cee4,_0xcba907=_0x13f732;}(!_0x4e096a&&!_0x39b135||!_0x556cd5)&&(_0x556cd5=_0x3c266d['modelTypeId']);const _0x2a31d6=await this[_0x4a74ba(0x183)][_0x4a74ba(0x1eb)](_0x556cd5);if(!_0x2a31d6)throw new common_1[(_0x4a74ba(0x12f))](_0x4a74ba(0x15e),common_1[_0x4a74ba(0x173)][_0x4a74ba(0x23b)]);const {deduct:_0xe0b7e6,deductType:_0x5d6c1d,model:_0x3e038b,maxTokens:_0x162a5a,modelType:_0x4fcac5,modelName:_0x747799}=_0x2a31d6,{systemMessage:_0x58f817,topN:_0x3d6a32,maxResponseTokens:_0x582a40,rounds:_0x516bc3}=_0x3c266d[_0x4a74ba(0x178)];let _0x7aedea=null;!_0x21d468?_0x7aedea=await this[_0x4a74ba(0x183)][_0x4a74ba(0x146)](_0x556cd5):_0x7aedea=await this[_0x4a74ba(0x183)][_0x4a74ba(0x13b)]();if(!_0x7aedea)throw new common_1[(_0x4a74ba(0x12f))]('当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型或更换模型使用！',common_1[_0x4a74ba(0x173)][_0x4a74ba(0x23b)]);const {key:_0xb06b56,secret:_0x4b735b,id:_0x317aab,accessToken:_0x3be58a,proxyUrl:_0x38ac23}=_0x7aedea;await this[_0x4a74ba(0x120)][_0x4a74ba(0x124)](_0x554291[_0x4a74ba(0x151)]),await this[_0x4a74ba(0x17e)][_0x4a74ba(0x1de)](_0x554291,(0x0,verification_constant_1[_0x4a74ba(0x1c4)])(_0x5d6c1d),_0xe0b7e6),_0x2a0471&&_0x2a0471['setHeader'](_0x4a74ba(0x213),_0x4a74ba(0x1bb)),await this[_0x4a74ba(0x18a)]['checkBadWords'](_0x4fa854,_0x554291['user']['id']);const _0x58c11b=await this[_0x4a74ba(0x156)]['checkAutoReply'](_0x4fa854);if(_0x58c11b&&_0x2a0471){const _0x596b9e={'message':_0x58c11b,'code':0x1f4};return _0x2a0471[_0x4a74ba(0x1d8)](JSON[_0x4a74ba(0x161)](_0x596b9e)),_0x2a0471['end']();}if(_0x39b135)_0xcba907&&(_0x43b5a0=_0xcba907);else{if(_0x21d468)_0x43b5a0=_0x6472ed['systemMessage'];else{if(_0x58f817)_0x43b5a0=_0x58f817;else{const _0x31f8ff=new Date()[_0x4a74ba(0x1f0)]()[_0x4a74ba(0x199)]('T')[0x0],_0x55013f=await this[_0x4a74ba(0x17a)]['getConfigs']([_0x4a74ba(0x149)]);_0x43b5a0=_0x55013f+(_0x4a74ba(0x127)+_0x31f8ff);}}}if(_0x4e096a){_0x43b5a0=null;const {imgUrl:_0x15a57a,documentUrl:_0x3797f2}=_0x1cbbab;_0x5d0b7a=_0x15a57a||_0x3797f2,_0x43b5a0=(0x0,helper_1[_0x4a74ba(0x16f)])(Object['assign'](Object[_0x4a74ba(0x16e)]({},_0x1cbbab),{'pluginId':_0x4e096a}));}_0x2a0471&&_0x2a0471['status'](0xc8);let _0xf9b08e=null,_0x1ed44a=null;try{if(_0x2a0471){let _0x45653a=null,_0x30ce3c=![];_0x2a0471['on'](_0x4a74ba(0x169),async()=>{const _0x512d8f=_0x4a74ba;if(_0x30ce3c)return;_0x136061[_0x512d8f(0x1c0)]();const _0x13a03d=await(0x0,openai_2['getTokenCount'])(_0x4fa854)||0x0,_0xba7e71=await(0x0,openai_2[_0x512d8f(0x13e)])(_0x45653a===null||_0x45653a===void 0x0?void 0x0:_0x45653a[_0x512d8f(0x139)])||0x0,_0x326651=_0x13a03d+_0xba7e71,_0x3cf2ab=(0x0,utils_1['getClientIp'])(_0x554291);await this[_0x512d8f(0x192)][_0x512d8f(0x14a)]({'appId':_0x39b135,'curIp':_0x3cf2ab,'userId':_0x554291['user']['id'],'type':balance_constant_1[_0x512d8f(0x1be)][_0x512d8f(0x241)],'prompt':_0x4fa854,'answer':'','promptTokens':_0x13a03d,'completionTokens':0x0,'totalTokens':_0x13a03d,'model':_0x3e038b,'role':'user','groupId':_0x510fe8,'tts':tts,'file':_0x5d0b7a,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x4fa854})}),await this[_0x512d8f(0x192)]['saveChatLog']({'appId':_0x39b135,'curIp':_0x3cf2ab,'userId':_0x554291[_0x512d8f(0x151)]['id'],'type':balance_constant_1[_0x512d8f(0x1be)][_0x512d8f(0x241)],'prompt':_0x4fa854,'answer':_0x45653a===null||_0x45653a===void 0x0?void 0x0:_0x45653a[_0x512d8f(0x139)],'promptTokens':_0x13a03d,'completionTokens':_0xba7e71,'totalTokens':_0x326651,'model':_0x3e038b,'role':_0x512d8f(0x21f),'groupId':_0x510fe8,'requestOptions':JSON[_0x512d8f(0x161)]({'options':{'model':_0x3e038b,'temperature':_0x3d6a32},'prompt':_0x4fa854}),'conversationOptions':JSON[_0x512d8f(0x161)]({'conversationId':_0x45653a===null||_0x45653a===void 0x0?void 0x0:_0x45653a[_0x512d8f(0x12d)],'model':_0x3e038b,'parentMessageId':_0x45653a===null||_0x45653a===void 0x0?void 0x0:_0x45653a['id'],'temperature':_0x3d6a32})}),await this[_0x512d8f(0x17e)][_0x512d8f(0x226)](_0x554291[_0x512d8f(0x151)]['id'],_0x512d8f(0x1a2)+(_0x5d6c1d===0x1?0x3:0x4),_0xe0b7e6,_0x326651);});const _0x110e38=_0x4fa854;if(Number(_0x4fcac5)===0x1){const {context:_0x15e867,maxTokens:_0x1ce827}=await this['nineStore'][_0x4a74ba(0x1e1)](_0x110e38,{'parentMessageId':_0x56bd27,'systemMessage':_0x43b5a0,'maxModelToken':_0x162a5a,'maxResponseTokens':_0x582a40,'maxRounds':(0x0,helper_1[_0x4a74ba(0x240)])(_0x516bc3),'file':_0x5d0b7a});let _0x2e61ab=!![];_0xf9b08e=await(0x0,openai_2[_0x4a74ba(0x136)])(_0x15e867,{'maxToken':_0x582a40,'apiKey':_0xb06b56,'model':_0x3e038b,'temperature':_0x3d6a32,'proxyUrl':_0x38ac23,'usingNetwork':_0x1f6e70,'gptsId':_0x521564,'onProgress':_0x519707=>{const _0x5165d4=_0x4a74ba;_0x2a0471[_0x5165d4(0x1d8)](_0x2e61ab?JSON[_0x5165d4(0x161)](_0x519707):'\x0a'+JSON['stringify'](_0x519707)),_0x45653a=_0x519707,_0x2e61ab=![];}}),_0x30ce3c=!![];}if(Number(_0x4fcac5)===0x2){let _0x814cd8=!![];const {context:_0x176350}=await this['nineStore'][_0x4a74ba(0x1e1)](_0x4fa854,{'parentMessageId':_0x56bd27,'maxRounds':(0x0,helper_1[_0x4a74ba(0x240)])(_0x516bc3)});_0xf9b08e=await(0x0,baidu_1['sendMessageFromBaidu'])(_0x176350,{'temperature':_0x3d6a32,'accessToken':_0x3be58a,'model':_0x3e038b,'onProgress':_0x49b06e=>{const _0x5707e0=_0x4a74ba;_0x2a0471[_0x5707e0(0x1d8)](_0x814cd8?JSON[_0x5707e0(0x161)](_0x49b06e):'\x0a'+JSON[_0x5707e0(0x161)](_0x49b06e)),_0x814cd8=![],_0x45653a=_0x49b06e;}}),_0x30ce3c=!![];}if(Number(_0x4fcac5)===0x3){let _0x189266=!![];const {context:_0x5097c3}=await this[_0x4a74ba(0x133)][_0x4a74ba(0x1e1)](_0x4fa854,{'parentMessageId':_0x56bd27,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x516bc3)});_0xf9b08e=await(0x0,zhipu_1[_0x4a74ba(0x209)])(_0x5097c3,{'temperature':_0x3d6a32,'key':_0xb06b56,'model':_0x3e038b,'onProgress':_0x3e0344=>{const _0x3bfa58=_0x4a74ba;_0x2a0471[_0x3bfa58(0x1d8)](_0x189266?JSON[_0x3bfa58(0x161)](_0x3e0344):'\x0a'+JSON[_0x3bfa58(0x161)](_0x3e0344)),_0x189266=![],_0x45653a=_0x3e0344;}}),_0x30ce3c=!![];}const _0x444b63={'id':this['nineStore'][_0x4a74ba(0x229)](),'text':_0x4fa854,'file':_0x5d0b7a,'role':_0x4a74ba(0x151),'name':undefined,'usage':null,'parentMessageId':_0x56bd27,'conversationId':_0xf9b08e===null||_0xf9b08e===void 0x0?void 0x0:_0xf9b08e[_0x4a74ba(0x12d)]};_0x1ed44a={'model':_0x3e038b,'parentMessageId':_0x56bd27},await this[_0x4a74ba(0x133)][_0x4a74ba(0x233)](_0x444b63);const _0x22c5e8={'id':_0xf9b08e['id'],'text':_0xf9b08e[_0x4a74ba(0x139)],'role':_0x4a74ba(0x21f),'name':undefined,'usage':_0xf9b08e['usage'],'parentMessageId':_0x444b63['id'],'conversationId':_0xf9b08e===null||_0xf9b08e===void 0x0?void 0x0:_0xf9b08e[_0x4a74ba(0x12d)]};await this[_0x4a74ba(0x133)][_0x4a74ba(0x233)](_0x22c5e8),_0x1ed44a={'model':_0x3e038b,'parentMessageId':_0x444b63['id']};}else{const _0x104faa=_0x4fa854,{context:_0x59374c}=await this[_0x4a74ba(0x133)]['buildMessageFromParentMessageId'](_0x104faa,{'parentMessageId':_0x56bd27,'systemMessage':_0x43b5a0,'maxRounds':(0x0,helper_1[_0x4a74ba(0x240)])(_0x516bc3)});_0xf9b08e=await(0x0,openai_2[_0x4a74ba(0x136)])(_0x59374c,{'apiKey':_0xb06b56,'model':_0x3e038b,'temperature':_0x3d6a32,'proxyUrl':_0x38ac23,'onProgress':null});}const _0x3446d7=await(0x0,helper_1[_0x4a74ba(0x21a)])(_0x4fcac5,_0xf9b08e,_0x1ed44a),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x3446d7[_0x4a74ba(0x195)];await this[_0x4a74ba(0x17e)][_0x4a74ba(0x226)](_0x554291[_0x4a74ba(0x151)]['id'],'model'+(_0x5d6c1d===0x1?0x3:0x4),_0xe0b7e6,total_tokens),await this[_0x4a74ba(0x183)]['saveUseLog'](_0x317aab,_0x556cd5,total_tokens);const _0x704ddf=(0x0,utils_1[_0x4a74ba(0x12c)])(_0x554291),_0x23b4ce=await this[_0x4a74ba(0x192)]['saveChatLog']({'appId':_0x39b135,'curIp':_0x704ddf,'userId':_0x554291[_0x4a74ba(0x151)]['id'],'type':balance_constant_1[_0x4a74ba(0x1be)][_0x4a74ba(0x241)],'prompt':_0x4fa854,'answer':'','promptTokens':prompt_tokens,'completionTokens':0x0,'totalTokens':total_tokens,'model':(_0x3446d7===null||_0x3446d7===void 0x0?void 0x0:_0x3446d7[_0x4a74ba(0x1a2)])||_0x3e038b,'role':_0x4a74ba(0x151),'groupId':_0x510fe8,'tts':tts,'file':_0x5d0b7a,'requestOptions':JSON[_0x4a74ba(0x161)]({'options':null,'prompt':_0x4fa854})}),_0x47578b=await this[_0x4a74ba(0x192)][_0x4a74ba(0x14a)]({'appId':_0x39b135,'curIp':_0x704ddf,'userId':_0x554291['user']['id'],'type':balance_constant_1['DeductionKey']['CHAT_TYPE'],'prompt':_0x4fa854,'answer':_0x3446d7===null||_0x3446d7===void 0x0?void 0x0:_0x3446d7['text'],'promptTokens':prompt_tokens,'completionTokens':completion_tokens,'totalTokens':total_tokens,'model':(_0x3446d7===null||_0x3446d7===void 0x0?void 0x0:_0x3446d7[_0x4a74ba(0x1a2)])||_0x3e038b,'role':_0x4a74ba(0x21f),'groupId':_0x510fe8,'requestOptions':JSON[_0x4a74ba(0x161)]({'options':{'model':_0x3e038b,'temperature':_0x3d6a32},'prompt':_0x4fa854}),'conversationOptions':JSON['stringify']({'conversationId':_0xf9b08e[_0x4a74ba(0x12d)],'model':_0x3e038b,'parentMessageId':_0xf9b08e['id'],'temperature':_0x3d6a32})});common_1[_0x4a74ba(0x235)][_0x4a74ba(0x190)](_0x4a74ba(0x174)+_0x554291['user']['id']+_0x4a74ba(0x15b)+_0x3e038b+'\x20key\x20->\x20'+_0xb06b56+_0x4a74ba(0x1ae)+_0x747799+_0x4a74ba(0x158)+_0x582a40,_0x4a74ba(0x219));const _0x19f26a=await this[_0x4a74ba(0x17e)][_0x4a74ba(0x23a)](_0x554291['user']['id']);return _0xf9b08e[_0x4a74ba(0x1e8)]=Object[_0x4a74ba(0x16e)]({},_0x19f26a),_0xf9b08e[_0x4a74ba(0x16c)]=_0x47578b['id'],_0xf9b08e[_0x4a74ba(0x1d3)]=_0x23b4ce['id'],_0xf9b08e[_0x4a74ba(0x1bf)]&&(_0xf9b08e[_0x4a74ba(0x1bf)]=''),_0xf9b08e[_0x4a74ba(0x130)]=!![],_0x2a0471?_0x2a0471[_0x4a74ba(0x1d8)]('\x0a'+JSON['stringify'](_0xf9b08e)):_0xf9b08e[_0x4a74ba(0x139)];}catch(_0xaa05b8){const _0x1d4bbe=(_0xaa05b8===null||_0xaa05b8===void 0x0?void 0x0:_0xaa05b8['statusCode'])||0x190,_0x1009df=((_0x485c06=_0xaa05b8===null||_0xaa05b8===void 0x0?void 0x0:_0xaa05b8[_0x4a74ba(0x163)])===null||_0x485c06===void 0x0?void 0x0:_0x485c06[_0x4a74ba(0x150)])||(_0xaa05b8===null||_0xaa05b8===void 0x0?void 0x0:_0xaa05b8['statusCode'])||0x190;if(_0xaa05b8['status']&&_0xaa05b8[_0x4a74ba(0x150)]===0x192){const _0x3e4fca={'message':_0x4a74ba(0x1ac)+_0xaa05b8[_0x4a74ba(0x243)],'code':0x192};if(_0x2a0471)return _0x2a0471['write'](JSON[_0x4a74ba(0x161)](_0x3e4fca));else throw new common_1[(_0x4a74ba(0x12f))](_0xaa05b8[_0x4a74ba(0x243)],common_1[_0x4a74ba(0x173)][_0x4a74ba(0x207)]);}if(!_0x1009df){if(_0x2a0471)return _0x2a0471[_0x4a74ba(0x1d8)](JSON[_0x4a74ba(0x161)]({'message':_0xaa05b8[_0x4a74ba(0x243)],'code':0x1f4}));else throw new common_1[(_0x4a74ba(0x12f))](_0xaa05b8['message'],common_1[_0x4a74ba(0x173)][_0x4a74ba(0x23b)]);}let _0x595ea8=errorMessage_constant_1[_0x4a74ba(0x14b)][_0x1009df]?errorMessage_constant_1[_0x4a74ba(0x14b)][_0x1009df]:'服务异常、请重新试试吧！！！';(_0xaa05b8===null||_0xaa05b8===void 0x0?void 0x0:_0xaa05b8[_0x4a74ba(0x243)][_0x4a74ba(0x21b)](_0x4a74ba(0x13c)))&&Number(_0x4fcac5)===0x1&&(await this[_0x4a74ba(0x183)][_0x4a74ba(0x1c6)](_0x317aab,_0x4a74ba(0x185),-0x1),_0x595ea8=_0x4a74ba(0x147));(_0xaa05b8===null||_0xaa05b8===void 0x0?void 0x0:_0xaa05b8['statusCode'])===0x1ad&&_0xaa05b8[_0x4a74ba(0x243)][_0x4a74ba(0x21b)](_0x4a74ba(0x1a6))&&Number(_0x4fcac5)===0x1&&(await this['modelsService'][_0x4a74ba(0x1c6)](_0x317aab,_0x4a74ba(0x22a),-0x3),_0x595ea8=_0x4a74ba(0x20a));(_0xaa05b8===null||_0xaa05b8===void 0x0?void 0x0:_0xaa05b8['statusCode'])===0x1ad&&(_0xaa05b8===null||_0xaa05b8===void 0x0?void 0x0:_0xaa05b8[_0x4a74ba(0x184)])===_0x4a74ba(0x218)&&(_0x595ea8=_0x4a74ba(0x1a7));(_0xaa05b8===null||_0xaa05b8===void 0x0?void 0x0:_0xaa05b8[_0x4a74ba(0x1d1)])===0x191&&_0xaa05b8['message']['includes'](_0x4a74ba(0x18b))&&Number(_0x4fcac5)===0x1&&(await this[_0x4a74ba(0x183)][_0x4a74ba(0x1c6)](_0x317aab,_0x4a74ba(0x1c5),-0x2),_0x595ea8=_0x4a74ba(0x157));(_0xaa05b8===null||_0xaa05b8===void 0x0?void 0x0:_0xaa05b8[_0x4a74ba(0x1d1)])===0x194&&_0xaa05b8[_0x4a74ba(0x243)]['includes'](_0x4a74ba(0x1e7))&&Number(_0x4fcac5)===0x1&&(await this['modelsService'][_0x4a74ba(0x1c6)](_0x317aab,_0x4a74ba(0x1e0),-0x4),_0x595ea8=_0x4a74ba(0x1ad));_0x1d4bbe===0x190&&console['log'](_0x4a74ba(0x20e),_0xaa05b8,_0xaa05b8[_0x4a74ba(0x243)]);const _0x2ec4ff={'message':_0x595ea8||_0x4a74ba(0x1cd),'code':_0x1d4bbe===0x191?0x190:_0x1d4bbe||0x1f4};if(_0x2a0471)return _0x2a0471[_0x4a74ba(0x1d8)](JSON[_0x4a74ba(0x161)](_0x2ec4ff));else throw new common_1[(_0x4a74ba(0x12f))](_0x2ec4ff['message'],common_1[_0x4a74ba(0x173)][_0x4a74ba(0x23b)]);}finally{_0x2a0471&&_0x2a0471[_0x4a74ba(0x1b1)]();}}async[_0x56780d(0x121)](_0x5af165,_0x2f2e3e){const _0x346a1a=_0x56780d;var _0xecf827,_0x244f5b,_0x2cb572,_0x4d55ce,_0x573463,_0x53bdc0,_0x4eb7e4,_0x57bb59;await this['badwordsService'][_0x346a1a(0x180)](_0x5af165[_0x346a1a(0x11f)],_0x2f2e3e['user']['id']),await this[_0x346a1a(0x120)][_0x346a1a(0x124)](_0x2f2e3e['user']);const _0x12dc0a=(_0x5af165===null||_0x5af165===void 0x0?void 0x0:_0x5af165[_0x346a1a(0x220)])==='hd'?0x4:0x2;await this[_0x346a1a(0x17e)][_0x346a1a(0x1de)](_0x2f2e3e,_0x346a1a(0x17c),_0x12dc0a);let _0x4c9745=[];const _0x36a334=await this['modelsService'][_0x346a1a(0x1df)]();if(!_0x36a334)throw new common_1[(_0x346a1a(0x12f))]('当前绘画模型暂未上架、请联系管理员上架此模型！',common_1[_0x346a1a(0x173)]['BAD_REQUEST']);const _0xb50e07=_0x36a334===null||_0x36a334===void 0x0?void 0x0:_0x36a334['id'],{key:_0x18460f}=_0x36a334;let _0x4b5375=_0x36a334[_0x346a1a(0x191)];common_1['Logger'][_0x346a1a(0x15d)]('draw\x20paompt\x20info\x20<==**==>\x20'+_0x5af165[_0x346a1a(0x11f)]+_0x346a1a(0x20b)+_0x18460f,_0x346a1a(0x16d));try{_0x4b5375['endsWith']('/')&&(_0x4b5375=_0x4b5375[_0x346a1a(0x216)](0x0,_0x4b5375[_0x346a1a(0x1a5)]-0x1));const _0xd60e87=_0x4b5375+_0x346a1a(0x14d),_0x38b7e6=Object[_0x346a1a(0x16e)](Object[_0x346a1a(0x16e)]({},_0x5af165),{'model':_0x346a1a(0x22c)}),_0x263428=await axios_1[_0x346a1a(0x1f3)][_0x346a1a(0x239)](_0xd60e87,Object['assign'](Object[_0x346a1a(0x16e)]({},_0x38b7e6),{'response_format':'b64_json'}),{'headers':{'Authorization':_0x346a1a(0x17d)+_0x18460f}});console[_0x346a1a(0x15d)](_0x346a1a(0x1b7),_0xd60e87,_0x18460f),_0x4c9745=_0x263428['data'][_0x346a1a(0x141)];const _0x19f711=[];for(const _0x542cc5 of _0x4c9745){const _0x222eb3=uuid['v4']()['slice'](0x0,0xa)+_0x346a1a(0x1b3),_0x1d4a2a=_0x542cc5['url']||_0x542cc5[_0x346a1a(0x1b6)],_0x30eab4=_0x1d4a2a[_0x346a1a(0x1bd)](/^data:image\/webp;base64,/,''),_0x321c92=Buffer[_0x346a1a(0x1ca)](_0x30eab4,'base64');_0x19f711[_0x346a1a(0x181)](this[_0x346a1a(0x21e)][_0x346a1a(0x1c2)]({'filename':_0x222eb3,'buffer':_0x321c92}));}const _0x4c1421=await Promise['all'](_0x19f711);await this[_0x346a1a(0x17e)][_0x346a1a(0x226)](_0x2f2e3e['user']['id'],'mjDraw',(_0x38b7e6===null||_0x38b7e6===void 0x0?void 0x0:_0x38b7e6[_0x346a1a(0x220)])===_0x346a1a(0x11d)?0x2:0x4,_0x12dc0a);const _0x5bda03=(0x0,utils_1[_0x346a1a(0x12c)])(_0x2f2e3e),_0x4d3f49=[],_0x2f37a6=await this[_0x346a1a(0x21e)][_0x346a1a(0x1af)](),[_0x136131,_0x5bae4f]=_0x5af165[_0x346a1a(0x1b8)]['split']('x');return _0x4c1421[_0x346a1a(0x1cc)](_0x220b26=>{const _0x57fbc5=_0x346a1a;_0x4d3f49[_0x57fbc5(0x181)](this['chatLogService'][_0x57fbc5(0x14a)]({'curIp':_0x5bda03,'userId':_0x2f2e3e[_0x57fbc5(0x151)]['id'],'type':balance_constant_1['DeductionKey'][_0x57fbc5(0x122)],'prompt':_0x5af165[_0x57fbc5(0x11f)],'answer':_0x220b26,'fileInfo':JSON[_0x57fbc5(0x161)]({'cosType':_0x2f37a6,'width':_0x136131,'height':_0x5bae4f,'cosUrl':_0x220b26}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x57fbc5(0x22c)}));}),await Promise[_0x346a1a(0x215)](_0x4d3f49),_0x4c1421;}catch(_0x28e2f1){console[_0x346a1a(0x15d)](_0x346a1a(0x214),_0x28e2f1),console['log'](_0x346a1a(0x14f),(_0xecf827=_0x28e2f1===null||_0x28e2f1===void 0x0?void 0x0:_0x28e2f1[_0x346a1a(0x163)])===null||_0xecf827===void 0x0?void 0x0:_0xecf827[_0x346a1a(0x150)],(_0x4d55ce=(_0x2cb572=(_0x244f5b=_0x28e2f1===null||_0x28e2f1===void 0x0?void 0x0:_0x28e2f1[_0x346a1a(0x163)])===null||_0x244f5b===void 0x0?void 0x0:_0x244f5b['data'])===null||_0x2cb572===void 0x0?void 0x0:_0x2cb572[_0x346a1a(0x12e)])===null||_0x4d55ce===void 0x0?void 0x0:_0x4d55ce[_0x346a1a(0x243)]);const _0x8b69c2=((_0x573463=_0x28e2f1===null||_0x28e2f1===void 0x0?void 0x0:_0x28e2f1[_0x346a1a(0x163)])===null||_0x573463===void 0x0?void 0x0:_0x573463[_0x346a1a(0x150)])||0x1f4,_0x50b663=(_0x57bb59=(_0x4eb7e4=(_0x53bdc0=_0x28e2f1===null||_0x28e2f1===void 0x0?void 0x0:_0x28e2f1[_0x346a1a(0x163)])===null||_0x53bdc0===void 0x0?void 0x0:_0x53bdc0[_0x346a1a(0x141)])===null||_0x4eb7e4===void 0x0?void 0x0:_0x4eb7e4[_0x346a1a(0x12e)])===null||_0x57bb59===void 0x0?void 0x0:_0x57bb59[_0x346a1a(0x243)];if(_0x8b69c2===0x1ad)throw new common_1[(_0x346a1a(0x12f))]('当前请求已过载、请稍等会儿再试试吧！',common_1[_0x346a1a(0x173)][_0x346a1a(0x23b)]);if(_0x8b69c2===0x190&&_0x50b663[_0x346a1a(0x21b)](_0x346a1a(0x171)))throw new common_1[(_0x346a1a(0x12f))]('您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',common_1['HttpStatus']['BAD_REQUEST']);if(_0x8b69c2===0x190&&_0x50b663[_0x346a1a(0x21b)](_0x346a1a(0x170))){await this[_0x346a1a(0x183)][_0x346a1a(0x1c6)](_0xb50e07,_0x346a1a(0x185),-0x1);throw new common_1['HttpException']('当前Key余额已不足、请重新再试一次吧！',common_1[_0x346a1a(0x173)][_0x346a1a(0x23b)]);}if(_0x8b69c2===0x1f4)throw new common_1[(_0x346a1a(0x12f))](_0x346a1a(0x1ba),common_1[_0x346a1a(0x173)]['BAD_REQUEST']);if(_0x8b69c2===0x191)throw new common_1[(_0x346a1a(0x12f))]('绘制图片失败，此次绘画被拒绝了！',common_1[_0x346a1a(0x173)]['BAD_REQUEST']);if(_0x8b69c2===0x1f7)throw new common_1[(_0x346a1a(0x12f))](_0x50b663,common_1['HttpStatus'][_0x346a1a(0x23b)]);throw new common_1[(_0x346a1a(0x12f))](_0x346a1a(0x234),common_1[_0x346a1a(0x173)][_0x346a1a(0x23b)]);}}async['getAllKeyList'](){const _0x4fc3ae=_0x56780d,_0x7ba8cc=await this[_0x4fc3ae(0x142)][_0x4fc3ae(0x23f)]({'where':{'status':0x1},'select':['id',_0x4fc3ae(0x137),_0x4fc3ae(0x203),_0x4fc3ae(0x1a2),_0x4fc3ae(0x1fd),'maxResponseTokens',_0x4fc3ae(0x13a),_0x4fc3ae(0x167)]}),_0x5b5683=_0x7ba8cc[_0x4fc3ae(0x222)](_0x4e7b08=>_0x4e7b08[_0x4fc3ae(0x1a2)][_0x4fc3ae(0x21b)]('gpt-3')),_0x2b694f=_0x7ba8cc[_0x4fc3ae(0x222)](_0x945b63=>_0x945b63[_0x4fc3ae(0x1a2)]['includes']('gpt-4'));this[_0x4fc3ae(0x1da)]={'list3':_0x5b5683,'list4':_0x2b694f};}async[_0x56780d(0x1e3)](_0x3c56a1){const _0x337e0e=_0x56780d,_0x3e1a41=await this[_0x337e0e(0x17a)]['getConfigs'](['openaiBaseUrl']);return(_0x3c56a1===null||_0x3c56a1===void 0x0?void 0x0:_0x3c56a1[_0x337e0e(0x191)])||_0x3e1a41||_0x337e0e(0x143);}async['setChatBoxType'](_0x59d3ce,_0x393dec){const _0x3a597c=_0x56780d;try{const {name:_0x1dd46f,icon:_0x81f7fa,order:_0x2802ec,id:_0x2b9647,status:_0x311cf5}=_0x393dec;return _0x2b9647?await this['chatBoxTypeEntity']['update']({'id':_0x2b9647},{'name':_0x1dd46f,'icon':_0x81f7fa,'order':_0x2802ec,'status':_0x311cf5}):await this['chatBoxTypeEntity']['save']({'name':_0x1dd46f,'icon':_0x81f7fa,'order':_0x2802ec,'status':_0x311cf5});}catch(_0x5ad31f){console['log'](_0x3a597c(0x214),_0x5ad31f);}}async['delChatBoxType'](_0x370c3b,_0x2b191c){const _0x102580=_0x56780d,{id:_0x158571}=_0x2b191c;if(!_0x158571)throw new common_1[(_0x102580(0x12f))](_0x102580(0x126),common_1[_0x102580(0x173)][_0x102580(0x23b)]);const _0x39659a=await this['chatBoxEntity'][_0x102580(0x1d5)]({'where':{'typeId':_0x158571}});if(_0x39659a)throw new common_1[(_0x102580(0x12f))](_0x102580(0x217),common_1[_0x102580(0x173)][_0x102580(0x23b)]);return await this['chatBoxTypeEntity']['delete']({'id':_0x158571});}async[_0x56780d(0x225)](){const _0x5be3e9=_0x56780d;return await this[_0x5be3e9(0x154)][_0x5be3e9(0x23f)]({'order':{'order':_0x5be3e9(0x11b)}});}async[_0x56780d(0x1ec)](_0x59977e,_0xa583e5){const _0x1baf38=_0x56780d,{title:_0x348e9d,prompt:_0x97f301,appId:_0x5e9bec,order:_0xf6e4f1,status:_0x42acbc,typeId:_0x5da831,id:_0x583fd7,url:_0x3e061d}=_0xa583e5;if(!_0x5da831)throw new common_1['HttpException'](_0x1baf38(0x193),common_1['HttpStatus'][_0x1baf38(0x23b)]);try{const _0x571ec7={'title':_0x348e9d,'order':_0xf6e4f1,'status':_0x42acbc,'typeId':_0x5da831,'url':_0x3e061d};return _0x571ec7[_0x1baf38(0x22e)]=_0x5e9bec||0x0,_0x571ec7['prompt']=_0x97f301||'',_0x583fd7?await this[_0x1baf38(0x1c7)]['update']({'id':_0x583fd7},_0x571ec7):await this[_0x1baf38(0x1c7)][_0x1baf38(0x129)](_0x571ec7);}catch(_0x57fc22){console[_0x1baf38(0x15d)]('error:\x20',_0x57fc22);}}async[_0x56780d(0x1d6)](_0x46db17,_0x22360e){const _0x1671aa=_0x56780d,{id:_0x67ca56}=_0x22360e;if(!_0x67ca56)throw new common_1[(_0x1671aa(0x12f))](_0x1671aa(0x126),common_1[_0x1671aa(0x173)]['BAD_REQUEST']);return await this[_0x1671aa(0x1c7)][_0x1671aa(0x236)]({'id':_0x67ca56});}async[_0x56780d(0x1cf)](){const _0x464543=_0x56780d,_0x44e68f=await this['chatBoxEntity'][_0x464543(0x23f)]({'order':{'order':'DESC'}}),_0xcd8899=[...new Set(_0x44e68f['map'](_0x193b64=>_0x193b64['typeId']))],_0x4174e5=[...new Set(_0x44e68f[_0x464543(0x1a0)](_0xe9e0fe=>_0xe9e0fe['appId']))],_0x4cc5b2=await this[_0x464543(0x154)][_0x464543(0x23f)]({'where':{'id':(0x0,typeorm_1['In'])(_0xcd8899)}}),_0x520817=await this[_0x464543(0x1ea)][_0x464543(0x23f)]({'where':{'id':(0x0,typeorm_1['In'])(_0x4174e5)}});return _0x44e68f[_0x464543(0x1a0)](_0xef9bf8=>{const _0x1aac2c=_0x464543,{typeId:_0x3d954a,appId:_0x4e001b}=_0xef9bf8;return _0xef9bf8['typeInfo']=_0x4cc5b2[_0x1aac2c(0x23f)](_0x40de15=>_0x40de15['id']===_0x3d954a),_0xef9bf8[_0x1aac2c(0x22d)]=_0x520817['find'](_0xdffdb4=>_0xdffdb4['id']===_0x4e001b),_0xef9bf8;});}async[_0x56780d(0x22b)](){const _0x457d81=_0x56780d,_0xfd093d=await this[_0x457d81(0x154)][_0x457d81(0x23f)]({'order':{'order':_0x457d81(0x11b)},'where':{'status':!![]}}),_0x532763=await this['chatBoxEntity'][_0x457d81(0x23f)]({'where':{'status':!![]}}),_0x145640=[...new Set(_0x532763[_0x457d81(0x1a0)](_0x584367=>_0x584367[_0x457d81(0x22e)]))],_0x54d0e8=await this[_0x457d81(0x1ea)][_0x457d81(0x23f)]({'where':{'id':(0x0,typeorm_1['In'])(_0x145640)}});return _0x532763[_0x457d81(0x1cc)](_0x4fc18b=>{const _0xb974d4=_0x457d81,_0x5c26cc=_0x54d0e8[_0xb974d4(0x23f)](_0xb0fcd5=>_0xb0fcd5['id']===_0x4fc18b[_0xb974d4(0x22e)]);return _0x4fc18b[_0xb974d4(0x160)]=_0x5c26cc===null||_0x5c26cc===void 0x0?void 0x0:_0x5c26cc[_0xb974d4(0x160)],_0x4fc18b;}),_0xfd093d[_0x457d81(0x1a0)](_0x4fd279=>{const _0x211434=_0x457d81;return _0x4fd279[_0x211434(0x1f5)]=_0x532763[_0x211434(0x222)](_0x5f03ee=>_0x5f03ee[_0x211434(0x201)]===_0x4fd279['id']&&_0x5f03ee['status']),_0x4fd279;});}async[_0x56780d(0x148)](_0x11f1f9,_0x1db42f){const _0xe2782=_0x56780d;try{const {name:_0xa8de7e,icon:_0x3ff2e6,order:_0x4087fe,id:_0x37d077,status:_0x37e572}=_0x1db42f;return _0x37d077?await this[_0xe2782(0x221)][_0xe2782(0x15f)]({'id':_0x37d077},{'name':_0xa8de7e,'icon':_0x3ff2e6,'order':_0x4087fe,'status':_0x37e572}):await this[_0xe2782(0x221)]['save']({'name':_0xa8de7e,'icon':_0x3ff2e6,'order':_0x4087fe,'status':_0x37e572});}catch(_0x338597){console['log'](_0xe2782(0x214),_0x338597);}}async[_0x56780d(0x23d)](_0x411bc9,_0x1f0527){const _0x2d1f9d=_0x56780d,{id:_0x11f461}=_0x1f0527;if(!_0x11f461)throw new common_1[(_0x2d1f9d(0x12f))](_0x2d1f9d(0x126),common_1[_0x2d1f9d(0x173)]['BAD_REQUEST']);const _0x45cbce=await this[_0x2d1f9d(0x1c7)][_0x2d1f9d(0x1d5)]({'where':{'typeId':_0x11f461}});if(_0x45cbce)throw new common_1[(_0x2d1f9d(0x12f))](_0x2d1f9d(0x217),common_1[_0x2d1f9d(0x173)][_0x2d1f9d(0x23b)]);return await this[_0x2d1f9d(0x221)][_0x2d1f9d(0x236)]({'id':_0x11f461});}async['queryChatPreType'](){const _0x1d12ab=_0x56780d;return await this[_0x1d12ab(0x221)][_0x1d12ab(0x23f)]({'order':{'order':_0x1d12ab(0x11b)}});}async[_0x56780d(0x1fc)](_0x49f792,_0x5151b4){const _0x27999d=_0x56780d,{title:_0x477a2f,prompt:_0x1d0248,appId:_0x324e88,order:_0x237189,status:_0x162d24,typeId:_0x43145d,id:_0x18ad24,url:_0x217c9d}=_0x5151b4;if(!_0x43145d)throw new common_1[(_0x27999d(0x12f))](_0x27999d(0x193),common_1[_0x27999d(0x173)]['BAD_REQUEST']);try{const _0x35d324={'title':_0x477a2f,'prompt':_0x1d0248,'order':_0x237189,'status':_0x162d24,'typeId':_0x43145d,'url':_0x217c9d};return _0x18ad24?await this[_0x27999d(0x211)][_0x27999d(0x15f)]({'id':_0x18ad24},_0x35d324):await this['chatPreEntity'][_0x27999d(0x129)](_0x35d324);}catch(_0x5d9184){console[_0x27999d(0x15d)]('error:\x20',_0x5d9184);}}async['delChatPre'](_0x12e3fc,_0x521837){const _0x324646=_0x56780d,{id:_0x25c691}=_0x521837;if(!_0x25c691)throw new common_1[(_0x324646(0x12f))](_0x324646(0x126),common_1[_0x324646(0x173)]['BAD_REQUEST']);return await this[_0x324646(0x211)][_0x324646(0x236)]({'id':_0x25c691});}async[_0x56780d(0x23e)](){const _0x42763b=_0x56780d,_0x3c3b87=await this[_0x42763b(0x211)][_0x42763b(0x23f)]({'order':{'order':_0x42763b(0x11b)}}),_0xe2002c=[...new Set(_0x3c3b87[_0x42763b(0x1a0)](_0x1c456e=>_0x1c456e[_0x42763b(0x201)]))],_0x5d90b5=await this['chatPreTypeEntity'][_0x42763b(0x23f)]({'where':{'id':(0x0,typeorm_1['In'])(_0xe2002c)}});return _0x3c3b87[_0x42763b(0x1a0)](_0x5b9935=>{const _0x3b87bb=_0x42763b,{typeId:_0x440252,appId:_0x349c28}=_0x5b9935;return _0x5b9935[_0x3b87bb(0x1b2)]=_0x5d90b5[_0x3b87bb(0x23f)](_0xf68586=>_0xf68586['id']===_0x440252),_0x5b9935;});}async[_0x56780d(0x145)](){const _0x4e192d=_0x56780d,_0x101281=await this['chatPreTypeEntity'][_0x4e192d(0x23f)]({'order':{'order':_0x4e192d(0x11b)},'where':{'status':!![]}}),_0x2ba878=await this[_0x4e192d(0x211)][_0x4e192d(0x23f)]({'where':{'status':!![]}});return _0x101281[_0x4e192d(0x1a0)](_0x1617fc=>{const _0x337477=_0x4e192d;return _0x1617fc[_0x337477(0x1f5)]=_0x2ba878[_0x337477(0x222)](_0x11c4a7=>_0x11c4a7[_0x337477(0x201)]===_0x1617fc['id']&&_0x11c4a7[_0x337477(0x150)]),_0x1617fc;});}async[_0x56780d(0x194)](_0x478cb9,_0x28295a,_0x38c3e4){const _0x1c0400=_0x56780d;let _0x16428a=0x1000,_0x3a6d54=0x800;return _0x478cb9['toLowerCase']()['includes'](_0x1c0400(0x18e))&&(_0x16428a=_0x28295a>=0x2004?0x2004:_0x28295a,_0x3a6d54=_0x38c3e4>=0x1000?0x1000:_0x38c3e4,_0x478cb9[_0x1c0400(0x22f)]()['includes'](_0x1c0400(0x16b))&&(_0x16428a=_0x28295a>=0x8000?0x8000:_0x28295a,_0x3a6d54=_0x38c3e4>=0x3e80?0x3e80:_0x38c3e4),(_0x478cb9[_0x1c0400(0x22f)]()['includes'](_0x1c0400(0x155))||_0x478cb9[_0x1c0400(0x22f)]()['includes'](_0x1c0400(0x13d)))&&(_0x16428a=_0x28295a>=0x1f400?0x1f400:_0x28295a,_0x3a6d54=_0x38c3e4>=0x1000?0x1000:_0x38c3e4)),_0x478cb9[_0x1c0400(0x22f)]()[_0x1c0400(0x21b)]('gpt-3')&&(_0x16428a=_0x28295a>=0x1000?0x1000:_0x28295a,_0x3a6d54=_0x38c3e4>=0x800?0x800:_0x38c3e4,_0x478cb9[_0x1c0400(0x22f)]()[_0x1c0400(0x21b)](_0x1c0400(0x118))&&(_0x16428a=_0x28295a>=0x4000?0x4000:_0x28295a,_0x3a6d54=_0x38c3e4>=0x1f40?0x1f40:_0x38c3e4),_0x478cb9[_0x1c0400(0x22f)]()[_0x1c0400(0x21b)]('1106')&&(_0x16428a=_0x28295a>=0x4000?0x4000:_0x28295a,_0x3a6d54=_0x38c3e4>=0x1f40?0x1f40:_0x38c3e4)),{'maxToken':_0x16428a,'maxRes':_0x3a6d54};}};ChatgptService=__decorate([(0x0,common_1[_0x56780d(0x206)])(),__param(0x0,(0x0,typeorm_2[_0x56780d(0x204)])(gptkeys_entity_1[_0x56780d(0x1cb)])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(config_entity_1['ConfigEntity'])),__param(0x2,(0x0,typeorm_2[_0x56780d(0x204)])(chatBoxType_entity_1[_0x56780d(0x223)])),__param(0x3,(0x0,typeorm_2[_0x56780d(0x204)])(chatBox_entity_1[_0x56780d(0x164)])),__param(0x4,(0x0,typeorm_2['InjectRepository'])(app_entity_1[_0x56780d(0x18c)])),__param(0x5,(0x0,typeorm_2[_0x56780d(0x204)])(chatPreType_entity_1[_0x56780d(0x1ff)])),__param(0x6,(0x0,typeorm_2['InjectRepository'])(chatPre_entity_1[_0x56780d(0x1e6)])),__metadata(_0x56780d(0x202),[typeorm_1[_0x56780d(0x119)],typeorm_1[_0x56780d(0x119)],typeorm_1[_0x56780d(0x119)],typeorm_1[_0x56780d(0x119)],typeorm_1['Repository'],typeorm_1[_0x56780d(0x119)],typeorm_1['Repository'],nestjs_config_1[_0x56780d(0x1c9)],userBalance_service_1[_0x56780d(0x162)],chatLog_service_1[_0x56780d(0x187)],user_service_1[_0x56780d(0x12b)],upload_service_1[_0x56780d(0x18f)],badwords_service_1['BadwordsService'],autoreply_service_1['AutoreplyService'],globalConfig_service_1[_0x56780d(0x1e4)],fanyi_service_1[_0x56780d(0x12a)],chatGroup_service_1[_0x56780d(0x186)],models_service_1[_0x56780d(0x1e9)]])],ChatgptService),exports['ChatgptService']=ChatgptService;