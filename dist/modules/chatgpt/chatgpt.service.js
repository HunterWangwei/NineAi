'use strict';const _0x274e85=_0x3a49;(function(_0x264645,_0x5ca47b){const _0x289d1c=_0x3a49,_0x4e7e9f=_0x264645();while(!![]){try{const _0x3c3060=-parseInt(_0x289d1c(0x25b))/0x1+-parseInt(_0x289d1c(0x25a))/0x2*(parseInt(_0x289d1c(0x245))/0x3)+-parseInt(_0x289d1c(0x203))/0x4+parseInt(_0x289d1c(0x1b8))/0x5*(parseInt(_0x289d1c(0x1e7))/0x6)+parseInt(_0x289d1c(0x296))/0x7*(parseInt(_0x289d1c(0x210))/0x8)+parseInt(_0x289d1c(0x253))/0x9*(-parseInt(_0x289d1c(0x290))/0xa)+parseInt(_0x289d1c(0x242))/0xb;if(_0x3c3060===_0x5ca47b)break;else _0x4e7e9f['push'](_0x4e7e9f['shift']());}catch(_0x2977c8){_0x4e7e9f['push'](_0x4e7e9f['shift']());}}}(_0x4c1d,0x33955));function _0x3a49(_0x51fc85,_0x531950){const _0x4c1d8e=_0x4c1d();return _0x3a49=function(_0x3a49a0,_0x38210e){_0x3a49a0=_0x3a49a0-0x1ac;let _0x40bda8=_0x4c1d8e[_0x3a49a0];return _0x40bda8;},_0x3a49(_0x51fc85,_0x531950);}var __decorate=this&&this['__decorate']||function(_0x46f12a,_0x4ec47e,_0xd9a3c2,_0x49a8a1){const _0x27f318=_0x3a49;var _0x478c7c=arguments[_0x27f318(0x216)],_0xcf2206=_0x478c7c<0x3?_0x4ec47e:_0x49a8a1===null?_0x49a8a1=Object[_0x27f318(0x278)](_0x4ec47e,_0xd9a3c2):_0x49a8a1,_0x449932;if(typeof Reflect===_0x27f318(0x2cc)&&typeof Reflect[_0x27f318(0x270)]==='function')_0xcf2206=Reflect[_0x27f318(0x270)](_0x46f12a,_0x4ec47e,_0xd9a3c2,_0x49a8a1);else{for(var _0x115304=_0x46f12a[_0x27f318(0x216)]-0x1;_0x115304>=0x0;_0x115304--)if(_0x449932=_0x46f12a[_0x115304])_0xcf2206=(_0x478c7c<0x3?_0x449932(_0xcf2206):_0x478c7c>0x3?_0x449932(_0x4ec47e,_0xd9a3c2,_0xcf2206):_0x449932(_0x4ec47e,_0xd9a3c2))||_0xcf2206;}return _0x478c7c>0x3&&_0xcf2206&&Object[_0x27f318(0x2a6)](_0x4ec47e,_0xd9a3c2,_0xcf2206),_0xcf2206;},__metadata=this&&this['__metadata']||function(_0x27fbdd,_0x19ab21){const _0x3298f4=_0x3a49;if(typeof Reflect===_0x3298f4(0x2cc)&&typeof Reflect[_0x3298f4(0x230)]===_0x3298f4(0x1c5))return Reflect[_0x3298f4(0x230)](_0x27fbdd,_0x19ab21);},__param=this&&this[_0x274e85(0x297)]||function(_0x13853d,_0x416ed4){return function(_0x120431,_0x3047c2){_0x416ed4(_0x120431,_0x3047c2,_0x13853d);};};Object[_0x274e85(0x2a6)](exports,'__esModule',{'value':!![]}),exports[_0x274e85(0x234)]=void 0x0;const upload_service_1=require('./../upload/upload.service'),user_service_1=require(_0x274e85(0x28d)),nestjs_config_1=require(_0x274e85(0x22a)),common_1=require('@nestjs/common'),errorMessage_constant_1=require(_0x274e85(0x226)),openai_1=require(_0x274e85(0x1b4)),utils_1=require(_0x274e85(0x236)),axios_1=require(_0x274e85(0x21a)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require('../../common/constants/balance.constant'),chatLog_service_1=require(_0x274e85(0x2ca)),uuid=require(_0x274e85(0x287)),config_entity_1=require(_0x274e85(0x1e9)),typeorm_1=require(_0x274e85(0x1c6)),typeorm_2=require('@nestjs/typeorm'),badwords_service_1=require('../badwords/badwords.service'),autoreply_service_1=require(_0x274e85(0x1cc)),gptkeys_entity_1=require(_0x274e85(0x1c2)),globalConfig_service_1=require(_0x274e85(0x1b0)),fanyi_service_1=require('../fanyi/fanyi.service'),app_entity_1=require(_0x274e85(0x247)),chatGroup_service_1=require('../chatGroup/chatGroup.service'),models_service_1=require(_0x274e85(0x1e1)),baidu_1=require(_0x274e85(0x2a8)),helper_1=require(_0x274e85(0x27c)),store_1=require('./store'),zhipu_1=require('./zhipu'),openai_2=require(_0x274e85(0x1b2)),chatBoxType_entity_1=require(_0x274e85(0x1cd)),chatBox_entity_1=require(_0x274e85(0x1af)),chatPre_entity_1=require(_0x274e85(0x289)),chatPreType_entity_1=require(_0x274e85(0x26e)),fs=require('fs'),path_1=require(_0x274e85(0x26b)),verification_constant_1=require(_0x274e85(0x260));function _0x4c1d(){const _0x7aa1a1=['appInfo','assistant','save','非法操作！','deductFromBalance','222vrJzoF','61070XPnqtA','uploadService','toISOString','find','pipe','../../common/constants/verification.constant','error-----:\x20','UploadService','gpt-4','coverImg','statusText','modelConfig','end','validateBalance','checkAutoReply','maxModelTokens','path','pathname','400\x20error','./chatPreType.entity','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','decorate','InjectRepository','https://api.openai.com','modelTypeId','Bearer\x20','缺失必要参数！','UserService','modelsService','getOwnPropertyDescriptor','chatProcess','setChatBoxType','REDIS_PORT','./helper','pluginId','stringify','delChatPreType','delete','conversationId','error','请将语言转为中文简体','16k','chatSpeechToText','chatSyncFree','uuid','mjDraw','./chatPre.entity','whisper-1','keyPool','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','./../user/user.service','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','当前请求已过载、请稍等会儿再试试吧！','10AaZBpn','saveChatLog','chatId','log','ChatBoxEntity','DrawService','7oqtGjq','__param','post','removeSpecialCharacters','saveUseLog','Injectable',',\x20最大回复token:\x20','gptKeysEntity','chatGlobaltools\x20\x20-->\x20error:\x20','userBalanceService','setChatPreType','当前Key余额已不足、请重新再试一次吧！','application/json','audio','slice','chat','defineProperty','default','./baidu','toLowerCase','userService','result','getGroupInfoFromId','unifiedFormattingResponse','autoreplyService','当前绘画模型暂未上架、请联系管理员上架此模型！','assign','all','chatBoxTypeEntity','checkUserStatus','findOne','PAINT_TYPE','lockKey','res.data:\x20','onModuleInit','dall-e-3','unshift','ChatGroupService','endsWith','fanyiService','draw\x20paompt\x20info\x20<==**==>\x20','gpt-3','uploadFile','chatTextToSpeech','../../public','/v1','getDefaultModel','\x0a\x20Current\x20date:\x20','gpt-4-vision-preview','realTimeTextToSpeech','请输入对话内容','usage','../chatLog/chatLog.service','getModelTypeIdFromGpts','object','\x20key\x20->\x20',',\x20模型名称:\x20','realTimeTextToSpeechChat','./chatBox.entity','../globalConfig/globalConfig.service','appEntity','./openai','语音转文字识别失败、请稍后试试吧！','openai','getTtsModelKey','HttpException','speech','1210rjEJsz','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','delChatBox','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','userBanance','count','getModelProxyUrl','当前应用使用的模型已被管理员下架、请联系管理员上架此模型！','当前语音转文字模型暂未上架、请联系管理员上架此模型！','getTokenCount','./gptkeys.entity','getClientIp','configEntity','function','typeorm','REDIS_PASSWORD','当前分类下有未处理数据不可移除！','chatBoxEntity','/v1/images/generations','standard','../autoreply/autoreply.service','./chatBoxType.entity','UserBalanceService','fable','createReadStream','ConfigEntity','importDynamic','write','user','ConfigService','b64_json','chatLogService','text','getUseDrawModelKey','close','addOneIfOdd','Repository','当前模型key余额已耗尽','systemPreMessage','sendMessageFromOpenAi','create','../models/models.service','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','setData','typeInfo','weight','getAllKeyList','1086lqOhCs','includes','../globalConfig/config.entity','AutoreplyService','status','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','delChatBoxType','error:\x20','setHeader','chatPreTypeEntity','choices','from','badwordsService','getMaxTokenFromModelWithOpenAi','response','绘制图片失败，请稍后试试吧！','abort','is_end','nineai-chatlog','tts-1','proxyUrl','typeId','DESC','当前流程所需要的模型已被管理员下架、请联系管理员上架此模型或更换其他模型使用！','systemMessage','replace','Content-type','getCurrentModelKeyInfo','1162376xHcrkP','getConfigs','getBaseConfig','请添加一个系统内置工具模型用于翻译优化！','data','model','/dist','nineStore','appId','filter','当前模型不是聊天模型','content','size','455352RDMATs','本次调用:\x20','1106','当前模型调用过于频繁、请重新试试吧！','NineStore','keyv','length','REDIS_HOST','Logger','map','axios','extractFilePath','Incorrect\x20API\x20key\x20provided','Billing\x20hard\x20limit\x20has\x20been\x20reached','chatPreEntity','CHAT_TYPE','Catch\x20Error\x20','maxResponseTokens','design:paramtypes','OpenAiErrorCodeMessage','ChatLogService','split','../../common/constants/errorMessage.constant','getModelTypeDetailFromId','setChatBox','quality','nestjs-config','globalConfigService','openaiBaseUrl','DeductionKey','queryChatBox','join','metadata','gpt-3.5-turbo','Too\x20Many\x20Requests','sendMessageFromZhipu','ChatgptService','getFullUrl','../../common/utils','chatgpt-nine-ai','GptKeysEntity','statusCode','buildMessageFromParentMessageId','update','key','queryChatBoxFrontend','chatGroupService','config','openaiProxyUrl','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型或更换模型使用！','7830812Cnsfmj','.png','BAD_REQUEST','2343gZESDZ','\x20model:\x20','../app/app.entity','prompt','url','base64','chatGlobaltools','env','message','HttpStatus','configService','REDIS_USER','billing','forEach','1466757ijoUrQ','checkBadWords'];_0x4c1d=function(){return _0x7aa1a1;};return _0x4c1d();}let ChatgptService=class ChatgptService{constructor(_0x8fa43,_0xada3c9,_0x4c5d79,_0xdea793,_0x29113d,_0x5b8d59,_0x10cdea,_0x58c1fc,_0x7b62ab,_0x2540d3,_0x51eb49,_0x50d40b,_0x472f10,_0x2b9326,_0x1dc2a0,_0x5e02fb,_0x49e064,_0x44ddb0){const _0x413825=_0x274e85;this[_0x413825(0x29d)]=_0x8fa43,this[_0x413825(0x1c4)]=_0xada3c9,this[_0x413825(0x2b2)]=_0x4c5d79,this['chatBoxEntity']=_0xdea793,this['appEntity']=_0x29113d,this[_0x413825(0x1f0)]=_0x5b8d59,this[_0x413825(0x21e)]=_0x10cdea,this[_0x413825(0x24f)]=_0x58c1fc,this[_0x413825(0x29f)]=_0x7b62ab,this['chatLogService']=_0x2540d3,this[_0x413825(0x2aa)]=_0x51eb49,this[_0x413825(0x25c)]=_0x50d40b,this[_0x413825(0x1f3)]=_0x472f10,this[_0x413825(0x2ae)]=_0x2b9326,this[_0x413825(0x22b)]=_0x1dc2a0,this[_0x413825(0x2bd)]=_0x5e02fb,this[_0x413825(0x23e)]=_0x49e064,this[_0x413825(0x277)]=_0x44ddb0,this[_0x413825(0x20a)]=null,this['whiteListUser']=[],this[_0x413825(0x28b)]={'list3':[],'list4':[]};}async[_0x274e85(0x2b8)](){const _0x258f47=_0x274e85;let _0x429799=await(0x0,utils_1[_0x258f47(0x1d2)])(_0x258f47(0x237)),_0x485660=await(0x0,utils_1['importDynamic'])('@keyv/redis'),_0x4ed5a6=await(0x0,utils_1['importDynamic'])(_0x258f47(0x215));_0x429799=(_0x429799===null||_0x429799===void 0x0?void 0x0:_0x429799[_0x258f47(0x2a7)])?_0x429799[_0x258f47(0x2a7)]:_0x429799,_0x485660=(_0x485660===null||_0x485660===void 0x0?void 0x0:_0x485660[_0x258f47(0x2a7)])?_0x485660[_0x258f47(0x2a7)]:_0x485660,_0x4ed5a6=(_0x4ed5a6===null||_0x4ed5a6===void 0x0?void 0x0:_0x4ed5a6[_0x258f47(0x2a7)])?_0x4ed5a6[_0x258f47(0x2a7)]:_0x4ed5a6;const {ChatGPTAPI:_0x3289dd,ChatGPTError:_0x5e8d8e,ChatGPTUnofficialProxyAPI:_0x3369a6}=_0x429799,_0x48ec51=+process[_0x258f47(0x24c)][_0x258f47(0x27b)],_0x1b4e9f=process[_0x258f47(0x24c)][_0x258f47(0x217)],_0x19fd1d=process['env'][_0x258f47(0x1c7)],_0x2c2602=process[_0x258f47(0x24c)][_0x258f47(0x250)],_0x2d84dd='redis://'+(_0x2c2602||'')+':'+(_0x19fd1d||'')+'@'+_0x1b4e9f+':'+_0x48ec51,_0x23a922=new _0x485660(_0x2d84dd),_0x133fd9=new _0x4ed5a6({'store':_0x23a922,'namespace':_0x258f47(0x1f9)});this['nineStore']=new store_1[(_0x258f47(0x214))]({'store':_0x133fd9,'namespace':_0x258f47(0x2a5)});}async[_0x274e85(0x286)](_0x4407f0){const _0x21e121=_0x274e85,_0x3c36af=await this[_0x21e121(0x277)][_0x21e121(0x2c4)]();if(!_0x3c36af)return;const {model:_0x43134b,maxTokens:_0x24aad9}=_0x3c36af,_0x1d6483=await this[_0x21e121(0x277)][_0x21e121(0x202)](_0x3c36af['id']);if(!_0x1d6483)return;const _0x1c0195=await this[_0x21e121(0x22b)]['getConfigs'](['systemPreMessage']),{key:_0x2040f5,proxyUrl:_0x2a4d60}=_0x1d6483,{context:_0x159c2a}=await this[_0x21e121(0x20a)][_0x21e121(0x23a)](_0x4407f0,{'parentMessageId':'','systemMessage':_0x1c0195});try{const _0x53a8a3=await(0x0,openai_2[_0x21e121(0x1df)])(_0x159c2a,{'apiKey':(0x0,utils_1[_0x21e121(0x299)])(_0x2040f5),'model':_0x43134b,'proxyUrl':_0x2a4d60,'maxToken':_0x24aad9,'onProgress':null});return _0x53a8a3===null||_0x53a8a3===void 0x0?void 0x0:_0x53a8a3['text'];}catch(_0xa607b1){console[_0x21e121(0x293)]('error:\x20',_0xa607b1);}}[_0x274e85(0x21b)](_0x467a26){const _0x5c879e=_0x274e85,_0x3fed42=new URL(_0x467a26);return _0x3fed42[_0x5c879e(0x26c)];}async[_0x274e85(0x24b)](_0x541cfd){const _0x18add5=_0x274e85;var _0x2e374a;try{const _0x5a968d=await this[_0x18add5(0x277)]['getUseToolsModelKey']();if(!_0x5a968d)throw new common_1['HttpException'](_0x18add5(0x206),common_1[_0x18add5(0x24e)][_0x18add5(0x244)]);const {key:_0x2ccee0,proxyUrl:_0x2bf095}=_0x5a968d,{systemMessage:_0x4702d2,prompt:_0x1ecf02}=_0x541cfd,_0x125199={'method':'POST','url':(0x0,openai_2[_0x18add5(0x235)])(_0x2bf095),'headers':{'Content-Type':_0x18add5(0x2a2),'Authorization':'Bearer\x20'+(0x0,utils_1[_0x18add5(0x299)])(_0x2ccee0)},'data':{'max_tokens':0xbb8,'model':_0x18add5(0x231),'messages':[{'role':_0x18add5(0x1d4),'content':_0x1ecf02}]}};_0x4702d2&&_0x125199['data']['messages'][_0x18add5(0x2ba)]({'role':'system','content':_0x4702d2});const _0x4cdb9a=await(0x0,axios_1[_0x18add5(0x2a7)])(_0x125199);return((_0x2e374a=_0x4cdb9a===null||_0x4cdb9a===void 0x0?void 0x0:_0x4cdb9a[_0x18add5(0x207)])===null||_0x2e374a===void 0x0?void 0x0:_0x2e374a[_0x18add5(0x1f1)][0x0][_0x18add5(0x24d)][_0x18add5(0x20e)])||_0x1ecf02;}catch(_0x16e63e){return console[_0x18add5(0x293)](_0x18add5(0x29e),_0x16e63e),prompt;}}async[_0x274e85(0x285)](_0x487222){const _0x3090b7=_0x274e85,_0x1ea07e=await this[_0x3090b7(0x277)]['getTtsModelKey']();if(!_0x1ea07e)throw new common_1[(_0x3090b7(0x1b6))](_0x3090b7(0x1c0),common_1[_0x3090b7(0x24e)]['BAD_REQUEST']);const {key:_0x579b3e,proxyUrl:_0x8f9762}=_0x1ea07e,_0x3093de=_0x8f9762[_0x3090b7(0x2bc)]('/')?_0x8f9762+'v1':_0x8f9762+_0x3090b7(0x2c3),_0x34653a=new openai_1['default']({'baseURL':_0x3093de,'apiKey':_0x579b3e}),_0x3bf3fd=this[_0x3090b7(0x21b)](_0x487222),_0xbf6b55=(0x0,path_1[_0x3090b7(0x22f)])(__dirname,_0x3090b7(0x2c2),_0x3bf3fd)[_0x3090b7(0x200)](_0x3090b7(0x209),''),_0x252265=await _0x34653a[_0x3090b7(0x2a3)]['transcriptions'][_0x3090b7(0x1e0)]({'model':_0x3090b7(0x28a),'prompt':_0x3090b7(0x283),'file':fs[_0x3090b7(0x1d0)](_0xbf6b55)});return console[_0x3090b7(0x293)]('语音转文字内容:\x20',_0x252265===null||_0x252265===void 0x0?void 0x0:_0x252265['text']),this['modelsService'][_0x3090b7(0x29a)](_0x1ea07e===null||_0x1ea07e===void 0x0?void 0x0:_0x1ea07e['id'],_0x1ea07e===null||_0x1ea07e===void 0x0?void 0x0:_0x1ea07e[_0x3090b7(0x273)],0x0),(_0x252265===null||_0x252265===void 0x0?void 0x0:_0x252265[_0x3090b7(0x1d8)])||null;}async['chatRealTimeTextToSpeech'](_0x2b8b8a,_0x1f756c,_0x66e7cf){const _0x166a42=_0x274e85,{name:name=_0x166a42(0x1cf),text:text=''}=_0x66e7cf;try{const _0x5bb877=await this[_0x166a42(0x277)]['getTtsModelKey']();if(!_0x5bb877)throw new common_1['HttpException'](_0x166a42(0x1c0),common_1[_0x166a42(0x24e)][_0x166a42(0x244)]);const {key:_0x6a8da2,proxyUrl:_0x17d98c}=_0x5bb877,_0x21854b=_0x17d98c[_0x166a42(0x2bc)]('/')?_0x17d98c+'v1':_0x17d98c+'/v1',_0x49e347=new openai_1[(_0x166a42(0x2a7))]({'baseURL':_0x21854b,'apiKey':_0x6a8da2}),_0x536cc6=await _0x49e347['audio'][_0x166a42(0x1b7)][_0x166a42(0x1e0)]({'model':_0x166a42(0x1fa),'voice':name,'input':text});this[_0x166a42(0x277)][_0x166a42(0x29a)](_0x5bb877===null||_0x5bb877===void 0x0?void 0x0:_0x5bb877['id'],_0x5bb877===null||_0x5bb877===void 0x0?void 0x0:_0x5bb877[_0x166a42(0x273)],0x0),_0x536cc6['body'][_0x166a42(0x25f)](_0x2b8b8a);}catch(_0x2ad1fc){console[_0x166a42(0x293)](_0x166a42(0x1ee),_0x2ad1fc);throw new common_1[(_0x166a42(0x1b6))]('语音转文字失败、请稍后试试吧！',common_1['HttpStatus'][_0x166a42(0x244)]);}}async[_0x274e85(0x1ae)](_0x52115f,_0x4ede8e){const _0xdd1497=_0x274e85,{id:_0x427719,voiceType:_0x3e5e3b}=_0x4ede8e;if(!_0x427719)return;const _0x5bea74=await this[_0xdd1497(0x1d7)]['getChatInfoFromId'](_0x427719);if(!_0x5bea74)return;const {answer:_0x22c414,prompt:_0x123aeb}=_0x5bea74,_0xce3dfc=_0x22c414||_0x123aeb;return this[_0xdd1497(0x2c7)](_0x52115f,_0xce3dfc,_0x3e5e3b);}async[_0x274e85(0x2c7)](_0x16bbda,_0x1de116,_0x967fed=_0x274e85(0x1cf)){const _0x266cc4=_0x274e85,_0x56c1c6=await this['modelsService'][_0x266cc4(0x1b5)]();if(!_0x56c1c6)throw new common_1[(_0x266cc4(0x1b6))](_0x266cc4(0x1c0),common_1[_0x266cc4(0x24e)][_0x266cc4(0x244)]);const {key:_0x37d655,proxyUrl:_0x5021b4}=_0x56c1c6,_0x12242e=_0x5021b4[_0x266cc4(0x2bc)]('/')?_0x5021b4+'v1':_0x5021b4+_0x266cc4(0x2c3),_0x499c96=new openai_1[(_0x266cc4(0x2a7))]({'baseURL':_0x12242e,'apiKey':_0x37d655}),_0x4ffc52=await _0x499c96[_0x266cc4(0x2a3)]['speech'][_0x266cc4(0x1e0)]({'model':'tts-1','voice':_0x967fed,'input':_0x1de116});_0x4ffc52['body'][_0x266cc4(0x25f)](_0x16bbda);}async[_0x274e85(0x2c1)](_0x34058b){const _0x4519df=_0x274e85;try{const _0x36eb94=await this[_0x4519df(0x277)][_0x4519df(0x1b5)]();if(!_0x36eb94)throw new common_1[(_0x4519df(0x1b6))](_0x4519df(0x1c0),common_1['HttpStatus']['BAD_REQUEST']);const {key:_0x193166,proxyUrl:_0x199c52}=_0x36eb94,_0x198f86=_0x199c52[_0x4519df(0x2bc)]('/')?_0x199c52+'v1':_0x199c52+_0x4519df(0x2c3),_0x1d4caf=new openai_1[(_0x4519df(0x2a7))]({'baseURL':_0x198f86,'apiKey':_0x193166});}catch(_0x31631e){console['log']('error:\x20',_0x31631e);throw new common_1[(_0x4519df(0x1b6))]('语音转文字失败、请稍后试试吧！',common_1['HttpStatus'][_0x4519df(0x244)]);}}async[_0x274e85(0x279)](_0x307ffc,_0x1e9c0c,_0x1770aa){const _0x560597=_0x274e85;var _0x1b3d80;const _0x134724=_0x1e9c0c['abortController'],{options:options={},appId:_0x43ee21,cusromPrompt:_0x5e3265,systemMessage:systemMessage='',tts:tts=''}=_0x307ffc;let _0x3c5e3a=_0x307ffc[_0x560597(0x248)];const {parentMessageId:_0x18dacd,file:_0xa6f184,groupId:_0x36a867,usingNetwork:_0x4ca5ed}=options;let _0x58ebe8=systemMessage,_0x141fc8=_0xa6f184;if(!tts&&!_0x3c5e3a&&!_0xa6f184)throw new common_1['HttpException'](_0x560597(0x2c8),common_1['HttpStatus'][_0x560597(0x244)]);if(tts){const _0x569126=await this[_0x560597(0x285)](tts);if(!_0x569126)throw new common_1[(_0x560597(0x1b6))](_0x560597(0x1b3),common_1['HttpStatus'][_0x560597(0x244)]);_0x3c5e3a=_0x569126;}const _0x162b8a=await this['chatGroupService'][_0x560597(0x2ac)](_0x36a867),_0x1de80d=(_0x162b8a===null||_0x162b8a===void 0x0?void 0x0:_0x162b8a[_0x560597(0x27d)])||0x0;let _0x238745=(_0x162b8a===null||_0x162b8a===void 0x0?void 0x0:_0x162b8a[_0x560597(0x23f)])?JSON['parse'](_0x162b8a[_0x560597(0x23f)]):null;(!_0x238745||!_0x238745[_0x560597(0x273)]||!_0x238745['modelConfig'])&&!_0x1de80d&&(_0x238745=await this['modelsService'][_0x560597(0x205)]());let _0x2f4634=0x0,_0xd0adb0='',_0x29ea54=null;_0x1de80d&&(_0x2f4634=await this[_0x560597(0x277)]['getModelTypeIdFromPluginId'](_0x1de80d));if(_0x43ee21){const _0x8c9912=await this[_0x560597(0x1b1)][_0x560597(0x2b4)]({'where':{'id':_0x43ee21,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x8c9912)throw new common_1[(_0x560597(0x1b6))](_0x560597(0x1bb),common_1[_0x560597(0x24e)][_0x560597(0x244)]);const {modelTypeId:_0x220b4d,isGpts:_0x375fd7,preset:_0x4e4c7d,gptsId:_0x47f03a}=_0x8c9912;if(_0x375fd7){_0x2f4634=await this[_0x560597(0x277)][_0x560597(0x2cb)]();if(!_0x2f4634)throw new common_1[(_0x560597(0x1b6))](_0x560597(0x1bf),common_1[_0x560597(0x24e)][_0x560597(0x244)]);_0x29ea54=_0x47f03a;}else _0x2f4634=_0x220b4d,_0xd0adb0=_0x4e4c7d;}(!_0x1de80d&&!_0x43ee21||!_0x2f4634)&&(_0x2f4634=_0x238745['modelTypeId']);const _0x23f9b7=await this[_0x560597(0x277)][_0x560597(0x227)](_0x2f4634);if(!_0x23f9b7)throw new common_1[(_0x560597(0x1b6))](_0x560597(0x1fe),common_1[_0x560597(0x24e)]['BAD_REQUEST']);const {deduct:_0x53b6ae,deductType:_0x31baf6,model:_0x277504,maxTokens:_0x1cbd7f,modelType:_0x21f805,modelName:_0x1b2f63}=_0x23f9b7,{systemMessage:_0x5848a2,topN:_0x5237b0,maxResponseTokens:_0x45dbce,rounds:_0xa94723}=_0x238745[_0x560597(0x266)];let _0x5cc542=null;!_0x5e3265?_0x5cc542=await this[_0x560597(0x277)][_0x560597(0x202)](_0x2f4634):_0x5cc542=await this['modelsService']['getUseToolsModelKey']();if(!_0x5cc542)throw new common_1[(_0x560597(0x1b6))](_0x560597(0x241),common_1[_0x560597(0x24e)][_0x560597(0x244)]);const {key:_0x1b4b70,secret:_0x5be6fc,id:_0x25c3af,accessToken:_0x5bbfbd,proxyUrl:_0x5739bb}=_0x5cc542;await this[_0x560597(0x2aa)][_0x560597(0x2b3)](_0x1e9c0c[_0x560597(0x1d4)]),await this[_0x560597(0x29f)][_0x560597(0x268)](_0x1e9c0c,(0x0,verification_constant_1['getDeductTypeMap'])(_0x31baf6),_0x53b6ae),_0x1770aa&&_0x1770aa[_0x560597(0x1ef)](_0x560597(0x201),'application/octet-stream;\x20charset=utf-8'),await this[_0x560597(0x1f3)][_0x560597(0x254)](_0x3c5e3a,_0x1e9c0c[_0x560597(0x1d4)]['id']);const _0x11a130=await this[_0x560597(0x2ae)][_0x560597(0x269)](_0x3c5e3a);if(_0x11a130&&_0x1770aa){const _0xeccd69={'message':_0x11a130,'code':0x1f4};return _0x1770aa[_0x560597(0x1d3)](JSON[_0x560597(0x27e)](_0xeccd69)),_0x1770aa[_0x560597(0x267)]();}if(_0x43ee21)_0xd0adb0&&(_0x58ebe8=_0xd0adb0);else{if(_0x5e3265)_0x58ebe8=_0x307ffc[_0x560597(0x1ff)];else{if(_0x5848a2)_0x58ebe8=_0x5848a2;else{const _0x4ee8b2=new Date()[_0x560597(0x25d)]()[_0x560597(0x225)]('T')[0x0],_0x570e20=await this[_0x560597(0x22b)][_0x560597(0x204)]([_0x560597(0x1de)]);_0x58ebe8=_0x570e20+(_0x560597(0x2c5)+_0x4ee8b2);}}}if(_0x1de80d){_0x58ebe8=null;const {imgUrl:_0x37c299,documentUrl:_0x2f448f}=_0x162b8a;_0x141fc8=_0x37c299||_0x2f448f,_0x58ebe8=(0x0,helper_1['genPluginSystemMessage'])(Object['assign'](Object[_0x560597(0x2b0)]({},_0x162b8a),{'pluginId':_0x1de80d}));}_0x1770aa&&_0x1770aa[_0x560597(0x1eb)](0xc8);let _0x2c9eb7=null,_0x1366b9=null;try{if(_0x1770aa){let _0x5a0fe1=null,_0x347a53=![];_0x1770aa['on'](_0x560597(0x1da),async()=>{const _0x30b5e4=_0x560597;if(_0x347a53)return;_0x134724[_0x30b5e4(0x1f7)]();const _0x402440=await(0x0,openai_2[_0x30b5e4(0x1c1)])(_0x3c5e3a)||0x0,_0x4fca47=await(0x0,openai_2[_0x30b5e4(0x1c1)])(_0x5a0fe1===null||_0x5a0fe1===void 0x0?void 0x0:_0x5a0fe1[_0x30b5e4(0x1d8)])||0x0,_0x121c37=_0x402440+_0x4fca47,_0x18be5e=(0x0,utils_1[_0x30b5e4(0x1c3)])(_0x1e9c0c);await this[_0x30b5e4(0x1d7)][_0x30b5e4(0x291)]({'appId':_0x43ee21,'curIp':_0x18be5e,'userId':_0x1e9c0c[_0x30b5e4(0x1d4)]['id'],'type':balance_constant_1[_0x30b5e4(0x22d)]['CHAT_TYPE'],'prompt':_0x3c5e3a,'answer':'','promptTokens':_0x402440,'completionTokens':0x0,'totalTokens':_0x402440,'model':_0x277504,'role':_0x30b5e4(0x1d4),'groupId':_0x36a867,'tts':tts,'file':_0x141fc8,'requestOptions':JSON[_0x30b5e4(0x27e)]({'options':null,'prompt':_0x3c5e3a})}),await this[_0x30b5e4(0x1d7)][_0x30b5e4(0x291)]({'appId':_0x43ee21,'curIp':_0x18be5e,'userId':_0x1e9c0c[_0x30b5e4(0x1d4)]['id'],'type':balance_constant_1[_0x30b5e4(0x22d)][_0x30b5e4(0x21f)],'prompt':_0x3c5e3a,'answer':_0x5a0fe1===null||_0x5a0fe1===void 0x0?void 0x0:_0x5a0fe1[_0x30b5e4(0x1d8)],'promptTokens':_0x402440,'completionTokens':_0x4fca47,'totalTokens':_0x121c37,'model':_0x277504,'role':_0x30b5e4(0x256),'groupId':_0x36a867,'requestOptions':JSON[_0x30b5e4(0x27e)]({'options':{'model':_0x277504,'temperature':_0x5237b0},'prompt':_0x3c5e3a}),'conversationOptions':JSON[_0x30b5e4(0x27e)]({'conversationId':_0x5a0fe1===null||_0x5a0fe1===void 0x0?void 0x0:_0x5a0fe1['conversationId'],'model':_0x277504,'parentMessageId':_0x5a0fe1===null||_0x5a0fe1===void 0x0?void 0x0:_0x5a0fe1['id'],'temperature':_0x5237b0})}),await this['userBalanceService']['deductFromBalance'](_0x1e9c0c[_0x30b5e4(0x1d4)]['id'],_0x30b5e4(0x208)+(_0x31baf6===0x1?0x3:0x4),_0x53b6ae,_0x121c37);});const _0x4173be=_0x3c5e3a;if(Number(_0x21f805)===0x1){const {context:_0x59485e,maxTokens:_0x549a2e}=await this[_0x560597(0x20a)][_0x560597(0x23a)](_0x4173be,{'parentMessageId':_0x18dacd,'systemMessage':_0x58ebe8,'maxModelToken':_0x1cbd7f,'maxResponseTokens':_0x45dbce,'maxRounds':(0x0,helper_1[_0x560597(0x1db)])(_0xa94723),'file':_0x141fc8});let _0xb0a113=!![];_0x2c9eb7=await(0x0,openai_2[_0x560597(0x1df)])(_0x59485e,{'maxToken':_0x45dbce,'apiKey':_0x1b4b70,'model':_0x277504,'temperature':_0x5237b0,'proxyUrl':_0x5739bb,'usingNetwork':_0x4ca5ed,'gptsId':_0x29ea54,'onProgress':_0x49d9dc=>{const _0x56a393=_0x560597;_0x1770aa[_0x56a393(0x1d3)](_0xb0a113?JSON[_0x56a393(0x27e)](_0x49d9dc):'\x0a'+JSON[_0x56a393(0x27e)](_0x49d9dc)),_0x5a0fe1=_0x49d9dc,_0xb0a113=![];}}),_0x347a53=!![];}if(Number(_0x21f805)===0x2){let _0x300b86=!![];const {context:_0x5ad2bb}=await this['nineStore'][_0x560597(0x23a)](_0x3c5e3a,{'parentMessageId':_0x18dacd,'maxRounds':(0x0,helper_1[_0x560597(0x1db)])(_0xa94723)});_0x2c9eb7=await(0x0,baidu_1['sendMessageFromBaidu'])(_0x5ad2bb,{'temperature':_0x5237b0,'accessToken':_0x5bbfbd,'model':_0x277504,'onProgress':_0x18d0f1=>{const _0x21e86d=_0x560597;_0x1770aa['write'](_0x300b86?JSON[_0x21e86d(0x27e)](_0x18d0f1):'\x0a'+JSON[_0x21e86d(0x27e)](_0x18d0f1)),_0x300b86=![],_0x5a0fe1=_0x18d0f1;}}),_0x347a53=!![];}if(Number(_0x21f805)===0x3){let _0x409842=!![];const {context:_0x167062}=await this['nineStore'][_0x560597(0x23a)](_0x3c5e3a,{'parentMessageId':_0x18dacd,'maxRounds':(0x0,helper_1[_0x560597(0x1db)])(_0xa94723)});_0x2c9eb7=await(0x0,zhipu_1[_0x560597(0x233)])(_0x167062,{'temperature':_0x5237b0,'key':_0x1b4b70,'model':_0x277504,'onProgress':_0xf848f2=>{const _0xecf0b5=_0x560597;_0x1770aa[_0xecf0b5(0x1d3)](_0x409842?JSON[_0xecf0b5(0x27e)](_0xf848f2):'\x0a'+JSON[_0xecf0b5(0x27e)](_0xf848f2)),_0x409842=![],_0x5a0fe1=_0xf848f2;}}),_0x347a53=!![];}const _0x2172f5={'id':this['nineStore']['getUuid'](),'text':_0x3c5e3a,'file':_0x141fc8,'role':_0x560597(0x1d4),'name':undefined,'usage':null,'parentMessageId':_0x18dacd,'conversationId':_0x2c9eb7===null||_0x2c9eb7===void 0x0?void 0x0:_0x2c9eb7[_0x560597(0x281)]};_0x1366b9={'model':_0x277504,'parentMessageId':_0x18dacd},await this[_0x560597(0x20a)][_0x560597(0x1e3)](_0x2172f5);const _0x282573={'id':_0x2c9eb7['id'],'text':_0x2c9eb7[_0x560597(0x1d8)],'role':'assistant','name':undefined,'usage':_0x2c9eb7[_0x560597(0x2c9)],'parentMessageId':_0x2172f5['id'],'conversationId':_0x2c9eb7===null||_0x2c9eb7===void 0x0?void 0x0:_0x2c9eb7[_0x560597(0x281)]};await this[_0x560597(0x20a)][_0x560597(0x1e3)](_0x282573),_0x1366b9={'model':_0x277504,'parentMessageId':_0x2172f5['id']};}else{const _0xe7a562=_0x3c5e3a,{context:_0xe362f1}=await this['nineStore'][_0x560597(0x23a)](_0xe7a562,{'parentMessageId':_0x18dacd,'systemMessage':_0x58ebe8,'maxRounds':(0x0,helper_1[_0x560597(0x1db)])(_0xa94723)});_0x2c9eb7=await(0x0,openai_2['sendMessageFromOpenAi'])(_0xe362f1,{'apiKey':_0x1b4b70,'model':_0x277504,'temperature':_0x5237b0,'proxyUrl':_0x5739bb,'onProgress':null});}const _0x473bf7=await(0x0,helper_1[_0x560597(0x2ad)])(_0x21f805,_0x2c9eb7,_0x1366b9),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x473bf7[_0x560597(0x2c9)];await this[_0x560597(0x29f)][_0x560597(0x259)](_0x1e9c0c[_0x560597(0x1d4)]['id'],_0x560597(0x208)+(_0x31baf6===0x1?0x3:0x4),_0x53b6ae,total_tokens),await this['modelsService'][_0x560597(0x29a)](_0x25c3af,_0x2f4634,total_tokens);const _0x5d9cb4=(0x0,utils_1[_0x560597(0x1c3)])(_0x1e9c0c),_0x12a338=await this[_0x560597(0x1d7)][_0x560597(0x291)]({'appId':_0x43ee21,'curIp':_0x5d9cb4,'userId':_0x1e9c0c[_0x560597(0x1d4)]['id'],'type':balance_constant_1[_0x560597(0x22d)][_0x560597(0x21f)],'prompt':_0x3c5e3a,'answer':'','promptTokens':prompt_tokens,'completionTokens':0x0,'totalTokens':total_tokens,'model':(_0x473bf7===null||_0x473bf7===void 0x0?void 0x0:_0x473bf7['model'])||_0x277504,'role':_0x560597(0x1d4),'groupId':_0x36a867,'tts':tts,'file':_0x141fc8,'requestOptions':JSON[_0x560597(0x27e)]({'options':null,'prompt':_0x3c5e3a})}),_0x3b709a=await this[_0x560597(0x1d7)][_0x560597(0x291)]({'appId':_0x43ee21,'curIp':_0x5d9cb4,'userId':_0x1e9c0c[_0x560597(0x1d4)]['id'],'type':balance_constant_1[_0x560597(0x22d)][_0x560597(0x21f)],'prompt':_0x3c5e3a,'answer':_0x473bf7===null||_0x473bf7===void 0x0?void 0x0:_0x473bf7['text'],'promptTokens':prompt_tokens,'completionTokens':completion_tokens,'totalTokens':total_tokens,'model':(_0x473bf7===null||_0x473bf7===void 0x0?void 0x0:_0x473bf7[_0x560597(0x208)])||_0x277504,'role':'assistant','groupId':_0x36a867,'requestOptions':JSON[_0x560597(0x27e)]({'options':{'model':_0x277504,'temperature':_0x5237b0},'prompt':_0x3c5e3a}),'conversationOptions':JSON['stringify']({'conversationId':_0x2c9eb7[_0x560597(0x281)],'model':_0x277504,'parentMessageId':_0x2c9eb7['id'],'temperature':_0x5237b0})});common_1[_0x560597(0x218)]['debug'](_0x560597(0x211)+_0x1e9c0c['user']['id']+_0x560597(0x246)+_0x277504+_0x560597(0x1ac)+_0x1b4b70+_0x560597(0x1ad)+_0x1b2f63+_0x560597(0x29c)+_0x45dbce,'ChatgptService');const _0xd31412=await this['userBalanceService']['queryUserBalance'](_0x1e9c0c['user']['id']);return _0x2c9eb7[_0x560597(0x1bc)]=Object[_0x560597(0x2b0)]({},_0xd31412),_0x2c9eb7[_0x560597(0x292)]=_0x3b709a['id'],_0x2c9eb7['prevChatId']=_0x12a338['id'],_0x2c9eb7[_0x560597(0x2ab)]&&(_0x2c9eb7['result']=''),_0x2c9eb7[_0x560597(0x1f8)]=!![],_0x1770aa?_0x1770aa[_0x560597(0x1d3)]('\x0a'+JSON[_0x560597(0x27e)](_0x2c9eb7)):_0x2c9eb7[_0x560597(0x1d8)];}catch(_0x5f05e3){const _0x18ad41=(_0x5f05e3===null||_0x5f05e3===void 0x0?void 0x0:_0x5f05e3[_0x560597(0x239)])||0x190,_0x9d3271=((_0x1b3d80=_0x5f05e3===null||_0x5f05e3===void 0x0?void 0x0:_0x5f05e3[_0x560597(0x1f5)])===null||_0x1b3d80===void 0x0?void 0x0:_0x1b3d80['status'])||(_0x5f05e3===null||_0x5f05e3===void 0x0?void 0x0:_0x5f05e3[_0x560597(0x239)])||0x190;if(_0x5f05e3[_0x560597(0x1eb)]&&_0x5f05e3['status']===0x192){const _0x4d8ee8={'message':_0x560597(0x220)+_0x5f05e3[_0x560597(0x24d)],'code':0x192};if(_0x1770aa)return _0x1770aa[_0x560597(0x1d3)](JSON[_0x560597(0x27e)](_0x4d8ee8));else throw new common_1['HttpException'](_0x5f05e3['message'],common_1[_0x560597(0x24e)]['PAYMENT_REQUIRED']);}if(!_0x9d3271){if(_0x1770aa)return _0x1770aa['write'](JSON['stringify']({'message':_0x5f05e3[_0x560597(0x24d)],'code':0x1f4}));else throw new common_1[(_0x560597(0x1b6))](_0x5f05e3['message'],common_1[_0x560597(0x24e)][_0x560597(0x244)]);}let _0xd3ccb1=errorMessage_constant_1[_0x560597(0x223)][_0x9d3271]?errorMessage_constant_1[_0x560597(0x223)][_0x9d3271]:'服务异常、请重新试试吧！！！';(_0x5f05e3===null||_0x5f05e3===void 0x0?void 0x0:_0x5f05e3['message'][_0x560597(0x1e8)](_0x560597(0x26f)))&&Number(_0x21f805)===0x1&&(await this[_0x560597(0x277)][_0x560597(0x2b6)](_0x25c3af,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0xd3ccb1='当前模型key已被封禁');(_0x5f05e3===null||_0x5f05e3===void 0x0?void 0x0:_0x5f05e3[_0x560597(0x239)])===0x1ad&&_0x5f05e3[_0x560597(0x24d)][_0x560597(0x1e8)](_0x560597(0x251))&&Number(_0x21f805)===0x1&&(await this[_0x560597(0x277)][_0x560597(0x2b6)](_0x25c3af,'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0xd3ccb1=_0x560597(0x1dd));(_0x5f05e3===null||_0x5f05e3===void 0x0?void 0x0:_0x5f05e3[_0x560597(0x239)])===0x1ad&&(_0x5f05e3===null||_0x5f05e3===void 0x0?void 0x0:_0x5f05e3[_0x560597(0x265)])===_0x560597(0x232)&&(_0xd3ccb1=_0x560597(0x213));(_0x5f05e3===null||_0x5f05e3===void 0x0?void 0x0:_0x5f05e3[_0x560597(0x239)])===0x191&&_0x5f05e3[_0x560597(0x24d)]['includes'](_0x560597(0x21c))&&Number(_0x21f805)===0x1&&(await this[_0x560597(0x277)][_0x560597(0x2b6)](_0x25c3af,'提供了错误的模型秘钥',-0x2),_0xd3ccb1=_0x560597(0x28c));(_0x5f05e3===null||_0x5f05e3===void 0x0?void 0x0:_0x5f05e3[_0x560597(0x239)])===0x194&&_0x5f05e3[_0x560597(0x24d)][_0x560597(0x1e8)]('This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported')&&Number(_0x21f805)===0x1&&(await this[_0x560597(0x277)][_0x560597(0x2b6)](_0x25c3af,_0x560597(0x20d),-0x4),_0xd3ccb1=_0x560597(0x1b9));_0x18ad41===0x190&&console[_0x560597(0x293)](_0x560597(0x26d),_0x5f05e3,_0x5f05e3['message']);const _0x41ba6e={'message':_0xd3ccb1||'Please\x20check\x20the\x20back-end\x20console','code':_0x18ad41===0x191?0x190:_0x18ad41||0x1f4};if(_0x1770aa)return _0x1770aa['write'](JSON[_0x560597(0x27e)](_0x41ba6e));else throw new common_1[(_0x560597(0x1b6))](_0x41ba6e['message'],common_1[_0x560597(0x24e)]['BAD_REQUEST']);}finally{_0x1770aa&&_0x1770aa['end']();}}async['draw'](_0x3bb860,_0x39af50){const _0x57f246=_0x274e85;var _0x5a7255,_0x1bee4a,_0x17fbd8,_0x4ced8b,_0x457412,_0x20fd27,_0x43ca2f,_0x42d78d;await this[_0x57f246(0x1f3)][_0x57f246(0x254)](_0x3bb860[_0x57f246(0x248)],_0x39af50['user']['id']),await this['userService']['checkUserStatus'](_0x39af50[_0x57f246(0x1d4)]);const _0x39e386=(_0x3bb860===null||_0x3bb860===void 0x0?void 0x0:_0x3bb860[_0x57f246(0x229)])==='hd'?0x4:0x2;await this[_0x57f246(0x29f)][_0x57f246(0x268)](_0x39af50,_0x57f246(0x288),_0x39e386);let _0x52db1c=[];const _0x1d9072=await this[_0x57f246(0x277)][_0x57f246(0x1d9)]();if(!_0x1d9072)throw new common_1[(_0x57f246(0x1b6))](_0x57f246(0x2af),common_1[_0x57f246(0x24e)][_0x57f246(0x244)]);const _0x1d8f6b=_0x1d9072===null||_0x1d9072===void 0x0?void 0x0:_0x1d9072['id'],{key:_0x30054d}=_0x1d9072;let _0x41c226=_0x1d9072['proxyUrl'];common_1['Logger']['log'](_0x57f246(0x2be)+_0x3bb860[_0x57f246(0x248)]+',\x20key\x20===>\x20'+_0x30054d,_0x57f246(0x295));try{_0x41c226[_0x57f246(0x2bc)]('/')&&(_0x41c226=_0x41c226[_0x57f246(0x2a4)](0x0,_0x41c226['length']-0x1));const _0x5252a4=_0x41c226+_0x57f246(0x1ca),_0x5660d1=Object[_0x57f246(0x2b0)](Object[_0x57f246(0x2b0)]({},_0x3bb860),{'model':_0x57f246(0x2b9)}),_0x3e772f=await axios_1[_0x57f246(0x2a7)][_0x57f246(0x298)](_0x5252a4,Object['assign'](Object['assign']({},_0x5660d1),{'response_format':_0x57f246(0x1d6)}),{'headers':{'Authorization':_0x57f246(0x274)+_0x30054d}});console[_0x57f246(0x293)](_0x57f246(0x2b7),_0x3e772f[_0x57f246(0x207)]),_0x52db1c=_0x3e772f['data'][_0x57f246(0x207)];const _0x5e5a86=[];for(const _0x51bca7 of _0x52db1c){const _0x3ef30a=uuid['v4']()[_0x57f246(0x2a4)](0x0,0xa)+_0x57f246(0x243),_0xfc784e=_0x51bca7['url']||_0x51bca7[_0x57f246(0x249)],_0x2e4b57=_0xfc784e[_0x57f246(0x200)](/^data:image\/webp;base64,/,''),_0x827847=Buffer[_0x57f246(0x1f2)](_0x2e4b57,_0x57f246(0x24a));_0x5e5a86['push'](this[_0x57f246(0x25c)][_0x57f246(0x2c0)]({'filename':_0x3ef30a,'buffer':_0x827847}));}const _0x1c5a12=await Promise['all'](_0x5e5a86);await this[_0x57f246(0x29f)][_0x57f246(0x259)](_0x39af50[_0x57f246(0x1d4)]['id'],'mjDraw',(_0x5660d1===null||_0x5660d1===void 0x0?void 0x0:_0x5660d1['quality'])===_0x57f246(0x1cb)?0x2:0x4,_0x39e386);const _0x4765b1=(0x0,utils_1[_0x57f246(0x1c3)])(_0x39af50),_0x321425=[],_0x1255c5=await this['uploadService']['getUploadType'](),[_0x23f82b,_0x3c788d]=_0x3bb860[_0x57f246(0x20f)][_0x57f246(0x225)]('x');return _0x1c5a12[_0x57f246(0x252)](_0xd5ee6=>{const _0x4cba22=_0x57f246;_0x321425['push'](this[_0x4cba22(0x1d7)][_0x4cba22(0x291)]({'curIp':_0x4765b1,'userId':_0x39af50[_0x4cba22(0x1d4)]['id'],'type':balance_constant_1['DeductionKey'][_0x4cba22(0x2b5)],'prompt':_0x3bb860[_0x4cba22(0x248)],'answer':_0xd5ee6,'fileInfo':JSON[_0x4cba22(0x27e)]({'cosType':_0x1255c5,'width':_0x23f82b,'height':_0x3c788d,'cosUrl':_0xd5ee6}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x4cba22(0x2b9)}));}),await Promise[_0x57f246(0x2b1)](_0x321425),_0x1c5a12;}catch(_0x6bd01b){console[_0x57f246(0x293)]('error:\x20',_0x6bd01b),console['log'](_0x57f246(0x261),(_0x5a7255=_0x6bd01b===null||_0x6bd01b===void 0x0?void 0x0:_0x6bd01b['response'])===null||_0x5a7255===void 0x0?void 0x0:_0x5a7255[_0x57f246(0x1eb)],(_0x4ced8b=(_0x17fbd8=(_0x1bee4a=_0x6bd01b===null||_0x6bd01b===void 0x0?void 0x0:_0x6bd01b[_0x57f246(0x1f5)])===null||_0x1bee4a===void 0x0?void 0x0:_0x1bee4a['data'])===null||_0x17fbd8===void 0x0?void 0x0:_0x17fbd8[_0x57f246(0x282)])===null||_0x4ced8b===void 0x0?void 0x0:_0x4ced8b[_0x57f246(0x24d)]);const _0x57b3e5=((_0x457412=_0x6bd01b===null||_0x6bd01b===void 0x0?void 0x0:_0x6bd01b['response'])===null||_0x457412===void 0x0?void 0x0:_0x457412[_0x57f246(0x1eb)])||0x1f4,_0x362714=(_0x42d78d=(_0x43ca2f=(_0x20fd27=_0x6bd01b===null||_0x6bd01b===void 0x0?void 0x0:_0x6bd01b[_0x57f246(0x1f5)])===null||_0x20fd27===void 0x0?void 0x0:_0x20fd27['data'])===null||_0x43ca2f===void 0x0?void 0x0:_0x43ca2f[_0x57f246(0x282)])===null||_0x42d78d===void 0x0?void 0x0:_0x42d78d[_0x57f246(0x24d)];if(_0x57b3e5===0x1ad)throw new common_1[(_0x57f246(0x1b6))](_0x57f246(0x28f),common_1[_0x57f246(0x24e)]['BAD_REQUEST']);if(_0x57b3e5===0x190&&_0x362714['includes'](_0x57f246(0x28e)))throw new common_1['HttpException'](_0x57f246(0x1e2),common_1[_0x57f246(0x24e)][_0x57f246(0x244)]);if(_0x57b3e5===0x190&&_0x362714[_0x57f246(0x1e8)](_0x57f246(0x21d))){await this[_0x57f246(0x277)][_0x57f246(0x2b6)](_0x1d8f6b,_0x57f246(0x1ec),-0x1);throw new common_1[(_0x57f246(0x1b6))](_0x57f246(0x2a1),common_1['HttpStatus'][_0x57f246(0x244)]);}if(_0x57b3e5===0x1f4)throw new common_1[(_0x57f246(0x1b6))]('当前配置模型可能不支持Dall-e-3模型、请检查！',common_1[_0x57f246(0x24e)][_0x57f246(0x244)]);if(_0x57b3e5===0x191)throw new common_1[(_0x57f246(0x1b6))]('绘制图片失败，此次绘画被拒绝了！',common_1[_0x57f246(0x24e)]['BAD_REQUEST']);if(_0x57b3e5===0x1f7)throw new common_1[(_0x57f246(0x1b6))](_0x362714,common_1['HttpStatus'][_0x57f246(0x244)]);throw new common_1['HttpException'](_0x57f246(0x1f6),common_1[_0x57f246(0x24e)][_0x57f246(0x244)]);}}async[_0x274e85(0x1e6)](){const _0x4f7b68=_0x274e85,_0x21de63=await this['gptKeysEntity'][_0x4f7b68(0x25e)]({'where':{'status':0x1},'select':['id',_0x4f7b68(0x23c),_0x4f7b68(0x1e5),_0x4f7b68(0x208),_0x4f7b68(0x26a),_0x4f7b68(0x221),_0x4f7b68(0x240),'openaiTimeoutMs']}),_0x3ff711=_0x21de63['filter'](_0x2c2ed7=>_0x2c2ed7[_0x4f7b68(0x208)][_0x4f7b68(0x1e8)]('gpt-3')),_0x41a9d4=_0x21de63['filter'](_0x5a07c4=>_0x5a07c4[_0x4f7b68(0x208)][_0x4f7b68(0x1e8)](_0x4f7b68(0x263)));this[_0x4f7b68(0x28b)]={'list3':_0x3ff711,'list4':_0x41a9d4};}async[_0x274e85(0x1be)](_0x3544f9){const _0x561f00=_0x274e85,_0x531a3b=await this[_0x561f00(0x22b)][_0x561f00(0x204)]([_0x561f00(0x22c)]);return(_0x3544f9===null||_0x3544f9===void 0x0?void 0x0:_0x3544f9[_0x561f00(0x1fb)])||_0x531a3b||_0x561f00(0x272);}async[_0x274e85(0x27a)](_0x366caf,_0x27cda5){const _0x2283a7=_0x274e85;try{const {name:_0x1a3cfe,icon:_0x4787e,order:_0x1745fc,id:_0x14c968,status:_0x4c518e}=_0x27cda5;return _0x14c968?await this[_0x2283a7(0x2b2)]['update']({'id':_0x14c968},{'name':_0x1a3cfe,'icon':_0x4787e,'order':_0x1745fc,'status':_0x4c518e}):await this[_0x2283a7(0x2b2)]['save']({'name':_0x1a3cfe,'icon':_0x4787e,'order':_0x1745fc,'status':_0x4c518e});}catch(_0x55ccb7){console[_0x2283a7(0x293)](_0x2283a7(0x1ee),_0x55ccb7);}}async[_0x274e85(0x1ed)](_0x37648d,_0x2df5ba){const _0x2ab7e2=_0x274e85,{id:_0x10656d}=_0x2df5ba;if(!_0x10656d)throw new common_1['HttpException'](_0x2ab7e2(0x258),common_1[_0x2ab7e2(0x24e)][_0x2ab7e2(0x244)]);const _0x5f1dbc=await this[_0x2ab7e2(0x1c9)][_0x2ab7e2(0x1bd)]({'where':{'typeId':_0x10656d}});if(_0x5f1dbc)throw new common_1['HttpException']('当前分类下有未处理数据不可移除！',common_1[_0x2ab7e2(0x24e)][_0x2ab7e2(0x244)]);return await this['chatBoxTypeEntity']['delete']({'id':_0x10656d});}async['queryChatBoxType'](){const _0x1ef7b4=_0x274e85;return await this[_0x1ef7b4(0x2b2)]['find']({'order':{'order':_0x1ef7b4(0x1fd)}});}async[_0x274e85(0x228)](_0x36acde,_0x11a208){const _0x183891=_0x274e85,{title:_0x3062d6,prompt:_0x1a1ab1,appId:_0x11d511,order:_0x80dfad,status:_0x2c1184,typeId:_0x4bf2ff,id:_0x3dd6d4,url:_0x261d9e}=_0x11a208;if(!_0x4bf2ff)throw new common_1[(_0x183891(0x1b6))](_0x183891(0x275),common_1[_0x183891(0x24e)]['BAD_REQUEST']);try{const _0x72335e={'title':_0x3062d6,'order':_0x80dfad,'status':_0x2c1184,'typeId':_0x4bf2ff,'url':_0x261d9e};return _0x72335e['appId']=_0x11d511||0x0,_0x72335e[_0x183891(0x248)]=_0x1a1ab1||'',_0x3dd6d4?await this[_0x183891(0x1c9)][_0x183891(0x23b)]({'id':_0x3dd6d4},_0x72335e):await this[_0x183891(0x1c9)][_0x183891(0x257)](_0x72335e);}catch(_0x4d82d3){console[_0x183891(0x293)](_0x183891(0x1ee),_0x4d82d3);}}async[_0x274e85(0x1ba)](_0x45306f,_0x2df574){const _0x5b32a2=_0x274e85,{id:_0x10074d}=_0x2df574;if(!_0x10074d)throw new common_1['HttpException'](_0x5b32a2(0x258),common_1[_0x5b32a2(0x24e)]['BAD_REQUEST']);return await this['chatBoxEntity'][_0x5b32a2(0x280)]({'id':_0x10074d});}async[_0x274e85(0x22e)](){const _0x306307=_0x274e85,_0x58fc92=await this[_0x306307(0x1c9)][_0x306307(0x25e)]({'order':{'order':_0x306307(0x1fd)}}),_0x52fc4c=[...new Set(_0x58fc92[_0x306307(0x219)](_0xa39dd1=>_0xa39dd1[_0x306307(0x1fc)]))],_0x89b8a7=[...new Set(_0x58fc92[_0x306307(0x219)](_0x5511bc=>_0x5511bc[_0x306307(0x20b)]))],_0x31c85a=await this[_0x306307(0x2b2)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x52fc4c)}}),_0x3fbc86=await this[_0x306307(0x1b1)][_0x306307(0x25e)]({'where':{'id':(0x0,typeorm_1['In'])(_0x89b8a7)}});return _0x58fc92[_0x306307(0x219)](_0xfb23ad=>{const _0x114b66=_0x306307,{typeId:_0x2cb522,appId:_0x4978b6}=_0xfb23ad;return _0xfb23ad[_0x114b66(0x1e4)]=_0x31c85a['find'](_0x2ce151=>_0x2ce151['id']===_0x2cb522),_0xfb23ad[_0x114b66(0x255)]=_0x3fbc86[_0x114b66(0x25e)](_0xc3772e=>_0xc3772e['id']===_0x4978b6),_0xfb23ad;});}async[_0x274e85(0x23d)](){const _0x900b38=_0x274e85,_0x44ee51=await this[_0x900b38(0x2b2)][_0x900b38(0x25e)]({'order':{'order':_0x900b38(0x1fd)},'where':{'status':!![]}}),_0x25192e=await this['chatBoxEntity'][_0x900b38(0x25e)]({'where':{'status':!![]}}),_0x412e2b=[...new Set(_0x25192e['map'](_0x5eadaa=>_0x5eadaa['appId']))],_0x52322c=await this[_0x900b38(0x1b1)][_0x900b38(0x25e)]({'where':{'id':(0x0,typeorm_1['In'])(_0x412e2b)}});return _0x25192e[_0x900b38(0x252)](_0x6eeab6=>{const _0xbb1ea2=_0x900b38,_0x57c64a=_0x52322c[_0xbb1ea2(0x25e)](_0x47c721=>_0x47c721['id']===_0x6eeab6[_0xbb1ea2(0x20b)]);return _0x6eeab6['coverImg']=_0x57c64a===null||_0x57c64a===void 0x0?void 0x0:_0x57c64a[_0xbb1ea2(0x264)],_0x6eeab6;}),_0x44ee51[_0x900b38(0x219)](_0x31f825=>{const _0x29bea6=_0x900b38;return _0x31f825['childList']=_0x25192e[_0x29bea6(0x20c)](_0x4c689b=>_0x4c689b[_0x29bea6(0x1fc)]===_0x31f825['id']&&_0x4c689b['status']),_0x31f825;});}async[_0x274e85(0x2a0)](_0x28dfd6,_0x207b5e){const _0x2f9026=_0x274e85;try{const {name:_0x48dd91,icon:_0x25463c,order:_0x5af51b,id:_0x82c4ae,status:_0x5e1b34}=_0x207b5e;return _0x82c4ae?await this['chatPreTypeEntity'][_0x2f9026(0x23b)]({'id':_0x82c4ae},{'name':_0x48dd91,'icon':_0x25463c,'order':_0x5af51b,'status':_0x5e1b34}):await this[_0x2f9026(0x1f0)][_0x2f9026(0x257)]({'name':_0x48dd91,'icon':_0x25463c,'order':_0x5af51b,'status':_0x5e1b34});}catch(_0x2097c2){console[_0x2f9026(0x293)](_0x2f9026(0x1ee),_0x2097c2);}}async[_0x274e85(0x27f)](_0x22e9b3,_0x523e91){const _0x1d9263=_0x274e85,{id:_0x449778}=_0x523e91;if(!_0x449778)throw new common_1[(_0x1d9263(0x1b6))](_0x1d9263(0x258),common_1[_0x1d9263(0x24e)]['BAD_REQUEST']);const _0xed4055=await this['chatBoxEntity'][_0x1d9263(0x1bd)]({'where':{'typeId':_0x449778}});if(_0xed4055)throw new common_1[(_0x1d9263(0x1b6))](_0x1d9263(0x1c8),common_1[_0x1d9263(0x24e)][_0x1d9263(0x244)]);return await this['chatPreTypeEntity'][_0x1d9263(0x280)]({'id':_0x449778});}async['queryChatPreType'](){const _0x496d9a=_0x274e85;return await this['chatPreTypeEntity'][_0x496d9a(0x25e)]({'order':{'order':_0x496d9a(0x1fd)}});}async['setChatPre'](_0x31b404,_0x1e3cc5){const _0x5cf8cb=_0x274e85,{title:_0x3d9ed3,prompt:_0x2ae05e,appId:_0x1fc703,order:_0x3716cc,status:_0x37827b,typeId:_0x112dd4,id:_0x2f6409,url:_0x5e07e2}=_0x1e3cc5;if(!_0x112dd4)throw new common_1[(_0x5cf8cb(0x1b6))](_0x5cf8cb(0x275),common_1['HttpStatus']['BAD_REQUEST']);try{const _0x541445={'title':_0x3d9ed3,'prompt':_0x2ae05e,'order':_0x3716cc,'status':_0x37827b,'typeId':_0x112dd4,'url':_0x5e07e2};return _0x2f6409?await this['chatPreEntity'][_0x5cf8cb(0x23b)]({'id':_0x2f6409},_0x541445):await this[_0x5cf8cb(0x21e)][_0x5cf8cb(0x257)](_0x541445);}catch(_0x41752e){console[_0x5cf8cb(0x293)](_0x5cf8cb(0x1ee),_0x41752e);}}async['delChatPre'](_0x5a0fea,_0xb28d62){const _0x3aa397=_0x274e85,{id:_0x6f4add}=_0xb28d62;if(!_0x6f4add)throw new common_1['HttpException'](_0x3aa397(0x258),common_1[_0x3aa397(0x24e)]['BAD_REQUEST']);return await this['chatPreEntity'][_0x3aa397(0x280)]({'id':_0x6f4add});}async['queryChatPre'](){const _0x381276=_0x274e85,_0x5ba3c5=await this['chatPreEntity'][_0x381276(0x25e)]({'order':{'order':_0x381276(0x1fd)}}),_0x1c2ade=[...new Set(_0x5ba3c5[_0x381276(0x219)](_0x14ebd0=>_0x14ebd0[_0x381276(0x1fc)]))],_0x7dc2fa=await this[_0x381276(0x1f0)][_0x381276(0x25e)]({'where':{'id':(0x0,typeorm_1['In'])(_0x1c2ade)}});return _0x5ba3c5[_0x381276(0x219)](_0x3ec038=>{const _0x64b2bb=_0x381276,{typeId:_0x4030e6,appId:_0x196135}=_0x3ec038;return _0x3ec038['typeInfo']=_0x7dc2fa[_0x64b2bb(0x25e)](_0x19d950=>_0x19d950['id']===_0x4030e6),_0x3ec038;});}async['queryChatPreList'](){const _0x47b3ac=_0x274e85,_0x99fbb3=await this[_0x47b3ac(0x1f0)][_0x47b3ac(0x25e)]({'order':{'order':_0x47b3ac(0x1fd)},'where':{'status':!![]}}),_0x4c00b9=await this[_0x47b3ac(0x21e)][_0x47b3ac(0x25e)]({'where':{'status':!![]}});return _0x99fbb3['map'](_0x15643e=>{const _0x4fc47d=_0x47b3ac;return _0x15643e['childList']=_0x4c00b9[_0x4fc47d(0x20c)](_0x469723=>_0x469723[_0x4fc47d(0x1fc)]===_0x15643e['id']&&_0x469723[_0x4fc47d(0x1eb)]),_0x15643e;});}async[_0x274e85(0x1f4)](_0x588048,_0x5e8de6,_0x25f508){const _0x559668=_0x274e85;let _0x5f2915=0x1000,_0x3364f7=0x800;return _0x588048[_0x559668(0x2a9)]()[_0x559668(0x1e8)]('gpt-4')&&(_0x5f2915=_0x5e8de6>=0x2004?0x2004:_0x5e8de6,_0x3364f7=_0x25f508>=0x1000?0x1000:_0x25f508,_0x588048['toLowerCase']()[_0x559668(0x1e8)]('32k')&&(_0x5f2915=_0x5e8de6>=0x8000?0x8000:_0x5e8de6,_0x3364f7=_0x25f508>=0x3e80?0x3e80:_0x25f508),(_0x588048[_0x559668(0x2a9)]()[_0x559668(0x1e8)]('gpt-4-1106')||_0x588048['toLowerCase']()[_0x559668(0x1e8)](_0x559668(0x2c6)))&&(_0x5f2915=_0x5e8de6>=0x1f400?0x1f400:_0x5e8de6,_0x3364f7=_0x25f508>=0x1000?0x1000:_0x25f508)),_0x588048[_0x559668(0x2a9)]()[_0x559668(0x1e8)](_0x559668(0x2bf))&&(_0x5f2915=_0x5e8de6>=0x1000?0x1000:_0x5e8de6,_0x3364f7=_0x25f508>=0x800?0x800:_0x25f508,_0x588048['toLowerCase']()[_0x559668(0x1e8)](_0x559668(0x284))&&(_0x5f2915=_0x5e8de6>=0x4000?0x4000:_0x5e8de6,_0x3364f7=_0x25f508>=0x1f40?0x1f40:_0x25f508),_0x588048['toLowerCase']()[_0x559668(0x1e8)](_0x559668(0x212))&&(_0x5f2915=_0x5e8de6>=0x4000?0x4000:_0x5e8de6,_0x3364f7=_0x25f508>=0x1f40?0x1f40:_0x25f508)),{'maxToken':_0x5f2915,'maxRes':_0x3364f7};}};ChatgptService=__decorate([(0x0,common_1[_0x274e85(0x29b)])(),__param(0x0,(0x0,typeorm_2[_0x274e85(0x271)])(gptkeys_entity_1[_0x274e85(0x238)])),__param(0x1,(0x0,typeorm_2[_0x274e85(0x271)])(config_entity_1[_0x274e85(0x1d1)])),__param(0x2,(0x0,typeorm_2[_0x274e85(0x271)])(chatBoxType_entity_1['ChatBoxTypeEntity'])),__param(0x3,(0x0,typeorm_2[_0x274e85(0x271)])(chatBox_entity_1[_0x274e85(0x294)])),__param(0x4,(0x0,typeorm_2[_0x274e85(0x271)])(app_entity_1['AppEntity'])),__param(0x5,(0x0,typeorm_2[_0x274e85(0x271)])(chatPreType_entity_1['ChatPreTypeEntity'])),__param(0x6,(0x0,typeorm_2[_0x274e85(0x271)])(chatPre_entity_1['ChatPreEntity'])),__metadata(_0x274e85(0x222),[typeorm_1[_0x274e85(0x1dc)],typeorm_1[_0x274e85(0x1dc)],typeorm_1[_0x274e85(0x1dc)],typeorm_1[_0x274e85(0x1dc)],typeorm_1['Repository'],typeorm_1[_0x274e85(0x1dc)],typeorm_1['Repository'],nestjs_config_1[_0x274e85(0x1d5)],userBalance_service_1[_0x274e85(0x1ce)],chatLog_service_1[_0x274e85(0x224)],user_service_1[_0x274e85(0x276)],upload_service_1[_0x274e85(0x262)],badwords_service_1['BadwordsService'],autoreply_service_1[_0x274e85(0x1ea)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1['FanyiService'],chatGroup_service_1[_0x274e85(0x2bb)],models_service_1['ModelsService']])],ChatgptService),exports[_0x274e85(0x234)]=ChatgptService;