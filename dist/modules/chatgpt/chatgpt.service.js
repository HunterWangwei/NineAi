'use strict';const _0x37187e=_0x25f0;(function(_0x8f9577,_0x1e3f9e){const _0x3038ba=_0x25f0,_0x41f91a=_0x8f9577();while(!![]){try{const _0x137739=-parseInt(_0x3038ba(0x1c4))/0x1+parseInt(_0x3038ba(0x19f))/0x2*(parseInt(_0x3038ba(0x1fa))/0x3)+parseInt(_0x3038ba(0x16c))/0x4*(parseInt(_0x3038ba(0x141))/0x5)+-parseInt(_0x3038ba(0x17f))/0x6+parseInt(_0x3038ba(0x1e3))/0x7*(parseInt(_0x3038ba(0x114))/0x8)+parseInt(_0x3038ba(0x1d4))/0x9+-parseInt(_0x3038ba(0xe7))/0xa;if(_0x137739===_0x1e3f9e)break;else _0x41f91a['push'](_0x41f91a['shift']());}catch(_0x19579f){_0x41f91a['push'](_0x41f91a['shift']());}}}(_0x2d00,0xc078c));function _0x2d00(){const _0x59d5b8=['CHAT_TYPE','当前绘画模型暂未上架、请联系管理员上架此模型！','toISOString','当前模型key已被封禁','validateBalance','unshift','saveChatLog','ModelsService','chatBoxTypeEntity','endsWith','stringify','语音转文字内容:\x20','message','./chatBoxType.entity','billing','defineProperty','./chatPreType.entity','10wAejgx','chatGlobaltools\x20\x20-->\x20error:\x20','userBanance','appId','Bearer\x20','modelsService','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型或更换模型使用！','status','uuid','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','../autoreply/autoreply.service','globalConfigService','当前流程所需要的模型已被管理员下架、请联系管理员上架此模型或更换其他模型使用！','gpt-3.5-turbo','removeSpecialCharacters','model','setChatPreType','decorate','forEach','16k','Repository','error-----:\x20','result','getOwnPropertyDescriptor','importDynamic','\x0a\x20Current\x20date:\x20','chatTextToSpeech','push','chatGlobaltools','prevChatId','delete','abortController','create','speech','queryChatBoxType','badwordsService','./../user/user.service','640895khSPmR','chatSyncFree','fable','InjectRepository','当前模型不是聊天模型','BAD_REQUEST','__esModule','../models/models.service','当前配置模型可能不支持Dall-e-3模型、请检查！','proxyUrl','Please\x20check\x20the\x20back-end\x20console','ChatGroupService','axios','close','quality','prompt','12959037GAuLKo','save','typeId','getUseToolsModelKey','dall-e-3','buildMessageFromParentMessageId','update','./baidu','../../public','error','queryChatPreList','map','length','getMaxTokenFromModelWithOpenAi','chatRealTimeTextToSpeech','63RnfPzN','user','getUuid','getConfigs','../badwords/badwords.service','getTokenCount','realTimeTextToSpeechChat','deductFromBalance','abort','../chatLog/chatLog.service','standard','gptKeysEntity','getDefaultModel','messages','DESC','AppEntity','chatPreTypeEntity','@nestjs/common','./chatBox.entity','modelTypeId','服务异常、请重新试试吧！！！','getModelTypeDetailFromId','path','433053sIiRdK','body','openaiProxyUrl','pipe','tts-1','userBalanceService','@keyv/redis','getClientIp','fanyiService','UploadService','queryChatBox','key','getChatInfoFromId','提供了错误的模型秘钥','9297420sSQCfn','replace','../globalConfig/config.entity','systemMessage','data','./helper','whiteListUser','chatSpeechToText','whisper-1','DeductionKey','extractFilePath','当前语音转文字模型暂未上架、请联系管理员上架此模型！','error:\x20','nineStore','application/json','saveUseLog','childList','chatLogService','OpenAiErrorCodeMessage','REDIS_PASSWORD','weight','getUploadType','chatgpt-nine-ai','setData','getModelProxyUrl','getTtsModelKey','typeorm','Injectable','keyPool','delChatPreType','mjDraw','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','delChatBox','gpt-4-vision-preview','REDIS_USER','delChatPre','/v1','metadata','assistant','checkAutoReply','genPluginSystemMessage','HttpException','key:\x20','onModuleInit','object','144264pcbixQ','gpt-4-1106','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','appEntity','Logger','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','../../common/constants/errorMessage.constant','base64','parse','configService','openaiTimeoutMs','choices','请将语言转为中文简体','BadwordsService','addOneIfOdd','当前模型调用过于频繁、请重新试试吧！','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','statusCode','../chatGroup/chatGroup.service','findOne','is_end','setChatBox','url','UserBalanceService','filter','请添加一个系统内置工具模型用于翻译优化！','UserService','pathname','usage','ChatBoxTypeEntity','../../common/constants/verification.constant','log','绘制图片失败，此次绘画被拒绝了！','env','end','find','default','text','非法操作！','@nestjs/typeorm','openaiBaseUrl','ChatgptService','GptKeysEntity','../userBalance/userBalance.service','assign','5qlnnQG','请输入对话内容','Incorrect\x20API\x20key\x20provided','getFullUrl','system','ConfigService','transcriptions','setChatPre',',\x20最大回复token:\x20','gpt-4','unifiedFormattingResponse','当前分类下有未处理数据不可移除！','modelConfig','count','./gptkeys.entity','autoreplyService','coverImg','typeInfo','getAllKeyList','audio','config','getCurrentModelKeyInfo','sendMessageFromZhipu','./chatPre.entity','toLowerCase','chatPreEntity','gpt-3','sendMessageFromOpenAi','/v1/images/generations','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','缺失必要参数！','本次调用:\x20','AutoreplyService','REDIS_PORT','systemPreMessage','语音转文字失败、请稍后试试吧！','uploadService','realTimeTextToSpeech','ChatPreTypeEntity','POST','function','pluginId','redis://','709164mTfILc','checkBadWords','__decorate','./store','join','../globalConfig/globalConfig.service','HttpStatus','conversationId','post','当前模型key余额已耗尽','setChatBoxType','design:paramtypes','.png','userService','chatBoxEntity','getDeductTypeMap','chatGroupService','PAINT_TYPE','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','853410TukFEX','DrawService','getUseDrawModelKey','../../common/utils','checkUserStatus','\x20model:\x20','debug','response','ChatLogService','draw\x20paompt\x20info\x20<==**==>\x20','createReadStream','includes','lockKey','all','write'];_0x2d00=function(){return _0x59d5b8;};return _0x2d00();}var __decorate=this&&this[_0x37187e(0x16e)]||function(_0x3ca440,_0x53c317,_0x51e3be,_0x4ac74b){const _0x26624a=_0x37187e;var _0x520d09=arguments[_0x26624a(0x1e0)],_0x565a27=_0x520d09<0x3?_0x53c317:_0x4ac74b===null?_0x4ac74b=Object[_0x26624a(0x1b6)](_0x53c317,_0x51e3be):_0x4ac74b,_0x12c14f;if(typeof Reflect===_0x26624a(0x113)&&typeof Reflect[_0x26624a(0x1b0)]===_0x26624a(0x169))_0x565a27=Reflect[_0x26624a(0x1b0)](_0x3ca440,_0x53c317,_0x51e3be,_0x4ac74b);else{for(var _0x52f6c5=_0x3ca440['length']-0x1;_0x52f6c5>=0x0;_0x52f6c5--)if(_0x12c14f=_0x3ca440[_0x52f6c5])_0x565a27=(_0x520d09<0x3?_0x12c14f(_0x565a27):_0x520d09>0x3?_0x12c14f(_0x53c317,_0x51e3be,_0x565a27):_0x12c14f(_0x53c317,_0x51e3be))||_0x565a27;}return _0x520d09>0x3&&_0x565a27&&Object[_0x26624a(0x19d)](_0x53c317,_0x51e3be,_0x565a27),_0x565a27;},__metadata=this&&this['__metadata']||function(_0x3da74e,_0x3cff6d){const _0x52c904=_0x37187e;if(typeof Reflect===_0x52c904(0x113)&&typeof Reflect[_0x52c904(0x10c)]===_0x52c904(0x169))return Reflect[_0x52c904(0x10c)](_0x3da74e,_0x3cff6d);},__param=this&&this['__param']||function(_0x342a8a,_0x4aaa3e){return function(_0x3c5c66,_0x2a7da1){_0x4aaa3e(_0x3c5c66,_0x2a7da1,_0x342a8a);};};Object['defineProperty'](exports,_0x37187e(0x1ca),{'value':!![]}),exports[_0x37187e(0x13d)]=void 0x0;function _0x25f0(_0x2edef5,_0xe9deb3){const _0x2d008f=_0x2d00();return _0x25f0=function(_0x25f05e,_0x584b6d){_0x25f05e=_0x25f05e-0xe3;let _0x1c82c9=_0x2d008f[_0x25f05e];return _0x1c82c9;},_0x25f0(_0x2edef5,_0xe9deb3);}const upload_service_1=require('./../upload/upload.service'),user_service_1=require(_0x37187e(0x1c3)),nestjs_config_1=require('nestjs-config'),common_1=require(_0x37187e(0x1f4)),errorMessage_constant_1=require(_0x37187e(0x11a)),openai_1=require('openai'),utils_1=require(_0x37187e(0x182)),axios_1=require(_0x37187e(0x1d0)),userBalance_service_1=require(_0x37187e(0x13f)),balance_constant_1=require('../../common/constants/balance.constant'),chatLog_service_1=require(_0x37187e(0x1ec)),uuid=require(_0x37187e(0x1a7)),config_entity_1=require(_0x37187e(0xe9)),typeorm_1=require(_0x37187e(0x101)),typeorm_2=require(_0x37187e(0x13b)),badwords_service_1=require(_0x37187e(0x1e7)),autoreply_service_1=require(_0x37187e(0x1a9)),gptkeys_entity_1=require(_0x37187e(0x14f)),globalConfig_service_1=require(_0x37187e(0x171)),fanyi_service_1=require('../fanyi/fanyi.service'),app_entity_1=require('../app/app.entity'),chatGroup_service_1=require(_0x37187e(0x126)),models_service_1=require(_0x37187e(0x1cb)),baidu_1=require(_0x37187e(0x1db)),helper_1=require(_0x37187e(0xec)),store_1=require(_0x37187e(0x16f)),zhipu_1=require('./zhipu'),openai_2=require('./openai'),chatBoxType_entity_1=require(_0x37187e(0x19b)),chatBox_entity_1=require(_0x37187e(0x1f5)),chatPre_entity_1=require(_0x37187e(0x158)),chatPreType_entity_1=require(_0x37187e(0x19e)),fs=require('fs'),path_1=require(_0x37187e(0x1f9)),verification_constant_1=require(_0x37187e(0x132));let ChatgptService=class ChatgptService{constructor(_0x21bcc1,_0x50859a,_0x111a93,_0x4a7d80,_0x2ac06e,_0x49b653,_0x18d805,_0x3f8c2e,_0x2741e7,_0x26111b,_0x384e34,_0x45951c,_0x3dda7c,_0x16e364,_0x231197,_0x12601b,_0x3ad15c,_0x5d9478){const _0x1057d5=_0x37187e;this[_0x1057d5(0x1ee)]=_0x21bcc1,this['configEntity']=_0x50859a,this[_0x1057d5(0x196)]=_0x111a93,this[_0x1057d5(0x17a)]=_0x4a7d80,this['appEntity']=_0x2ac06e,this['chatPreTypeEntity']=_0x49b653,this[_0x1057d5(0x15a)]=_0x18d805,this[_0x1057d5(0x11d)]=_0x3f8c2e,this['userBalanceService']=_0x2741e7,this[_0x1057d5(0xf8)]=_0x26111b,this[_0x1057d5(0x179)]=_0x384e34,this[_0x1057d5(0x165)]=_0x45951c,this[_0x1057d5(0x1c2)]=_0x3dda7c,this[_0x1057d5(0x150)]=_0x16e364,this[_0x1057d5(0x1aa)]=_0x231197,this[_0x1057d5(0x202)]=_0x12601b,this[_0x1057d5(0x17c)]=_0x3ad15c,this['modelsService']=_0x5d9478,this[_0x1057d5(0xf4)]=null,this[_0x1057d5(0xed)]=[],this[_0x1057d5(0x103)]={'list3':[],'list4':[]};}async[_0x37187e(0x112)](){const _0x234644=_0x37187e;let _0xd6c7bc=await(0x0,utils_1[_0x234644(0x1b7)])(_0x234644(0xfd)),_0x21a839=await(0x0,utils_1[_0x234644(0x1b7)])(_0x234644(0x200)),_0x2cb8f2=await(0x0,utils_1[_0x234644(0x1b7)])('keyv');_0xd6c7bc=(_0xd6c7bc===null||_0xd6c7bc===void 0x0?void 0x0:_0xd6c7bc['default'])?_0xd6c7bc[_0x234644(0x138)]:_0xd6c7bc,_0x21a839=(_0x21a839===null||_0x21a839===void 0x0?void 0x0:_0x21a839['default'])?_0x21a839[_0x234644(0x138)]:_0x21a839,_0x2cb8f2=(_0x2cb8f2===null||_0x2cb8f2===void 0x0?void 0x0:_0x2cb8f2['default'])?_0x2cb8f2['default']:_0x2cb8f2;const {ChatGPTAPI:_0x1b4998,ChatGPTError:_0x9bd529,ChatGPTUnofficialProxyAPI:_0x11ea6c}=_0xd6c7bc,_0x12ae4b=+process['env'][_0x234644(0x162)],_0x295958=process[_0x234644(0x135)]['REDIS_HOST'],_0x445a7e=process[_0x234644(0x135)][_0x234644(0xfa)],_0x3fc748=process['env'][_0x234644(0x109)],_0x5d0f04=_0x234644(0x16b)+(_0x3fc748||'')+':'+(_0x445a7e||'')+'@'+_0x295958+':'+_0x12ae4b,_0x5c9597=new _0x21a839(_0x5d0f04),_0x2bf852=new _0x2cb8f2({'store':_0x5c9597,'namespace':'nineai-chatlog'});this[_0x234644(0xf4)]=new store_1['NineStore']({'store':_0x2bf852,'namespace':'chat'});}async[_0x37187e(0x1c5)](_0x1020b1){const _0x813e6a=_0x37187e,_0x20b04c=await this[_0x813e6a(0x1a4)][_0x813e6a(0x1ef)]();if(!_0x20b04c)return;const {model:_0x1e942f,maxTokens:_0x13573e}=_0x20b04c,_0x470150=await this['modelsService'][_0x813e6a(0x156)](_0x20b04c['id']);if(!_0x470150)return;const _0x461532=await this[_0x813e6a(0x1aa)][_0x813e6a(0x1e6)](['systemPreMessage']),{key:_0x606147,proxyUrl:_0x12deed}=_0x470150,{context:_0x4e2e3b}=await this[_0x813e6a(0xf4)][_0x813e6a(0x1d9)](_0x1020b1,{'parentMessageId':'','systemMessage':_0x461532});try{const _0x33cdfb=await(0x0,openai_2[_0x813e6a(0x15c)])(_0x4e2e3b,{'apiKey':(0x0,utils_1[_0x813e6a(0x1ad)])(_0x606147),'model':_0x1e942f,'proxyUrl':_0x12deed,'maxToken':_0x13573e,'onProgress':null});return _0x33cdfb===null||_0x33cdfb===void 0x0?void 0x0:_0x33cdfb[_0x813e6a(0x139)];}catch(_0x402b3f){console[_0x813e6a(0x133)](_0x813e6a(0xf3),_0x402b3f);}}[_0x37187e(0xf1)](_0x2a78fd){const _0x4870a0=_0x37187e,_0x1c867e=new URL(_0x2a78fd);return _0x1c867e[_0x4870a0(0x12f)];}async[_0x37187e(0x1bb)](_0x553590){const _0x135bad=_0x37187e;var _0x385365;try{const _0x3c59b5=await this[_0x135bad(0x1a4)][_0x135bad(0x1d7)]();if(!_0x3c59b5)throw new common_1[(_0x135bad(0x110))](_0x135bad(0x12d),common_1['HttpStatus'][_0x135bad(0x1c9)]);const {key:_0x31620f,proxyUrl:_0x11dd3b}=_0x3c59b5,{systemMessage:_0x3c3ae4,prompt:_0xfe1780}=_0x553590,_0x3d5c41={'method':_0x135bad(0x168),'url':(0x0,openai_2[_0x135bad(0x144)])(_0x11dd3b),'headers':{'Content-Type':_0x135bad(0xf5),'Authorization':_0x135bad(0x1a3)+(0x0,utils_1[_0x135bad(0x1ad)])(_0x31620f)},'data':{'max_tokens':0xbb8,'model':_0x135bad(0x1ac),'messages':[{'role':_0x135bad(0x1e4),'content':_0xfe1780}]}};_0x3c3ae4&&_0x3d5c41[_0x135bad(0xeb)][_0x135bad(0x1f0)][_0x135bad(0x193)]({'role':_0x135bad(0x145),'content':_0x3c3ae4});const _0x40438c=await(0x0,axios_1['default'])(_0x3d5c41);return((_0x385365=_0x40438c===null||_0x40438c===void 0x0?void 0x0:_0x40438c[_0x135bad(0xeb)])===null||_0x385365===void 0x0?void 0x0:_0x385365[_0x135bad(0x11f)][0x0]['message']['content'])||_0xfe1780;}catch(_0x5c0720){return console['log'](_0x135bad(0x1a0),_0x5c0720),prompt;}}async[_0x37187e(0xee)](_0xc499d1){const _0x2ad45d=_0x37187e,_0x3018dd=await this[_0x2ad45d(0x1a4)][_0x2ad45d(0x100)]();if(!_0x3018dd)throw new common_1[(_0x2ad45d(0x110))]('当前语音转文字模型暂未上架、请联系管理员上架此模型！',common_1[_0x2ad45d(0x172)][_0x2ad45d(0x1c9)]);const {key:_0x257306,proxyUrl:_0x1fb421}=_0x3018dd,_0x30350f=_0x1fb421[_0x2ad45d(0x197)]('/')?_0x1fb421+'v1':_0x1fb421+'/v1',_0x2d0198=new openai_1[(_0x2ad45d(0x138))]({'baseURL':_0x30350f,'apiKey':_0x257306}),_0xa2aaa2=this[_0x2ad45d(0xf1)](_0xc499d1),_0x164dc1=(0x0,path_1[_0x2ad45d(0x170)])(__dirname,_0x2ad45d(0x1dc),_0xa2aaa2)[_0x2ad45d(0xe8)]('/dist',''),_0x2b00e0=await _0x2d0198[_0x2ad45d(0x154)][_0x2ad45d(0x147)]['create']({'model':_0x2ad45d(0xef),'prompt':_0x2ad45d(0x120),'file':fs[_0x2ad45d(0x189)](_0x164dc1)});return console['log'](_0x2ad45d(0x199),_0x2b00e0===null||_0x2b00e0===void 0x0?void 0x0:_0x2b00e0['text']),this[_0x2ad45d(0x1a4)]['saveUseLog'](_0x3018dd===null||_0x3018dd===void 0x0?void 0x0:_0x3018dd['id'],_0x3018dd===null||_0x3018dd===void 0x0?void 0x0:_0x3018dd[_0x2ad45d(0x1f6)],0x0),(_0x2b00e0===null||_0x2b00e0===void 0x0?void 0x0:_0x2b00e0['text'])||null;}async[_0x37187e(0x1e2)](_0x9a4717,_0x470748,_0x2d01e6){const _0x25b3b8=_0x37187e,{name:name='fable',text:text=''}=_0x2d01e6;try{const _0x4af198=await this['modelsService']['getTtsModelKey']();if(!_0x4af198)throw new common_1[(_0x25b3b8(0x110))](_0x25b3b8(0xf2),common_1[_0x25b3b8(0x172)][_0x25b3b8(0x1c9)]);const {key:_0xdb2ae1,proxyUrl:_0x4a29e7}=_0x4af198,_0x4c23aa=_0x4a29e7['endsWith']('/')?_0x4a29e7+'v1':_0x4a29e7+'/v1',_0x517d3e=new openai_1[(_0x25b3b8(0x138))]({'baseURL':_0x4c23aa,'apiKey':_0xdb2ae1}),_0x3c7511=await _0x517d3e['audio'][_0x25b3b8(0x1c0)][_0x25b3b8(0x1bf)]({'model':_0x25b3b8(0x1fe),'voice':name,'input':text});this[_0x25b3b8(0x1a4)][_0x25b3b8(0xf6)](_0x4af198===null||_0x4af198===void 0x0?void 0x0:_0x4af198['id'],_0x4af198===null||_0x4af198===void 0x0?void 0x0:_0x4af198[_0x25b3b8(0x1f6)],0x0),_0x3c7511[_0x25b3b8(0x1fb)]['pipe'](_0x9a4717);}catch(_0x4c5191){console[_0x25b3b8(0x133)](_0x25b3b8(0xf3),_0x4c5191);throw new common_1[(_0x25b3b8(0x110))](_0x25b3b8(0x164),common_1[_0x25b3b8(0x172)][_0x25b3b8(0x1c9)]);}}async[_0x37187e(0x1e9)](_0x16b4a2,_0x3c6d16){const _0x124e9b=_0x37187e,{id:_0x18f293,voiceType:_0x3a820a}=_0x3c6d16;if(!_0x18f293)return;const _0x29fec3=await this['chatLogService'][_0x124e9b(0xe5)](_0x18f293);if(!_0x29fec3)return;const {answer:_0xed1b2d,prompt:_0x226055}=_0x29fec3,_0x26345d=_0xed1b2d||_0x226055;return this[_0x124e9b(0x166)](_0x16b4a2,_0x26345d,_0x3a820a);}async['realTimeTextToSpeech'](_0x2a8d34,_0x5180a8,_0x4751af=_0x37187e(0x1c6)){const _0xee1e45=_0x37187e,_0x24dfd0=await this[_0xee1e45(0x1a4)]['getTtsModelKey']();if(!_0x24dfd0)throw new common_1[(_0xee1e45(0x110))](_0xee1e45(0xf2),common_1[_0xee1e45(0x172)]['BAD_REQUEST']);const {key:_0x9df698,proxyUrl:_0x42e45f}=_0x24dfd0,_0x158c2b=_0x42e45f[_0xee1e45(0x197)]('/')?_0x42e45f+'v1':_0x42e45f+_0xee1e45(0x10b),_0x24d3a6=new openai_1[(_0xee1e45(0x138))]({'baseURL':_0x158c2b,'apiKey':_0x9df698}),_0x493d11=await _0x24d3a6[_0xee1e45(0x154)][_0xee1e45(0x1c0)]['create']({'model':_0xee1e45(0x1fe),'voice':_0x4751af,'input':_0x5180a8});_0x493d11['body'][_0xee1e45(0x1fd)](_0x2a8d34);}async[_0x37187e(0x1b9)](_0x5f3456){const _0x2a08d6=_0x37187e;try{const _0x2ff989=await this['modelsService']['getTtsModelKey']();if(!_0x2ff989)throw new common_1['HttpException'](_0x2a08d6(0xf2),common_1[_0x2a08d6(0x172)][_0x2a08d6(0x1c9)]);const {key:_0x1d5252,proxyUrl:_0x720a54}=_0x2ff989,_0x493b8f=_0x720a54[_0x2a08d6(0x197)]('/')?_0x720a54+'v1':_0x720a54+_0x2a08d6(0x10b),_0xba922a=new openai_1[(_0x2a08d6(0x138))]({'baseURL':_0x493b8f,'apiKey':_0x1d5252});}catch(_0x3afa22){console[_0x2a08d6(0x133)](_0x2a08d6(0xf3),_0x3afa22);throw new common_1[(_0x2a08d6(0x110))](_0x2a08d6(0x164),common_1[_0x2a08d6(0x172)]['BAD_REQUEST']);}}async['chatProcess'](_0x439dd4,_0x1d78b5,_0xa69584){const _0x317ca5=_0x37187e;var _0x31a156;const _0x1230ad=_0x1d78b5[_0x317ca5(0x1be)],{options:options={},appId:_0x3c63eb,cusromPrompt:_0x25b06f,systemMessage:systemMessage='',tts:tts=''}=_0x439dd4;let _0x78fd3=_0x439dd4[_0x317ca5(0x1d3)];const {parentMessageId:_0x51df7d,file:_0x3afa56,groupId:_0x459619,usingNetwork:_0x29cf4b}=options;let _0x22cc51=systemMessage,_0x379e33=_0x3afa56;if(!tts&&!_0x78fd3&&!_0x3afa56)throw new common_1[(_0x317ca5(0x110))](_0x317ca5(0x142),common_1[_0x317ca5(0x172)][_0x317ca5(0x1c9)]);if(tts){const _0x1b5de6=await this[_0x317ca5(0xee)](tts);if(!_0x1b5de6)throw new common_1['HttpException']('语音转文字识别失败、请稍后试试吧！',common_1[_0x317ca5(0x172)][_0x317ca5(0x1c9)]);_0x78fd3=_0x1b5de6;}const _0x23a14f=await this[_0x317ca5(0x17c)]['getGroupInfoFromId'](_0x459619),_0x470edf=(_0x23a14f===null||_0x23a14f===void 0x0?void 0x0:_0x23a14f[_0x317ca5(0x16a)])||0x0;let _0x2a0195=(_0x23a14f===null||_0x23a14f===void 0x0?void 0x0:_0x23a14f[_0x317ca5(0x155)])?JSON[_0x317ca5(0x11c)](_0x23a14f[_0x317ca5(0x155)]):null;(!_0x2a0195||!_0x2a0195[_0x317ca5(0x1f6)]||!_0x2a0195[_0x317ca5(0x14d)])&&!_0x470edf&&(_0x2a0195=await this[_0x317ca5(0x1a4)]['getBaseConfig']());let _0x9770b9=0x0,_0x52abb8='',_0x9c6493=null;_0x470edf&&(_0x9770b9=await this[_0x317ca5(0x1a4)]['getModelTypeIdFromPluginId'](_0x470edf));if(_0x3c63eb){const _0xc3bdba=await this[_0x317ca5(0x117)][_0x317ca5(0x127)]({'where':{'id':_0x3c63eb,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0xc3bdba)throw new common_1[(_0x317ca5(0x110))](_0x317ca5(0x119),common_1[_0x317ca5(0x172)][_0x317ca5(0x1c9)]);const {modelTypeId:_0x401a38,isGpts:_0x8f757c,preset:_0x464061,gptsId:_0x9cf297}=_0xc3bdba;if(_0x8f757c){_0x9770b9=await this[_0x317ca5(0x1a4)]['getModelTypeIdFromGpts']();if(!_0x9770b9)throw new common_1[(_0x317ca5(0x110))]('当前应用使用的模型已被管理员下架、请联系管理员上架此模型！',common_1[_0x317ca5(0x172)][_0x317ca5(0x1c9)]);_0x9c6493=_0x9cf297;}else _0x9770b9=_0x401a38,_0x52abb8=_0x464061;}(!_0x470edf&&!_0x3c63eb||!_0x9770b9)&&(_0x9770b9=_0x2a0195[_0x317ca5(0x1f6)]);const _0x9afd25=await this['modelsService'][_0x317ca5(0x1f8)](_0x9770b9);if(!_0x9afd25)throw new common_1[(_0x317ca5(0x110))](_0x317ca5(0x1ab),common_1['HttpStatus'][_0x317ca5(0x1c9)]);const {deduct:_0x382983,deductType:_0x2a3b01,model:_0x2d2ba9,maxTokens:_0x2c8f57,modelType:_0x349aab,modelName:_0x1b1f22}=_0x9afd25,{systemMessage:_0x4fb369,topN:_0x2bff73,maxResponseTokens:_0x52a3b6,rounds:_0x384f98}=_0x2a0195['modelConfig'];let _0x53a4fe=null;!_0x25b06f?_0x53a4fe=await this[_0x317ca5(0x1a4)][_0x317ca5(0x156)](_0x9770b9):_0x53a4fe=await this[_0x317ca5(0x1a4)]['getUseToolsModelKey']();if(!_0x53a4fe)throw new common_1[(_0x317ca5(0x110))](_0x317ca5(0x1a5),common_1['HttpStatus'][_0x317ca5(0x1c9)]);const {key:_0x5c6bbe,secret:_0x3c628d,id:_0x4fe42e,accessToken:_0x59f4ec,proxyUrl:_0x132a26}=_0x53a4fe;await this[_0x317ca5(0x179)][_0x317ca5(0x183)](_0x1d78b5[_0x317ca5(0x1e4)]),await this['userBalanceService'][_0x317ca5(0x192)](_0x1d78b5,(0x0,verification_constant_1[_0x317ca5(0x17b)])(_0x2a3b01),_0x382983),_0xa69584&&_0xa69584['setHeader']('Content-type','application/octet-stream;\x20charset=utf-8'),await this[_0x317ca5(0x1c2)][_0x317ca5(0x16d)](_0x78fd3,_0x1d78b5['user']['id']);const _0x5451cb=await this[_0x317ca5(0x150)][_0x317ca5(0x10e)](_0x78fd3);if(_0x5451cb&&_0xa69584){const _0x6d7de1={'message':_0x5451cb,'code':0x1f4};return _0xa69584[_0x317ca5(0x18d)](JSON[_0x317ca5(0x198)](_0x6d7de1)),_0xa69584[_0x317ca5(0x136)]();}if(_0x3c63eb)_0x52abb8&&(_0x22cc51=_0x52abb8);else{if(_0x25b06f)_0x22cc51=_0x439dd4[_0x317ca5(0xea)];else{if(_0x4fb369)_0x22cc51=_0x4fb369;else{const _0x1cd67f=new Date()[_0x317ca5(0x190)]()['split']('T')[0x0],_0x409b18=await this[_0x317ca5(0x1aa)][_0x317ca5(0x1e6)]([_0x317ca5(0x163)]);_0x22cc51=_0x409b18+(_0x317ca5(0x1b8)+_0x1cd67f);}}}if(_0x470edf){_0x22cc51=null;const {imgUrl:_0x12d7ad,documentUrl:_0x2c71a4}=_0x23a14f;_0x379e33=_0x12d7ad||_0x2c71a4,_0x22cc51=(0x0,helper_1[_0x317ca5(0x10f)])(Object['assign'](Object['assign']({},_0x23a14f),{'pluginId':_0x470edf}));}_0xa69584&&_0xa69584[_0x317ca5(0x1a6)](0xc8);let _0x298bc3=null,_0x327b61=null;try{if(_0xa69584){let _0x392257=null,_0x1c9f0c=![];_0xa69584['on'](_0x317ca5(0x1d1),async()=>{const _0x2894fe=_0x317ca5;if(_0x1c9f0c)return;_0x1230ad[_0x2894fe(0x1eb)]();const _0x1f05d9=await(0x0,openai_2[_0x2894fe(0x1e8)])(_0x78fd3)||0x0,_0x1cd6b3=await(0x0,openai_2[_0x2894fe(0x1e8)])(_0x392257===null||_0x392257===void 0x0?void 0x0:_0x392257[_0x2894fe(0x139)])||0x0,_0x8c9e37=_0x1f05d9+_0x1cd6b3,_0xc85739=(0x0,utils_1['getClientIp'])(_0x1d78b5);await this['chatLogService']['saveChatLog']({'appId':_0x3c63eb,'curIp':_0xc85739,'userId':_0x1d78b5[_0x2894fe(0x1e4)]['id'],'type':balance_constant_1[_0x2894fe(0xf0)][_0x2894fe(0x18e)],'prompt':_0x78fd3,'answer':'','promptTokens':_0x1f05d9,'completionTokens':0x0,'totalTokens':_0x1f05d9,'model':_0x2d2ba9,'role':_0x2894fe(0x1e4),'groupId':_0x459619,'tts':tts,'file':_0x379e33,'requestOptions':JSON[_0x2894fe(0x198)]({'options':null,'prompt':_0x78fd3})}),await this[_0x2894fe(0xf8)][_0x2894fe(0x194)]({'appId':_0x3c63eb,'curIp':_0xc85739,'userId':_0x1d78b5[_0x2894fe(0x1e4)]['id'],'type':balance_constant_1[_0x2894fe(0xf0)][_0x2894fe(0x18e)],'prompt':_0x78fd3,'answer':_0x392257===null||_0x392257===void 0x0?void 0x0:_0x392257['text'],'promptTokens':_0x1f05d9,'completionTokens':_0x1cd6b3,'totalTokens':_0x8c9e37,'model':_0x2d2ba9,'role':'assistant','groupId':_0x459619,'requestOptions':JSON[_0x2894fe(0x198)]({'options':{'model':_0x2d2ba9,'temperature':_0x2bff73},'prompt':_0x78fd3}),'conversationOptions':JSON[_0x2894fe(0x198)]({'conversationId':_0x392257===null||_0x392257===void 0x0?void 0x0:_0x392257[_0x2894fe(0x173)],'model':_0x2d2ba9,'parentMessageId':_0x392257===null||_0x392257===void 0x0?void 0x0:_0x392257['id'],'temperature':_0x2bff73})}),await this[_0x2894fe(0x1ff)][_0x2894fe(0x1ea)](_0x1d78b5[_0x2894fe(0x1e4)]['id'],_0x2894fe(0x1ae)+(_0x2a3b01===0x1?0x3:0x4),_0x382983,_0x8c9e37);});const _0x5b4ba1=_0x78fd3;if(Number(_0x349aab)===0x1){const {context:_0x43a3bc,maxTokens:_0x499d91}=await this[_0x317ca5(0xf4)]['buildMessageFromParentMessageId'](_0x5b4ba1,{'parentMessageId':_0x51df7d,'systemMessage':_0x22cc51,'maxModelToken':_0x2c8f57,'maxResponseTokens':_0x52a3b6,'maxRounds':(0x0,helper_1[_0x317ca5(0x122)])(_0x384f98),'file':_0x379e33});let _0x4ccb63=!![];_0x298bc3=await(0x0,openai_2[_0x317ca5(0x15c)])(_0x43a3bc,{'maxToken':_0x52a3b6,'apiKey':_0x5c6bbe,'model':_0x2d2ba9,'temperature':_0x2bff73,'proxyUrl':_0x132a26,'usingNetwork':_0x29cf4b,'gptsId':_0x9c6493,'onProgress':_0x4c990c=>{const _0x580d6c=_0x317ca5;_0xa69584[_0x580d6c(0x18d)](_0x4ccb63?JSON[_0x580d6c(0x198)](_0x4c990c):'\x0a'+JSON[_0x580d6c(0x198)](_0x4c990c)),_0x392257=_0x4c990c,_0x4ccb63=![];}}),_0x1c9f0c=!![];}if(Number(_0x349aab)===0x2){let _0x17c9df=!![];const {context:_0x3662f9}=await this[_0x317ca5(0xf4)]['buildMessageFromParentMessageId'](_0x78fd3,{'parentMessageId':_0x51df7d,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x384f98)});_0x298bc3=await(0x0,baidu_1['sendMessageFromBaidu'])(_0x3662f9,{'temperature':_0x2bff73,'accessToken':_0x59f4ec,'model':_0x2d2ba9,'onProgress':_0x51a1e3=>{const _0x184184=_0x317ca5;_0xa69584[_0x184184(0x18d)](_0x17c9df?JSON['stringify'](_0x51a1e3):'\x0a'+JSON['stringify'](_0x51a1e3)),_0x17c9df=![],_0x392257=_0x51a1e3;}}),_0x1c9f0c=!![];}if(Number(_0x349aab)===0x3){let _0x4fd443=!![];const {context:_0x1088fa}=await this[_0x317ca5(0xf4)]['buildMessageFromParentMessageId'](_0x78fd3,{'parentMessageId':_0x51df7d,'maxRounds':(0x0,helper_1[_0x317ca5(0x122)])(_0x384f98)});_0x298bc3=await(0x0,zhipu_1[_0x317ca5(0x157)])(_0x1088fa,{'temperature':_0x2bff73,'key':_0x5c6bbe,'model':_0x2d2ba9,'onProgress':_0x13c4a1=>{const _0x2232a5=_0x317ca5;_0xa69584[_0x2232a5(0x18d)](_0x4fd443?JSON['stringify'](_0x13c4a1):'\x0a'+JSON[_0x2232a5(0x198)](_0x13c4a1)),_0x4fd443=![],_0x392257=_0x13c4a1;}}),_0x1c9f0c=!![];}const _0x50507f={'id':this[_0x317ca5(0xf4)][_0x317ca5(0x1e5)](),'text':_0x78fd3,'file':_0x379e33,'role':_0x317ca5(0x1e4),'name':undefined,'usage':null,'parentMessageId':_0x51df7d,'conversationId':_0x298bc3===null||_0x298bc3===void 0x0?void 0x0:_0x298bc3[_0x317ca5(0x173)]};_0x327b61={'model':_0x2d2ba9,'parentMessageId':_0x51df7d},await this['nineStore'][_0x317ca5(0xfe)](_0x50507f);const _0x4395c3={'id':_0x298bc3['id'],'text':_0x298bc3[_0x317ca5(0x139)],'role':'assistant','name':undefined,'usage':_0x298bc3[_0x317ca5(0x130)],'parentMessageId':_0x50507f['id'],'conversationId':_0x298bc3===null||_0x298bc3===void 0x0?void 0x0:_0x298bc3[_0x317ca5(0x173)]};await this['nineStore'][_0x317ca5(0xfe)](_0x4395c3),_0x327b61={'model':_0x2d2ba9,'parentMessageId':_0x50507f['id']};}else{const _0x196220=_0x78fd3,{context:_0x1b19eb}=await this[_0x317ca5(0xf4)]['buildMessageFromParentMessageId'](_0x196220,{'parentMessageId':_0x51df7d,'systemMessage':_0x22cc51,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x384f98)});_0x298bc3=await(0x0,openai_2[_0x317ca5(0x15c)])(_0x1b19eb,{'apiKey':_0x5c6bbe,'model':_0x2d2ba9,'temperature':_0x2bff73,'proxyUrl':_0x132a26,'onProgress':null});}const _0x30c7b=await(0x0,helper_1[_0x317ca5(0x14b)])(_0x349aab,_0x298bc3,_0x327b61),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x30c7b[_0x317ca5(0x130)];await this['userBalanceService'][_0x317ca5(0x1ea)](_0x1d78b5[_0x317ca5(0x1e4)]['id'],'model'+(_0x2a3b01===0x1?0x3:0x4),_0x382983,total_tokens),await this[_0x317ca5(0x1a4)]['saveUseLog'](_0x4fe42e,_0x9770b9,total_tokens);const _0x455c5d=(0x0,utils_1[_0x317ca5(0x201)])(_0x1d78b5),_0x2b0deb=await this[_0x317ca5(0xf8)]['saveChatLog']({'appId':_0x3c63eb,'curIp':_0x455c5d,'userId':_0x1d78b5[_0x317ca5(0x1e4)]['id'],'type':balance_constant_1[_0x317ca5(0xf0)][_0x317ca5(0x18e)],'prompt':_0x78fd3,'answer':'','promptTokens':prompt_tokens,'completionTokens':0x0,'totalTokens':total_tokens,'model':(_0x30c7b===null||_0x30c7b===void 0x0?void 0x0:_0x30c7b[_0x317ca5(0x1ae)])||_0x2d2ba9,'role':_0x317ca5(0x1e4),'groupId':_0x459619,'tts':tts,'file':_0x379e33,'requestOptions':JSON[_0x317ca5(0x198)]({'options':null,'prompt':_0x78fd3})}),_0x39950b=await this[_0x317ca5(0xf8)][_0x317ca5(0x194)]({'appId':_0x3c63eb,'curIp':_0x455c5d,'userId':_0x1d78b5[_0x317ca5(0x1e4)]['id'],'type':balance_constant_1[_0x317ca5(0xf0)][_0x317ca5(0x18e)],'prompt':_0x78fd3,'answer':_0x30c7b===null||_0x30c7b===void 0x0?void 0x0:_0x30c7b[_0x317ca5(0x139)],'promptTokens':prompt_tokens,'completionTokens':completion_tokens,'totalTokens':total_tokens,'model':(_0x30c7b===null||_0x30c7b===void 0x0?void 0x0:_0x30c7b['model'])||_0x2d2ba9,'role':_0x317ca5(0x10d),'groupId':_0x459619,'requestOptions':JSON['stringify']({'options':{'model':_0x2d2ba9,'temperature':_0x2bff73},'prompt':_0x78fd3}),'conversationOptions':JSON[_0x317ca5(0x198)]({'conversationId':_0x298bc3[_0x317ca5(0x173)],'model':_0x2d2ba9,'parentMessageId':_0x298bc3['id'],'temperature':_0x2bff73})});common_1[_0x317ca5(0x118)][_0x317ca5(0x185)](_0x317ca5(0x160)+_0x1d78b5['user']['id']+_0x317ca5(0x184)+_0x2d2ba9+'\x20key\x20->\x20'+_0x5c6bbe+',\x20模型名称:\x20'+_0x1b1f22+_0x317ca5(0x149)+_0x52a3b6,_0x317ca5(0x13d));const _0x1ca03a=await this[_0x317ca5(0x1ff)]['queryUserBalance'](_0x1d78b5[_0x317ca5(0x1e4)]['id']);return _0x298bc3[_0x317ca5(0x1a1)]=Object[_0x317ca5(0x140)]({},_0x1ca03a),_0x298bc3['chatId']=_0x39950b['id'],_0x298bc3[_0x317ca5(0x1bc)]=_0x2b0deb['id'],_0x298bc3[_0x317ca5(0x1b5)]&&(_0x298bc3[_0x317ca5(0x1b5)]=''),_0x298bc3[_0x317ca5(0x128)]=!![],_0xa69584?_0xa69584[_0x317ca5(0x18d)]('\x0a'+JSON[_0x317ca5(0x198)](_0x298bc3)):_0x298bc3[_0x317ca5(0x139)];}catch(_0x7fed7f){const _0x5e2c6c=(_0x7fed7f===null||_0x7fed7f===void 0x0?void 0x0:_0x7fed7f[_0x317ca5(0x125)])||0x190,_0x481b57=((_0x31a156=_0x7fed7f===null||_0x7fed7f===void 0x0?void 0x0:_0x7fed7f[_0x317ca5(0x186)])===null||_0x31a156===void 0x0?void 0x0:_0x31a156[_0x317ca5(0x1a6)])||(_0x7fed7f===null||_0x7fed7f===void 0x0?void 0x0:_0x7fed7f[_0x317ca5(0x125)])||0x190;if(_0x7fed7f['status']&&_0x7fed7f['status']===0x192){const _0x466e41={'message':'Catch\x20Error\x20'+_0x7fed7f[_0x317ca5(0x19a)],'code':0x192};if(_0xa69584)return _0xa69584[_0x317ca5(0x18d)](JSON[_0x317ca5(0x198)](_0x466e41));else throw new common_1[(_0x317ca5(0x110))](_0x7fed7f[_0x317ca5(0x19a)],common_1[_0x317ca5(0x172)]['PAYMENT_REQUIRED']);}if(!_0x481b57){if(_0xa69584)return _0xa69584[_0x317ca5(0x18d)](JSON['stringify']({'message':_0x7fed7f[_0x317ca5(0x19a)],'code':0x1f4}));else throw new common_1[(_0x317ca5(0x110))](_0x7fed7f[_0x317ca5(0x19a)],common_1[_0x317ca5(0x172)][_0x317ca5(0x1c9)]);}let _0x286e80=errorMessage_constant_1[_0x317ca5(0xf9)][_0x481b57]?errorMessage_constant_1[_0x317ca5(0xf9)][_0x481b57]:_0x317ca5(0x1f7);(_0x7fed7f===null||_0x7fed7f===void 0x0?void 0x0:_0x7fed7f['message'][_0x317ca5(0x18a)](_0x317ca5(0x106)))&&Number(_0x349aab)===0x1&&(await this[_0x317ca5(0x1a4)]['lockKey'](_0x4fe42e,_0x317ca5(0x1a8),-0x1),_0x286e80=_0x317ca5(0x191));(_0x7fed7f===null||_0x7fed7f===void 0x0?void 0x0:_0x7fed7f['statusCode'])===0x1ad&&_0x7fed7f[_0x317ca5(0x19a)][_0x317ca5(0x18a)](_0x317ca5(0x19c))&&Number(_0x349aab)===0x1&&(await this[_0x317ca5(0x1a4)][_0x317ca5(0x18b)](_0x4fe42e,_0x317ca5(0x124),-0x3),_0x286e80=_0x317ca5(0x175));(_0x7fed7f===null||_0x7fed7f===void 0x0?void 0x0:_0x7fed7f[_0x317ca5(0x125)])===0x1ad&&(_0x7fed7f===null||_0x7fed7f===void 0x0?void 0x0:_0x7fed7f['statusText'])==='Too\x20Many\x20Requests'&&(_0x286e80=_0x317ca5(0x123));(_0x7fed7f===null||_0x7fed7f===void 0x0?void 0x0:_0x7fed7f['statusCode'])===0x191&&_0x7fed7f[_0x317ca5(0x19a)]['includes'](_0x317ca5(0x143))&&Number(_0x349aab)===0x1&&(await this['modelsService'][_0x317ca5(0x18b)](_0x4fe42e,_0x317ca5(0xe6),-0x2),_0x286e80='提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！');(_0x7fed7f===null||_0x7fed7f===void 0x0?void 0x0:_0x7fed7f[_0x317ca5(0x125)])===0x194&&_0x7fed7f[_0x317ca5(0x19a)][_0x317ca5(0x18a)](_0x317ca5(0x17e))&&Number(_0x349aab)===0x1&&(await this[_0x317ca5(0x1a4)][_0x317ca5(0x18b)](_0x4fe42e,_0x317ca5(0x1c8),-0x4),_0x286e80='当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！');_0x5e2c6c===0x190&&console['log']('400\x20error',_0x7fed7f,_0x7fed7f[_0x317ca5(0x19a)]);const _0x3543ba={'message':_0x286e80||_0x317ca5(0x1ce),'code':_0x5e2c6c===0x191?0x190:_0x5e2c6c||0x1f4};if(_0xa69584)return _0xa69584[_0x317ca5(0x18d)](JSON[_0x317ca5(0x198)](_0x3543ba));else throw new common_1[(_0x317ca5(0x110))](_0x3543ba[_0x317ca5(0x19a)],common_1[_0x317ca5(0x172)][_0x317ca5(0x1c9)]);}finally{_0xa69584&&_0xa69584['end']();}}async['draw'](_0x1f9a2c,_0xe0e9c4){const _0x40524c=_0x37187e;var _0x3c002d,_0x29e68d,_0x13aec6,_0x2e8f55,_0x130715,_0x5c002a,_0x14f9b5,_0x877a1f;await this['badwordsService'][_0x40524c(0x16d)](_0x1f9a2c[_0x40524c(0x1d3)],_0xe0e9c4[_0x40524c(0x1e4)]['id']),await this[_0x40524c(0x179)][_0x40524c(0x183)](_0xe0e9c4[_0x40524c(0x1e4)]);const _0x2207a3=(_0x1f9a2c===null||_0x1f9a2c===void 0x0?void 0x0:_0x1f9a2c[_0x40524c(0x1d2)])==='hd'?0x4:0x2;await this['userBalanceService'][_0x40524c(0x192)](_0xe0e9c4,_0x40524c(0x105),_0x2207a3);let _0x193b56=[];const _0x3c4395=await this['modelsService'][_0x40524c(0x181)]();if(!_0x3c4395)throw new common_1['HttpException'](_0x40524c(0x18f),common_1['HttpStatus'][_0x40524c(0x1c9)]);const _0x172914=_0x3c4395===null||_0x3c4395===void 0x0?void 0x0:_0x3c4395['id'],{key:_0x3b6f5d}=_0x3c4395;let _0xebb2ee=_0x3c4395['proxyUrl'];common_1['Logger'][_0x40524c(0x133)](_0x40524c(0x188)+_0x1f9a2c['prompt']+',\x20key\x20===>\x20'+_0x3b6f5d,_0x40524c(0x180));try{_0xebb2ee[_0x40524c(0x197)]('/')&&(_0xebb2ee=_0xebb2ee['slice'](0x0,_0xebb2ee[_0x40524c(0x1e0)]-0x1));const _0x4bcfbc=_0xebb2ee+_0x40524c(0x15d),_0x3d50f3=Object['assign'](Object[_0x40524c(0x140)]({},_0x1f9a2c),{'model':_0x40524c(0x1d8)}),_0x56fe85=await axios_1[_0x40524c(0x138)][_0x40524c(0x174)](_0x4bcfbc,Object[_0x40524c(0x140)](Object['assign']({},_0x3d50f3),{'response_format':'b64_json'}),{'headers':{'Authorization':_0x40524c(0x1a3)+_0x3b6f5d}});console[_0x40524c(0x133)](_0x40524c(0x111),_0x4bcfbc,_0x3b6f5d),_0x193b56=_0x56fe85[_0x40524c(0xeb)]['data'];const _0x4cac53=[];for(const _0x4f6c67 of _0x193b56){const _0x53b3b5=uuid['v4']()['slice'](0x0,0xa)+_0x40524c(0x178),_0x486e54=_0x4f6c67[_0x40524c(0x12a)]||_0x4f6c67[_0x40524c(0x12a)],_0xfc2a4b=_0x486e54[_0x40524c(0xe8)](/^data:image\/webp;base64,/,''),_0x3679ee=Buffer['from'](_0xfc2a4b,_0x40524c(0x11b));_0x4cac53[_0x40524c(0x1ba)](this[_0x40524c(0x165)]['uploadFile']({'filename':_0x53b3b5,'buffer':_0x3679ee}));}const _0x33ad64=await Promise['all'](_0x4cac53);await this['userBalanceService'][_0x40524c(0x1ea)](_0xe0e9c4['user']['id'],_0x40524c(0x105),(_0x3d50f3===null||_0x3d50f3===void 0x0?void 0x0:_0x3d50f3[_0x40524c(0x1d2)])===_0x40524c(0x1ed)?0x2:0x4,_0x2207a3);const _0x30af4f=(0x0,utils_1['getClientIp'])(_0xe0e9c4),_0x3f4fa5=[],_0x4b32cb=await this['uploadService'][_0x40524c(0xfc)](),[_0x4bb502,_0x3be493]=_0x1f9a2c['size']['split']('x');return _0x33ad64[_0x40524c(0x1b1)](_0x27573a=>{const _0x4dae12=_0x40524c;_0x3f4fa5[_0x4dae12(0x1ba)](this[_0x4dae12(0xf8)][_0x4dae12(0x194)]({'curIp':_0x30af4f,'userId':_0xe0e9c4[_0x4dae12(0x1e4)]['id'],'type':balance_constant_1[_0x4dae12(0xf0)][_0x4dae12(0x17d)],'prompt':_0x1f9a2c['prompt'],'answer':_0x27573a,'fileInfo':JSON['stringify']({'cosType':_0x4b32cb,'width':_0x4bb502,'height':_0x3be493,'cosUrl':_0x27573a}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x4dae12(0x1d8)}));}),await Promise[_0x40524c(0x18c)](_0x3f4fa5),_0x33ad64;}catch(_0x3e60ff){console[_0x40524c(0x133)]('error:\x20',_0x3e60ff),console[_0x40524c(0x133)](_0x40524c(0x1b4),(_0x3c002d=_0x3e60ff===null||_0x3e60ff===void 0x0?void 0x0:_0x3e60ff[_0x40524c(0x186)])===null||_0x3c002d===void 0x0?void 0x0:_0x3c002d[_0x40524c(0x1a6)],(_0x2e8f55=(_0x13aec6=(_0x29e68d=_0x3e60ff===null||_0x3e60ff===void 0x0?void 0x0:_0x3e60ff[_0x40524c(0x186)])===null||_0x29e68d===void 0x0?void 0x0:_0x29e68d[_0x40524c(0xeb)])===null||_0x13aec6===void 0x0?void 0x0:_0x13aec6[_0x40524c(0x1dd)])===null||_0x2e8f55===void 0x0?void 0x0:_0x2e8f55[_0x40524c(0x19a)]);const _0x156a9c=((_0x130715=_0x3e60ff===null||_0x3e60ff===void 0x0?void 0x0:_0x3e60ff[_0x40524c(0x186)])===null||_0x130715===void 0x0?void 0x0:_0x130715[_0x40524c(0x1a6)])||0x1f4,_0x2d48df=(_0x877a1f=(_0x14f9b5=(_0x5c002a=_0x3e60ff===null||_0x3e60ff===void 0x0?void 0x0:_0x3e60ff[_0x40524c(0x186)])===null||_0x5c002a===void 0x0?void 0x0:_0x5c002a[_0x40524c(0xeb)])===null||_0x14f9b5===void 0x0?void 0x0:_0x14f9b5[_0x40524c(0x1dd)])===null||_0x877a1f===void 0x0?void 0x0:_0x877a1f['message'];if(_0x156a9c===0x1ad)throw new common_1[(_0x40524c(0x110))]('当前请求已过载、请稍等会儿再试试吧！',common_1['HttpStatus'][_0x40524c(0x1c9)]);if(_0x156a9c===0x190&&_0x2d48df[_0x40524c(0x18a)](_0x40524c(0x15e)))throw new common_1[(_0x40524c(0x110))](_0x40524c(0x116),common_1[_0x40524c(0x172)][_0x40524c(0x1c9)]);if(_0x156a9c===0x190&&_0x2d48df['includes']('Billing\x20hard\x20limit\x20has\x20been\x20reached')){await this[_0x40524c(0x1a4)][_0x40524c(0x18b)](_0x172914,_0x40524c(0x1a8),-0x1);throw new common_1[(_0x40524c(0x110))]('当前Key余额已不足、请重新再试一次吧！',common_1[_0x40524c(0x172)][_0x40524c(0x1c9)]);}if(_0x156a9c===0x1f4)throw new common_1[(_0x40524c(0x110))](_0x40524c(0x1cc),common_1[_0x40524c(0x172)][_0x40524c(0x1c9)]);if(_0x156a9c===0x191)throw new common_1[(_0x40524c(0x110))](_0x40524c(0x134),common_1['HttpStatus']['BAD_REQUEST']);if(_0x156a9c===0x1f7)throw new common_1[(_0x40524c(0x110))](_0x2d48df,common_1[_0x40524c(0x172)][_0x40524c(0x1c9)]);throw new common_1['HttpException']('绘制图片失败，请稍后试试吧！',common_1[_0x40524c(0x172)]['BAD_REQUEST']);}}async[_0x37187e(0x153)](){const _0x3da39f=_0x37187e,_0x395f82=await this[_0x3da39f(0x1ee)][_0x3da39f(0x137)]({'where':{'status':0x1},'select':['id',_0x3da39f(0xe4),_0x3da39f(0xfb),_0x3da39f(0x1ae),'maxModelTokens','maxResponseTokens',_0x3da39f(0x1fc),_0x3da39f(0x11e)]}),_0x33f028=_0x395f82['filter'](_0x25bef4=>_0x25bef4[_0x3da39f(0x1ae)][_0x3da39f(0x18a)](_0x3da39f(0x15b))),_0x31ecf1=_0x395f82[_0x3da39f(0x12c)](_0x2e539c=>_0x2e539c[_0x3da39f(0x1ae)][_0x3da39f(0x18a)](_0x3da39f(0x14a)));this[_0x3da39f(0x103)]={'list3':_0x33f028,'list4':_0x31ecf1};}async[_0x37187e(0xff)](_0x3a034f){const _0x221d79=_0x37187e,_0x3e2b01=await this[_0x221d79(0x1aa)]['getConfigs']([_0x221d79(0x13c)]);return(_0x3a034f===null||_0x3a034f===void 0x0?void 0x0:_0x3a034f[_0x221d79(0x1cd)])||_0x3e2b01||'https://api.openai.com';}async[_0x37187e(0x176)](_0x337081,_0x7cb91a){const _0x3b6e59=_0x37187e;try{const {name:_0x38419d,icon:_0x2c2a65,order:_0x5e58e1,id:_0x1b9861,status:_0x1a48f2}=_0x7cb91a;return _0x1b9861?await this[_0x3b6e59(0x196)][_0x3b6e59(0x1da)]({'id':_0x1b9861},{'name':_0x38419d,'icon':_0x2c2a65,'order':_0x5e58e1,'status':_0x1a48f2}):await this['chatBoxTypeEntity'][_0x3b6e59(0x1d5)]({'name':_0x38419d,'icon':_0x2c2a65,'order':_0x5e58e1,'status':_0x1a48f2});}catch(_0x3a7b8b){console[_0x3b6e59(0x133)](_0x3b6e59(0xf3),_0x3a7b8b);}}async['delChatBoxType'](_0x57f7b8,_0xbd977a){const _0x5a9384=_0x37187e,{id:_0x56ab38}=_0xbd977a;if(!_0x56ab38)throw new common_1[(_0x5a9384(0x110))](_0x5a9384(0x13a),common_1[_0x5a9384(0x172)][_0x5a9384(0x1c9)]);const _0x507e08=await this[_0x5a9384(0x17a)][_0x5a9384(0x14e)]({'where':{'typeId':_0x56ab38}});if(_0x507e08)throw new common_1[(_0x5a9384(0x110))](_0x5a9384(0x14c),common_1['HttpStatus'][_0x5a9384(0x1c9)]);return await this['chatBoxTypeEntity'][_0x5a9384(0x1bd)]({'id':_0x56ab38});}async[_0x37187e(0x1c1)](){const _0x125de3=_0x37187e;return await this[_0x125de3(0x196)]['find']({'order':{'order':'DESC'}});}async[_0x37187e(0x129)](_0x39c134,_0x3c185d){const _0x455c65=_0x37187e,{title:_0x578487,prompt:_0x251941,appId:_0x33b5d9,order:_0x5ac5d1,status:_0x131c01,typeId:_0x20012f,id:_0x277ecd,url:_0x2e15d9}=_0x3c185d;if(!_0x20012f)throw new common_1['HttpException'](_0x455c65(0x15f),common_1['HttpStatus'][_0x455c65(0x1c9)]);try{const _0x249238={'title':_0x578487,'order':_0x5ac5d1,'status':_0x131c01,'typeId':_0x20012f,'url':_0x2e15d9};return _0x249238[_0x455c65(0x1a2)]=_0x33b5d9||0x0,_0x249238[_0x455c65(0x1d3)]=_0x251941||'',_0x277ecd?await this[_0x455c65(0x17a)][_0x455c65(0x1da)]({'id':_0x277ecd},_0x249238):await this[_0x455c65(0x17a)][_0x455c65(0x1d5)](_0x249238);}catch(_0x44278b){console[_0x455c65(0x133)]('error:\x20',_0x44278b);}}async[_0x37187e(0x107)](_0x466f07,_0x34ea86){const _0x5c4da2=_0x37187e,{id:_0x4144cc}=_0x34ea86;if(!_0x4144cc)throw new common_1['HttpException'](_0x5c4da2(0x13a),common_1[_0x5c4da2(0x172)][_0x5c4da2(0x1c9)]);return await this[_0x5c4da2(0x17a)][_0x5c4da2(0x1bd)]({'id':_0x4144cc});}async[_0x37187e(0xe3)](){const _0x45c641=_0x37187e,_0x451a9c=await this['chatBoxEntity'][_0x45c641(0x137)]({'order':{'order':_0x45c641(0x1f1)}}),_0x2cf794=[...new Set(_0x451a9c[_0x45c641(0x1df)](_0x41b485=>_0x41b485[_0x45c641(0x1d6)]))],_0x4bd645=[...new Set(_0x451a9c[_0x45c641(0x1df)](_0x1793e9=>_0x1793e9[_0x45c641(0x1a2)]))],_0x32cf6c=await this[_0x45c641(0x196)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x2cf794)}}),_0x71a70f=await this[_0x45c641(0x117)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x4bd645)}});return _0x451a9c['map'](_0x12b10a=>{const _0x5d4d58=_0x45c641,{typeId:_0x3f44ed,appId:_0x553a7e}=_0x12b10a;return _0x12b10a[_0x5d4d58(0x152)]=_0x32cf6c['find'](_0x5b7115=>_0x5b7115['id']===_0x3f44ed),_0x12b10a['appInfo']=_0x71a70f['find'](_0x459d49=>_0x459d49['id']===_0x553a7e),_0x12b10a;});}async['queryChatBoxFrontend'](){const _0x33a44a=_0x37187e,_0x22d836=await this[_0x33a44a(0x196)][_0x33a44a(0x137)]({'order':{'order':_0x33a44a(0x1f1)},'where':{'status':!![]}}),_0x26e449=await this[_0x33a44a(0x17a)]['find']({'where':{'status':!![]}}),_0x4727f7=[...new Set(_0x26e449[_0x33a44a(0x1df)](_0x42d500=>_0x42d500[_0x33a44a(0x1a2)]))],_0x4a2c03=await this[_0x33a44a(0x117)][_0x33a44a(0x137)]({'where':{'id':(0x0,typeorm_1['In'])(_0x4727f7)}});return _0x26e449['forEach'](_0x544cd9=>{const _0x3458de=_0x33a44a,_0x46b8b0=_0x4a2c03[_0x3458de(0x137)](_0x1374f7=>_0x1374f7['id']===_0x544cd9[_0x3458de(0x1a2)]);return _0x544cd9[_0x3458de(0x151)]=_0x46b8b0===null||_0x46b8b0===void 0x0?void 0x0:_0x46b8b0[_0x3458de(0x151)],_0x544cd9;}),_0x22d836[_0x33a44a(0x1df)](_0x5990ae=>{const _0x24e98a=_0x33a44a;return _0x5990ae['childList']=_0x26e449['filter'](_0x2300ef=>_0x2300ef[_0x24e98a(0x1d6)]===_0x5990ae['id']&&_0x2300ef[_0x24e98a(0x1a6)]),_0x5990ae;});}async[_0x37187e(0x1af)](_0x7c027a,_0x3f616b){const _0x376af9=_0x37187e;try{const {name:_0x119b4b,icon:_0x2e67c,order:_0x27a968,id:_0x2ae739,status:_0x3b8411}=_0x3f616b;return _0x2ae739?await this['chatPreTypeEntity']['update']({'id':_0x2ae739},{'name':_0x119b4b,'icon':_0x2e67c,'order':_0x27a968,'status':_0x3b8411}):await this[_0x376af9(0x1f3)][_0x376af9(0x1d5)]({'name':_0x119b4b,'icon':_0x2e67c,'order':_0x27a968,'status':_0x3b8411});}catch(_0x127089){console[_0x376af9(0x133)]('error:\x20',_0x127089);}}async[_0x37187e(0x104)](_0x143fb7,_0x1464b6){const _0x2106c1=_0x37187e,{id:_0x5b8531}=_0x1464b6;if(!_0x5b8531)throw new common_1[(_0x2106c1(0x110))](_0x2106c1(0x13a),common_1[_0x2106c1(0x172)]['BAD_REQUEST']);const _0x3436f6=await this['chatBoxEntity']['count']({'where':{'typeId':_0x5b8531}});if(_0x3436f6)throw new common_1[(_0x2106c1(0x110))](_0x2106c1(0x14c),common_1[_0x2106c1(0x172)][_0x2106c1(0x1c9)]);return await this[_0x2106c1(0x1f3)]['delete']({'id':_0x5b8531});}async['queryChatPreType'](){const _0x466164=_0x37187e;return await this[_0x466164(0x1f3)]['find']({'order':{'order':_0x466164(0x1f1)}});}async[_0x37187e(0x148)](_0x53b105,_0x4d25a4){const _0x8066c1=_0x37187e,{title:_0x44326c,prompt:_0x1bb2cc,appId:_0x4b7f10,order:_0x35f559,status:_0x444570,typeId:_0x4a2f97,id:_0x5c9f32,url:_0x47b8a0}=_0x4d25a4;if(!_0x4a2f97)throw new common_1[(_0x8066c1(0x110))](_0x8066c1(0x15f),common_1[_0x8066c1(0x172)][_0x8066c1(0x1c9)]);try{const _0x3c903a={'title':_0x44326c,'prompt':_0x1bb2cc,'order':_0x35f559,'status':_0x444570,'typeId':_0x4a2f97,'url':_0x47b8a0};return _0x5c9f32?await this[_0x8066c1(0x15a)][_0x8066c1(0x1da)]({'id':_0x5c9f32},_0x3c903a):await this['chatPreEntity']['save'](_0x3c903a);}catch(_0x50ea8c){console[_0x8066c1(0x133)]('error:\x20',_0x50ea8c);}}async[_0x37187e(0x10a)](_0x5c8604,_0x58d126){const _0x21a704=_0x37187e,{id:_0x36e940}=_0x58d126;if(!_0x36e940)throw new common_1[(_0x21a704(0x110))](_0x21a704(0x13a),common_1['HttpStatus']['BAD_REQUEST']);return await this[_0x21a704(0x15a)]['delete']({'id':_0x36e940});}async['queryChatPre'](){const _0x4464e4=_0x37187e,_0x361d00=await this[_0x4464e4(0x15a)][_0x4464e4(0x137)]({'order':{'order':_0x4464e4(0x1f1)}}),_0x1d1626=[...new Set(_0x361d00[_0x4464e4(0x1df)](_0x5e2184=>_0x5e2184[_0x4464e4(0x1d6)]))],_0x5a3a35=await this[_0x4464e4(0x1f3)][_0x4464e4(0x137)]({'where':{'id':(0x0,typeorm_1['In'])(_0x1d1626)}});return _0x361d00[_0x4464e4(0x1df)](_0x511b2e=>{const _0x12ac15=_0x4464e4,{typeId:_0xccc091,appId:_0x2c2610}=_0x511b2e;return _0x511b2e[_0x12ac15(0x152)]=_0x5a3a35[_0x12ac15(0x137)](_0xf45307=>_0xf45307['id']===_0xccc091),_0x511b2e;});}async[_0x37187e(0x1de)](){const _0x40847e=_0x37187e,_0x106a0a=await this[_0x40847e(0x1f3)][_0x40847e(0x137)]({'order':{'order':_0x40847e(0x1f1)},'where':{'status':!![]}}),_0x294f09=await this[_0x40847e(0x15a)][_0x40847e(0x137)]({'where':{'status':!![]}});return _0x106a0a[_0x40847e(0x1df)](_0x29c756=>{const _0x1f2153=_0x40847e;return _0x29c756[_0x1f2153(0xf7)]=_0x294f09['filter'](_0x5d5e5c=>_0x5d5e5c['typeId']===_0x29c756['id']&&_0x5d5e5c[_0x1f2153(0x1a6)]),_0x29c756;});}async[_0x37187e(0x1e1)](_0x5084ea,_0x45e1f5,_0x5db641){const _0x24d931=_0x37187e;let _0x4cdb63=0x1000,_0xad9e90=0x800;return _0x5084ea[_0x24d931(0x159)]()[_0x24d931(0x18a)]('gpt-4')&&(_0x4cdb63=_0x45e1f5>=0x2004?0x2004:_0x45e1f5,_0xad9e90=_0x5db641>=0x1000?0x1000:_0x5db641,_0x5084ea['toLowerCase']()[_0x24d931(0x18a)]('32k')&&(_0x4cdb63=_0x45e1f5>=0x8000?0x8000:_0x45e1f5,_0xad9e90=_0x5db641>=0x3e80?0x3e80:_0x5db641),(_0x5084ea[_0x24d931(0x159)]()['includes'](_0x24d931(0x115))||_0x5084ea[_0x24d931(0x159)]()['includes'](_0x24d931(0x108)))&&(_0x4cdb63=_0x45e1f5>=0x1f400?0x1f400:_0x45e1f5,_0xad9e90=_0x5db641>=0x1000?0x1000:_0x5db641)),_0x5084ea['toLowerCase']()[_0x24d931(0x18a)]('gpt-3')&&(_0x4cdb63=_0x45e1f5>=0x1000?0x1000:_0x45e1f5,_0xad9e90=_0x5db641>=0x800?0x800:_0x5db641,_0x5084ea[_0x24d931(0x159)]()['includes'](_0x24d931(0x1b2))&&(_0x4cdb63=_0x45e1f5>=0x4000?0x4000:_0x45e1f5,_0xad9e90=_0x5db641>=0x1f40?0x1f40:_0x5db641),_0x5084ea['toLowerCase']()[_0x24d931(0x18a)]('1106')&&(_0x4cdb63=_0x45e1f5>=0x4000?0x4000:_0x45e1f5,_0xad9e90=_0x5db641>=0x1f40?0x1f40:_0x5db641)),{'maxToken':_0x4cdb63,'maxRes':_0xad9e90};}};ChatgptService=__decorate([(0x0,common_1[_0x37187e(0x102)])(),__param(0x0,(0x0,typeorm_2[_0x37187e(0x1c7)])(gptkeys_entity_1[_0x37187e(0x13e)])),__param(0x1,(0x0,typeorm_2[_0x37187e(0x1c7)])(config_entity_1['ConfigEntity'])),__param(0x2,(0x0,typeorm_2[_0x37187e(0x1c7)])(chatBoxType_entity_1[_0x37187e(0x131)])),__param(0x3,(0x0,typeorm_2[_0x37187e(0x1c7)])(chatBox_entity_1['ChatBoxEntity'])),__param(0x4,(0x0,typeorm_2['InjectRepository'])(app_entity_1[_0x37187e(0x1f2)])),__param(0x5,(0x0,typeorm_2[_0x37187e(0x1c7)])(chatPreType_entity_1[_0x37187e(0x167)])),__param(0x6,(0x0,typeorm_2[_0x37187e(0x1c7)])(chatPre_entity_1['ChatPreEntity'])),__metadata(_0x37187e(0x177),[typeorm_1['Repository'],typeorm_1[_0x37187e(0x1b3)],typeorm_1[_0x37187e(0x1b3)],typeorm_1[_0x37187e(0x1b3)],typeorm_1[_0x37187e(0x1b3)],typeorm_1[_0x37187e(0x1b3)],typeorm_1['Repository'],nestjs_config_1[_0x37187e(0x146)],userBalance_service_1[_0x37187e(0x12b)],chatLog_service_1[_0x37187e(0x187)],user_service_1[_0x37187e(0x12e)],upload_service_1[_0x37187e(0x203)],badwords_service_1[_0x37187e(0x121)],autoreply_service_1[_0x37187e(0x161)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1['FanyiService'],chatGroup_service_1[_0x37187e(0x1cf)],models_service_1[_0x37187e(0x195)]])],ChatgptService),exports[_0x37187e(0x13d)]=ChatgptService;