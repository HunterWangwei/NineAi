'use strict';function _0x1677(){const _0x384a71=['reduce','maxResponseTokens','length','9787323gMlsIK','namespace','text','10543410GSKdzC','formatOptions','store','_getTokenCount','image_url','8079300CWtbkq','content','replace','generateKey','maxModelToken','uuid','5870dYWpxg','633348GagWon','96AQXzwM','encode','1052160RaSmOa','cl100k_base','_recursivePruning','user','get','8MQJiEK','slice','concat','@dqbd/tiktoken','NineStore','max','set','chat','system','getUuid','expires','18193uRrKpn','3426ilFQSj','min','__esModule','push'];_0x1677=function(){return _0x384a71;};return _0x1677();}const _0x529472=_0x1a06;(function(_0x1c529f,_0x4d77d4){const _0x10b5bd=_0x1a06,_0xd01d6c=_0x1c529f();while(!![]){try{const _0x537973=parseInt(_0x10b5bd(0xcb))/0x1*(-parseInt(_0x10b5bd(0xb9))/0x2)+parseInt(_0x10b5bd(0xbb))/0x3+parseInt(_0x10b5bd(0xb8))/0x4+-parseInt(_0x10b5bd(0xb7))/0x5*(parseInt(_0x10b5bd(0xcc))/0x6)+-parseInt(_0x10b5bd(0xd3))/0x7*(-parseInt(_0x10b5bd(0xc0))/0x8)+parseInt(_0x10b5bd(0xd6))/0x9+-parseInt(_0x10b5bd(0xb1))/0xa;if(_0x537973===_0x4d77d4)break;else _0xd01d6c['push'](_0xd01d6c['shift']());}catch(_0x68f91){_0xd01d6c['push'](_0xd01d6c['shift']());}}}(_0x1677,0xb1894));Object['defineProperty'](exports,_0x529472(0xce),{'value':!![]}),exports[_0x529472(0xc4)]=void 0x0;const uuid_1=require(_0x529472(0xb6)),tiktoken_1=require(_0x529472(0xc3)),tokenizer=(0x0,tiktoken_1['get_encoding'])(_0x529472(0xbc));function isFileUrl(_0x1c0974){const _0x497a36=/\.(jpg|jpeg|png|bmp|webp)$/i;return _0x497a36['test'](_0x1c0974)?!![]:![];}class NineStore{constructor(_0x51cfea){const _0xcb8be9=_0x529472,{store:_0x405fdc,namespace:_0x5e3510,expires:_0x27bdee}=this['formatOptions'](_0x51cfea);this[_0xcb8be9(0xae)]=_0x405fdc,this[_0xcb8be9(0xd4)]=_0x5e3510,this[_0xcb8be9(0xca)]=_0x27bdee;}[_0x529472(0xd7)](_0x40d8da){const _0x35c4ff=_0x529472,{store:_0x42bc58,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace=_0x35c4ff(0xc7)}=_0x40d8da;return{'store':_0x42bc58,'namespace':namespace,'expires':expires};}[_0x529472(0xb4)](_0x5e78f2){const _0x125d41=_0x529472;return this['namespace']?this[_0x125d41(0xd4)]+'-'+_0x5e78f2:_0x5e78f2;}async['getData'](_0x3628a1){const _0x30d9c5=_0x529472,_0x42eb14=await this[_0x30d9c5(0xae)][_0x30d9c5(0xbf)](_0x3628a1);return _0x42eb14;}async['setData'](_0x43c419,_0x57b66a=this[_0x529472(0xca)]){const _0x472b53=_0x529472;await this[_0x472b53(0xae)][_0x472b53(0xc6)](_0x43c419['id'],_0x43c419,_0x57b66a);}async['buildMessageFromParentMessageId'](_0x2fd86f,_0x2a14e1){const _0x453f48=_0x529472;_0x2a14e1[_0x453f48(0xd1)]>=_0x2a14e1[_0x453f48(0xb5)]&&(_0x2a14e1[_0x453f48(0xd1)]=Math['floor'](_0x2a14e1[_0x453f48(0xb5)]/0x2));const {maxRounds:_0x14bc18,maxModelToken:_0x204bdb,maxResponseTokens:_0x1b6933,systemMessage:systemMessage='',name:_0x518749,file:_0x21110a}=_0x2a14e1;let {parentMessageId:_0x18f7f9}=_0x2a14e1;const _0x3e4bc7=[];let _0x5db537=0x0;systemMessage&&_0x3e4bc7[_0x453f48(0xcf)]({'role':_0x453f48(0xc8),'content':systemMessage});const _0x4b6bac=_0x3e4bc7[_0x453f48(0xd2)];let _0x2fc80d=0x0,_0x192f31=_0x3e4bc7;_0x2fd86f&&(_0x192f31=_0x3e4bc7[_0x453f48(0xc2)]([{'role':_0x453f48(0xbe),'content':_0x2fd86f,'name':_0x518749}]));_0x21110a&&isFileUrl(_0x21110a)&&(_0x192f31=_0x3e4bc7['concat']([{'role':_0x453f48(0xbe),'content':[{'type':_0x453f48(0xd5),'text':_0x2fd86f},{'type':_0x453f48(0xb0),'image_url':_0x21110a}],'name':_0x518749}]));_0x21110a&&!isFileUrl(_0x21110a)&&(_0x192f31=_0x3e4bc7[_0x453f48(0xc2)]([{'role':_0x453f48(0xbe),'content':[{'type':_0x21110a+'\x20text'}],'name':_0x518749}]));let _0x4dba22=_0x192f31;do{if(!_0x18f7f9)break;const _0x3c3592=await this['getData'](_0x18f7f9);if(!_0x3c3592)break;const {text:_0x10b488,name:_0x885496,role:_0x4bdf36,file:_0x31b428}=_0x3c3592;let _0x5902c4={};_0x10b488&&(_0x5902c4={'role':_0x4bdf36,'content':_0x10b488,'name':_0x885496});_0x31b428&&(_0x5902c4={'role':_0x453f48(0xbe),'content':[{'type':_0x453f48(0xd5),'text':_0x10b488},{'type':_0x453f48(0xb0),'image_url':_0x31b428}],'name':_0x885496});_0x4dba22=_0x4dba22['slice'](0x0,_0x4b6bac)['concat']([_0x5902c4,..._0x4dba22[_0x453f48(0xc1)](_0x4b6bac)]),_0x2fc80d++;if(_0x14bc18&&_0x2fc80d>=_0x14bc18)break;if(_0x204bdb&&_0x1b6933){const _0x50a5a6=_0x204bdb-_0x1b6933;_0x5db537=await this[_0x453f48(0xaf)](_0x4dba22);const _0x550d53=_0x5db537+0xc8<=_0x50a5a6;!_0x550d53&&(_0x4dba22=this[_0x453f48(0xbd)](_0x4dba22,_0x50a5a6,systemMessage));}_0x18f7f9=_0x3c3592['parentMessageId'];}while(!![]);const _0x24854f=Math[_0x453f48(0xc5)](0x1,Math[_0x453f48(0xcd)](_0x204bdb-_0x5db537,_0x1b6933));return{'context':_0x4dba22,'round':_0x4dba22['length'],'historyToken':_0x5db537,'maxTokens':_0x24854f};}[_0x529472(0xaf)](_0x4fd3be){const _0x3076e0=_0x529472;let _0x2c0901=_0x4fd3be[_0x3076e0(0xd0)]((_0x3a775d,_0x149db0)=>{const _0x1db1a8=_0x3076e0;return _0x3a775d+=_0x149db0[_0x1db1a8(0xb2)];},'');return _0x2c0901=_0x2c0901[_0x3076e0(0xb3)](/<\|endoftext\|>/g,''),tokenizer[_0x3076e0(0xba)](_0x2c0901)[_0x3076e0(0xd2)];}[_0x529472(0xbd)](_0xe1a945,_0x11fb48,_0x18bd68){const _0x353180=_0x529472,_0x36ea28=this[_0x353180(0xaf)](_0xe1a945);if(_0x36ea28<=_0x11fb48)return _0xe1a945;return _0xe1a945['splice'](_0x18bd68?0x1:0x0,0x1),this[_0x353180(0xbd)](_0xe1a945,_0x11fb48,_0x18bd68);}[_0x529472(0xc9)](){return(0x0,uuid_1['v4'])();}}function _0x1a06(_0x294138,_0xedcfe5){const _0x167753=_0x1677();return _0x1a06=function(_0x1a0618,_0x5849ca){_0x1a0618=_0x1a0618-0xae;let _0x152e1b=_0x167753[_0x1a0618];return _0x152e1b;},_0x1a06(_0x294138,_0xedcfe5);}exports['NineStore']=NineStore;