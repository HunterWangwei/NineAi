'use strict';const _0x427eca=_0x1a45;(function(_0x4790ce,_0xc65112){const _0x6a9729=_0x1a45,_0x5ac60d=_0x4790ce();while(!![]){try{const _0x1b04a5=-parseInt(_0x6a9729(0x178))/0x1*(-parseInt(_0x6a9729(0x16a))/0x2)+-parseInt(_0x6a9729(0x18c))/0x3+-parseInt(_0x6a9729(0x176))/0x4*(parseInt(_0x6a9729(0x186))/0x5)+parseInt(_0x6a9729(0x189))/0x6*(-parseInt(_0x6a9729(0x177))/0x7)+parseInt(_0x6a9729(0x17a))/0x8*(parseInt(_0x6a9729(0x17f))/0x9)+parseInt(_0x6a9729(0x168))/0xa*(parseInt(_0x6a9729(0x16c))/0xb)+parseInt(_0x6a9729(0x166))/0xc;if(_0x1b04a5===_0xc65112)break;else _0x5ac60d['push'](_0x5ac60d['shift']());}catch(_0x2c9ac5){_0x5ac60d['push'](_0x5ac60d['shift']());}}}(_0x1ee5,0x44b4a));Object[_0x427eca(0x180)](exports,_0x427eca(0x170),{'value':!![]}),exports[_0x427eca(0x174)]=void 0x0;function _0x1a45(_0x31786d,_0xa2cdef){const _0x1ee50c=_0x1ee5();return _0x1a45=function(_0x1a4523,_0x34150d){_0x1a4523=_0x1a4523-0x165;let _0x4e5008=_0x1ee50c[_0x1a4523];return _0x4e5008;},_0x1a45(_0x31786d,_0xa2cdef);}function _0x1ee5(){const _0x237284=['77481CiaiXR','defineProperty','_getTokenCount','content','namespace','cl100k_base','min','305dFTgsV','@dqbd/tiktoken','image_url','6NVRisD','maxModelToken','formatOptions','1014240wamnqq','encode','8678904XoVtNh','maxResponseTokens','422890RjGGZB','reduce','2TeRZly','system','33sshDlT','text','getUuid','store','__esModule','buildMessageFromParentMessageId','user','slice','NineStore','length','36280glXQpX','776083ENSeKQ','226912uYnhSb','set','192XmzgaD','\x20text','_recursivePruning','expires','concat'];_0x1ee5=function(){return _0x237284;};return _0x1ee5();}const uuid_1=require('uuid'),tiktoken_1=require(_0x427eca(0x187)),tokenizer=(0x0,tiktoken_1['get_encoding'])(_0x427eca(0x184));function isFileUrl(_0x59cd05){const _0x3261ba=/\.(jpg|jpeg|png|bmp|webp)$/i;return _0x3261ba['test'](_0x59cd05)?!![]:![];}class NineStore{constructor(_0x47d9c7){const _0x4614f4=_0x427eca,{store:_0x93822e,namespace:_0x1bb2db,expires:_0x405900}=this[_0x4614f4(0x18b)](_0x47d9c7);this[_0x4614f4(0x16f)]=_0x93822e,this[_0x4614f4(0x183)]=_0x1bb2db,this[_0x4614f4(0x17d)]=_0x405900;}['formatOptions'](_0x5429f7){const {store:_0x4f321b,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace='chat'}=_0x5429f7;return{'store':_0x4f321b,'namespace':namespace,'expires':expires};}['generateKey'](_0x26ccab){const _0x50f19d=_0x427eca;return this['namespace']?this[_0x50f19d(0x183)]+'-'+_0x26ccab:_0x26ccab;}async['getData'](_0x165566){const _0x83bc6b=await this['store']['get'](_0x165566);return _0x83bc6b;}async['setData'](_0x1ee5f6,_0x2496c2=this[_0x427eca(0x17d)]){const _0x33147f=_0x427eca;await this[_0x33147f(0x16f)][_0x33147f(0x179)](_0x1ee5f6['id'],_0x1ee5f6,_0x2496c2);}async[_0x427eca(0x171)](_0x2a4e32,_0x15db56){const _0x31596f=_0x427eca;_0x15db56[_0x31596f(0x167)]>=_0x15db56[_0x31596f(0x18a)]&&(_0x15db56[_0x31596f(0x167)]=Math['floor'](_0x15db56[_0x31596f(0x18a)]/0x2));const {maxRounds:_0x2887d5,maxModelToken:_0x342446,maxResponseTokens:_0x14074e,systemMessage:systemMessage='',name:_0x187556,file:_0x2cffff}=_0x15db56;let {parentMessageId:_0x39c407}=_0x15db56;const _0x3dacbc=[];let _0x120e89=0x0;systemMessage&&_0x3dacbc['push']({'role':_0x31596f(0x16b),'content':systemMessage});const _0x53972f=_0x3dacbc[_0x31596f(0x175)];let _0x4b4eda=0x0,_0xf499bc=_0x3dacbc;_0x2a4e32&&(_0xf499bc=_0x3dacbc[_0x31596f(0x17e)]([{'role':'user','content':_0x2a4e32,'name':_0x187556}]));_0x2cffff&&isFileUrl(_0x2cffff)&&(_0xf499bc=_0x3dacbc[_0x31596f(0x17e)]([{'role':_0x31596f(0x172),'content':[{'type':_0x31596f(0x16d),'text':_0x2a4e32},{'type':_0x31596f(0x188),'image_url':_0x2cffff}],'name':_0x187556}]));_0x2cffff&&!isFileUrl(_0x2cffff)&&(_0xf499bc=_0x3dacbc[_0x31596f(0x17e)]([{'role':_0x31596f(0x172),'content':[{'type':_0x2cffff+_0x31596f(0x17b)}],'name':_0x187556}]));let _0x163e2d=_0xf499bc;do{if(!_0x39c407)break;const _0x2ddb4c=await this['getData'](_0x39c407);if(!_0x2ddb4c)break;const {text:_0x5da823,name:_0x21c485,role:_0x6fbfc9,file:_0xc10da9}=_0x2ddb4c;let _0x5a586a={};_0x5da823&&(_0x5a586a={'role':_0x6fbfc9,'content':_0x5da823,'name':_0x21c485});_0xc10da9&&(_0x5a586a={'role':_0x31596f(0x172),'content':[{'type':_0x31596f(0x16d),'text':_0x5da823},{'type':_0x31596f(0x188),'image_url':_0xc10da9}],'name':_0x21c485});_0x163e2d=_0x163e2d[_0x31596f(0x173)](0x0,_0x53972f)[_0x31596f(0x17e)]([_0x5a586a,..._0x163e2d[_0x31596f(0x173)](_0x53972f)]),_0x4b4eda++;if(_0x2887d5&&_0x4b4eda>=_0x2887d5)break;if(_0x342446&&_0x14074e){const _0x1e4aae=_0x342446-_0x14074e;_0x120e89=await this[_0x31596f(0x181)](_0x163e2d);const _0x5bc0df=_0x120e89+0xc8<=_0x1e4aae;!_0x5bc0df&&(_0x163e2d=this[_0x31596f(0x17c)](_0x163e2d,_0x1e4aae,systemMessage));}_0x39c407=_0x2ddb4c['parentMessageId'];}while(!![]);const _0x4007f2=Math['max'](0x1,Math[_0x31596f(0x185)](_0x342446-_0x120e89,_0x14074e));return{'context':_0x163e2d,'round':_0x163e2d[_0x31596f(0x175)],'historyToken':_0x120e89,'maxTokens':_0x4007f2};}['_getTokenCount'](_0x39bfcb){const _0x13a93d=_0x427eca;let _0x390dcb=_0x39bfcb[_0x13a93d(0x169)]((_0x4e695e,_0x3abc17)=>{const _0x2ae19a=_0x13a93d;return _0x4e695e+=_0x3abc17[_0x2ae19a(0x182)];},'');return _0x390dcb=_0x390dcb['replace'](/<\|endoftext\|>/g,''),tokenizer[_0x13a93d(0x165)](_0x390dcb)[_0x13a93d(0x175)];}['_recursivePruning'](_0x4a546b,_0x3fc007,_0x1a3670){const _0x24b441=_0x427eca,_0x1c8ba6=this[_0x24b441(0x181)](_0x4a546b);if(_0x1c8ba6<=_0x3fc007)return _0x4a546b;return _0x4a546b['splice'](_0x1a3670?0x1:0x0,0x1),this[_0x24b441(0x17c)](_0x4a546b,_0x3fc007,_0x1a3670);}[_0x427eca(0x16e)](){return(0x0,uuid_1['v4'])();}}exports[_0x427eca(0x174)]=NineStore;