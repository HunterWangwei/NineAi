'use strict';const _0x9ca12=_0x1f51;function _0x28c7(){const _0x2b59bc=['当前套餐不存在、请检查你的输入参数！','@nestjs/common','CramiService','HttpStatus','Not','HttpException','metadata','user','updatePackage','username','email','cramiEntity','queryAllPackage','useId','958984yLMDDL','generateCrami','decorate','1016290aVsBLr','affected','__decorate','当前卡密已被使用、请确认您输入的卡密是否正确！','3643512uTXOTC','forEach','406vRWnLT','../userBalance/userBalance.service','packageId','createPackage','CramiEntity','PACKAGE_GIFT','../user/user.entity','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','defineProperty','套餐名称或套餐等级重复、请检查！','count','findAndCount','length','generateCramiCode','role','85208JPHHSY','当前卡密已被使用、已使用的卡密禁止删除！','当前卡密不存在、请确认您要删除的卡密是否存在！','findOne','cramiPackageEntity','删除卡密失败、请重试！','find','saveRecordRechargeLog','../../common/utils','更新套餐失败、请重试！','Like','当前卡密不存在、请确认您输入的卡密是否正确！','LessThanOrEqual','error:\x20','push','delete','InjectRepository','status','./crami.entity','maskCrami','578612iNRzMJ','queryAllCrami','更新套餐成功！','./cramiPackage.entity','delCrami','自定义卡密必须至少一项余额不为0️零！','log','function','UserBalanceService','BAD_REQUEST','Repository','map','使用卡密成功','59610zBJnoy','update','userEntity','当前套餐不存在、请确认您选择的套餐是否存在！','__esModule','save','design:paramtypes','__param','delPackage','batchDelCrami','RechargeType','userBalanceService','1431YjnvMq','2455527nGCkUo','DESC','super','CramiPackageEntity','object','assign','UserEntity','code'];_0x28c7=function(){return _0x2b59bc;};return _0x28c7();}(function(_0x15bac6,_0x27aa18){const _0x1c8439=_0x1f51,_0x10469f=_0x15bac6();while(!![]){try{const _0x256e5e=parseInt(_0x1c8439(0x208))/0x1+parseInt(_0x1c8439(0x234))/0x2+parseInt(_0x1c8439(0x1f2))/0x3+parseInt(_0x1c8439(0x20f))/0x4+-parseInt(_0x1c8439(0x20b))/0x5+-parseInt(_0x1c8439(0x241))/0x6*(parseInt(_0x1c8439(0x211))/0x7)+-parseInt(_0x1c8439(0x220))/0x8*(parseInt(_0x1c8439(0x1f1))/0x9);if(_0x256e5e===_0x27aa18)break;else _0x10469f['push'](_0x10469f['shift']());}catch(_0xb9b788){_0x10469f['push'](_0x10469f['shift']());}}}(_0x28c7,0x7b368));var __decorate=this&&this[_0x9ca12(0x20d)]||function(_0x2cfa6c,_0x10748e,_0x3f0262,_0x499ead){const _0x26e9d0=_0x9ca12;var _0x1d954f=arguments[_0x26e9d0(0x21d)],_0x2914ad=_0x1d954f<0x3?_0x10748e:_0x499ead===null?_0x499ead=Object['getOwnPropertyDescriptor'](_0x10748e,_0x3f0262):_0x499ead,_0x5c1a57;if(typeof Reflect==='object'&&typeof Reflect[_0x26e9d0(0x20a)]===_0x26e9d0(0x23b))_0x2914ad=Reflect['decorate'](_0x2cfa6c,_0x10748e,_0x3f0262,_0x499ead);else{for(var _0xd5b406=_0x2cfa6c[_0x26e9d0(0x21d)]-0x1;_0xd5b406>=0x0;_0xd5b406--)if(_0x5c1a57=_0x2cfa6c[_0xd5b406])_0x2914ad=(_0x1d954f<0x3?_0x5c1a57(_0x2914ad):_0x1d954f>0x3?_0x5c1a57(_0x10748e,_0x3f0262,_0x2914ad):_0x5c1a57(_0x10748e,_0x3f0262))||_0x2914ad;}return _0x1d954f>0x3&&_0x2914ad&&Object[_0x26e9d0(0x219)](_0x10748e,_0x3f0262,_0x2914ad),_0x2914ad;},__metadata=this&&this['__metadata']||function(_0x19340f,_0xa17ceb){const _0x2507b4=_0x9ca12;if(typeof Reflect===_0x2507b4(0x1f6)&&typeof Reflect[_0x2507b4(0x200)]===_0x2507b4(0x23b))return Reflect[_0x2507b4(0x200)](_0x19340f,_0xa17ceb);},__param=this&&this[_0x9ca12(0x248)]||function(_0x1c9201,_0x52d28f){return function(_0x5b98d6,_0xb54f33){_0x52d28f(_0x5b98d6,_0xb54f33,_0x1c9201);};};Object['defineProperty'](exports,_0x9ca12(0x245),{'value':!![]}),exports[_0x9ca12(0x1fc)]=void 0x0;function _0x1f51(_0x180606,_0x18231c){const _0x28c7b0=_0x28c7();return _0x1f51=function(_0x1f51f5,_0x12e196){_0x1f51f5=_0x1f51f5-0x1ee;let _0x523867=_0x28c7b0[_0x1f51f5];return _0x523867;},_0x1f51(_0x180606,_0x18231c);}const common_1=require(_0x9ca12(0x1fb)),crami_entity_1=require(_0x9ca12(0x232)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),cramiPackage_entity_1=require(_0x9ca12(0x237)),utils_1=require(_0x9ca12(0x228)),user_entity_1=require(_0x9ca12(0x217)),userBalance_service_1=require(_0x9ca12(0x212)),balance_constant_1=require('../../common/constants/balance.constant');let CramiService=class CramiService{constructor(_0x303cb6,_0x1f3e91,_0xc6fefb,_0x34d0e1){const _0x44530e=_0x9ca12;this[_0x44530e(0x205)]=_0x303cb6,this['cramiPackageEntity']=_0x1f3e91,this[_0x44530e(0x243)]=_0xc6fefb,this[_0x44530e(0x1f0)]=_0x34d0e1;}async['queryOnePackage'](_0x279d07){const _0x4aeead=_0x9ca12;return await this[_0x4aeead(0x224)][_0x4aeead(0x223)]({'where':{'id':_0x279d07}});}async[_0x9ca12(0x206)](_0x288698){const _0x3e9dea=_0x9ca12;try{const {page:page=0x1,size:size=0xa,name:_0x2073e1,status:_0x533980,type:_0x5b6128}=_0x288698,_0x45038d={};_0x2073e1&&Object['assign'](_0x45038d,{'name':(0x0,typeorm_2[_0x3e9dea(0x22a)])('%'+_0x2073e1+'%')}),_0x533980&&Object[_0x3e9dea(0x1f7)](_0x45038d,{'status':_0x533980});_0x5b6128&&(_0x5b6128>0x0?Object[_0x3e9dea(0x1f7)](_0x45038d,{'days':(0x0,typeorm_2['MoreThan'])(0x0)}):Object[_0x3e9dea(0x1f7)](_0x45038d,{'days':(0x0,typeorm_2[_0x3e9dea(0x22c)])(0x0)}));const [_0xe29109,_0x3ecefa]=await this[_0x3e9dea(0x224)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0x45038d,'order':{'order':'DESC'}});return{'rows':_0xe29109,'count':_0x3ecefa};}catch(_0x202e8a){console[_0x3e9dea(0x23a)](_0x3e9dea(0x22d),_0x202e8a);}}async[_0x9ca12(0x214)](_0x64419e){const _0x58ef27=_0x9ca12,{name:_0x33cc3e,weight:_0x51b1c2}=_0x64419e,_0x4f4834=await this['cramiPackageEntity'][_0x58ef27(0x223)]({'where':[{'name':_0x33cc3e},{'weight':_0x51b1c2}]});if(_0x4f4834)throw new common_1[(_0x58ef27(0x1ff))](_0x58ef27(0x21a),common_1[_0x58ef27(0x1fd)]['BAD_REQUEST']);try{return await this[_0x58ef27(0x224)][_0x58ef27(0x246)](_0x64419e);}catch(_0x15f8e0){console[_0x58ef27(0x23a)](_0x58ef27(0x22d),_0x15f8e0);throw new common_1[(_0x58ef27(0x1ff))](_0x15f8e0,common_1['HttpStatus'][_0x58ef27(0x23d)]);}}async[_0x9ca12(0x202)](_0x48772a){const _0x24ee99=_0x9ca12,{id:_0x22b095,name:_0x378d98,weight:_0x554502}=_0x48772a,_0x3e1441=await this[_0x24ee99(0x224)]['findOne']({'where':{'id':_0x22b095}});if(!_0x3e1441)throw new common_1['HttpException'](_0x24ee99(0x1fa),common_1['HttpStatus'][_0x24ee99(0x23d)]);const _0x5d87de=await this[_0x24ee99(0x224)][_0x24ee99(0x21b)]({'where':[{'name':_0x378d98,'id':(0x0,typeorm_2[_0x24ee99(0x1fe)])(_0x22b095)},{'weight':_0x554502,'id':(0x0,typeorm_2[_0x24ee99(0x1fe)])(_0x22b095)}]});if(_0x5d87de)throw new common_1[(_0x24ee99(0x1ff))]('套餐名称或套餐等级重复、请检查！',common_1[_0x24ee99(0x1fd)][_0x24ee99(0x23d)]);const _0x242f80=await this[_0x24ee99(0x224)][_0x24ee99(0x242)]({'id':_0x22b095},_0x48772a);if(_0x242f80['affected']>0x0)return _0x24ee99(0x236);else throw new common_1[(_0x24ee99(0x1ff))](_0x24ee99(0x229),common_1[_0x24ee99(0x1fd)][_0x24ee99(0x23d)]);}async[_0x9ca12(0x249)](_0x3e49c7){const _0xab4479=_0x9ca12,{id:_0x48a368}=_0x3e49c7,_0xab2db=await this[_0xab4479(0x205)][_0xab4479(0x21b)]({'where':{'packageId':_0x48a368}});if(_0xab2db)throw new common_1[(_0xab4479(0x1ff))](_0xab4479(0x218),common_1[_0xab4479(0x1fd)][_0xab4479(0x23d)]);return await this[_0xab4479(0x224)]['delete']({'id':_0x48a368});}async['createCrami'](_0x504b55){const _0x10f90b=_0x9ca12,{packageId:_0x77fa33,count:count=0x1}=_0x504b55;if(_0x77fa33){const _0x33791e=await this[_0x10f90b(0x224)][_0x10f90b(0x223)]({'where':{'id':_0x77fa33}});if(!_0x33791e)throw new common_1[(_0x10f90b(0x1ff))](_0x10f90b(0x244),common_1[_0x10f90b(0x1fd)][_0x10f90b(0x23d)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x33791e,_0x484461={'packageId':_0x77fa33,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this['generateCrami'](_0x484461,count);}if(!_0x77fa33){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x504b55;if([model3Count,model4Count,drawMjCount]['every'](_0x4f182f=>!_0x4f182f))throw new common_1[(_0x10f90b(0x1ff))](_0x10f90b(0x239),common_1['HttpStatus'][_0x10f90b(0x23d)]);const _0x3a62af={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x10f90b(0x209)](_0x3a62af,count);}}async[_0x9ca12(0x209)](_0x2ac24e,_0x40549a){const _0x523a75=_0x9ca12,_0x31f7db=[];for(let _0xa3ba42=0x0;_0xa3ba42<_0x40549a;_0xa3ba42++){const _0x4d1908=(0x0,utils_1[_0x523a75(0x21e)])(),_0x4b0fef=this[_0x523a75(0x205)]['create'](Object[_0x523a75(0x1f7)](Object[_0x523a75(0x1f7)]({},_0x2ac24e),{'code':_0x4d1908}));_0x31f7db[_0x523a75(0x22e)](_0x4b0fef);}return await this[_0x523a75(0x205)][_0x523a75(0x246)](_0x31f7db);}async['useCrami'](_0x39b8bb,_0x2d986f){const _0xcd8f8=_0x9ca12,{id:_0x158c71}=_0x39b8bb['user'],_0x32fdff=await this['cramiEntity'][_0xcd8f8(0x223)]({'where':{'code':_0x2d986f[_0xcd8f8(0x1f9)]}});if(!_0x32fdff)throw new common_1[(_0xcd8f8(0x1ff))](_0xcd8f8(0x22b),common_1[_0xcd8f8(0x1fd)]['BAD_REQUEST']);const {status:_0x384520,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x32b0e4}=_0x32fdff;if(_0x384520===0x1)throw new common_1['HttpException'](_0xcd8f8(0x20e),common_1[_0xcd8f8(0x1fd)][_0xcd8f8(0x23d)]);const _0x5d7ec4={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x32b0e4};return await this[_0xcd8f8(0x1f0)]['addBalanceToUser'](_0x158c71,Object['assign']({},_0x5d7ec4),days),await this[_0xcd8f8(0x1f0)][_0xcd8f8(0x227)]({'userId':_0x158c71,'rechargeType':balance_constant_1[_0xcd8f8(0x1ef)][_0xcd8f8(0x216)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this['cramiEntity']['update']({'code':_0x2d986f[_0xcd8f8(0x1f9)]},{'useId':_0x158c71,'status':0x1}),_0xcd8f8(0x240);}async[_0x9ca12(0x235)](_0x1703b1,_0x2b7d3b){const _0x12af91=_0x9ca12,{page:page=0x1,size:size=0xa,status:_0xe32f82,useId:_0x4cf66d}=_0x1703b1,_0x1ec297={};_0xe32f82&&Object[_0x12af91(0x1f7)](_0x1ec297,{'status':_0xe32f82}),_0x4cf66d&&Object['assign'](_0x1ec297,{'useId':_0x4cf66d});const [_0x236772,_0x54cefe]=await this[_0x12af91(0x205)][_0x12af91(0x21c)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':_0x12af91(0x1f3)},'where':_0x1ec297}),_0x2c89a1=_0x236772[_0x12af91(0x23f)](_0x1f2b14=>_0x1f2b14['useId']),_0x5a8f14=_0x236772[_0x12af91(0x23f)](_0x308064=>_0x308064[_0x12af91(0x213)]),_0x15f421=await this[_0x12af91(0x243)][_0x12af91(0x226)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2c89a1)}}),_0x58858f=await this[_0x12af91(0x224)][_0x12af91(0x226)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5a8f14)}});return _0x236772[_0x12af91(0x210)](_0x210a50=>{const _0x41909d=_0x12af91;var _0x27b405,_0x45ff54,_0xde3838;_0x210a50[_0x41909d(0x203)]=(_0x27b405=_0x15f421[_0x41909d(0x226)](_0x436e5d=>_0x436e5d['id']===_0x210a50[_0x41909d(0x207)]))===null||_0x27b405===void 0x0?void 0x0:_0x27b405['username'],_0x210a50[_0x41909d(0x204)]=(_0x45ff54=_0x15f421[_0x41909d(0x226)](_0x2d3230=>_0x2d3230['id']===_0x210a50['useId']))===null||_0x45ff54===void 0x0?void 0x0:_0x45ff54[_0x41909d(0x204)],_0x210a50['packageName']=(_0xde3838=_0x58858f[_0x41909d(0x226)](_0x1238fe=>_0x1238fe['id']===_0x210a50[_0x41909d(0x213)]))===null||_0xde3838===void 0x0?void 0x0:_0xde3838['name'];}),_0x2b7d3b[_0x12af91(0x201)][_0x12af91(0x21f)]!==_0x12af91(0x1f4)&&_0x236772[_0x12af91(0x210)](_0x1bf4a7=>_0x1bf4a7[_0x12af91(0x204)]=(0x0,utils_1['maskEmail'])(_0x1bf4a7[_0x12af91(0x204)])),_0x2b7d3b['user'][_0x12af91(0x21f)]!==_0x12af91(0x1f4)&&_0x236772[_0x12af91(0x210)](_0x17d6ae=>_0x17d6ae['code']=(0x0,utils_1[_0x12af91(0x233)])(_0x17d6ae[_0x12af91(0x1f9)])),{'rows':_0x236772,'count':_0x54cefe};}async[_0x9ca12(0x238)](_0xa0d857){const _0x535b28=_0x9ca12,_0x2609a8=await this[_0x535b28(0x205)][_0x535b28(0x223)]({'where':{'id':_0xa0d857}});if(!_0x2609a8)throw new common_1[(_0x535b28(0x1ff))](_0x535b28(0x222),common_1['HttpStatus'][_0x535b28(0x23d)]);if(_0x2609a8[_0x535b28(0x231)]===0x1)throw new common_1[(_0x535b28(0x1ff))](_0x535b28(0x221),common_1[_0x535b28(0x1fd)][_0x535b28(0x23d)]);return await this[_0x535b28(0x205)][_0x535b28(0x22f)]({'id':_0xa0d857});}async[_0x9ca12(0x1ee)](_0x3e0b3e){const _0x5aa928=_0x9ca12,{ids:_0x513fd0}=_0x3e0b3e,_0x23ca74=await this['cramiEntity'][_0x5aa928(0x22f)](_0x513fd0);if(_0x23ca74[_0x5aa928(0x20c)]>0x0)return'删除卡密成功！';else throw new common_1[(_0x5aa928(0x1ff))](_0x5aa928(0x225),common_1['HttpStatus'][_0x5aa928(0x23d)]);}};CramiService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(crami_entity_1[_0x9ca12(0x215)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x9ca12(0x1f5)])),__param(0x2,(0x0,typeorm_1[_0x9ca12(0x230)])(user_entity_1[_0x9ca12(0x1f8)])),__metadata(_0x9ca12(0x247),[typeorm_2[_0x9ca12(0x23e)],typeorm_2['Repository'],typeorm_2[_0x9ca12(0x23e)],userBalance_service_1[_0x9ca12(0x23c)]])],CramiService),exports[_0x9ca12(0x1fc)]=CramiService;