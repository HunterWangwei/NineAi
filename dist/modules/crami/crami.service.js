'use strict';const _0x53ea36=_0x3bbb;(function(_0x396d5c,_0x4a1253){const _0xd959fe=_0x3bbb,_0x208140=_0x396d5c();while(!![]){try{const _0x39b8f6=-parseInt(_0xd959fe(0x176))/0x1+parseInt(_0xd959fe(0x186))/0x2*(parseInt(_0xd959fe(0x157))/0x3)+-parseInt(_0xd959fe(0x19b))/0x4*(-parseInt(_0xd959fe(0x150))/0x5)+-parseInt(_0xd959fe(0x18f))/0x6*(-parseInt(_0xd959fe(0x16e))/0x7)+-parseInt(_0xd959fe(0x15c))/0x8*(parseInt(_0xd959fe(0x18c))/0x9)+-parseInt(_0xd959fe(0x160))/0xa*(-parseInt(_0xd959fe(0x159))/0xb)+-parseInt(_0xd959fe(0x19a))/0xc*(parseInt(_0xd959fe(0x163))/0xd);if(_0x39b8f6===_0x4a1253)break;else _0x208140['push'](_0x208140['shift']());}catch(_0xd1af3){_0x208140['push'](_0x208140['shift']());}}}(_0x4b49,0x9d703));var __decorate=this&&this[_0x53ea36(0x174)]||function(_0x652dd6,_0x5cb018,_0x416b7f,_0x1bdfdc){const _0x437b72=_0x53ea36;var _0x501d18=arguments[_0x437b72(0x15e)],_0x681fe5=_0x501d18<0x3?_0x5cb018:_0x1bdfdc===null?_0x1bdfdc=Object[_0x437b72(0x179)](_0x5cb018,_0x416b7f):_0x1bdfdc,_0x3a5870;if(typeof Reflect===_0x437b72(0x15a)&&typeof Reflect['decorate']===_0x437b72(0x158))_0x681fe5=Reflect['decorate'](_0x652dd6,_0x5cb018,_0x416b7f,_0x1bdfdc);else{for(var _0x4d96f9=_0x652dd6[_0x437b72(0x15e)]-0x1;_0x4d96f9>=0x0;_0x4d96f9--)if(_0x3a5870=_0x652dd6[_0x4d96f9])_0x681fe5=(_0x501d18<0x3?_0x3a5870(_0x681fe5):_0x501d18>0x3?_0x3a5870(_0x5cb018,_0x416b7f,_0x681fe5):_0x3a5870(_0x5cb018,_0x416b7f))||_0x681fe5;}return _0x501d18>0x3&&_0x681fe5&&Object[_0x437b72(0x170)](_0x5cb018,_0x416b7f,_0x681fe5),_0x681fe5;},__metadata=this&&this[_0x53ea36(0x185)]||function(_0x1dfc91,_0x4a53f6){const _0xe9b908=_0x53ea36;if(typeof Reflect==='object'&&typeof Reflect[_0xe9b908(0x177)]===_0xe9b908(0x158))return Reflect[_0xe9b908(0x177)](_0x1dfc91,_0x4a53f6);},__param=this&&this[_0x53ea36(0x162)]||function(_0x2ff884,_0x4a71ac){return function(_0x11318b,_0x5a9ee7){_0x4a71ac(_0x11318b,_0x5a9ee7,_0x2ff884);};};Object['defineProperty'](exports,_0x53ea36(0x19f),{'value':!![]}),exports[_0x53ea36(0x147)]=void 0x0;const common_1=require(_0x53ea36(0x15d)),crami_entity_1=require(_0x53ea36(0x181)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),cramiPackage_entity_1=require('./cramiPackage.entity'),utils_1=require('../../common/utils'),user_entity_1=require(_0x53ea36(0x190)),userBalance_service_1=require(_0x53ea36(0x15f)),balance_constant_1=require(_0x53ea36(0x197));function _0x3bbb(_0x3262e9,_0x34c5f7){const _0x4b4946=_0x4b49();return _0x3bbb=function(_0x3bbbb5,_0x5d2bf2){_0x3bbbb5=_0x3bbbb5-0x143;let _0x2fec0e=_0x4b4946[_0x3bbbb5];return _0x2fec0e;},_0x3bbb(_0x3262e9,_0x34c5f7);}let CramiService=class CramiService{constructor(_0x43eda3,_0x12fd07,_0x1734d3,_0x53b43a){const _0xe63d3=_0x53ea36;this['cramiEntity']=_0x43eda3,this[_0xe63d3(0x14b)]=_0x12fd07,this[_0xe63d3(0x193)]=_0x1734d3,this[_0xe63d3(0x15b)]=_0x53b43a;}async[_0x53ea36(0x199)](_0x1f0809){const _0x414d9e=_0x53ea36;return await this[_0x414d9e(0x14b)]['findOne']({'where':{'id':_0x1f0809}});}async['queryAllPackage'](_0x284153){const _0x42878f=_0x53ea36;try{const {page:page=0x1,size:size=0xa,name:_0x120b0c,status:_0x230c52,type:_0x49bcb0}=_0x284153,_0x36400d={};_0x120b0c&&Object[_0x42878f(0x145)](_0x36400d,{'name':(0x0,typeorm_2[_0x42878f(0x165)])('%'+_0x120b0c+'%')}),_0x230c52&&Object[_0x42878f(0x145)](_0x36400d,{'status':_0x230c52});_0x49bcb0&&(_0x49bcb0>0x0?Object[_0x42878f(0x145)](_0x36400d,{'days':(0x0,typeorm_2['MoreThan'])(0x0)}):Object[_0x42878f(0x145)](_0x36400d,{'days':(0x0,typeorm_2['LessThanOrEqual'])(0x0)}));const [_0x1fc34c,_0x40258d]=await this['cramiPackageEntity'][_0x42878f(0x198)]({'skip':(page-0x1)*size,'take':size,'where':_0x36400d,'order':{'order':_0x42878f(0x161)}});return{'rows':_0x1fc34c,'count':_0x40258d};}catch(_0x536329){console['log'](_0x42878f(0x175),_0x536329);}}async[_0x53ea36(0x17a)](_0x2293d4){const _0x15a9c8=_0x53ea36,{name:_0x18f069,weight:_0xd39bf9}=_0x2293d4,_0x19f5fc=await this['cramiPackageEntity'][_0x15a9c8(0x178)]({'where':[{'name':_0x18f069},{'weight':_0xd39bf9}]});if(_0x19f5fc)throw new common_1[(_0x15a9c8(0x152))](_0x15a9c8(0x182),common_1[_0x15a9c8(0x16b)][_0x15a9c8(0x192)]);try{return await this[_0x15a9c8(0x14b)][_0x15a9c8(0x16c)](_0x2293d4);}catch(_0x156009){console[_0x15a9c8(0x155)](_0x15a9c8(0x175),_0x156009);throw new common_1[(_0x15a9c8(0x152))](_0x156009,common_1[_0x15a9c8(0x16b)][_0x15a9c8(0x192)]);}}async['updatePackage'](_0x4bcdf3){const _0x830246=_0x53ea36,{id:_0x2aad53,name:_0x2e78be,weight:_0x53b157}=_0x4bcdf3,_0x5b9db1=await this['cramiPackageEntity'][_0x830246(0x178)]({'where':{'id':_0x2aad53}});if(!_0x5b9db1)throw new common_1[(_0x830246(0x152))]('当前套餐不存在、请检查你的输入参数！',common_1['HttpStatus'][_0x830246(0x192)]);const _0x118957=await this[_0x830246(0x14b)][_0x830246(0x153)]({'where':[{'name':_0x2e78be,'id':(0x0,typeorm_2[_0x830246(0x194)])(_0x2aad53)},{'weight':_0x53b157,'id':(0x0,typeorm_2[_0x830246(0x194)])(_0x2aad53)}]});if(_0x118957)throw new common_1['HttpException'](_0x830246(0x182),common_1[_0x830246(0x16b)][_0x830246(0x192)]);const _0x2fceff=await this[_0x830246(0x14b)][_0x830246(0x191)]({'id':_0x2aad53},_0x4bcdf3);if(_0x2fceff[_0x830246(0x189)]>0x0)return _0x830246(0x171);else throw new common_1[(_0x830246(0x152))]('更新套餐失败、请重试！',common_1['HttpStatus'][_0x830246(0x192)]);}async[_0x53ea36(0x188)](_0xfd1a34){const _0x119be2=_0x53ea36,{id:_0x2905a7}=_0xfd1a34,_0x22bcc1=await this[_0x119be2(0x184)][_0x119be2(0x153)]({'where':{'packageId':_0x2905a7}});if(_0x22bcc1)throw new common_1[(_0x119be2(0x152))](_0x119be2(0x146),common_1[_0x119be2(0x16b)]['BAD_REQUEST']);return await this[_0x119be2(0x14b)][_0x119be2(0x151)]({'id':_0x2905a7});}async[_0x53ea36(0x14d)](_0x3ef467){const _0x33346c=_0x53ea36,{packageId:_0x50a701,count:count=0x1}=_0x3ef467;if(_0x50a701){const _0x578f6e=await this[_0x33346c(0x14b)][_0x33346c(0x178)]({'where':{'id':_0x50a701}});if(!_0x578f6e)throw new common_1[(_0x33346c(0x152))](_0x33346c(0x183),common_1[_0x33346c(0x16b)][_0x33346c(0x192)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x578f6e,_0x19a294={'packageId':_0x50a701,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x33346c(0x16f)](_0x19a294,count);}if(!_0x50a701){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3ef467;if([model3Count,model4Count,drawMjCount][_0x33346c(0x17f)](_0xada582=>!_0xada582))throw new common_1[(_0x33346c(0x152))](_0x33346c(0x19e),common_1[_0x33346c(0x16b)][_0x33346c(0x192)]);const _0x2640af={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x33346c(0x16f)](_0x2640af,count);}}async[_0x53ea36(0x16f)](_0x32d069,_0x327dfc){const _0x513d74=_0x53ea36,_0x43e582=[];for(let _0x22193a=0x0;_0x22193a<_0x327dfc;_0x22193a++){const _0x1c1f88=(0x0,utils_1[_0x513d74(0x167)])(),_0x3b0464=this[_0x513d74(0x184)][_0x513d74(0x173)](Object[_0x513d74(0x145)](Object[_0x513d74(0x145)]({},_0x32d069),{'code':_0x1c1f88}));_0x43e582[_0x513d74(0x156)](_0x3b0464);}return await this[_0x513d74(0x184)][_0x513d74(0x16c)](_0x43e582);}async[_0x53ea36(0x169)](_0xe33908,_0x17bdc5){const _0x4b2e97=_0x53ea36,{id:_0x2f9427}=_0xe33908[_0x4b2e97(0x17e)],_0x3cd373=await this[_0x4b2e97(0x184)]['findOne']({'where':{'code':_0x17bdc5[_0x4b2e97(0x18b)]}});if(!_0x3cd373)throw new common_1['HttpException']('当前卡密不存在、请确认您输入的卡密是否正确！',common_1['HttpStatus'][_0x4b2e97(0x192)]);const {status:_0x8993fd,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x4d58a6}=_0x3cd373;if(_0x8993fd===0x1)throw new common_1[(_0x4b2e97(0x152))](_0x4b2e97(0x19c),common_1[_0x4b2e97(0x16b)][_0x4b2e97(0x192)]);const _0x5a86c8={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x4d58a6};return await this['userBalanceService'][_0x4b2e97(0x14a)](_0x2f9427,Object['assign']({},_0x5a86c8),days),await this['userBalanceService'][_0x4b2e97(0x14c)]({'userId':_0x2f9427,'rechargeType':balance_constant_1['RechargeType'][_0x4b2e97(0x18a)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this['cramiEntity'][_0x4b2e97(0x191)]({'code':_0x17bdc5[_0x4b2e97(0x18b)]},{'useId':_0x2f9427,'status':0x1}),'使用卡密成功';}async[_0x53ea36(0x187)](_0x126932,_0x340895){const _0x245f86=_0x53ea36,{page:page=0x1,size:size=0xa,status:_0x25a8b6,useId:_0x4404f2}=_0x126932,_0x21e0f0={};_0x25a8b6&&Object[_0x245f86(0x145)](_0x21e0f0,{'status':_0x25a8b6}),_0x4404f2&&Object[_0x245f86(0x145)](_0x21e0f0,{'useId':_0x4404f2});const [_0x42b95b,_0xf1640d]=await this[_0x245f86(0x184)][_0x245f86(0x198)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':_0x245f86(0x161)},'where':_0x21e0f0}),_0x2079d3=_0x42b95b[_0x245f86(0x17d)](_0x4bfbd3=>_0x4bfbd3[_0x245f86(0x164)]),_0x3e6731=_0x42b95b[_0x245f86(0x17d)](_0x485927=>_0x485927[_0x245f86(0x195)]),_0xfce191=await this[_0x245f86(0x193)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x2079d3)}}),_0x162ad1=await this['cramiPackageEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x3e6731)}});return _0x42b95b[_0x245f86(0x196)](_0x49da79=>{const _0x67116c=_0x245f86;var _0x13d0d7,_0x72d652,_0x2370a3;_0x49da79['username']=(_0x13d0d7=_0xfce191[_0x67116c(0x168)](_0x4d1a7d=>_0x4d1a7d['id']===_0x49da79['useId']))===null||_0x13d0d7===void 0x0?void 0x0:_0x13d0d7[_0x67116c(0x172)],_0x49da79['email']=(_0x72d652=_0xfce191[_0x67116c(0x168)](_0x3f4576=>_0x3f4576['id']===_0x49da79[_0x67116c(0x164)]))===null||_0x72d652===void 0x0?void 0x0:_0x72d652['email'],_0x49da79[_0x67116c(0x143)]=(_0x2370a3=_0x162ad1['find'](_0x40e470=>_0x40e470['id']===_0x49da79[_0x67116c(0x195)]))===null||_0x2370a3===void 0x0?void 0x0:_0x2370a3[_0x67116c(0x14e)];}),_0x340895[_0x245f86(0x17e)][_0x245f86(0x18d)]!==_0x245f86(0x18e)&&_0x42b95b['forEach'](_0x4a730a=>_0x4a730a[_0x245f86(0x144)]=(0x0,utils_1[_0x245f86(0x148)])(_0x4a730a['email'])),_0x340895[_0x245f86(0x17e)]['role']!==_0x245f86(0x18e)&&_0x42b95b[_0x245f86(0x196)](_0x3e80c7=>_0x3e80c7[_0x245f86(0x18b)]=(0x0,utils_1[_0x245f86(0x1a0)])(_0x3e80c7[_0x245f86(0x18b)])),{'rows':_0x42b95b,'count':_0xf1640d};}async[_0x53ea36(0x14f)](_0x5373e3){const _0x4c7ced=_0x53ea36,_0x12723c=await this[_0x4c7ced(0x184)][_0x4c7ced(0x178)]({'where':{'id':_0x5373e3}});if(!_0x12723c)throw new common_1[(_0x4c7ced(0x152))](_0x4c7ced(0x19d),common_1[_0x4c7ced(0x16b)][_0x4c7ced(0x192)]);if(_0x12723c[_0x4c7ced(0x154)]===0x1)throw new common_1[(_0x4c7ced(0x152))]('当前卡密已被使用、已使用的卡密禁止删除！',common_1[_0x4c7ced(0x16b)][_0x4c7ced(0x192)]);return await this[_0x4c7ced(0x184)][_0x4c7ced(0x151)]({'id':_0x5373e3});}async[_0x53ea36(0x17c)](_0x33d3cd){const _0x52e84f=_0x53ea36,{ids:_0x44aa68}=_0x33d3cd,_0x180548=await this['cramiEntity'][_0x52e84f(0x151)](_0x44aa68);if(_0x180548[_0x52e84f(0x189)]>0x0)return _0x52e84f(0x180);else throw new common_1[(_0x52e84f(0x152))]('删除卡密失败、请重试！',common_1['HttpStatus'][_0x52e84f(0x192)]);}};CramiService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x53ea36(0x16d)])(crami_entity_1[_0x53ea36(0x17b)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1[_0x53ea36(0x16d)])(user_entity_1[_0x53ea36(0x166)])),__metadata(_0x53ea36(0x16a),[typeorm_2[_0x53ea36(0x149)],typeorm_2[_0x53ea36(0x149)],typeorm_2[_0x53ea36(0x149)],userBalance_service_1['UserBalanceService']])],CramiService),exports['CramiService']=CramiService;function _0x4b49(){const _0x4cd39d=['design:paramtypes','HttpStatus','save','InjectRepository','28PPMXaG','generateCrami','defineProperty','更新套餐成功！','username','create','__decorate','error:\x20','615617tCvciP','metadata','findOne','getOwnPropertyDescriptor','createPackage','CramiEntity','batchDelCrami','map','user','every','删除卡密成功！','./crami.entity','套餐名称或套餐等级重复、请检查！','当前套餐不存在、请确认您选择的套餐是否存在！','cramiEntity','__metadata','14zidiyn','queryAllCrami','delPackage','affected','PACKAGE_GIFT','code','9pROIuO','role','super','1878834wQJeZB','../user/user.entity','update','BAD_REQUEST','userEntity','Not','packageId','forEach','../../common/constants/balance.constant','findAndCount','queryOnePackage','12vzLRdg','31324VGtCCI','当前卡密已被使用、请确认您输入的卡密是否正确！','当前卡密不存在、请确认您要删除的卡密是否存在！','自定义卡密必须至少一项余额不为0️零！','__esModule','maskCrami','packageName','email','assign','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','CramiService','maskEmail','Repository','addBalanceToUser','cramiPackageEntity','saveRecordRechargeLog','createCrami','name','delCrami','635eedifE','delete','HttpException','count','status','log','push','67350QjcpxK','function','44HjRRJN','object','userBalanceService','1248088bnRboe','@nestjs/common','length','../userBalance/userBalance.service','67810kZKCwg','DESC','__param','13193336vcHDXf','useId','Like','UserEntity','generateCramiCode','find','useCrami'];_0x4b49=function(){return _0x4cd39d;};return _0x4b49();}