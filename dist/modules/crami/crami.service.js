'use strict';const _0x369bfd=_0x2baf;(function(_0x4fe0a4,_0xa6fa25){const _0x4ad2c0=_0x2baf,_0x1a26ad=_0x4fe0a4();while(!![]){try{const _0x5ee686=-parseInt(_0x4ad2c0(0xeb))/0x1+parseInt(_0x4ad2c0(0xf5))/0x2*(parseInt(_0x4ad2c0(0xe5))/0x3)+-parseInt(_0x4ad2c0(0x12e))/0x4*(parseInt(_0x4ad2c0(0xe9))/0x5)+-parseInt(_0x4ad2c0(0xdc))/0x6+-parseInt(_0x4ad2c0(0x11d))/0x7+parseInt(_0x4ad2c0(0x123))/0x8*(-parseInt(_0x4ad2c0(0x10a))/0x9)+-parseInt(_0x4ad2c0(0x12d))/0xa*(-parseInt(_0x4ad2c0(0x121))/0xb);if(_0x5ee686===_0xa6fa25)break;else _0x1a26ad['push'](_0x1a26ad['shift']());}catch(_0x51203f){_0x1a26ad['push'](_0x1a26ad['shift']());}}}(_0x395b,0x7825a));function _0x2baf(_0x201eb1,_0x49a08d){const _0x395b15=_0x395b();return _0x2baf=function(_0x2bafea,_0x233048){_0x2bafea=_0x2bafea-0xda;let _0x5c1c82=_0x395b15[_0x2bafea];return _0x5c1c82;},_0x2baf(_0x201eb1,_0x49a08d);}var __decorate=this&&this[_0x369bfd(0xfe)]||function(_0xa182d3,_0x223442,_0x4cf781,_0x1c7c24){const _0x4fcd98=_0x369bfd;var _0x223fcc=arguments[_0x4fcd98(0xde)],_0x5c38a3=_0x223fcc<0x3?_0x223442:_0x1c7c24===null?_0x1c7c24=Object[_0x4fcd98(0xf3)](_0x223442,_0x4cf781):_0x1c7c24,_0x44c1a9;if(typeof Reflect===_0x4fcd98(0x106)&&typeof Reflect[_0x4fcd98(0x105)]==='function')_0x5c38a3=Reflect[_0x4fcd98(0x105)](_0xa182d3,_0x223442,_0x4cf781,_0x1c7c24);else{for(var _0x2de0af=_0xa182d3[_0x4fcd98(0xde)]-0x1;_0x2de0af>=0x0;_0x2de0af--)if(_0x44c1a9=_0xa182d3[_0x2de0af])_0x5c38a3=(_0x223fcc<0x3?_0x44c1a9(_0x5c38a3):_0x223fcc>0x3?_0x44c1a9(_0x223442,_0x4cf781,_0x5c38a3):_0x44c1a9(_0x223442,_0x4cf781))||_0x5c38a3;}return _0x223fcc>0x3&&_0x5c38a3&&Object[_0x4fcd98(0x111)](_0x223442,_0x4cf781,_0x5c38a3),_0x5c38a3;},__metadata=this&&this['__metadata']||function(_0x808480,_0x4f404f){const _0x140965=_0x369bfd;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x140965(0xfd))return Reflect[_0x140965(0x128)](_0x808480,_0x4f404f);},__param=this&&this[_0x369bfd(0x116)]||function(_0x13130d,_0x11bab5){return function(_0x438d75,_0x1123b4){_0x11bab5(_0x438d75,_0x1123b4,_0x13130d);};};Object[_0x369bfd(0x111)](exports,_0x369bfd(0x113),{'value':!![]}),exports['CramiService']=void 0x0;const common_1=require('@nestjs/common'),crami_entity_1=require('./crami.entity'),typeorm_1=require(_0x369bfd(0xea)),typeorm_2=require(_0x369bfd(0x11b)),cramiPackage_entity_1=require('./cramiPackage.entity'),utils_1=require('../../common/utils'),user_entity_1=require(_0x369bfd(0x114)),userBalance_service_1=require(_0x369bfd(0x119)),balance_constant_1=require(_0x369bfd(0x110));function _0x395b(){const _0x436401=['CramiService','error:\x20','update','732850oJORPX','957928AWgGbB','RechargeType','delCrami','status','maskCrami','design:paramtypes','CramiPackageEntity','1303056EWbolE','affected','length','findAndCount','更新套餐成功！','HttpException','map','role','userBalanceService','18UJnUhY','使用卡密成功','assign','InjectRepository','20qnUypc','@nestjs/typeorm','132965nRAMyv','packageId','addBalanceToUser','push','createPackage','create','log','LessThanOrEqual','getOwnPropertyDescriptor','queryAllCrami','72762lXkUPQ','Injectable','findOne','useCrami','batchDelCrami','Repository','当前卡密已被使用、请确认您输入的卡密是否正确！','updatePackage','function','__decorate','forEach','HttpStatus','自定义卡密必须至少一项余额不为0️零！','userEntity','套餐名称或套餐等级重复、请检查！','cramiPackageEntity','decorate','object','UserEntity','cramiEntity','username','1287bIIxlM','packageName','count','delete','save','useId','../../common/constants/balance.constant','defineProperty','generateCrami','__esModule','../user/user.entity','code','__param','DESC','当前卡密不存在、请确认您要删除的卡密是否存在！','../userBalance/userBalance.service','saveRecordRechargeLog','typeorm','createCrami','6853392TyvqmL','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','super','更新套餐失败、请重试！','429kdYfPq','BAD_REQUEST','16624uFAQlm','UserBalanceService','PACKAGE_GIFT','email','find','metadata','当前卡密已被使用、已使用的卡密禁止删除！'];_0x395b=function(){return _0x436401;};return _0x395b();}let CramiService=class CramiService{constructor(_0x440ce2,_0x23c8de,_0x48032c,_0x1528ad){const _0x904335=_0x369bfd;this[_0x904335(0x108)]=_0x440ce2,this[_0x904335(0x104)]=_0x23c8de,this['userEntity']=_0x48032c,this[_0x904335(0xe4)]=_0x1528ad;}async['queryOnePackage'](_0x2a508e){const _0x107d53=_0x369bfd;return await this[_0x107d53(0x104)]['findOne']({'where':{'id':_0x2a508e}});}async['queryAllPackage'](_0x48576a){const _0x28ec6c=_0x369bfd;try{const {page:page=0x1,size:size=0xa,name:_0x2a3022,status:_0x42393d,type:_0x280a7a}=_0x48576a,_0x4a0c52={};_0x2a3022&&Object[_0x28ec6c(0xe7)](_0x4a0c52,{'name':(0x0,typeorm_2['Like'])('%'+_0x2a3022+'%')}),_0x42393d&&Object[_0x28ec6c(0xe7)](_0x4a0c52,{'status':_0x42393d});_0x280a7a&&(_0x280a7a>0x0?Object[_0x28ec6c(0xe7)](_0x4a0c52,{'days':(0x0,typeorm_2['MoreThan'])(0x0)}):Object[_0x28ec6c(0xe7)](_0x4a0c52,{'days':(0x0,typeorm_2[_0x28ec6c(0xf2)])(0x0)}));const [_0x51ccd4,_0x49b041]=await this[_0x28ec6c(0x104)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0x4a0c52,'order':{'order':_0x28ec6c(0x117)}});return{'rows':_0x51ccd4,'count':_0x49b041};}catch(_0x2be5da){console[_0x28ec6c(0xf1)](_0x28ec6c(0x12b),_0x2be5da);}}async[_0x369bfd(0xef)](_0x29b5a3){const _0x120adb=_0x369bfd,{name:_0x44458a,weight:_0xaa1dfc}=_0x29b5a3,_0x3821fd=await this['cramiPackageEntity'][_0x120adb(0xf7)]({'where':[{'name':_0x44458a},{'weight':_0xaa1dfc}]});if(_0x3821fd)throw new common_1[(_0x120adb(0xe1))](_0x120adb(0x103),common_1['HttpStatus'][_0x120adb(0x122)]);try{return await this[_0x120adb(0x104)]['save'](_0x29b5a3);}catch(_0x31d7a2){console[_0x120adb(0xf1)](_0x120adb(0x12b),_0x31d7a2);throw new common_1['HttpException'](_0x31d7a2,common_1[_0x120adb(0x100)]['BAD_REQUEST']);}}async[_0x369bfd(0xfc)](_0x5eba72){const _0x37db2c=_0x369bfd,{id:_0x1edd20,name:_0x4f1ba9,weight:_0x3258b0}=_0x5eba72,_0x20f712=await this['cramiPackageEntity'][_0x37db2c(0xf7)]({'where':{'id':_0x1edd20}});if(!_0x20f712)throw new common_1[(_0x37db2c(0xe1))]('当前套餐不存在、请检查你的输入参数！',common_1[_0x37db2c(0x100)][_0x37db2c(0x122)]);const _0x5615d9=await this['cramiPackageEntity'][_0x37db2c(0x10c)]({'where':[{'name':_0x4f1ba9,'id':(0x0,typeorm_2['Not'])(_0x1edd20)},{'weight':_0x3258b0,'id':(0x0,typeorm_2['Not'])(_0x1edd20)}]});if(_0x5615d9)throw new common_1[(_0x37db2c(0xe1))](_0x37db2c(0x103),common_1[_0x37db2c(0x100)][_0x37db2c(0x122)]);const _0x3c175c=await this['cramiPackageEntity'][_0x37db2c(0x12c)]({'id':_0x1edd20},_0x5eba72);if(_0x3c175c[_0x37db2c(0xdd)]>0x0)return _0x37db2c(0xe0);else throw new common_1[(_0x37db2c(0xe1))](_0x37db2c(0x120),common_1[_0x37db2c(0x100)]['BAD_REQUEST']);}async['delPackage'](_0x7fdf4e){const _0x2b2ec2=_0x369bfd,{id:_0x22f761}=_0x7fdf4e,_0x3ebe1b=await this[_0x2b2ec2(0x108)][_0x2b2ec2(0x10c)]({'where':{'packageId':_0x22f761}});if(_0x3ebe1b)throw new common_1['HttpException'](_0x2b2ec2(0x11e),common_1[_0x2b2ec2(0x100)][_0x2b2ec2(0x122)]);return await this[_0x2b2ec2(0x104)][_0x2b2ec2(0x10d)]({'id':_0x22f761});}async[_0x369bfd(0x11c)](_0x4b0e1c){const _0x5ce848=_0x369bfd,{packageId:_0x8d8911,count:count=0x1}=_0x4b0e1c;if(_0x8d8911){const _0x511619=await this[_0x5ce848(0x104)][_0x5ce848(0xf7)]({'where':{'id':_0x8d8911}});if(!_0x511619)throw new common_1[(_0x5ce848(0xe1))]('当前套餐不存在、请确认您选择的套餐是否存在！',common_1[_0x5ce848(0x100)][_0x5ce848(0x122)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x511619,_0x4ac25d={'packageId':_0x8d8911,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x5ce848(0x112)](_0x4ac25d,count);}if(!_0x8d8911){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4b0e1c;if([model3Count,model4Count,drawMjCount]['every'](_0x700bd1=>!_0x700bd1))throw new common_1[(_0x5ce848(0xe1))](_0x5ce848(0x101),common_1[_0x5ce848(0x100)]['BAD_REQUEST']);const _0x33d451={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x5ce848(0x112)](_0x33d451,count);}}async['generateCrami'](_0x4423ab,_0x192f3e){const _0x5d6c17=_0x369bfd,_0xc1d865=[];for(let _0x4cd133=0x0;_0x4cd133<_0x192f3e;_0x4cd133++){const _0x2f90f4=(0x0,utils_1['generateCramiCode'])(),_0x2d3c49=this[_0x5d6c17(0x108)][_0x5d6c17(0xf0)](Object[_0x5d6c17(0xe7)](Object[_0x5d6c17(0xe7)]({},_0x4423ab),{'code':_0x2f90f4}));_0xc1d865[_0x5d6c17(0xee)](_0x2d3c49);}return await this[_0x5d6c17(0x108)][_0x5d6c17(0x10e)](_0xc1d865);}async[_0x369bfd(0xf8)](_0x4ca556,_0x44c57a){const _0x264f90=_0x369bfd,{id:_0x5627df}=_0x4ca556['user'],_0x759a1d=await this[_0x264f90(0x108)][_0x264f90(0xf7)]({'where':{'code':_0x44c57a['code']}});if(!_0x759a1d)throw new common_1['HttpException']('当前卡密不存在、请确认您输入的卡密是否正确！',common_1['HttpStatus'][_0x264f90(0x122)]);const {status:_0x4bf222,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x567a4}=_0x759a1d;if(_0x4bf222===0x1)throw new common_1[(_0x264f90(0xe1))](_0x264f90(0xfb),common_1[_0x264f90(0x100)][_0x264f90(0x122)]);const _0x14e233={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x567a4};return await this['userBalanceService'][_0x264f90(0xed)](_0x5627df,Object[_0x264f90(0xe7)]({},_0x14e233),days),await this[_0x264f90(0xe4)][_0x264f90(0x11a)]({'userId':_0x5627df,'rechargeType':balance_constant_1[_0x264f90(0x12f)][_0x264f90(0x125)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this[_0x264f90(0x108)][_0x264f90(0x12c)]({'code':_0x44c57a[_0x264f90(0x115)]},{'useId':_0x5627df,'status':0x1}),_0x264f90(0xe6);}async[_0x369bfd(0xf4)](_0x3daf41,_0x245607){const _0x1c905e=_0x369bfd,{page:page=0x1,size:size=0xa,status:_0x2c5081,useId:_0x1b08f9}=_0x3daf41,_0x583f19={};_0x2c5081&&Object['assign'](_0x583f19,{'status':_0x2c5081}),_0x1b08f9&&Object[_0x1c905e(0xe7)](_0x583f19,{'useId':_0x1b08f9});const [_0x16f7a0,_0x145e57]=await this[_0x1c905e(0x108)][_0x1c905e(0xdf)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':_0x1c905e(0x117)},'where':_0x583f19}),_0x4331b4=_0x16f7a0[_0x1c905e(0xe2)](_0x4552d9=>_0x4552d9[_0x1c905e(0x10f)]),_0x39a5a2=_0x16f7a0[_0x1c905e(0xe2)](_0x43b724=>_0x43b724[_0x1c905e(0xec)]),_0x1bf614=await this[_0x1c905e(0x102)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x4331b4)}}),_0x4331a8=await this[_0x1c905e(0x104)][_0x1c905e(0x127)]({'where':{'id':(0x0,typeorm_2['In'])(_0x39a5a2)}});return _0x16f7a0[_0x1c905e(0xff)](_0x5310fe=>{const _0x3ca1e3=_0x1c905e;var _0x5e0666,_0x4d04ba,_0x3f4b5b;_0x5310fe[_0x3ca1e3(0x109)]=(_0x5e0666=_0x1bf614[_0x3ca1e3(0x127)](_0xd380c3=>_0xd380c3['id']===_0x5310fe[_0x3ca1e3(0x10f)]))===null||_0x5e0666===void 0x0?void 0x0:_0x5e0666['username'],_0x5310fe[_0x3ca1e3(0x126)]=(_0x4d04ba=_0x1bf614[_0x3ca1e3(0x127)](_0x338d68=>_0x338d68['id']===_0x5310fe[_0x3ca1e3(0x10f)]))===null||_0x4d04ba===void 0x0?void 0x0:_0x4d04ba[_0x3ca1e3(0x126)],_0x5310fe[_0x3ca1e3(0x10b)]=(_0x3f4b5b=_0x4331a8['find'](_0x1d4449=>_0x1d4449['id']===_0x5310fe[_0x3ca1e3(0xec)]))===null||_0x3f4b5b===void 0x0?void 0x0:_0x3f4b5b['name'];}),_0x245607['user'][_0x1c905e(0xe3)]!==_0x1c905e(0x11f)&&_0x16f7a0['forEach'](_0x29be8d=>_0x29be8d[_0x1c905e(0x126)]=(0x0,utils_1['maskEmail'])(_0x29be8d[_0x1c905e(0x126)])),_0x245607['user']['role']!==_0x1c905e(0x11f)&&_0x16f7a0['forEach'](_0x3faea4=>_0x3faea4['code']=(0x0,utils_1[_0x1c905e(0x132)])(_0x3faea4[_0x1c905e(0x115)])),{'rows':_0x16f7a0,'count':_0x145e57};}async[_0x369bfd(0x130)](_0x33c7fc){const _0x4a6898=_0x369bfd,_0x5690fb=await this['cramiEntity'][_0x4a6898(0xf7)]({'where':{'id':_0x33c7fc}});if(!_0x5690fb)throw new common_1[(_0x4a6898(0xe1))](_0x4a6898(0x118),common_1[_0x4a6898(0x100)][_0x4a6898(0x122)]);if(_0x5690fb[_0x4a6898(0x131)]===0x1)throw new common_1[(_0x4a6898(0xe1))](_0x4a6898(0x129),common_1['HttpStatus'][_0x4a6898(0x122)]);return await this[_0x4a6898(0x108)][_0x4a6898(0x10d)]({'id':_0x33c7fc});}async[_0x369bfd(0xf9)](_0x1171d3){const _0x194443=_0x369bfd,{ids:_0x2a2b25}=_0x1171d3,_0x49997f=await this['cramiEntity'][_0x194443(0x10d)](_0x2a2b25);if(_0x49997f[_0x194443(0xdd)]>0x0)return'删除卡密成功！';else throw new common_1[(_0x194443(0xe1))]('删除卡密失败、请重试！',common_1[_0x194443(0x100)][_0x194443(0x122)]);}};CramiService=__decorate([(0x0,common_1[_0x369bfd(0xf6)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(crami_entity_1['CramiEntity'])),__param(0x1,(0x0,typeorm_1[_0x369bfd(0xe8)])(cramiPackage_entity_1[_0x369bfd(0xdb)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x369bfd(0x107)])),__metadata(_0x369bfd(0xda),[typeorm_2['Repository'],typeorm_2[_0x369bfd(0xfa)],typeorm_2[_0x369bfd(0xfa)],userBalance_service_1[_0x369bfd(0x124)]])],CramiService),exports[_0x369bfd(0x12a)]=CramiService;