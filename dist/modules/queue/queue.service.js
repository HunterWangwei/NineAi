'use strict';const _0x54c954=_0x354c;(function(_0x41e7c0,_0x3b2d84){const _0x3d2397=_0x354c,_0x3baf26=_0x41e7c0();while(!![]){try{const _0x3a6742=-parseInt(_0x3d2397(0x17f))/0x1+parseInt(_0x3d2397(0x199))/0x2+parseInt(_0x3d2397(0x1a2))/0x3+parseInt(_0x3d2397(0x1a6))/0x4+-parseInt(_0x3d2397(0x176))/0x5*(parseInt(_0x3d2397(0x185))/0x6)+-parseInt(_0x3d2397(0x18f))/0x7+-parseInt(_0x3d2397(0x195))/0x8;if(_0x3a6742===_0x3b2d84)break;else _0x3baf26['push'](_0x3baf26['shift']());}catch(_0x2d6897){_0x3baf26['push'](_0x3baf26['shift']());}}}(_0x37d5,0x6f736));function _0x37d5(){const _0x52879a=['GlobalConfigService','addDrawQueue','push','mjDrawQueue','835815MqCIht','../midjourney/midjourney.service','MidjourneyService','globalConfigService','MidjourneyActionEnum','QueueService','../userBalance/userBalance.service','@nestjs/bull','add','266895abXQHn','user','checkIsUpscale','__param','onApplicationBootstrap','active','30eFevoS','assign','jobIds','function','validateBalance','getDrawActionDetail','length','../globalConfig/globalConfig.service','userBalanceService','mjDraw','39781JcJSJG','REGENERATE','../../common/utils','metadata','VARY','MJDRAW','2171864KKTfLt','BAD_REQUEST','DRAW','mjTimeoutMs','511892YWugfO','cleanQueue','UPSCALE','HttpException','__decorate','getOwnPropertyDescriptor','clean','getConfigs','midjourneyService','2563857kVGgJs','decorate','UserBalanceService','createRandomUid','2903252NSdGzw','../../common/constants/midjourney.constant','ZOOM','checkLimit','getQueue','object','__metadata','defineProperty','deductFromBalance'];_0x37d5=function(){return _0x52879a;};return _0x37d5();}var __decorate=this&&this[_0x54c954(0x19d)]||function(_0x4dada0,_0xf8bdcd,_0xa459a2,_0x135001){const _0x180085=_0x54c954;var _0x4e3963=arguments[_0x180085(0x18b)],_0x344f84=_0x4e3963<0x3?_0xf8bdcd:_0x135001===null?_0x135001=Object[_0x180085(0x19e)](_0xf8bdcd,_0xa459a2):_0x135001,_0x9f6618;if(typeof Reflect===_0x180085(0x16e)&&typeof Reflect[_0x180085(0x1a3)]==='function')_0x344f84=Reflect['decorate'](_0x4dada0,_0xf8bdcd,_0xa459a2,_0x135001);else{for(var _0x5e3d23=_0x4dada0['length']-0x1;_0x5e3d23>=0x0;_0x5e3d23--)if(_0x9f6618=_0x4dada0[_0x5e3d23])_0x344f84=(_0x4e3963<0x3?_0x9f6618(_0x344f84):_0x4e3963>0x3?_0x9f6618(_0xf8bdcd,_0xa459a2,_0x344f84):_0x9f6618(_0xf8bdcd,_0xa459a2))||_0x344f84;}return _0x4e3963>0x3&&_0x344f84&&Object[_0x180085(0x170)](_0xf8bdcd,_0xa459a2,_0x344f84),_0x344f84;},__metadata=this&&this[_0x54c954(0x16f)]||function(_0x343066,_0x5c8b39){const _0x14404f=_0x54c954;if(typeof Reflect===_0x14404f(0x16e)&&typeof Reflect['metadata']===_0x14404f(0x188))return Reflect[_0x14404f(0x192)](_0x343066,_0x5c8b39);},__param=this&&this[_0x54c954(0x182)]||function(_0x5a3b47,_0x24371b){return function(_0x4b678b,_0x26e3a0){_0x24371b(_0x4b678b,_0x26e3a0,_0x5a3b47);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['QueueService']=void 0x0;const common_1=require('@nestjs/common'),bull_1=require(_0x54c954(0x17d)),utils_1=require(_0x54c954(0x191)),midjourney_service_1=require(_0x54c954(0x177)),midjourney_constant_1=require(_0x54c954(0x1a7)),userBalance_service_1=require(_0x54c954(0x17c)),globalConfig_service_1=require(_0x54c954(0x18c));let QueueService=class QueueService{constructor(_0x59dc0d,_0x509089,_0x3a7343,_0x4c8626){const _0x41127b=_0x54c954;this[_0x41127b(0x175)]=_0x59dc0d,this['midjourneyService']=_0x509089,this[_0x41127b(0x18d)]=_0x3a7343,this[_0x41127b(0x179)]=_0x4c8626,this[_0x41127b(0x187)]=[];}async[_0x54c954(0x183)](){const _0x42d353=_0x54c954;await this[_0x42d353(0x175)][_0x42d353(0x19f)](0x0,_0x42d353(0x184)),await this[_0x42d353(0x1a1)][_0x42d353(0x19a)]();}async['addMjDrawQueue'](_0x123805,_0x3aea6e){const _0x7d38a3=_0x54c954,{prompt:_0x12d12d,imgUrl:_0x10cb8f,extraParam:_0x52bb22,orderId:_0x2a8b91,action:action=0x1,drawId:_0x1e33d3}=_0x123805;await this[_0x7d38a3(0x1a1)][_0x7d38a3(0x1a9)](_0x3aea6e),await this['userBalanceService'][_0x7d38a3(0x189)](_0x3aea6e,_0x7d38a3(0x18e),action===0x2?0x1:0x4);if(action===midjourney_constant_1['MidjourneyActionEnum'][_0x7d38a3(0x197)]||action===midjourney_constant_1[_0x7d38a3(0x17a)]['GENERATE']){const _0x3062c6=''+(0x0,utils_1[_0x7d38a3(0x1a5)])(),_0x43957b=Object['assign'](Object['assign']({},_0x123805),{'userId':_0x3aea6e[_0x7d38a3(0x180)]['id'],'randomDrawId':_0x3062c6}),_0x4d3f83=await this[_0x7d38a3(0x1a1)]['addDrawQueue'](_0x43957b),_0x2fcb20=await this[_0x7d38a3(0x179)]['getConfigs']([_0x7d38a3(0x198)])||0x30d40,_0x5c4ea7=await this[_0x7d38a3(0x175)]['add'](_0x7d38a3(0x18e),{'id':_0x4d3f83['id'],'action':_0x10cb8f?0x4:0x1,'userId':_0x3aea6e[_0x7d38a3(0x180)]['id']},{'delay':0x3e8,'timeout':+_0x2fcb20});return this['jobIds']['push'](_0x5c4ea7['id']),await this[_0x7d38a3(0x18d)][_0x7d38a3(0x171)](_0x3aea6e[_0x7d38a3(0x180)]['id'],_0x7d38a3(0x18e),0x4,0x4),!![];}if(!_0x1e33d3||!_0x2a8b91)throw new common_1[(_0x7d38a3(0x19c))]('缺少必要参数！',common_1['HttpStatus'][_0x7d38a3(0x196)]);if(action===midjourney_constant_1['MidjourneyActionEnum'][_0x7d38a3(0x19b)]){const _0x4c5155=await this[_0x7d38a3(0x1a1)][_0x7d38a3(0x18a)](action,_0x1e33d3,_0x2a8b91),{custom_id:_0x4b096f}=_0x4c5155;await this['midjourneyService'][_0x7d38a3(0x181)](_0x4b096f);const _0xeb64f8=Object[_0x7d38a3(0x186)](Object[_0x7d38a3(0x186)](Object[_0x7d38a3(0x186)]({},_0x123805),{'userId':_0x3aea6e[_0x7d38a3(0x180)]['id']}),_0x4c5155),_0x55f93e=await this[_0x7d38a3(0x1a1)][_0x7d38a3(0x173)](_0xeb64f8),_0x3db388=await this['globalConfigService']['getConfigs']([_0x7d38a3(0x198)])||0x30d40,_0x1f2670=await this[_0x7d38a3(0x175)][_0x7d38a3(0x17e)](_0x7d38a3(0x18e),{'id':_0x55f93e['id'],'action':action,'userId':_0x3aea6e[_0x7d38a3(0x180)]['id']},{'delay':0x3e8,'timeout':+_0x3db388});await this['userBalanceService'][_0x7d38a3(0x171)](_0x3aea6e['user']['id'],_0x7d38a3(0x18e),0x1,0x1),this[_0x7d38a3(0x187)][_0x7d38a3(0x174)](_0x1f2670['id']);return;}if(action===midjourney_constant_1[_0x7d38a3(0x17a)]['VARIATION']){const _0x5a15c7=await this[_0x7d38a3(0x1a1)]['getDrawActionDetail'](action,_0x1e33d3,_0x2a8b91),_0x1b1bd0=Object[_0x7d38a3(0x186)](Object['assign'](Object[_0x7d38a3(0x186)]({},_0x123805),{'userId':_0x3aea6e[_0x7d38a3(0x180)]['id']}),_0x5a15c7),_0x276b9c=await this[_0x7d38a3(0x1a1)][_0x7d38a3(0x173)](_0x1b1bd0),_0x53dc36=await this['globalConfigService'][_0x7d38a3(0x1a0)]([_0x7d38a3(0x198)])||0x30d40,_0x21354c=await this[_0x7d38a3(0x175)][_0x7d38a3(0x17e)](_0x7d38a3(0x18e),{'id':_0x276b9c['id'],'action':action,'userId':_0x3aea6e[_0x7d38a3(0x180)]['id']},{'delay':0x3e8,'timeout':+_0x53dc36});this[_0x7d38a3(0x187)][_0x7d38a3(0x174)](_0x21354c['id']),await this[_0x7d38a3(0x18d)][_0x7d38a3(0x171)](_0x3aea6e[_0x7d38a3(0x180)]['id'],_0x7d38a3(0x18e),0x4,0x4);return;}if(action===midjourney_constant_1['MidjourneyActionEnum'][_0x7d38a3(0x190)]){const _0x4a23d5=await this['midjourneyService'][_0x7d38a3(0x18a)](action,_0x1e33d3,_0x2a8b91),_0x34fada=Object['assign'](Object['assign'](Object[_0x7d38a3(0x186)]({},_0x123805),{'userId':_0x3aea6e[_0x7d38a3(0x180)]['id']}),_0x4a23d5),_0x326879=await this['midjourneyService']['addDrawQueue'](_0x34fada),_0x546671=await this[_0x7d38a3(0x179)][_0x7d38a3(0x1a0)]([_0x7d38a3(0x198)])||0x30d40,_0x2392ae=await this[_0x7d38a3(0x175)][_0x7d38a3(0x17e)](_0x7d38a3(0x18e),{'id':_0x326879['id'],'action':action,'userId':_0x3aea6e[_0x7d38a3(0x180)]['id']},{'delay':0x3e8,'timeout':+_0x546671});this['jobIds']['push'](_0x2392ae['id']),await this[_0x7d38a3(0x18d)][_0x7d38a3(0x171)](_0x3aea6e[_0x7d38a3(0x180)]['id'],_0x7d38a3(0x18e),0x4,0x4);return;}if(action===midjourney_constant_1[_0x7d38a3(0x17a)][_0x7d38a3(0x193)]){const _0x14ee7a=await this[_0x7d38a3(0x1a1)][_0x7d38a3(0x18a)](action,_0x1e33d3,_0x2a8b91),_0x256ed7=Object[_0x7d38a3(0x186)](Object[_0x7d38a3(0x186)](Object['assign']({},_0x123805),{'userId':_0x3aea6e[_0x7d38a3(0x180)]['id']}),_0x14ee7a),_0x4aadd1=await this['midjourneyService']['addDrawQueue'](_0x256ed7),_0x537870=await this[_0x7d38a3(0x179)][_0x7d38a3(0x1a0)]([_0x7d38a3(0x198)])||0x30d40,_0x3cc507=await this['mjDrawQueue'][_0x7d38a3(0x17e)](_0x7d38a3(0x18e),{'id':_0x4aadd1['id'],'action':action,'userId':_0x3aea6e['user']['id']},{'delay':0x3e8,'timeout':+_0x537870});this[_0x7d38a3(0x187)][_0x7d38a3(0x174)](_0x3cc507['id']),await this[_0x7d38a3(0x18d)][_0x7d38a3(0x171)](_0x3aea6e[_0x7d38a3(0x180)]['id'],_0x7d38a3(0x18e),0x4,0x4);return;}if(action===midjourney_constant_1[_0x7d38a3(0x17a)][_0x7d38a3(0x1a8)]){const _0x15ac3d=await this[_0x7d38a3(0x1a1)][_0x7d38a3(0x18a)](action,_0x1e33d3,_0x2a8b91),_0x41104d=Object[_0x7d38a3(0x186)](Object[_0x7d38a3(0x186)](Object[_0x7d38a3(0x186)]({},_0x123805),{'userId':_0x3aea6e[_0x7d38a3(0x180)]['id']}),_0x15ac3d),_0x10ad49=await this[_0x7d38a3(0x1a1)]['addDrawQueue'](_0x41104d),_0x3fc26d=await this['globalConfigService'][_0x7d38a3(0x1a0)]([_0x7d38a3(0x198)])||0x30d40,_0x3c0fc9=await this['mjDrawQueue'][_0x7d38a3(0x17e)](_0x7d38a3(0x18e),{'id':_0x10ad49['id'],'action':action,'userId':_0x3aea6e[_0x7d38a3(0x180)]['id']},{'delay':0x3e8,'timeout':+_0x3fc26d});this[_0x7d38a3(0x187)][_0x7d38a3(0x174)](_0x3c0fc9['id']),await this[_0x7d38a3(0x18d)][_0x7d38a3(0x171)](_0x3aea6e['user']['id'],_0x7d38a3(0x18e),0x4,0x4);return;}}async[_0x54c954(0x16d)](){const _0xb3a3a6=_0x54c954;return{'jobIds':this[_0xb3a3a6(0x187)]};}};function _0x354c(_0x228bfd,_0x1c45bb){const _0x37d508=_0x37d5();return _0x354c=function(_0x354c98,_0x3bbc9b){_0x354c98=_0x354c98-0x16d;let _0x138b60=_0x37d508[_0x354c98];return _0x138b60;},_0x354c(_0x228bfd,_0x1c45bb);}QueueService=__decorate([__param(0x0,(0x0,bull_1['InjectQueue'])(_0x54c954(0x194))),__metadata('design:paramtypes',[Object,midjourney_service_1[_0x54c954(0x178)],userBalance_service_1[_0x54c954(0x1a4)],globalConfig_service_1[_0x54c954(0x172)]])],QueueService),exports[_0x54c954(0x17b)]=QueueService;