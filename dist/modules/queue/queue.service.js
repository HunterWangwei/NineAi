'use strict';function _0x5178(){const _0x537098=['getOwnPropertyDescriptor','user','mjDrawQueue','UPSCALE','MidjourneyService','GlobalConfigService','validateBalance','InjectQueue','11628DBusJA','createRandomUid','../userBalance/userBalance.service','deductFromBalance','clean','1263594WvaCIX','object','midjourneyService','432754QptLpw','32uxDRjm','REGENERATE','950lLJvhB','UserBalanceService','checkIsUpscale','active','getConfigs','userBalanceService','addDrawQueue','4288428UWPqkw','push','446877SsZSKy','jobIds','347886Eytkly','design:paramtypes','addMjDrawQueue','length','HttpException','@nestjs/common','function','VARY','getQueue','DRAW','mjTimeoutMs','globalConfigService','../../common/constants/midjourney.constant','assign','HttpStatus','add','decorate','metadata','BAD_REQUEST','getDrawActionDetail','1318148YDdWSk','QueueService','../midjourney/midjourney.service','mjDraw','MidjourneyActionEnum','缺少必要参数！','VARIATION','onApplicationBootstrap','checkLimit'];_0x5178=function(){return _0x537098;};return _0x5178();}const _0x244958=_0x59f4;(function(_0x1ee579,_0x48dabd){const _0x2086f0=_0x59f4,_0x5295dc=_0x1ee579();while(!![]){try{const _0x29a41a=-parseInt(_0x2086f0(0x162))/0x1+-parseInt(_0x2086f0(0x176))/0x2+-parseInt(_0x2086f0(0x19b))/0x3+parseInt(_0x2086f0(0x187))/0x4*(parseInt(_0x2086f0(0x192))/0x5)+parseInt(_0x2086f0(0x18c))/0x6+-parseInt(_0x2086f0(0x18f))/0x7*(-parseInt(_0x2086f0(0x190))/0x8)+parseInt(_0x2086f0(0x199))/0x9;if(_0x29a41a===_0x48dabd)break;else _0x5295dc['push'](_0x5295dc['shift']());}catch(_0x13067c){_0x5295dc['push'](_0x5295dc['shift']());}}}(_0x5178,0x50c26));var __decorate=this&&this['__decorate']||function(_0x469020,_0x108d85,_0x4215de,_0x47b002){const _0x2bf93e=_0x59f4;var _0x477eea=arguments['length'],_0x193621=_0x477eea<0x3?_0x108d85:_0x47b002===null?_0x47b002=Object[_0x2bf93e(0x17f)](_0x108d85,_0x4215de):_0x47b002,_0x444b3b;if(typeof Reflect==='object'&&typeof Reflect[_0x2bf93e(0x172)]===_0x2bf93e(0x168))_0x193621=Reflect['decorate'](_0x469020,_0x108d85,_0x4215de,_0x47b002);else{for(var _0x10e363=_0x469020[_0x2bf93e(0x165)]-0x1;_0x10e363>=0x0;_0x10e363--)if(_0x444b3b=_0x469020[_0x10e363])_0x193621=(_0x477eea<0x3?_0x444b3b(_0x193621):_0x477eea>0x3?_0x444b3b(_0x108d85,_0x4215de,_0x193621):_0x444b3b(_0x108d85,_0x4215de))||_0x193621;}return _0x477eea>0x3&&_0x193621&&Object['defineProperty'](_0x108d85,_0x4215de,_0x193621),_0x193621;},__metadata=this&&this['__metadata']||function(_0x1cc42b,_0x3a12a9){const _0x55ea15=_0x59f4;if(typeof Reflect===_0x55ea15(0x18d)&&typeof Reflect[_0x55ea15(0x173)]===_0x55ea15(0x168))return Reflect[_0x55ea15(0x173)](_0x1cc42b,_0x3a12a9);},__param=this&&this['__param']||function(_0xa3ba74,_0x1feeb9){return function(_0x11d7eb,_0x16e59f){_0x1feeb9(_0x11d7eb,_0x16e59f,_0xa3ba74);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x244958(0x177)]=void 0x0;function _0x59f4(_0x2e6784,_0x3bb1b8){const _0x51788a=_0x5178();return _0x59f4=function(_0x59f470,_0x339b7f){_0x59f470=_0x59f470-0x162;let _0xb36d0c=_0x51788a[_0x59f470];return _0xb36d0c;},_0x59f4(_0x2e6784,_0x3bb1b8);}const common_1=require(_0x244958(0x167)),bull_1=require('@nestjs/bull'),utils_1=require('../../common/utils'),midjourney_service_1=require(_0x244958(0x178)),midjourney_constant_1=require(_0x244958(0x16e)),userBalance_service_1=require(_0x244958(0x189)),globalConfig_service_1=require('../globalConfig/globalConfig.service');let QueueService=class QueueService{constructor(_0x5c0839,_0x5ac332,_0x4bb99c,_0x58cbfd){const _0xf7197b=_0x244958;this[_0xf7197b(0x181)]=_0x5c0839,this[_0xf7197b(0x18e)]=_0x5ac332,this[_0xf7197b(0x197)]=_0x4bb99c,this[_0xf7197b(0x16d)]=_0x58cbfd,this[_0xf7197b(0x19c)]=[];}async[_0x244958(0x17d)](){const _0x3d3ed2=_0x244958;await this[_0x3d3ed2(0x181)][_0x3d3ed2(0x18b)](0x0,_0x3d3ed2(0x195)),await this[_0x3d3ed2(0x18e)]['cleanQueue']();}async[_0x244958(0x164)](_0x592fbb,_0x1096c1){const _0x501b79=_0x244958,{prompt:_0x2cce94,imgUrl:_0x5c182f,extraParam:_0x460446,orderId:_0x2c679b,action:action=0x1,drawId:_0x2ae85a}=_0x592fbb;await this['midjourneyService'][_0x501b79(0x17e)](_0x1096c1),await this[_0x501b79(0x197)][_0x501b79(0x185)](_0x1096c1,_0x501b79(0x179),action===0x2?0x1:0x4);if(action===midjourney_constant_1[_0x501b79(0x17a)][_0x501b79(0x16b)]||action===midjourney_constant_1[_0x501b79(0x17a)]['GENERATE']){const _0xcd389b=''+(0x0,utils_1[_0x501b79(0x188)])(),_0x55e727=Object[_0x501b79(0x16f)](Object[_0x501b79(0x16f)]({},_0x592fbb),{'userId':_0x1096c1[_0x501b79(0x180)]['id'],'randomDrawId':_0xcd389b}),_0x5996ec=await this[_0x501b79(0x18e)][_0x501b79(0x198)](_0x55e727),_0x39c805=await this[_0x501b79(0x16d)][_0x501b79(0x196)]([_0x501b79(0x16c)])||0x30d40,_0x4d386f=await this[_0x501b79(0x181)]['add']('mjDraw',{'id':_0x5996ec['id'],'action':_0x5c182f?0x4:0x1,'userId':_0x1096c1['user']['id']},{'delay':0x3e8,'timeout':+_0x39c805});return this['jobIds']['push'](_0x4d386f['id']),await this['userBalanceService'][_0x501b79(0x18a)](_0x1096c1[_0x501b79(0x180)]['id'],_0x501b79(0x179),0x4,0x4),!![];}if(!_0x2ae85a||!_0x2c679b)throw new common_1[(_0x501b79(0x166))](_0x501b79(0x17b),common_1[_0x501b79(0x170)][_0x501b79(0x174)]);if(action===midjourney_constant_1[_0x501b79(0x17a)][_0x501b79(0x182)]){const _0x3a76bd=await this['midjourneyService'][_0x501b79(0x175)](action,_0x2ae85a,_0x2c679b),{custom_id:_0x114c50}=_0x3a76bd;await this['midjourneyService'][_0x501b79(0x194)](_0x114c50);const _0x5ea51a=Object[_0x501b79(0x16f)](Object[_0x501b79(0x16f)](Object[_0x501b79(0x16f)]({},_0x592fbb),{'userId':_0x1096c1[_0x501b79(0x180)]['id']}),_0x3a76bd),_0x152462=await this[_0x501b79(0x18e)]['addDrawQueue'](_0x5ea51a),_0x3ed4bc=await this[_0x501b79(0x16d)]['getConfigs']([_0x501b79(0x16c)])||0x30d40,_0x202027=await this['mjDrawQueue'][_0x501b79(0x171)](_0x501b79(0x179),{'id':_0x152462['id'],'action':action,'userId':_0x1096c1[_0x501b79(0x180)]['id']},{'delay':0x3e8,'timeout':+_0x3ed4bc});await this[_0x501b79(0x197)]['deductFromBalance'](_0x1096c1['user']['id'],_0x501b79(0x179),0x1,0x1),this['jobIds'][_0x501b79(0x19a)](_0x202027['id']);return;}if(action===midjourney_constant_1[_0x501b79(0x17a)][_0x501b79(0x17c)]){const _0x4177f5=await this[_0x501b79(0x18e)][_0x501b79(0x175)](action,_0x2ae85a,_0x2c679b),_0x386d08=Object[_0x501b79(0x16f)](Object[_0x501b79(0x16f)](Object[_0x501b79(0x16f)]({},_0x592fbb),{'userId':_0x1096c1[_0x501b79(0x180)]['id']}),_0x4177f5),_0x3a2da7=await this['midjourneyService'][_0x501b79(0x198)](_0x386d08),_0x1f2c59=await this['globalConfigService']['getConfigs']([_0x501b79(0x16c)])||0x30d40,_0x3ad1da=await this[_0x501b79(0x181)][_0x501b79(0x171)](_0x501b79(0x179),{'id':_0x3a2da7['id'],'action':action,'userId':_0x1096c1['user']['id']},{'delay':0x3e8,'timeout':+_0x1f2c59});this['jobIds']['push'](_0x3ad1da['id']),await this[_0x501b79(0x197)]['deductFromBalance'](_0x1096c1[_0x501b79(0x180)]['id'],'mjDraw',0x4,0x4);return;}if(action===midjourney_constant_1[_0x501b79(0x17a)][_0x501b79(0x191)]){const _0x480c56=await this[_0x501b79(0x18e)][_0x501b79(0x175)](action,_0x2ae85a,_0x2c679b),_0x351ab8=Object[_0x501b79(0x16f)](Object[_0x501b79(0x16f)](Object[_0x501b79(0x16f)]({},_0x592fbb),{'userId':_0x1096c1[_0x501b79(0x180)]['id']}),_0x480c56),_0x2eeb2f=await this['midjourneyService']['addDrawQueue'](_0x351ab8),_0x4a76eb=await this['globalConfigService'][_0x501b79(0x196)](['mjTimeoutMs'])||0x30d40,_0x16adcb=await this[_0x501b79(0x181)]['add'](_0x501b79(0x179),{'id':_0x2eeb2f['id'],'action':action,'userId':_0x1096c1[_0x501b79(0x180)]['id']},{'delay':0x3e8,'timeout':+_0x4a76eb});this['jobIds'][_0x501b79(0x19a)](_0x16adcb['id']),await this['userBalanceService'][_0x501b79(0x18a)](_0x1096c1['user']['id'],_0x501b79(0x179),0x4,0x4);return;}if(action===midjourney_constant_1['MidjourneyActionEnum'][_0x501b79(0x169)]){const _0x4af621=await this['midjourneyService']['getDrawActionDetail'](action,_0x2ae85a,_0x2c679b),_0x4068db=Object[_0x501b79(0x16f)](Object[_0x501b79(0x16f)](Object[_0x501b79(0x16f)]({},_0x592fbb),{'userId':_0x1096c1[_0x501b79(0x180)]['id']}),_0x4af621),_0x518f63=await this[_0x501b79(0x18e)][_0x501b79(0x198)](_0x4068db),_0x5b6ce9=await this[_0x501b79(0x16d)]['getConfigs']([_0x501b79(0x16c)])||0x30d40,_0x38be50=await this[_0x501b79(0x181)]['add'](_0x501b79(0x179),{'id':_0x518f63['id'],'action':action,'userId':_0x1096c1[_0x501b79(0x180)]['id']},{'delay':0x3e8,'timeout':+_0x5b6ce9});this[_0x501b79(0x19c)][_0x501b79(0x19a)](_0x38be50['id']),await this[_0x501b79(0x197)]['deductFromBalance'](_0x1096c1[_0x501b79(0x180)]['id'],_0x501b79(0x179),0x4,0x4);return;}if(action===midjourney_constant_1[_0x501b79(0x17a)]['ZOOM']){const _0x9c4c7e=await this['midjourneyService'][_0x501b79(0x175)](action,_0x2ae85a,_0x2c679b),_0x4e8151=Object[_0x501b79(0x16f)](Object[_0x501b79(0x16f)](Object[_0x501b79(0x16f)]({},_0x592fbb),{'userId':_0x1096c1[_0x501b79(0x180)]['id']}),_0x9c4c7e),_0x578101=await this[_0x501b79(0x18e)][_0x501b79(0x198)](_0x4e8151),_0x5c05c2=await this[_0x501b79(0x16d)]['getConfigs']([_0x501b79(0x16c)])||0x30d40,_0x2b9efa=await this[_0x501b79(0x181)][_0x501b79(0x171)](_0x501b79(0x179),{'id':_0x578101['id'],'action':action,'userId':_0x1096c1[_0x501b79(0x180)]['id']},{'delay':0x3e8,'timeout':+_0x5c05c2});this['jobIds']['push'](_0x2b9efa['id']),await this[_0x501b79(0x197)]['deductFromBalance'](_0x1096c1[_0x501b79(0x180)]['id'],'mjDraw',0x4,0x4);return;}}async[_0x244958(0x16a)](){const _0x36904d=_0x244958;return{'jobIds':this[_0x36904d(0x19c)]};}};QueueService=__decorate([__param(0x0,(0x0,bull_1[_0x244958(0x186)])('MJDRAW')),__metadata(_0x244958(0x163),[Object,midjourney_service_1[_0x244958(0x183)],userBalance_service_1[_0x244958(0x193)],globalConfig_service_1[_0x244958(0x184)]])],QueueService),exports[_0x244958(0x177)]=QueueService;