'use strict';const _0x1c9e0a=_0x510b;(function(_0x3d8d92,_0x1036a0){const _0x1f219c=_0x510b,_0x1e9fee=_0x3d8d92();while(!![]){try{const _0x477dd7=parseInt(_0x1f219c(0x22a))/0x1+parseInt(_0x1f219c(0x1f1))/0x2*(-parseInt(_0x1f219c(0x210))/0x3)+-parseInt(_0x1f219c(0x1f3))/0x4+-parseInt(_0x1f219c(0x1fb))/0x5+parseInt(_0x1f219c(0x221))/0x6*(parseInt(_0x1f219c(0x1fc))/0x7)+-parseInt(_0x1f219c(0x223))/0x8*(-parseInt(_0x1f219c(0x21d))/0x9)+parseInt(_0x1f219c(0x1f2))/0xa*(parseInt(_0x1f219c(0x222))/0xb);if(_0x477dd7===_0x1036a0)break;else _0x1e9fee['push'](_0x1e9fee['shift']());}catch(_0x46fd9c){_0x1e9fee['push'](_0x1e9fee['shift']());}}}(_0x516a,0x95585));function _0x516a(){const _0x56fcff=['cleanQueue','@nestjs/common','jobIds','object','clean','userBalanceService','MidjourneyService','VARY','@nestjs/bull','getDrawActionDetail','function','length','decorate','5646NvAswN','UserBalanceService','addDrawQueue','assign','MidjourneyActionEnum','REGENERATE','createRandomUid','BAD_REQUEST','getConfigs','MJDRAW','active','VARIATION','getQueue','333pgCafz','midjourneyService','mjTimeoutMs','GlobalConfigService','6aGepSR','66xihwvE','246232GeVSJK','onApplicationBootstrap','ZOOM','InjectQueue','../../common/constants/midjourney.constant','缺少必要参数！','defineProperty','171124WZFtVD','../midjourney/midjourney.service','UPSCALE','user','globalConfigService','push','626PWjjQA','2090430oIuOwF','4308316qiphgC','deductFromBalance','mjDrawQueue','checkIsUpscale','DRAW','add','validateBalance','mjDraw','2772320ObPojq','1876847gzbEKJ','addMjDrawQueue','GENERATE','checkLimit','getOwnPropertyDescriptor','metadata','QueueService'];_0x516a=function(){return _0x56fcff;};return _0x516a();}var __decorate=this&&this['__decorate']||function(_0x318c4f,_0x1a2812,_0x1191f0,_0x1ba01e){const _0x4b6e33=_0x510b;var _0x3ec905=arguments[_0x4b6e33(0x20e)],_0x48f90f=_0x3ec905<0x3?_0x1a2812:_0x1ba01e===null?_0x1ba01e=Object[_0x4b6e33(0x200)](_0x1a2812,_0x1191f0):_0x1ba01e,_0x47322a;if(typeof Reflect===_0x4b6e33(0x206)&&typeof Reflect[_0x4b6e33(0x20f)]===_0x4b6e33(0x20d))_0x48f90f=Reflect['decorate'](_0x318c4f,_0x1a2812,_0x1191f0,_0x1ba01e);else{for(var _0x58c79c=_0x318c4f[_0x4b6e33(0x20e)]-0x1;_0x58c79c>=0x0;_0x58c79c--)if(_0x47322a=_0x318c4f[_0x58c79c])_0x48f90f=(_0x3ec905<0x3?_0x47322a(_0x48f90f):_0x3ec905>0x3?_0x47322a(_0x1a2812,_0x1191f0,_0x48f90f):_0x47322a(_0x1a2812,_0x1191f0))||_0x48f90f;}return _0x3ec905>0x3&&_0x48f90f&&Object['defineProperty'](_0x1a2812,_0x1191f0,_0x48f90f),_0x48f90f;},__metadata=this&&this['__metadata']||function(_0xddfc92,_0x1acba3){const _0x1775d6=_0x510b;if(typeof Reflect==='object'&&typeof Reflect[_0x1775d6(0x201)]===_0x1775d6(0x20d))return Reflect[_0x1775d6(0x201)](_0xddfc92,_0x1acba3);},__param=this&&this['__param']||function(_0x536269,_0x577b40){return function(_0x40ab0c,_0x56b57a){_0x577b40(_0x40ab0c,_0x56b57a,_0x536269);};};Object[_0x1c9e0a(0x229)](exports,'__esModule',{'value':!![]}),exports['QueueService']=void 0x0;function _0x510b(_0x27eac7,_0x363b9c){const _0x516ace=_0x516a();return _0x510b=function(_0x510bf6,_0x143472){_0x510bf6=_0x510bf6-0x1f0;let _0x4a06f2=_0x516ace[_0x510bf6];return _0x4a06f2;},_0x510b(_0x27eac7,_0x363b9c);}const common_1=require(_0x1c9e0a(0x204)),bull_1=require(_0x1c9e0a(0x20b)),utils_1=require('../../common/utils'),midjourney_service_1=require(_0x1c9e0a(0x22b)),midjourney_constant_1=require(_0x1c9e0a(0x227)),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require('../globalConfig/globalConfig.service');let QueueService=class QueueService{constructor(_0x57c19c,_0x33bc8f,_0x32d0f8,_0x5cb3dc){const _0x3e2067=_0x1c9e0a;this[_0x3e2067(0x1f5)]=_0x57c19c,this['midjourneyService']=_0x33bc8f,this[_0x3e2067(0x208)]=_0x32d0f8,this[_0x3e2067(0x22e)]=_0x5cb3dc,this['jobIds']=[];}async[_0x1c9e0a(0x224)](){const _0x3b9e0b=_0x1c9e0a;await this[_0x3b9e0b(0x1f5)][_0x3b9e0b(0x207)](0x0,_0x3b9e0b(0x21a)),await this[_0x3b9e0b(0x21e)][_0x3b9e0b(0x203)]();}async[_0x1c9e0a(0x1fd)](_0x12e708,_0x3b9358){const _0x2d489b=_0x1c9e0a,{prompt:_0x9ff6d6,imgUrl:_0x268e29,extraParam:_0x1ce474,orderId:_0x182936,action:action=0x1,drawId:_0x45f53a}=_0x12e708;await this[_0x2d489b(0x21e)][_0x2d489b(0x1ff)](_0x3b9358),await this['userBalanceService'][_0x2d489b(0x1f9)](_0x3b9358,'mjDraw',action===0x2?0x1:0x4);if(action===midjourney_constant_1[_0x2d489b(0x214)][_0x2d489b(0x1f7)]||action===midjourney_constant_1[_0x2d489b(0x214)][_0x2d489b(0x1fe)]){const _0x182f14=''+(0x0,utils_1[_0x2d489b(0x216)])(),_0x374d34=Object[_0x2d489b(0x213)](Object[_0x2d489b(0x213)]({},_0x12e708),{'userId':_0x3b9358[_0x2d489b(0x22d)]['id'],'randomDrawId':_0x182f14}),_0x429828=await this['midjourneyService'][_0x2d489b(0x212)](_0x374d34),_0x8ac128=await this[_0x2d489b(0x22e)]['getConfigs']([_0x2d489b(0x21f)])||0x30d40,_0x77a5fa=await this[_0x2d489b(0x1f5)][_0x2d489b(0x1f8)](_0x2d489b(0x1fa),{'id':_0x429828['id'],'action':_0x268e29?0x4:0x1,'userId':_0x3b9358[_0x2d489b(0x22d)]['id']},{'delay':0x3e8,'timeout':+_0x8ac128});return this[_0x2d489b(0x205)]['push'](_0x77a5fa['id']),await this[_0x2d489b(0x208)][_0x2d489b(0x1f4)](_0x3b9358['user']['id'],'mjDraw',0x4,0x4),!![];}if(!_0x45f53a||!_0x182936)throw new common_1['HttpException'](_0x2d489b(0x228),common_1['HttpStatus'][_0x2d489b(0x217)]);if(action===midjourney_constant_1[_0x2d489b(0x214)][_0x2d489b(0x22c)]){const _0x145da2=await this['midjourneyService']['getDrawActionDetail'](action,_0x45f53a,_0x182936),{custom_id:_0x125e44}=_0x145da2;await this[_0x2d489b(0x21e)][_0x2d489b(0x1f6)](_0x125e44);const _0x265a88=Object['assign'](Object[_0x2d489b(0x213)](Object[_0x2d489b(0x213)]({},_0x12e708),{'userId':_0x3b9358[_0x2d489b(0x22d)]['id']}),_0x145da2),_0x327c45=await this[_0x2d489b(0x21e)][_0x2d489b(0x212)](_0x265a88),_0x38d9e4=await this[_0x2d489b(0x22e)]['getConfigs'](['mjTimeoutMs'])||0x30d40,_0x384ea2=await this[_0x2d489b(0x1f5)][_0x2d489b(0x1f8)]('mjDraw',{'id':_0x327c45['id'],'action':action,'userId':_0x3b9358['user']['id']},{'delay':0x3e8,'timeout':+_0x38d9e4});await this['userBalanceService'][_0x2d489b(0x1f4)](_0x3b9358[_0x2d489b(0x22d)]['id'],_0x2d489b(0x1fa),0x1,0x1),this[_0x2d489b(0x205)]['push'](_0x384ea2['id']);return;}if(action===midjourney_constant_1[_0x2d489b(0x214)][_0x2d489b(0x21b)]){const _0x3258e8=await this['midjourneyService'][_0x2d489b(0x20c)](action,_0x45f53a,_0x182936),_0x27eec6=Object['assign'](Object['assign'](Object[_0x2d489b(0x213)]({},_0x12e708),{'userId':_0x3b9358['user']['id']}),_0x3258e8),_0xa29d10=await this[_0x2d489b(0x21e)][_0x2d489b(0x212)](_0x27eec6),_0xa62b24=await this[_0x2d489b(0x22e)][_0x2d489b(0x218)]([_0x2d489b(0x21f)])||0x30d40,_0x21be6b=await this[_0x2d489b(0x1f5)][_0x2d489b(0x1f8)](_0x2d489b(0x1fa),{'id':_0xa29d10['id'],'action':action,'userId':_0x3b9358[_0x2d489b(0x22d)]['id']},{'delay':0x3e8,'timeout':+_0xa62b24});this[_0x2d489b(0x205)][_0x2d489b(0x1f0)](_0x21be6b['id']),await this['userBalanceService'][_0x2d489b(0x1f4)](_0x3b9358[_0x2d489b(0x22d)]['id'],_0x2d489b(0x1fa),0x4,0x4);return;}if(action===midjourney_constant_1[_0x2d489b(0x214)][_0x2d489b(0x215)]){const _0x159aa7=await this[_0x2d489b(0x21e)][_0x2d489b(0x20c)](action,_0x45f53a,_0x182936),_0x4bc7da=Object['assign'](Object[_0x2d489b(0x213)](Object['assign']({},_0x12e708),{'userId':_0x3b9358[_0x2d489b(0x22d)]['id']}),_0x159aa7),_0x13828f=await this['midjourneyService']['addDrawQueue'](_0x4bc7da),_0x229005=await this['globalConfigService'][_0x2d489b(0x218)]([_0x2d489b(0x21f)])||0x30d40,_0x8636ce=await this['mjDrawQueue'][_0x2d489b(0x1f8)](_0x2d489b(0x1fa),{'id':_0x13828f['id'],'action':action,'userId':_0x3b9358[_0x2d489b(0x22d)]['id']},{'delay':0x3e8,'timeout':+_0x229005});this['jobIds'][_0x2d489b(0x1f0)](_0x8636ce['id']),await this['userBalanceService'][_0x2d489b(0x1f4)](_0x3b9358[_0x2d489b(0x22d)]['id'],'mjDraw',0x4,0x4);return;}if(action===midjourney_constant_1[_0x2d489b(0x214)][_0x2d489b(0x20a)]){const _0x4a7434=await this[_0x2d489b(0x21e)][_0x2d489b(0x20c)](action,_0x45f53a,_0x182936),_0x4d6283=Object[_0x2d489b(0x213)](Object['assign'](Object[_0x2d489b(0x213)]({},_0x12e708),{'userId':_0x3b9358[_0x2d489b(0x22d)]['id']}),_0x4a7434),_0x1e6889=await this['midjourneyService'][_0x2d489b(0x212)](_0x4d6283),_0x22f5ab=await this['globalConfigService'][_0x2d489b(0x218)]([_0x2d489b(0x21f)])||0x30d40,_0x33d1b0=await this['mjDrawQueue'][_0x2d489b(0x1f8)](_0x2d489b(0x1fa),{'id':_0x1e6889['id'],'action':action,'userId':_0x3b9358[_0x2d489b(0x22d)]['id']},{'delay':0x3e8,'timeout':+_0x22f5ab});this['jobIds'][_0x2d489b(0x1f0)](_0x33d1b0['id']),await this[_0x2d489b(0x208)]['deductFromBalance'](_0x3b9358[_0x2d489b(0x22d)]['id'],_0x2d489b(0x1fa),0x4,0x4);return;}if(action===midjourney_constant_1[_0x2d489b(0x214)][_0x2d489b(0x225)]){const _0x32022a=await this['midjourneyService'][_0x2d489b(0x20c)](action,_0x45f53a,_0x182936),_0x318c65=Object[_0x2d489b(0x213)](Object['assign'](Object['assign']({},_0x12e708),{'userId':_0x3b9358[_0x2d489b(0x22d)]['id']}),_0x32022a),_0x5a3786=await this[_0x2d489b(0x21e)][_0x2d489b(0x212)](_0x318c65),_0x4c7fcc=await this[_0x2d489b(0x22e)]['getConfigs']([_0x2d489b(0x21f)])||0x30d40,_0x4032bc=await this[_0x2d489b(0x1f5)][_0x2d489b(0x1f8)](_0x2d489b(0x1fa),{'id':_0x5a3786['id'],'action':action,'userId':_0x3b9358[_0x2d489b(0x22d)]['id']},{'delay':0x3e8,'timeout':+_0x4c7fcc});this['jobIds'][_0x2d489b(0x1f0)](_0x4032bc['id']),await this['userBalanceService']['deductFromBalance'](_0x3b9358[_0x2d489b(0x22d)]['id'],_0x2d489b(0x1fa),0x4,0x4);return;}}async[_0x1c9e0a(0x21c)](){const _0x41d6c7=_0x1c9e0a;return{'jobIds':this[_0x41d6c7(0x205)]};}};QueueService=__decorate([__param(0x0,(0x0,bull_1[_0x1c9e0a(0x226)])(_0x1c9e0a(0x219))),__metadata('design:paramtypes',[Object,midjourney_service_1[_0x1c9e0a(0x209)],userBalance_service_1[_0x1c9e0a(0x211)],globalConfig_service_1[_0x1c9e0a(0x220)]])],QueueService),exports[_0x1c9e0a(0x202)]=QueueService;