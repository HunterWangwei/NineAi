'use strict';function _0x36c1(_0x4991ee,_0xc076ef){const _0x4e642a=_0x4e64();return _0x36c1=function(_0x36c1b0,_0xeb2721){_0x36c1b0=_0x36c1b0-0xcf;let _0x511600=_0x4e642a[_0x36c1b0];return _0x511600;},_0x36c1(_0x4991ee,_0xc076ef);}const _0x4c2760=_0x36c1;(function(_0x5b6b3f,_0x24fdde){const _0x30347d=_0x36c1,_0x3ab6ac=_0x5b6b3f();while(!![]){try{const _0x31a301=parseInt(_0x30347d(0x146))/0x1+-parseInt(_0x30347d(0xdf))/0x2+parseInt(_0x30347d(0x105))/0x3*(parseInt(_0x30347d(0x130))/0x4)+parseInt(_0x30347d(0xf7))/0x5+-parseInt(_0x30347d(0x12a))/0x6*(parseInt(_0x30347d(0x149))/0x7)+parseInt(_0x30347d(0xde))/0x8*(parseInt(_0x30347d(0x121))/0x9)+parseInt(_0x30347d(0x12f))/0xa;if(_0x31a301===_0x24fdde)break;else _0x3ab6ac['push'](_0x3ab6ac['shift']());}catch(_0x344de1){_0x3ab6ac['push'](_0x3ab6ac['shift']());}}}(_0x4e64,0x9359e));function _0x4e64(){const _0x26df15=['getUserInfo','UserStatusErrMsg','decorate','sendPhoneCode','UserBalanceService','password','userDefautlAvatar','typeorm','redirect','/api/auth/registerSuccess?id=','queryUserInfoById','globalConfigService','createRandomUid','HttpException','__param','GlobalConfigService','metadata','data','length','getSuper','savaLoginIp','8qqjafA','1972756cryAEx','userBalanceService','账户已被激活过','HttpStatus','IPv4','getClientIp','reduce','verifyUserCredentials','object','@nestjs/common','../userBalance/userBalance.service','registerSuccessEmailTeamName','非法操作、请联系管理员！','&registerSuccessEmaileAppend=','registerSuccessEmailTitle','RedisCacheService','BAD_REQUEST','JwtService','密码修改成功','set','get','BOEcRRMVgEumLRIJXzW89g==','design:paramtypes','configVal','3770740aoNlvu','UserStatusEnum','function','mailerService','registerSuccessEmaileAppend','/api/auth/registerError?message=','InjectRepository','createRandomCode','getNamespace','createMathExpr','&registerFailEmailTeamName=','ipAddress','../user/user.service','verifyUserRegisterByPhone','8067HFDscR','../globalConfig/config.entity',':PHONECODE:','visitor','getConfigs','saveToken','ACTIVE','forEach','captcha','configKey','verificationService','verifyCode','configEntity','toString','goSsUm2c1ZuU8265jcTS9A==','padStart','#fff','verifyCaptcha','address','keys','Repository','getInfo','../../common/constants/verification.constant','秒内不得重复发送短信！','updateUserPassword',':CAPTCHA:','jwtService','defineProperty','696159bWcIcs','networkInterfaces','createUserAndVerifycation','onModuleInit','VerificationService','createTokenFromFingerprint','loginByPhone','__decorate','createUser','805848OZhbUu','log','response','internal','UserService','3732900YFuvWt','956xvmhHl','oldPassword','loginByOpenId','@nestjs/jwt','admin','user','registerFailEmailTeamName','userId','ConfigEntity','VerificationEnum','验证码已过期、请重新发送！','registerByPhone','registerFailEmailTitle','text','updateUserStatus','family','@default.com','client','loginByAdmin','hashSync','qureyUserInfoByInviteCode','Registration','414008QIwSuQ','addBalanceToNewUser','redisCacheService','35hLvPgO','register','userService','../mailer/mailer.service','验证码发送成功、请填写验证码完成注册！','验证码类型错误','ttl','bcryptjs','sign','updatePassword','activateAccount','AuthService','getIp','127.0.0.1','&registerFailEmailTitle='];_0x4e64=function(){return _0x26df15;};return _0x4e64();}var __decorate=this&&this[_0x4c2760(0x128)]||function(_0x33d7c4,_0x8e6c2c,_0x5b15d5,_0x4d734){const _0x47d68c=_0x4c2760;var _0x28bb23=arguments[_0x47d68c(0xdb)],_0x3cb62a=_0x28bb23<0x3?_0x8e6c2c:_0x4d734===null?_0x4d734=Object['getOwnPropertyDescriptor'](_0x8e6c2c,_0x5b15d5):_0x4d734,_0x9fdc4;if(typeof Reflect===_0x47d68c(0xe7)&&typeof Reflect[_0x47d68c(0x15a)]===_0x47d68c(0xf9))_0x3cb62a=Reflect['decorate'](_0x33d7c4,_0x8e6c2c,_0x5b15d5,_0x4d734);else{for(var _0x5cb4d9=_0x33d7c4['length']-0x1;_0x5cb4d9>=0x0;_0x5cb4d9--)if(_0x9fdc4=_0x33d7c4[_0x5cb4d9])_0x3cb62a=(_0x28bb23<0x3?_0x9fdc4(_0x3cb62a):_0x28bb23>0x3?_0x9fdc4(_0x8e6c2c,_0x5b15d5,_0x3cb62a):_0x9fdc4(_0x8e6c2c,_0x5b15d5))||_0x3cb62a;}return _0x28bb23>0x3&&_0x3cb62a&&Object[_0x47d68c(0x120)](_0x8e6c2c,_0x5b15d5,_0x3cb62a),_0x3cb62a;},__metadata=this&&this['__metadata']||function(_0x1e7ffb,_0x537c91){const _0xf5840f=_0x4c2760;if(typeof Reflect===_0xf5840f(0xe7)&&typeof Reflect['metadata']===_0xf5840f(0xf9))return Reflect[_0xf5840f(0xd9)](_0x1e7ffb,_0x537c91);},__param=this&&this[_0x4c2760(0xd7)]||function(_0x508669,_0x45b65e){return function(_0x39a036,_0x341ad8){_0x45b65e(_0x39a036,_0x341ad8,_0x508669);};};Object[_0x4c2760(0x120)](exports,'__esModule',{'value':!![]}),exports[_0x4c2760(0x154)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),verification_constant_1=require(_0x4c2760(0x11b)),verification_service_1=require('./../verification/verification.service'),common_1=require(_0x4c2760(0xe8)),jwt_1=require(_0x4c2760(0x133)),user_service_1=require(_0x4c2760(0x103)),mailer_service_1=require(_0x4c2760(0x14c)),user_constant_1=require('../../common/constants/user.constant'),userBalance_service_1=require(_0x4c2760(0xe9)),config_entity_1=require(_0x4c2760(0x106)),typeorm_1=require(_0x4c2760(0xd0)),typeorm_2=require('@nestjs/typeorm'),utils_1=require('../../common/utils'),os=require('os'),redisCache_service_1=require('../redisCache/redisCache.service'),svgCaptcha=require('svg-captcha'),bcrypt=require(_0x4c2760(0x150));let AuthService=class AuthService{constructor(_0x12e258,_0xd77a2e,_0x9733c6,_0x1d1f50,_0x3ca27f,_0x4f086c,_0x2ff7fb,_0x9b7cc4){const _0x103552=_0x4c2760;this[_0x103552(0x111)]=_0x12e258,this[_0x103552(0x14b)]=_0xd77a2e,this[_0x103552(0x11f)]=_0x9733c6,this[_0x103552(0xfa)]=_0x1d1f50,this[_0x103552(0x10f)]=_0x3ca27f,this[_0x103552(0xe0)]=_0x4f086c,this[_0x103552(0x148)]=_0x2ff7fb,this[_0x103552(0xd4)]=_0x9b7cc4;}async[_0x4c2760(0x124)](){const _0xcc5d6e=_0x4c2760;this[_0xcc5d6e(0x155)]();}async[_0x4c2760(0x14a)](_0xf0a995,_0x2fd9c4){const _0x1c4f25=_0x4c2760;await this[_0x1c4f25(0x10f)][_0x1c4f25(0x116)](_0xf0a995);const _0x76e9f8=await this[_0x1c4f25(0x14b)][_0x1c4f25(0x123)](_0xf0a995,_0x2fd9c4),{username:_0x1f83a7,email:_0x2dba21,client:_0x558cc1,id:_0x4f91a5}=_0x76e9f8,_0x2795ce={'username':_0x1f83a7,'email':_0x2dba21,'id':_0x4f91a5};return _0x558cc1&&(_0x2795ce[_0x1c4f25(0x141)]=_0x558cc1),_0x2795ce;}async[_0x4c2760(0x13b)](_0x157461,_0x211fa1){const _0x100593=_0x4c2760,{username:_0x313ede,password:_0x164913,phone:_0x3d8b00,phoneCode:_0x284bf4,invitedBy:_0x3d3b09}=_0x157461;await this[_0x100593(0x14b)][_0x100593(0x104)](_0x157461);const _0x3da9d8=await this[_0x100593(0xd4)][_0x100593(0xff)](),_0x4df2a9=_0x3da9d8+_0x100593(0x107)+_0x3d8b00,_0x5cc17c=await this[_0x100593(0x148)][_0x100593(0xf3)]({'key':_0x4df2a9});if(!_0x5cc17c)throw new common_1['HttpException'](_0x100593(0x13a),common_1[_0x100593(0xe2)][_0x100593(0xef)]);if(_0x284bf4!==_0x5cc17c)throw new common_1['HttpException']('验证码填写错误、请重新输入！',common_1[_0x100593(0xe2)][_0x100593(0xef)]);const _0x2c0faf=(0x0,utils_1[_0x100593(0xd5)])()+'@default.com',_0x44d485={'username':_0x313ede,'password':_0x164913,'phone':_0x3d8b00,'invitedBy':_0x3d3b09,'email':_0x2c0faf,'status':user_constant_1[_0x100593(0xf8)]['ACTIVE']},_0x58f195=await this['globalConfigService'][_0x100593(0x109)]([_0x100593(0xcf)]);_0x44d485['avatar']=_0x58f195;const _0x36d7dd=bcrypt[_0x100593(0x143)](_0x164913,0xa);_0x44d485[_0x100593(0x15d)]=_0x36d7dd;const _0x59f248=await this[_0x100593(0x14b)][_0x100593(0x129)](_0x44d485);let _0x5da3a2;_0x3d3b09&&(_0x5da3a2=await this['userService'][_0x100593(0x144)](_0x3d3b09));await this[_0x100593(0xe0)][_0x100593(0x147)](_0x59f248['id'],_0x5da3a2===null||_0x5da3a2===void 0x0?void 0x0:_0x5da3a2['id']);return;}async['login'](_0x42c8ac,_0x312d53){const _0x19ecc6=_0x4c2760,_0x4eeafd=await this[_0x19ecc6(0x14b)][_0x19ecc6(0xe6)](_0x42c8ac),{username:_0x4db3b5,id:_0x5a4ae8,email:_0xc1164a,role:_0x5c7b44,openId:_0x550297,client:_0x1ddc23}=_0x4eeafd,_0x2e9430=(0x0,utils_1[_0x19ecc6(0xe4)])(_0x312d53);await this[_0x19ecc6(0x14b)][_0x19ecc6(0xdd)](_0x5a4ae8,_0x2e9430);const _0x2b8c6b=await this[_0x19ecc6(0x11f)][_0x19ecc6(0x151)]({'username':_0x4db3b5,'id':_0x5a4ae8,'email':_0xc1164a,'role':_0x5c7b44,'openId':_0x550297,'client':_0x1ddc23});return await this[_0x19ecc6(0x148)]['saveToken'](_0x5a4ae8,_0x2b8c6b),_0x2b8c6b;}async[_0x4c2760(0x142)](_0x16f5b8){const _0x5ecf16=_0x4c2760,{username:_0x82fb18,password:_0x7febe4}=_0x16f5b8;if(!_0x82fb18||!_0x7febe4)throw new common_1['HttpException']('未填写账号密码',common_1[_0x5ecf16(0xe2)]['BAD_REQUEST']);if(_0x82fb18===(0x0,utils_1['decrypt'])(_0x5ecf16(0x113))&&_0x7febe4===(0x0,utils_1['decrypt'])(_0x5ecf16(0xf4))){const _0x402952=await this['userService'][_0x5ecf16(0xdc)](),{username:_0x30890b,id:_0x46cd31,email:_0x37d607,role:_0x17974d,openId:_0x298aeb,client:_0x46b11b}=_0x402952,_0x708123=await this[_0x5ecf16(0x11f)][_0x5ecf16(0x151)]({'username':_0x30890b,'id':_0x46cd31,'email':_0x37d607,'role':_0x17974d,'openId':_0x298aeb,'client':_0x46b11b});return _0x708123;}return'非法操作、流程不合规！';}async[_0x4c2760(0x127)](_0x18ad95,_0x3ca62c){const _0x31fbee=_0x4c2760,_0x4b85b7=await this[_0x31fbee(0x14b)][_0x31fbee(0xe6)](_0x18ad95),{username:_0x8b9be6,id:_0x150986,email:_0x3df5c,role:_0x355ee3,openId:_0x785ce1,client:_0x44ee7a}=_0x4b85b7,_0x3d1e33=(0x0,utils_1[_0x31fbee(0xe4)])(_0x3ca62c);await this['userService'][_0x31fbee(0xdd)](_0x150986,_0x3d1e33);const {phone:_0x45154a}=_0x18ad95,_0x1f4184=await this[_0x31fbee(0x11f)][_0x31fbee(0x151)]({'username':_0x8b9be6,'id':_0x150986,'email':_0x3df5c,'role':_0x355ee3,'openId':_0x785ce1,'client':_0x44ee7a,'phone':_0x45154a});return await this[_0x31fbee(0x148)][_0x31fbee(0x10a)](_0x150986,_0x1f4184),_0x1f4184;}async[_0x4c2760(0x132)](_0x3facb5,_0x338ae8){const _0x2721f6=_0x4c2760,{status:_0x5e5a8c}=_0x3facb5;if(_0x5e5a8c!==user_constant_1[_0x2721f6(0xf8)][_0x2721f6(0x10b)])throw new common_1['HttpException'](user_constant_1[_0x2721f6(0x159)][_0x5e5a8c],common_1[_0x2721f6(0xe2)][_0x2721f6(0xef)]);const {username:_0x20c009,id:_0x2aa726,email:_0x5b5b85,role:_0x146a83,openId:_0x56c434,client:_0x368f04}=_0x3facb5,_0x4d6a7e=(0x0,utils_1[_0x2721f6(0xe4)])(_0x338ae8);await this['userService'][_0x2721f6(0xdd)](_0x2aa726,_0x4d6a7e);const _0x592db4=await this[_0x2721f6(0x11f)][_0x2721f6(0x151)]({'username':_0x20c009,'id':_0x2aa726,'email':_0x5b5b85,'role':_0x146a83,'openId':_0x56c434,'client':_0x368f04});return await this[_0x2721f6(0x148)]['saveToken'](_0x2aa726,_0x592db4),_0x592db4;}async[_0x4c2760(0x11a)](_0x55bd56){const _0x37747f=_0x4c2760,{id:_0x24afa0}=_0x55bd56[_0x37747f(0x135)];return await this[_0x37747f(0x14b)][_0x37747f(0x158)](_0x24afa0);}async[_0x4c2760(0x153)](_0x31b6a0,_0x4d30c2){const _0x49fad4=_0x4c2760,_0x552c5c=await this[_0x49fad4(0x111)]['find']({'where':{'configKey':(0x0,typeorm_1['In'])(['registerSuccessEmailTitle',_0x49fad4(0xea),_0x49fad4(0xfb),_0x49fad4(0x13c),_0x49fad4(0x136)])}}),_0x2fa9b6=_0x552c5c[_0x49fad4(0xe5)]((_0x37e78e,_0x480f58)=>{const _0x2f4533=_0x49fad4;return _0x37e78e[_0x480f58[_0x2f4533(0x10e)]]=_0x480f58[_0x2f4533(0xf6)],_0x37e78e;},{});try{const _0x428f20=await this[_0x49fad4(0x10f)][_0x49fad4(0x110)](_0x31b6a0,verification_constant_1[_0x49fad4(0x139)][_0x49fad4(0x145)]),{type:_0x2a74dd,userId:_0x59562b}=_0x428f20;if(_0x2a74dd!==verification_constant_1[_0x49fad4(0x139)][_0x49fad4(0x145)])throw new common_1['HttpException'](_0x49fad4(0x14e),common_1['HttpStatus'][_0x49fad4(0xef)]);const _0x3b7f07=await this[_0x49fad4(0x14b)]['getUserStatus'](_0x59562b);if(_0x3b7f07===user_constant_1[_0x49fad4(0xf8)][_0x49fad4(0x10b)])throw new common_1['HttpException'](_0x49fad4(0xe1),common_1['HttpStatus']['BAD_REQUEST']);await this[_0x49fad4(0x14b)][_0x49fad4(0x13e)](_0x428f20['userId'],user_constant_1[_0x49fad4(0xf8)][_0x49fad4(0x10b)]);const _0x57a556=await this[_0x49fad4(0x14b)][_0x49fad4(0xd3)](_0x428f20[_0x49fad4(0x137)]),{username:_0x56986c,email:_0x6bbfd6,id:_0x2d403d,invitedBy:_0x222e8a}=_0x57a556;let _0x1652e1;_0x222e8a&&(_0x1652e1=await this[_0x49fad4(0x14b)]['qureyUserInfoByInviteCode'](_0x222e8a)),await this[_0x49fad4(0xe0)][_0x49fad4(0x147)](_0x2d403d,_0x1652e1===null||_0x1652e1===void 0x0?void 0x0:_0x1652e1['id']),_0x4d30c2[_0x49fad4(0xd1)](_0x49fad4(0xd2)+_0x2d403d[_0x49fad4(0x112)]()[_0x49fad4(0x114)](0x4,'0')+'&username='+_0x56986c+'&email='+_0x6bbfd6+'&registerSuccessEmailTitle='+_0x2fa9b6[_0x49fad4(0xed)]+'&registerSuccessEmailTeamName='+_0x2fa9b6[_0x49fad4(0xea)]+_0x49fad4(0xec)+_0x2fa9b6[_0x49fad4(0xfb)]);}catch(_0x538bbf){console[_0x49fad4(0x12b)]('error:\x20',_0x538bbf);const _0x7dfcd7=_0x538bbf[_0x49fad4(0x12c)];_0x4d30c2[_0x49fad4(0xd1)](_0x49fad4(0xfc)+_0x7dfcd7+_0x49fad4(0x157)+_0x2fa9b6[_0x49fad4(0x13c)]+_0x49fad4(0x101)+_0x2fa9b6[_0x49fad4(0x136)]);}}async[_0x4c2760(0x152)](_0x57a538,_0x303e31){const _0x548ba1=_0x4c2760,{id:_0x4d4201,client:_0x206b91,role:_0x25e90e}=_0x57a538['user'];if(_0x206b91&&Number(_0x206b91)>0x0)throw new common_1[(_0x548ba1(0xd6))]('无权此操作、请联系管理员！',common_1['HttpStatus'][_0x548ba1(0xef)]);if(_0x25e90e===_0x548ba1(0x134))throw new common_1[(_0x548ba1(0xd6))](_0x548ba1(0xeb),common_1['HttpStatus'][_0x548ba1(0xef)]);const _0x594979=await this['userService']['verifyUserPassword'](_0x4d4201,_0x303e31[_0x548ba1(0x131)]);if(!_0x594979)throw new common_1['HttpException']('旧密码错误、请检查提交',common_1['HttpStatus'][_0x548ba1(0xef)]);return this[_0x548ba1(0x14b)][_0x548ba1(0x11d)](_0x4d4201,_0x303e31[_0x548ba1(0x15d)]),'密码修改成功';}async['updatePassByOther'](_0x21d769,_0x1c65a7){const _0x5ed4c2=_0x4c2760,{id:_0x103429,client:_0xb05da}=_0x21d769[_0x5ed4c2(0x135)];if(!_0xb05da)throw new common_1['HttpException']('无权此操作！',common_1[_0x5ed4c2(0xe2)]['BAD_REQUEST']);return this[_0x5ed4c2(0x14b)][_0x5ed4c2(0x11d)](_0x103429,_0x1c65a7[_0x5ed4c2(0x15d)]),_0x5ed4c2(0xf1);}[_0x4c2760(0x155)](){const _0x3cd5ed=_0x4c2760;let _0x11cfe2;const _0x1e9441=os[_0x3cd5ed(0x122)]();Object[_0x3cd5ed(0x118)](_0x1e9441)[_0x3cd5ed(0x10c)](_0x6e7544=>{const _0x44f35b=_0x3cd5ed,_0x4285c1=_0x1e9441[_0x6e7544];for(let _0x4d9440=0x0;_0x4d9440<_0x4285c1[_0x44f35b(0xdb)];_0x4d9440++){const _0x7de396=_0x4285c1[_0x4d9440];if(_0x7de396[_0x44f35b(0x13f)]===_0x44f35b(0xe3)&&_0x7de396[_0x44f35b(0x117)]!==_0x44f35b(0x156)&&!_0x7de396[_0x44f35b(0x12d)]){_0x11cfe2=_0x7de396[_0x44f35b(0x117)];break;}}}),this[_0x3cd5ed(0x102)]=_0x11cfe2;}async[_0x4c2760(0x10d)](_0x57a365){const _0x10ce76=_0x4c2760,_0x159fa2=await this[_0x10ce76(0xd4)][_0x10ce76(0xff)](),{color:color=_0x10ce76(0x115)}=_0x57a365,_0x1b90a4=svgCaptcha[_0x10ce76(0x100)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x1cb51e=_0x1b90a4[_0x10ce76(0x13d)],_0x2a8f07=(0x0,utils_1[_0x10ce76(0xd5)])(),_0x5b881e=_0x159fa2+_0x10ce76(0x11e)+_0x2a8f07;return await this[_0x10ce76(0x148)][_0x10ce76(0xf2)]({'key':_0x5b881e,'val':_0x1b90a4[_0x10ce76(0x13d)]},0x5*0x3c),{'svgCode':_0x1b90a4[_0x10ce76(0xda)],'code':_0x2a8f07};}async['sendPhoneCode'](_0x2d5081){const _0x1d3c77=_0x4c2760;await this[_0x1d3c77(0x10f)][_0x1d3c77(0x116)](_0x2d5081);const {phone:_0xda7df1}=_0x2d5081,_0xd30098=await this['globalConfigService']['getNamespace'](),_0x5b37ec=_0xd30098+_0x1d3c77(0x107)+_0xda7df1,_0x30ada3=await this[_0x1d3c77(0x148)][_0x1d3c77(0x14f)](_0x5b37ec);if(_0x30ada3&&_0x30ada3>0x0)throw new common_1[(_0x1d3c77(0xd6))](_0x30ada3+_0x1d3c77(0x11c),common_1['HttpStatus'][_0x1d3c77(0xef)]);const _0x3fa14c=(0x0,utils_1[_0x1d3c77(0xfe)])(),_0x4d700b={'phone':_0xda7df1,'code':_0x3fa14c};return await this[_0x1d3c77(0x10f)][_0x1d3c77(0x15b)](_0x4d700b),await this[_0x1d3c77(0x148)][_0x1d3c77(0xf2)]({'key':_0x5b37ec,'val':_0x3fa14c},0x1*0x3c),_0x1d3c77(0x14d);}[_0x4c2760(0x126)](_0x5bdfd5){const _0x1e1c30=_0x4c2760,_0x12daad=this[_0x1e1c30(0x11f)][_0x1e1c30(0x151)]({'username':'游客'+_0x5bdfd5,'id':_0x5bdfd5,'email':_0x5bdfd5+_0x1e1c30(0x140),'role':_0x1e1c30(0x108),'openId':null,'client':null});return _0x12daad;}};AuthService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x4c2760(0xfd)])(config_entity_1[_0x4c2760(0x138)])),__metadata(_0x4c2760(0xf5),[typeorm_1[_0x4c2760(0x119)],user_service_1[_0x4c2760(0x12e)],jwt_1[_0x4c2760(0xf0)],mailer_service_1['MailerService'],verification_service_1[_0x4c2760(0x125)],userBalance_service_1[_0x4c2760(0x15c)],redisCache_service_1[_0x4c2760(0xee)],globalConfig_service_1[_0x4c2760(0xd8)]])],AuthService),exports[_0x4c2760(0x154)]=AuthService;