'use strict';function _0x498d(_0x50f9c1,_0xfa6ee7){const _0x297a91=_0x297a();return _0x498d=function(_0x498dd7,_0x34b757){_0x498dd7=_0x498dd7-0x1bc;let _0x1f30ca=_0x297a91[_0x498dd7];return _0x1f30ca;},_0x498d(_0x50f9c1,_0xfa6ee7);}const _0x407c5a=_0x498d;(function(_0x4ed169,_0x71f9c8){const _0x5b7d94=_0x498d,_0x146f30=_0x4ed169();while(!![]){try{const _0x30329f=-parseInt(_0x5b7d94(0x273))/0x1+-parseInt(_0x5b7d94(0x247))/0x2+-parseInt(_0x5b7d94(0x1c2))/0x3+-parseInt(_0x5b7d94(0x252))/0x4+parseInt(_0x5b7d94(0x224))/0x5+parseInt(_0x5b7d94(0x1d1))/0x6*(-parseInt(_0x5b7d94(0x238))/0x7)+parseInt(_0x5b7d94(0x266))/0x8;if(_0x30329f===_0x71f9c8)break;else _0x146f30['push'](_0x146f30['shift']());}catch(_0x4d6df0){_0x146f30['push'](_0x146f30['shift']());}}}(_0x297a,0x63112));function _0x297a(){const _0x4a5b8c=['packageId','mjDraw','../chatGroup/chatGroup.entity','update','save','weight','Injectable','查询用户账户信息失败！','firstRregisterSendModel4Count','writeOldBalanceToNewTable','formatDate','CramiPackageEntity','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','../../common/utils','format','ChatLogEntity','BalanceService','../../common/utils/date','userBalanceEntity','>\x20或购买专属套餐\x20！','getMonth','836334Eachhn','getAccountLog','whiteListEntity','isInteger','registerSendModel3Count','rechargeType','model3','registerSendModel4Count','log','firstRregisterSendDrawMjCount','debug','BalanceEntity','isUpdatedToday','__param','visitorMJNum','157758sFIwWY','useModel3Token','firstRegisterSendStatus','odel4','YYYY-MM-DD\x20HH:mm:ss','inviteSendStatus','upgradeBalance','formatCreateOrUpdateDate','Repository','useModel4Count','configVal','@nestjs/typeorm','addBalanceToUser','sumModel3Count','midjourneyEntity','getOwnPropertyDescriptor','memberModel4Count','./fingerprint.entity','firstRegisterSendRank','visitorModel3Num','cramiPackageEntity','firstRregisterSendModel3Count','WhiteListEntity','getVisitorCount','balanceEntity','vxNumber','ChatGroupEntity','Logger','odel3','decorate','invitedGuestSendModel3Count','当前用户不存在,记录充值日志异常','drawMjCount','chatGroupEntity','旧账户信息迁移成功','accountLogEntity','upgradeStatus','find','refundMjBalance','查询当前用户余额失败！','email','HttpStatus','用户充值失败！','memberDrawMjCount','./balance.entity','当前套餐不存在！','sumDrawMjCount','model3Count','userEntity','status','validateVisitorBalance','HttpException','@nestjs/common','addBalanceToNewUser','invitedGuestSendDrawMjCount','inviteGiveSendModel4Count','UserBalanceService','add','then','drawFailRefund','inviteGiveSendModel3Count','RechargeType','metadata','affected','reduce','catch','---','model4Count','UserEntity','ConfigEntity','useDrawMjToken','registerSendStatus','forEach','消费余额失败！','inheritVisitorData','useModel3Count','hideString','SalesService','globalConfigService','../sales/salesUsers.entity','非法操作、当前充值套餐暂不存在！','GlobalConfigService','total','1701110SiSQMJ','./../globalConfig/globalConfig.service','getConfigs','visitor','getMemberKeyMap','memberModel3Count','注册赠送失败,请联系管理员！','createBaseUserBalance','username','BAD_REQUEST','queryUserBalanceByIds','goodsId','model4','includes','saveCommissionAmount','error:\x20','userId','../globalConfig/config.entity','DRAW_FAIL_REFUND','phone','49AMNQnG','validateBalance','getRechargeLog','salesUsersEntity','createSalesRecords','length','configEntity','缺失当前用户账户记录！','旧账户信息迁移失败','saveRecordRechargeLog','object','缺失当前套餐ID、充值失败！','REFER_GIFT','INVITE_GIFT','../user/user.entity','1268464SDrWEv','count','updatedAt','__metadata','充值失败！','invitedGuestSendModel4Count','../../common/constants/balance.constant','addBalanceToOrder','PAYMENT_REQUIRED','fingerprintLogEntity','REG_GIFT','2773284eGozUF','inviteGiveSendDrawMjCount','sumModel4Count','MidjourneyEntity','function','getFullYear','充值失败','chatLogEntity','__esModule','InjectRepository','findOne','registerSendDrawMjCount','default','../chatgpt/whiteList.entity','salesService','../midjourney/midjourney.entity','headers','days','DESC','../sales/sales.service','19853016WMzcVa','useModel4Token','findAndCount','day','map','../crami/cramiPackage.entity','expirationTime','YYYY-MM-DD','./userBalance.entity','expireDateCn','当前用户无需创建账户信息！','getBaseKeyMap','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','625689CzRZok','您已经升级过了、请勿重复操作！','visitorModel4Num','AccountLogEntity','user'];_0x297a=function(){return _0x4a5b8c;};return _0x297a();}var __decorate=this&&this['__decorate']||function(_0x3b6a27,_0x36fe46,_0x46d2ca,_0x4f2bf3){const _0x33971c=_0x498d;var _0x477901=arguments[_0x33971c(0x23d)],_0xab3964=_0x477901<0x3?_0x36fe46:_0x4f2bf3===null?_0x4f2bf3=Object[_0x33971c(0x1e0)](_0x36fe46,_0x46d2ca):_0x4f2bf3,_0x8340d0;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x33971c(0x256))_0xab3964=Reflect[_0x33971c(0x1ee)](_0x3b6a27,_0x36fe46,_0x46d2ca,_0x4f2bf3);else{for(var _0x16c4ca=_0x3b6a27[_0x33971c(0x23d)]-0x1;_0x16c4ca>=0x0;_0x16c4ca--)if(_0x8340d0=_0x3b6a27[_0x16c4ca])_0xab3964=(_0x477901<0x3?_0x8340d0(_0xab3964):_0x477901>0x3?_0x8340d0(_0x36fe46,_0x46d2ca,_0xab3964):_0x8340d0(_0x36fe46,_0x46d2ca))||_0xab3964;}return _0x477901>0x3&&_0xab3964&&Object['defineProperty'](_0x36fe46,_0x46d2ca,_0xab3964),_0xab3964;},__metadata=this&&this[_0x407c5a(0x24a)]||function(_0x845112,_0x21983b){const _0x5279da=_0x407c5a;if(typeof Reflect===_0x5279da(0x242)&&typeof Reflect['metadata']===_0x5279da(0x256))return Reflect[_0x5279da(0x20f)](_0x845112,_0x21983b);},__param=this&&this[_0x407c5a(0x1cf)]||function(_0x247c9c,_0x1b3409){return function(_0x2c94ac,_0x517c62){_0x1b3409(_0x2c94ac,_0x517c62,_0x247c9c);};};Object['defineProperty'](exports,_0x407c5a(0x25a),{'value':!![]}),exports[_0x407c5a(0x209)]=void 0x0;const globalConfig_service_1=require(_0x407c5a(0x225)),typeorm_1=require(_0x407c5a(0x1dc)),balance_entity_1=require(_0x407c5a(0x1fd)),common_1=require(_0x407c5a(0x205)),typeorm_2=require('typeorm'),balance_constant_1=require(_0x407c5a(0x24d)),accountLog_entity_1=require('./accountLog.entity'),utils_1=require(_0x407c5a(0x285)),config_entity_1=require(_0x407c5a(0x235)),cramiPackage_entity_1=require(_0x407c5a(0x26b)),userBalance_entity_1=require(_0x407c5a(0x26e)),date_1=require(_0x407c5a(0x1be)),user_entity_1=require(_0x407c5a(0x246)),salesUsers_entity_1=require(_0x407c5a(0x220)),sales_service_1=require(_0x407c5a(0x265)),whiteList_entity_1=require(_0x407c5a(0x25f)),fingerprint_entity_1=require(_0x407c5a(0x1e2)),chatLog_entity_1=require('../chatLog/chatLog.entity'),chatGroup_entity_1=require(_0x407c5a(0x27a)),midjourney_entity_1=require(_0x407c5a(0x261)),verification_constant_1=require('../../common/constants/verification.constant');let UserBalanceService=class UserBalanceService{constructor(_0x590a21,_0xee7eeb,_0x110d38,_0x1ed593,_0x4fa663,_0x5a46a5,_0x409f3d,_0x402753,_0x1912bc,_0x1121d1,_0x211322,_0x4ca47b,_0x395972,_0x374543){const _0x128bab=_0x407c5a;this[_0x128bab(0x1e9)]=_0x590a21,this[_0x128bab(0x1bf)]=_0xee7eeb,this['accountLogEntity']=_0x110d38,this[_0x128bab(0x1e5)]=_0x1ed593,this[_0x128bab(0x23e)]=_0x4fa663,this[_0x128bab(0x201)]=_0x5a46a5,this[_0x128bab(0x23b)]=_0x409f3d,this['whiteListEntity']=_0x402753,this[_0x128bab(0x250)]=_0x1912bc,this[_0x128bab(0x1f2)]=_0x1121d1,this['chatLogEntity']=_0x211322,this[_0x128bab(0x1df)]=_0x4ca47b,this[_0x128bab(0x260)]=_0x395972,this[_0x128bab(0x21f)]=_0x374543;}async[_0x407c5a(0x206)](_0x1f6704,_0x3f0b14){const _0x21e22c=_0x407c5a;try{const _0x29a383=await this[_0x21e22c(0x23e)][_0x21e22c(0x1f6)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x21e22c(0x218),_0x21e22c(0x1c6),_0x21e22c(0x1c9),'registerSendDrawMjCount',_0x21e22c(0x1d3),_0x21e22c(0x1e3),_0x21e22c(0x1e6),_0x21e22c(0x280),'firstRregisterSendDrawMjCount',_0x21e22c(0x1d6),_0x21e22c(0x20d),_0x21e22c(0x208),_0x21e22c(0x253),'invitedGuestSendModel3Count',_0x21e22c(0x207),_0x21e22c(0x24c)])}}),_0x44f13a=_0x29a383[_0x21e22c(0x211)]((_0x3e0471,_0x51c121)=>{const _0x52a9e1=_0x21e22c,_0x53b781=Number(_0x51c121[_0x52a9e1(0x1db)]),_0x5466af=Number[_0x52a9e1(0x1c5)](_0x53b781)&&_0x53b781>0x0?_0x53b781:0x0;return _0x3e0471[_0x51c121['configKey']]=_0x5466af,_0x3e0471;},{});let _0x595921=0x0,_0x108f30=0x0,_0x6944c5=0x0;_0x44f13a[_0x21e22c(0x218)]===0x1&&(_0x595921=_0x595921+_0x44f13a['registerSendModel3Count'],_0x108f30=_0x108f30+_0x44f13a[_0x21e22c(0x1c9)],_0x6944c5=_0x6944c5+_0x44f13a[_0x21e22c(0x25d)]),_0x44f13a['registerSendStatus']===0x1&&_0x44f13a[_0x21e22c(0x1d3)]===0x1&&_0x1f6704<=_0x44f13a[_0x21e22c(0x1e3)]&&(_0x595921=_0x595921+_0x44f13a['firstRregisterSendModel3Count'],_0x108f30=_0x108f30+_0x44f13a['firstRregisterSendModel4Count'],_0x6944c5=_0x6944c5+_0x44f13a[_0x21e22c(0x1cb)]),await this[_0x21e22c(0x241)]({'userId':_0x1f6704,'rechargeType':balance_constant_1[_0x21e22c(0x20e)][_0x21e22c(0x251)],'model3Count':_0x595921,'drawMjCount':_0x6944c5,'model4Count':_0x108f30}),_0x3f0b14&&(Number(_0x44f13a[_0x21e22c(0x1d6)])===0x1&&(_0x595921=_0x595921+Number(_0x44f13a['invitedGuestSendModel3Count']),_0x108f30=_0x108f30+Number(_0x44f13a[_0x21e22c(0x24c)]),_0x6944c5=_0x6944c5+Number(_0x44f13a['invitedGuestSendDrawMjCount']),await this[_0x21e22c(0x241)]({'userId':_0x1f6704,'rechargeType':balance_constant_1[_0x21e22c(0x20e)][_0x21e22c(0x245)],'model3Count':_0x44f13a[_0x21e22c(0x1ef)],'model4Count':_0x44f13a[_0x21e22c(0x24c)],'drawMjCount':_0x44f13a[_0x21e22c(0x207)]}),await this[_0x21e22c(0x1dd)](_0x3f0b14,{'model3Count':_0x44f13a[_0x21e22c(0x20d)],'model4Count':_0x44f13a['inviteGiveSendModel4Count'],'drawMjCount':_0x44f13a['inviteGiveSendDrawMjCount']}),await this[_0x21e22c(0x241)]({'userId':_0x3f0b14,'rechargeType':balance_constant_1[_0x21e22c(0x20e)][_0x21e22c(0x244)],'model3Count':_0x44f13a[_0x21e22c(0x20d)],'model4Count':_0x44f13a[_0x21e22c(0x208)],'drawMjCount':_0x44f13a['inviteGiveSendDrawMjCount']}))),await this[_0x21e22c(0x1bf)][_0x21e22c(0x27c)]({'userId':_0x1f6704,'model3Count':_0x595921,'model4Count':_0x108f30,'drawMjCount':_0x6944c5,'useTokens':0x0});}catch(_0x139720){console[_0x21e22c(0x1ca)]('error:\x20',_0x139720);throw new common_1[(_0x21e22c(0x204))](_0x21e22c(0x22a),common_1[_0x21e22c(0x1fa)][_0x21e22c(0x22d)]);}}async[_0x407c5a(0x239)](_0x42c0e4,_0x5e3af1,_0x52c806){const _0xfa95e6=_0x407c5a,{id:_0x29cad4,role:_0x396335}=_0x42c0e4[_0xfa95e6(0x277)];let _0x55fe80=await this[_0xfa95e6(0x1bf)][_0xfa95e6(0x25c)]({'where':{'userId':_0x29cad4}});!_0x55fe80&&(_0x55fe80=await this['createBaseUserBalance'](_0x29cad4));if(_0x396335===_0xfa95e6(0x227))return this[_0xfa95e6(0x203)](_0x42c0e4,_0x5e3af1,_0x52c806);const _0x1fc1d6=await this[_0xfa95e6(0x23e)][_0xfa95e6(0x25c)]({'where':{'configKey':_0xfa95e6(0x1ea)}}),_0x1d66dc=_0x1fc1d6?_0x1fc1d6['configVal']:_0xfa95e6(0x213),_0x29b7cf=(0x0,verification_constant_1[_0xfa95e6(0x228)])(_0x5e3af1),_0x4b17ce=(0x0,verification_constant_1[_0xfa95e6(0x271)])(_0x5e3af1);if(_0x55fe80[_0xfa95e6(0x278)]&&_0x55fe80[_0x29b7cf]<_0x52c806){if(_0x55fe80[_0x4b17ce]<_0x52c806)throw new common_1['HttpException'](_0xfa95e6(0x284)+_0x1d66dc+_0xfa95e6(0x1c0),common_1[_0xfa95e6(0x1fa)][_0xfa95e6(0x24f)]);}if(!_0x55fe80[_0xfa95e6(0x278)]&&_0x55fe80[_0x4b17ce]<_0x52c806)throw new common_1[(_0xfa95e6(0x204))]('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x1d66dc+_0xfa95e6(0x1c0),common_1[_0xfa95e6(0x1fa)][_0xfa95e6(0x24f)]);return _0x55fe80;}async[_0x407c5a(0x203)](_0x2b0a7c,_0x514dc4,_0x5881c2){const _0x3011fa=_0x407c5a,{id:_0x206cd7}=_0x2b0a7c['user'],_0x5d6f99=_0x514dc4===_0x3011fa(0x1c8)?'model3Count':_0x514dc4==='model4'?_0x3011fa(0x214):_0x514dc4===_0x3011fa(0x279)?'drawMjCount':null,_0x1a7a30=new Date(),_0xd682b1=await this[_0x3011fa(0x250)]['findOne']({'where':{'fingerprint':_0x206cd7}}),{visitorModel3Num:_0x505738,visitorModel4Num:_0x40cd67,visitorMJNum:_0x28803d}=await this[_0x3011fa(0x21f)][_0x3011fa(0x226)]([_0x3011fa(0x1e4),_0x3011fa(0x275),_0x3011fa(0x1d0)]),_0x2ff4bb={'model3Count':_0x505738?Number(_0x505738):0x0,'model4Count':_0x40cd67?Number(_0x40cd67):0x0,'drawMjCount':_0x28803d?Number(_0x28803d):0x0};if(_0x2ff4bb[_0x5d6f99]===-0x1)return!![];if(!_0xd682b1){const _0x51bf3e={'fingerprint':_0x206cd7,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x46fd96=_0x5881c2||0x1;_0x51bf3e[_0x5d6f99]=_0x51bf3e[_0x5d6f99]+_0x46fd96;if(_0x51bf3e[_0x5d6f99]>_0x2ff4bb[_0x5d6f99]||!_0x51bf3e[_0x5d6f99])throw new common_1[(_0x3011fa(0x204))](_0x3011fa(0x272),common_1['HttpStatus'][_0x3011fa(0x24f)]);else return await this[_0x3011fa(0x250)][_0x3011fa(0x27c)](_0x51bf3e),!![];}else{const {model3Count:_0x4d6cfa,model4Count:_0x538053,drawMjCount:_0x50c91a}=_0xd682b1;let _0x40e612={'model3Count':_0x4d6cfa,'model4Count':_0x538053,'drawMjCount':_0x50c91a};const _0x5031d2=Number(new Date(_0xd682b1[_0x3011fa(0x249)])),_0x27c9fa=this['isUpdatedToday'](_0x5031d2),_0x619950=_0x5881c2||0x1;_0x27c9fa?_0x40e612[_0x5d6f99]=_0x40e612[_0x5d6f99]+_0x619950:(_0x40e612={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x40e612[_0x5d6f99]=_0x40e612[_0x5d6f99]+_0x619950);if(_0x40e612[_0x5d6f99]>_0x2ff4bb[_0x5d6f99])throw new common_1[(_0x3011fa(0x204))](_0x3011fa(0x272),common_1[_0x3011fa(0x1fa)][_0x3011fa(0x24f)]);else return await this['fingerprintLogEntity']['update']({'fingerprint':_0x206cd7},_0x40e612),!![];}}[_0x407c5a(0x1ce)](_0x5e765a){const _0x1937d7=_0x407c5a,_0x4c2de9=new Date(),_0x57373c=new Date(_0x4c2de9[_0x1937d7(0x257)](),_0x4c2de9[_0x1937d7(0x1c1)](),_0x4c2de9['getDate']());return _0x5e765a>=_0x57373c;}async['deductFromBalance'](_0x5d8cb1,_0x136520,_0x324150,_0x400a15=0x0){const _0x5a0ce2=_0x407c5a,_0xfac4e0=await this[_0x5a0ce2(0x1bf)][_0x5a0ce2(0x25c)]({'where':{'userId':_0x5d8cb1}});if(!_0xfac4e0)throw new common_1[(_0x5a0ce2(0x204))](_0x5a0ce2(0x23f),common_1['HttpStatus'][_0x5a0ce2(0x22d)]);const _0x4520e5=_0x136520===_0x5a0ce2(0x1c8)?'memberModel3Count':_0x136520==='model4'?_0x5a0ce2(0x1e1):_0x136520==='mjDraw'?_0x5a0ce2(0x1fc):null,_0x5481c3=_0x136520===_0x5a0ce2(0x1c8)?'model3Count':_0x136520===_0x5a0ce2(0x230)?_0x5a0ce2(0x214):_0x136520===_0x5a0ce2(0x279)?_0x5a0ce2(0x1f1):null,_0x1b8d56=_0xfac4e0[_0x5a0ce2(0x278)]&&_0xfac4e0[_0x4520e5]<_0x324150?_0x5481c3:_0xfac4e0[_0x5a0ce2(0x278)]?_0x4520e5:_0x5481c3;let _0x2aa214=null;_0x1b8d56[_0x5a0ce2(0x231)](_0x5a0ce2(0x1ed))&&(_0x2aa214=_0x5a0ce2(0x1d2));_0x1b8d56[_0x5a0ce2(0x231)](_0x5a0ce2(0x1d4))&&(_0x2aa214=_0x5a0ce2(0x267));_0x1b8d56[_0x5a0ce2(0x231)]('MjCount')&&(_0x2aa214=_0x5a0ce2(0x217));const _0x2cab45={[_0x1b8d56]:_0xfac4e0[_0x1b8d56]-_0x324150<0x0?0x0:_0xfac4e0[_0x1b8d56]-_0x324150,[_0x2aa214]:_0xfac4e0[_0x2aa214]+_0x400a15};_0x2aa214===_0x5a0ce2(0x1d2)&&(_0x2cab45[_0x5a0ce2(0x21c)]=_0xfac4e0[_0x5a0ce2(0x21c)]+0x1),_0x2aa214===_0x5a0ce2(0x267)&&(_0x2cab45[_0x5a0ce2(0x1da)]=_0xfac4e0[_0x5a0ce2(0x1da)]+0x1);const _0x2c7fd3=await this[_0x5a0ce2(0x1bf)][_0x5a0ce2(0x27b)]({'userId':_0x5d8cb1},_0x2cab45);if(_0x2c7fd3[_0x5a0ce2(0x210)]===0x0)throw new common_1[(_0x5a0ce2(0x204))](_0x5a0ce2(0x21a),common_1['HttpStatus']['BAD_REQUEST']);}async['queryUserBalance'](_0x285246){const _0x4ee801=_0x407c5a;try{const _0x942e75=await this['userBalanceEntity'][_0x4ee801(0x25c)]({'where':{'userId':_0x285246},'select':['packageId','model3Count',_0x4ee801(0x214),'drawMjCount',_0x4ee801(0x229),_0x4ee801(0x1e1),_0x4ee801(0x1fc),'useModel3Count',_0x4ee801(0x1da),_0x4ee801(0x1d2),'useModel4Token',_0x4ee801(0x217),_0x4ee801(0x26c)]});if(!_0x942e75){const _0x35e784=await this[_0x4ee801(0x22b)](_0x285246);if(_0x35e784)return await this['queryUserBalance'](_0x285246);else throw new common_1[(_0x4ee801(0x204))](_0x4ee801(0x1f8),common_1[_0x4ee801(0x1fa)][_0x4ee801(0x22d)]);}return _0x942e75[_0x4ee801(0x1de)]=_0x942e75['packageId']?_0x942e75['model3Count']+_0x942e75['memberModel3Count']:_0x942e75['model3Count'],_0x942e75[_0x4ee801(0x254)]=_0x942e75[_0x4ee801(0x278)]?_0x942e75[_0x4ee801(0x214)]+_0x942e75[_0x4ee801(0x1e1)]:_0x942e75[_0x4ee801(0x214)],_0x942e75[_0x4ee801(0x1ff)]=_0x942e75[_0x4ee801(0x278)]?_0x942e75[_0x4ee801(0x1f1)]+_0x942e75['memberDrawMjCount']:_0x942e75[_0x4ee801(0x1f1)],_0x942e75[_0x4ee801(0x26c)]=_0x942e75[_0x4ee801(0x26c)]?(0x0,date_1[_0x4ee801(0x282)])(_0x942e75[_0x4ee801(0x26c)],_0x4ee801(0x26d)):null,_0x942e75;}catch(_0x923593){console[_0x4ee801(0x1ca)](_0x4ee801(0x233),_0x923593);}}async[_0x407c5a(0x241)](_0x2e3ebf){const _0x3908d2=_0x407c5a,{userId:_0x3c4162,rechargeType:_0x9d3888,model3Count:_0x1d3cf9,model4Count:_0x4badb1,drawMjCount:_0x406dbd,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x2e3ebf;if(!_0x3c4162)throw new common_1[(_0x3908d2(0x204))](_0x3908d2(0x1f0),common_1['HttpStatus'][_0x3908d2(0x22d)]);const _0x43a2f4=(0x0,utils_1['createRandomUid'])();return await this[_0x3908d2(0x1f4)]['save']({'userId':_0x3c4162,'rechargeType':_0x9d3888,'model3Count':_0x1d3cf9,'model4Count':_0x4badb1,'drawMjCount':_0x406dbd,'days':days,'extent':extent,'uid':_0x43a2f4,'pkgName':pkgName});}async[_0x407c5a(0x22b)](_0x212325,_0x549cf8={}){const _0x7c035d=_0x407c5a,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x549cf8,_0x35cade=await this[_0x7c035d(0x1bf)]['findOne']({'where':{'userId':_0x212325}});if(_0x35cade)throw new common_1[(_0x7c035d(0x204))](_0x7c035d(0x270),common_1[_0x7c035d(0x1fa)]['BAD_REQUEST']);return await this[_0x7c035d(0x1bf)][_0x7c035d(0x27c)]({'userId':_0x212325,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x407c5a(0x1dd)](_0xd43ca2,_0x473104,_0x504b96=-0x1){const _0x3d55f8=_0x407c5a;try{const _0x52db12=await this[_0x3d55f8(0x1bf)]['findOne']({'where':{'userId':_0xd43ca2}})||await this['createBaseUserBalance'](_0xd43ca2);if(!_0x52db12)throw new common_1[(_0x3d55f8(0x204))](_0x3d55f8(0x27f),common_1[_0x3d55f8(0x1fa)]['BAD_REQUEST']);const {model3Count:_0xb676db,model4Count:_0x1bbba6,drawMjCount:_0x2cbfcd,memberModel3Count:_0x477106,memberModel4Count:_0x2c254c,memberDrawMjCount:_0x4bbb0e}=_0x52db12;let _0x1f9be9={};if(_0x504b96>0x0){const {packageId:_0x407aa8}=_0x473104;if(!_0x407aa8)throw new common_1[(_0x3d55f8(0x204))](_0x3d55f8(0x243),common_1[_0x3d55f8(0x1fa)][_0x3d55f8(0x22d)]);const _0x340a84=await this['cramiPackageEntity'][_0x3d55f8(0x25c)]({'where':{'id':_0x407aa8}});if(!_0x340a84)throw new common_1[(_0x3d55f8(0x204))](_0x3d55f8(0x1fe),common_1[_0x3d55f8(0x1fa)][_0x3d55f8(0x22d)]);const {weight:_0x32be67}=_0x340a84;if(!_0x52db12['packageId'])_0x1f9be9={'memberModel3Count':_0xb676db+_0x473104[_0x3d55f8(0x200)],'memberModel4Count':_0x1bbba6+_0x473104['model4Count'],'memberDrawMjCount':_0x2cbfcd+_0x473104[_0x3d55f8(0x1f1)],'expirationTime':(0x0,date_1['default'])()[_0x3d55f8(0x20a)](_0x504b96>0x0?_0x504b96:0x0,'day')[_0x3d55f8(0x286)](_0x3d55f8(0x1d5)),'packageId':_0x407aa8};else{const _0x2aa9ff=await this[_0x3d55f8(0x1e5)][_0x3d55f8(0x25c)]({'where':{'id':_0x52db12['packageId']}});_0x32be67>=_0x2aa9ff[_0x3d55f8(0x27d)]&&(_0x1f9be9={'memberModel3Count':_0x477106+_0x473104['model3Count'],'memberModel4Count':_0x2c254c+_0x473104[_0x3d55f8(0x214)],'memberDrawMjCount':_0x4bbb0e+_0x473104['drawMjCount'],'expirationTime':(0x0,date_1[_0x3d55f8(0x25e)])(_0x52db12['expirationTime'])[_0x3d55f8(0x20a)](_0x504b96>0x0?_0x504b96:0x0,_0x3d55f8(0x269))[_0x3d55f8(0x286)](_0x3d55f8(0x1d5)),'packageId':_0x407aa8}),_0x32be67<_0x2aa9ff[_0x3d55f8(0x27d)]&&(_0x1f9be9={'memberModel3Count':_0x477106+_0x473104['model3Count'],'memberModel4Count':_0x2c254c+_0x473104[_0x3d55f8(0x214)],'memberDrawMjCount':_0x4bbb0e+_0x473104[_0x3d55f8(0x1f1)]});}}_0x504b96<=0x0&&(_0x1f9be9={'model3Count':_0xb676db+_0x473104[_0x3d55f8(0x200)],'model4Count':_0x1bbba6+_0x473104[_0x3d55f8(0x214)],'drawMjCount':_0x2cbfcd+_0x473104['drawMjCount']});const _0x317f6d=await this[_0x3d55f8(0x1bf)]['update']({'userId':_0xd43ca2},_0x1f9be9);if(_0x317f6d[_0x3d55f8(0x210)]===0x0)throw new common_1[(_0x3d55f8(0x204))](_0xd43ca2+_0x3d55f8(0x258),common_1[_0x3d55f8(0x1fa)][_0x3d55f8(0x22d)]);}catch(_0x9db5cf){console[_0x3d55f8(0x1ca)](_0x3d55f8(0x233),_0x9db5cf);throw new common_1[(_0x3d55f8(0x204))](_0x3d55f8(0x1fb),common_1[_0x3d55f8(0x1fa)][_0x3d55f8(0x22d)]);}}async[_0x407c5a(0x24e)](_0x3ff33f){const _0x160f83=_0x407c5a;console[_0x160f83(0x1ca)]('充值的工单信息:',_0x3ff33f);try{const {userId:_0xdecc6b,goodsId:_0xf93a4f}=_0x3ff33f,_0x1f1cb2=await this[_0x160f83(0x1e5)][_0x160f83(0x25c)]({'where':{'id':_0x3ff33f['goodsId'],'status':0x1}});if(!_0x1f1cb2)throw new common_1[(_0x160f83(0x204))](_0x160f83(0x221),common_1['HttpStatus'][_0x160f83(0x22d)]);const {model3Count:_0x1bc0ea,model4Count:_0xa8ccdc,drawMjCount:_0x38217a,days:_0x499eab,name:_0x4a44ea}=_0x1f1cb2,_0x5d82e2={'model3Count':_0x1bc0ea,'model4Count':_0xa8ccdc,'drawMjCount':_0x38217a,'days':_0x499eab,'packageId':_0x3ff33f[_0x160f83(0x22f)]};await this[_0x160f83(0x1dd)](_0xdecc6b,_0x5d82e2,_0x499eab),await this['saveRecordRechargeLog']({'userId':_0xdecc6b,'rechargeType':balance_constant_1['RechargeType']['SCAN_PAY'],'model3Count':_0x1bc0ea,'model4Count':_0xa8ccdc,'drawMjCount':_0x38217a,'pkgName':_0x4a44ea,'days':_0x499eab});const _0x1296f1=await this[_0x160f83(0x201)][_0x160f83(0x25c)]({'where':{'id':_0xdecc6b}}),{invitedBy:_0x24cd26}=_0x1296f1;if(_0x24cd26){const _0x1ca1cd=await this['userEntity'][_0x160f83(0x25c)]({'where':{'inviteCode':_0x24cd26}}),_0x3bcfa4=await this[_0x160f83(0x23b)][_0x160f83(0x25c)]({'where':{'userId':_0x1ca1cd['id']}});if(!_0x1ca1cd)return;const {id:_0x4b642e}=_0x1ca1cd,{performanceRatio:_0xdbf878}=_0x3bcfa4,_0x2bce80={'inviterUserId':_0x4b642e,'inviteeUserId':_0xdecc6b,'orderId':_0x3ff33f['id'],'orderPrice':_0x3ff33f[_0x160f83(0x223)],'commissionPercentage':_0xdbf878,'commissionAmount':(_0x3ff33f['total']*_0xdbf878/0x64)['toFixed'](0x2)};await this[_0x160f83(0x260)][_0x160f83(0x23c)](_0x2bce80),await this[_0x160f83(0x260)][_0x160f83(0x232)](_0x4b642e,_0x2bce80['commissionAmount']);}}catch(_0x5def85){console[_0x160f83(0x1ca)]('error:\x20',_0x5def85);throw new common_1[(_0x160f83(0x204))](_0x160f83(0x24b),common_1[_0x160f83(0x1fa)][_0x160f83(0x22d)]);}}async[_0x407c5a(0x23a)](_0x3f0c4c,_0x522d34){const _0x459cd8=_0x407c5a,{page:page=0x1,size:size=0x14}=_0x522d34,{id:_0xee86b6}=_0x3f0c4c[_0x459cd8(0x277)],[_0x1986a0,_0x4ea876]=await this[_0x459cd8(0x1f4)][_0x459cd8(0x268)]({'where':{'userId':_0xee86b6},'order':{'id':_0x459cd8(0x264)},'skip':(page-0x1)*size,'take':size});return _0x1986a0[_0x459cd8(0x219)](_0x324f87=>{const _0x3f1058=_0x459cd8;_0x324f87[_0x3f1058(0x26f)]=_0x324f87['days']>0x0?_0x324f87[_0x3f1058(0x263)]+'天':'永久';}),{'rows':(0x0,date_1[_0x459cd8(0x1d8)])(_0x1986a0),'count':_0x4ea876};}async[_0x407c5a(0x1c3)](_0x1475d4,_0x4d35ab){const _0x441d27=_0x407c5a;try{const {page:page=0x1,size:size=0xa,userId:_0x3e1031,rechargeType:_0x3ac29e,packageId:_0x2cf81a}=_0x4d35ab,{role:_0x11f769}=_0x1475d4[_0x441d27(0x277)],_0x2c4608={};_0x3ac29e&&(_0x2c4608[_0x441d27(0x1c7)]=_0x3ac29e),_0x2c4608[_0x441d27(0x234)]=_0x3e1031||(0x0,typeorm_2['LessThan'])(0x186a0),_0x2cf81a&&(_0x2c4608[_0x441d27(0x278)]={'$like':'%'+_0x2cf81a+'%'});const [_0x36e3d7,_0xb8831e]=await this[_0x441d27(0x1f4)][_0x441d27(0x268)]({'where':_0x2c4608,'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size}),_0x2d02d5=_0x36e3d7[_0x441d27(0x26a)](_0xa92c31=>_0xa92c31[_0x441d27(0x234)]),_0x45d345=await this[_0x441d27(0x201)][_0x441d27(0x1f6)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2d02d5)}});return _0x36e3d7[_0x441d27(0x219)](_0x16244b=>{const _0x3ded77=_0x441d27,_0x32205e=_0x45d345[_0x3ded77(0x1f6)](_0x5471ea=>_0x5471ea['id']===_0x16244b['userId']);_0x16244b[_0x3ded77(0x22c)]=_0x32205e===null||_0x32205e===void 0x0?void 0x0:_0x32205e[_0x3ded77(0x22c)],_0x16244b[_0x3ded77(0x1f9)]=_0x32205e===null||_0x32205e===void 0x0?void 0x0:_0x32205e[_0x3ded77(0x1f9)],_0x16244b[_0x3ded77(0x237)]=_0x32205e===null||_0x32205e===void 0x0?void 0x0:_0x32205e[_0x3ded77(0x237)],_0x16244b[_0x3ded77(0x202)]=_0x32205e===null||_0x32205e===void 0x0?void 0x0:_0x32205e[_0x3ded77(0x202)],_0x16244b['avatar']=_0x32205e===null||_0x32205e===void 0x0?void 0x0:_0x32205e['avatar'];}),_0x11f769!=='super'&&_0x36e3d7['forEach'](_0x597106=>{const _0x1611e6=_0x441d27;_0x597106['email']=_0x597106['email']?(0x0,utils_1[_0x1611e6(0x21d)])(_0x597106['email']):'',_0x597106[_0x1611e6(0x237)]=_0x597106[_0x1611e6(0x237)]?(0x0,utils_1[_0x1611e6(0x21d)])(_0x597106[_0x1611e6(0x237)]):'';}),{'rows':_0x36e3d7,'count':_0xb8831e};}catch(_0xfebf7f){console[_0x441d27(0x1ca)](_0x441d27(0x233),_0xfebf7f);throw new common_1[(_0x441d27(0x204))]('查询用户账户失败！',common_1[_0x441d27(0x1fa)]['BAD_REQUEST']);}}async[_0x407c5a(0x22e)](_0x3d57bf){const _0x33315f=_0x407c5a;return await this['userBalanceEntity'][_0x33315f(0x1f6)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x3d57bf)}});}async[_0x407c5a(0x1f7)](_0x5235c7,_0x20f15b){}async[_0x407c5a(0x20c)](_0x2c59d5,_0x56167f){const _0x162322=_0x407c5a,_0x4f4801=await this[_0x162322(0x1bf)][_0x162322(0x25c)]({'where':{'userId':_0x2c59d5}});if(!_0x4f4801)return;await this[_0x162322(0x241)]({'userId':_0x2c59d5,'rechargeType':balance_constant_1[_0x162322(0x20e)][_0x162322(0x236)],'model3Count':0x0,'model4Count':0x0,'drawMjCount':_0x56167f,'pkgName':'','days':0x0}),await this[_0x162322(0x1bf)][_0x162322(0x27b)]({'userId':_0x2c59d5},{'drawMjCount':_0x4f4801[_0x162322(0x1f1)]+Number(_0x56167f)});}async[_0x407c5a(0x1d7)](){const _0x4bb0ed=_0x407c5a,_0x30c4b5=await this[_0x4bb0ed(0x201)][_0x4bb0ed(0x1f6)]();if(!_0x30c4b5[_0x4bb0ed(0x23d)])return;const _0x1220cf=await this['globalConfigService']['getConfigs']([_0x4bb0ed(0x1f5)]);if(!_0x1220cf)await this[_0x4bb0ed(0x21f)]['setConfig']({'settings':[{'configKey':_0x4bb0ed(0x1f5),'configVal':'1'}]});else throw new common_1[(_0x4bb0ed(0x204))](_0x4bb0ed(0x274),common_1[_0x4bb0ed(0x1fa)][_0x4bb0ed(0x22d)]);_0x30c4b5[_0x4bb0ed(0x219)](_0x3de514=>{const _0x37a574=_0x4bb0ed,{id:_0x14c5be}=_0x3de514;this[_0x37a574(0x1e9)][_0x37a574(0x25c)]({'where':{'userId':_0x14c5be}})[_0x37a574(0x20b)](_0x33f350=>{const _0x159379=_0x37a574;if(!_0x33f350)return;this[_0x159379(0x281)](_0x14c5be,_0x33f350);});});}async[_0x407c5a(0x281)](_0x42f73c,_0x384986){const _0x59d11f=_0x407c5a,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x384986,_0x1ab335=await this[_0x59d11f(0x1c4)][_0x59d11f(0x25c)]({'where':{'userId':_0x42f73c}}),_0x18f9e8={'userId':_0x42f73c,'model3Count':Number(usesLeft),'model4Count':(_0x1ab335===null||_0x1ab335===void 0x0?void 0x0:_0x1ab335[_0x59d11f(0x248)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x1ab335===null||_0x1ab335===void 0x0?void 0x0:_0x1ab335['useCount'])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x5e113b=await this[_0x59d11f(0x1bf)][_0x59d11f(0x25c)]({'where':{'userId':_0x42f73c}});_0x5e113b?common_1[_0x59d11f(0x1ec)][_0x59d11f(0x1cc)]('用户'+_0x42f73c+'账户信息已经存在、迁移无效',_0x59d11f(0x1bd)):this['userBalanceEntity'][_0x59d11f(0x27c)](_0x18f9e8)['then'](_0xc31bdb=>{const _0x5ef967=_0x59d11f;common_1[_0x5ef967(0x1ec)][_0x5ef967(0x1cc)]('用户'+_0x42f73c+_0x5ef967(0x1f3),_0x5ef967(0x1bd));})[_0x59d11f(0x212)](_0x6f6ba0=>{const _0x353c8b=_0x59d11f;console['log'](_0x353c8b(0x233),_0x6f6ba0),common_1['Logger'][_0x353c8b(0x1cc)]('用户'+_0x42f73c+_0x353c8b(0x240),_0x353c8b(0x1bd));});}async[_0x407c5a(0x21b)](_0x41d77f){const _0x3fe404=_0x407c5a,{fingerprint:_0x1679ab}=_0x41d77f['headers'],{id:_0x37e906}=_0x41d77f[_0x3fe404(0x277)];return await this[_0x3fe404(0x259)][_0x3fe404(0x27b)]({'userId':Number(_0x1679ab)},{'userId':_0x37e906}),await this[_0x3fe404(0x1f2)]['update']({'userId':Number(_0x1679ab)},{'userId':_0x37e906}),await this[_0x3fe404(0x1df)]['update']({'userId':Number(_0x1679ab)},{'userId':_0x37e906}),0x1;}async[_0x407c5a(0x1e8)](_0x4476b7){const _0x536fa2=_0x407c5a,{fingerprint:_0xc3d935}=_0x4476b7[_0x536fa2(0x262)],_0x2a3c27=await this[_0x536fa2(0x259)][_0x536fa2(0x248)]({'where':{'userId':_0xc3d935}}),_0x50cbf7=await this[_0x536fa2(0x1f2)][_0x536fa2(0x248)]({'where':{'userId':_0xc3d935}}),_0x3a7ca3=await this['midjourneyEntity'][_0x536fa2(0x248)]({'where':{'userId':_0xc3d935}});return _0x2a3c27||_0x50cbf7||_0x3a7ca3||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x407c5a(0x27e)])(),__param(0x0,(0x0,typeorm_1[_0x407c5a(0x25b)])(balance_entity_1[_0x407c5a(0x1cd)])),__param(0x1,(0x0,typeorm_1[_0x407c5a(0x25b)])(userBalance_entity_1['UserBalanceEntity'])),__param(0x2,(0x0,typeorm_1[_0x407c5a(0x25b)])(accountLog_entity_1[_0x407c5a(0x276)])),__param(0x3,(0x0,typeorm_1[_0x407c5a(0x25b)])(cramiPackage_entity_1[_0x407c5a(0x283)])),__param(0x4,(0x0,typeorm_1[_0x407c5a(0x25b)])(config_entity_1[_0x407c5a(0x216)])),__param(0x5,(0x0,typeorm_1[_0x407c5a(0x25b)])(user_entity_1[_0x407c5a(0x215)])),__param(0x6,(0x0,typeorm_1[_0x407c5a(0x25b)])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x7,(0x0,typeorm_1[_0x407c5a(0x25b)])(whiteList_entity_1[_0x407c5a(0x1e7)])),__param(0x8,(0x0,typeorm_1[_0x407c5a(0x25b)])(fingerprint_entity_1['FingerprintLogEntity'])),__param(0x9,(0x0,typeorm_1[_0x407c5a(0x25b)])(chatGroup_entity_1[_0x407c5a(0x1eb)])),__param(0xa,(0x0,typeorm_1[_0x407c5a(0x25b)])(chatLog_entity_1[_0x407c5a(0x1bc)])),__param(0xb,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1[_0x407c5a(0x255)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x407c5a(0x1d9)],typeorm_2[_0x407c5a(0x1d9)],typeorm_2[_0x407c5a(0x1d9)],typeorm_2['Repository'],typeorm_2[_0x407c5a(0x1d9)],typeorm_2[_0x407c5a(0x1d9)],typeorm_2[_0x407c5a(0x1d9)],typeorm_2[_0x407c5a(0x1d9)],typeorm_2[_0x407c5a(0x1d9)],typeorm_2[_0x407c5a(0x1d9)],typeorm_2['Repository'],sales_service_1[_0x407c5a(0x21e)],globalConfig_service_1[_0x407c5a(0x222)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;