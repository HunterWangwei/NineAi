'use strict';const _0x2508d1=_0x2fe6;(function(_0x42031e,_0x13db7e){const _0x1e3237=_0x2fe6,_0x45cb45=_0x42031e();while(!![]){try{const _0x3eed5f=parseInt(_0x1e3237(0x1ca))/0x1*(-parseInt(_0x1e3237(0x1bd))/0x2)+parseInt(_0x1e3237(0x1bb))/0x3*(parseInt(_0x1e3237(0x238))/0x4)+-parseInt(_0x1e3237(0x200))/0x5*(-parseInt(_0x1e3237(0x228))/0x6)+parseInt(_0x1e3237(0x1d0))/0x7*(-parseInt(_0x1e3237(0x1c4))/0x8)+-parseInt(_0x1e3237(0x225))/0x9*(parseInt(_0x1e3237(0x1d1))/0xa)+parseInt(_0x1e3237(0x1d7))/0xb*(-parseInt(_0x1e3237(0x19b))/0xc)+parseInt(_0x1e3237(0x20b))/0xd;if(_0x3eed5f===_0x13db7e)break;else _0x45cb45['push'](_0x45cb45['shift']());}catch(_0x9eb0d0){_0x45cb45['push'](_0x45cb45['shift']());}}}(_0x2987,0x3b30b));var __decorate=this&&this[_0x2508d1(0x1c3)]||function(_0x3b7fe0,_0x4b0e59,_0x818ec2,_0x4b88e1){const _0x53bbb3=_0x2508d1;var _0x13bf95=arguments[_0x53bbb3(0x226)],_0xb769ad=_0x13bf95<0x3?_0x4b0e59:_0x4b88e1===null?_0x4b88e1=Object['getOwnPropertyDescriptor'](_0x4b0e59,_0x818ec2):_0x4b88e1,_0x21e3e9;if(typeof Reflect===_0x53bbb3(0x1a9)&&typeof Reflect[_0x53bbb3(0x1e7)]===_0x53bbb3(0x1e6))_0xb769ad=Reflect['decorate'](_0x3b7fe0,_0x4b0e59,_0x818ec2,_0x4b88e1);else{for(var _0x182ae4=_0x3b7fe0[_0x53bbb3(0x226)]-0x1;_0x182ae4>=0x0;_0x182ae4--)if(_0x21e3e9=_0x3b7fe0[_0x182ae4])_0xb769ad=(_0x13bf95<0x3?_0x21e3e9(_0xb769ad):_0x13bf95>0x3?_0x21e3e9(_0x4b0e59,_0x818ec2,_0xb769ad):_0x21e3e9(_0x4b0e59,_0x818ec2))||_0xb769ad;}return _0x13bf95>0x3&&_0xb769ad&&Object[_0x53bbb3(0x1b7)](_0x4b0e59,_0x818ec2,_0xb769ad),_0xb769ad;},__metadata=this&&this[_0x2508d1(0x1c2)]||function(_0x4bae80,_0x2d85f0){const _0x2ec52f=_0x2508d1;if(typeof Reflect===_0x2ec52f(0x1a9)&&typeof Reflect[_0x2ec52f(0x19e)]===_0x2ec52f(0x1e6))return Reflect[_0x2ec52f(0x19e)](_0x4bae80,_0x2d85f0);},__param=this&&this['__param']||function(_0x3bac57,_0x139718){return function(_0x9c2733,_0x578896){_0x139718(_0x9c2733,_0x578896,_0x3bac57);};};function _0x2fe6(_0x236e6f,_0x114cbc){const _0x298754=_0x2987();return _0x2fe6=function(_0x2fe65e,_0x428f95){_0x2fe65e=_0x2fe65e-0x18c;let _0x11ee1d=_0x298754[_0x2fe65e];return _0x11ee1d;},_0x2fe6(_0x236e6f,_0x114cbc);}Object['defineProperty'](exports,_0x2508d1(0x1f0),{'value':!![]}),exports[_0x2508d1(0x1ff)]=void 0x0;const globalConfig_service_1=require(_0x2508d1(0x211)),typeorm_1=require(_0x2508d1(0x234)),balance_entity_1=require(_0x2508d1(0x1b6)),common_1=require('@nestjs/common'),typeorm_2=require(_0x2508d1(0x21e)),balance_constant_1=require(_0x2508d1(0x1c1)),accountLog_entity_1=require(_0x2508d1(0x1a0)),utils_1=require('../../common/utils'),config_entity_1=require(_0x2508d1(0x1f1)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_entity_1=require(_0x2508d1(0x21a)),date_1=require(_0x2508d1(0x241)),user_entity_1=require(_0x2508d1(0x197)),salesUsers_entity_1=require(_0x2508d1(0x22d)),sales_service_1=require(_0x2508d1(0x1d4)),whiteList_entity_1=require('../chatgpt/whiteList.entity'),fingerprint_entity_1=require(_0x2508d1(0x1a2)),chatLog_entity_1=require(_0x2508d1(0x1cb)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),midjourney_entity_1=require(_0x2508d1(0x190));let UserBalanceService=class UserBalanceService{constructor(_0x293644,_0x20d020,_0xb4e7ce,_0x39b346,_0x44f72e,_0x544701,_0x16073c,_0xdc2779,_0x1234e6,_0x5db68a,_0x4e2eb3,_0x402588,_0x2063ce,_0x178af5){const _0x58d543=_0x2508d1;this[_0x58d543(0x1e8)]=_0x293644,this[_0x58d543(0x23c)]=_0x20d020,this[_0x58d543(0x220)]=_0xb4e7ce,this[_0x58d543(0x1b2)]=_0x39b346,this['configEntity']=_0x44f72e,this[_0x58d543(0x1fa)]=_0x544701,this[_0x58d543(0x204)]=_0x16073c,this[_0x58d543(0x23a)]=_0xdc2779,this[_0x58d543(0x218)]=_0x1234e6,this[_0x58d543(0x22c)]=_0x5db68a,this[_0x58d543(0x19d)]=_0x4e2eb3,this['midjourneyEntity']=_0x402588,this[_0x58d543(0x1ce)]=_0x2063ce,this[_0x58d543(0x250)]=_0x178af5;}async['addBalanceToNewUser'](_0x2f40a0,_0x26a227){const _0x1f2061=_0x2508d1;try{const _0x4d15eb=await this[_0x1f2061(0x1ee)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])(['registerSendStatus',_0x1f2061(0x18d),'registerSendModel4Count',_0x1f2061(0x1f8),_0x1f2061(0x217),_0x1f2061(0x1fc),'firstRregisterSendModel3Count',_0x1f2061(0x1ba),_0x1f2061(0x245),_0x1f2061(0x1b8),'inviteGiveSendModel3Count',_0x1f2061(0x1e5),_0x1f2061(0x232),_0x1f2061(0x192),_0x1f2061(0x236),'invitedGuestSendModel4Count'])}}),_0x4804b4=_0x4d15eb[_0x1f2061(0x214)]((_0x3bd0b5,_0x39ea8d)=>{const _0x3793b0=_0x1f2061,_0x936c3=Number(_0x39ea8d[_0x3793b0(0x1af)]),_0x57f608=Number[_0x3793b0(0x1c7)](_0x936c3)&&_0x936c3>0x0?_0x936c3:0x0;return _0x3bd0b5[_0x39ea8d['configKey']]=_0x57f608,_0x3bd0b5;},{});let _0x1a7888=0x0,_0x34e5ee=0x0,_0x5afc35=0x0;_0x4804b4[_0x1f2061(0x1f5)]===0x1&&(_0x1a7888=_0x1a7888+_0x4804b4[_0x1f2061(0x18d)],_0x34e5ee=_0x34e5ee+_0x4804b4[_0x1f2061(0x1ea)],_0x5afc35=_0x5afc35+_0x4804b4[_0x1f2061(0x1f8)]),_0x4804b4[_0x1f2061(0x1f5)]===0x1&&_0x4804b4['firstRegisterSendStatus']===0x1&&_0x2f40a0<=_0x4804b4['firstRegisterSendRank']&&(_0x1a7888=_0x1a7888+_0x4804b4[_0x1f2061(0x1f7)],_0x34e5ee=_0x34e5ee+_0x4804b4['firstRregisterSendModel4Count'],_0x5afc35=_0x5afc35+_0x4804b4[_0x1f2061(0x245)]),await this[_0x1f2061(0x1cf)]({'userId':_0x2f40a0,'rechargeType':balance_constant_1['RechargeType'][_0x1f2061(0x235)],'model3Count':_0x1a7888,'drawMjCount':_0x5afc35,'model4Count':_0x34e5ee}),_0x26a227&&(Number(_0x4804b4[_0x1f2061(0x1b8)])===0x1&&(_0x1a7888=_0x1a7888+Number(_0x4804b4[_0x1f2061(0x192)]),_0x34e5ee=_0x34e5ee+Number(_0x4804b4[_0x1f2061(0x243)]),_0x5afc35=_0x5afc35+Number(_0x4804b4['invitedGuestSendDrawMjCount']),await this[_0x1f2061(0x1cf)]({'userId':_0x2f40a0,'rechargeType':balance_constant_1[_0x1f2061(0x1cd)][_0x1f2061(0x19c)],'model3Count':_0x4804b4[_0x1f2061(0x192)],'model4Count':_0x4804b4[_0x1f2061(0x243)],'drawMjCount':_0x4804b4[_0x1f2061(0x236)]}),await this[_0x1f2061(0x1dc)](_0x26a227,{'model3Count':_0x4804b4[_0x1f2061(0x237)],'model4Count':_0x4804b4[_0x1f2061(0x1e5)],'drawMjCount':_0x4804b4[_0x1f2061(0x232)]}),await this[_0x1f2061(0x1cf)]({'userId':_0x26a227,'rechargeType':balance_constant_1[_0x1f2061(0x1cd)]['REFER_GIFT'],'model3Count':_0x4804b4[_0x1f2061(0x237)],'model4Count':_0x4804b4[_0x1f2061(0x1e5)],'drawMjCount':_0x4804b4[_0x1f2061(0x232)]}))),await this['userBalanceEntity']['save']({'userId':_0x2f40a0,'model3Count':_0x1a7888,'model4Count':_0x34e5ee,'drawMjCount':_0x5afc35,'useTokens':0x0});}catch(_0x2d995e){console['log'](_0x1f2061(0x21d),_0x2d995e);throw new common_1[(_0x1f2061(0x23f))](_0x1f2061(0x1fd),common_1[_0x1f2061(0x202)]['BAD_REQUEST']);}}async[_0x2508d1(0x1be)](_0x51a5f4,_0x303762,_0x5be260){const _0xf8a4d1=_0x2508d1,{id:_0x1f66a4,role:_0x2b8dbb}=_0x51a5f4[_0xf8a4d1(0x1df)];let _0x696de=await this[_0xf8a4d1(0x23c)][_0xf8a4d1(0x216)]({'where':{'userId':_0x1f66a4}});!_0x696de&&(_0x696de=await this['createBaseUserBalance'](_0x1f66a4));if(_0x2b8dbb===_0xf8a4d1(0x24c))return this['validateVisitorBalance'](_0x51a5f4,_0x303762,_0x5be260);const _0xe6f566=await this[_0xf8a4d1(0x1ee)]['findOne']({'where':{'configKey':_0xf8a4d1(0x1d3)}}),_0x31d593=_0xe6f566?_0xe6f566[_0xf8a4d1(0x1af)]:'---',_0x1885d2=_0x303762===_0xf8a4d1(0x20a)?_0xf8a4d1(0x1f3):_0x303762===_0xf8a4d1(0x24a)?_0xf8a4d1(0x1f6):_0x303762===_0xf8a4d1(0x22f)?_0xf8a4d1(0x1eb):null,_0x2d7f89=_0x303762===_0xf8a4d1(0x20a)?_0xf8a4d1(0x24d):_0x303762===_0xf8a4d1(0x24a)?_0xf8a4d1(0x1c8):_0x303762===_0xf8a4d1(0x22f)?'drawMjCount':null;if(_0x696de[_0xf8a4d1(0x1e4)]&&_0x696de[_0x1885d2]<_0x5be260){if(_0x696de[_0x2d7f89]<_0x5be260)throw new common_1[(_0xf8a4d1(0x23f))]('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x31d593+'>\x20或购买专属套餐\x20！',common_1[_0xf8a4d1(0x202)][_0xf8a4d1(0x18e)]);}if(!_0x696de[_0xf8a4d1(0x1e4)]&&_0x696de[_0x2d7f89]<_0x5be260)throw new common_1[(_0xf8a4d1(0x23f))](_0xf8a4d1(0x24b)+_0x31d593+_0xf8a4d1(0x251),common_1[_0xf8a4d1(0x202)][_0xf8a4d1(0x18e)]);return _0x696de;}async[_0x2508d1(0x23b)](_0x2f6491,_0x33cbde,_0x5d1587){const _0x178db2=_0x2508d1,{id:_0x406ff1}=_0x2f6491['user'],_0x4f0b48=_0x33cbde===_0x178db2(0x20a)?_0x178db2(0x24d):_0x33cbde===_0x178db2(0x24a)?_0x178db2(0x1c8):_0x33cbde==='mjDraw'?'drawMjCount':null,_0x843d7c=new Date(),_0x206ef4=await this[_0x178db2(0x218)]['findOne']({'where':{'fingerprint':_0x406ff1}}),{visitorModel3Num:_0x5ccb61,visitorModel4Num:_0x599fd8,visitorMJNum:_0x54dc42}=await this[_0x178db2(0x250)][_0x178db2(0x21c)]([_0x178db2(0x208),_0x178db2(0x1c5),_0x178db2(0x199)]),_0x312a02={'model3Count':_0x5ccb61?Number(_0x5ccb61):0x0,'model4Count':_0x599fd8?Number(_0x599fd8):0x0,'drawMjCount':_0x54dc42?Number(_0x54dc42):0x0};if(!_0x206ef4){const _0x21b774={'fingerprint':_0x406ff1,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x21b774[_0x4f0b48]=_0x21b774[_0x4f0b48]+_0x5d1587;if(_0x21b774[_0x4f0b48]>_0x312a02[_0x4f0b48])throw new common_1[(_0x178db2(0x23f))](_0x178db2(0x224),common_1[_0x178db2(0x202)]['PAYMENT_REQUIRED']);else return await this[_0x178db2(0x218)][_0x178db2(0x249)](_0x21b774),!![];}else{const {model3Count:_0x30b301,model4Count:_0x344c69,drawMjCount:_0x5a94db}=_0x206ef4;let _0x1128f7={'model3Count':_0x30b301,'model4Count':_0x344c69,'drawMjCount':_0x5a94db};const _0x13fa8c=Number(new Date(_0x206ef4[_0x178db2(0x1ac)])),_0x23208d=this['isUpdatedToday'](_0x13fa8c);_0x23208d?_0x1128f7[_0x4f0b48]=_0x1128f7[_0x4f0b48]+_0x5d1587:(_0x1128f7={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x1128f7[_0x4f0b48]=_0x1128f7[_0x4f0b48]+_0x5d1587);if(_0x1128f7[_0x4f0b48]>_0x312a02[_0x4f0b48])throw new common_1[(_0x178db2(0x23f))](_0x178db2(0x224),common_1[_0x178db2(0x202)][_0x178db2(0x18e)]);else return await this[_0x178db2(0x218)]['update']({'fingerprint':_0x406ff1},_0x1128f7),!![];}}['isUpdatedToday'](_0x27b180){const _0x2c97c8=_0x2508d1,_0x344960=new Date(),_0x46d93b=new Date(_0x344960[_0x2c97c8(0x198)](),_0x344960[_0x2c97c8(0x221)](),_0x344960['getDate']());return _0x27b180>=_0x46d93b;}async[_0x2508d1(0x1b0)](_0x126c89,_0x3ffe81,_0x41f37f,_0x103d70=0x0){const _0x2216b8=_0x2508d1,_0x5750bb=await this[_0x2216b8(0x23c)][_0x2216b8(0x216)]({'where':{'userId':_0x126c89}});if(!_0x5750bb)throw new common_1[(_0x2216b8(0x23f))]('缺失当前用户账户记录！',common_1[_0x2216b8(0x202)][_0x2216b8(0x24f)]);const _0x548e12=_0x3ffe81===_0x2216b8(0x20a)?_0x2216b8(0x1f3):_0x3ffe81===_0x2216b8(0x24a)?_0x2216b8(0x1f6):_0x3ffe81===_0x2216b8(0x22f)?_0x2216b8(0x1eb):null,_0x375414=_0x3ffe81===_0x2216b8(0x20a)?_0x2216b8(0x24d):_0x3ffe81==='model4'?_0x2216b8(0x1c8):_0x3ffe81===_0x2216b8(0x22f)?_0x2216b8(0x1b9):null,_0x4e01ee=_0x5750bb[_0x2216b8(0x1e4)]&&_0x5750bb[_0x548e12]<_0x41f37f?_0x375414:_0x5750bb[_0x2216b8(0x1e4)]?_0x548e12:_0x375414;let _0x280db4=null;_0x4e01ee[_0x2216b8(0x254)](_0x2216b8(0x1ad))&&(_0x280db4=_0x2216b8(0x227));_0x4e01ee[_0x2216b8(0x254)](_0x2216b8(0x1ab))&&(_0x280db4='useModel4Token');_0x4e01ee[_0x2216b8(0x254)](_0x2216b8(0x1a8))&&(_0x280db4=_0x2216b8(0x206));const _0x3a6479={[_0x4e01ee]:_0x5750bb[_0x4e01ee]-_0x41f37f<0x0?0x0:_0x5750bb[_0x4e01ee]-_0x41f37f,[_0x280db4]:_0x5750bb[_0x280db4]+_0x103d70};_0x280db4===_0x2216b8(0x227)&&(_0x3a6479['useModel3Count']=_0x5750bb['useModel3Count']+0x1),_0x280db4==='useModel4Token'&&(_0x3a6479[_0x2216b8(0x191)]=_0x5750bb[_0x2216b8(0x191)]+0x1);const _0x2a81ed=await this[_0x2216b8(0x23c)][_0x2216b8(0x1c0)]({'userId':_0x126c89},_0x3a6479);if(_0x2a81ed['affected']===0x0)throw new common_1[(_0x2216b8(0x23f))](_0x2216b8(0x1d9),common_1[_0x2216b8(0x202)][_0x2216b8(0x24f)]);}async['queryUserBalance'](_0x3cd46e){const _0x21420f=_0x2508d1;try{const _0x1f7f86=await this[_0x21420f(0x23c)][_0x21420f(0x216)]({'where':{'userId':_0x3cd46e},'select':['packageId',_0x21420f(0x24d),_0x21420f(0x1c8),_0x21420f(0x1b9),'memberModel3Count',_0x21420f(0x1f6),'memberDrawMjCount',_0x21420f(0x1c6),'useModel4Count',_0x21420f(0x227),_0x21420f(0x19f),'useDrawMjToken',_0x21420f(0x203)]});if(!_0x1f7f86){const _0x55976b=await this[_0x21420f(0x240)](_0x3cd46e);if(_0x55976b)return await this[_0x21420f(0x1fb)](_0x3cd46e);else throw new common_1[(_0x21420f(0x23f))](_0x21420f(0x1e1),common_1['HttpStatus'][_0x21420f(0x24f)]);}return _0x1f7f86[_0x21420f(0x223)]=_0x1f7f86[_0x21420f(0x1e4)]?_0x1f7f86[_0x21420f(0x24d)]+_0x1f7f86['memberModel3Count']:_0x1f7f86[_0x21420f(0x24d)],_0x1f7f86['sumModel4Count']=_0x1f7f86[_0x21420f(0x1e4)]?_0x1f7f86[_0x21420f(0x1c8)]+_0x1f7f86[_0x21420f(0x1f6)]:_0x1f7f86[_0x21420f(0x1c8)],_0x1f7f86[_0x21420f(0x201)]=_0x1f7f86[_0x21420f(0x1e4)]?_0x1f7f86['drawMjCount']+_0x1f7f86[_0x21420f(0x1eb)]:_0x1f7f86[_0x21420f(0x1b9)],_0x1f7f86['expirationTime']=_0x1f7f86['expirationTime']?(0x0,date_1[_0x21420f(0x212)])(_0x1f7f86[_0x21420f(0x203)],_0x21420f(0x253)):null,_0x1f7f86;}catch(_0x1c3f76){console[_0x21420f(0x230)](_0x21420f(0x21d),_0x1c3f76);}}async[_0x2508d1(0x1cf)](_0x3934ba){const _0x2121ea=_0x2508d1,{userId:_0x33d437,rechargeType:_0x45aa3d,model3Count:_0x3bbf3d,model4Count:_0x96d204,drawMjCount:_0x3e4bc2,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x3934ba;if(!_0x33d437)throw new common_1[(_0x2121ea(0x23f))]('当前用户不存在,记录充值日志异常',common_1[_0x2121ea(0x202)]['BAD_REQUEST']);const _0x2b6f6a=(0x0,utils_1[_0x2121ea(0x1bc)])();return await this[_0x2121ea(0x220)]['save']({'userId':_0x33d437,'rechargeType':_0x45aa3d,'model3Count':_0x3bbf3d,'model4Count':_0x96d204,'drawMjCount':_0x3e4bc2,'days':days,'extent':extent,'uid':_0x2b6f6a,'pkgName':pkgName});}async[_0x2508d1(0x240)](_0x111b86,_0x4756fb={}){const _0x4a7a29=_0x2508d1,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4756fb,_0x518763=await this[_0x4a7a29(0x23c)][_0x4a7a29(0x216)]({'where':{'userId':_0x111b86}});if(_0x518763)throw new common_1[(_0x4a7a29(0x23f))](_0x4a7a29(0x1a7),common_1['HttpStatus'][_0x4a7a29(0x24f)]);return await this[_0x4a7a29(0x23c)][_0x4a7a29(0x249)]({'userId':_0x111b86,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x2508d1(0x1dc)](_0xae9d29,_0x3b7a18,_0x2ddaa3=-0x1){const _0x3509fe=_0x2508d1;try{const _0x2bbaf4=await this['userBalanceEntity']['findOne']({'where':{'userId':_0xae9d29}})||await this[_0x3509fe(0x240)](_0xae9d29);if(!_0x2bbaf4)throw new common_1[(_0x3509fe(0x23f))](_0x3509fe(0x252),common_1[_0x3509fe(0x202)][_0x3509fe(0x24f)]);const {model3Count:_0x590b87,model4Count:_0x3d706b,drawMjCount:_0x37ea0e,memberModel3Count:_0x5a2a90,memberModel4Count:_0x67b767,memberDrawMjCount:_0x4b9ab7}=_0x2bbaf4;let _0x55527d={};if(_0x2ddaa3>0x0){const {packageId:_0x497a36}=_0x3b7a18;if(!_0x497a36)throw new common_1[(_0x3509fe(0x23f))](_0x3509fe(0x1a5),common_1[_0x3509fe(0x202)][_0x3509fe(0x24f)]);const _0x42eb89=await this[_0x3509fe(0x1b2)][_0x3509fe(0x216)]({'where':{'id':_0x497a36}});if(!_0x42eb89)throw new common_1[(_0x3509fe(0x23f))](_0x3509fe(0x196),common_1[_0x3509fe(0x202)][_0x3509fe(0x24f)]);const {weight:_0x72cc2a}=_0x42eb89;if(!_0x2bbaf4[_0x3509fe(0x1e4)])_0x55527d={'memberModel3Count':_0x590b87+_0x3b7a18[_0x3509fe(0x24d)],'memberModel4Count':_0x3d706b+_0x3b7a18[_0x3509fe(0x1c8)],'memberDrawMjCount':_0x37ea0e+_0x3b7a18[_0x3509fe(0x1b9)],'expirationTime':(0x0,date_1[_0x3509fe(0x1d6)])()['add'](_0x2ddaa3>0x0?_0x2ddaa3:0x0,_0x3509fe(0x20e))['format'](_0x3509fe(0x247)),'packageId':_0x497a36};else{const _0xadea1a=await this[_0x3509fe(0x1b2)][_0x3509fe(0x216)]({'where':{'id':_0x2bbaf4[_0x3509fe(0x1e4)]}});_0x72cc2a>=_0xadea1a[_0x3509fe(0x1bf)]&&(_0x55527d={'memberModel3Count':_0x5a2a90+_0x3b7a18['model3Count'],'memberModel4Count':_0x67b767+_0x3b7a18[_0x3509fe(0x1c8)],'memberDrawMjCount':_0x4b9ab7+_0x3b7a18[_0x3509fe(0x1b9)],'expirationTime':(0x0,date_1['default'])(_0x2bbaf4[_0x3509fe(0x203)])[_0x3509fe(0x1ed)](_0x2ddaa3>0x0?_0x2ddaa3:0x0,_0x3509fe(0x20e))[_0x3509fe(0x1c9)](_0x3509fe(0x247)),'packageId':_0x497a36}),_0x72cc2a<_0xadea1a[_0x3509fe(0x1bf)]&&(_0x55527d={'memberModel3Count':_0x5a2a90+_0x3b7a18[_0x3509fe(0x24d)],'memberModel4Count':_0x67b767+_0x3b7a18['model4Count'],'memberDrawMjCount':_0x4b9ab7+_0x3b7a18['drawMjCount']});}}_0x2ddaa3<=0x0&&(_0x55527d={'model3Count':_0x590b87+_0x3b7a18[_0x3509fe(0x24d)],'model4Count':_0x3d706b+_0x3b7a18['model4Count'],'drawMjCount':_0x37ea0e+_0x3b7a18['drawMjCount']});const _0x10a118=await this[_0x3509fe(0x23c)][_0x3509fe(0x1c0)]({'userId':_0xae9d29},_0x55527d);if(_0x10a118[_0x3509fe(0x222)]===0x0)throw new common_1['HttpException'](_0xae9d29+'充值失败',common_1['HttpStatus'][_0x3509fe(0x24f)]);}catch(_0xe85c13){console[_0x3509fe(0x230)](_0x3509fe(0x21d),_0xe85c13);throw new common_1[(_0x3509fe(0x23f))](_0x3509fe(0x22a),common_1['HttpStatus'][_0x3509fe(0x24f)]);}}async['addBalanceToOrder'](_0x4d30e9){const _0x264a25=_0x2508d1;console['log']('充值的工单信息:',_0x4d30e9);try{const {userId:_0xf5aac8,goodsId:_0x3632c5}=_0x4d30e9,_0x2fb7f0=await this['cramiPackageEntity'][_0x264a25(0x216)]({'where':{'id':_0x4d30e9[_0x264a25(0x1ec)],'status':0x1}});if(!_0x2fb7f0)throw new common_1['HttpException'](_0x264a25(0x18f),common_1[_0x264a25(0x202)][_0x264a25(0x24f)]);const {model3Count:_0x540ae3,model4Count:_0x2656b1,drawMjCount:_0x2da589,days:_0x3bb7ad,name:_0xe3497b}=_0x2fb7f0,_0x3c0349={'model3Count':_0x540ae3,'model4Count':_0x2656b1,'drawMjCount':_0x2da589,'days':_0x3bb7ad,'packageId':_0x4d30e9[_0x264a25(0x1ec)]};await this[_0x264a25(0x1dc)](_0xf5aac8,_0x3c0349,_0x3bb7ad),await this[_0x264a25(0x1cf)]({'userId':_0xf5aac8,'rechargeType':balance_constant_1['RechargeType'][_0x264a25(0x1de)],'model3Count':_0x540ae3,'model4Count':_0x2656b1,'drawMjCount':_0x2da589,'pkgName':_0xe3497b,'days':_0x3bb7ad});const _0x4a10ff=await this['userEntity'][_0x264a25(0x216)]({'where':{'id':_0xf5aac8}}),{invitedBy:_0x2cbbdc}=_0x4a10ff;if(_0x2cbbdc){const _0xc0e585=await this[_0x264a25(0x1fa)][_0x264a25(0x216)]({'where':{'inviteCode':_0x2cbbdc}}),_0x199d49=await this[_0x264a25(0x204)][_0x264a25(0x216)]({'where':{'userId':_0xc0e585['id']}});if(!_0xc0e585)return;const {id:_0xfdc6fc}=_0xc0e585,{performanceRatio:_0xd5ae7f}=_0x199d49,_0x3f76f2={'inviterUserId':_0xfdc6fc,'inviteeUserId':_0xf5aac8,'orderId':_0x4d30e9['id'],'orderPrice':_0x4d30e9['total'],'commissionPercentage':_0xd5ae7f,'commissionAmount':(_0x4d30e9[_0x264a25(0x1b4)]*_0xd5ae7f/0x64)[_0x264a25(0x1a1)](0x2)};await this[_0x264a25(0x1ce)][_0x264a25(0x21f)](_0x3f76f2),await this[_0x264a25(0x1ce)][_0x264a25(0x1f9)](_0xfdc6fc,_0x3f76f2[_0x264a25(0x246)]);}}catch(_0x1d99d3){console['log'](_0x264a25(0x21d),_0x1d99d3);throw new common_1['HttpException'](_0x264a25(0x1ef),common_1[_0x264a25(0x202)][_0x264a25(0x24f)]);}}async[_0x2508d1(0x20c)](_0x231b5c,_0x28119c){const _0x47b8b7=_0x2508d1,{page:page=0x1,size:size=0x14}=_0x28119c,{id:_0x4df2a6}=_0x231b5c[_0x47b8b7(0x1df)],[_0x531556,_0x2ea1c9]=await this[_0x47b8b7(0x220)][_0x47b8b7(0x194)]({'where':{'userId':_0x4df2a6},'order':{'id':_0x47b8b7(0x1d2)},'skip':(page-0x1)*size,'take':size});return _0x531556[_0x47b8b7(0x1b1)](_0x17c797=>{const _0x51f8a1=_0x47b8b7;_0x17c797[_0x51f8a1(0x1e9)]=_0x17c797[_0x51f8a1(0x1a3)]>0x0?_0x17c797['days']+'天':'永久';}),{'rows':(0x0,date_1[_0x47b8b7(0x210)])(_0x531556),'count':_0x2ea1c9};}async['getAccountLog'](_0x1c8ed3,_0x5aa61c){const _0x4da39d=_0x2508d1;try{const {page:page=0x1,size:size=0xa,userId:_0x422073,rechargeType:_0x20c89b,packageId:_0x255f29}=_0x5aa61c,{role:_0x2eb787}=_0x1c8ed3[_0x4da39d(0x1df)],_0x244b27={};_0x20c89b&&(_0x244b27[_0x4da39d(0x231)]=_0x20c89b),_0x244b27['userId']=_0x422073||(0x0,typeorm_2['LessThan'])(0x186a0),_0x255f29&&(_0x244b27['packageId']={'$like':'%'+_0x255f29+'%'});const [_0x354433,_0x1eba08]=await this['accountLogEntity'][_0x4da39d(0x194)]({'where':_0x244b27,'order':{'id':_0x4da39d(0x1d2)},'skip':(page-0x1)*size,'take':size}),_0x5a93a3=_0x354433[_0x4da39d(0x1a6)](_0x294e36=>_0x294e36[_0x4da39d(0x1d8)]),_0x30368b=await this[_0x4da39d(0x1fa)][_0x4da39d(0x1aa)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5a93a3)}});return _0x354433[_0x4da39d(0x1b1)](_0x4abb6d=>{const _0x1c36d1=_0x4da39d,_0x284bcd=_0x30368b[_0x1c36d1(0x1aa)](_0xd93520=>_0xd93520['id']===_0x4abb6d['userId']);_0x4abb6d['username']=_0x284bcd===null||_0x284bcd===void 0x0?void 0x0:_0x284bcd[_0x1c36d1(0x1ae)],_0x4abb6d['email']=_0x284bcd===null||_0x284bcd===void 0x0?void 0x0:_0x284bcd[_0x1c36d1(0x22b)],_0x4abb6d[_0x1c36d1(0x1f2)]=_0x284bcd===null||_0x284bcd===void 0x0?void 0x0:_0x284bcd[_0x1c36d1(0x1f2)],_0x4abb6d[_0x1c36d1(0x248)]=_0x284bcd===null||_0x284bcd===void 0x0?void 0x0:_0x284bcd['status'],_0x4abb6d['avatar']=_0x284bcd===null||_0x284bcd===void 0x0?void 0x0:_0x284bcd[_0x1c36d1(0x244)];}),_0x2eb787!==_0x4da39d(0x1dd)&&_0x354433['forEach'](_0x34989d=>{const _0x3c3d5c=_0x4da39d;_0x34989d[_0x3c3d5c(0x22b)]=_0x34989d[_0x3c3d5c(0x22b)]?(0x0,utils_1[_0x3c3d5c(0x1cc)])(_0x34989d[_0x3c3d5c(0x22b)]):'',_0x34989d[_0x3c3d5c(0x1f2)]=_0x34989d[_0x3c3d5c(0x1f2)]?(0x0,utils_1[_0x3c3d5c(0x1cc)])(_0x34989d[_0x3c3d5c(0x1f2)]):'';}),{'rows':_0x354433,'count':_0x1eba08};}catch(_0x453e1b){console[_0x4da39d(0x230)](_0x4da39d(0x21d),_0x453e1b);throw new common_1[(_0x4da39d(0x23f))](_0x4da39d(0x229),common_1[_0x4da39d(0x202)][_0x4da39d(0x24f)]);}}async[_0x2508d1(0x215)](_0x4370ed){const _0x3944b1=_0x2508d1;return await this[_0x3944b1(0x23c)][_0x3944b1(0x1aa)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x4370ed)}});}async[_0x2508d1(0x213)](_0x58fe2b,_0x5239ba){}async[_0x2508d1(0x1f4)](){const _0x10d10f=_0x2508d1,_0x4d9700=await this[_0x10d10f(0x1fa)][_0x10d10f(0x1aa)]();if(!_0x4d9700[_0x10d10f(0x226)])return;const _0x2c5703=await this[_0x10d10f(0x250)][_0x10d10f(0x21c)]([_0x10d10f(0x1db)]);if(!_0x2c5703)await this[_0x10d10f(0x250)][_0x10d10f(0x242)]({'settings':[{'configKey':_0x10d10f(0x1db),'configVal':'1'}]});else throw new common_1[(_0x10d10f(0x23f))](_0x10d10f(0x1da),common_1[_0x10d10f(0x202)]['BAD_REQUEST']);_0x4d9700[_0x10d10f(0x1b1)](_0x5337ba=>{const _0x56139c=_0x10d10f,{id:_0x2f1259}=_0x5337ba;this['balanceEntity'][_0x56139c(0x216)]({'where':{'userId':_0x2f1259}})[_0x56139c(0x22e)](_0x1bddaa=>{const _0x14e298=_0x56139c;if(!_0x1bddaa)return;this[_0x14e298(0x1fe)](_0x2f1259,_0x1bddaa);});});}async[_0x2508d1(0x1fe)](_0x3fb64e,_0x3c132c){const _0x39b159=_0x2508d1,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x3c132c,_0x51023b=await this['whiteListEntity'][_0x39b159(0x216)]({'where':{'userId':_0x3fb64e}}),_0x4bdc6d={'userId':_0x3fb64e,'model3Count':Number(usesLeft),'model4Count':(_0x51023b===null||_0x51023b===void 0x0?void 0x0:_0x51023b['count'])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x51023b===null||_0x51023b===void 0x0?void 0x0:_0x51023b[_0x39b159(0x18c)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x918cc9=await this[_0x39b159(0x23c)][_0x39b159(0x216)]({'where':{'userId':_0x3fb64e}});_0x918cc9?common_1[_0x39b159(0x20f)][_0x39b159(0x1e0)]('用户'+_0x3fb64e+_0x39b159(0x23e),_0x39b159(0x20d)):this[_0x39b159(0x23c)][_0x39b159(0x249)](_0x4bdc6d)['then'](_0x4d9ca7=>{const _0x112136=_0x39b159;common_1[_0x112136(0x20f)][_0x112136(0x1e0)]('用户'+_0x3fb64e+_0x112136(0x23d),_0x112136(0x20d));})['catch'](_0x48c34f=>{const _0x113b4a=_0x39b159;console[_0x113b4a(0x230)](_0x113b4a(0x21d),_0x48c34f),common_1[_0x113b4a(0x20f)][_0x113b4a(0x1e0)]('用户'+_0x3fb64e+_0x113b4a(0x233),'BalanceService');});}async[_0x2508d1(0x19a)](_0x47941d){const _0x17d877=_0x2508d1,{fingerprint:_0x183203}=_0x47941d['headers'],{id:_0x58c6ce}=_0x47941d[_0x17d877(0x1df)];return await this[_0x17d877(0x19d)]['update']({'userId':Number(_0x183203)},{'userId':_0x58c6ce}),await this['chatGroupEntity'][_0x17d877(0x1c0)]({'userId':Number(_0x183203)},{'userId':_0x58c6ce}),await this[_0x17d877(0x239)][_0x17d877(0x1c0)]({'userId':Number(_0x183203)},{'userId':_0x58c6ce}),0x1;}async[_0x2508d1(0x205)](_0x5c85a4){const _0x5049b2=_0x2508d1,{fingerprint:_0x4f424b}=_0x5c85a4['headers'],_0x374e74=await this[_0x5049b2(0x19d)]['count']({'where':{'userId':_0x4f424b}}),_0x539704=await this[_0x5049b2(0x22c)][_0x5049b2(0x193)]({'where':{'userId':_0x4f424b}}),_0x52be6a=await this[_0x5049b2(0x239)][_0x5049b2(0x193)]({'where':{'userId':_0x4f424b}});return _0x374e74||_0x539704||_0x52be6a||0x0;}};UserBalanceService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x2508d1(0x219)])(balance_entity_1['BalanceEntity'])),__param(0x1,(0x0,typeorm_1[_0x2508d1(0x219)])(userBalance_entity_1[_0x2508d1(0x209)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1['AccountLogEntity'])),__param(0x3,(0x0,typeorm_1[_0x2508d1(0x219)])(cramiPackage_entity_1[_0x2508d1(0x1d5)])),__param(0x4,(0x0,typeorm_1[_0x2508d1(0x219)])(config_entity_1['ConfigEntity'])),__param(0x5,(0x0,typeorm_1[_0x2508d1(0x219)])(user_entity_1[_0x2508d1(0x207)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1[_0x2508d1(0x1a4)])),__param(0x7,(0x0,typeorm_1[_0x2508d1(0x219)])(whiteList_entity_1[_0x2508d1(0x1b5)])),__param(0x8,(0x0,typeorm_1[_0x2508d1(0x219)])(fingerprint_entity_1['FingerprintLogEntity'])),__param(0x9,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x2508d1(0x195)])),__param(0xa,(0x0,typeorm_1[_0x2508d1(0x219)])(chatLog_entity_1[_0x2508d1(0x21b)])),__param(0xb,(0x0,typeorm_1[_0x2508d1(0x219)])(midjourney_entity_1['MidjourneyEntity'])),__metadata(_0x2508d1(0x24e),[typeorm_2[_0x2508d1(0x1e2)],typeorm_2[_0x2508d1(0x1e2)],typeorm_2['Repository'],typeorm_2[_0x2508d1(0x1e2)],typeorm_2[_0x2508d1(0x1e2)],typeorm_2[_0x2508d1(0x1e2)],typeorm_2[_0x2508d1(0x1e2)],typeorm_2[_0x2508d1(0x1e2)],typeorm_2[_0x2508d1(0x1e2)],typeorm_2[_0x2508d1(0x1e2)],typeorm_2[_0x2508d1(0x1e2)],typeorm_2[_0x2508d1(0x1e2)],sales_service_1[_0x2508d1(0x1e3)],globalConfig_service_1[_0x2508d1(0x1b3)]])],UserBalanceService),exports[_0x2508d1(0x1ff)]=UserBalanceService;function _0x2987(){const _0x55adf1=['odel4','updatedAt','odel3','username','configVal','deductFromBalance','forEach','cramiPackageEntity','GlobalConfigService','total','WhiteListEntity','./balance.entity','defineProperty','inviteSendStatus','drawMjCount','firstRregisterSendModel4Count','96TceAju','createRandomUid','36yMKrAU','validateBalance','weight','update','../../common/constants/balance.constant','__metadata','__decorate','128lDJGWK','visitorModel4Num','useModel3Count','isInteger','model4Count','format','4239mtaCxE','../chatLog/chatLog.entity','hideString','RechargeType','salesService','saveRecordRechargeLog','187754ptXGPb','324590ZqxrWo','DESC','vxNumber','../sales/sales.service','CramiPackageEntity','default','75526RKnQyb','userId','消费余额失败！','您已经升级过了、请勿重复操作！','upgradeStatus','addBalanceToUser','super','SCAN_PAY','user','debug','查询当前用户余额失败！','Repository','SalesService','packageId','inviteGiveSendModel4Count','function','decorate','balanceEntity','expireDateCn','registerSendModel4Count','memberDrawMjCount','goodsId','add','configEntity','充值失败！','__esModule','../globalConfig/config.entity','phone','memberModel3Count','upgradeBalance','registerSendStatus','memberModel4Count','firstRregisterSendModel3Count','registerSendDrawMjCount','saveCommissionAmount','userEntity','queryUserBalance','firstRegisterSendRank','注册赠送失败,请联系管理员！','writeOldBalanceToNewTable','UserBalanceService','1091650ajazyq','sumDrawMjCount','HttpStatus','expirationTime','salesUsersEntity','getVisitorCount','useDrawMjToken','UserEntity','visitorModel3Num','UserBalanceEntity','model3','8299252xxdIhx','getRechargeLog','BalanceService','day','Logger','formatCreateOrUpdateDate','./../globalConfig/globalConfig.service','formatDate','refundMjBalance','reduce','queryUserBalanceByIds','findOne','firstRegisterSendStatus','fingerprintLogEntity','InjectRepository','./userBalance.entity','ChatLogEntity','getConfigs','error:\x20','typeorm','createSalesRecords','accountLogEntity','getMonth','affected','sumModel3Count','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','63UiAHrB','length','useModel3Token','12qVoUtq','查询用户账户失败！','用户充值失败！','email','chatGroupEntity','../sales/salesUsers.entity','then','mjDraw','log','rechargeType','inviteGiveSendDrawMjCount','旧账户信息迁移失败','@nestjs/typeorm','REG_GIFT','invitedGuestSendDrawMjCount','inviteGiveSendModel3Count','2096fllCKE','midjourneyEntity','whiteListEntity','validateVisitorBalance','userBalanceEntity','旧账户信息迁移成功','账户信息已经存在、迁移无效','HttpException','createBaseUserBalance','../../common/utils/date','setConfig','invitedGuestSendModel4Count','avatar','firstRregisterSendDrawMjCount','commissionAmount','YYYY-MM-DD\x20HH:mm:ss','status','save','model4','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','visitor','model3Count','design:paramtypes','BAD_REQUEST','globalConfigService','>\x20或购买专属套餐\x20！','查询用户账户信息失败！','YYYY-MM-DD','includes','useCount','registerSendModel3Count','PAYMENT_REQUIRED','非法操作、当前充值套餐暂不存在！','../midjourney/midjourney.entity','useModel4Count','invitedGuestSendModel3Count','count','findAndCount','ChatGroupEntity','当前套餐不存在！','../user/user.entity','getFullYear','visitorMJNum','inheritVisitorData','204CglxvF','INVITE_GIFT','chatLogEntity','metadata','useModel4Token','./accountLog.entity','toFixed','./fingerprint.entity','days','SalesUsersEntity','缺失当前套餐ID、充值失败！','map','当前用户无需创建账户信息！','MjCount','object','find'];_0x2987=function(){return _0x55adf1;};return _0x2987();}