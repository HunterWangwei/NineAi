'use strict';const _0x4d7304=_0x3937;(function(_0x4232e9,_0x20ec53){const _0x2cdcbd=_0x3937,_0x22a34b=_0x4232e9();while(!![]){try{const _0x581f80=parseInt(_0x2cdcbd(0xe8))/0x1+parseInt(_0x2cdcbd(0x187))/0x2+-parseInt(_0x2cdcbd(0x167))/0x3+parseInt(_0x2cdcbd(0x163))/0x4*(parseInt(_0x2cdcbd(0x101))/0x5)+-parseInt(_0x2cdcbd(0xfb))/0x6*(-parseInt(_0x2cdcbd(0x196))/0x7)+-parseInt(_0x2cdcbd(0x122))/0x8*(parseInt(_0x2cdcbd(0xfe))/0x9)+-parseInt(_0x2cdcbd(0x11c))/0xa*(-parseInt(_0x2cdcbd(0x18b))/0xb);if(_0x581f80===_0x20ec53)break;else _0x22a34b['push'](_0x22a34b['shift']());}catch(_0x295b88){_0x22a34b['push'](_0x22a34b['shift']());}}}(_0x34ff,0xacda3));function _0x3937(_0xc60c44,_0x23a328){const _0x34ff52=_0x34ff();return _0x3937=function(_0x393796,_0x60a263){_0x393796=_0x393796-0xe4;let _0x20036d=_0x34ff52[_0x393796];return _0x20036d;},_0x3937(_0xc60c44,_0x23a328);}var __decorate=this&&this[_0x4d7304(0x14d)]||function(_0xfbb099,_0xe0a2f3,_0x239a82,_0x3d4e60){const _0x4c1d62=_0x4d7304;var _0x12ee72=arguments[_0x4c1d62(0x158)],_0x57e0a5=_0x12ee72<0x3?_0xe0a2f3:_0x3d4e60===null?_0x3d4e60=Object[_0x4c1d62(0x123)](_0xe0a2f3,_0x239a82):_0x3d4e60,_0x3d8205;if(typeof Reflect==='object'&&typeof Reflect[_0x4c1d62(0x11a)]==='function')_0x57e0a5=Reflect[_0x4c1d62(0x11a)](_0xfbb099,_0xe0a2f3,_0x239a82,_0x3d4e60);else{for(var _0x2a4abb=_0xfbb099['length']-0x1;_0x2a4abb>=0x0;_0x2a4abb--)if(_0x3d8205=_0xfbb099[_0x2a4abb])_0x57e0a5=(_0x12ee72<0x3?_0x3d8205(_0x57e0a5):_0x12ee72>0x3?_0x3d8205(_0xe0a2f3,_0x239a82,_0x57e0a5):_0x3d8205(_0xe0a2f3,_0x239a82))||_0x57e0a5;}return _0x12ee72>0x3&&_0x57e0a5&&Object[_0x4c1d62(0x13f)](_0xe0a2f3,_0x239a82,_0x57e0a5),_0x57e0a5;},__metadata=this&&this[_0x4d7304(0x144)]||function(_0x4bac2f,_0x2e39de){const _0x223b0a=_0x4d7304;if(typeof Reflect===_0x223b0a(0x175)&&typeof Reflect['metadata']===_0x223b0a(0x181))return Reflect[_0x223b0a(0x142)](_0x4bac2f,_0x2e39de);},__param=this&&this[_0x4d7304(0x130)]||function(_0x3c4e9e,_0x1f6b13){return function(_0x9d35fc,_0x3bfe17){_0x1f6b13(_0x9d35fc,_0x3bfe17,_0x3c4e9e);};};Object['defineProperty'](exports,_0x4d7304(0x173),{'value':!![]}),exports[_0x4d7304(0x136)]=void 0x0;const globalConfig_service_1=require(_0x4d7304(0x15a)),typeorm_1=require(_0x4d7304(0x100)),balance_entity_1=require(_0x4d7304(0x154)),common_1=require('@nestjs/common'),typeorm_2=require(_0x4d7304(0x17e)),balance_constant_1=require(_0x4d7304(0xed)),accountLog_entity_1=require('./accountLog.entity'),utils_1=require('../../common/utils'),config_entity_1=require(_0x4d7304(0x156)),cramiPackage_entity_1=require(_0x4d7304(0x19a)),userBalance_entity_1=require(_0x4d7304(0x177)),date_1=require(_0x4d7304(0x14f)),user_entity_1=require(_0x4d7304(0x157)),salesUsers_entity_1=require(_0x4d7304(0x133)),sales_service_1=require(_0x4d7304(0x15b)),whiteList_entity_1=require(_0x4d7304(0x104)),fingerprint_entity_1=require(_0x4d7304(0x147)),chatLog_entity_1=require('../chatLog/chatLog.entity'),chatGroup_entity_1=require(_0x4d7304(0x168)),midjourney_entity_1=require(_0x4d7304(0x19d)),verification_constant_1=require('../../common/constants/verification.constant');function _0x34ff(){const _0x25b780=['addBalanceToOrder','firstRegisterSendRank','PAYMENT_REQUIRED','map','forEach','sumModel3Count','setConfig','packageId','MidjourneyEntity','super','debug','useDrawMjToken','getAccountLog','489618FNFPSg','REFER_GIFT','isUpdatedToday','981PQLQPw','inviteGiveSendModel4Count','@nestjs/typeorm','1479215IOHuhi','visitor','visitorModel4Num','../chatgpt/whiteList.entity','YYYY-MM-DD\x20HH:mm:ss','userId','rechargeType','firstRregisterSendDrawMjCount','ConfigEntity','midjourneyEntity','includes','model3Count','invitedGuestSendModel4Count','chatGroupEntity','cramiPackageEntity','avatar','BAD_REQUEST','email','refundMjBalance','balanceEntity','---','userBalanceEntity','UserEntity','add','expireDateCn','decorate','log:\x20','46430ukXUDt','InjectRepository','save','inviteGiveSendDrawMjCount','firstRregisterSendModel3Count','salesService','38984olfkfx','getOwnPropertyDescriptor','MjCount','BalanceEntity','userEntity','commissionAmount','odel3','firstRregisterSendModel4Count','configEntity','drawMjCount','log','visitorModel3Num','invitedGuestSendDrawMjCount','充值失败','__param','当前套餐不存在！','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','../sales/salesUsers.entity','find','chatLogEntity','UserBalanceService','model4','then','hideString','registerSendModel4Count','catch','goodsId','queryUserBalance','default','defineProperty','user','非法操作、当前充值套餐暂不存在！','metadata','whiteListEntity','__metadata','total','memberDrawMjCount','./fingerprint.entity','UserBalanceEntity','createRandomUid','registerSendModel3Count','inviteSendStatus','globalConfigService','__decorate','查询用户账户失败！','../../common/utils/date','days','useModel3Token','HttpException','validateVisitorBalance','./balance.entity','createBaseUserBalance','../globalConfig/config.entity','../user/user.entity','length','memberModel3Count','./../globalConfig/globalConfig.service','../sales/sales.service','mjDraw','count','getDate','LessThan','inheritVisitorData','updatedAt','reduce','4PRaNKe','status','update','BalanceService','1187295wnGrqk','../chatGroup/chatGroup.entity','accountLogEntity','saveCommissionAmount','phone','memberModel4Count','getFullYear','saveRecordRechargeLog','findOne','fingerprintLogEntity','writeOldBalanceToNewTable','upgradeBalance','__esModule','useModel3Count','object','SalesService','./userBalance.entity','当前用户不存在,记录充值日志异常','vxNumber','SalesUsersEntity','充值失败！','缺失当前套餐ID、充值失败！','HttpStatus','typeorm','validateBalance','drawFailRefund','function','useModel4Count','Logger','format','addBalanceToNewUser','getMonth','1791202uFcdKz','invitedGuestSendModel3Count','Repository','expirationTime','33QfqoIM','model4Count','RechargeType','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','useModel4Token','headers','ChatLogEntity','FingerprintLogEntity','model3','getVisitorCount','toFixed','35IqMBcE','salesUsersEntity','registerSendDrawMjCount','formatCreateOrUpdateDate','../crami/cramiPackage.entity','useCount','getRechargeLog','../midjourney/midjourney.entity','DESC','WhiteListEntity','GlobalConfigService','>\x20或购买专属套餐\x20！','YYYY-MM-DD','inviteGiveSendModel3Count','weight','ChatGroupEntity','缺失当前用户账户记录！','Injectable','configKey','error:\x20','upgradeStatus','addBalanceToUser','configVal','getConfigs','21537nkNPud','findAndCount','username','visitorMJNum','registerSendStatus','../../common/constants/balance.constant'];_0x34ff=function(){return _0x25b780;};return _0x34ff();}let UserBalanceService=class UserBalanceService{constructor(_0x51b0dc,_0x1edbba,_0x532479,_0x242374,_0x24fca1,_0x59eaf2,_0x41af48,_0x304646,_0x4e6112,_0x37f289,_0xf85c8f,_0x32afc4,_0x3bb8ac,_0x3e9ac8){const _0x539d9a=_0x4d7304;this[_0x539d9a(0x114)]=_0x51b0dc,this[_0x539d9a(0x116)]=_0x1edbba,this[_0x539d9a(0x169)]=_0x532479,this[_0x539d9a(0x10f)]=_0x242374,this[_0x539d9a(0x12a)]=_0x24fca1,this[_0x539d9a(0x126)]=_0x59eaf2,this[_0x539d9a(0x197)]=_0x41af48,this[_0x539d9a(0x143)]=_0x304646,this[_0x539d9a(0x170)]=_0x4e6112,this[_0x539d9a(0x10e)]=_0x37f289,this[_0x539d9a(0x135)]=_0xf85c8f,this[_0x539d9a(0x10a)]=_0x32afc4,this[_0x539d9a(0x121)]=_0x3bb8ac,this[_0x539d9a(0x14c)]=_0x3e9ac8;}async[_0x4d7304(0x185)](_0x1ef8e4,_0x520029){const _0x543f51=_0x4d7304;try{const _0x3b5d26=await this['configEntity'][_0x543f51(0x134)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x543f51(0xec),_0x543f51(0x14a),_0x543f51(0x13a),_0x543f51(0x198),'firstRegisterSendStatus',_0x543f51(0xef),'firstRregisterSendModel3Count',_0x543f51(0x129),'firstRregisterSendDrawMjCount',_0x543f51(0x14b),_0x543f51(0x1a3),_0x543f51(0xff),_0x543f51(0x11f),_0x543f51(0x188),'invitedGuestSendDrawMjCount',_0x543f51(0x10d)])}}),_0x340c9b=_0x3b5d26[_0x543f51(0x162)]((_0xfc3263,_0x38392d)=>{const _0x202823=_0x543f51,_0x21bd6b=Number(_0x38392d['configVal']),_0x14c7c7=Number['isInteger'](_0x21bd6b)&&_0x21bd6b>0x0?_0x21bd6b:0x0;return _0xfc3263[_0x38392d[_0x202823(0x1a8)]]=_0x14c7c7,_0xfc3263;},{});let _0x30fc2e=0x0,_0xa06edb=0x0,_0x490b02=0x0;_0x340c9b['registerSendStatus']===0x1&&(_0x30fc2e=_0x30fc2e+_0x340c9b[_0x543f51(0x14a)],_0xa06edb=_0xa06edb+_0x340c9b[_0x543f51(0x13a)],_0x490b02=_0x490b02+_0x340c9b['registerSendDrawMjCount']),_0x340c9b['registerSendStatus']===0x1&&_0x340c9b['firstRegisterSendStatus']===0x1&&_0x1ef8e4<=_0x340c9b[_0x543f51(0xef)]&&(_0x30fc2e=_0x30fc2e+_0x340c9b[_0x543f51(0x120)],_0xa06edb=_0xa06edb+_0x340c9b[_0x543f51(0x129)],_0x490b02=_0x490b02+_0x340c9b[_0x543f51(0x108)]),await this[_0x543f51(0x16e)]({'userId':_0x1ef8e4,'rechargeType':balance_constant_1[_0x543f51(0x18d)]['REG_GIFT'],'model3Count':_0x30fc2e,'drawMjCount':_0x490b02,'model4Count':_0xa06edb}),_0x520029&&(Number(_0x340c9b['inviteSendStatus'])===0x1&&(_0x30fc2e=_0x30fc2e+Number(_0x340c9b[_0x543f51(0x188)]),_0xa06edb=_0xa06edb+Number(_0x340c9b['invitedGuestSendModel4Count']),_0x490b02=_0x490b02+Number(_0x340c9b[_0x543f51(0x12e)]),await this[_0x543f51(0x16e)]({'userId':_0x1ef8e4,'rechargeType':balance_constant_1[_0x543f51(0x18d)]['INVITE_GIFT'],'model3Count':_0x340c9b[_0x543f51(0x188)],'model4Count':_0x340c9b[_0x543f51(0x10d)],'drawMjCount':_0x340c9b[_0x543f51(0x12e)]}),await this[_0x543f51(0xe5)](_0x520029,{'model3Count':_0x340c9b[_0x543f51(0x1a3)],'model4Count':_0x340c9b[_0x543f51(0xff)],'drawMjCount':_0x340c9b[_0x543f51(0x11f)]}),await this['saveRecordRechargeLog']({'userId':_0x520029,'rechargeType':balance_constant_1[_0x543f51(0x18d)][_0x543f51(0xfc)],'model3Count':_0x340c9b[_0x543f51(0x1a3)],'model4Count':_0x340c9b[_0x543f51(0xff)],'drawMjCount':_0x340c9b['inviteGiveSendDrawMjCount']}))),await this['userBalanceEntity'][_0x543f51(0x11e)]({'userId':_0x1ef8e4,'model3Count':_0x30fc2e,'model4Count':_0xa06edb,'drawMjCount':_0x490b02,'useTokens':0x0});}catch(_0x2c8d4f){console[_0x543f51(0x12c)](_0x543f51(0x1a9),_0x2c8d4f);throw new common_1[(_0x543f51(0x152))]('注册赠送失败,请联系管理员！',common_1[_0x543f51(0x17d)][_0x543f51(0x111)]);}}async[_0x4d7304(0x17f)](_0x46a4cd,_0x548117,_0x211f5f){const _0x22ce70=_0x4d7304,{id:_0x426825,role:_0x29c085}=_0x46a4cd[_0x22ce70(0x140)];let _0x3488f7=await this[_0x22ce70(0x116)][_0x22ce70(0x16f)]({'where':{'userId':_0x426825}});!_0x3488f7&&(_0x3488f7=await this[_0x22ce70(0x155)](_0x426825));if(_0x29c085===_0x22ce70(0x102))return this[_0x22ce70(0x153)](_0x46a4cd,_0x548117,_0x211f5f);const _0x429f78=await this[_0x22ce70(0x12a)][_0x22ce70(0x16f)]({'where':{'configKey':_0x22ce70(0x179)}}),_0x1b56ca=_0x429f78?_0x429f78[_0x22ce70(0xe6)]:_0x22ce70(0x115),_0x4fb9b6=(0x0,verification_constant_1['getMemberKeyMap'])(_0x548117),_0x2151b2=(0x0,verification_constant_1['getBaseKeyMap'])(_0x548117);if(_0x3488f7['packageId']&&_0x3488f7[_0x4fb9b6]<_0x211f5f){if(_0x3488f7[_0x2151b2]<_0x211f5f)throw new common_1[(_0x22ce70(0x152))](_0x22ce70(0x18e)+_0x1b56ca+_0x22ce70(0x1a1),common_1['HttpStatus']['PAYMENT_REQUIRED']);}if(!_0x3488f7['packageId']&&_0x3488f7[_0x2151b2]<_0x211f5f)throw new common_1[(_0x22ce70(0x152))](_0x22ce70(0x18e)+_0x1b56ca+_0x22ce70(0x1a1),common_1[_0x22ce70(0x17d)][_0x22ce70(0xf0)]);return _0x3488f7;}async[_0x4d7304(0x153)](_0x4ed60f,_0x5022fc,_0x6e4529){const _0x3dc94c=_0x4d7304,{id:_0x5d4dcb}=_0x4ed60f['user'],_0x2392fa=_0x5022fc===_0x3dc94c(0x193)?_0x3dc94c(0x10c):_0x5022fc===_0x3dc94c(0x137)?_0x3dc94c(0x18c):_0x5022fc===_0x3dc94c(0x15c)?'drawMjCount':null,_0x2df4db=new Date(),_0x3835da=await this[_0x3dc94c(0x170)][_0x3dc94c(0x16f)]({'where':{'fingerprint':_0x5d4dcb}}),{visitorModel3Num:_0x1b4a6c,visitorModel4Num:_0x4e1ed1,visitorMJNum:_0x283228}=await this[_0x3dc94c(0x14c)]['getConfigs']([_0x3dc94c(0x12d),_0x3dc94c(0x103),_0x3dc94c(0xeb)]),_0x329752={'model3Count':_0x1b4a6c?Number(_0x1b4a6c):0x0,'model4Count':_0x4e1ed1?Number(_0x4e1ed1):0x0,'drawMjCount':_0x283228?Number(_0x283228):0x0};if(_0x329752[_0x2392fa]===-0x1)return!![];console[_0x3dc94c(0x12c)](_0x3dc94c(0x11b),_0x3835da);if(!_0x3835da){const _0x33780f={'fingerprint':_0x5d4dcb,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x2321a4=_0x6e4529||0x1;_0x33780f[_0x2392fa]=_0x33780f[_0x2392fa]+_0x2321a4;if(_0x33780f[_0x2392fa]>_0x329752[_0x2392fa]||!_0x33780f[_0x2392fa])throw new common_1[(_0x3dc94c(0x152))](_0x3dc94c(0x132),common_1[_0x3dc94c(0x17d)][_0x3dc94c(0xf0)]);else return await this[_0x3dc94c(0x170)][_0x3dc94c(0x11e)](_0x33780f),!![];}else{const {model3Count:_0x286083,model4Count:_0x1b8e4c,drawMjCount:_0x56cdf8}=_0x3835da;let _0xba00b={'model3Count':_0x286083,'model4Count':_0x1b8e4c,'drawMjCount':_0x56cdf8};const _0x1354bb=Number(new Date(_0x3835da[_0x3dc94c(0x161)])),_0x27f8ae=this[_0x3dc94c(0xfd)](_0x1354bb),_0x1b1073=_0x6e4529||0x1;_0x27f8ae?_0xba00b[_0x2392fa]=_0xba00b[_0x2392fa]+_0x1b1073:(_0xba00b={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0xba00b[_0x2392fa]=_0xba00b[_0x2392fa]+_0x1b1073);if(_0xba00b[_0x2392fa]>_0x329752[_0x2392fa])throw new common_1['HttpException'](_0x3dc94c(0x132),common_1[_0x3dc94c(0x17d)][_0x3dc94c(0xf0)]);else return await this[_0x3dc94c(0x170)]['update']({'fingerprint':_0x5d4dcb},_0xba00b),!![];}}[_0x4d7304(0xfd)](_0xf33e40){const _0xceeadd=_0x4d7304,_0x16bfd2=new Date(),_0x2f9b8c=new Date(_0x16bfd2[_0xceeadd(0x16d)](),_0x16bfd2[_0xceeadd(0x186)](),_0x16bfd2[_0xceeadd(0x15e)]());return _0xf33e40>=_0x2f9b8c;}async['deductFromBalance'](_0x9fb504,_0x1623d6,_0x16eeb3,_0x258d3b=0x0){const _0x454f4f=_0x4d7304,_0x3f184b=await this['userBalanceEntity'][_0x454f4f(0x16f)]({'where':{'userId':_0x9fb504}});if(!_0x3f184b)throw new common_1[(_0x454f4f(0x152))](_0x454f4f(0x1a6),common_1[_0x454f4f(0x17d)]['BAD_REQUEST']);const _0x33a8a2=_0x1623d6===_0x454f4f(0x193)?_0x454f4f(0x159):_0x1623d6===_0x454f4f(0x137)?_0x454f4f(0x16c):_0x1623d6===_0x454f4f(0x15c)?_0x454f4f(0x146):null,_0x6e48a5=_0x1623d6===_0x454f4f(0x193)?_0x454f4f(0x10c):_0x1623d6===_0x454f4f(0x137)?'model4Count':_0x1623d6===_0x454f4f(0x15c)?_0x454f4f(0x12b):null,_0x29686f=_0x3f184b[_0x454f4f(0xf5)]&&_0x3f184b[_0x33a8a2]<_0x16eeb3?_0x6e48a5:_0x3f184b['packageId']?_0x33a8a2:_0x6e48a5;let _0x59fecc=null;_0x29686f[_0x454f4f(0x10b)](_0x454f4f(0x128))&&(_0x59fecc=_0x454f4f(0x151));_0x29686f[_0x454f4f(0x10b)]('odel4')&&(_0x59fecc='useModel4Token');_0x29686f['includes'](_0x454f4f(0x124))&&(_0x59fecc=_0x454f4f(0xf9));const _0x55124e={[_0x29686f]:_0x3f184b[_0x29686f]-_0x16eeb3<0x0?0x0:_0x3f184b[_0x29686f]-_0x16eeb3,[_0x59fecc]:_0x3f184b[_0x59fecc]+_0x258d3b};_0x59fecc===_0x454f4f(0x151)&&(_0x55124e[_0x454f4f(0x174)]=_0x3f184b[_0x454f4f(0x174)]+0x1),_0x59fecc===_0x454f4f(0x18f)&&(_0x55124e[_0x454f4f(0x182)]=_0x3f184b[_0x454f4f(0x182)]+0x1);const _0x27e7de=await this[_0x454f4f(0x116)][_0x454f4f(0x165)]({'userId':_0x9fb504},_0x55124e);if(_0x27e7de['affected']===0x0)throw new common_1[(_0x454f4f(0x152))]('消费余额失败！',common_1[_0x454f4f(0x17d)][_0x454f4f(0x111)]);}async[_0x4d7304(0x13d)](_0x41b07a){const _0x5636e4=_0x4d7304;try{const _0x2e92a2=await this[_0x5636e4(0x116)][_0x5636e4(0x16f)]({'where':{'userId':_0x41b07a},'select':[_0x5636e4(0xf5),_0x5636e4(0x10c),_0x5636e4(0x18c),_0x5636e4(0x12b),_0x5636e4(0x159),_0x5636e4(0x16c),_0x5636e4(0x146),_0x5636e4(0x174),_0x5636e4(0x182),_0x5636e4(0x151),_0x5636e4(0x18f),_0x5636e4(0xf9),_0x5636e4(0x18a)]});if(!_0x2e92a2){const _0x2d733b=await this[_0x5636e4(0x155)](_0x41b07a);if(_0x2d733b)return await this[_0x5636e4(0x13d)](_0x41b07a);else throw new common_1['HttpException']('查询当前用户余额失败！',common_1[_0x5636e4(0x17d)]['BAD_REQUEST']);}return _0x2e92a2[_0x5636e4(0xf3)]=_0x2e92a2[_0x5636e4(0xf5)]?_0x2e92a2[_0x5636e4(0x10c)]+_0x2e92a2['memberModel3Count']:_0x2e92a2['model3Count'],_0x2e92a2['sumModel4Count']=_0x2e92a2['packageId']?_0x2e92a2[_0x5636e4(0x18c)]+_0x2e92a2[_0x5636e4(0x16c)]:_0x2e92a2[_0x5636e4(0x18c)],_0x2e92a2['sumDrawMjCount']=_0x2e92a2[_0x5636e4(0xf5)]?_0x2e92a2['drawMjCount']+_0x2e92a2[_0x5636e4(0x146)]:_0x2e92a2[_0x5636e4(0x12b)],_0x2e92a2[_0x5636e4(0x18a)]=_0x2e92a2[_0x5636e4(0x18a)]?(0x0,date_1['formatDate'])(_0x2e92a2[_0x5636e4(0x18a)],_0x5636e4(0x1a2)):null,_0x2e92a2;}catch(_0x3e8104){console[_0x5636e4(0x12c)](_0x5636e4(0x1a9),_0x3e8104);}}async['saveRecordRechargeLog'](_0x3fa13a){const _0x3db176=_0x4d7304,{userId:_0xe127ff,rechargeType:_0x1da254,model3Count:_0x9d2dde,model4Count:_0x2c6c14,drawMjCount:_0x42a4ee,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x3fa13a;if(!_0xe127ff)throw new common_1[(_0x3db176(0x152))](_0x3db176(0x178),common_1[_0x3db176(0x17d)]['BAD_REQUEST']);const _0x1d062f=(0x0,utils_1[_0x3db176(0x149)])();return await this[_0x3db176(0x169)][_0x3db176(0x11e)]({'userId':_0xe127ff,'rechargeType':_0x1da254,'model3Count':_0x9d2dde,'model4Count':_0x2c6c14,'drawMjCount':_0x42a4ee,'days':days,'extent':extent,'uid':_0x1d062f,'pkgName':pkgName});}async[_0x4d7304(0x155)](_0x3d02e0,_0x205a92={}){const _0x559742=_0x4d7304,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x205a92,_0x150774=await this[_0x559742(0x116)][_0x559742(0x16f)]({'where':{'userId':_0x3d02e0}});if(_0x150774)throw new common_1[(_0x559742(0x152))]('当前用户无需创建账户信息！',common_1[_0x559742(0x17d)][_0x559742(0x111)]);return await this[_0x559742(0x116)][_0x559742(0x11e)]({'userId':_0x3d02e0,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x4d7304(0xe5)](_0x2894a2,_0x5cf7ce,_0xb002ba=-0x1){const _0x2bb571=_0x4d7304;try{const _0x33d16d=await this[_0x2bb571(0x116)]['findOne']({'where':{'userId':_0x2894a2}})||await this[_0x2bb571(0x155)](_0x2894a2);if(!_0x33d16d)throw new common_1[(_0x2bb571(0x152))]('查询用户账户信息失败！',common_1[_0x2bb571(0x17d)][_0x2bb571(0x111)]);const {model3Count:_0x41328b,model4Count:_0x32be07,drawMjCount:_0x86acc6,memberModel3Count:_0x4e5cdd,memberModel4Count:_0x67fe30,memberDrawMjCount:_0x1cf946}=_0x33d16d;let _0x174290={};if(_0xb002ba>0x0){const {packageId:_0x42228c}=_0x5cf7ce;if(!_0x42228c)throw new common_1[(_0x2bb571(0x152))](_0x2bb571(0x17c),common_1['HttpStatus'][_0x2bb571(0x111)]);const _0x290853=await this[_0x2bb571(0x10f)]['findOne']({'where':{'id':_0x42228c}});if(!_0x290853)throw new common_1[(_0x2bb571(0x152))](_0x2bb571(0x131),common_1[_0x2bb571(0x17d)][_0x2bb571(0x111)]);const {weight:_0x409945}=_0x290853;if(!_0x33d16d[_0x2bb571(0xf5)])_0x174290={'memberModel3Count':_0x41328b+_0x5cf7ce[_0x2bb571(0x10c)],'memberModel4Count':_0x32be07+_0x5cf7ce[_0x2bb571(0x18c)],'memberDrawMjCount':_0x86acc6+_0x5cf7ce['drawMjCount'],'expirationTime':(0x0,date_1[_0x2bb571(0x13e)])()['add'](_0xb002ba>0x0?_0xb002ba:0x0,'day')[_0x2bb571(0x184)](_0x2bb571(0x105)),'packageId':_0x42228c};else{const _0x7b8489=await this[_0x2bb571(0x10f)]['findOne']({'where':{'id':_0x33d16d[_0x2bb571(0xf5)]}});_0x409945>=_0x7b8489[_0x2bb571(0x1a4)]&&(_0x174290={'memberModel3Count':_0x4e5cdd+_0x5cf7ce[_0x2bb571(0x10c)],'memberModel4Count':_0x67fe30+_0x5cf7ce[_0x2bb571(0x18c)],'memberDrawMjCount':_0x1cf946+_0x5cf7ce[_0x2bb571(0x12b)],'expirationTime':(0x0,date_1[_0x2bb571(0x13e)])(_0x33d16d[_0x2bb571(0x18a)])[_0x2bb571(0x118)](_0xb002ba>0x0?_0xb002ba:0x0,'day')[_0x2bb571(0x184)](_0x2bb571(0x105)),'packageId':_0x42228c}),_0x409945<_0x7b8489['weight']&&(_0x174290={'memberModel3Count':_0x4e5cdd+_0x5cf7ce[_0x2bb571(0x10c)],'memberModel4Count':_0x67fe30+_0x5cf7ce[_0x2bb571(0x18c)],'memberDrawMjCount':_0x1cf946+_0x5cf7ce['drawMjCount']});}}_0xb002ba<=0x0&&(_0x174290={'model3Count':_0x41328b+_0x5cf7ce[_0x2bb571(0x10c)],'model4Count':_0x32be07+_0x5cf7ce[_0x2bb571(0x18c)],'drawMjCount':_0x86acc6+_0x5cf7ce[_0x2bb571(0x12b)]});const _0x297c44=await this[_0x2bb571(0x116)]['update']({'userId':_0x2894a2},_0x174290);if(_0x297c44['affected']===0x0)throw new common_1[(_0x2bb571(0x152))](_0x2894a2+_0x2bb571(0x12f),common_1[_0x2bb571(0x17d)][_0x2bb571(0x111)]);}catch(_0x3713e8){console[_0x2bb571(0x12c)](_0x2bb571(0x1a9),_0x3713e8);throw new common_1[(_0x2bb571(0x152))]('用户充值失败！',common_1[_0x2bb571(0x17d)][_0x2bb571(0x111)]);}}async[_0x4d7304(0xee)](_0x4b1b23){const _0xdf16dc=_0x4d7304;console[_0xdf16dc(0x12c)]('充值的工单信息:',_0x4b1b23);try{const {userId:_0x4f5557,goodsId:_0x76811d}=_0x4b1b23,_0x2dcd57=await this[_0xdf16dc(0x10f)][_0xdf16dc(0x16f)]({'where':{'id':_0x4b1b23[_0xdf16dc(0x13c)],'status':0x1}});if(!_0x2dcd57)throw new common_1['HttpException'](_0xdf16dc(0x141),common_1[_0xdf16dc(0x17d)][_0xdf16dc(0x111)]);const {model3Count:_0x5a3894,model4Count:_0x81b67b,drawMjCount:_0x1ccd02,days:_0x2d1954,name:_0x577cf9}=_0x2dcd57,_0x21700e={'model3Count':_0x5a3894,'model4Count':_0x81b67b,'drawMjCount':_0x1ccd02,'days':_0x2d1954,'packageId':_0x4b1b23[_0xdf16dc(0x13c)]};await this[_0xdf16dc(0xe5)](_0x4f5557,_0x21700e,_0x2d1954),await this['saveRecordRechargeLog']({'userId':_0x4f5557,'rechargeType':balance_constant_1[_0xdf16dc(0x18d)]['SCAN_PAY'],'model3Count':_0x5a3894,'model4Count':_0x81b67b,'drawMjCount':_0x1ccd02,'pkgName':_0x577cf9,'days':_0x2d1954});const _0x2d29f8=await this[_0xdf16dc(0x126)][_0xdf16dc(0x16f)]({'where':{'id':_0x4f5557}}),{invitedBy:_0x4a0ec8}=_0x2d29f8;if(_0x4a0ec8){const _0x4097bb=await this[_0xdf16dc(0x126)]['findOne']({'where':{'inviteCode':_0x4a0ec8}}),_0x523484=await this[_0xdf16dc(0x197)][_0xdf16dc(0x16f)]({'where':{'userId':_0x4097bb['id']}});if(!_0x4097bb)return;const {id:_0x28379c}=_0x4097bb,{performanceRatio:_0x2de6a7}=_0x523484,_0x34623d={'inviterUserId':_0x28379c,'inviteeUserId':_0x4f5557,'orderId':_0x4b1b23['id'],'orderPrice':_0x4b1b23[_0xdf16dc(0x145)],'commissionPercentage':_0x2de6a7,'commissionAmount':(_0x4b1b23[_0xdf16dc(0x145)]*_0x2de6a7/0x64)[_0xdf16dc(0x195)](0x2)};await this[_0xdf16dc(0x121)]['createSalesRecords'](_0x34623d),await this[_0xdf16dc(0x121)][_0xdf16dc(0x16a)](_0x28379c,_0x34623d[_0xdf16dc(0x127)]);}}catch(_0x411fea){console[_0xdf16dc(0x12c)](_0xdf16dc(0x1a9),_0x411fea);throw new common_1[(_0xdf16dc(0x152))](_0xdf16dc(0x17b),common_1['HttpStatus'][_0xdf16dc(0x111)]);}}async[_0x4d7304(0x19c)](_0x317870,_0x17fc4c){const _0xed9100=_0x4d7304,{page:page=0x1,size:size=0x14}=_0x17fc4c,{id:_0x4777b7}=_0x317870[_0xed9100(0x140)],[_0x531ef8,_0x27fddb]=await this[_0xed9100(0x169)][_0xed9100(0xe9)]({'where':{'userId':_0x4777b7},'order':{'id':_0xed9100(0x19e)},'skip':(page-0x1)*size,'take':size});return _0x531ef8[_0xed9100(0xf2)](_0x5bed53=>{const _0x46f4a9=_0xed9100;_0x5bed53[_0x46f4a9(0x119)]=_0x5bed53[_0x46f4a9(0x150)]>0x0?_0x5bed53[_0x46f4a9(0x150)]+'天':'永久';}),{'rows':(0x0,date_1[_0xed9100(0x199)])(_0x531ef8),'count':_0x27fddb};}async[_0x4d7304(0xfa)](_0x56e10d,_0x484529){const _0x5326cf=_0x4d7304;try{const {page:page=0x1,size:size=0xa,userId:_0x40069d,rechargeType:_0x1f67dd,packageId:_0x19ccfd}=_0x484529,{role:_0x575ffc}=_0x56e10d['user'],_0x97298b={};_0x1f67dd&&(_0x97298b[_0x5326cf(0x107)]=_0x1f67dd),_0x97298b[_0x5326cf(0x106)]=_0x40069d||(0x0,typeorm_2[_0x5326cf(0x15f)])(0x186a0),_0x19ccfd&&(_0x97298b[_0x5326cf(0xf5)]={'$like':'%'+_0x19ccfd+'%'});const [_0xa8c62c,_0x231fb7]=await this[_0x5326cf(0x169)][_0x5326cf(0xe9)]({'where':_0x97298b,'order':{'id':_0x5326cf(0x19e)},'skip':(page-0x1)*size,'take':size}),_0x382b35=_0xa8c62c[_0x5326cf(0xf1)](_0x5e94b0=>_0x5e94b0[_0x5326cf(0x106)]),_0x24325a=await this[_0x5326cf(0x126)][_0x5326cf(0x134)]({'where':{'id':(0x0,typeorm_2['In'])(_0x382b35)}});return _0xa8c62c['forEach'](_0x571975=>{const _0x5877d1=_0x5326cf,_0x1f9f77=_0x24325a[_0x5877d1(0x134)](_0x5ecf7b=>_0x5ecf7b['id']===_0x571975[_0x5877d1(0x106)]);_0x571975[_0x5877d1(0xea)]=_0x1f9f77===null||_0x1f9f77===void 0x0?void 0x0:_0x1f9f77[_0x5877d1(0xea)],_0x571975[_0x5877d1(0x112)]=_0x1f9f77===null||_0x1f9f77===void 0x0?void 0x0:_0x1f9f77[_0x5877d1(0x112)],_0x571975['phone']=_0x1f9f77===null||_0x1f9f77===void 0x0?void 0x0:_0x1f9f77[_0x5877d1(0x16b)],_0x571975[_0x5877d1(0x164)]=_0x1f9f77===null||_0x1f9f77===void 0x0?void 0x0:_0x1f9f77[_0x5877d1(0x164)],_0x571975[_0x5877d1(0x110)]=_0x1f9f77===null||_0x1f9f77===void 0x0?void 0x0:_0x1f9f77[_0x5877d1(0x110)];}),_0x575ffc!==_0x5326cf(0xf7)&&_0xa8c62c['forEach'](_0x381c8c=>{const _0x584ec6=_0x5326cf;_0x381c8c['email']=_0x381c8c['email']?(0x0,utils_1[_0x584ec6(0x139)])(_0x381c8c[_0x584ec6(0x112)]):'',_0x381c8c[_0x584ec6(0x16b)]=_0x381c8c[_0x584ec6(0x16b)]?(0x0,utils_1[_0x584ec6(0x139)])(_0x381c8c[_0x584ec6(0x16b)]):'';}),{'rows':_0xa8c62c,'count':_0x231fb7};}catch(_0x2328b4){console[_0x5326cf(0x12c)]('error:\x20',_0x2328b4);throw new common_1['HttpException'](_0x5326cf(0x14e),common_1[_0x5326cf(0x17d)][_0x5326cf(0x111)]);}}async['queryUserBalanceByIds'](_0x356523){const _0x2d6daa=_0x4d7304;return await this[_0x2d6daa(0x116)]['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x356523)}});}async[_0x4d7304(0x113)](_0x298374,_0x597ab5){}async[_0x4d7304(0x180)](_0x18cf2c,_0x222e1a){const _0xcbd1f5=_0x4d7304,_0x27a707=await this[_0xcbd1f5(0x116)]['findOne']({'where':{'userId':_0x18cf2c}});if(!_0x27a707)return;await this[_0xcbd1f5(0x16e)]({'userId':_0x18cf2c,'rechargeType':balance_constant_1[_0xcbd1f5(0x18d)]['DRAW_FAIL_REFUND'],'model3Count':0x0,'model4Count':0x0,'drawMjCount':_0x222e1a,'pkgName':'','days':0x0}),await this['userBalanceEntity']['update']({'userId':_0x18cf2c},{'drawMjCount':_0x27a707[_0xcbd1f5(0x12b)]+Number(_0x222e1a)});}async[_0x4d7304(0x172)](){const _0x54760b=_0x4d7304,_0x5d9aea=await this[_0x54760b(0x126)][_0x54760b(0x134)]();if(!_0x5d9aea[_0x54760b(0x158)])return;const _0xcdbbe=await this['globalConfigService'][_0x54760b(0xe7)]([_0x54760b(0xe4)]);if(!_0xcdbbe)await this['globalConfigService'][_0x54760b(0xf4)]({'settings':[{'configKey':_0x54760b(0xe4),'configVal':'1'}]});else throw new common_1[(_0x54760b(0x152))]('您已经升级过了、请勿重复操作！',common_1[_0x54760b(0x17d)][_0x54760b(0x111)]);_0x5d9aea[_0x54760b(0xf2)](_0x38049a=>{const _0x52c52d=_0x54760b,{id:_0x50212d}=_0x38049a;this[_0x52c52d(0x114)]['findOne']({'where':{'userId':_0x50212d}})[_0x52c52d(0x138)](_0x20304b=>{if(!_0x20304b)return;this['writeOldBalanceToNewTable'](_0x50212d,_0x20304b);});});}async[_0x4d7304(0x171)](_0x49daa2,_0x9530ca){const _0x378027=_0x4d7304,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x9530ca,_0xc79a64=await this[_0x378027(0x143)][_0x378027(0x16f)]({'where':{'userId':_0x49daa2}}),_0x38ce30={'userId':_0x49daa2,'model3Count':Number(usesLeft),'model4Count':(_0xc79a64===null||_0xc79a64===void 0x0?void 0x0:_0xc79a64[_0x378027(0x15d)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0xc79a64===null||_0xc79a64===void 0x0?void 0x0:_0xc79a64[_0x378027(0x19b)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x3b05b1=await this[_0x378027(0x116)][_0x378027(0x16f)]({'where':{'userId':_0x49daa2}});_0x3b05b1?common_1[_0x378027(0x183)]['debug']('用户'+_0x49daa2+'账户信息已经存在、迁移无效',_0x378027(0x166)):this[_0x378027(0x116)][_0x378027(0x11e)](_0x38ce30)['then'](_0x58b0fc=>{const _0x138538=_0x378027;common_1[_0x138538(0x183)][_0x138538(0xf8)]('用户'+_0x49daa2+'旧账户信息迁移成功',_0x138538(0x166));})[_0x378027(0x13b)](_0x566725=>{const _0x211bd7=_0x378027;console[_0x211bd7(0x12c)](_0x211bd7(0x1a9),_0x566725),common_1[_0x211bd7(0x183)][_0x211bd7(0xf8)]('用户'+_0x49daa2+'旧账户信息迁移失败',_0x211bd7(0x166));});}async[_0x4d7304(0x160)](_0x154a7c){const _0x201353=_0x4d7304,{fingerprint:_0x2eb48f}=_0x154a7c['headers'],{id:_0x3ec905}=_0x154a7c[_0x201353(0x140)];return await this[_0x201353(0x135)][_0x201353(0x165)]({'userId':Number(_0x2eb48f)},{'userId':_0x3ec905}),await this[_0x201353(0x10e)][_0x201353(0x165)]({'userId':Number(_0x2eb48f)},{'userId':_0x3ec905}),await this['midjourneyEntity'][_0x201353(0x165)]({'userId':Number(_0x2eb48f)},{'userId':_0x3ec905}),0x1;}async[_0x4d7304(0x194)](_0x12a83c){const _0x1183d8=_0x4d7304,{fingerprint:_0x371095}=_0x12a83c[_0x1183d8(0x190)],_0x7ce352=await this['chatLogEntity'][_0x1183d8(0x15d)]({'where':{'userId':_0x371095}}),_0x3e03e6=await this['chatGroupEntity'][_0x1183d8(0x15d)]({'where':{'userId':_0x371095}}),_0x228e8e=await this[_0x1183d8(0x10a)][_0x1183d8(0x15d)]({'where':{'userId':_0x371095}});return _0x7ce352||_0x3e03e6||_0x228e8e||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x4d7304(0x1a7)])(),__param(0x0,(0x0,typeorm_1[_0x4d7304(0x11d)])(balance_entity_1[_0x4d7304(0x125)])),__param(0x1,(0x0,typeorm_1[_0x4d7304(0x11d)])(userBalance_entity_1[_0x4d7304(0x148)])),__param(0x2,(0x0,typeorm_1[_0x4d7304(0x11d)])(accountLog_entity_1['AccountLogEntity'])),__param(0x3,(0x0,typeorm_1[_0x4d7304(0x11d)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x4,(0x0,typeorm_1[_0x4d7304(0x11d)])(config_entity_1[_0x4d7304(0x109)])),__param(0x5,(0x0,typeorm_1[_0x4d7304(0x11d)])(user_entity_1[_0x4d7304(0x117)])),__param(0x6,(0x0,typeorm_1[_0x4d7304(0x11d)])(salesUsers_entity_1[_0x4d7304(0x17a)])),__param(0x7,(0x0,typeorm_1[_0x4d7304(0x11d)])(whiteList_entity_1[_0x4d7304(0x19f)])),__param(0x8,(0x0,typeorm_1[_0x4d7304(0x11d)])(fingerprint_entity_1[_0x4d7304(0x192)])),__param(0x9,(0x0,typeorm_1[_0x4d7304(0x11d)])(chatGroup_entity_1[_0x4d7304(0x1a5)])),__param(0xa,(0x0,typeorm_1[_0x4d7304(0x11d)])(chatLog_entity_1[_0x4d7304(0x191)])),__param(0xb,(0x0,typeorm_1[_0x4d7304(0x11d)])(midjourney_entity_1[_0x4d7304(0xf6)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x4d7304(0x189)],typeorm_2['Repository'],typeorm_2[_0x4d7304(0x189)],typeorm_2[_0x4d7304(0x189)],typeorm_2['Repository'],typeorm_2[_0x4d7304(0x189)],typeorm_2[_0x4d7304(0x189)],typeorm_2[_0x4d7304(0x189)],typeorm_2[_0x4d7304(0x189)],typeorm_2[_0x4d7304(0x189)],typeorm_2[_0x4d7304(0x189)],sales_service_1[_0x4d7304(0x176)],globalConfig_service_1[_0x4d7304(0x1a0)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;