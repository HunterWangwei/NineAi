'use strict';const _0x3a81d9=_0x4e34;(function(_0x945367,_0x1e2f79){const _0x51d468=_0x4e34,_0x97c11f=_0x945367();while(!![]){try{const _0x2ff20a=parseInt(_0x51d468(0x123))/0x1*(-parseInt(_0x51d468(0x165))/0x2)+parseInt(_0x51d468(0x12d))/0x3*(parseInt(_0x51d468(0x129))/0x4)+parseInt(_0x51d468(0xda))/0x5+parseInt(_0x51d468(0x144))/0x6*(-parseInt(_0x51d468(0xf3))/0x7)+parseInt(_0x51d468(0x101))/0x8*(parseInt(_0x51d468(0x161))/0x9)+parseInt(_0x51d468(0xc6))/0xa+-parseInt(_0x51d468(0xcd))/0xb*(parseInt(_0x51d468(0x119))/0xc);if(_0x2ff20a===_0x1e2f79)break;else _0x97c11f['push'](_0x97c11f['shift']());}catch(_0x5b2ea9){_0x97c11f['push'](_0x97c11f['shift']());}}}(_0x1b5f,0xde32f));function _0x4e34(_0x580a83,_0x58d806){const _0x1b5f7c=_0x1b5f();return _0x4e34=function(_0x4e34d1,_0x441f3c){_0x4e34d1=_0x4e34d1-0xba;let _0x46013d=_0x1b5f7c[_0x4e34d1];return _0x46013d;},_0x4e34(_0x580a83,_0x58d806);}var __decorate=this&&this[_0x3a81d9(0x157)]||function(_0x391f12,_0x58dd19,_0x37cf8e,_0x2a2d52){const _0x32b6e6=_0x3a81d9;var _0x2a04aa=arguments[_0x32b6e6(0xd7)],_0x3a7133=_0x2a04aa<0x3?_0x58dd19:_0x2a2d52===null?_0x2a2d52=Object[_0x32b6e6(0x175)](_0x58dd19,_0x37cf8e):_0x2a2d52,_0xc7b756;if(typeof Reflect===_0x32b6e6(0x15f)&&typeof Reflect[_0x32b6e6(0x131)]===_0x32b6e6(0xdb))_0x3a7133=Reflect[_0x32b6e6(0x131)](_0x391f12,_0x58dd19,_0x37cf8e,_0x2a2d52);else{for(var _0x4b53a4=_0x391f12['length']-0x1;_0x4b53a4>=0x0;_0x4b53a4--)if(_0xc7b756=_0x391f12[_0x4b53a4])_0x3a7133=(_0x2a04aa<0x3?_0xc7b756(_0x3a7133):_0x2a04aa>0x3?_0xc7b756(_0x58dd19,_0x37cf8e,_0x3a7133):_0xc7b756(_0x58dd19,_0x37cf8e))||_0x3a7133;}return _0x2a04aa>0x3&&_0x3a7133&&Object[_0x32b6e6(0x158)](_0x58dd19,_0x37cf8e,_0x3a7133),_0x3a7133;},__metadata=this&&this[_0x3a81d9(0x154)]||function(_0x2114ad,_0x4b5867){const _0x248c41=_0x3a81d9;if(typeof Reflect===_0x248c41(0x15f)&&typeof Reflect[_0x248c41(0x179)]==='function')return Reflect[_0x248c41(0x179)](_0x2114ad,_0x4b5867);},__param=this&&this[_0x3a81d9(0xbb)]||function(_0x441bdd,_0x536d5e){return function(_0x18de55,_0x2b5f57){_0x536d5e(_0x18de55,_0x2b5f57,_0x441bdd);};};Object[_0x3a81d9(0x158)](exports,_0x3a81d9(0x142),{'value':!![]}),exports['UserBalanceService']=void 0x0;const globalConfig_service_1=require(_0x3a81d9(0xd6)),typeorm_1=require('@nestjs/typeorm'),balance_entity_1=require(_0x3a81d9(0x126)),common_1=require(_0x3a81d9(0x14d)),typeorm_2=require(_0x3a81d9(0x13b)),balance_constant_1=require(_0x3a81d9(0x120)),accountLog_entity_1=require(_0x3a81d9(0xe8)),utils_1=require('../../common/utils'),config_entity_1=require('../globalConfig/config.entity'),cramiPackage_entity_1=require(_0x3a81d9(0x11b)),userBalance_entity_1=require(_0x3a81d9(0xfe)),date_1=require(_0x3a81d9(0xd9)),user_entity_1=require(_0x3a81d9(0x15e)),salesUsers_entity_1=require(_0x3a81d9(0xfb)),sales_service_1=require(_0x3a81d9(0x13c)),whiteList_entity_1=require('../chatgpt/whiteList.entity'),fingerprint_entity_1=require(_0x3a81d9(0x11c)),chatLog_entity_1=require(_0x3a81d9(0xf7)),chatGroup_entity_1=require(_0x3a81d9(0x14c)),midjourney_entity_1=require(_0x3a81d9(0x104));let UserBalanceService=class UserBalanceService{constructor(_0x598952,_0x4a97c2,_0x568a19,_0x5a4a4d,_0x332bf4,_0x3511b8,_0x545a07,_0x363eae,_0x2ab096,_0x3c23c7,_0x534519,_0x2ec96a,_0x8099df,_0x47bf34){const _0xee3fd8=_0x3a81d9;this[_0xee3fd8(0x148)]=_0x598952,this['userBalanceEntity']=_0x4a97c2,this['accountLogEntity']=_0x568a19,this[_0xee3fd8(0x162)]=_0x5a4a4d,this[_0xee3fd8(0x152)]=_0x332bf4,this['userEntity']=_0x3511b8,this[_0xee3fd8(0xdf)]=_0x545a07,this[_0xee3fd8(0x16e)]=_0x363eae,this[_0xee3fd8(0x11e)]=_0x2ab096,this[_0xee3fd8(0xf8)]=_0x3c23c7,this[_0xee3fd8(0x174)]=_0x534519,this[_0xee3fd8(0x170)]=_0x2ec96a,this[_0xee3fd8(0xec)]=_0x8099df,this[_0xee3fd8(0xc3)]=_0x47bf34;}async[_0x3a81d9(0xce)](_0x1ea172,_0x32bb71){const _0x3acbb1=_0x3a81d9;try{const _0x4bd71f=await this[_0x3acbb1(0x152)][_0x3acbb1(0x12c)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x3acbb1(0x127),_0x3acbb1(0x106),_0x3acbb1(0x122),'registerSendDrawMjCount',_0x3acbb1(0x169),_0x3acbb1(0xbe),_0x3acbb1(0xf1),_0x3acbb1(0xea),_0x3acbb1(0x12b),_0x3acbb1(0x11f),_0x3acbb1(0xff),_0x3acbb1(0x10a),_0x3acbb1(0x156),'invitedGuestSendModel3Count',_0x3acbb1(0x110),_0x3acbb1(0xc8)])}}),_0x34ac90=_0x4bd71f['reduce']((_0x4a8fbc,_0xe569e2)=>{const _0x10a059=_0x3acbb1,_0x3b358c=Number(_0xe569e2[_0x10a059(0x168)]),_0x1e3ce1=Number[_0x10a059(0x133)](_0x3b358c)&&_0x3b358c>0x0?_0x3b358c:0x0;return _0x4a8fbc[_0xe569e2[_0x10a059(0x11d)]]=_0x1e3ce1,_0x4a8fbc;},{});let _0x545c5b=0x0,_0x2e63a8=0x0,_0x255667=0x0;_0x34ac90[_0x3acbb1(0x127)]===0x1&&(_0x545c5b=_0x545c5b+_0x34ac90[_0x3acbb1(0x106)],_0x2e63a8=_0x2e63a8+_0x34ac90[_0x3acbb1(0x122)],_0x255667=_0x255667+_0x34ac90['registerSendDrawMjCount']),_0x34ac90[_0x3acbb1(0x127)]===0x1&&_0x34ac90[_0x3acbb1(0x169)]===0x1&&_0x1ea172<=_0x34ac90[_0x3acbb1(0xbe)]&&(_0x545c5b=_0x545c5b+_0x34ac90[_0x3acbb1(0xf1)],_0x2e63a8=_0x2e63a8+_0x34ac90[_0x3acbb1(0xea)],_0x255667=_0x255667+_0x34ac90[_0x3acbb1(0x12b)]),await this[_0x3acbb1(0x107)]({'userId':_0x1ea172,'rechargeType':balance_constant_1[_0x3acbb1(0x155)][_0x3acbb1(0xd3)],'model3Count':_0x545c5b,'drawMjCount':_0x255667,'model4Count':_0x2e63a8}),_0x32bb71&&(Number(_0x34ac90[_0x3acbb1(0x11f)])===0x1&&(_0x545c5b=_0x545c5b+Number(_0x34ac90[_0x3acbb1(0x14a)]),_0x2e63a8=_0x2e63a8+Number(_0x34ac90[_0x3acbb1(0xc8)]),_0x255667=_0x255667+Number(_0x34ac90[_0x3acbb1(0x110)]),await this[_0x3acbb1(0x107)]({'userId':_0x1ea172,'rechargeType':balance_constant_1[_0x3acbb1(0x155)][_0x3acbb1(0x136)],'model3Count':_0x34ac90['invitedGuestSendModel3Count'],'model4Count':_0x34ac90[_0x3acbb1(0xc8)],'drawMjCount':_0x34ac90['invitedGuestSendDrawMjCount']}),await this[_0x3acbb1(0x16a)](_0x32bb71,{'model3Count':_0x34ac90[_0x3acbb1(0xff)],'model4Count':_0x34ac90['inviteGiveSendModel4Count'],'drawMjCount':_0x34ac90[_0x3acbb1(0x156)]}),await this['saveRecordRechargeLog']({'userId':_0x32bb71,'rechargeType':balance_constant_1[_0x3acbb1(0x155)][_0x3acbb1(0x10f)],'model3Count':_0x34ac90[_0x3acbb1(0xff)],'model4Count':_0x34ac90['inviteGiveSendModel4Count'],'drawMjCount':_0x34ac90[_0x3acbb1(0x156)]}))),await this[_0x3acbb1(0x105)][_0x3acbb1(0x164)]({'userId':_0x1ea172,'model3Count':_0x545c5b,'model4Count':_0x2e63a8,'drawMjCount':_0x255667,'useTokens':0x0});}catch(_0x14c429){console[_0x3acbb1(0x153)](_0x3acbb1(0x13d),_0x14c429);throw new common_1[(_0x3acbb1(0xc5))](_0x3acbb1(0x150),common_1[_0x3acbb1(0x111)][_0x3acbb1(0x108)]);}}async[_0x3a81d9(0xf0)](_0x8b84a6,_0x1f4f9a,_0x3aa171){const _0x5624ab=_0x3a81d9,{id:_0x306625,role:_0x4173d9}=_0x8b84a6[_0x5624ab(0xe5)];let _0x455a1d=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x306625}});!_0x455a1d&&(_0x455a1d=await this[_0x5624ab(0x166)](_0x306625));if(_0x4173d9==='visitor')return this['validateVisitorBalance'](_0x8b84a6,_0x1f4f9a,_0x3aa171);const _0x35af34=await this[_0x5624ab(0x152)][_0x5624ab(0xfa)]({'where':{'configKey':_0x5624ab(0x13a)}}),_0x5bff22=_0x35af34?_0x35af34['configVal']:_0x5624ab(0x163),_0x5a11dc=_0x1f4f9a===_0x5624ab(0x102)?'memberModel3Count':_0x1f4f9a===_0x5624ab(0x17e)?'memberModel4Count':_0x1f4f9a===_0x5624ab(0x172)?_0x5624ab(0xba):null,_0x3203a4=_0x1f4f9a===_0x5624ab(0x102)?_0x5624ab(0x109):_0x1f4f9a===_0x5624ab(0x17e)?_0x5624ab(0xed):_0x1f4f9a==='mjDraw'?_0x5624ab(0x130):null;if(_0x455a1d['packageId']&&_0x455a1d[_0x5a11dc]<_0x3aa171){if(_0x455a1d[_0x3203a4]<_0x3aa171)throw new common_1[(_0x5624ab(0xc5))](_0x5624ab(0x14b)+_0x5bff22+_0x5624ab(0x132),common_1[_0x5624ab(0x111)][_0x5624ab(0xd2)]);}if(!_0x455a1d[_0x5624ab(0x146)]&&_0x455a1d[_0x3203a4]<_0x3aa171)throw new common_1['HttpException']('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x5bff22+'>\x20或购买专属套餐\x20！',common_1['HttpStatus'][_0x5624ab(0xd2)]);return _0x455a1d;}async[_0x3a81d9(0x128)](_0x417c59,_0x326386,_0x29b66d){const _0x116c97=_0x3a81d9,{id:_0x489c52}=_0x417c59[_0x116c97(0xe5)],_0x5cbdf3=_0x326386==='model3'?_0x116c97(0x109):_0x326386===_0x116c97(0x17e)?_0x116c97(0xed):_0x326386===_0x116c97(0x172)?_0x116c97(0x130):null,_0x460fc8=new Date(),_0x65acff=await this[_0x116c97(0x11e)][_0x116c97(0xfa)]({'where':{'fingerprint':_0x489c52}}),{visitorModel3Num:_0x107b6e,visitorModel4Num:_0x59bfaa,visitorMJNum:_0x4e0fd2}=await this[_0x116c97(0xc3)][_0x116c97(0x114)](['visitorModel3Num','visitorModel4Num',_0x116c97(0xcf)]),_0x383334={'model3Count':_0x107b6e?Number(_0x107b6e):0x0,'model4Count':_0x59bfaa?Number(_0x59bfaa):0x0,'drawMjCount':_0x4e0fd2?Number(_0x4e0fd2):0x0};if(!_0x65acff){const _0x221cf6={'fingerprint':_0x489c52,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x221cf6[_0x5cbdf3]=_0x221cf6[_0x5cbdf3]+_0x29b66d;if(_0x221cf6[_0x5cbdf3]>_0x383334[_0x5cbdf3])throw new common_1[(_0x116c97(0xc5))](_0x116c97(0x15d),common_1[_0x116c97(0x111)][_0x116c97(0xd2)]);else return await this[_0x116c97(0x11e)]['save'](_0x221cf6),!![];}else{const {model3Count:_0x1f99ed,model4Count:_0x20c4e9,drawMjCount:_0x5d8846}=_0x65acff;let _0x187947={'model3Count':_0x1f99ed,'model4Count':_0x20c4e9,'drawMjCount':_0x5d8846};const _0x1f7182=Number(new Date(_0x65acff[_0x116c97(0x137)])),_0x383183=this[_0x116c97(0xe1)](_0x1f7182);_0x383183?_0x187947[_0x5cbdf3]=_0x187947[_0x5cbdf3]+_0x29b66d:(_0x187947={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x187947[_0x5cbdf3]=_0x187947[_0x5cbdf3]+_0x29b66d);if(_0x187947[_0x5cbdf3]>_0x383334[_0x5cbdf3])throw new common_1['HttpException'](_0x116c97(0x15d),common_1['HttpStatus']['PAYMENT_REQUIRED']);else return await this[_0x116c97(0x11e)]['update']({'fingerprint':_0x489c52},_0x187947),!![];}}[_0x3a81d9(0xe1)](_0x36a8b5){const _0x345e8e=_0x3a81d9,_0x309b32=new Date(),_0x10dd17=new Date(_0x309b32[_0x345e8e(0x138)](),_0x309b32[_0x345e8e(0x14f)](),_0x309b32[_0x345e8e(0xe9)]());return _0x36a8b5>=_0x10dd17;}async['deductFromBalance'](_0x22cbe1,_0x1b00ed,_0x5e07e9,_0x4a0f04=0x0){const _0x1d9362=_0x3a81d9,_0x477e86=await this['userBalanceEntity'][_0x1d9362(0xfa)]({'where':{'userId':_0x22cbe1}});if(!_0x477e86)throw new common_1[(_0x1d9362(0xc5))](_0x1d9362(0xd5),common_1[_0x1d9362(0x111)]['BAD_REQUEST']);const _0x4634f8=_0x1b00ed===_0x1d9362(0x102)?_0x1d9362(0xe3):_0x1b00ed===_0x1d9362(0x17e)?'memberModel4Count':_0x1b00ed===_0x1d9362(0x172)?_0x1d9362(0xba):null,_0x3992b3=_0x1b00ed===_0x1d9362(0x102)?_0x1d9362(0x109):_0x1b00ed==='model4'?_0x1d9362(0xed):_0x1b00ed===_0x1d9362(0x172)?'drawMjCount':null,_0x23fd3d=_0x477e86['packageId']&&_0x477e86[_0x4634f8]<_0x5e07e9?_0x3992b3:_0x477e86[_0x1d9362(0x146)]?_0x4634f8:_0x3992b3;let _0x1e555b=null;_0x23fd3d[_0x1d9362(0x10d)]('odel3')&&(_0x1e555b=_0x1d9362(0x176));_0x23fd3d[_0x1d9362(0x10d)](_0x1d9362(0xde))&&(_0x1e555b=_0x1d9362(0x183));_0x23fd3d['includes'](_0x1d9362(0x17f))&&(_0x1e555b=_0x1d9362(0x184));const _0x4aea41={[_0x23fd3d]:_0x477e86[_0x23fd3d]-_0x5e07e9<0x0?0x0:_0x477e86[_0x23fd3d]-_0x5e07e9,[_0x1e555b]:_0x477e86[_0x1e555b]+_0x4a0f04};_0x1e555b===_0x1d9362(0x176)&&(_0x4aea41['useModel3Count']=_0x477e86[_0x1d9362(0x135)]+0x1),_0x1e555b===_0x1d9362(0x183)&&(_0x4aea41['useModel4Count']=_0x477e86['useModel4Count']+0x1);const _0x481b2b=await this[_0x1d9362(0x105)][_0x1d9362(0x124)]({'userId':_0x22cbe1},_0x4aea41);if(_0x481b2b['affected']===0x0)throw new common_1['HttpException'](_0x1d9362(0x147),common_1[_0x1d9362(0x111)]['BAD_REQUEST']);}async[_0x3a81d9(0x117)](_0x2d209c){const _0x38eeb8=_0x3a81d9;try{const _0x2b0061=await this[_0x38eeb8(0x105)][_0x38eeb8(0xfa)]({'where':{'userId':_0x2d209c},'select':[_0x38eeb8(0x146),_0x38eeb8(0x109),_0x38eeb8(0xed),_0x38eeb8(0x130),_0x38eeb8(0xe3),_0x38eeb8(0x14e),_0x38eeb8(0xba),_0x38eeb8(0x135),_0x38eeb8(0x177),_0x38eeb8(0x176),'useModel4Token',_0x38eeb8(0x184),_0x38eeb8(0xc9)]});if(!_0x2b0061){const _0x1bac0a=await this[_0x38eeb8(0x166)](_0x2d209c);if(_0x1bac0a)return await this[_0x38eeb8(0x117)](_0x2d209c);else throw new common_1[(_0x38eeb8(0xc5))](_0x38eeb8(0xcb),common_1[_0x38eeb8(0x111)][_0x38eeb8(0x108)]);}return _0x2b0061['sumModel3Count']=_0x2b0061[_0x38eeb8(0x146)]?_0x2b0061[_0x38eeb8(0x109)]+_0x2b0061['memberModel3Count']:_0x2b0061[_0x38eeb8(0x109)],_0x2b0061['sumModel4Count']=_0x2b0061[_0x38eeb8(0x146)]?_0x2b0061['model4Count']+_0x2b0061[_0x38eeb8(0x14e)]:_0x2b0061[_0x38eeb8(0xed)],_0x2b0061[_0x38eeb8(0x173)]=_0x2b0061[_0x38eeb8(0x146)]?_0x2b0061[_0x38eeb8(0x130)]+_0x2b0061[_0x38eeb8(0xba)]:_0x2b0061['drawMjCount'],_0x2b0061[_0x38eeb8(0xc9)]=_0x2b0061['expirationTime']?(0x0,date_1[_0x38eeb8(0xe4)])(_0x2b0061[_0x38eeb8(0xc9)],_0x38eeb8(0xd4)):null,_0x2b0061;}catch(_0x538996){console['log']('error:\x20',_0x538996);}}async[_0x3a81d9(0x107)](_0x2f7bd4){const _0x11799f=_0x3a81d9,{userId:_0x58caeb,rechargeType:_0x511480,model3Count:_0x10b858,model4Count:_0x2695ad,drawMjCount:_0x54e781,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x2f7bd4;if(!_0x58caeb)throw new common_1[(_0x11799f(0xc5))](_0x11799f(0xd1),common_1['HttpStatus'][_0x11799f(0x108)]);const _0x3aafc8=(0x0,utils_1[_0x11799f(0x113)])();return await this[_0x11799f(0xbd)][_0x11799f(0x164)]({'userId':_0x58caeb,'rechargeType':_0x511480,'model3Count':_0x10b858,'model4Count':_0x2695ad,'drawMjCount':_0x54e781,'days':days,'extent':extent,'uid':_0x3aafc8,'pkgName':pkgName});}async['createBaseUserBalance'](_0x3aa92,_0x5c46f3={}){const _0x24748c=_0x3a81d9,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x5c46f3,_0x37dd25=await this[_0x24748c(0x105)][_0x24748c(0xfa)]({'where':{'userId':_0x3aa92}});if(_0x37dd25)throw new common_1[(_0x24748c(0xc5))](_0x24748c(0xbf),common_1['HttpStatus'][_0x24748c(0x108)]);return await this['userBalanceEntity'][_0x24748c(0x164)]({'userId':_0x3aa92,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x3a81d9(0x16a)](_0x1d6fd9,_0x8e52e5,_0x3617fd=-0x1){const _0x575c95=_0x3a81d9;try{const _0x5a34c4=await this[_0x575c95(0x105)][_0x575c95(0xfa)]({'where':{'userId':_0x1d6fd9}})||await this[_0x575c95(0x166)](_0x1d6fd9);if(!_0x5a34c4)throw new common_1['HttpException'](_0x575c95(0x10e),common_1[_0x575c95(0x111)][_0x575c95(0x108)]);const {model3Count:_0x342275,model4Count:_0x4935fb,drawMjCount:_0x3221c9,memberModel3Count:_0x436442,memberModel4Count:_0x6d74b5,memberDrawMjCount:_0x4e5685}=_0x5a34c4;let _0x21f8b6={};if(_0x3617fd>0x0){const {packageId:_0x3d3467}=_0x8e52e5;if(!_0x3d3467)throw new common_1[(_0x575c95(0xc5))](_0x575c95(0xc0),common_1[_0x575c95(0x111)]['BAD_REQUEST']);const _0x498d41=await this[_0x575c95(0x162)]['findOne']({'where':{'id':_0x3d3467}});if(!_0x498d41)throw new common_1[(_0x575c95(0xc5))](_0x575c95(0x15a),common_1[_0x575c95(0x111)][_0x575c95(0x108)]);const {weight:_0x4cbc48}=_0x498d41;if(!_0x5a34c4[_0x575c95(0x146)])_0x21f8b6={'memberModel3Count':_0x342275+_0x8e52e5[_0x575c95(0x109)],'memberModel4Count':_0x4935fb+_0x8e52e5['model4Count'],'memberDrawMjCount':_0x3221c9+_0x8e52e5['drawMjCount'],'expirationTime':(0x0,date_1[_0x575c95(0x159)])()[_0x575c95(0x10c)](_0x3617fd>0x0?_0x3617fd:0x0,'day')['format']('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x3d3467};else{const _0x444cdd=await this[_0x575c95(0x162)]['findOne']({'where':{'id':_0x5a34c4[_0x575c95(0x146)]}});_0x4cbc48>=_0x444cdd[_0x575c95(0xe7)]&&(_0x21f8b6={'memberModel3Count':_0x436442+_0x8e52e5[_0x575c95(0x109)],'memberModel4Count':_0x6d74b5+_0x8e52e5[_0x575c95(0xed)],'memberDrawMjCount':_0x4e5685+_0x8e52e5[_0x575c95(0x130)],'expirationTime':(0x0,date_1[_0x575c95(0x159)])(_0x5a34c4['expirationTime'])['add'](_0x3617fd>0x0?_0x3617fd:0x0,_0x575c95(0x149))[_0x575c95(0x17b)](_0x575c95(0x17c)),'packageId':_0x3d3467}),_0x4cbc48<_0x444cdd[_0x575c95(0xe7)]&&(_0x21f8b6={'memberModel3Count':_0x436442+_0x8e52e5[_0x575c95(0x109)],'memberModel4Count':_0x6d74b5+_0x8e52e5[_0x575c95(0xed)],'memberDrawMjCount':_0x4e5685+_0x8e52e5['drawMjCount']});}}_0x3617fd<=0x0&&(_0x21f8b6={'model3Count':_0x342275+_0x8e52e5[_0x575c95(0x109)],'model4Count':_0x4935fb+_0x8e52e5[_0x575c95(0xed)],'drawMjCount':_0x3221c9+_0x8e52e5[_0x575c95(0x130)]});const _0x131efd=await this['userBalanceEntity']['update']({'userId':_0x1d6fd9},_0x21f8b6);if(_0x131efd['affected']===0x0)throw new common_1[(_0x575c95(0xc5))](_0x1d6fd9+_0x575c95(0x17d),common_1[_0x575c95(0x111)]['BAD_REQUEST']);}catch(_0x532e7c){console[_0x575c95(0x153)](_0x575c95(0x13d),_0x532e7c);throw new common_1[(_0x575c95(0xc5))](_0x575c95(0x12a),common_1[_0x575c95(0x111)]['BAD_REQUEST']);}}async['addBalanceToOrder'](_0x4ad295){const _0x7f263a=_0x3a81d9;console[_0x7f263a(0x153)](_0x7f263a(0xf5),_0x4ad295);try{const {userId:_0x386705,goodsId:_0x5f24cd}=_0x4ad295,_0x5330af=await this[_0x7f263a(0x162)][_0x7f263a(0xfa)]({'where':{'id':_0x4ad295[_0x7f263a(0xd0)],'status':0x1}});if(!_0x5330af)throw new common_1[(_0x7f263a(0xc5))](_0x7f263a(0xef),common_1[_0x7f263a(0x111)]['BAD_REQUEST']);const {model3Count:_0x21235e,model4Count:_0x12fcb7,drawMjCount:_0x21fdc6,days:_0x476cb5,name:_0x130f44}=_0x5330af,_0x159611={'model3Count':_0x21235e,'model4Count':_0x12fcb7,'drawMjCount':_0x21fdc6,'days':_0x476cb5,'packageId':_0x4ad295[_0x7f263a(0xd0)]};await this[_0x7f263a(0x16a)](_0x386705,_0x159611,_0x476cb5),await this['saveRecordRechargeLog']({'userId':_0x386705,'rechargeType':balance_constant_1[_0x7f263a(0x155)][_0x7f263a(0xfd)],'model3Count':_0x21235e,'model4Count':_0x12fcb7,'drawMjCount':_0x21fdc6,'pkgName':_0x130f44,'days':_0x476cb5});const _0x4292e7=await this['userEntity'][_0x7f263a(0xfa)]({'where':{'id':_0x386705}}),{invitedBy:_0xe02921}=_0x4292e7;if(_0xe02921){const _0x5b7c3d=await this[_0x7f263a(0x121)]['findOne']({'where':{'inviteCode':_0xe02921}}),_0x38d09f=await this[_0x7f263a(0xdf)][_0x7f263a(0xfa)]({'where':{'userId':_0x5b7c3d['id']}});if(!_0x5b7c3d)return;const {id:_0x13484f}=_0x5b7c3d,{performanceRatio:_0x3aba70}=_0x38d09f,_0x5d28ea={'inviterUserId':_0x13484f,'inviteeUserId':_0x386705,'orderId':_0x4ad295['id'],'orderPrice':_0x4ad295[_0x7f263a(0x167)],'commissionPercentage':_0x3aba70,'commissionAmount':(_0x4ad295['total']*_0x3aba70/0x64)[_0x7f263a(0x118)](0x2)};await this['salesService'][_0x7f263a(0xcc)](_0x5d28ea),await this['salesService'][_0x7f263a(0x13f)](_0x13484f,_0x5d28ea[_0x7f263a(0x140)]);}}catch(_0x36a38c){console[_0x7f263a(0x153)](_0x7f263a(0x13d),_0x36a38c);throw new common_1[(_0x7f263a(0xc5))](_0x7f263a(0x143),common_1['HttpStatus'][_0x7f263a(0x108)]);}}async[_0x3a81d9(0x10b)](_0x460985,_0x366dda){const _0xc119bf=_0x3a81d9,{page:page=0x1,size:size=0x14}=_0x366dda,{id:_0x33d79c}=_0x460985[_0xc119bf(0xe5)],[_0x220413,_0x136ae3]=await this[_0xc119bf(0xbd)][_0xc119bf(0x112)]({'where':{'userId':_0x33d79c},'order':{'id':_0xc119bf(0x16f)},'skip':(page-0x1)*size,'take':size});return _0x220413[_0xc119bf(0x181)](_0x4e44f8=>{const _0x3e5dbd=_0xc119bf;_0x4e44f8[_0x3e5dbd(0x103)]=_0x4e44f8[_0x3e5dbd(0x115)]>0x0?_0x4e44f8[_0x3e5dbd(0x115)]+'天':'永久';}),{'rows':(0x0,date_1[_0xc119bf(0xbc)])(_0x220413),'count':_0x136ae3};}async[_0x3a81d9(0xca)](_0x301e4a,_0xe79233){const _0x160b49=_0x3a81d9;try{const {page:page=0x1,size:size=0xa,userId:_0x3ad942,rechargeType:_0x1c7c59,packageId:_0x3b0bb4}=_0xe79233,{role:_0x3521b2}=_0x301e4a[_0x160b49(0xe5)],_0x5530f5={};_0x1c7c59&&(_0x5530f5[_0x160b49(0xc7)]=_0x1c7c59),_0x5530f5[_0x160b49(0x15c)]=_0x3ad942||(0x0,typeorm_2[_0x160b49(0x16b)])(0x186a0),_0x3b0bb4&&(_0x5530f5[_0x160b49(0x146)]={'$like':'%'+_0x3b0bb4+'%'});const [_0x2c85d7,_0x574be5]=await this['accountLogEntity'][_0x160b49(0x112)]({'where':_0x5530f5,'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size}),_0x366e23=_0x2c85d7[_0x160b49(0x186)](_0x1eebac=>_0x1eebac[_0x160b49(0x15c)]),_0x131d4f=await this[_0x160b49(0x121)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x366e23)}});return _0x2c85d7[_0x160b49(0x181)](_0xa1c79b=>{const _0x3107c4=_0x160b49,_0x4598b9=_0x131d4f[_0x3107c4(0x12c)](_0x93ab0e=>_0x93ab0e['id']===_0xa1c79b['userId']);_0xa1c79b[_0x3107c4(0xe6)]=_0x4598b9===null||_0x4598b9===void 0x0?void 0x0:_0x4598b9['username'],_0xa1c79b[_0x3107c4(0xf4)]=_0x4598b9===null||_0x4598b9===void 0x0?void 0x0:_0x4598b9[_0x3107c4(0xf4)],_0xa1c79b[_0x3107c4(0xdc)]=_0x4598b9===null||_0x4598b9===void 0x0?void 0x0:_0x4598b9[_0x3107c4(0xdc)],_0xa1c79b[_0x3107c4(0x16c)]=_0x4598b9===null||_0x4598b9===void 0x0?void 0x0:_0x4598b9['status'],_0xa1c79b[_0x3107c4(0x180)]=_0x4598b9===null||_0x4598b9===void 0x0?void 0x0:_0x4598b9['avatar'];}),_0x3521b2!==_0x160b49(0x17a)&&_0x2c85d7[_0x160b49(0x181)](_0x171db5=>{const _0x13f008=_0x160b49;_0x171db5[_0x13f008(0xf4)]=_0x171db5[_0x13f008(0xf4)]?(0x0,utils_1[_0x13f008(0xdd)])(_0x171db5['email']):'',_0x171db5[_0x13f008(0xdc)]=_0x171db5['phone']?(0x0,utils_1[_0x13f008(0xdd)])(_0x171db5[_0x13f008(0xdc)]):'';}),{'rows':_0x2c85d7,'count':_0x574be5};}catch(_0x124c34){console[_0x160b49(0x153)]('error:\x20',_0x124c34);throw new common_1[(_0x160b49(0xc5))](_0x160b49(0x160),common_1[_0x160b49(0x111)]['BAD_REQUEST']);}}async[_0x3a81d9(0x15b)](_0x50e405){const _0x295312=_0x3a81d9;return await this['userBalanceEntity'][_0x295312(0x12c)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x50e405)}});}async[_0x3a81d9(0xc2)](_0x1aae81,_0x33144a){}async[_0x3a81d9(0x100)](){const _0x2efd4a=_0x3a81d9,_0x4adc3e=await this[_0x2efd4a(0x121)]['find']();if(!_0x4adc3e[_0x2efd4a(0xd7)])return;const _0x1a8bd7=await this[_0x2efd4a(0xc3)][_0x2efd4a(0x114)](['upgradeStatus']);if(!_0x1a8bd7)await this[_0x2efd4a(0xc3)][_0x2efd4a(0xe2)]({'settings':[{'configKey':_0x2efd4a(0x13e),'configVal':'1'}]});else throw new common_1[(_0x2efd4a(0xc5))]('您已经升级过了、请勿重复操作！',common_1['HttpStatus'][_0x2efd4a(0x108)]);_0x4adc3e[_0x2efd4a(0x181)](_0x154420=>{const _0x42bc76=_0x2efd4a,{id:_0x362b7b}=_0x154420;this[_0x42bc76(0x148)][_0x42bc76(0xfa)]({'where':{'userId':_0x362b7b}})['then'](_0xf9e7c4=>{const _0x2f061a=_0x42bc76;if(!_0xf9e7c4)return;this[_0x2f061a(0xd8)](_0x362b7b,_0xf9e7c4);});});}async[_0x3a81d9(0xd8)](_0x3479dc,_0x57fcc0){const _0x3406d9=_0x3a81d9,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x57fcc0,_0x162932=await this[_0x3406d9(0x16e)][_0x3406d9(0xfa)]({'where':{'userId':_0x3479dc}}),_0x51390d={'userId':_0x3479dc,'model3Count':Number(usesLeft),'model4Count':(_0x162932===null||_0x162932===void 0x0?void 0x0:_0x162932[_0x3406d9(0x151)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x162932===null||_0x162932===void 0x0?void 0x0:_0x162932[_0x3406d9(0x185)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x3149e2=await this[_0x3406d9(0x105)][_0x3406d9(0xfa)]({'where':{'userId':_0x3479dc}});_0x3149e2?common_1[_0x3406d9(0x116)][_0x3406d9(0x125)]('用户'+_0x3479dc+_0x3406d9(0xee),_0x3406d9(0xfc)):this[_0x3406d9(0x105)]['save'](_0x51390d)[_0x3406d9(0x12e)](_0x2f44af=>{const _0x14d9c1=_0x3406d9;common_1['Logger'][_0x14d9c1(0x125)]('用户'+_0x3479dc+_0x14d9c1(0x12f),_0x14d9c1(0xfc));})['catch'](_0x33fd85=>{const _0x1a360d=_0x3406d9;console[_0x1a360d(0x153)](_0x1a360d(0x13d),_0x33fd85),common_1[_0x1a360d(0x116)][_0x1a360d(0x125)]('用户'+_0x3479dc+_0x1a360d(0xc1),_0x1a360d(0xfc));});}async[_0x3a81d9(0x182)](_0x42a7fb){const _0x3d3802=_0x3a81d9,{fingerprint:_0x402f55}=_0x42a7fb[_0x3d3802(0xeb)],{id:_0x2b4331}=_0x42a7fb[_0x3d3802(0xe5)];return await this[_0x3d3802(0x174)][_0x3d3802(0x124)]({'userId':Number(_0x402f55)},{'userId':_0x2b4331}),await this['chatGroupEntity']['update']({'userId':Number(_0x402f55)},{'userId':_0x2b4331}),await this[_0x3d3802(0x170)]['update']({'userId':Number(_0x402f55)},{'userId':_0x2b4331}),0x1;}async['getVisitorCount'](_0x256ab3){const _0x4e3295=_0x3a81d9,{fingerprint:_0x14499f}=_0x256ab3[_0x4e3295(0xeb)],_0x2ea4ba=await this[_0x4e3295(0x174)][_0x4e3295(0x151)]({'where':{'userId':_0x14499f}}),_0x3f49ad=await this[_0x4e3295(0xf8)][_0x4e3295(0x151)]({'where':{'userId':_0x14499f}}),_0x2e8cd0=await this[_0x4e3295(0x170)][_0x4e3295(0x151)]({'where':{'userId':_0x14499f}});return _0x2ea4ba||_0x3f49ad||_0x2e8cd0||0x0;}};UserBalanceService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(balance_entity_1[_0x3a81d9(0xf2)])),__param(0x1,(0x0,typeorm_1[_0x3a81d9(0x134)])(userBalance_entity_1['UserBalanceEntity'])),__param(0x2,(0x0,typeorm_1[_0x3a81d9(0x134)])(accountLog_entity_1['AccountLogEntity'])),__param(0x3,(0x0,typeorm_1[_0x3a81d9(0x134)])(cramiPackage_entity_1[_0x3a81d9(0x11a)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1['ConfigEntity'])),__param(0x5,(0x0,typeorm_1[_0x3a81d9(0x134)])(user_entity_1[_0x3a81d9(0xc4)])),__param(0x6,(0x0,typeorm_1[_0x3a81d9(0x134)])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1[_0x3a81d9(0x145)])),__param(0x8,(0x0,typeorm_1[_0x3a81d9(0x134)])(fingerprint_entity_1[_0x3a81d9(0x139)])),__param(0x9,(0x0,typeorm_1[_0x3a81d9(0x134)])(chatGroup_entity_1['ChatGroupEntity'])),__param(0xa,(0x0,typeorm_1[_0x3a81d9(0x134)])(chatLog_entity_1[_0x3a81d9(0x16d)])),__param(0xb,(0x0,typeorm_1[_0x3a81d9(0x134)])(midjourney_entity_1[_0x3a81d9(0x141)])),__metadata(_0x3a81d9(0xe0),[typeorm_2['Repository'],typeorm_2[_0x3a81d9(0x178)],typeorm_2[_0x3a81d9(0x178)],typeorm_2['Repository'],typeorm_2[_0x3a81d9(0x178)],typeorm_2['Repository'],typeorm_2[_0x3a81d9(0x178)],typeorm_2[_0x3a81d9(0x178)],typeorm_2['Repository'],typeorm_2[_0x3a81d9(0x178)],typeorm_2[_0x3a81d9(0x178)],typeorm_2['Repository'],sales_service_1[_0x3a81d9(0xf6)],globalConfig_service_1[_0x3a81d9(0x171)]])],UserBalanceService),exports[_0x3a81d9(0xf9)]=UserBalanceService;function _0x1b5f(){const _0x4f0bb5=['createBaseUserBalance','total','configVal','firstRegisterSendStatus','addBalanceToUser','LessThan','status','ChatLogEntity','whiteListEntity','DESC','midjourneyEntity','GlobalConfigService','mjDraw','sumDrawMjCount','chatLogEntity','getOwnPropertyDescriptor','useModel3Token','useModel4Count','Repository','metadata','super','format','YYYY-MM-DD\x20HH:mm:ss','充值失败','model4','MjCount','avatar','forEach','inheritVisitorData','useModel4Token','useDrawMjToken','useCount','map','memberDrawMjCount','__param','formatCreateOrUpdateDate','accountLogEntity','firstRegisterSendRank','当前用户无需创建账户信息！','缺失当前套餐ID、充值失败！','旧账户信息迁移失败','refundMjBalance','globalConfigService','UserEntity','HttpException','12332960lxmZhQ','rechargeType','invitedGuestSendModel4Count','expirationTime','getAccountLog','查询当前用户余额失败！','createSalesRecords','5252192MmQOsA','addBalanceToNewUser','visitorMJNum','goodsId','当前用户不存在,记录充值日志异常','PAYMENT_REQUIRED','REG_GIFT','YYYY-MM-DD','缺失当前用户账户记录！','./../globalConfig/globalConfig.service','length','writeOldBalanceToNewTable','../../common/utils/date','4785130ZMlldn','function','phone','hideString','odel4','salesUsersEntity','design:paramtypes','isUpdatedToday','setConfig','memberModel3Count','formatDate','user','username','weight','./accountLog.entity','getDate','firstRregisterSendModel4Count','headers','salesService','model4Count','账户信息已经存在、迁移无效','非法操作、当前充值套餐暂不存在！','validateBalance','firstRregisterSendModel3Count','BalanceEntity','7YWQokG','email','充值的工单信息:','SalesService','../chatLog/chatLog.entity','chatGroupEntity','UserBalanceService','findOne','../sales/salesUsers.entity','BalanceService','SCAN_PAY','./userBalance.entity','inviteGiveSendModel3Count','upgradeBalance','7088288arhwna','model3','expireDateCn','../midjourney/midjourney.entity','userBalanceEntity','registerSendModel3Count','saveRecordRechargeLog','BAD_REQUEST','model3Count','inviteGiveSendModel4Count','getRechargeLog','add','includes','查询用户账户信息失败！','REFER_GIFT','invitedGuestSendDrawMjCount','HttpStatus','findAndCount','createRandomUid','getConfigs','days','Logger','queryUserBalance','toFixed','96klMiaj','CramiPackageEntity','../crami/cramiPackage.entity','./fingerprint.entity','configKey','fingerprintLogEntity','inviteSendStatus','../../common/constants/balance.constant','userEntity','registerSendModel4Count','2319gIJcJc','update','debug','./balance.entity','registerSendStatus','validateVisitorBalance','11116QGzoIz','用户充值失败！','firstRregisterSendDrawMjCount','find','1533sSJhDh','then','旧账户信息迁移成功','drawMjCount','decorate','>\x20或购买专属套餐\x20！','isInteger','InjectRepository','useModel3Count','INVITE_GIFT','updatedAt','getFullYear','FingerprintLogEntity','vxNumber','typeorm','../sales/sales.service','error:\x20','upgradeStatus','saveCommissionAmount','commissionAmount','MidjourneyEntity','__esModule','充值失败！','3901446uTQoEQ','WhiteListEntity','packageId','消费余额失败！','balanceEntity','day','invitedGuestSendModel3Count','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','../chatGroup/chatGroup.entity','@nestjs/common','memberModel4Count','getMonth','注册赠送失败,请联系管理员！','count','configEntity','log','__metadata','RechargeType','inviteGiveSendDrawMjCount','__decorate','defineProperty','default','当前套餐不存在！','queryUserBalanceByIds','userId','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','../user/user.entity','object','查询用户账户失败！','18qURCOL','cramiPackageEntity','---','save','2uRcKhu'];_0x1b5f=function(){return _0x4f0bb5;};return _0x1b5f();}