'use strict';const _0x1dbe62=_0x3756;(function(_0x5e4533,_0x475bbe){const _0xcd0f9d=_0x3756,_0x4bbb30=_0x5e4533();while(!![]){try{const _0x5e2268=parseInt(_0xcd0f9d(0x279))/0x1+-parseInt(_0xcd0f9d(0x1fe))/0x2+parseInt(_0xcd0f9d(0x1d0))/0x3*(-parseInt(_0xcd0f9d(0x234))/0x4)+parseInt(_0xcd0f9d(0x229))/0x5+-parseInt(_0xcd0f9d(0x1c9))/0x6+-parseInt(_0xcd0f9d(0x1de))/0x7+-parseInt(_0xcd0f9d(0x25c))/0x8*(-parseInt(_0xcd0f9d(0x235))/0x9);if(_0x5e2268===_0x475bbe)break;else _0x4bbb30['push'](_0x4bbb30['shift']());}catch(_0x132ca8){_0x4bbb30['push'](_0x4bbb30['shift']());}}}(_0x25ac,0x8fc45));function _0x25ac(){const _0x92e490=['BAD_REQUEST','memberDrawMjCount','firstRregisterSendDrawMjCount','getMemberKeyMap','vxNumber','userBalanceEntity','createRandomUid','memberModel3Count','find','inviteGiveSendDrawMjCount','format','userId','2920428phUEjz','YYYY-MM-DD\x20HH:mm:ss','default','BalanceService','@nestjs/typeorm','INVITE_GIFT','@nestjs/common','6jqwlkl','balanceEntity','map','includes','./balance.entity','__param','您已经升级过了、请勿重复操作！','账户信息已经存在、迁移无效','非法操作、当前充值套餐暂不存在！','useModel4Count','length','__esModule','查询当前用户余额失败！','当前套餐不存在！','6651169eCQFrg','visitor','sumModel4Count','REFER_GIFT','---','save','addBalanceToOrder','whiteListEntity','upgradeStatus','days','expirationTime','DRAW_FAIL_REFUND','../../common/utils/date','day','getConfigs','drawFailRefund','UserBalanceService','MjCount','../user/user.entity','globalConfigService','DESC','forEach','firstRegisterSendStatus','RechargeType','userEntity','writeOldBalanceToNewTable','../sales/sales.service','phone','useModel3Token','mjDraw','registerSendModel4Count','旧账户信息迁移成功','252072vXeqgy','useModel4Token','decorate','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','sumDrawMjCount','packageId','SalesUsersEntity','error:\x20','getRechargeLog','../chatGroup/chatGroup.entity','update','addBalanceToNewUser','旧账户信息迁移失败','isUpdatedToday','sumModel3Count','chatLogEntity','addBalanceToUser','InjectRepository','缺失当前套餐ID、充值失败！','PAYMENT_REQUIRED','invitedGuestSendModel3Count','visitorModel4Num','Logger','visitorMJNum','then','configEntity','super','BalanceEntity','expireDateCn','缺失当前用户账户记录！','midjourneyEntity','salesService','typeorm','odel3','updatedAt','>\x20或购买专属套餐\x20！','formatCreateOrUpdateDate','reduce','headers','model4Count','HttpStatus','design:paramtypes','getFullYear','399290jAgRmi','getMonth','fingerprintLogEntity','Repository','findOne','./userBalance.entity','inviteGiveSendModel3Count','firstRegisterSendRank','memberModel4Count','registerSendModel3Count','充值的工单信息:','562776dmGQEf','9pqLcsU','充值失败','useDrawMjToken','getDate','defineProperty','registerSendDrawMjCount','消费余额失败！','model3','deductFromBalance','useCount','validateVisitorBalance','isInteger','firstRregisterSendModel4Count','./../globalConfig/globalConfig.service','add','../sales/salesUsers.entity','total','model4','configVal','inviteSendStatus','getVisitorCount','./fingerprint.entity','getOwnPropertyDescriptor','goodsId','user','salesUsersEntity','object','getAccountLog','commissionAmount','count','GlobalConfigService','configKey','Injectable','status','function','username','saveCommissionAmount','findAndCount','REG_GIFT','18376640ZWChBk','inviteGiveSendModel4Count','affected','firstRregisterSendModel3Count','accountLogEntity','../chatgpt/whiteList.entity','MidjourneyEntity','weight','avatar','注册赠送失败,请联系管理员！','debug','../../common/constants/verification.constant','inheritVisitorData','useModel3Count','../midjourney/midjourney.entity','rechargeType','HttpException','invitedGuestSendDrawMjCount','__metadata','email','refundMjBalance','invitedGuestSendModel4Count','../../common/constants/balance.constant','toFixed','model3Count','registerSendStatus','./accountLog.entity','createBaseUserBalance','ConfigEntity','56260QytqSV','当前用户不存在,记录充值日志异常','cramiPackageEntity','log','UserEntity','hideString','drawMjCount','CramiPackageEntity','AccountLogEntity','catch','saveRecordRechargeLog','充值失败！'];_0x25ac=function(){return _0x92e490;};return _0x25ac();}var __decorate=this&&this['__decorate']||function(_0x5ea0cb,_0x4b40df,_0x5c5f8a,_0xf380cc){const _0x38b0c3=_0x3756;var _0x1b3d19=arguments[_0x38b0c3(0x1da)],_0x2203d5=_0x1b3d19<0x3?_0x4b40df:_0xf380cc===null?_0xf380cc=Object[_0x38b0c3(0x24b)](_0x4b40df,_0x5c5f8a):_0xf380cc,_0x4e5467;if(typeof Reflect==='object'&&typeof Reflect[_0x38b0c3(0x200)]==='function')_0x2203d5=Reflect[_0x38b0c3(0x200)](_0x5ea0cb,_0x4b40df,_0x5c5f8a,_0xf380cc);else{for(var _0x1993fe=_0x5ea0cb[_0x38b0c3(0x1da)]-0x1;_0x1993fe>=0x0;_0x1993fe--)if(_0x4e5467=_0x5ea0cb[_0x1993fe])_0x2203d5=(_0x1b3d19<0x3?_0x4e5467(_0x2203d5):_0x1b3d19>0x3?_0x4e5467(_0x4b40df,_0x5c5f8a,_0x2203d5):_0x4e5467(_0x4b40df,_0x5c5f8a))||_0x2203d5;}return _0x1b3d19>0x3&&_0x2203d5&&Object[_0x38b0c3(0x239)](_0x4b40df,_0x5c5f8a,_0x2203d5),_0x2203d5;},__metadata=this&&this[_0x1dbe62(0x26e)]||function(_0x5b567b,_0x447cff){const _0x49d162=_0x1dbe62;if(typeof Reflect===_0x49d162(0x24f)&&typeof Reflect['metadata']===_0x49d162(0x257))return Reflect['metadata'](_0x5b567b,_0x447cff);},__param=this&&this[_0x1dbe62(0x1d5)]||function(_0x5359f3,_0x2d8e68){return function(_0x10e5c1,_0x3e546c){_0x2d8e68(_0x10e5c1,_0x3e546c,_0x5359f3);};};Object[_0x1dbe62(0x239)](exports,_0x1dbe62(0x1db),{'value':!![]}),exports[_0x1dbe62(0x1ee)]=void 0x0;const globalConfig_service_1=require(_0x1dbe62(0x242)),typeorm_1=require(_0x1dbe62(0x1cd)),balance_entity_1=require(_0x1dbe62(0x1d4)),common_1=require(_0x1dbe62(0x1cf)),typeorm_2=require(_0x1dbe62(0x21e)),balance_constant_1=require(_0x1dbe62(0x272)),accountLog_entity_1=require(_0x1dbe62(0x276)),utils_1=require('../../common/utils'),config_entity_1=require('../globalConfig/config.entity'),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_entity_1=require(_0x1dbe62(0x22e)),date_1=require(_0x1dbe62(0x1ea)),user_entity_1=require(_0x1dbe62(0x1f0)),salesUsers_entity_1=require(_0x1dbe62(0x244)),sales_service_1=require(_0x1dbe62(0x1f8)),whiteList_entity_1=require(_0x1dbe62(0x261)),fingerprint_entity_1=require(_0x1dbe62(0x24a)),chatLog_entity_1=require('../chatLog/chatLog.entity'),chatGroup_entity_1=require(_0x1dbe62(0x207)),midjourney_entity_1=require(_0x1dbe62(0x26a)),verification_constant_1=require(_0x1dbe62(0x267));function _0x3756(_0x33067b,_0x19ef71){const _0x25ac93=_0x25ac();return _0x3756=function(_0x3756fc,_0x3d529f){_0x3756fc=_0x3756fc-0x1bd;let _0x1f882b=_0x25ac93[_0x3756fc];return _0x1f882b;},_0x3756(_0x33067b,_0x19ef71);}let UserBalanceService=class UserBalanceService{constructor(_0x44d88d,_0x4c6a5d,_0x456ec2,_0x4c7fa5,_0x163ca3,_0xfcf88b,_0x581618,_0x549d6f,_0x29214b,_0x5943ab,_0x2c140a,_0x54a2b3,_0x4dbb92,_0x55fa55){const _0x20a045=_0x1dbe62;this[_0x20a045(0x1d1)]=_0x44d88d,this['userBalanceEntity']=_0x4c6a5d,this[_0x20a045(0x260)]=_0x456ec2,this['cramiPackageEntity']=_0x4c7fa5,this[_0x20a045(0x217)]=_0x163ca3,this[_0x20a045(0x1f6)]=_0xfcf88b,this[_0x20a045(0x24e)]=_0x581618,this[_0x20a045(0x1e5)]=_0x549d6f,this[_0x20a045(0x22b)]=_0x29214b,this['chatGroupEntity']=_0x5943ab,this[_0x20a045(0x20d)]=_0x2c140a,this[_0x20a045(0x21c)]=_0x54a2b3,this[_0x20a045(0x21d)]=_0x4dbb92,this[_0x20a045(0x1f1)]=_0x55fa55;}async[_0x1dbe62(0x209)](_0x1a4504,_0x4f6f0b){const _0xa239d2=_0x1dbe62;try{const _0x5a2fe3=await this[_0xa239d2(0x217)][_0xa239d2(0x1c5)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0xa239d2(0x275),_0xa239d2(0x232),_0xa239d2(0x1fc),'registerSendDrawMjCount',_0xa239d2(0x1f4),_0xa239d2(0x230),_0xa239d2(0x25f),_0xa239d2(0x241),_0xa239d2(0x1bf),_0xa239d2(0x248),_0xa239d2(0x22f),'inviteGiveSendModel4Count','inviteGiveSendDrawMjCount',_0xa239d2(0x212),_0xa239d2(0x26d),_0xa239d2(0x271)])}}),_0x462268=_0x5a2fe3[_0xa239d2(0x223)]((_0x454a98,_0x4e2135)=>{const _0x512c88=_0xa239d2,_0x47c88d=Number(_0x4e2135[_0x512c88(0x247)]),_0x3076cb=Number[_0x512c88(0x240)](_0x47c88d)&&_0x47c88d>0x0?_0x47c88d:0x0;return _0x454a98[_0x4e2135[_0x512c88(0x254)]]=_0x3076cb,_0x454a98;},{});let _0x28e576=0x0,_0x1228f2=0x0,_0x2decf7=0x0;_0x462268[_0xa239d2(0x275)]===0x1&&(_0x28e576=_0x28e576+_0x462268['registerSendModel3Count'],_0x1228f2=_0x1228f2+_0x462268[_0xa239d2(0x1fc)],_0x2decf7=_0x2decf7+_0x462268[_0xa239d2(0x23a)]),_0x462268[_0xa239d2(0x275)]===0x1&&_0x462268[_0xa239d2(0x1f4)]===0x1&&_0x1a4504<=_0x462268[_0xa239d2(0x230)]&&(_0x28e576=_0x28e576+_0x462268[_0xa239d2(0x25f)],_0x1228f2=_0x1228f2+_0x462268[_0xa239d2(0x241)],_0x2decf7=_0x2decf7+_0x462268[_0xa239d2(0x1bf)]),await this[_0xa239d2(0x283)]({'userId':_0x1a4504,'rechargeType':balance_constant_1[_0xa239d2(0x1f5)][_0xa239d2(0x25b)],'model3Count':_0x28e576,'drawMjCount':_0x2decf7,'model4Count':_0x1228f2}),_0x4f6f0b&&(Number(_0x462268[_0xa239d2(0x248)])===0x1&&(_0x28e576=_0x28e576+Number(_0x462268[_0xa239d2(0x212)]),_0x1228f2=_0x1228f2+Number(_0x462268[_0xa239d2(0x271)]),_0x2decf7=_0x2decf7+Number(_0x462268['invitedGuestSendDrawMjCount']),await this[_0xa239d2(0x283)]({'userId':_0x1a4504,'rechargeType':balance_constant_1['RechargeType'][_0xa239d2(0x1ce)],'model3Count':_0x462268[_0xa239d2(0x212)],'model4Count':_0x462268['invitedGuestSendModel4Count'],'drawMjCount':_0x462268[_0xa239d2(0x26d)]}),await this[_0xa239d2(0x20e)](_0x4f6f0b,{'model3Count':_0x462268[_0xa239d2(0x22f)],'model4Count':_0x462268[_0xa239d2(0x25d)],'drawMjCount':_0x462268[_0xa239d2(0x1c6)]}),await this['saveRecordRechargeLog']({'userId':_0x4f6f0b,'rechargeType':balance_constant_1[_0xa239d2(0x1f5)][_0xa239d2(0x1e1)],'model3Count':_0x462268['inviteGiveSendModel3Count'],'model4Count':_0x462268[_0xa239d2(0x25d)],'drawMjCount':_0x462268[_0xa239d2(0x1c6)]}))),await this[_0xa239d2(0x1c2)][_0xa239d2(0x1e3)]({'userId':_0x1a4504,'model3Count':_0x28e576,'model4Count':_0x1228f2,'drawMjCount':_0x2decf7,'useTokens':0x0});}catch(_0x5626fa){console[_0xa239d2(0x27c)](_0xa239d2(0x205),_0x5626fa);throw new common_1[(_0xa239d2(0x26c))](_0xa239d2(0x265),common_1[_0xa239d2(0x226)]['BAD_REQUEST']);}}async['validateBalance'](_0x4cd8d0,_0x22cb40,_0x156422){const _0x569bdb=_0x1dbe62,{id:_0xefb95,role:_0x482158}=_0x4cd8d0['user'];let _0x3de543=await this[_0x569bdb(0x1c2)][_0x569bdb(0x22d)]({'where':{'userId':_0xefb95}});!_0x3de543&&(_0x3de543=await this[_0x569bdb(0x277)](_0xefb95));if(_0x482158===_0x569bdb(0x1df))return this[_0x569bdb(0x23f)](_0x4cd8d0,_0x22cb40,_0x156422);const _0x36d7a1=await this[_0x569bdb(0x217)][_0x569bdb(0x22d)]({'where':{'configKey':_0x569bdb(0x1c1)}}),_0x4a678b=_0x36d7a1?_0x36d7a1[_0x569bdb(0x247)]:_0x569bdb(0x1e2),_0x20fc39=(0x0,verification_constant_1[_0x569bdb(0x1c0)])(_0x22cb40),_0x99388e=(0x0,verification_constant_1['getBaseKeyMap'])(_0x22cb40);if(_0x3de543[_0x569bdb(0x203)]&&_0x3de543[_0x20fc39]<_0x156422){if(_0x3de543[_0x99388e]<_0x156422)throw new common_1['HttpException'](_0x569bdb(0x201)+_0x4a678b+'>\x20或购买专属套餐\x20！',common_1['HttpStatus'][_0x569bdb(0x211)]);}if(!_0x3de543['packageId']&&_0x3de543[_0x99388e]<_0x156422)throw new common_1[(_0x569bdb(0x26c))](_0x569bdb(0x201)+_0x4a678b+_0x569bdb(0x221),common_1['HttpStatus'][_0x569bdb(0x211)]);return _0x3de543;}async[_0x1dbe62(0x23f)](_0x196f11,_0x1385e3,_0x56ddad){const _0x4487ab=_0x1dbe62,{id:_0x333760}=_0x196f11['user'],_0x164a2e=_0x1385e3==='model3'?_0x4487ab(0x274):_0x1385e3===_0x4487ab(0x246)?_0x4487ab(0x225):_0x1385e3===_0x4487ab(0x1fb)?'drawMjCount':null,_0x26384f=new Date(),_0x2f4792=await this[_0x4487ab(0x22b)][_0x4487ab(0x22d)]({'where':{'fingerprint':_0x333760}}),{visitorModel3Num:_0x5ddf9e,visitorModel4Num:_0x4cc9ec,visitorMJNum:_0x1757fa}=await this['globalConfigService'][_0x4487ab(0x1ec)](['visitorModel3Num',_0x4487ab(0x213),_0x4487ab(0x215)]),_0x2d9f31={'model3Count':_0x5ddf9e?Number(_0x5ddf9e):0x0,'model4Count':_0x4cc9ec?Number(_0x4cc9ec):0x0,'drawMjCount':_0x1757fa?Number(_0x1757fa):0x0};if(_0x2d9f31[_0x164a2e]===-0x1)return!![];if(!_0x2f4792){const _0x27d6e0={'fingerprint':_0x333760,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x240798=_0x56ddad||0x1;_0x27d6e0[_0x164a2e]=_0x27d6e0[_0x164a2e]+_0x240798;if(_0x27d6e0[_0x164a2e]>_0x2d9f31[_0x164a2e]||!_0x27d6e0[_0x164a2e])throw new common_1[(_0x4487ab(0x26c))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1[_0x4487ab(0x226)][_0x4487ab(0x211)]);else return await this['fingerprintLogEntity'][_0x4487ab(0x1e3)](_0x27d6e0),!![];}else{const {model3Count:_0x4be50f,model4Count:_0xe17a0d,drawMjCount:_0x58726c}=_0x2f4792;let _0x143451={'model3Count':_0x4be50f,'model4Count':_0xe17a0d,'drawMjCount':_0x58726c};const _0x398aa7=Number(new Date(_0x2f4792[_0x4487ab(0x220)])),_0x377548=this[_0x4487ab(0x20b)](_0x398aa7),_0x3277c3=_0x56ddad||0x1;_0x377548?_0x143451[_0x164a2e]=_0x143451[_0x164a2e]+_0x3277c3:(_0x143451={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x143451[_0x164a2e]=_0x143451[_0x164a2e]+_0x3277c3);if(_0x143451[_0x164a2e]>_0x2d9f31[_0x164a2e])throw new common_1[(_0x4487ab(0x26c))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1['HttpStatus'][_0x4487ab(0x211)]);else return await this[_0x4487ab(0x22b)]['update']({'fingerprint':_0x333760},_0x143451),!![];}}['isUpdatedToday'](_0x542a0f){const _0x5940b6=_0x1dbe62,_0xf51a2a=new Date(),_0x4fb9ff=new Date(_0xf51a2a[_0x5940b6(0x228)](),_0xf51a2a[_0x5940b6(0x22a)](),_0xf51a2a[_0x5940b6(0x238)]());return _0x542a0f>=_0x4fb9ff;}async[_0x1dbe62(0x23d)](_0x5ece1c,_0x342618,_0x1c6a91,_0xdbf62e=0x0){const _0x2f14cc=_0x1dbe62,_0x2b24bb=await this[_0x2f14cc(0x1c2)][_0x2f14cc(0x22d)]({'where':{'userId':_0x5ece1c}});if(!_0x2b24bb)throw new common_1[(_0x2f14cc(0x26c))](_0x2f14cc(0x21b),common_1[_0x2f14cc(0x226)][_0x2f14cc(0x1bd)]);const _0x338828=_0x342618==='model3'?_0x2f14cc(0x1c4):_0x342618==='model4'?_0x2f14cc(0x231):_0x342618===_0x2f14cc(0x1fb)?_0x2f14cc(0x1be):null,_0x4eed54=_0x342618===_0x2f14cc(0x23c)?_0x2f14cc(0x274):_0x342618===_0x2f14cc(0x246)?_0x2f14cc(0x225):_0x342618===_0x2f14cc(0x1fb)?_0x2f14cc(0x27f):null,_0x406d2f=_0x2b24bb['packageId']&&_0x2b24bb[_0x338828]<_0x1c6a91?_0x4eed54:_0x2b24bb['packageId']?_0x338828:_0x4eed54;let _0x16b2ee=null;_0x406d2f[_0x2f14cc(0x1d3)](_0x2f14cc(0x21f))&&(_0x16b2ee=_0x2f14cc(0x1fa));_0x406d2f['includes']('odel4')&&(_0x16b2ee=_0x2f14cc(0x1ff));_0x406d2f[_0x2f14cc(0x1d3)](_0x2f14cc(0x1ef))&&(_0x16b2ee=_0x2f14cc(0x237));const _0x4d8ef5={[_0x406d2f]:_0x2b24bb[_0x406d2f]-_0x1c6a91<0x0?0x0:_0x2b24bb[_0x406d2f]-_0x1c6a91,[_0x16b2ee]:_0x2b24bb[_0x16b2ee]+_0xdbf62e};_0x16b2ee==='useModel3Token'&&(_0x4d8ef5[_0x2f14cc(0x269)]=_0x2b24bb[_0x2f14cc(0x269)]+0x1),_0x16b2ee===_0x2f14cc(0x1ff)&&(_0x4d8ef5[_0x2f14cc(0x1d9)]=_0x2b24bb[_0x2f14cc(0x1d9)]+0x1);const _0x3af38e=await this[_0x2f14cc(0x1c2)][_0x2f14cc(0x208)]({'userId':_0x5ece1c},_0x4d8ef5);if(_0x3af38e['affected']===0x0)throw new common_1[(_0x2f14cc(0x26c))](_0x2f14cc(0x23b),common_1[_0x2f14cc(0x226)][_0x2f14cc(0x1bd)]);}async['queryUserBalance'](_0x3ba234){const _0x21a000=_0x1dbe62;try{const _0x251a95=await this[_0x21a000(0x1c2)][_0x21a000(0x22d)]({'where':{'userId':_0x3ba234},'select':[_0x21a000(0x203),_0x21a000(0x274),'model4Count',_0x21a000(0x27f),_0x21a000(0x1c4),'memberModel4Count','memberDrawMjCount',_0x21a000(0x269),_0x21a000(0x1d9),_0x21a000(0x1fa),_0x21a000(0x1ff),_0x21a000(0x237),_0x21a000(0x1e8)]});if(!_0x251a95){const _0x18c374=await this[_0x21a000(0x277)](_0x3ba234);if(_0x18c374)return await this['queryUserBalance'](_0x3ba234);else throw new common_1['HttpException'](_0x21a000(0x1dc),common_1['HttpStatus'][_0x21a000(0x1bd)]);}return _0x251a95[_0x21a000(0x20c)]=_0x251a95[_0x21a000(0x203)]?_0x251a95[_0x21a000(0x274)]+_0x251a95[_0x21a000(0x1c4)]:_0x251a95['model3Count'],_0x251a95[_0x21a000(0x1e0)]=_0x251a95[_0x21a000(0x203)]?_0x251a95[_0x21a000(0x225)]+_0x251a95[_0x21a000(0x231)]:_0x251a95[_0x21a000(0x225)],_0x251a95[_0x21a000(0x202)]=_0x251a95[_0x21a000(0x203)]?_0x251a95[_0x21a000(0x27f)]+_0x251a95['memberDrawMjCount']:_0x251a95[_0x21a000(0x27f)],_0x251a95[_0x21a000(0x1e8)]=_0x251a95[_0x21a000(0x1e8)]?(0x0,date_1['formatDate'])(_0x251a95[_0x21a000(0x1e8)],'YYYY-MM-DD'):null,_0x251a95;}catch(_0x209e39){console[_0x21a000(0x27c)](_0x21a000(0x205),_0x209e39);}}async[_0x1dbe62(0x283)](_0x1ccc5b){const _0x305c0c=_0x1dbe62,{userId:_0x1cd610,rechargeType:_0x202672,model3Count:_0x2ad9bd,model4Count:_0x25a748,drawMjCount:_0x2954ac,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x1ccc5b;if(!_0x1cd610)throw new common_1[(_0x305c0c(0x26c))](_0x305c0c(0x27a),common_1[_0x305c0c(0x226)][_0x305c0c(0x1bd)]);const _0xfc8b0a=(0x0,utils_1[_0x305c0c(0x1c3)])();return await this['accountLogEntity'][_0x305c0c(0x1e3)]({'userId':_0x1cd610,'rechargeType':_0x202672,'model3Count':_0x2ad9bd,'model4Count':_0x25a748,'drawMjCount':_0x2954ac,'days':days,'extent':extent,'uid':_0xfc8b0a,'pkgName':pkgName});}async[_0x1dbe62(0x277)](_0x55a90f,_0x171de0={}){const _0x3954e8=_0x1dbe62,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x171de0,_0x65fce9=await this[_0x3954e8(0x1c2)]['findOne']({'where':{'userId':_0x55a90f}});if(_0x65fce9)throw new common_1[(_0x3954e8(0x26c))]('当前用户无需创建账户信息！',common_1['HttpStatus'][_0x3954e8(0x1bd)]);return await this['userBalanceEntity']['save']({'userId':_0x55a90f,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x1dbe62(0x20e)](_0x20fe7a,_0x4eda08,_0x1ce1fa=-0x1){const _0x9367c3=_0x1dbe62;try{const _0x27fd47=await this['userBalanceEntity'][_0x9367c3(0x22d)]({'where':{'userId':_0x20fe7a}})||await this[_0x9367c3(0x277)](_0x20fe7a);if(!_0x27fd47)throw new common_1[(_0x9367c3(0x26c))]('查询用户账户信息失败！',common_1[_0x9367c3(0x226)][_0x9367c3(0x1bd)]);const {model3Count:_0x29f3e0,model4Count:_0x4e7a71,drawMjCount:_0x3dc66d,memberModel3Count:_0xa754bf,memberModel4Count:_0x2deb7b,memberDrawMjCount:_0xffa8f0}=_0x27fd47;let _0x4b1f04={};if(_0x1ce1fa>0x0){const {packageId:_0xcf6e54}=_0x4eda08;if(!_0xcf6e54)throw new common_1['HttpException'](_0x9367c3(0x210),common_1['HttpStatus'][_0x9367c3(0x1bd)]);const _0x5792ee=await this['cramiPackageEntity'][_0x9367c3(0x22d)]({'where':{'id':_0xcf6e54}});if(!_0x5792ee)throw new common_1['HttpException'](_0x9367c3(0x1dd),common_1[_0x9367c3(0x226)]['BAD_REQUEST']);const {weight:_0x3f570e}=_0x5792ee;if(!_0x27fd47[_0x9367c3(0x203)])_0x4b1f04={'memberModel3Count':_0x29f3e0+_0x4eda08[_0x9367c3(0x274)],'memberModel4Count':_0x4e7a71+_0x4eda08[_0x9367c3(0x225)],'memberDrawMjCount':_0x3dc66d+_0x4eda08['drawMjCount'],'expirationTime':(0x0,date_1[_0x9367c3(0x1cb)])()[_0x9367c3(0x243)](_0x1ce1fa>0x0?_0x1ce1fa:0x0,_0x9367c3(0x1eb))['format'](_0x9367c3(0x1ca)),'packageId':_0xcf6e54};else{const _0xfb08e1=await this['cramiPackageEntity'][_0x9367c3(0x22d)]({'where':{'id':_0x27fd47[_0x9367c3(0x203)]}});_0x3f570e>=_0xfb08e1[_0x9367c3(0x263)]&&(_0x4b1f04={'memberModel3Count':_0xa754bf+_0x4eda08[_0x9367c3(0x274)],'memberModel4Count':_0x2deb7b+_0x4eda08[_0x9367c3(0x225)],'memberDrawMjCount':_0xffa8f0+_0x4eda08[_0x9367c3(0x27f)],'expirationTime':(0x0,date_1[_0x9367c3(0x1cb)])(_0x27fd47[_0x9367c3(0x1e8)])[_0x9367c3(0x243)](_0x1ce1fa>0x0?_0x1ce1fa:0x0,_0x9367c3(0x1eb))[_0x9367c3(0x1c7)](_0x9367c3(0x1ca)),'packageId':_0xcf6e54}),_0x3f570e<_0xfb08e1['weight']&&(_0x4b1f04={'memberModel3Count':_0xa754bf+_0x4eda08[_0x9367c3(0x274)],'memberModel4Count':_0x2deb7b+_0x4eda08[_0x9367c3(0x225)],'memberDrawMjCount':_0xffa8f0+_0x4eda08[_0x9367c3(0x27f)]});}}_0x1ce1fa<=0x0&&(_0x4b1f04={'model3Count':_0x29f3e0+_0x4eda08['model3Count'],'model4Count':_0x4e7a71+_0x4eda08['model4Count'],'drawMjCount':_0x3dc66d+_0x4eda08[_0x9367c3(0x27f)]});const _0x3a0bad=await this['userBalanceEntity'][_0x9367c3(0x208)]({'userId':_0x20fe7a},_0x4b1f04);if(_0x3a0bad[_0x9367c3(0x25e)]===0x0)throw new common_1[(_0x9367c3(0x26c))](_0x20fe7a+_0x9367c3(0x236),common_1[_0x9367c3(0x226)][_0x9367c3(0x1bd)]);}catch(_0x911938){console[_0x9367c3(0x27c)](_0x9367c3(0x205),_0x911938);throw new common_1[(_0x9367c3(0x26c))]('用户充值失败！',common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x1dbe62(0x1e4)](_0x12d21b){const _0x5006ac=_0x1dbe62;console[_0x5006ac(0x27c)](_0x5006ac(0x233),_0x12d21b);try{const {userId:_0x52ce38,goodsId:_0x570c18}=_0x12d21b,_0x4796b4=await this[_0x5006ac(0x27b)][_0x5006ac(0x22d)]({'where':{'id':_0x12d21b[_0x5006ac(0x24c)],'status':0x1}});if(!_0x4796b4)throw new common_1[(_0x5006ac(0x26c))](_0x5006ac(0x1d8),common_1[_0x5006ac(0x226)][_0x5006ac(0x1bd)]);const {model3Count:_0x33b96b,model4Count:_0x3cdf50,drawMjCount:_0x4ccbeb,days:_0x514c7a,name:_0x471497}=_0x4796b4,_0x2e3520={'model3Count':_0x33b96b,'model4Count':_0x3cdf50,'drawMjCount':_0x4ccbeb,'days':_0x514c7a,'packageId':_0x12d21b[_0x5006ac(0x24c)]};await this[_0x5006ac(0x20e)](_0x52ce38,_0x2e3520,_0x514c7a),await this[_0x5006ac(0x283)]({'userId':_0x52ce38,'rechargeType':balance_constant_1['RechargeType']['SCAN_PAY'],'model3Count':_0x33b96b,'model4Count':_0x3cdf50,'drawMjCount':_0x4ccbeb,'pkgName':_0x471497,'days':_0x514c7a});const _0x286916=await this['userEntity']['findOne']({'where':{'id':_0x52ce38}}),{invitedBy:_0x17aabb}=_0x286916;if(_0x17aabb){const _0x2a7db6=await this[_0x5006ac(0x1f6)][_0x5006ac(0x22d)]({'where':{'inviteCode':_0x17aabb}}),_0x3b220e=await this['salesUsersEntity']['findOne']({'where':{'userId':_0x2a7db6['id']}});if(!_0x2a7db6)return;const {id:_0x4441a5}=_0x2a7db6,{performanceRatio:_0x4432eb}=_0x3b220e,_0x2f77b0={'inviterUserId':_0x4441a5,'inviteeUserId':_0x52ce38,'orderId':_0x12d21b['id'],'orderPrice':_0x12d21b[_0x5006ac(0x245)],'commissionPercentage':_0x4432eb,'commissionAmount':(_0x12d21b['total']*_0x4432eb/0x64)[_0x5006ac(0x273)](0x2)};await this[_0x5006ac(0x21d)]['createSalesRecords'](_0x2f77b0),await this[_0x5006ac(0x21d)][_0x5006ac(0x259)](_0x4441a5,_0x2f77b0[_0x5006ac(0x251)]);}}catch(_0x4bc81a){console[_0x5006ac(0x27c)]('error:\x20',_0x4bc81a);throw new common_1[(_0x5006ac(0x26c))](_0x5006ac(0x284),common_1[_0x5006ac(0x226)][_0x5006ac(0x1bd)]);}}async[_0x1dbe62(0x206)](_0x3576d5,_0x17871c){const _0x17c8c1=_0x1dbe62,{page:page=0x1,size:size=0x14}=_0x17871c,{id:_0x58e79c}=_0x3576d5[_0x17c8c1(0x24d)],[_0x54ced2,_0x291dd9]=await this[_0x17c8c1(0x260)][_0x17c8c1(0x25a)]({'where':{'userId':_0x58e79c},'order':{'id':_0x17c8c1(0x1f2)},'skip':(page-0x1)*size,'take':size});return _0x54ced2['forEach'](_0x190132=>{const _0x4d6615=_0x17c8c1;_0x190132[_0x4d6615(0x21a)]=_0x190132[_0x4d6615(0x1e7)]>0x0?_0x190132[_0x4d6615(0x1e7)]+'天':'永久';}),{'rows':(0x0,date_1[_0x17c8c1(0x222)])(_0x54ced2),'count':_0x291dd9};}async[_0x1dbe62(0x250)](_0x466e77,_0xe9aec9){const _0x59c257=_0x1dbe62;try{const {page:page=0x1,size:size=0xa,userId:_0xdb466d,rechargeType:_0x2dcb65,packageId:_0x2787c5}=_0xe9aec9,{role:_0x42ef7f}=_0x466e77[_0x59c257(0x24d)],_0x517749={};_0x2dcb65&&(_0x517749[_0x59c257(0x26b)]=_0x2dcb65),_0x517749[_0x59c257(0x1c8)]=_0xdb466d||(0x0,typeorm_2['LessThan'])(0x186a0),_0x2787c5&&(_0x517749['packageId']={'$like':'%'+_0x2787c5+'%'});const [_0x13b34d,_0x3a4964]=await this['accountLogEntity']['findAndCount']({'where':_0x517749,'order':{'id':_0x59c257(0x1f2)},'skip':(page-0x1)*size,'take':size}),_0x443e11=_0x13b34d[_0x59c257(0x1d2)](_0x3874f0=>_0x3874f0['userId']),_0x4eed44=await this[_0x59c257(0x1f6)][_0x59c257(0x1c5)]({'where':{'id':(0x0,typeorm_2['In'])(_0x443e11)}});return _0x13b34d['forEach'](_0x14fc55=>{const _0x4295c9=_0x59c257,_0x169f0d=_0x4eed44['find'](_0x24329a=>_0x24329a['id']===_0x14fc55[_0x4295c9(0x1c8)]);_0x14fc55[_0x4295c9(0x258)]=_0x169f0d===null||_0x169f0d===void 0x0?void 0x0:_0x169f0d[_0x4295c9(0x258)],_0x14fc55['email']=_0x169f0d===null||_0x169f0d===void 0x0?void 0x0:_0x169f0d[_0x4295c9(0x26f)],_0x14fc55['phone']=_0x169f0d===null||_0x169f0d===void 0x0?void 0x0:_0x169f0d[_0x4295c9(0x1f9)],_0x14fc55[_0x4295c9(0x256)]=_0x169f0d===null||_0x169f0d===void 0x0?void 0x0:_0x169f0d[_0x4295c9(0x256)],_0x14fc55[_0x4295c9(0x264)]=_0x169f0d===null||_0x169f0d===void 0x0?void 0x0:_0x169f0d[_0x4295c9(0x264)];}),_0x42ef7f!==_0x59c257(0x218)&&_0x13b34d[_0x59c257(0x1f3)](_0x383e23=>{const _0x539934=_0x59c257;_0x383e23[_0x539934(0x26f)]=_0x383e23[_0x539934(0x26f)]?(0x0,utils_1['hideString'])(_0x383e23[_0x539934(0x26f)]):'',_0x383e23[_0x539934(0x1f9)]=_0x383e23[_0x539934(0x1f9)]?(0x0,utils_1[_0x539934(0x27e)])(_0x383e23['phone']):'';}),{'rows':_0x13b34d,'count':_0x3a4964};}catch(_0x3a41d3){console[_0x59c257(0x27c)](_0x59c257(0x205),_0x3a41d3);throw new common_1[(_0x59c257(0x26c))]('查询用户账户失败！',common_1[_0x59c257(0x226)][_0x59c257(0x1bd)]);}}async['queryUserBalanceByIds'](_0x427cc6){const _0x2fb0cd=_0x1dbe62;return await this[_0x2fb0cd(0x1c2)][_0x2fb0cd(0x1c5)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x427cc6)}});}async[_0x1dbe62(0x270)](_0x237866,_0x888cff){}async[_0x1dbe62(0x1ed)](_0x423dfd,_0x25fb8e){const _0x2699d8=_0x1dbe62,_0x3d51de=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x423dfd}});if(!_0x3d51de)return;await this[_0x2699d8(0x283)]({'userId':_0x423dfd,'rechargeType':balance_constant_1[_0x2699d8(0x1f5)][_0x2699d8(0x1e9)],'model3Count':0x0,'model4Count':0x0,'drawMjCount':_0x25fb8e,'pkgName':'','days':0x0}),await this[_0x2699d8(0x1c2)][_0x2699d8(0x208)]({'userId':_0x423dfd},{'drawMjCount':_0x3d51de[_0x2699d8(0x27f)]+Number(_0x25fb8e)});}async['upgradeBalance'](){const _0x597dac=_0x1dbe62,_0x41b9f5=await this[_0x597dac(0x1f6)][_0x597dac(0x1c5)]();if(!_0x41b9f5['length'])return;const _0x24eeb9=await this[_0x597dac(0x1f1)][_0x597dac(0x1ec)]([_0x597dac(0x1e6)]);if(!_0x24eeb9)await this[_0x597dac(0x1f1)]['setConfig']({'settings':[{'configKey':_0x597dac(0x1e6),'configVal':'1'}]});else throw new common_1[(_0x597dac(0x26c))](_0x597dac(0x1d6),common_1[_0x597dac(0x226)]['BAD_REQUEST']);_0x41b9f5[_0x597dac(0x1f3)](_0x537089=>{const {id:_0x15ed6c}=_0x537089;this['balanceEntity']['findOne']({'where':{'userId':_0x15ed6c}})['then'](_0x322fad=>{const _0x45e9e6=_0x3756;if(!_0x322fad)return;this[_0x45e9e6(0x1f7)](_0x15ed6c,_0x322fad);});});}async[_0x1dbe62(0x1f7)](_0x49ec9b,_0x489a30){const _0x5e9f33=_0x1dbe62,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x489a30,_0x1f858c=await this[_0x5e9f33(0x1e5)][_0x5e9f33(0x22d)]({'where':{'userId':_0x49ec9b}}),_0x3f3e97={'userId':_0x49ec9b,'model3Count':Number(usesLeft),'model4Count':(_0x1f858c===null||_0x1f858c===void 0x0?void 0x0:_0x1f858c[_0x5e9f33(0x252)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x1f858c===null||_0x1f858c===void 0x0?void 0x0:_0x1f858c[_0x5e9f33(0x23e)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x548e6e=await this['userBalanceEntity'][_0x5e9f33(0x22d)]({'where':{'userId':_0x49ec9b}});_0x548e6e?common_1[_0x5e9f33(0x214)][_0x5e9f33(0x266)]('用户'+_0x49ec9b+_0x5e9f33(0x1d7),_0x5e9f33(0x1cc)):this[_0x5e9f33(0x1c2)][_0x5e9f33(0x1e3)](_0x3f3e97)[_0x5e9f33(0x216)](_0x2d3502=>{const _0x47276f=_0x5e9f33;common_1['Logger'][_0x47276f(0x266)]('用户'+_0x49ec9b+_0x47276f(0x1fd),_0x47276f(0x1cc));})[_0x5e9f33(0x282)](_0x3d42f3=>{const _0x312b6b=_0x5e9f33;console[_0x312b6b(0x27c)](_0x312b6b(0x205),_0x3d42f3),common_1[_0x312b6b(0x214)][_0x312b6b(0x266)]('用户'+_0x49ec9b+_0x312b6b(0x20a),_0x312b6b(0x1cc));});}async[_0x1dbe62(0x268)](_0x4a1468){const _0x2ab318=_0x1dbe62,{fingerprint:_0x2fe0ea}=_0x4a1468[_0x2ab318(0x224)],{id:_0x2f505c}=_0x4a1468[_0x2ab318(0x24d)];return await this['chatLogEntity'][_0x2ab318(0x208)]({'userId':Number(_0x2fe0ea)},{'userId':_0x2f505c}),await this['chatGroupEntity'][_0x2ab318(0x208)]({'userId':Number(_0x2fe0ea)},{'userId':_0x2f505c}),await this[_0x2ab318(0x21c)][_0x2ab318(0x208)]({'userId':Number(_0x2fe0ea)},{'userId':_0x2f505c}),0x1;}async[_0x1dbe62(0x249)](_0x56160e){const _0xcbc606=_0x1dbe62,{fingerprint:_0x180835}=_0x56160e[_0xcbc606(0x224)],_0x295b36=await this['chatLogEntity'][_0xcbc606(0x252)]({'where':{'userId':_0x180835}}),_0x46007c=await this['chatGroupEntity']['count']({'where':{'userId':_0x180835}}),_0x2b2b84=await this[_0xcbc606(0x21c)][_0xcbc606(0x252)]({'where':{'userId':_0x180835}});return _0x295b36||_0x46007c||_0x2b2b84||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x1dbe62(0x255)])(),__param(0x0,(0x0,typeorm_1[_0x1dbe62(0x20f)])(balance_entity_1[_0x1dbe62(0x219)])),__param(0x1,(0x0,typeorm_1[_0x1dbe62(0x20f)])(userBalance_entity_1['UserBalanceEntity'])),__param(0x2,(0x0,typeorm_1[_0x1dbe62(0x20f)])(accountLog_entity_1[_0x1dbe62(0x281)])),__param(0x3,(0x0,typeorm_1[_0x1dbe62(0x20f)])(cramiPackage_entity_1[_0x1dbe62(0x280)])),__param(0x4,(0x0,typeorm_1[_0x1dbe62(0x20f)])(config_entity_1[_0x1dbe62(0x278)])),__param(0x5,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x1dbe62(0x27d)])),__param(0x6,(0x0,typeorm_1[_0x1dbe62(0x20f)])(salesUsers_entity_1[_0x1dbe62(0x204)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1['WhiteListEntity'])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1['FingerprintLogEntity'])),__param(0x9,(0x0,typeorm_1[_0x1dbe62(0x20f)])(chatGroup_entity_1['ChatGroupEntity'])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0xb,(0x0,typeorm_1[_0x1dbe62(0x20f)])(midjourney_entity_1[_0x1dbe62(0x262)])),__metadata(_0x1dbe62(0x227),[typeorm_2[_0x1dbe62(0x22c)],typeorm_2[_0x1dbe62(0x22c)],typeorm_2[_0x1dbe62(0x22c)],typeorm_2['Repository'],typeorm_2[_0x1dbe62(0x22c)],typeorm_2[_0x1dbe62(0x22c)],typeorm_2[_0x1dbe62(0x22c)],typeorm_2[_0x1dbe62(0x22c)],typeorm_2[_0x1dbe62(0x22c)],typeorm_2[_0x1dbe62(0x22c)],typeorm_2[_0x1dbe62(0x22c)],typeorm_2[_0x1dbe62(0x22c)],sales_service_1['SalesService'],globalConfig_service_1[_0x1dbe62(0x253)]])],UserBalanceService),exports[_0x1dbe62(0x1ee)]=UserBalanceService;