'use strict';const _0x1aaf14=_0x99fc;(function(_0x3b8e4d,_0x31a664){const _0x2dade2=_0x99fc,_0x6ac90d=_0x3b8e4d();while(!![]){try{const _0x42b471=parseInt(_0x2dade2(0x9f))/0x1*(-parseInt(_0x2dade2(0x9b))/0x2)+-parseInt(_0x2dade2(0xac))/0x3+-parseInt(_0x2dade2(0x9e))/0x4*(parseInt(_0x2dade2(0x98))/0x5)+-parseInt(_0x2dade2(0xc4))/0x6*(parseInt(_0x2dade2(0x8c))/0x7)+-parseInt(_0x2dade2(0xbf))/0x8*(parseInt(_0x2dade2(0x9a))/0x9)+parseInt(_0x2dade2(0xc8))/0xa+parseInt(_0x2dade2(0x94))/0xb;if(_0x42b471===_0x31a664)break;else _0x6ac90d['push'](_0x6ac90d['shift']());}catch(_0x40b3a2){_0x6ac90d['push'](_0x6ac90d['shift']());}}}(_0x19f1,0x337c5));function _0x99fc(_0x37cf3b,_0x30aac7){const _0x19f1ac=_0x19f1();return _0x99fc=function(_0x99fc1,_0x5caf34){_0x99fc1=_0x99fc1-0x8b;let _0x23a4e0=_0x19f1ac[_0x99fc1];return _0x23a4e0;},_0x99fc(_0x37cf3b,_0x30aac7);}function _0x19f1(){const _0x13ad75=['del','752930VLVIjh','../globalConfig/globalConfig.service','InjectRepository','createdAt','验证码不存在','request','@nestjs/common','验证码发送失败！','图形验证码已过期、请重新输入!','update',':CAPTCHA:','now','data','function','7AVImDS','BAD_REQUEST','__decorate','verifycationEntity','USED','verifyCaptcha','createRandomCode','getOwnPropertyDescriptor','17691003nyRGkU','../redisCache/redisCache.service','@alicloud/pop-core','globalConfigService','10iWOWhZ','decorate','408249pFUIwW','246802xqdlFM','__metadata','findOne','457796nLPSeY','2QpLmcN','ceil','design:paramtypes','SendSms','确实必要参数错误！','GlobalConfigService','stringify','metadata','https://dysmsapi.aliyuncs.com','验证码错误','VerificationUseStatusEnum','save','2017-05-25','953379ubvWTL','redisCacheService','S内不得重新发送','object','RedisCacheService','Injectable','typeorm','getTime','HttpStatus','./verifycation.entity','get','Repository','HttpException','Message','getNamespace','VerifycationEntity','DESC','verifyCode','VerificationService','56VBcndb','length','当前验证码已被使用！','expiresAt','Code','2169966EPLeXc','defineProperty','__esModule'];_0x19f1=function(){return _0x13ad75;};return _0x19f1();}var __decorate=this&&this[_0x1aaf14(0x8e)]||function(_0xf76893,_0x14bed8,_0x4076f4,_0x2062c4){const _0x48e801=_0x1aaf14;var _0x310374=arguments['length'],_0x2623a1=_0x310374<0x3?_0x14bed8:_0x2062c4===null?_0x2062c4=Object[_0x48e801(0x93)](_0x14bed8,_0x4076f4):_0x2062c4,_0x4f8f6e;if(typeof Reflect==='object'&&typeof Reflect[_0x48e801(0x99)]===_0x48e801(0x8b))_0x2623a1=Reflect['decorate'](_0xf76893,_0x14bed8,_0x4076f4,_0x2062c4);else{for(var _0x299973=_0xf76893[_0x48e801(0xc0)]-0x1;_0x299973>=0x0;_0x299973--)if(_0x4f8f6e=_0xf76893[_0x299973])_0x2623a1=(_0x310374<0x3?_0x4f8f6e(_0x2623a1):_0x310374>0x3?_0x4f8f6e(_0x14bed8,_0x4076f4,_0x2623a1):_0x4f8f6e(_0x14bed8,_0x4076f4))||_0x2623a1;}return _0x310374>0x3&&_0x2623a1&&Object[_0x48e801(0xc5)](_0x14bed8,_0x4076f4,_0x2623a1),_0x2623a1;},__metadata=this&&this[_0x1aaf14(0x9c)]||function(_0x169f16,_0x32c2ce){const _0x159a4b=_0x1aaf14;if(typeof Reflect===_0x159a4b(0xaf)&&typeof Reflect['metadata']===_0x159a4b(0x8b))return Reflect[_0x159a4b(0xa6)](_0x169f16,_0x32c2ce);},__param=this&&this['__param']||function(_0x26edc2,_0x388c4e){return function(_0xef17d7,_0x3c5cc6){_0x388c4e(_0xef17d7,_0x3c5cc6,_0x26edc2);};};Object[_0x1aaf14(0xc5)](exports,_0x1aaf14(0xc6),{'value':!![]}),exports[_0x1aaf14(0xbe)]=void 0x0;const globalConfig_service_1=require(_0x1aaf14(0xc9)),status_constant_1=require('./../../common/constants/status.constant'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x1aaf14(0xb2)),verifycation_entity_1=require(_0x1aaf14(0xb5)),common_1=require(_0x1aaf14(0xce)),utils_1=require('../../common/utils'),redisCache_service_1=require(_0x1aaf14(0x95)),Core=require(_0x1aaf14(0x96));let VerificationService=class VerificationService{constructor(_0x11f4ce,_0x110e23,_0x134c06){const _0x251a9d=_0x1aaf14;this['verifycationEntity']=_0x11f4ce,this[_0x251a9d(0x97)]=_0x110e23,this[_0x251a9d(0xad)]=_0x134c06;}async['createVerification'](_0x535023,_0x51487d,_0x243b33=0x1e*0x3c){const _0x357b8=_0x1aaf14,_0x6f4e6d=await this['verifycationEntity'][_0x357b8(0x9d)]({'where':{'userId':_0x535023['id'],'type':_0x51487d},'order':{'createdAt':_0x357b8(0xbc)}});if(_0x6f4e6d&&_0x6f4e6d[_0x357b8(0xcb)][_0x357b8(0xb3)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x192a02=Math[_0x357b8(0xa0)]((_0x6f4e6d[_0x357b8(0xcb)]['getTime']()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1[(_0x357b8(0xb8))](_0x192a02+_0x357b8(0xae),common_1[_0x357b8(0xb4)][_0x357b8(0x8d)]);}const _0x508408=(0x0,utils_1[_0x357b8(0x92)])(),_0x339631=new Date(Date[_0x357b8(0xd3)]()+_0x243b33*0x3e8),{id:_0x1dd94c,email:_0x304b05}=_0x535023,_0x4f7d36={'userId':_0x1dd94c,'type':_0x51487d,'code':_0x508408,'expiresAt':_0x339631,'email':_0x304b05};return await this[_0x357b8(0x8f)][_0x357b8(0xaa)](_0x4f7d36);}async[_0x1aaf14(0xbd)]({code:_0x2e0a47,id:_0x80ee0f},_0x431669){const _0x5ab38d=_0x1aaf14,_0x591e4c=await this['verifycationEntity'][_0x5ab38d(0x9d)]({'where':{'id':_0x80ee0f,'type':_0x431669},'order':{'createdAt':_0x5ab38d(0xbc)}});if(!_0x591e4c)throw new common_1[(_0x5ab38d(0xb8))](_0x5ab38d(0xcc),common_1[_0x5ab38d(0xb4)][_0x5ab38d(0x8d)]);if(_0x591e4c['used']===status_constant_1[_0x5ab38d(0xa9)][_0x5ab38d(0x90)])throw new common_1[(_0x5ab38d(0xb8))](_0x5ab38d(0xc1),common_1[_0x5ab38d(0xb4)][_0x5ab38d(0x8d)]);else _0x591e4c['used']=status_constant_1[_0x5ab38d(0xa9)]['USED'],await this[_0x5ab38d(0x8f)][_0x5ab38d(0xd1)]({'id':_0x80ee0f},_0x591e4c);if(Number(_0x591e4c['code'])!==Number(_0x2e0a47))throw new common_1['HttpException'](_0x5ab38d(0xa8),common_1[_0x5ab38d(0xb4)][_0x5ab38d(0x8d)]);if(_0x591e4c[_0x5ab38d(0xc2)]<new Date())throw new common_1['HttpException']('验证码已过期',common_1[_0x5ab38d(0xb4)][_0x5ab38d(0x8d)]);return _0x591e4c;}async[_0x1aaf14(0x91)](_0x12d55a){const _0x22aa51=_0x1aaf14,{captchaId:_0x3e6763,captchaCode:_0xaf8aa3}=_0x12d55a,_0x578161=await this[_0x22aa51(0x97)][_0x22aa51(0xba)](),_0x20c5d9=_0x578161+_0x22aa51(0xd2)+_0x3e6763,_0x455754=await this['redisCacheService'][_0x22aa51(0xb6)]({'key':_0x20c5d9});await this[_0x22aa51(0xad)][_0x22aa51(0xc7)]({'key':_0x20c5d9});if(!_0x455754)throw new common_1[(_0x22aa51(0xb8))](_0x22aa51(0xd0),common_1['HttpStatus']['BAD_REQUEST']);if(!_0x455754||_0x455754!==_0xaf8aa3)throw new common_1[(_0x22aa51(0xb8))]('图形验证码错误、请检查填写!',common_1[_0x22aa51(0xb4)][_0x22aa51(0x8d)]);}async['sendPhoneCode'](_0x177cfa){const _0x14ffa4=_0x1aaf14;var _0x22d44c;const {accessKeyId:_0x442794,accessKeySecret:_0x38282f,SignName:_0x59a21f,TemplateCode:_0x491934}=await this[_0x14ffa4(0x97)]['getPhoneVerifyConfig'](),{phone:_0x2ab055,code:_0x1ceb1b}=_0x177cfa;if(!_0x2ab055||!_0x1ceb1b)throw new common_1['HttpException'](_0x14ffa4(0xa3),common_1[_0x14ffa4(0xb4)][_0x14ffa4(0x8d)]);const _0x571931=new Core({'accessKeyId':_0x442794,'accessKeySecret':_0x38282f,'endpoint':_0x14ffa4(0xa7),'apiVersion':_0x14ffa4(0xab)}),_0x2a95eb={'PhoneNumbers':_0x2ab055,'SignName':_0x59a21f,'TemplateCode':_0x491934,'TemplateParam':JSON[_0x14ffa4(0xa5)]({'code':_0x1ceb1b})},_0x6f26d3={'method':'POST','formatParams':![]};try{const _0x35e3af=await _0x571931[_0x14ffa4(0xcd)](_0x14ffa4(0xa2),_0x2a95eb,_0x6f26d3);if(_0x35e3af[_0x14ffa4(0xc3)]==='OK')return!![];else throw new common_1[(_0x14ffa4(0xb8))](_0x35e3af['Message']||_0x14ffa4(0xcf),common_1['HttpStatus'][_0x14ffa4(0x8d)]);}catch(_0x402e8f){throw new common_1[(_0x14ffa4(0xb8))](((_0x22d44c=_0x402e8f===null||_0x402e8f===void 0x0?void 0x0:_0x402e8f[_0x14ffa4(0xd4)])===null||_0x22d44c===void 0x0?void 0x0:_0x22d44c[_0x14ffa4(0xb9)])||'验证码发送失败！',common_1[_0x14ffa4(0xb4)]['BAD_REQUEST']);}}};VerificationService=__decorate([(0x0,common_1[_0x1aaf14(0xb1)])(),__param(0x0,(0x0,typeorm_1[_0x1aaf14(0xca)])(verifycation_entity_1[_0x1aaf14(0xbb)])),__metadata(_0x1aaf14(0xa1),[typeorm_2[_0x1aaf14(0xb7)],globalConfig_service_1[_0x1aaf14(0xa4)],redisCache_service_1[_0x1aaf14(0xb0)]])],VerificationService),exports[_0x1aaf14(0xbe)]=VerificationService;