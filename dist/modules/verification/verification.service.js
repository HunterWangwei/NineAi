'use strict';const _0x291f91=_0x602e;(function(_0x40d570,_0x23500d){const _0x3df8fc=_0x602e,_0xca06d8=_0x40d570();while(!![]){try{const _0x51edc0=parseInt(_0x3df8fc(0x126))/0x1*(-parseInt(_0x3df8fc(0x11a))/0x2)+-parseInt(_0x3df8fc(0xfa))/0x3+parseInt(_0x3df8fc(0x116))/0x4+parseInt(_0x3df8fc(0xf7))/0x5*(parseInt(_0x3df8fc(0x121))/0x6)+parseInt(_0x3df8fc(0x102))/0x7+parseInt(_0x3df8fc(0x117))/0x8+-parseInt(_0x3df8fc(0x12d))/0x9;if(_0x51edc0===_0x23500d)break;else _0xca06d8['push'](_0xca06d8['shift']());}catch(_0x57bad8){_0xca06d8['push'](_0xca06d8['shift']());}}}(_0x210a,0xdc185));var __decorate=this&&this[_0x291f91(0x115)]||function(_0x544b5d,_0x359b2e,_0x92c047,_0xe68fb7){const _0x45d29b=_0x291f91;var _0x4a9c82=arguments[_0x45d29b(0x10d)],_0x5d6965=_0x4a9c82<0x3?_0x359b2e:_0xe68fb7===null?_0xe68fb7=Object[_0x45d29b(0x130)](_0x359b2e,_0x92c047):_0xe68fb7,_0x502b3d;if(typeof Reflect===_0x45d29b(0xfd)&&typeof Reflect['decorate']===_0x45d29b(0x11e))_0x5d6965=Reflect[_0x45d29b(0x100)](_0x544b5d,_0x359b2e,_0x92c047,_0xe68fb7);else{for(var _0x47e1b6=_0x544b5d[_0x45d29b(0x10d)]-0x1;_0x47e1b6>=0x0;_0x47e1b6--)if(_0x502b3d=_0x544b5d[_0x47e1b6])_0x5d6965=(_0x4a9c82<0x3?_0x502b3d(_0x5d6965):_0x4a9c82>0x3?_0x502b3d(_0x359b2e,_0x92c047,_0x5d6965):_0x502b3d(_0x359b2e,_0x92c047))||_0x5d6965;}return _0x4a9c82>0x3&&_0x5d6965&&Object[_0x45d29b(0x10b)](_0x359b2e,_0x92c047,_0x5d6965),_0x5d6965;},__metadata=this&&this[_0x291f91(0x107)]||function(_0x58f119,_0x57bc0e){const _0x3890fb=_0x291f91;if(typeof Reflect===_0x3890fb(0xfd)&&typeof Reflect[_0x3890fb(0x112)]===_0x3890fb(0x11e))return Reflect[_0x3890fb(0x112)](_0x58f119,_0x57bc0e);},__param=this&&this[_0x291f91(0xf4)]||function(_0x30a540,_0x315a91){return function(_0x32abdf,_0x3d9139){_0x315a91(_0x32abdf,_0x3d9139,_0x30a540);};};Object[_0x291f91(0x10b)](exports,_0x291f91(0x123),{'value':!![]}),exports[_0x291f91(0x109)]=void 0x0;const globalConfig_service_1=require(_0x291f91(0x119)),status_constant_1=require(_0x291f91(0x128)),typeorm_1=require(_0x291f91(0x11d)),typeorm_2=require('typeorm'),verifycation_entity_1=require(_0x291f91(0xf6)),common_1=require('@nestjs/common'),utils_1=require(_0x291f91(0x12e)),redisCache_service_1=require(_0x291f91(0x11f)),Core=require(_0x291f91(0x118));function _0x602e(_0x55304f,_0x33c2fa){const _0x210afe=_0x210a();return _0x602e=function(_0x602ea6,_0x46a546){_0x602ea6=_0x602ea6-0xed;let _0x587b28=_0x210afe[_0x602ea6];return _0x587b28;},_0x602e(_0x55304f,_0x33c2fa);}let VerificationService=class VerificationService{constructor(_0x23c8a8,_0x10ebd1,_0x4f468b){const _0x3e3bc4=_0x291f91;this[_0x3e3bc4(0xf1)]=_0x23c8a8,this['globalConfigService']=_0x10ebd1,this[_0x3e3bc4(0x104)]=_0x4f468b;}async[_0x291f91(0x10f)](_0x50178b,_0x268b83,_0x55e768=0x1e*0x3c){const _0x4e6b4d=_0x291f91,_0x44412e=await this['verifycationEntity'][_0x4e6b4d(0x12c)]({'where':{'userId':_0x50178b['id'],'type':_0x268b83},'order':{'createdAt':_0x4e6b4d(0x113)}});if(_0x44412e&&_0x44412e[_0x4e6b4d(0xf9)]['getTime']()+0x1*0x3c*0x3e8>Date[_0x4e6b4d(0x106)]()){const _0x3876ea=Math['ceil']((_0x44412e[_0x4e6b4d(0xf9)][_0x4e6b4d(0xed)]()+0x1*0x3c*0x3e8-Date[_0x4e6b4d(0x106)]())/0x3e8);throw new common_1['HttpException'](_0x3876ea+'S内不得重新发送',common_1[_0x4e6b4d(0x125)][_0x4e6b4d(0xfb)]);}const _0xce7efb=(0x0,utils_1[_0x4e6b4d(0xfe)])(),_0x4058ec=new Date(Date['now']()+_0x55e768*0x3e8),{id:_0xded22c,email:_0x1114cd}=_0x50178b,_0xfc118a={'userId':_0xded22c,'type':_0x268b83,'code':_0xce7efb,'expiresAt':_0x4058ec,'email':_0x1114cd};return await this['verifycationEntity'][_0x4e6b4d(0x110)](_0xfc118a);}async[_0x291f91(0x101)]({code:_0x1af327,id:_0x228af3},_0x293c90){const _0x222bc2=_0x291f91,_0x13aafc=await this[_0x222bc2(0xf1)][_0x222bc2(0x12c)]({'where':{'id':_0x228af3,'type':_0x293c90},'order':{'createdAt':_0x222bc2(0x113)}});if(!_0x13aafc)throw new common_1[(_0x222bc2(0x108))]('验证码不存在',common_1[_0x222bc2(0x125)][_0x222bc2(0xfb)]);if(_0x13aafc[_0x222bc2(0x11c)]===status_constant_1[_0x222bc2(0x122)][_0x222bc2(0xf0)])throw new common_1['HttpException'](_0x222bc2(0xf2),common_1[_0x222bc2(0x125)][_0x222bc2(0xfb)]);else _0x13aafc[_0x222bc2(0x11c)]=status_constant_1[_0x222bc2(0x122)]['USED'],await this[_0x222bc2(0xf1)][_0x222bc2(0x127)]({'id':_0x228af3},_0x13aafc);if(Number(_0x13aafc['code'])!==Number(_0x1af327))throw new common_1['HttpException']('验证码错误',common_1[_0x222bc2(0x125)][_0x222bc2(0xfb)]);if(_0x13aafc['expiresAt']<new Date())throw new common_1[(_0x222bc2(0x108))](_0x222bc2(0x111),common_1[_0x222bc2(0x125)]['BAD_REQUEST']);return _0x13aafc;}async[_0x291f91(0xf3)](_0x2fa2f7){const _0x12d5e4=_0x291f91,{captchaId:_0xf03bc1,captchaCode:_0x2829b7}=_0x2fa2f7,_0x5c8bac=await this[_0x12d5e4(0x12a)][_0x12d5e4(0x124)](),_0x32ea4a=_0x5c8bac+_0x12d5e4(0x120)+_0xf03bc1,_0x1b9844=await this[_0x12d5e4(0x104)][_0x12d5e4(0x12f)]({'key':_0x32ea4a});await this[_0x12d5e4(0x104)][_0x12d5e4(0xf8)]({'key':_0x32ea4a});if(!_0x1b9844)throw new common_1['HttpException'](_0x12d5e4(0x131),common_1[_0x12d5e4(0x125)][_0x12d5e4(0xfb)]);if(!_0x1b9844||_0x1b9844!==_0x2829b7)throw new common_1[(_0x12d5e4(0x108))]('图形验证码错误、请检查填写!',common_1[_0x12d5e4(0x125)][_0x12d5e4(0xfb)]);}async[_0x291f91(0xf5)](_0x433e70){const _0x309b7d=_0x291f91;var _0x34ce02;const {accessKeyId:_0x1dcd17,accessKeySecret:_0x3ee0e8,SignName:_0x5704bd,TemplateCode:_0x41eab9}=await this[_0x309b7d(0x12a)][_0x309b7d(0xef)](),{phone:_0x474085,code:_0x238791}=_0x433e70;if(!_0x474085||!_0x238791)throw new common_1[(_0x309b7d(0x108))]('确实必要参数错误！',common_1[_0x309b7d(0x125)][_0x309b7d(0xfb)]);const _0x3f909d=new Core({'accessKeyId':_0x1dcd17,'accessKeySecret':_0x3ee0e8,'endpoint':_0x309b7d(0x114),'apiVersion':_0x309b7d(0x10a)}),_0x42617f={'PhoneNumbers':_0x474085,'SignName':_0x5704bd,'TemplateCode':_0x41eab9,'TemplateParam':JSON[_0x309b7d(0xee)]({'code':_0x238791})},_0x50593={'method':'POST','formatParams':![]};try{const _0x2aef37=await _0x3f909d[_0x309b7d(0x103)](_0x309b7d(0x11b),_0x42617f,_0x50593);if(_0x2aef37[_0x309b7d(0x10e)]==='OK')return!![];else throw new common_1[(_0x309b7d(0x108))](_0x2aef37[_0x309b7d(0xfc)]||_0x309b7d(0x129),common_1[_0x309b7d(0x125)][_0x309b7d(0xfb)]);}catch(_0x473079){throw new common_1[(_0x309b7d(0x108))](((_0x34ce02=_0x473079===null||_0x473079===void 0x0?void 0x0:_0x473079['data'])===null||_0x34ce02===void 0x0?void 0x0:_0x34ce02[_0x309b7d(0xfc)])||_0x309b7d(0x129),common_1[_0x309b7d(0x125)][_0x309b7d(0xfb)]);}}};function _0x210a(){const _0x25c8d2=['createRandomCode','InjectRepository','decorate','verifyCode','4548432egiVld','request','redisCacheService','Injectable','now','__metadata','HttpException','VerificationService','2017-05-25','defineProperty','GlobalConfigService','length','Code','createVerification','save','验证码已过期','metadata','DESC','https://dysmsapi.aliyuncs.com','__decorate','6063512bAZRcw','1375744eadKaA','@alicloud/pop-core','../globalConfig/globalConfig.service','2bvQsos','SendSms','used','@nestjs/typeorm','function','../redisCache/redisCache.service',':CAPTCHA:','138774LFjvwT','VerificationUseStatusEnum','__esModule','getNamespace','HttpStatus','636545qfstmx','update','./../../common/constants/status.constant','验证码发送失败！','globalConfigService','VerifycationEntity','findOne','6113106ByGKlF','../../common/utils','get','getOwnPropertyDescriptor','图形验证码已过期、请重新输入!','getTime','stringify','getPhoneVerifyConfig','USED','verifycationEntity','当前验证码已被使用！','verifyCaptcha','__param','sendPhoneCode','./verifycation.entity','205fKZTzd','del','createdAt','3205869fuYLmx','BAD_REQUEST','Message','object'];_0x210a=function(){return _0x25c8d2;};return _0x210a();}VerificationService=__decorate([(0x0,common_1[_0x291f91(0x105)])(),__param(0x0,(0x0,typeorm_1[_0x291f91(0xff)])(verifycation_entity_1[_0x291f91(0x12b)])),__metadata('design:paramtypes',[typeorm_2['Repository'],globalConfig_service_1[_0x291f91(0x10c)],redisCache_service_1['RedisCacheService']])],VerificationService),exports[_0x291f91(0x109)]=VerificationService;