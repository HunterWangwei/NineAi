'use strict';const _0x185f79=_0x4776;(function(_0x230b1e,_0x452115){const _0x4d1f59=_0x4776,_0x9388ec=_0x230b1e();while(!![]){try{const _0x1eac02=-parseInt(_0x4d1f59(0x1b1))/0x1+-parseInt(_0x4d1f59(0x18b))/0x2+parseInt(_0x4d1f59(0x19b))/0x3+-parseInt(_0x4d1f59(0x1ba))/0x4*(parseInt(_0x4d1f59(0x1bb))/0x5)+-parseInt(_0x4d1f59(0x17d))/0x6+parseInt(_0x4d1f59(0x19f))/0x7*(-parseInt(_0x4d1f59(0x1af))/0x8)+parseInt(_0x4d1f59(0x17c))/0x9;if(_0x1eac02===_0x452115)break;else _0x9388ec['push'](_0x9388ec['shift']());}catch(_0x3b7081){_0x9388ec['push'](_0x9388ec['shift']());}}}(_0x3be3,0x56d11));var __decorate=this&&this[_0x185f79(0x1a1)]||function(_0xda9ad7,_0x589d49,_0x14d441,_0x3b2d2b){const _0x5ee6a4=_0x185f79;var _0x19e8eb=arguments[_0x5ee6a4(0x18a)],_0x237fe9=_0x19e8eb<0x3?_0x589d49:_0x3b2d2b===null?_0x3b2d2b=Object[_0x5ee6a4(0x18f)](_0x589d49,_0x14d441):_0x3b2d2b,_0xce5e59;if(typeof Reflect===_0x5ee6a4(0x1aa)&&typeof Reflect['decorate']===_0x5ee6a4(0x18c))_0x237fe9=Reflect[_0x5ee6a4(0x17f)](_0xda9ad7,_0x589d49,_0x14d441,_0x3b2d2b);else{for(var _0x46dd5c=_0xda9ad7[_0x5ee6a4(0x18a)]-0x1;_0x46dd5c>=0x0;_0x46dd5c--)if(_0xce5e59=_0xda9ad7[_0x46dd5c])_0x237fe9=(_0x19e8eb<0x3?_0xce5e59(_0x237fe9):_0x19e8eb>0x3?_0xce5e59(_0x589d49,_0x14d441,_0x237fe9):_0xce5e59(_0x589d49,_0x14d441))||_0x237fe9;}return _0x19e8eb>0x3&&_0x237fe9&&Object[_0x5ee6a4(0x1b8)](_0x589d49,_0x14d441,_0x237fe9),_0x237fe9;},__metadata=this&&this[_0x185f79(0x1a3)]||function(_0x47166a,_0x241590){const _0x4f6655=_0x185f79;if(typeof Reflect===_0x4f6655(0x1aa)&&typeof Reflect[_0x4f6655(0x19c)]===_0x4f6655(0x18c))return Reflect[_0x4f6655(0x19c)](_0x47166a,_0x241590);},__param=this&&this['__param']||function(_0x8d145c,_0x1e9a2e){return function(_0x48fa7d,_0x41b0fb){_0x1e9a2e(_0x48fa7d,_0x41b0fb,_0x8d145c);};};Object[_0x185f79(0x1b8)](exports,_0x185f79(0x192),{'value':!![]}),exports[_0x185f79(0x191)]=void 0x0;const globalConfig_service_1=require(_0x185f79(0x19d)),status_constant_1=require(_0x185f79(0x195)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x185f79(0x1a2)),verifycation_entity_1=require('./verifycation.entity'),common_1=require(_0x185f79(0x185)),utils_1=require(_0x185f79(0x1a7)),redisCache_service_1=require(_0x185f79(0x1b9)),Core=require(_0x185f79(0x1bf));function _0x4776(_0x5382c2,_0x5576a6){const _0x3be39b=_0x3be3();return _0x4776=function(_0x47765a,_0x2caf9a){_0x47765a=_0x47765a-0x17c;let _0x4e56fd=_0x3be39b[_0x47765a];return _0x4e56fd;},_0x4776(_0x5382c2,_0x5576a6);}let VerificationService=class VerificationService{constructor(_0x20e255,_0x2d893a,_0x278a6c){const _0x417da4=_0x185f79;this[_0x417da4(0x1a9)]=_0x20e255,this['globalConfigService']=_0x2d893a,this[_0x417da4(0x180)]=_0x278a6c;}async[_0x185f79(0x1ac)](_0x1a5b7f,_0x5e1140,_0x30110d=0x1e*0x3c){const _0x24fff9=_0x185f79,_0x1dac59=await this['verifycationEntity'][_0x24fff9(0x1a8)]({'where':{'userId':_0x1a5b7f['id'],'type':_0x5e1140},'order':{'createdAt':_0x24fff9(0x18e)}});if(_0x1dac59&&_0x1dac59[_0x24fff9(0x186)][_0x24fff9(0x1ae)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x4a137a=Math[_0x24fff9(0x1b3)]((_0x1dac59[_0x24fff9(0x186)]['getTime']()+0x1*0x3c*0x3e8-Date[_0x24fff9(0x18d)]())/0x3e8);throw new common_1[(_0x24fff9(0x1a4))](_0x4a137a+'S内不得重新发送',common_1[_0x24fff9(0x1bd)][_0x24fff9(0x17e)]);}const _0x54eb27=(0x0,utils_1[_0x24fff9(0x1a5)])(),_0x194bed=new Date(Date[_0x24fff9(0x18d)]()+_0x30110d*0x3e8),{id:_0x4caec0,email:_0x583ef1}=_0x1a5b7f,_0x165902={'userId':_0x4caec0,'type':_0x5e1140,'code':_0x54eb27,'expiresAt':_0x194bed,'email':_0x583ef1};return await this[_0x24fff9(0x1a9)][_0x24fff9(0x183)](_0x165902);}async[_0x185f79(0x1c0)]({code:_0x1773cd,id:_0x3f0bff},_0x236696){const _0x50f0a0=_0x185f79,_0x23e834=await this['verifycationEntity'][_0x50f0a0(0x1a8)]({'where':{'id':_0x3f0bff,'type':_0x236696},'order':{'createdAt':_0x50f0a0(0x18e)}});if(!_0x23e834)throw new common_1['HttpException'](_0x50f0a0(0x1b5),common_1[_0x50f0a0(0x1bd)][_0x50f0a0(0x17e)]);if(_0x23e834[_0x50f0a0(0x1be)]===status_constant_1[_0x50f0a0(0x182)][_0x50f0a0(0x1b6)])throw new common_1['HttpException'](_0x50f0a0(0x197),common_1['HttpStatus']['BAD_REQUEST']);else _0x23e834['used']=status_constant_1['VerificationUseStatusEnum'][_0x50f0a0(0x1b6)],await this['verifycationEntity'][_0x50f0a0(0x1a6)]({'id':_0x3f0bff},_0x23e834);if(Number(_0x23e834[_0x50f0a0(0x181)])!==Number(_0x1773cd))throw new common_1['HttpException'](_0x50f0a0(0x1b2),common_1['HttpStatus'][_0x50f0a0(0x17e)]);if(_0x23e834['expiresAt']<new Date())throw new common_1[(_0x50f0a0(0x1a4))]('验证码已过期',common_1[_0x50f0a0(0x1bd)]['BAD_REQUEST']);return _0x23e834;}async['verifyCaptcha'](_0x501c8c){const _0x171a58=_0x185f79,{captchaId:_0x4b52ee,captchaCode:_0x167f0c}=_0x501c8c,_0x1d9f34=await this['globalConfigService'][_0x171a58(0x1b4)](),_0x1c4329=_0x1d9f34+':CAPTCHA:'+_0x4b52ee,_0x41b4f8=await this['redisCacheService'][_0x171a58(0x19a)]({'key':_0x1c4329});await this[_0x171a58(0x180)]['del']({'key':_0x1c4329});if(!_0x41b4f8)throw new common_1[(_0x171a58(0x1a4))](_0x171a58(0x1a0),common_1[_0x171a58(0x1bd)]['BAD_REQUEST']);if(!_0x41b4f8||_0x41b4f8!==_0x167f0c)throw new common_1[(_0x171a58(0x1a4))](_0x171a58(0x194),common_1[_0x171a58(0x1bd)][_0x171a58(0x17e)]);}async['sendPhoneCode'](_0x15b2b1){const _0x2db60f=_0x185f79;var _0xaf6150;const {accessKeyId:_0x376e07,accessKeySecret:_0x26ff74,SignName:_0x3f0be7,TemplateCode:_0x168abb}=await this[_0x2db60f(0x189)]['getPhoneVerifyConfig'](),{phone:_0x110309,code:_0x438d8e}=_0x15b2b1;if(!_0x110309||!_0x438d8e)throw new common_1['HttpException']('确实必要参数错误！',common_1[_0x2db60f(0x1bd)]['BAD_REQUEST']);const _0x3a381e=new Core({'accessKeyId':_0x376e07,'accessKeySecret':_0x26ff74,'endpoint':_0x2db60f(0x19e),'apiVersion':_0x2db60f(0x199)}),_0x5406f8={'PhoneNumbers':_0x110309,'SignName':_0x3f0be7,'TemplateCode':_0x168abb,'TemplateParam':JSON[_0x2db60f(0x196)]({'code':_0x438d8e})},_0x4c4851={'method':'POST','formatParams':![]};try{const _0x4ec4f2=await _0x3a381e[_0x2db60f(0x187)](_0x2db60f(0x1b7),_0x5406f8,_0x4c4851);if(_0x4ec4f2['Code']==='OK')return!![];else throw new common_1[(_0x2db60f(0x1a4))](_0x4ec4f2['Message']||_0x2db60f(0x184),common_1[_0x2db60f(0x1bd)][_0x2db60f(0x17e)]);}catch(_0xae2579){throw new common_1[(_0x2db60f(0x1a4))](((_0xaf6150=_0xae2579===null||_0xae2579===void 0x0?void 0x0:_0xae2579[_0x2db60f(0x1ab)])===null||_0xaf6150===void 0x0?void 0x0:_0xaf6150[_0x2db60f(0x1ad)])||'验证码发送失败！',common_1[_0x2db60f(0x1bd)][_0x2db60f(0x17e)]);}}};VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x185f79(0x190)])(verifycation_entity_1[_0x185f79(0x198)])),__metadata(_0x185f79(0x1bc),[typeorm_2[_0x185f79(0x188)],globalConfig_service_1[_0x185f79(0x193)],redisCache_service_1[_0x185f79(0x1b0)]])],VerificationService),exports[_0x185f79(0x191)]=VerificationService;function _0x3be3(){const _0x1b5b8f=['metadata','../globalConfig/globalConfig.service','https://dysmsapi.aliyuncs.com','2000264qPuiBq','图形验证码已过期、请重新输入!','__decorate','typeorm','__metadata','HttpException','createRandomCode','update','../../common/utils','findOne','verifycationEntity','object','data','createVerification','Message','getTime','16JUsdKs','RedisCacheService','542045vUtdMb','验证码错误','ceil','getNamespace','验证码不存在','USED','SendSms','defineProperty','../redisCache/redisCache.service','8YBtSqd','360700QUekUR','design:paramtypes','HttpStatus','used','@alicloud/pop-core','verifyCode','15265719xZLbvb','1540596ydALlx','BAD_REQUEST','decorate','redisCacheService','code','VerificationUseStatusEnum','save','验证码发送失败！','@nestjs/common','createdAt','request','Repository','globalConfigService','length','191926qHpWuY','function','now','DESC','getOwnPropertyDescriptor','InjectRepository','VerificationService','__esModule','GlobalConfigService','图形验证码错误、请检查填写!','./../../common/constants/status.constant','stringify','当前验证码已被使用！','VerifycationEntity','2017-05-25','get','809904TlpsbD'];_0x3be3=function(){return _0x1b5b8f;};return _0x3be3();}