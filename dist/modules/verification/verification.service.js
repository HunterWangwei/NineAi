'use strict';const _0x1798d8=_0xb9c3;(function(_0x2baf0d,_0x22322d){const _0x59beda=_0xb9c3,_0x4bb4a9=_0x2baf0d();while(!![]){try{const _0x517997=-parseInt(_0x59beda(0x208))/0x1*(parseInt(_0x59beda(0x1ed))/0x2)+-parseInt(_0x59beda(0x1d6))/0x3*(-parseInt(_0x59beda(0x1d5))/0x4)+parseInt(_0x59beda(0x20b))/0x5+-parseInt(_0x59beda(0x1ef))/0x6+parseInt(_0x59beda(0x1f6))/0x7+-parseInt(_0x59beda(0x1f5))/0x8*(-parseInt(_0x59beda(0x1ca))/0x9)+-parseInt(_0x59beda(0x1f7))/0xa;if(_0x517997===_0x22322d)break;else _0x4bb4a9['push'](_0x4bb4a9['shift']());}catch(_0x484d49){_0x4bb4a9['push'](_0x4bb4a9['shift']());}}}(_0x4a76,0x75c3f));function _0x4a76(){const _0x1ec45d=['当前验证码已被使用！','globalConfigService','1806813IYRgHC','verifycationEntity','now','S内不得重新发送','HttpStatus','__decorate',':CAPTCHA:','@nestjs/common','get','findOne','design:paramtypes','1219204iTlfKi','3EWSceb','function','USED','del','metadata','expiresAt','VerificationUseStatusEnum','RedisCacheService','图形验证码错误、请检查填写!','typeorm','data','DESC','Code','HttpException','defineProperty','verifyCaptcha','./verifycation.entity','length','VerificationService','redisCacheService','getNamespace','__metadata','../redisCache/redisCache.service','998MqaSZY','VerifycationEntity','4094736Mijdns','used','getTime','@nestjs/typeorm','Message','图形验证码已过期、请重新输入!','16KVGjPK','3204985cySXfP','3372570AKZgyK','sendPhoneCode','ceil','verifyCode','确实必要参数错误！','createdAt','object','@alicloud/pop-core','__param','2017-05-25','验证码已过期','验证码错误','./../../common/constants/status.constant','GlobalConfigService','createRandomCode','BAD_REQUEST','验证码发送失败！','181vuFecS','验证码不存在','../../common/utils','2141145bQMwHG'];_0x4a76=function(){return _0x1ec45d;};return _0x4a76();}function _0xb9c3(_0x36654d,_0x3ca442){const _0x4a7663=_0x4a76();return _0xb9c3=function(_0xb9c3c5,_0x21dcbc){_0xb9c3c5=_0xb9c3c5-0x1ca;let _0x21bac5=_0x4a7663[_0xb9c3c5];return _0x21bac5;},_0xb9c3(_0x36654d,_0x3ca442);}var __decorate=this&&this[_0x1798d8(0x1cf)]||function(_0x3cf9f4,_0x41fe57,_0x257065,_0x2fd1c4){const _0x12264e=_0x1798d8;var _0x52af9e=arguments[_0x12264e(0x1e7)],_0x140ad6=_0x52af9e<0x3?_0x41fe57:_0x2fd1c4===null?_0x2fd1c4=Object['getOwnPropertyDescriptor'](_0x41fe57,_0x257065):_0x2fd1c4,_0x8747ae;if(typeof Reflect===_0x12264e(0x1fd)&&typeof Reflect['decorate']===_0x12264e(0x1d7))_0x140ad6=Reflect['decorate'](_0x3cf9f4,_0x41fe57,_0x257065,_0x2fd1c4);else{for(var _0x1ec354=_0x3cf9f4[_0x12264e(0x1e7)]-0x1;_0x1ec354>=0x0;_0x1ec354--)if(_0x8747ae=_0x3cf9f4[_0x1ec354])_0x140ad6=(_0x52af9e<0x3?_0x8747ae(_0x140ad6):_0x52af9e>0x3?_0x8747ae(_0x41fe57,_0x257065,_0x140ad6):_0x8747ae(_0x41fe57,_0x257065))||_0x140ad6;}return _0x52af9e>0x3&&_0x140ad6&&Object['defineProperty'](_0x41fe57,_0x257065,_0x140ad6),_0x140ad6;},__metadata=this&&this[_0x1798d8(0x1eb)]||function(_0x1c8098,_0x8d8b3d){const _0x121b40=_0x1798d8;if(typeof Reflect===_0x121b40(0x1fd)&&typeof Reflect['metadata']===_0x121b40(0x1d7))return Reflect[_0x121b40(0x1da)](_0x1c8098,_0x8d8b3d);},__param=this&&this[_0x1798d8(0x1ff)]||function(_0x4e8e88,_0xf9b25e){return function(_0x50ea33,_0x289760){_0xf9b25e(_0x50ea33,_0x289760,_0x4e8e88);};};Object[_0x1798d8(0x1e4)](exports,'__esModule',{'value':!![]}),exports[_0x1798d8(0x1e8)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),status_constant_1=require(_0x1798d8(0x203)),typeorm_1=require(_0x1798d8(0x1f2)),typeorm_2=require(_0x1798d8(0x1df)),verifycation_entity_1=require(_0x1798d8(0x1e6)),common_1=require(_0x1798d8(0x1d1)),utils_1=require(_0x1798d8(0x20a)),redisCache_service_1=require(_0x1798d8(0x1ec)),Core=require(_0x1798d8(0x1fe));let VerificationService=class VerificationService{constructor(_0x36967a,_0x307288,_0x45b665){const _0x13e197=_0x1798d8;this['verifycationEntity']=_0x36967a,this[_0x13e197(0x20d)]=_0x307288,this[_0x13e197(0x1e9)]=_0x45b665;}async['createVerification'](_0x1932c8,_0x190bec,_0x4e8d68=0x1e*0x3c){const _0x40f7c5=_0x1798d8,_0x20de9f=await this['verifycationEntity'][_0x40f7c5(0x1d3)]({'where':{'userId':_0x1932c8['id'],'type':_0x190bec},'order':{'createdAt':'DESC'}});if(_0x20de9f&&_0x20de9f[_0x40f7c5(0x1fc)][_0x40f7c5(0x1f1)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x10ee38=Math[_0x40f7c5(0x1f9)]((_0x20de9f[_0x40f7c5(0x1fc)][_0x40f7c5(0x1f1)]()+0x1*0x3c*0x3e8-Date[_0x40f7c5(0x1cc)]())/0x3e8);throw new common_1['HttpException'](_0x10ee38+_0x40f7c5(0x1cd),common_1[_0x40f7c5(0x1ce)][_0x40f7c5(0x206)]);}const _0x1e6263=(0x0,utils_1[_0x40f7c5(0x205)])(),_0x57ccb0=new Date(Date[_0x40f7c5(0x1cc)]()+_0x4e8d68*0x3e8),{id:_0x271c34,email:_0x1e3dce}=_0x1932c8,_0x39c30f={'userId':_0x271c34,'type':_0x190bec,'code':_0x1e6263,'expiresAt':_0x57ccb0,'email':_0x1e3dce};return await this[_0x40f7c5(0x1cb)]['save'](_0x39c30f);}async[_0x1798d8(0x1fa)]({code:_0x4f44ce,id:_0x3cea31},_0x41126d){const _0x17a500=_0x1798d8,_0x197da7=await this['verifycationEntity'][_0x17a500(0x1d3)]({'where':{'id':_0x3cea31,'type':_0x41126d},'order':{'createdAt':_0x17a500(0x1e1)}});if(!_0x197da7)throw new common_1[(_0x17a500(0x1e3))](_0x17a500(0x209),common_1[_0x17a500(0x1ce)][_0x17a500(0x206)]);if(_0x197da7[_0x17a500(0x1f0)]===status_constant_1[_0x17a500(0x1dc)][_0x17a500(0x1d8)])throw new common_1[(_0x17a500(0x1e3))](_0x17a500(0x20c),common_1[_0x17a500(0x1ce)][_0x17a500(0x206)]);else _0x197da7[_0x17a500(0x1f0)]=status_constant_1[_0x17a500(0x1dc)]['USED'],await this['verifycationEntity']['update']({'id':_0x3cea31},_0x197da7);if(Number(_0x197da7['code'])!==Number(_0x4f44ce))throw new common_1[(_0x17a500(0x1e3))](_0x17a500(0x202),common_1[_0x17a500(0x1ce)][_0x17a500(0x206)]);if(_0x197da7[_0x17a500(0x1db)]<new Date())throw new common_1['HttpException'](_0x17a500(0x201),common_1[_0x17a500(0x1ce)][_0x17a500(0x206)]);return _0x197da7;}async[_0x1798d8(0x1e5)](_0x549caa){const _0x4ca6ea=_0x1798d8,{captchaId:_0x567aa2,captchaCode:_0x4c9b96}=_0x549caa,_0x54a77e=await this[_0x4ca6ea(0x20d)][_0x4ca6ea(0x1ea)](),_0x51aae9=_0x54a77e+_0x4ca6ea(0x1d0)+_0x567aa2,_0x244f67=await this[_0x4ca6ea(0x1e9)][_0x4ca6ea(0x1d2)]({'key':_0x51aae9});await this[_0x4ca6ea(0x1e9)][_0x4ca6ea(0x1d9)]({'key':_0x51aae9});if(!_0x244f67)throw new common_1[(_0x4ca6ea(0x1e3))](_0x4ca6ea(0x1f4),common_1[_0x4ca6ea(0x1ce)][_0x4ca6ea(0x206)]);if(!_0x244f67||_0x244f67!==_0x4c9b96)throw new common_1[(_0x4ca6ea(0x1e3))](_0x4ca6ea(0x1de),common_1[_0x4ca6ea(0x1ce)]['BAD_REQUEST']);}async[_0x1798d8(0x1f8)](_0x4639fa){const _0x3edbfa=_0x1798d8;var _0x5e9901;const {accessKeyId:_0x21088a,accessKeySecret:_0x40b517,SignName:_0x3cc814,TemplateCode:_0x3cfe51}=await this[_0x3edbfa(0x20d)]['getPhoneVerifyConfig'](),{phone:_0x2e5197,code:_0x55759d}=_0x4639fa;if(!_0x2e5197||!_0x55759d)throw new common_1[(_0x3edbfa(0x1e3))](_0x3edbfa(0x1fb),common_1['HttpStatus'][_0x3edbfa(0x206)]);const _0x25d2f0=new Core({'accessKeyId':_0x21088a,'accessKeySecret':_0x40b517,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0x3edbfa(0x200)}),_0x496b11={'PhoneNumbers':_0x2e5197,'SignName':_0x3cc814,'TemplateCode':_0x3cfe51,'TemplateParam':JSON['stringify']({'code':_0x55759d})},_0x441364={'method':'POST','formatParams':![]};try{const _0x403c83=await _0x25d2f0['request']('SendSms',_0x496b11,_0x441364);if(_0x403c83[_0x3edbfa(0x1e2)]==='OK')return!![];else throw new common_1['HttpException'](_0x403c83[_0x3edbfa(0x1f3)]||_0x3edbfa(0x207),common_1['HttpStatus'][_0x3edbfa(0x206)]);}catch(_0x515f7f){throw new common_1[(_0x3edbfa(0x1e3))](((_0x5e9901=_0x515f7f===null||_0x515f7f===void 0x0?void 0x0:_0x515f7f[_0x3edbfa(0x1e0)])===null||_0x5e9901===void 0x0?void 0x0:_0x5e9901[_0x3edbfa(0x1f3)])||_0x3edbfa(0x207),common_1['HttpStatus']['BAD_REQUEST']);}}};VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(verifycation_entity_1[_0x1798d8(0x1ee)])),__metadata(_0x1798d8(0x1d4),[typeorm_2['Repository'],globalConfig_service_1[_0x1798d8(0x204)],redisCache_service_1[_0x1798d8(0x1dd)]])],VerificationService),exports['VerificationService']=VerificationService;