'use strict';const _0x59db0f=_0x38a3;(function(_0x16a393,_0x5da1d5){const _0x40dede=_0x38a3,_0x269be6=_0x16a393();while(!![]){try{const _0x184c98=-parseInt(_0x40dede(0xaa))/0x1*(-parseInt(_0x40dede(0xcc))/0x2)+-parseInt(_0x40dede(0xc5))/0x3+parseInt(_0x40dede(0xe7))/0x4*(parseInt(_0x40dede(0xc9))/0x5)+-parseInt(_0x40dede(0xe5))/0x6+parseInt(_0x40dede(0xb0))/0x7+-parseInt(_0x40dede(0xe8))/0x8+-parseInt(_0x40dede(0xe9))/0x9*(-parseInt(_0x40dede(0xa9))/0xa);if(_0x184c98===_0x5da1d5)break;else _0x269be6['push'](_0x269be6['shift']());}catch(_0x196bc7){_0x269be6['push'](_0x269be6['shift']());}}}(_0x130e,0x830f7));var __decorate=this&&this[_0x59db0f(0xc2)]||function(_0x51fc80,_0x3aec61,_0x22f158,_0x3b028c){const _0x421f6a=_0x59db0f;var _0xcd844f=arguments[_0x421f6a(0xcb)],_0x33f41d=_0xcd844f<0x3?_0x3aec61:_0x3b028c===null?_0x3b028c=Object['getOwnPropertyDescriptor'](_0x3aec61,_0x22f158):_0x3b028c,_0x264004;if(typeof Reflect===_0x421f6a(0xad)&&typeof Reflect['decorate']==='function')_0x33f41d=Reflect[_0x421f6a(0xd5)](_0x51fc80,_0x3aec61,_0x22f158,_0x3b028c);else{for(var _0x496e11=_0x51fc80[_0x421f6a(0xcb)]-0x1;_0x496e11>=0x0;_0x496e11--)if(_0x264004=_0x51fc80[_0x496e11])_0x33f41d=(_0xcd844f<0x3?_0x264004(_0x33f41d):_0xcd844f>0x3?_0x264004(_0x3aec61,_0x22f158,_0x33f41d):_0x264004(_0x3aec61,_0x22f158))||_0x33f41d;}return _0xcd844f>0x3&&_0x33f41d&&Object['defineProperty'](_0x3aec61,_0x22f158,_0x33f41d),_0x33f41d;},__metadata=this&&this['__metadata']||function(_0x13210f,_0x82c8ca){const _0x509e4c=_0x59db0f;if(typeof Reflect==='object'&&typeof Reflect[_0x509e4c(0xe2)]===_0x509e4c(0xb6))return Reflect[_0x509e4c(0xe2)](_0x13210f,_0x82c8ca);},__param=this&&this['__param']||function(_0x41d12c,_0x1b50ca){return function(_0x492acb,_0x173ada){_0x1b50ca(_0x492acb,_0x173ada,_0x41d12c);};};Object['defineProperty'](exports,_0x59db0f(0xbd),{'value':!![]}),exports[_0x59db0f(0xda)]=void 0x0;const globalConfig_service_1=require(_0x59db0f(0xa8)),status_constant_1=require(_0x59db0f(0xe0)),typeorm_1=require(_0x59db0f(0xce)),typeorm_2=require(_0x59db0f(0xbb)),verifycation_entity_1=require('./verifycation.entity'),common_1=require('@nestjs/common'),utils_1=require(_0x59db0f(0xac)),redisCache_service_1=require('../redisCache/redisCache.service'),Core=require(_0x59db0f(0xc3));let VerificationService=class VerificationService{constructor(_0x3d147e,_0xe70cbb,_0x5c11d0){const _0x45a11e=_0x59db0f;this[_0x45a11e(0xb9)]=_0x3d147e,this[_0x45a11e(0xb2)]=_0xe70cbb,this[_0x45a11e(0xbf)]=_0x5c11d0;}async['createVerification'](_0x58a23b,_0x140853,_0x40426b=0x1e*0x3c){const _0x4048f0=_0x59db0f,_0x567185=await this[_0x4048f0(0xb9)][_0x4048f0(0xc1)]({'where':{'userId':_0x58a23b['id'],'type':_0x140853},'order':{'createdAt':'DESC'}});if(_0x567185&&_0x567185[_0x4048f0(0xdf)][_0x4048f0(0xaf)]()+0x1*0x3c*0x3e8>Date[_0x4048f0(0xba)]()){const _0x37ca33=Math[_0x4048f0(0xd3)]((_0x567185[_0x4048f0(0xdf)]['getTime']()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1[(_0x4048f0(0xd6))](_0x37ca33+_0x4048f0(0xde),common_1['HttpStatus'][_0x4048f0(0xe4)]);}const _0x2d982d=(0x0,utils_1[_0x4048f0(0xd1)])(),_0x1b2b67=new Date(Date['now']()+_0x40426b*0x3e8),{id:_0x177e71,email:_0x44c408}=_0x58a23b,_0x31fe2a={'userId':_0x177e71,'type':_0x140853,'code':_0x2d982d,'expiresAt':_0x1b2b67,'email':_0x44c408};return await this['verifycationEntity'][_0x4048f0(0xb1)](_0x31fe2a);}async['verifyCode']({code:_0x3967b3,id:_0x11ca27},_0x290573){const _0x2709ae=_0x59db0f,_0x263fba=await this[_0x2709ae(0xb9)][_0x2709ae(0xc1)]({'where':{'id':_0x11ca27,'type':_0x290573},'order':{'createdAt':_0x2709ae(0xcd)}});if(!_0x263fba)throw new common_1[(_0x2709ae(0xd6))](_0x2709ae(0xc7),common_1['HttpStatus'][_0x2709ae(0xe4)]);if(_0x263fba[_0x2709ae(0xab)]===status_constant_1['VerificationUseStatusEnum'][_0x2709ae(0xd7)])throw new common_1[(_0x2709ae(0xd6))](_0x2709ae(0xd9),common_1[_0x2709ae(0xd2)][_0x2709ae(0xe4)]);else _0x263fba[_0x2709ae(0xab)]=status_constant_1['VerificationUseStatusEnum']['USED'],await this[_0x2709ae(0xb9)][_0x2709ae(0xcf)]({'id':_0x11ca27},_0x263fba);if(Number(_0x263fba[_0x2709ae(0xd8)])!==Number(_0x3967b3))throw new common_1[(_0x2709ae(0xd6))](_0x2709ae(0xa6),common_1[_0x2709ae(0xd2)][_0x2709ae(0xe4)]);if(_0x263fba[_0x2709ae(0xd4)]<new Date())throw new common_1[(_0x2709ae(0xd6))](_0x2709ae(0xb4),common_1[_0x2709ae(0xd2)][_0x2709ae(0xe4)]);return _0x263fba;}async['verifyCaptcha'](_0x55993e){const _0x415e90=_0x59db0f,{captchaId:_0x4bd155,captchaCode:_0x49699e}=_0x55993e,_0x473cf4=await this[_0x415e90(0xb2)]['getNamespace'](),_0x46ce12=_0x473cf4+_0x415e90(0xca)+_0x4bd155,_0x11f458=await this[_0x415e90(0xbf)][_0x415e90(0xdc)]({'key':_0x46ce12});await this[_0x415e90(0xbf)][_0x415e90(0xe6)]({'key':_0x46ce12});if(!_0x11f458)throw new common_1[(_0x415e90(0xd6))]('图形验证码已过期、请重新输入!',common_1[_0x415e90(0xd2)][_0x415e90(0xe4)]);if(!_0x11f458||_0x11f458!==_0x49699e)throw new common_1[(_0x415e90(0xd6))](_0x415e90(0xc8),common_1[_0x415e90(0xd2)][_0x415e90(0xe4)]);}async[_0x59db0f(0xb5)](_0x56356a){const _0x3f7d62=_0x59db0f;var _0x8063ee;const {accessKeyId:_0x57c2e9,accessKeySecret:_0x92f58f,SignName:_0x255a3c,TemplateCode:_0x33ea1d}=await this[_0x3f7d62(0xb2)][_0x3f7d62(0xa5)](),{phone:_0x376323,code:_0xc9ba04}=_0x56356a;if(!_0x376323||!_0xc9ba04)throw new common_1[(_0x3f7d62(0xd6))](_0x3f7d62(0xc0),common_1[_0x3f7d62(0xd2)]['BAD_REQUEST']);const _0x2b2a9e=new Core({'accessKeyId':_0x57c2e9,'accessKeySecret':_0x92f58f,'endpoint':_0x3f7d62(0xb7),'apiVersion':_0x3f7d62(0xea)}),_0x4ac906={'PhoneNumbers':_0x376323,'SignName':_0x255a3c,'TemplateCode':_0x33ea1d,'TemplateParam':JSON[_0x3f7d62(0xe3)]({'code':_0xc9ba04})},_0x2d090d={'method':_0x3f7d62(0xe1),'formatParams':![]};try{const _0x45c6c6=await _0x2b2a9e['request'](_0x3f7d62(0xeb),_0x4ac906,_0x2d090d);if(_0x45c6c6[_0x3f7d62(0xae)]==='OK')return!![];else throw new common_1[(_0x3f7d62(0xd6))](_0x45c6c6[_0x3f7d62(0xc6)]||'验证码发送失败！',common_1[_0x3f7d62(0xd2)][_0x3f7d62(0xe4)]);}catch(_0x417ef6){throw new common_1[(_0x3f7d62(0xd6))](((_0x8063ee=_0x417ef6===null||_0x417ef6===void 0x0?void 0x0:_0x417ef6[_0x3f7d62(0xb3)])===null||_0x8063ee===void 0x0?void 0x0:_0x8063ee[_0x3f7d62(0xc6)])||_0x3f7d62(0xbe),common_1['HttpStatus'][_0x3f7d62(0xe4)]);}}};function _0x38a3(_0x4510b6,_0xc773bd){const _0x130e9c=_0x130e();return _0x38a3=function(_0x38a3b8,_0x2d8470){_0x38a3b8=_0x38a3b8-0xa5;let _0x153fdc=_0x130e9c[_0x38a3b8];return _0x153fdc;},_0x38a3(_0x4510b6,_0xc773bd);}VerificationService=__decorate([(0x0,common_1[_0x59db0f(0xd0)])(),__param(0x0,(0x0,typeorm_1[_0x59db0f(0xdb)])(verifycation_entity_1[_0x59db0f(0xa7)])),__metadata(_0x59db0f(0xb8),[typeorm_2[_0x59db0f(0xc4)],globalConfig_service_1[_0x59db0f(0xbc)],redisCache_service_1[_0x59db0f(0xdd)]])],VerificationService),exports[_0x59db0f(0xda)]=VerificationService;function _0x130e(){const _0x25e733=['892066rrzWvT','save','globalConfigService','data','验证码已过期','sendPhoneCode','function','https://dysmsapi.aliyuncs.com','design:paramtypes','verifycationEntity','now','typeorm','GlobalConfigService','__esModule','验证码发送失败！','redisCacheService','确实必要参数错误！','findOne','__decorate','@alicloud/pop-core','Repository','2698524DQsdjQ','Message','验证码不存在','图形验证码错误、请检查填写!','231285NKdVmn',':CAPTCHA:','length','6qlZsNe','DESC','@nestjs/typeorm','update','Injectable','createRandomCode','HttpStatus','ceil','expiresAt','decorate','HttpException','USED','code','当前验证码已被使用！','VerificationService','InjectRepository','get','RedisCacheService','S内不得重新发送','createdAt','./../../common/constants/status.constant','POST','metadata','stringify','BAD_REQUEST','666840gEivYj','del','8ZLVGTG','6302936ZxupWe','45YNVnfa','2017-05-25','SendSms','getPhoneVerifyConfig','验证码错误','VerifycationEntity','../globalConfig/globalConfig.service','3937210hNpYEg','48927GLoRBr','used','../../common/utils','object','Code','getTime'];_0x130e=function(){return _0x25e733;};return _0x130e();}